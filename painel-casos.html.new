<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Painel de Casos de ViolÃªncia Escolar</title>
  
  <!-- Esconde conteÃºdo IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>
  
  <!-- TailwindCSS via CDN -->
  <script>
    // Suprime o aviso de produÃ§Ã£o do Tailwind CSS
    (function() {
      const originalWarn = console.warn;
      let tailwindWarningSuppressed = false;
      
      console.warn = function(...args) {
        const message = args.join(' ');
        // Suprime aviso do Tailwind CSS sobre produÃ§Ã£o
        if (message.includes('cdn.tailwindcss.com should not be used') ||
            message.includes('To use Tailwind CSS in production') ||
            message.includes('install it as a PostCSS plugin') ||
            message.includes('use the Tailwind CLI')) {
          tailwindWarningSuppressed = true;
          return; // Suprime o aviso
        }
        originalWarn.apply(console, args);
      };
      
      // Restaura console.warn apÃ³s alguns segundos (Tailwind jÃ¡ terÃ¡ carregado)
      setTimeout(() => {
        if (tailwindWarningSuppressed) {
          console.warn = originalWarn;
        }
      }, 5000);
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">
  
  <!-- ConfiguraÃ§Ã£o Centralizada -->
  <script src="config.js"></script>
  <script src="assets/js/utils/config-loader.js"></script>
  
  <!-- Sistema de TransiÃ§Ãµes entre PÃ¡ginas -->
  <script src="assets/js/utils/page-transitions.js"></script>
  
  <!-- Sistema de Loading Indicator Elegante -->
  <script src="assets/js/utils/loading-indicator.js"></script>
  
  <!-- Sistema de Scroll Reveal - RevelaÃ§Ã£o Progressiva -->
  <script src="assets/js/utils/scroll-reveal.js"></script>
  
  <!-- Sistema de Cache e NotificaÃ§Ãµes -->
  <link rel="stylesheet" href="assets/css/update-notification.css">
  <script src="assets/js/utils/data-cache.js"></script>
  <script src="assets/js/utils/change-detector.js"></script>
  <script src="assets/js/utils/update-notification.js"></script>
  
  <!-- Sistema de API e SeguranÃ§a -->
  <script src="assets/js/utils/security.js"></script>
  <script src="assets/js/utils/api.js"></script>
  
  <!-- Dashboard e EstatÃ­sticas (arquivo separado para evitar HTML muito longo) -->
  <script src="assets/js/modules/dashboard-stats.js"></script>
  
  <!-- Biblioteca para grÃ¡ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Biblioteca para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* AnimaÃ§Ã£o suave para linhas da tabela */
    .record-row {
      animation: slideInRow 0.3s ease-out backwards;
    }
    
    @keyframes slideInRow {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Delay escalonado para cada linha */
    .record-row:nth-child(1) { animation-delay: 0.05s; }
    .record-row:nth-child(2) { animation-delay: 0.1s; }
    .record-row:nth-child(3) { animation-delay: 0.15s; }
    .record-row:nth-child(4) { animation-delay: 0.2s; }
    .record-row:nth-child(5) { animation-delay: 0.25s; }
    .record-row:nth-child(6) { animation-delay: 0.3s; }
    .record-row:nth-child(7) { animation-delay: 0.35s; }
    .record-row:nth-child(8) { animation-delay: 0.4s; }
    .record-row:nth-child(9) { animation-delay: 0.45s; }
    .record-row:nth-child(10) { animation-delay: 0.5s; }
    
    /* Checkboxes personalizados elegantes */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }
    
    .custom-checkbox:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
    }
    
    .custom-checkbox:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      color: white;
      font-size: 12px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes checkPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    /* AnimaÃ§Ãµes para notificaÃ§Ã£o de nova notificaÃ§Ã£o */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    /* ========================================
       NOTIFICAÃ‡ÃƒO ELEGANTE E COMPACTA
       ======================================== */
    .notificacao-nova-elegante {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 360px;
      max-width: calc(100vw - 40px);
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.05);
      z-index: 10000;
      overflow: hidden;
      opacity: 0;
      transform: translateX(100%) scale(0.95);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    }
    
    .notificacao-nova-elegante.notificacao-visible {
      animation: notificacaoEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .notificacao-nova-elegante.notificacao-exit {
      animation: notificacaoExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes notificacaoEntrance {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes notificacaoExit {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }
    }
    
    .notificacao-conteudo {
      position: relative;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: #ffffff;
    }
    
    .notificacao-icone-container {
      position: relative;
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eff6ff;
      border-radius: 8px;
      animation: notificacaoIconContainerPulse 2s ease-in-out infinite;
    }
    
    @keyframes notificacaoIconContainerPulse {
      0%, 100% {
        background: #eff6ff;
        transform: scale(1);
      }
      50% {
        background: #dbeafe;
        transform: scale(1.05);
      }
    }
    
    .notificacao-icone {
      width: 20px;
      height: 20px;
      color: #3b82f6;
      animation: notificacaoIconEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes notificacaoIconEntrance {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      60% {
        transform: scale(1.2) rotate(10deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    .notificacao-texto {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .notificacao-titulo {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .notificacao-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: #3b82f6;
      color: white;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-radius: 4px;
      flex-shrink: 0;
      animation: notificacaoBadgeEntrance 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes notificacaoBadgeEntrance {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .notificacao-mensagem-principal {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.4;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.2s both;
    }
    
    @keyframes notificacaoTextFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .notificacao-descricao {
      font-size: 12px;
      color: #64748b;
      line-height: 1.5;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.3s both;
    }
    
    .notificacao-acoes {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-top: 4px;
    }
    
    .notificacao-btn-atualizar {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.4s both;
    }
    
    @keyframes notificacaoButtonEntrance {
      from {
        opacity: 0;
        transform: translateX(10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .notificacao-btn-atualizar:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .notificacao-btn-atualizar:active {
      transform: translateY(0);
    }
    
    .notificacao-btn-atualizar svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }
    
    .notificacao-btn-atualizar:hover svg {
      transform: rotate(180deg);
    }
    
    .notificacao-btn-fechar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.5s both;
    }
    
    .notificacao-btn-fechar:hover {
      background: #f1f5f9;
      color: #64748b;
      transform: rotate(90deg) scale(1.1);
    }
    
    .notificacao-progresso {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
      background-size: 200% 100%;
      width: 100%;
      transform-origin: left;
      animation: notificacaoProgresso 15s linear forwards, notificacaoProgressoShimmer 2s linear infinite;
    }
    
    @keyframes notificacaoProgresso {
      from {
        transform: scaleX(1);
      }
      to {
        transform: scaleX(0);
      }
    }
    
    @keyframes notificacaoProgressoShimmer {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 200% 50%;
      }
    }
    
    /* Responsivo */
    @media (max-width: 640px) {
      .notificacao-nova-elegante {
        width: calc(100vw - 32px);
        right: 16px;
        top: 16px;
      }
      
      .notificacao-conteudo {
        padding: 0;
      }
    }
    
    .checkbox-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      font-size: 0.875rem;
    }
    
    .checkbox-container:hover .checkbox-label {
      color: #1e40af;
    }
    
    /* Painel avanÃ§ado colapsÃ¡vel */
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }

    .advanced-panel.open {
      max-height: 2000px;
      opacity: 1;
      overflow: visible;
    }
    
    .filter-section.show {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .toggle-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    
    .checkbox-container {
      transition: all 0.2s ease;
    }
    
    .checkbox-container:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
    }
    
    /* Cards de filtros clicÃ¡veis */
    .filter-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      height: 56px;
      min-height: 56px;
      padding: 0.75rem !important;
      display: flex;
      align-items: center;
    }

    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.75rem 0.75rem;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
      background-color: #eff6ff;
    }

    .autocomplete-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .autocomplete-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .autocomplete-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .autocomplete-nome {
      font-size: 14px;
      color: #374151;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .autocomplete-list::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-list::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .autocomplete-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .autocomplete-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    #filterEscolaSearch.autocomplete-open {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      min-height: 44px;
    }

    .selected-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      font-size: 12px;
      color: #374151;
      max-width: 100%;
    }

    .selected-tag-label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 52ch;
    }

    .selected-tag-remove {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      line-height: 1;
      cursor: pointer;
      flex-shrink: 0;
    }

    .selected-tag-remove:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .filter-card-title {
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 10.5rem;
      transition: none !important;
      transform: none !important;
      pointer-events: none;
    }
    
    .filter-card-icon {
      transition: none;
      transform: none !important;
      pointer-events: none;
    }
    
    .filter-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .filter-card:hover::before {
      left: 100%;
    }
    
    .filter-card:hover {
      transform: translateY(-2px);
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .filter-card-icon {
      transition: none;
      transform: none !important;
      pointer-events: none;
    }
    
    .filter-card.active {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .badge-count {
      animation: badgePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      margin-left: 0.75rem; /* EspaÃ§amento entre o texto e o badge */
    }
    
    @keyframes badgePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Grupos de Encaminhamento */
    .encaminhamento-group {
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      transition: all 0.3s ease;
      background: white;
    }
    
    .encaminhamento-group:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .group-header:hover {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    
    .group-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }
    
    .group-checkbox-wrapper {
      display: flex;
      align-items: center;
    }
    
    .group-checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .group-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.9375rem;
    }
    
    .group-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      height: 1.5rem;
      padding: 0 0.5rem;
      background: #3b82f6;
      color: white;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .group-badge.hidden {
      display: none;
    }
    
    .toggle-icon {
      width: 1.25rem;
      height: 1.25rem;
      transition: transform 0.3s ease;
      color: #6b7280;
    }
    
    .toggle-icon.rotated {
      transform: rotate(180deg);
    }
    
    .group-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: white;
    }
    
    .group-body.expanded {
      max-height: 1000px;
    }
    
    .group-body-content {
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    
    .encaminhamento-group.outros-detectados {
      border-style: dashed;
      border-color: #f59e0b;
      background: #fffbeb;
    }
    
    .encaminhamento-group.outros-detectados .group-header {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Alerta inline para novas notificaÃ§Ãµes */
    .alerta-novas-notificacoes {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid #fecaca;
      background: linear-gradient(90deg, #fff1f2, #ffe4e6);
      color: #b91c1c;
      box-shadow: 0 8px 20px rgba(248, 113, 113, 0.15);
      opacity: 0;
      transform: translateY(-20px);
    }
    
    .alerta-novas-notificacoes.show {
      display: flex;
      animation: alertaEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .alerta-novas-notificacoes.hide {
      animation: alertaExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes alertaEntrance {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes alertaExit {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* AnimaÃ§Ã£o de shake para o contador quando Ã© incrementado */
    @keyframes shakeCounter {
      0%, 100% {
        transform: translateX(0);
      }
      10%, 30%, 50%, 70%, 90% {
        transform: translateX(-4px);
      }
      20%, 40%, 60%, 80% {
        transform: translateX(4px);
      }
    }

    .alerta-novas-notificacoes .contador-shake {
      animation: shakeCounter 0.5s ease-in-out;
      display: inline-block;
    }

    /* Esconder botÃ£o CTA */
    .alerta-novas-notificacoes .cta {
      display: none;
    }
    .alerta-novas-notificacoes .cta:hover {
      display: none;
    }

    /* AnimaÃ§Ã£o de pulsar unificada (reutilizÃ¡vel) */
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Classe genÃ©rica para pulsar (sem ID especÃ­fico) */
    .btn-pulse-active {
      animation: pulse 2s infinite !important;
      transition: none !important;
    }
    .alerta-novas-notificacoes .close-btn {
      background: transparent;
      color: #b91c1c;
      padding: 6px;
      border-radius: 8px;
      transition: background 0.15s ease;
    }
    .alerta-novas-notificacoes .close-btn:hover {
      background: rgba(185, 28, 28, 0.08);
    }
    
    /* Bloqueio quando toast estÃ¡ ativo */
    .alerta-novas-notificacoes.toast-blocking {
      pointer-events: none;
      opacity: 0.5;
    }

    /* Apenas Celulares e Tablets: Esconde menu horizontal, mostra hamburguer */

    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }
      
      .desktop-menu {
        display: none !important;
      }
      
      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {
      button, a {
        min-height: 44px;
      }
    }
    
    /* ========================================
       DRAWER DE DETALHES
       ======================================== */
    /* ========================================
       MODAL DE DETALHES - SIMPLES
       ======================================== */
    .modal-detalhes {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
      transition: all 0.3s ease;
      overflow-y: auto;
    }

    .modal-detalhes.visible {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px !important;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .modal-detalhes-conteudo {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      padding: 0;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 1152px;
      max-height: 95vh;
      margin: auto;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: modalFadeIn 0.3s ease;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-detalhes-header {
      flex-shrink: 0;
    }

    .modal-detalhes-titulo {
      margin: 0;
    }

    .modal-detalhes-subtitulo {
      margin: 0;
    }

    .modal-detalhes-close {
      cursor: pointer;
    }

    .modal-detalhes-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      background: transparent;
    }

    .modal-detalhes-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-detalhes-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .modal-detalhes-body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
      border-radius: 10px;
    }

    .modal-detalhes-body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);
    }

    .modal-detalhes-section,
    .modal-detalhes-section-title,
    .modal-detalhes-row,
    .modal-detalhes-label,
    .modal-detalhes-value,
    .modal-detalhes-value.empty {
      all: unset;
    }

    /* BotÃ£o na tabela */
    .btn-ver-detalhes {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      flex-shrink: 0;
    }

    .btn-ver-detalhes:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-ver-detalhes svg {
      width: 18px;
      height: 18px;
    }

    body.modal-open {
      overflow: hidden !important;
      touch-action: none;
    }

    .select-shell {
      position: relative;
      width: 100%;
    }

    .select-native {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
    }

    .select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 0.85rem;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      padding: 0.65rem 0.85rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #111827;
      transition: box-shadow 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
                  border-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
                  transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
                  background-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 1px 0 rgba(17, 24, 39, 0.02);
    }

    .select-trigger:hover {
      border-color: #93c5fd;
      background: linear-gradient(180deg, #ffffff 0%, #f3f8ff 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
    }

    .select-trigger:focus {
      outline: none;
    }

    .select-trigger:focus-visible {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18), 0 12px 26px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .select-trigger-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.85rem;
      height: 1.85rem;
      border-radius: 0.7rem;
      color: #64748b;
      background: rgba(148, 163, 184, 0.12);
      transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
                  background-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
                  color 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      flex-shrink: 0;
      margin-left: 0.75rem;
    }

    .select-shell[data-open="true"] .select-trigger-icon {
      transform: rotate(180deg);
      background: rgba(59, 130, 246, 0.14);
      color: #2563eb;
    }

    .select-menu {
      position: absolute;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 280px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.55);
      border-radius: 1rem;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.14);
      padding: 0.4rem;
      max-height: 240px;
      overflow: auto;
      transform-origin: top;
      opacity: 0;
      transform: translateY(-6px) scale(0.985);
      pointer-events: none;
      visibility: hidden;
      transition: opacity 140ms ease, transform 180ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .select-menu.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
      visibility: visible;
    }

    .select-menu.closing {
      visibility: visible;
      pointer-events: none;
    }

    /* Complementares: padronizaÃ§Ã£o visual (apenas dentro dos grupos colapsÃ¡veis) */
    .filter-group-content label {
      font-size: 0.875rem;
      line-height: 1.2;
      margin-bottom: 6px !important;
    }

    .filter-group-content label span.flex-1 {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      overflow: hidden;
    }

    .filter-group-content .grid {
      align-items: stretch;
    }

    .filter-group-content .grid > div:not(.hidden) {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 112px;
    }

    .filter-group-content .select-trigger {
      padding: 0.52rem 0.75rem;
      border-radius: 0.75rem;
    }

    .filter-group-content .select-trigger-icon {
      width: 1.65rem;
      height: 1.65rem;
      border-radius: 0.65rem;
      margin-left: 0.6rem;
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      height: 18px;
      padding: 0 8px;
      border-radius: 9999px;
      font-size: 10px;
      font-weight: 700;
      line-height: 1;
      letter-spacing: 0.02em;
      color: #334155;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      user-select: none;
      white-space: nowrap;
    }

    /* AnimaÃ§Ã£o do filtro condicional (parece "sair" do pai) */
    #filterOcorreuEscolaContainer {
      overflow: visible;
      transform-origin: top;
      will-change: height, opacity, transform;
    }

    #filterOcorreuEscolaContainer.is-animating {
      overflow: hidden;
      pointer-events: none;
    }

    .select-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.8rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #0f172a;
      cursor: pointer;
      user-select: none;
      transition: background-color 160ms ease, transform 160ms ease;
    }

    .select-option:hover {
      background-color: rgba(59, 130, 246, 0.10);
      transform: translateY(-1px);
    }

    .select-option[aria-selected="true"] {
      background-color: rgba(37, 99, 235, 0.14);
      color: #1d4ed8;
      font-weight: 700;
    }

    .tooltip-trigger {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .tooltip-trigger:focus {
      outline: none;
    }

    .tooltip-popover {
      display: none;
      z-index: 50000;
    }

    .tooltip-trigger:hover .tooltip-popover,
    .tooltip-trigger:focus-within .tooltip-popover {
      display: block;
    }

    .filter-group,
    .filter-group-content {
      overflow: visible;
    }

    #filtersSection {
      position: relative;
      overflow: visible;
    }

    #selectOverlay {
      position: absolute;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .modal-detalhes-conteudo {
        width: 100%;
        max-height: 95vh;
        margin: auto;
      }
      
      .modal-detalhes-header {
        padding: 0;
      }
      
      .modal-detalhes-titulo {
        font-size: inherit;
      }
      
      .modal-detalhes-body {
        padding: 0;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  
  <!-- Container Principal -->
  <div class="max-w-[1400px] mx-auto px-4 py-8">
  
  <!-- Menu de NavegaÃ§Ã£o -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
    <div class="px-4 py-3">
      <!-- BotÃ£o Hamburguer (Mobile) -->
      <button onclick="toggleMobileMenu()" class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
        <span>ğŸ“± Menu</span>
        <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      
      <!-- Menu Desktop -->
      <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
        <a href="painel-casos.html" class="px-5 py-2.5 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all">
          ğŸ“Š Painel de Casos
        </a>
        <a href="registro-novo-caso.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ“ Novo Registro
        </a>
        <a href="gerenciar-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ“‹ Gerenciar Registros
        </a>
        <a href="minhas-notificacoes.html" class="px-5 py-2.5 bg-purple-500 text-white rounded-lg text-sm font-semibold hover:bg-purple-400 transition-all">
          ğŸ”” Minhas NotificaÃ§Ãµes
        </a>
        <a id="menuAdmin" href="gerenciar-usuarios.html" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ”§ Painel Admin
        </a>
        <button id="btnSair" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
          ğŸšª Sair
        </button>
        <button id="btnSairVisualizadorDesktop" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
          ğŸšª Sair
        </button>
      </nav>
      
      <!-- Menu Mobile (Dropdown) -->
      <nav id="mobileMenuNav" class="mobile-menu mt-3">
        <div class="flex flex-col gap-2">
          <a href="painel-casos.html" class="btn-elegant px-5 py-3 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md text-center border-2 border-blue-500">
            ğŸ“Š Painel de Casos
          </a>
          <a href="registro-novo-caso.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ“ Novo Registro
          </a>
          <a href="gerenciar-casos.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ“‹ Gerenciar Registros
          </a>
          <a href="minhas-notificacoes.html" class="btn-elegant px-5 py-3 bg-purple-500 text-white rounded-lg text-sm font-semibold hover:bg-purple-400 transition-all text-center relative">
            ğŸ”” Minhas NotificaÃ§Ãµes
            <span id="badge-notif-mobile" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">0</span>
          </a>
          <a id="menuAdminMobile" href="gerenciar-usuarios.html" class="btn-elegant btn-primary-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ”§ Painel Admin
          </a>
          <button id="btnLogoutVisualizadorMobile" onclick="sair()" class="btn-elegant btn-danger-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸšª Sair
          </button>
          <button id="btnSairMobile" onclick="sair()" class="btn-elegant btn-danger-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸšª Sair
          </button>
        </div>
      </nav>
    </div>
  </div>
  
  <!-- Alerta de novas notificaÃ§Ãµes -->
  <div id="alerta-novas-notificacoes" class="alerta-novas-notificacoes mb-4">
    <div class="flex items-center gap-3">
      <span class="text-lg">ğŸ””</span>
      <div class="flex flex-col">
        <span class="font-semibold">Existem novas notificaÃ§Ãµes!</span>
        <span class="text-sm text-rose-700">Clique em Atualizar Dados para recarregar.</span>
      </div>
    </div>
  </div>

  <!-- CABEÃ‡ALHO -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
    <div class="flex items-center justify-center gap-4 mb-3">
      <div class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
        ğŸ“Š
      </div>
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-blue-800">
          Painel de Casos de ViolÃªncia Escolar
        </h1>
      </div>
    </div>
    <p class="text-center text-gray-600">Sistema de visualizaÃ§Ã£o e anÃ¡lise de dados conectado ao Google Sheets</p>
    <p class="text-center text-gray-500 text-sm mt-2">âœ… Dados carregados automaticamente da planilha oficial</p>
  </div>
    
    <!-- CONEXÃƒO COM PLANILHA -->
    <section class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ”— ConexÃ£o com Planilha</h2>
      
      <div class="mb-4 flex items-center justify-between">
        <div>
          <p class="text-slate-700 font-medium mb-1">Planilha conectada:</p>
          <p class="text-slate-500 text-sm">Os dados sÃ£o carregados automaticamente da planilha configurada no Google Sheets</p>
        </div>
        <button 
          id="btnAtualizar" 
          onclick="carregarDadosPlanilha()" 
          class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition shadow-md hover:shadow-lg flex items-center gap-2">
          <span>ğŸ”„</span>
          <span>Atualizar Dados</span>
        </button>
      </div>
      
      <div id="uploadStatus" class="p-4 rounded-md bg-blue-50 text-blue-700">â³ Carregando dados da planilha...</div>
    </section>

    <!-- FILTROS -->
    <section id="filtersSection" class="card-elegant bg-white rounded-2xl shadow-xl p-6 mb-6" data-reveal="fade-up">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
          <span class="text-3xl">ğŸ”</span>
          <span>Filtros</span>
        </h2>
        <button id="btnToggleAdvanced" onclick="toggleAdvancedFilters()" class="btn-elegant btn-secondary-elegant px-4 py-2 rounded-lg text-sm font-semibold">
          âš™ï¸ AvanÃ§ado
        </button>
      </div>

      <!-- PAINEL BÃSICO -->
      <div id="basicPanel">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-6 border border-gray-200 shadow-sm">

          <!-- Campo de Busca por Nome (SEMPRE VISÃVEL NO TOPO) -->
          <div class="mb-6 pb-6 border-b border-gray-200">
            <label for="filterNome" class="block text-sm font-semibold text-gray-700 mb-2">
              Buscar por nome da crianÃ§a/estudante
            </label>
            <input
              type="text"
              id="filterNome"
              placeholder="Digite parte do nome..."
              class="input-elegant w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            />
          </div>

          <!-- ÃRVORE DE FILTROS (6 grupos) -->
          <div class="space-y-3">

            <!-- ========================================
                 GRUPO 1: PERÃODO
                 ======================================== -->
            <details id="filterGroupPeriodo" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">ğŸ“…</div>
                  <span class="text-sm font-semibold text-gray-800">PerÃ­odo</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-gray-700 text-sm font-medium mb-2">Data InÃ­cio</label>
                      <input
                        type="date"
                        id="filterDataInicio"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                      />
                    </div>
                    <div>
                      <label class="block text-gray-700 text-sm font-medium mb-2">Data Fim</label>
                      <input
                        type="date"
                        id="filterDataFim"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <!-- ========================================
                 GRUPO 2: CRIANÃ‡A / PERFIL
                 ======================================== -->
            <details id="filterGroupPerfilEstudante" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-purple-100 text-purple-700">ğŸ‘¶</div>
                  <span class="text-sm font-semibold text-gray-800">CrianÃ§a / Perfil</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2 space-y-5">

                  <!-- SeÃ§Ã£o: Idade -->
                  <div>
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">Idade</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Idade MÃ­nima</label>
                        <input
                          type="number"
                          id="filterIdadeMin"
                          placeholder="Ex: 5"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                        />
                      </div>
                      <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Idade MÃ¡xima</label>
                        <input
                          type="number"
                          id="filterIdadeMax"
                          placeholder="Ex: 18"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- SeÃ§Ã£o: GÃªnero -->
                  <div id="section-genero" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">âš§ï¸ GÃªnero</h5>
                    <div id="filterGeneroContainer" class="filter-checkbox-grid filter-checkbox-grid-2col"></div>
                  </div>

                  <!-- SeÃ§Ã£o: RaÃ§a/Cor -->
                  <div id="section-raca" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">ğŸ‘¥ RaÃ§a/Cor</h5>
                    <div id="filterRacaContainer" class="filter-checkbox-grid filter-checkbox-grid-raca"></div>
                  </div>

                  <!-- SeÃ§Ã£o: OrientaÃ§Ã£o Sexual -->
                  <div id="section-orientacao" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">ğŸŒˆ OrientaÃ§Ã£o Sexual</h5>
                    <div id="filterOrientacaoContainer" class="filter-checkbox-grid filter-checkbox-grid-orientacao"></div>
                  </div>

                  <!-- SeÃ§Ã£o: Ã‰ PCD? -->
                  <div>
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">Pessoa com DeficiÃªncia</h5>
                    <div>
                      <label class="block text-gray-700 text-sm font-medium mb-2">Ã‰ PCD/tem Transtorno?</label>
                      <select id="filterPCD" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Condicional: Tipo de deficiÃªncia (indentado) -->
                    <div id="section-tipoDeficiencia" class="filter-conditional hidden mt-4 ml-4 pl-4 border-l-2 border-blue-300">
                      <h5 class="text-xs font-bold text-blue-700 uppercase tracking-wide mb-3">â™¿ Tipo de deficiÃªncia / transtorno</h5>
                      <div id="filterTipoDeficienciaContainer" class="filter-checkbox-grid filter-checkbox-grid-raca"></div>
                    </div>
                  </div>

                </div>
              </div>
            </details>

            <!-- ========================================
                 GRUPO 3: ESCOLA / CONTEXTO
                 ======================================== -->
            <details id="filterGroupContextoEscolar" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-green-100 text-green-700">ğŸ«</div>
                  <span class="text-sm font-semibold text-gray-800">Escola / Contexto</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2 space-y-4">

                  <!-- SeÃ§Ã£o: RegiÃ£o (AVANÃ‡ADO - virÃ¡ do painel avanÃ§ado) -->
                  <div id="section-regiao" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">ğŸ“ RegiÃ£o</h5>
                    <div id="filterRegiaoContainer" class="filter-checkbox-grid filter-checkbox-grid-raca"></div>
                  </div>

                  <!-- SeÃ§Ã£o: Tipo de InstituiÃ§Ã£o -->
                  <div id="section-tipoInstituicao" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">ğŸ« Tipo de InstituiÃ§Ã£o</h5>
                    <div id="filterTipoInstituicaoContainer" class="filter-checkbox-grid filter-checkbox-grid-2col"></div>
                  </div>

                  <!-- SeÃ§Ã£o: Escola EspecÃ­fica -->
                  <div id="section-escola" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">ğŸ¢ Escola EspecÃ­fica</h5>
                    <div class="autocomplete-wrapper mb-2">
                      <input
                        type="text"
                        id="filterEscolaSearch"
                        class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                        placeholder="Digite para buscar..."
                        autocomplete="off"
                      />
                      <div class="autocomplete-list" id="filterEscolaAutocompleteList"></div>
                    </div>
                    <div id="filterEscolaSelectedTags" class="selected-tags mb-2"></div>
                    <p class="text-xs text-gray-500 mt-1.5">Digite para buscar e selecione uma instituiÃ§Ã£o.</p>
                    <div id="filterEscolaContainer" class="hidden"></div>
                  </div>

                  <!-- SeÃ§Ã£o: Tempo Integral -->
                  <div id="section-ti" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">â±ï¸ Tempo Integral</h5>
                    <select id="filterTI" class="select-elegant w-full">
                      <option value="">Todos</option>
                      <option value="TI">Tempo Integral (TI)</option>
                      <option value="Regular">Tempo Regular (nÃ£o TI)</option>
                    </select>
                  </div>

                  <!-- Filtros do Contexto Escolar -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- Filtro: Fonte informada -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1 text-sm">
                          <span class="flex-1">O relato foi feito pela escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Fonte do relato</div>
                                <div class="leading-relaxed text-gray-800">Mostra quem iniciou o relato/notificaÃ§Ã£o do caso.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterFonteInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Filtro: ViolÃªncia identificada pela escola ocorrida na escola -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">A escola identificou que a violÃªncia ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Local confirmado (na escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se foi confirmado que o fato ocorreu dentro do ambiente escolar.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaEscolaOcorreu" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Filtro: ViolÃªncia identificada NÃƒO ocorrida na escola -->
                    <div>
                      <label class="block text-gray-700 font-medium text-sm" style="margin-bottom: 6px;">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">A escola identificou que a violÃªncia NÃƒO ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Local confirmado (fora da escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se foi confirmado que o fato ocorreu fora do ambiente escolar.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaNaoEscola" class="select-elegant w-full" style="margin-top: 2px;">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudo de Caso -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1 text-sm">
                          <span class="flex-1">Foi realizado estudo de caso pela equipe?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Estudo de caso</div>
                                <div class="leading-relaxed text-gray-800">Indica se a equipe realizou estudo de caso.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudoCaso" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Filtro: ViolÃªncia informada Ã  escola -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1 text-sm">
                          <span class="flex-1">ViolÃªncia foi comunicada Ã  escola por algum agente externo?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">ComunicaÃ§Ã£o por terceiros</div>
                                <div class="leading-relaxed text-gray-800">Indica se a escola tomou conhecimento do caso por comunicaÃ§Ã£o de terceiros.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                  </div>

                  <!-- Filtro CONDICIONAL: Ocorreu na escola (indentado) -->
                  <div id="filterOcorreuEscolaContainer" class="filter-conditional hidden ml-4 pl-4 border-l-2 border-blue-300">
                    <label class="block text-gray-700 font-medium mb-2">
                      <span class="flex items-start gap-1 text-sm">
                        <span class="flex-1">âœ A violÃªncia ocorreu na escola?</span>
                        <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="CondiÃ§Ã£o">
                          <span class="filter-badge">Condicional</span>
                        </span>
                        <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                          <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                          <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                            <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                            <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                              <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">ConfirmaÃ§Ã£o do local</div>
                              <div class="leading-relaxed text-gray-800">Este campo aparece quando o caso foi comunicado por agente externo.</div>
                            </span>
                          </span>
                        </span>
                      </span>
                    </label>
                    <select id="filterOcorreuEscola" class="select-elegant w-full">
                      <option value="">Todos</option>
                      <option value="S">Sim</option>
                      <option value="N">NÃ£o</option>
                    </select>
                  </div>

                </div>
              </div>
            </details>

            <!-- ========================================
                 GRUPO 4: AUTORIA / AGENTE
                 ======================================== -->
            <details id="filterGroupAutoriaAgente" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-orange-100 text-orange-700">ğŸ§‘â€ğŸ¤â€ğŸ§‘</div>
                  <span class="text-sm font-semibold text-gray-800">Autoria / Agente</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                    <!-- Filtro: Foi um membro familiar? -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="inline-flex items-center gap-1">
                          O autor era membro da famÃ­lia?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Membro da famÃ­lia</div>
                                <div class="leading-relaxed text-gray-800">Para entender se o caso tem indÃ­cio de violÃªncia intrafamiliar.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterMembroFamiliar" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="Sim">Sim</option>
                        <option value="NÃ£o">NÃ£o</option>
                        <option value="naoinformado">NÃ£o informado</option>
                      </select>
                    </div>

                    <!-- Filtro: Profissional autor -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="inline-flex items-center gap-1">
                          Profissional/funcionÃ¡rio foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Autoria (profissional)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria foi atribuÃ­da a profissional/funcionÃ¡rio da escola.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterProfissionalAutor" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudante autor -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="inline-flex items-center gap-1">
                          Estudante foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                            <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Autoria (estudante)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria foi atribuÃ­da a estudante.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudanteAutor" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">NÃ£o</option>
                      </select>
                    </div>

                  </div>
                </div>
              </div>
            </details>

            <!-- ========================================
                 GRUPO 5: VIOLÃŠNCIA
                 ======================================== -->
            <details id="filterGroupViolencia" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-red-100 text-red-700">âš ï¸</div>
                  <span class="text-sm font-semibold text-gray-800">ViolÃªncia</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2 space-y-4">

                  <!-- SeÃ§Ã£o: Tipo de ViolÃªncia -->
                  <div id="section-tipoViolencia" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3">âš ï¸ Tipo de ViolÃªncia</h5>
                    <div id="filterTipoViolenciaContainer" class="filter-checkbox-grid filter-checkbox-grid-raca"></div>
                  </div>

                  <!-- Condicional: ViolÃªncias Institucionais (indentado) -->
                  <div id="section-violenciaInstitucional" class="filter-conditional hidden ml-4 pl-4 border-l-2 border-red-300">
                    <h5 class="text-xs font-bold text-red-700 uppercase tracking-wide mb-3 flex items-center gap-2">
                      <span>ğŸ›ï¸ ViolÃªncias Institucionais</span>
                      <span id="badge-violenciaInstitucional-total" class="badge-count hidden inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full">0</span>
                    </h5>
                    <div id="filterViolenciaInstitucionalContainer" class="space-y-3"></div>
                  </div>

                </div>
              </div>
            </details>

            <!-- ========================================
                 GRUPO 6: ENCAMINHAMENTOS
                 ======================================== -->
            <details id="filterGroupEncaminhamentos" class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-teal-100 text-teal-700">ğŸ“‹</div>
                  <span class="text-sm font-semibold text-gray-800">Encaminhamentos</span>
                </div>
                <span class="filter-group-chevron text-gray-400">â–¾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <div id="section-encaminhamento" class="hidden">
                    <h5 class="text-xs font-bold text-gray-600 uppercase tracking-wide mb-3 flex items-center justify-between">
                      <span>ğŸ“‹ Encaminhamento</span>
                      <span id="badge-encaminhamento-total" class="badge-count hidden inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-teal-600 rounded-full">0</span>
                    </h5>
                    <div id="filterEncaminhamentoContainer" class="space-y-3"></div>
                  </div>

                </div>
              </div>
            </details>

          </div>

        </div>
      </div>

      <!-- Painel AvanÃ§ado (mantido do original) -->
      <div id="advancedPanel" class="advanced-panel mt-6 hidden">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-6 border border-gray-200 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
            <span class="text-2xl">ğŸ”</span>
            <span>Filtros AvanÃ§ados</span>
          </h3>

          <!-- MantÃ©m todas as seÃ§Ãµes do painel avanÃ§ado original -->
          <!-- (RegiÃ£o, Tipo ViolÃªncia, Tipo InstituiÃ§Ã£o, Escola, TI, Encaminhamento, RaÃ§a, GÃªnero, Tipo DeficiÃªncia, OrientaÃ§Ã£o, ViolÃªncia Institucional) -->
        </div>
      </div>

      <!-- BOTÃ•ES DE AÃ‡ÃƒO -->
      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="btnLimparFiltros" class="btn-elegant btn-secondary-elegant px-4 py-2 rounded-md font-medium">
          ğŸ”„ Limpar Filtros
        </button>
        <button id="btnExportarCSV" class="btn-elegant px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-md font-medium">
          ğŸ“¥ Exportar CSV
        </button>
        <button id="btnExportarExcel" class="btn-elegant px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-md font-medium">
          ğŸ“Š Exportar Excel
        </button>
        <button id="btnExportarPDF" class="btn-elegant px-4 py-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-md font-medium">
          ğŸ“„ Exportar PDF
        </button>
      </div>
    </section>

    <!-- DASHBOARD EXECUTIVO -->
    <section id="dashboardExecutivo" class="card-elegant bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl shadow-xl p-6 mb-6 hidden fade-in border-2 border-blue-200" data-reveal="fade-up">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="text-4xl animate-float">ğŸ“Š</span>
          <span>Dashboard Executivo</span>
        </h2>
        <button id="btnAtualizarKPIs" class="btn-elegant btn-primary-elegant px-4 py-2 rounded-lg text-sm font-semibold">
          ğŸ”„ Atualizar
        </button>
      </div>
      
      <!-- KPIs Principais -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card-elegant bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" data-reveal="scale-up" data-stagger="50">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Total de Casos</span>
            <span class="text-2xl">ğŸ“‹</span>
          </div>
          <div id="kpiTotalCasos" class="text-4xl font-bold mb-1">0</div>
          <div class="text-xs opacity-75" id="kpiTotalCasosVariacao">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" data-reveal="scale-up" data-stagger="50">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Casos Filtrados</span>
            <span class="text-2xl">ğŸ”</span>
          </div>
          <div id="kpiCasosFiltrados" class="text-4xl font-bold mb-1">0</div>
          <div class="text-xs opacity-75" id="kpiCasosFiltradosPercentual">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" data-reveal="scale-up" data-stagger="50">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Top Escola</span>
            <span class="text-2xl">ğŸ«</span>
          </div>
          <div id="kpiTopEscola" class="text-2xl font-bold mb-1 truncate">-</div>
          <div class="text-xs opacity-75" id="kpiTopEscolaCasos">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" data-reveal="scale-up" data-stagger="50">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Tipo Mais Frequente</span>
            <span class="text-2xl">âš ï¸</span>
          </div>
          <div id="kpiTipoFrequente" class="text-lg font-bold mb-1 truncate">-</div>
          <div class="text-xs opacity-75" id="kpiTipoFrequenteCasos">-</div>
        </div>
      </div>
      
      <!-- AnÃ¡lise EstatÃ­stica e Top 5 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ“ˆ</span>
            <span>EstatÃ­sticas Descritivas (Idade)</span>
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ©dia:</span>
              <span id="statMediaIdade" class="text-lg font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">Mediana:</span>
              <span id="statMedianaIdade" class="text-lg font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ­nima:</span>
              <span id="statIdadeMin" class="text-lg font-bold text-green-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ¡xima:</span>
              <span id="statIdadeMax" class="text-lg font-bold text-red-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-gray-600 font-medium">Desvio PadrÃ£o:</span>
              <span id="statDesvioPadrao" class="text-lg font-bold text-purple-600">-</span>
            </div>
          </div>
        </div>
        
        <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ†</span>
            <span>Top 5 Escolas</span>
          </h3>
          <div id="top5Escolas" class="space-y-2">
            <div class="text-gray-400 text-center py-4">Carregando...</div>
          </div>
        </div>
      </div>
      
      <!-- AnÃ¡lise Temporal -->
      <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span>ğŸ“…</span>
          <span>AnÃ¡lise Temporal</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
            <div class="text-sm text-gray-600 mb-1">Casos Este MÃªs</div>
            <div id="statCasosEsteMes" class="text-3xl font-bold text-blue-700">0</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200">
            <div class="text-sm text-gray-600 mb-1">Casos MÃªs Anterior</div>
            <div id="statCasosMesAnterior" class="text-3xl font-bold text-green-700">0</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
            <div class="text-sm text-gray-600 mb-1">VariaÃ§Ã£o</div>
            <div id="statVariacaoMensal" class="text-3xl font-bold text-purple-700">0%</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ESTATÃSTICAS -->
    <section id="statsSection" class="card-elegant bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in" data-reveal="fade-up">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="text-3xl animate-float">ğŸ“ˆ</span>
        <span>EstatÃ­sticas</span>
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card-elegant bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 border-2 border-blue-200" data-reveal="fade-left" data-stagger="40">
          <div class="text-gray-600 text-sm font-medium mb-2">Total de Registros</div>
          <div id="statTotal" class="text-4xl font-bold text-blue-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border-2 border-green-200" data-reveal="fade-up" data-stagger="40">
          <div class="text-gray-600 text-sm font-medium mb-2">Registros Filtrados</div>
          <div id="statFiltrados" class="text-4xl font-bold text-green-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-5 border-2 border-amber-200" data-reveal="fade-up" data-stagger="40">
          <div class="text-gray-600 text-sm font-medium mb-2">Ocorreram na Escola</div>
          <div id="statEscola" class="text-4xl font-bold text-amber-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 border-2 border-purple-200" data-reveal="fade-right" data-stagger="40">
          <div class="text-gray-600 text-sm font-medium mb-2">Tipos de ViolÃªncia</div>
          <div id="statTipos" class="text-sm text-purple-700 mt-1 max-h-20 overflow-y-auto scrollbar-elegant"></div>
        </div>
      </div>
    </section>

    <!-- GRÃFICOS -->
    <section id="chartsSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in" data-reveal="fade-up">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">ğŸ“Š GrÃ¡ficos DinÃ¢micos</h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- GrÃ¡fico: Tipos de ViolÃªncia -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Tipos de ViolÃªncia</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTipoViolencia"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Tipos de ViolÃªncia Institucional -->
        <div id="containerChartViolenciaInstitucional" class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg p-4 border border-orange-200 hidden" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-orange-700 mb-4">ğŸ›ï¸ ViolÃªncia Institucional</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTipoViolenciaInstitucional"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por RegiÃ£o -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Casos por RegiÃ£o</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRegiao"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por Escola -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Top 10 Escolas</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartEscola"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por Faixa EtÃ¡ria -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Faixa EtÃ¡ria</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartIdade"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por GÃªnero -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">GÃªnero (M/F)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartGenero"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por RaÃ§a/Cor -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">RaÃ§a/Cor</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRaca"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Linha do Tempo -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 lg:col-span-2" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Linha do Tempo (Por MÃªs)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTemporal"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Encaminhamentos -->
        <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“Š</span>
            <span>Encaminhamentos por Rede</span>
          </h3>
          <div class="relative" style="height: 320px;">
            <canvas id="chartEncaminhamento"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Autor da ViolÃªncia -->
        <div class="bg-gradient-to-br from-slate-50 to-purple-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ‘¤</span>
            <span>Autor da ViolÃªncia</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartAutor"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Ocorreu na Escola? -->
        <div class="bg-gradient-to-br from-slate-50 to-green-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ«</span>
            <span>Ocorreu na Escola?</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartOcorreuEscola"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: CorrelaÃ§Ã£o Tipo de ViolÃªncia vs Faixa EtÃ¡ria -->
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border-2 border-indigo-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ”—</span>
            <span>CorrelaÃ§Ã£o: Tipo de ViolÃªncia vs Faixa EtÃ¡ria</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartCorrelacaoTipoIdade"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Comparativo Temporal (Ãšltimos 6 Meses vs PerÃ­odo Anterior) -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border-2 border-amber-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“Š</span>
            <span>Comparativo Temporal: Ãšltimos 6 Meses vs PerÃ­odo Anterior</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartComparativoTemporal"></canvas>
          </div>
        </div>

        <!-- GrÃ¡fico: TendÃªncia Anual (ComparaÃ§Ã£o Ano Atual vs Ano Anterior) -->
        <div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-5 border-2 border-teal-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“ˆ</span>
            <span>TendÃªncia Anual: ComparaÃ§Ã£o MÃªs a MÃªs</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartTendenciaAnual"></canvas>
          </div>
        </div>
        
      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="resultsSection" class="bg-white rounded-2xl shadow-xl p-6 hidden fade-in">
      <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="text-4xl">ğŸ“‹</span>
          <span>Registros</span>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 border border-blue-200">
            <span id="recordCount">0</span>
          </span>
        </h2>
      </div>
      
      <div id="noResultsMessage" class="hidden p-6 text-center text-gray-500">âš ï¸ Nenhum registro encontrado com os filtros atuais.</div>
      
      <div id="tableContainer" class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 sticky top-0 shadow-sm">
            <tr>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">ğŸ‘¤ CrianÃ§a/Estudante</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">ğŸ“… Idade</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">ğŸ—“ï¸ Data</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">âš ï¸ Tipo de ViolÃªncia</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">ğŸ« CMEI/EMEF</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">ğŸ“ RegiÃ£o</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">ğŸ“‹ Encaminhamento</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">âœ“ Na Escola?</th>
              <th class="px-4 py-3.5 text-center text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">ğŸ” AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-slate-200"></tbody>
        </table>
      </div>
      
      <!-- Controles de PaginaÃ§Ã£o Modernos -->
      <div id="paginacao" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4 px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-gray-700">ğŸ“„ Exibir:</span>
          <select id="registrosPorPaginaSelect" class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all hover:border-gray-400 cursor-pointer shadow-sm">
            <option value="5">5 registros</option>
            <option value="10" selected>10 registros</option>
            <option value="25">25 registros</option>
            <option value="50">50 registros</option>
            <option value="100">100 registros</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200">
          <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">PÃ¡gina</span>
          <span id="paginacaoInfo" class="text-sm font-bold text-slate-700 px-2">1 de 1</span>
        </div>
        
        <div class="flex items-center gap-1.5">
          <button id="btnPrimeiraPagina" class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md" disabled title="Primeira pÃ¡gina">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
            </svg>
          </button>
          <button id="btnPaginaAnterior" class="group px-4 py-2 text-sm font-medium text-gray-600 bg-white border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-gray-300 disabled:hover:text-gray-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5" disabled title="PÃ¡gina anterior">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline">Anterior</span>
          </button>
          <button id="btnProximaPagina" class="group px-4 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5" title="PrÃ³xima pÃ¡gina">
            <span class="hidden sm:inline">PrÃ³xima</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <button id="btnUltimaPagina" class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md" title="Ãšltima pÃ¡gina">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </section>

  </main>


  <script>
    // ==============================
    // VariÃ¡veis globais
    // ==============================
    let originalData = [];
    let filteredData = [];
    let columnNames = {};
    let charts = {}; // Armazena instÃ¢ncias dos grÃ¡ficos
    
    // ExpÃµe variÃ¡veis globalmente para dashboard-stats.js
    window.originalData = originalData;
    window.filteredData = filteredData;
    window.columnNames = columnNames;

    // VariÃ¡veis de paginaÃ§Ã£o (frontend-only)
    let paginaAtual = 1;
    let registrosPorPagina = 10;
    let totalPaginas = 1;
    
    // Dados CSV inline das listas de CMEIs e EMEFs
    const CSV_CMEIS = `Nome,Sigla
AdÃ¡cio Bispo dos Santos TI,ABS
Ãlvaro Fernandes Lima TI,AFL
Ana Maria Chaves Colares,AMCC
AnÃ­zio SpÃ­nola Teixeira,AST
Carlos Alberto Martinelli de Souza TI,EAMS
Carlita CorrÃªa Pereira TI,CCP
Carlos Mendes,CM
Darcy Castello de MendonÃ§a,DCM
Dom. JoÃ£o Batista da Motta e Albuquerque TI,JBMA
Dr. Denizart Santos TI,DS
Darcy Vargas,DV
Edlma Maria Soares Braga TTI,EMSB
Ernestina Pessoa,EP
Gilda de Athayde Ramos,GAR
Gisela da Cruz MilitÃ£o,GCM
Georgiana da Trindade Faria,GTF
Hecy Alves Fraga TI,HAF
Jacivinha Ferreira de Souza SimÃµes TI,JFSS
JuÃ­zo Pedro de Aguiar,JPA
Luiz Carlos Grecco TI,LCG
Laurentina MendonÃ§a CorrÃªa,LMC
LuÃ­za Pereira Muniz CorrÃªa TI,LPMC
Lidia Rocha Feitosa,LRF
Lisandra Ignes Carpanedo do Carmo,LICC
MagnÃ³lia Dias Miranda Cunha TTI,MUMC
Maria Goretti Coutinho Cosme TI,MGCC
Menino Jesus TI,MJ
Maria Nazareth Menegueli TTI,MNM
Marlene Dilande Simonetti,MDS
Nalcyrley Silva Braga,NSB
Oscalina Nunes Andrade,ONA
Odila SimÃµes,OS
Professora Cida Barreto,PCB
Dr. Pedro Feu Rosa,PFR
Padre Giovanni Bartesaghi TTI,PGB
Rubem Braga,RB
Rubens Duarte de Albuquerque TTI,RDA
Robson JosÃ© Nassur PeÃ§oto TI,RJNP
Rubens JosÃ© Vervloet Gomes TI,RJVG
Reinaldo Ridolfi,RR
Professora Sophia Musengiyvi Loureiro,SML
Sinclair Phillips,SP
Silvanete da Silva Rosa Rocha TI,SSRR
Thomas Tommasi TTI,TT
Terezinha Vasconcellos Salvador,TVS
Valdivia de Penna Antunes Rodrigues TI,VPAR
Yolanda Lucas da Silva,VLS
Zilmar Alves de Melo,ZAM
Zulmira Gomes Martins Marcarini Cavalcanti,ZGMC
ZÃ©lia Viana de Aguiar,ZVA`;

    const CSV_EMEFS = `Nome,Sigla
Alberto de Almeida,AA
AdÃ£o Benezath,AB
AristÃ³bulo Barbosa LeÃ£o,ABL
Ãlvaro de Castro Mattos,ACM
Arthur da Costa e Silva,ACS
Amilton Monteiro da Silva,AMS
Alvimar Silva,AS
Adilson da Silva Castro,ASC
Adevalni Sysesmundo Ferreira de Azevedo,ASFA
Anacleta Schneider Lucas TI,ASLC
Ceciliano Abel de Almeida,CAA
Castelo Branco,CB
CustÃ³dia Dias de Campos,CDC
CEJA Prof. Admardo Serafim de Oliveira,EJA ASO
Ã‰ber Louzada Zippinotti,ELZ
Edna de Mattos Siqueira Gaudio TI,EMSG
Eunice Perreira Silveira TI,EPS
Eliane Rodrigues dos Santos,ERS
Escola Experimental de VitÃ³ria-UFES,UFES
Elzira Vivacqua dos Santos,EVS
Francisco Lacerda de Aguiar,FLA
Heloisa Abreu JÃºdice de Mattos,HAJM
IrmÃ£ Jacinta Soares de Souza Lima,IJSSL
Izaura Marques da Silva TI,IMS
JosÃ© Ãureo Monjardim TI,JAM
JoÃ£o Bandeira,JB
Juscelino Kubitschek de Oliveira,JKO
JosÃ© Lemos de Miranda TI,JLM
Lenir Borlot,LB
Moacyr Avidos TI,MA
Mauro Braga,MB
Marieta Escobar,ME
Maria JosÃ© Costa Moraes,MJCM
Maria Leonor Pereira da Silva,MLPS
Marechal Mascarenhas de Moraes,MMM
Maria Madalena Oliveira Domingues,MMOD
Maria Stella de Novaes,MSN
Neusa Nunes GonÃ§alves,NNG
Orlandina D'Almeida Lucas,ODAL
Otto Ewald JÃºnior,OEJ
OctacÃ­lio Lomba,OL
Prezideu Amorim,PA
Padre Anchieta,PAN
Padre Guido Ceotto,PGC
Paulo Reglus Neves Freire TI,PRNF
Paulo Roberto Vieira Gomes,PRVG
Rita de CÃ¡ssia Oliveira,RCO
Regina Maria Silva,RMS
Ronaldo Soares,RS
Suzete Cuendet,SC
SÃ£o Vicente de Paulo,SVP
Tancredo de Almeida Neves,TAN
VercenÃ­lio da Silva Pascoal,VSP
Zilda Andrade,ZA`;
    
    // FunÃ§Ã£o para processar os CSVs e criar os mapeamentos
    function processarCSVs() {
      const linhasCMEI = CSV_CMEIS.split('\n').slice(1); // Remove header
      const linhasEMEF = CSV_EMEFS.split('\n').slice(1); // Remove header
      
      const cmeiSiglas = {};
      const emefSiglas = {};
      
      linhasCMEI.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            cmeiSiglas[sigla] = nome;
          }
        }
      });
      
      linhasEMEF.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            emefSiglas[sigla] = nome;
          }
        }
      });
      
      return { cmeiSiglas, emefSiglas };
    }
    
    // Processa os CSVs e cria os mapeamentos
    const { cmeiSiglas: CMEI_SIGLAS, emefSiglas: EMEF_SIGLAS } = processarCSVs();

    // ==============================
    // FunÃ§Ã£o auxiliar: Detecta se escola Ã© Tempo Integral
    // ==============================
    function isTempoIntegral(escolaValor) {
      if (!escolaValor) return false;
      
      const sigla = String(escolaValor).trim().toUpperCase();
      let nomeCompleto = null;

      // Tenta achar nas listas de siglas
      if (CMEI_SIGLAS[sigla]) {
        nomeCompleto = CMEI_SIGLAS[sigla];
      } else if (EMEF_SIGLAS[sigla]) {
        nomeCompleto = EMEF_SIGLAS[sigla];
      } else {
        // Fallback: usa o prÃ³prio valor caso a planilha um dia venha com nome em vez de sigla
        nomeCompleto = String(escolaValor).trim();
      }

      const nomeUpper = nomeCompleto.toUpperCase();

      // Tempo Integral: nome completo termina com " TI" ou " TTI"
      return nomeUpper.endsWith(' TI') || nomeUpper.endsWith(' TTI');
    }

    // ==============================
    // UtilitÃ¡rios de texto / listas
    // ==============================

    // NormalizaÃ§Ã£o para reduzir erro de digitaÃ§Ã£o: tira acento, pontuaÃ§Ã£o, caixa
    // IMPORTANTE: Preserva a barra (/) para tipos compostos como "Financeira/EconÃ´mica"
    function normalizeText(str) {
      return String(str || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s\/]/g, ' ') // â† Preserva / alÃ©m de letras, nÃºmeros e espaÃ§os
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // Identifica se uma escola Ã© EMEF ou CMEI baseado no nome/sigla
    function getTipoInstituicao(nomeEscola) {
      if (!nomeEscola) return null;
      
      const nome = String(nomeEscola).trim().toUpperCase();
      
      // Verifica se Ã© uma sigla exata de EMEF
      if (EMEF_SIGLAS[nome]) {
        return 'EMEF';
      }
      
      // Verifica se Ã© uma sigla exata de CMEI
      if (CMEI_SIGLAS[nome]) {
        return 'CMEI';
      }
      
      // Verifica se o nome contÃ©m a sigla como palavra isolada (EMEF)
      for (const sigla in EMEF_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) {
          return 'EMEF';
        }
      }
      
      // Verifica se o nome contÃ©m a sigla como palavra isolada (CMEI)
      for (const sigla in CMEI_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) {
          return 'CMEI';
        }
      }
      
      // Verifica se contÃ©m "EMEF" no nome
      if (nome.includes('EMEF')) {
        return 'EMEF';
      }
      
      // Verifica se contÃ©m "CMEI" no nome
      if (nome.includes('CMEI')) {
        return 'CMEI';
      }
      
      // Se nÃ£o identificou, retorna null
      return null;
    }
    
    // Converte sigla para nome completo (se for uma EMEF ou CMEI conhecida)
    function getDisplayName(nomeEscola) {
      if (!nomeEscola) return '';
      
      const nome = String(nomeEscola).trim().toUpperCase();
      
      // Se for uma sigla exata de EMEF, retorna "EMEF Sigla"
      if (EMEF_SIGLAS[nome]) {
        return `EMEF ${nome}`;
      }
      
      // Se for uma sigla exata de CMEI, retorna "CMEI Sigla"
      if (CMEI_SIGLAS[nome]) {
        return `CMEI ${nome}`;
      }
      
      return nomeEscola;
    }

    // ==============================
    // Sistema de Grupos de Encaminhamento
    // ==============================
    
    // DefiniÃ§Ã£o dos grupos de encaminhamento
    const encaminhamentosAgrupados = {
      redeAssistencia: ['AssistÃªncia Social','CRAS','CREAS','Casa Rosa','PsicÃ³logo'],
      redeSaude: ['SaÃºde','UBS','US','CAPSIN'],
      redeEducacao: ['NAAM','EducaÃ§Ã£o','Escola'],
      conselhoTutelar: ['CT'],
      redeSegurancaJustica: ['DACLE','DEAM','DEPI','DPCA','Defensoria PÃºblica','MinistÃ©rio PÃºblico','Outras delegacias']
    };
    
    // Nomes amigÃ¡veis dos grupos
    const grupoNomes = {
      redeAssistencia: 'Rede de AssistÃªncia Social',
      redeSaude: 'Rede de SaÃºde',
      redeEducacao: 'Rede de EducaÃ§Ã£o',
      conselhoTutelar: 'Conselho Tutelar',
      redeSegurancaJustica: 'Rede de SeguranÃ§a e JustiÃ§a'
    };
    
    // Verifica se um termo pertence a algum grupo
    function belongsToAnyGroup(term) {
      const termNorm = normalizeText(term);
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        if (children.some(child => normalizeText(child) === termNorm)) {
          return true;
        }
      }
      return false;
    }
    
    // ConstrÃ³i os grupos de encaminhamento baseado nos dados reais
    function buildEncaminhamentoGroups(availableEncaminhamentos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      container.innerHTML = '';
      
      // Normalizar availableEncaminhamentos para comparaÃ§Ã£o
      const availableNormalized = availableEncaminhamentos.map(e => normalizeText(e));
      
      // Construir cada grupo
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        
        // Filtrar apenas os filhos que existem nos dados
        const childrenPresent = children.filter(child => 
          availableNormalized.includes(normalizeText(child))
        );
        
        // Se nÃ£o hÃ¡ filhos presentes, nÃ£o renderizar o grupo
        if (childrenPresent.length === 0) continue;
        
        // Renderizar o grupo
        renderEncaminhamentoGroup(groupKey, childrenPresent);
      }
      
      // Identificar encaminhamentos nÃ£o mapeados ("Outros detectados")
      const outrosDetectados = availableEncaminhamentos.filter(term => !belongsToAnyGroup(term));
      
      if (outrosDetectados.length > 0) {
        renderOutrosDetectados(outrosDetectados);
      }
    }
    
    // Renderiza um grupo de encaminhamento
    function renderEncaminhamentoGroup(groupId, childrenPresent) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      const groupName = grupoNomes[groupId] || groupId;
      
      // Criar estrutura do grupo
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group';
      groupDiv.dataset.group = groupId;
      
      // Header do grupo
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      
      // Checkbox do grupo
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group-${groupId}`;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      
      checkboxWrapper.appendChild(groupCheckbox);
      
      // TÃ­tulo do grupo
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = groupName;
      
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      
      // Badge de contagem
      const badge = document.createElement('span');
      badge.id = `badge-${groupId}`;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      
      // Ãcone de toggle
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle-${groupId}`;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      
      // Body do grupo (conteÃºdo colapsÃ¡vel)
      const body = document.createElement('div');
      body.id = `body-${groupId}`;
      body.className = 'group-body';
      
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      
      // Criar checkboxes dos filhos
      childrenPresent.forEach((child, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-gray-50 rounded-lg border border-gray-200';
        
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index}`;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = child;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index}`;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = child;
        
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      
      body.appendChild(bodyContent);
      
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }
    
    // Renderiza grupo "Outros detectados"
    function renderOutrosDetectados(termos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      const groupId = 'outrosDetectados';
      
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group outros-detectados';
      groupDiv.dataset.group = groupId;
      
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group-${groupId}`;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      
      checkboxWrapper.appendChild(groupCheckbox);
      
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = 'âš ï¸ Outros detectados';
      
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      
      const badge = document.createElement('span');
      badge.id = `badge-${groupId}`;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle-${groupId}`;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      
      const body = document.createElement('div');
      body.id = `body-${groupId}`;
      body.className = 'group-body';
      
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      
      termos.forEach((termo, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-amber-50 rounded-lg border border-amber-300';
        
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index}`;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = termo;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index}`;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = termo;
        
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      
      body.appendChild(bodyContent);
      
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }
    
    // Toggle panel de um grupo
    function toggleGroupPanel(groupId) {
      const body = document.getElementById(`body-${groupId}`);
      const icon = document.getElementById(`toggle-${groupId}`);
      
      if (body && icon) {
        body.classList.toggle('expanded');
        icon.classList.toggle('rotated');
      }
    }
    
    // Handler quando checkbox de grupo muda
    function onGroupCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group-${groupId}`);
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);
      
      // Marcar/desmarcar todos os filhos
      childCheckboxes.forEach(child => {
        child.checked = groupCheckbox.checked;
      });
      
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      applyFilters();
    }
    
    // Handler quando checkbox de filho muda
    function onChildCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group-${groupId}`);
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);
      
      const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(childCheckboxes).some(cb => cb.checked);
      
      // Atualizar estado do grupo (checked, indeterminate, unchecked)
      groupCheckbox.checked = allChecked;
      groupCheckbox.indeterminate = someChecked && !allChecked;
      
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      applyFilters();
    }
    
    // Atualiza badge de um grupo especÃ­fico
    function updateGroupBadge(groupId) {
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
      const count = childCheckboxes.length;
      const badge = document.getElementById(`badge-${groupId}`);
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // Atualiza badge total de encaminhamento
    function updateBadgeEncaminhamentoTotal() {
      const allChildCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      const count = allChildCheckboxes.length;
      const badge = document.getElementById('badge-encaminhamento-total');
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // ==============================
    // Sistema de Grupos de ViolÃªncias Institucionais
    // ==============================
    
    // DefiniÃ§Ã£o dos grupos de violÃªncias institucionais (similar aos encaminhamentos)
    const violenciasInstitucionaisAgrupadas = {
      fisica: ['FÃ­sica', 'Fisica'],
      psicologica: ['PsicolÃ³gica', 'Psicologica', 'PsicolÃ³gica/Moral'],
      sexual: ['Sexual', 'Abuso Sexual'],
      verbal: ['Verbal', 'Verbal/Moral'],
      negligencia: ['NegligÃªncia', 'Negligencia', 'NegligÃªncia/Abandono'],
      patrimonial: ['Patrimonial', 'Patrimonial/EconÃ´mica'],
      bullying: ['Bullying', 'Bullying/Cyberbullying'],
      outras: ['Outras', 'Outros']
    };
    
    // Nomes amigÃ¡veis dos grupos
    const grupoNomesViolenciaInstitucional = {
      fisica: 'ViolÃªncia FÃ­sica',
      psicologica: 'ViolÃªncia PsicolÃ³gica',
      sexual: 'ViolÃªncia Sexual',
      verbal: 'ViolÃªncia Verbal',
      negligencia: 'NegligÃªncia',
      patrimonial: 'ViolÃªncia Patrimonial',
      bullying: 'Bullying/Cyberbullying',
      outras: 'Outras ViolÃªncias Institucionais'
    };
    
    // Verifica se um termo pertence a algum grupo
    function belongsToAnyGroupViolenciaInstitucional(term) {
      const termNorm = normalizeText(term);
      for (const groupKey in violenciasInstitucionaisAgrupadas) {
        const children = violenciasInstitucionaisAgrupadas[groupKey];
        if (children.some(child => normalizeText(child) === termNorm)) {
          return true;
        }
      }
      return false;
    }
    
    // ConstrÃ³i a lista simples de violÃªncias institucionais (sem grupos)
    function buildViolenciaInstitucionalGroups(data) {
      const container = document.getElementById('filterViolenciaInstitucionalContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Coleta todas as violÃªncias institucionais dos dados
      // Apenas de registros que tÃªm "Institucional" em tipoViolencia
      const violenciasInstitucionais = new Set();
      
      data.forEach(row => {
        const tipoViolencia = String(row[columnNames.tipo] || '').toLowerCase();
        const temInstitucional = tipoViolencia.includes('institucional');
        
        if (temInstitucional && columnNames.tipoViolenciaInstitucional) {
          const violenciaInstitucional = row[columnNames.tipoViolenciaInstitucional];
          if (violenciaInstitucional) {
            // Pode ter mÃºltiplos valores separados por vÃ­rgula
            const valores = String(violenciaInstitucional).split(',').map(v => v.trim()).filter(v => v);
            valores.forEach(v => violenciasInstitucionais.add(v));
          }
        }
      });
      
      const availableViolencias = Array.from(violenciasInstitucionais).sort();
      
      if (availableViolencias.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma violÃªncia institucional encontrada nos dados.</p>';
        return;
      }
      
      // Criar checkbox geral "ViolÃªncia Institucional" que marca/desmarca todos
      const grupoGeralDiv = document.createElement('div');
      grupoGeralDiv.className = 'mb-4 p-3 bg-blue-50 border-2 border-blue-200 rounded-lg';
      
      const grupoGeralCheckboxDiv = document.createElement('div');
      grupoGeralCheckboxDiv.className = 'flex items-center gap-3';
      
      const grupoGeralCheckbox = document.createElement('input');
      grupoGeralCheckbox.type = 'checkbox';
      grupoGeralCheckbox.id = 'checkbox-violencia-institucional-geral';
      grupoGeralCheckbox.className = 'custom-checkbox';
      grupoGeralCheckbox.onchange = () => {
        const isChecked = grupoGeralCheckbox.checked;
        const allCheckboxes = container.querySelectorAll('input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)');
        allCheckboxes.forEach(cb => {
          cb.checked = isChecked;
        });
        updateBadgeViolenciaInstitucionalTotal();
        applyFilters();
      };
      
      const grupoGeralLabel = document.createElement('label');
      grupoGeralLabel.htmlFor = 'checkbox-violencia-institucional-geral';
      grupoGeralLabel.className = 'text-base font-bold text-gray-800 cursor-pointer flex-1';
      grupoGeralLabel.textContent = 'ViolÃªncia Institucional';
      
      grupoGeralCheckboxDiv.appendChild(grupoGeralCheckbox);
      grupoGeralCheckboxDiv.appendChild(grupoGeralLabel);
      grupoGeralDiv.appendChild(grupoGeralCheckboxDiv);
      container.appendChild(grupoGeralDiv);
      
      // Criar checkboxes individuais para cada tipo de violÃªncia institucional
      const checkboxesDiv = document.createElement('div');
      checkboxesDiv.className = 'space-y-2 ml-6';
      
      availableViolencias.forEach((violencia, index) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'flex items-center gap-2.5 p-2 bg-gray-50 rounded-lg border border-gray-200';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `checkbox-vi-${index}`;
        checkbox.className = 'custom-checkbox';
        checkbox.dataset.value = violencia;
        checkbox.dataset.filter = 'violenciaInstitucional';
        checkbox.onchange = () => {
          // Atualiza o checkbox geral baseado no estado de todos os checkboxes
          const allCheckboxes = container.querySelectorAll('input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
          
          grupoGeralCheckbox.checked = allChecked;
          grupoGeralCheckbox.indeterminate = someChecked && !allChecked;
          
          updateBadgeViolenciaInstitucionalTotal();
          applyFilters();
        };
        
        const label = document.createElement('label');
        label.htmlFor = `checkbox-vi-${index}`;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = violencia;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        checkboxesDiv.appendChild(checkboxDiv);
      });
      
      container.appendChild(checkboxesDiv);
    }
    
    
    // Atualiza badge total de violÃªncia institucional
    function updateBadgeViolenciaInstitucionalTotal() {
      // Conta apenas os checkboxes individuais (exclui o checkbox geral)
      const allChildCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
      const count = allChildCheckboxes.length;
      const badge = document.getElementById('badge-violenciaInstitucional-total');
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // Coleta todos os tipos de violÃªncia institucional selecionados
    function gatherSelectedViolenciasInstitucionais() {
      // Retorna apenas os checkboxes individuais (exclui o checkbox geral)
      const selectedCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
      return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
    }
    
    // Verifica se uma cÃ©lula de violÃªncia institucional corresponde aos termos selecionados (lÃ³gica OR)
    function matchViolenciaInstitucionalCell(cellValue, selectedTerms) {
      // Se nenhum termo foi selecionado, aceita todos
      if (selectedTerms.length === 0) return true;
      
      // Se hÃ¡ termos selecionados mas a cÃ©lula estÃ¡ vazia, REJEITA
      if (!cellValue) return false;
      
      // Normalizar cÃ©lula (split por vÃ­rgula)
      const cellValues = String(cellValue)
        .split(',')
        .map(v => normalizeText(v.trim()))
        .filter(v => v);
      
      // Se apÃ³s normalizar nÃ£o hÃ¡ valores, REJEITA
      if (cellValues.length === 0) return false;
      
      // Normalizar termos selecionados
      const selectedNormalized = selectedTerms.map(t => normalizeText(t));
      
      // Retorna true se qualquer valor da cÃ©lula estiver nos selecionados (OR)
      return cellValues.some(cv => selectedNormalized.includes(cv));
    }
    
    // Verifica se "Institucional" estÃ¡ selecionado no filtro de Tipo ViolÃªncia e mostra/esconde o card de ViolÃªncias Institucionais
    function verificarViolenciaInstitucionalNoFiltro() {
      let cardViolenciaInstitucional = document.getElementById('card-violenciaInstitucional');
      const sectionViolenciaInstitucional = document.getElementById('section-violenciaInstitucional');
      
      // Verifica se algum checkbox de "Institucional" estÃ¡ marcado no filtro de Tipo ViolÃªncia
      const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
      const temInstitucional = Array.from(tipoViolenciaCheckboxes).some(cb => {
        const valor = (cb.dataset.value || '').toLowerCase();
        return valor === 'institucional' || valor.includes('institucional');
      });
      
      if (temInstitucional) {
        // Cria o card se nÃ£o existir
        if (!cardViolenciaInstitucional) {
          const cardTipoViolencia = document.querySelector('[data-filter="tipoViolencia"]');
          if (cardTipoViolencia) {
            // Cria o card dinamicamente
            const novoCard = document.createElement('div');
            novoCard.id = 'card-violenciaInstitucional';
            novoCard.className = 'filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm';
            novoCard.setAttribute('data-filter', 'violenciaInstitucional');
            novoCard.onclick = () => openFilterSection('violenciaInstitucional');
            novoCard.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="filter-card-icon text-2xl">ğŸ›ï¸</span>
                  <span class="text-sm font-medium text-gray-700">ViolÃªncias Institucionais</span>
                </div>
                <span id="badge-violenciaInstitucional-total" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
              </div>
            `;
            // Insere apÃ³s o card de Tipo ViolÃªncia
            cardTipoViolencia.insertAdjacentElement('afterend', novoCard);
            cardViolenciaInstitucional = novoCard;
          }
        } else {
          // Card jÃ¡ existe, apenas mostra e posiciona
          cardViolenciaInstitucional.classList.remove('hidden');
          cardViolenciaInstitucional.style.display = '';
          
          // Move o card para aparecer logo apÃ³s o card de Tipo ViolÃªncia
          const cardTipoViolencia = document.querySelector('[data-filter="tipoViolencia"]');
          
          if (cardTipoViolencia) {
            // Verifica se jÃ¡ estÃ¡ na posiÃ§Ã£o correta
            const proximoIrmao = cardTipoViolencia.nextElementSibling;
            if (!proximoIrmao || proximoIrmao.id !== 'card-violenciaInstitucional') {
              // Remove o card de sua posiÃ§Ã£o atual (se estiver em outro lugar)
              if (cardViolenciaInstitucional.parentElement) {
                cardViolenciaInstitucional.remove();
              }
              // Insere apÃ³s o card de Tipo ViolÃªncia
              cardTipoViolencia.insertAdjacentElement('afterend', cardViolenciaInstitucional);
            }
          }
        }
        
        // NOVO: Abre automaticamente a seÃ§Ã£o de ViolÃªncias Institucionais
        setTimeout(() => {
          // Marca automaticamente o checkbox geral "ViolÃªncia Institucional"
          const grupoGeralCheckbox = document.getElementById('checkbox-violencia-institucional-geral');
          if (grupoGeralCheckbox && !grupoGeralCheckbox.checked) {
            grupoGeralCheckbox.checked = true;
            grupoGeralCheckbox.dispatchEvent(new Event('change'));
          }
          
          // Abre a seÃ§Ã£o de filtros se ainda nÃ£o estiver aberta
          if (sectionViolenciaInstitucional && sectionViolenciaInstitucional.classList.contains('hidden')) {
            openFilterSection('violenciaInstitucional');
          }
          
          // Mostra o grÃ¡fico de violÃªncia institucional
          const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
          if (containerChartViolenciaInst) {
            containerChartViolenciaInst.classList.remove('hidden');
          }
          // Re-renderiza os grÃ¡ficos para atualizar o grÃ¡fico de violÃªncia institucional
          if (typeof renderCharts === 'function' && filteredData) {
            renderCharts(filteredData);
          }
        }, 100);
      } else {
        // Esconde o card e limpa os filtros de violÃªncias institucionais
        if (cardViolenciaInstitucional) {
          cardViolenciaInstitucional.classList.add('hidden');
          cardViolenciaInstitucional.style.display = 'none';
        }
        
        // Desmarca todos os checkboxes de violÃªncias institucionais
        const viCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]');
        viCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.indeterminate = false;
        });
        
        // Desmarca o checkbox geral tambÃ©m
        const grupoGeralCheckbox = document.getElementById('checkbox-violencia-institucional-geral');
        if (grupoGeralCheckbox) {
          grupoGeralCheckbox.checked = false;
          grupoGeralCheckbox.indeterminate = false;
        }
        
        // Atualiza badges
        updateBadgeViolenciaInstitucionalTotal();
        
        // Fecha a seÃ§Ã£o se estiver aberta
        if (sectionViolenciaInstitucional && sectionViolenciaInstitucional.classList.contains('show')) {
          sectionViolenciaInstitucional.classList.remove('show');
          sectionViolenciaInstitucional.classList.add('hidden');
          cardViolenciaInstitucional.classList.remove('active');
        }
        
        // Esconde o grÃ¡fico de violÃªncia institucional
        const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
        if (containerChartViolenciaInst) {
          containerChartViolenciaInst.classList.add('hidden');
        }
        // Destroi o grÃ¡fico se existir
        if (charts['chartTipoViolenciaInstitucional']) {
          charts['chartTipoViolenciaInstitucional'].destroy();
          delete charts['chartTipoViolenciaInstitucional'];
        }
        
        // Aplica filtros para atualizar a tabela
        applyFilters();
      }
    }
    
    // Torna a funÃ§Ã£o acessÃ­vel globalmente
    window.verificarViolenciaInstitucionalNoFiltro = verificarViolenciaInstitucionalNoFiltro;
    
    // Coleta todos os encaminhamentos selecionados (de todos os grupos)
    function gatherSelectedEncaminhamentos() {
      const selectedCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
    }
    
    // Verifica se uma cÃ©lula de encaminhamento corresponde aos termos selecionados (lÃ³gica OR)
    function matchEncaminhamentoCell(cellValue, selectedTerms) {
      // Se nenhum termo foi selecionado, aceita todos
      if (selectedTerms.length === 0) return true;
      
      // Se hÃ¡ termos selecionados mas a cÃ©lula estÃ¡ vazia, REJEITA
      if (!cellValue) return false;
      
      // Normalizar cÃ©lula (split por vÃ­rgula e barra)
      const cellValues = String(cellValue)
        .split(',')
        .flatMap(v => v.split('/'))
        .map(v => normalizeText(v.trim()))
        .filter(v => v);
      
      // Se apÃ³s normalizar nÃ£o hÃ¡ valores, REJEITA
      if (cellValues.length === 0) return false;
      
      // Normalizar termos selecionados
      const selectedNormalized = selectedTerms.map(t => normalizeText(t));
      
      // Retorna true se qualquer valor da cÃ©lula estiver nos selecionados (OR)
      return cellValues.some(cv => selectedNormalized.includes(cv));
    }

    // Gera opÃ§Ãµes "agrupadas" por texto normalizado (com suporte a multi-valor)
    function buildNormalizedOptions(colKey, data) {
      const map = new Map(); // norm -> rÃ³tulo original mais comum
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        
        // Suporta valores mÃºltiplos separados por vÃ­rgula E por barra (/)
        // Primeiro separa por vÃ­rgula, depois cada parte por barra
        const valores = String(raw)
          .split(',')
          .flatMap(v => v.split('/'))
          .map(v => v.trim())
          .filter(v => v);
        
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          
          // Guarda o label original mais completo (maior length)
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }
    
    // Gera opÃ§Ãµes para TIPO DE VIOLÃŠNCIA (NÃƒO separa por barra - "Financeira/EconÃ´mica" fica junto)
    function buildNormalizedOptionsTipoViolencia(colKey, data) {
      const map = new Map(); // norm -> rÃ³tulo original mais comum
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        
        // Suporta valores mÃºltiplos separados APENAS por vÃ­rgula
        // NÃƒO separa por barra (/) para manter "Financeira/EconÃ´mica" como uma Ãºnica categoria
        const valores = String(raw)
          .split(',')
          .map(v => v.trim())
          .filter(v => v);
        
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          
          // Guarda o label original mais completo (maior length)
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }
    
    // ========================================
    // NORMALIZAÃ‡ÃƒO DE TRANSTORNOS (UNIFICAÃ‡ÃƒO)
    // ========================================
    // Unifica variaÃ§Ãµes de transtornos em rÃ³tulos padronizados
    function normalizarTranstorno(label) {
      if (!label) return label;
      
      const norm = normalizeText(label);
      
      // EquivalÃªncias para TDAH
      const equivalenciasTDAH = [
        'tdah',
        'tdh',
        'tda h',
        't d a h',
        'deficit de atencao',
        'deficit atencao',
        'deficitdeatencao',
        'deficit hiperatividade',
        'transtorno de deficit',
        'transtorno deficit',
        'transtorno de deficit de atencao',
        'transtorno deficit atencao',
        'deficit de atencao e hiperatividade',
        'deficit de atencao hiperatividade'
      ];
      
      if (equivalenciasTDAH.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TDAH (DÃ©ficit de AtenÃ§Ã£o e Hiperatividade)';
      }
      
      // EquivalÃªncias para TEA (Autismo)
      const equivalenciasTEA = [
        'tea',
        't e a',
        'autismo',
        'autista',
        'transtorno do espectro autista',
        'espectro autista',
        'transtorno autista'
      ];
      
      if (equivalenciasTEA.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TEA (Transtorno do Espectro Autista)';
      }
      
      // EquivalÃªncias para DI (DeficiÃªncia Intelectual)
      const equivalenciasDI = [
        'di ',
        ' di',
        'd i',
        'deficiencia intelectual',
        'deficiencia mental'
      ];
      
      if (equivalenciasDI.some(e => norm === e || norm.includes(e))) {
        return 'DI (DeficiÃªncia Intelectual)';
      }
      
      // EquivalÃªncias para TOD (Transtorno Opositor Desafiador)
      const equivalenciasTOD = [
        'tod',
        't o d',
        'transtorno opositor',
        'opositor desafiador',
        'transtorno opositor desafiador'
      ];
      
      if (equivalenciasTOD.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TOD (Transtorno Opositor Desafiador)';
      }
      
      // Retorna o label original se nÃ£o encontrou equivalÃªncia
      return label;
    }
    
    // Aplica normalizaÃ§Ã£o a uma lista de opÃ§Ãµes
    function normalizarListaTranstornos(opcoes) {
      const map = new Map(); // Usa Map para evitar duplicatas apÃ³s normalizaÃ§Ã£o
      
      opcoes.forEach(opt => {
        const normalizado = normalizarTranstorno(opt);
        // Guarda apenas uma vez (a primeira ocorrÃªncia)
        if (!map.has(normalizado)) {
          map.set(normalizado, true);
        }
      });
      
      return Array.from(map.keys()).sort();
    }
    
    // Gera opÃ§Ãµes para coluna de GÃªnero (apenas M ou F)
    function buildGeneroOptions(data) {
      const valores = new Set();
      data.forEach(row => {
        const genero = row[columnNames.genero];
        if (genero) {
          const val = String(genero).trim().toUpperCase();
          if (val === 'M' || val === 'F') {
            valores.add(val);
          }
        }
      });
      return Array.from(valores).sort();
    }
    
    // Cria checkboxes elegantes para filtros
    function createCheckboxes(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;
        const div = document.createElement('div');
        div.className = 'checkbox-container flex items-center gap-2.5 p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.className = 'custom-checkbox';
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;
        checkbox.addEventListener('change', function() {
          updateBadge(filterName);
          applyFilters();
          
          // Se for filtro de tipoViolencia, verifica se "Institucional" estÃ¡ selecionado
          if (filterName === 'tipoViolencia') {
            verificarViolenciaInstitucionalNoFiltro();
          }
        });
        
        const label = document.createElement('label');
        label.htmlFor = id;
        label.className = 'checkbox-label flex-1 text-gray-700';
        label.textContent = opt;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    function setupEscolaAutocomplete() {
      const input = document.getElementById('filterEscolaSearch');
      const container = document.getElementById('filterEscolaContainer');
      const list = document.getElementById('filterEscolaAutocompleteList');
      const tagsContainer = document.getElementById('filterEscolaSelectedTags');
      if (!input || !container || !list) return;

      if (input.dataset.bound === 'true') return;
      input.dataset.bound = 'true';

      let cached = [];
      let selectedIndex = -1;

      const buildReverseSiglas = () => {
        const rev = { cmei: {}, emef: {} };
        if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS) {
          Object.keys(CMEI_SIGLAS).forEach((sigla) => {
            const nome = CMEI_SIGLAS[sigla];
            if (!sigla || !nome) return;
            const full = `CMEI ${String(nome).trim()}`;
            rev.cmei[normalizeText(full)] = String(sigla).trim();
          });
        }
        if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS) {
          Object.keys(EMEF_SIGLAS).forEach((sigla) => {
            const nome = EMEF_SIGLAS[sigla];
            if (!sigla || !nome) return;
            const full = `EMEF ${String(nome).trim()}`;
            rev.emef[normalizeText(full)] = String(sigla).trim();
          });
        }
        return rev;
      };

      const reverseSiglas = buildReverseSiglas();

      const getNomeFromSigla = (sigla) => {
        const s = String(sigla || '').trim().toUpperCase();
        if (!s) return '';
        if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS && CMEI_SIGLAS[s]) return `CMEI ${CMEI_SIGLAS[s]}`;
        if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS && EMEF_SIGLAS[s]) return `EMEF ${EMEF_SIGLAS[s]}`;
        return '';
      };

      const renderSelectedTags = () => {
        if (!tagsContainer) return;
        const checked = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]:checked'));
        tagsContainer.innerHTML = '';

        if (!checked.length) {
          tagsContainer.innerHTML = '<span class="text-xs text-gray-500">Nenhuma escola selecionada</span>';
          return;
        }

        checked.forEach((cb) => {
          const raw = String(cb.getAttribute('data-value') || '').trim();
          const nomeFromSigla = getNomeFromSigla(raw);
          const label = nomeFromSigla || raw;

          const tag = document.createElement('span');
          tag.className = 'selected-tag';

          const tipo = getTipoInstituicao(label) || getTipoInstituicao(raw) || '';
          if (tipo) {
            const badge = document.createElement('span');
            badge.className = `autocomplete-badge ${String(tipo).toLowerCase()}`;
            badge.textContent = tipo;
            tag.appendChild(badge);
          }

          const text = document.createElement('span');
          text.className = 'selected-tag-label';
          text.textContent = label;
          tag.appendChild(text);

          const remove = document.createElement('button');
          remove.type = 'button';
          remove.className = 'selected-tag-remove';
          remove.textContent = 'Ã—';
          remove.addEventListener('click', () => {
            cb.checked = false;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
          });
          tag.appendChild(remove);

          tagsContainer.appendChild(tag);
        });
      };

      const rebuildCache = () => {
        // Base do autocomplete = opÃ§Ãµes realmente existentes no filtro (vindas da planilha)
        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]'));

        cached = checkboxes
          .map((cb) => {
            const raw = String(cb.getAttribute('data-value') || '').trim();
            if (!raw) return null;

            // Se o valor do checkbox for uma sigla, resolve o nome completo (para exibir/pesquisar por nome)
            const nomeFromSigla = getNomeFromSigla(raw);
            const value = nomeFromSigla || raw;
            const tipo = getTipoInstituicao(value) || getTipoInstituicao(raw) || '';

            // Determina sigla real (se raw jÃ¡ for sigla, usa; se raw for nome, tenta achar no reverse)
            let sigla = '';
            if (nomeFromSigla) {
              sigla = raw;
            } else {
              const key = normalizeText(raw);
              sigla = reverseSiglas.cmei[key] || reverseSiglas.emef[key] || '';
            }

            const normalized = normalizeText(value);
            const siglaNormalized = normalizeText(sigla);

            return {
              checkboxValue: raw,
              value,
              tipo,
              sigla,
              siglaNormalized,
              normalized,
            };
          })
          .filter(Boolean);
      };

      const closeList = () => {
        list.classList.remove('show');
        input.classList.remove('autocomplete-open');
        selectedIndex = -1;
      };

      const openList = () => {
        if (!list.classList.contains('show')) list.classList.add('show');
        input.classList.add('autocomplete-open');
      };

      const updateSelectedVisual = () => {
        const items = Array.from(list.querySelectorAll('.autocomplete-item'));
        items.forEach((el, idx) => {
          if (idx === selectedIndex) el.classList.add('active');
          else el.classList.remove('active');
        });
        if (selectedIndex >= 0 && items[selectedIndex]) {
          items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      };

      const filterItems = (termRaw) => {
        // Replica o algoritmo do novo registro:
        // - palavras devem bater no NOME
        // - sigla (sem espaÃ§os) bate por includes
        // - iniciais consecutivas bate por startsWith na sigla
        const termoLower = normalizeText(String(termRaw || '')).trim();
        const termoSemEspacos = termoLower.replace(/\s+/g, '');
        const palavras = termoLower.split(/\s+/).filter(Boolean);

        if (!termoLower) return [];

        // NÃ£o sugere opÃ§Ãµes jÃ¡ selecionadas
        const selectedSet = new Set(
          Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]:checked'))
            .map((cb) => normalizeText(String(cb.getAttribute('data-value') || '').trim()))
            .filter(Boolean)
        );

        return cached.filter((it) => {
          const key = normalizeText(String(it.checkboxValue || '').trim());
          if (key && selectedSet.has(key)) return false;

          const nomeNormalizado = it.normalized;
          const siglaNormalizada = it.siglaNormalized || '';

          const matchPorPalavras = palavras.length ? palavras.every(p => nomeNormalizado.includes(p)) : true;
          const matchPorSigla = termoSemEspacos ? siglaNormalizada.includes(termoSemEspacos) : true;
          const matchPorIniciaisConsecutivas = termoSemEspacos ? siglaNormalizada.startsWith(termoSemEspacos) : true;

          return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
        });
      };

      const selectItem = (it) => {
        // Multi-seleÃ§Ã£o: alterna o checkbox correspondente e mantÃ©m os demais
        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]'));

        // Encontra o checkbox correspondente
        const target = normalizeText(String(it.checkboxValue || '').trim());
        const cbMatch = checkboxes.find((cb) => {
          const v = String(cb.getAttribute('data-value') || '').trim();
          return normalizeText(v) === target;
        });

        if (cbMatch) {
          cbMatch.checked = !cbMatch.checked;
          cbMatch.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // Limpa para permitir adicionar outra escola rapidamente
        input.value = '';
        input.focus();
        closeList();
      };

      const render = (results) => {
        list.innerHTML = '';

        if (!results.length) {
          list.innerHTML = '<div class="no-results">ğŸ” Nenhuma instituiÃ§Ã£o encontrada</div>';
          openList();
          return;
        }

        results.slice(0, 60).forEach((it, idx) => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';

          const badge = document.createElement('span');
          badge.className = `autocomplete-badge ${String(it.tipo || '').toLowerCase()}`;
          badge.textContent = it.tipo || '';

          const infoContainer = document.createElement('div');
          infoContainer.className = 'flex flex-col';

          const nomeSemTipo = it.tipo ? String(it.value).replace(String(it.tipo) + ' ', '') : it.value;
          const nomeSpan = document.createElement('span');
          nomeSpan.className = 'autocomplete-nome';
          nomeSpan.textContent = nomeSemTipo;

          const siglaSpan = document.createElement('span');
          siglaSpan.className = 'text-xs text-gray-500 mt-0.5';
          siglaSpan.textContent = `Sigla: ${it.sigla || ''}`;

          infoContainer.appendChild(nomeSpan);
          infoContainer.appendChild(siglaSpan);

          if (it.tipo) item.appendChild(badge);
          item.appendChild(infoContainer);

          item.addEventListener('click', () => selectItem(it));
          list.appendChild(item);
          if (idx === 0) selectedIndex = 0;
        });

        openList();
        updateSelectedVisual();
      };

      input.addEventListener('input', function() {
        const termRaw = String(this.value || '').trim();
        selectedIndex = -1;
        if (termRaw.length === 0) {
          list.innerHTML = '';
          closeList();
          return;
        }
        const results = filterItems(termRaw);
        render(results);
      });

      input.addEventListener('keydown', function(e) {
        const items = Array.from(list.querySelectorAll('.autocomplete-item'));
        if (!items.length) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedVisual();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedVisual();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
          }
        } else if (e.key === 'Escape') {
          closeList();
        }
      });

      document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          closeList();
        }
      });

      // MantÃ©m cache atualizado quando createCheckboxes recriar o container
      const obs = new MutationObserver(() => {
        rebuildCache();
        renderSelectedTags();
      });
      obs.observe(container, { childList: true, subtree: true });

      // Atualiza tags quando checkboxes mudarem (event delegation)
      container.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.matches && t.matches('input[type="checkbox"][data-filter="escola"]')) {
          renderSelectedTags();
        }
      });

      rebuildCache();
      renderSelectedTags();
    }
    
    // ObtÃ©m valores selecionados dos checkboxes
    function getCheckedValues(filterName) {
      const checkboxes = document.querySelectorAll(`input[data-filter="${filterName}"]:checked`);
      return Array.from(checkboxes).map(cb => cb.dataset.value);
    }
    
    // Atualiza o badge de contagem
    function updateBadge(filterName) {
      const count = getCheckedValues(filterName).length;
      const badge = document.getElementById(`badge-${filterName}`);
      
      // Verifica se o badge existe antes de tentar acessar suas propriedades
      if (!badge) {
        console.warn(`[updateBadge] Badge nÃ£o encontrado para filtro: ${filterName}`);
        return;
      }
      
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    // Atualiza badge para filtro TI (select ao invÃ©s de checkboxes)
    function updateBadgeTI() {
      const selectTI = document.getElementById('filterTI');
      const badge = document.getElementById('badge-ti');
      
      if (selectTI && selectTI.value && selectTI.value !== '') {
        badge.textContent = '1';
        badge.classList.remove('hidden');
      } else if (badge) {
        badge.classList.add('hidden');
      }
    }

    // Formata data para exibiÃ§Ã£o (dd/mm/aaaa)
    function formatDate(value) {
      if (!value || value === '') return null; // Retorna null para valores vazios
      const date = parseDateCell(value);
      if (!date) return value; // Se nÃ£o conseguir parsear, retorna o valor original
      
      const dia = String(date.getDate()).padStart(2, '0');
      const mes = String(date.getMonth() + 1).padStart(2, '0');
      const ano = date.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    // Converte cÃ©lula de data (dd/mm/aaaa, nÃºmero serial do Excel, etc.) em Date
    function parseDateCell(value) {
      const str = String(value || '').trim();
      if (!str) return null;

      // IMPORTANTE: Formato Date(YYYY,M,D) do Google Sheets
      // O mÃªs jÃ¡ vem base-0 (0=janeiro, 11=dezembro)
      const dateMatch = str.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
      if (dateMatch) {
        const ano = parseInt(dateMatch[1], 10);
        const mes = parseInt(dateMatch[2], 10); // JÃ¡ estÃ¡ em base-0
        const dia = parseInt(dateMatch[3], 10);
        return new Date(ano, mes, dia);
      }

      // Tenta formato dd/mm/aaaa ou dd-mm-aaaa (brasileiro)
      const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let dia = parseInt(m[1], 10);
        let mes = parseInt(m[2], 10) - 1;
        let ano = parseInt(m[3], 10);
        if (ano < 100) ano += 2000;
        
        // Valida se a data Ã© vÃ¡lida
        const d = new Date(ano, mes, dia);
        if (d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia) {
          return d;
        }
        return null;
      }

      // Tenta como nÃºmero serial do Excel (ex: 45803)
      const num = parseFloat(str);
      if (!isNaN(num) && num > 1 && num < 100000) {
        // Excel conta dias desde 01/01/1900
        // Mas Excel tem um bug: considera 1900 como ano bissexto (nÃ£o Ã©)
        // EntÃ£o para datas >= 01/03/1900, subtraÃ­mos 1 dia extra
        const excelEpoch = new Date(1899, 11, 30); // 30/12/1899
        const days = num >= 60 ? num - 1 : num; // Corrige bug do Excel
        const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
        return date;
      }

      // Tenta parse direto (formato ISO ou outros)
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    // ==============================
    // InicializaÃ§Ã£o da pÃ¡gina
    // ==============================
    window.addEventListener('load', function() {
      // Estado global de atualizaÃ§Ã£o (compartilhado via localStorage)
      window.EstadoBotaoAtualizacaoPainel = false;
      
      // Event listeners do modal
      const modal = document.getElementById('modal-detalhes');
      
      // Fechar modal ao clicar fora
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            fecharModalDetalhes();
          }
        });
      }
      
      // Fechar modal com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (modal && modal.classList.contains('visible')) {
            fecharModalDetalhes();
          }
        }
      });
      // Ao clicar em Atualizar Dados, atualiza estado global, invalida cache e carrega dados
      document.getElementById('btnAtualizar').addEventListener('click', function() {
        try {
          window.EstadoBotaoAtualizacaoPainel = true;
          localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
            state: true,
            timestamp: Date.now(),
            source: 'painel-casos'
          }));
          console.log('[Painel] ğŸ§­ Estado global definido: Atualizar Dados clicado');
        } catch (e) {
          console.warn('[Painel] âš ï¸ Erro ao definir estado global:', e);
        }

        // Garante limpeza de cache e recarrega notificaÃ§Ãµes
        if (typeof limparCacheERecarregarNotificacoes === 'function') {
          limparCacheERecarregarNotificacoes();
        }
        // Comportamento normal do botÃ£o
        // Passa true para indicar que Ã© uma aÃ§Ã£o explÃ­cita do usuÃ¡rio
        if (typeof carregarDadosPlanilha === 'function') {
          carregarDadosPlanilha(true);
        }
      });
      
      // Event listeners de paginaÃ§Ã£o
      document.getElementById('btnPrimeiraPagina').addEventListener('click', () => irParaPagina(1));
      document.getElementById('btnPaginaAnterior').addEventListener('click', () => irParaPagina(paginaAtual - 1));
      document.getElementById('btnProximaPagina').addEventListener('click', () => irParaPagina(paginaAtual + 1));
      document.getElementById('btnUltimaPagina').addEventListener('click', () => irParaPagina(totalPaginas));
      document.getElementById('registrosPorPaginaSelect').addEventListener('change', alterarRegistrosPorPagina);
      
      // Event listeners de exportaÃ§Ã£o e dashboard
      const btnExportarCSV = document.getElementById('btnExportarCSV');
      const btnExportarExcel = document.getElementById('btnExportarExcel');
      const btnExportarPDF = document.getElementById('btnExportarPDF');
      const btnAtualizarKPIs = document.getElementById('btnAtualizarKPIs');
      
      // Wrapper para atualizarKPIs que limpa cache e recarrega notificaÃ§Ãµes
      function atualizarKPIsComLimpeza() {
        // Limpa cache e recarrega notificaÃ§Ãµes antes de atualizar KPIs
        if (typeof limparCacheERecarregarNotificacoes === 'function') {
          limparCacheERecarregarNotificacoes();
        }
        // Chama a funÃ§Ã£o original de atualizar KPIs
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }
      
      if (btnExportarCSV) btnExportarCSV.addEventListener('click', exportarCSV);
      if (btnExportarExcel) btnExportarExcel.addEventListener('click', exportarExcel);
      if (btnExportarPDF) btnExportarPDF.addEventListener('click', exportarPDF);
      if (btnAtualizarKPIs) btnAtualizarKPIs.addEventListener('click', atualizarKPIsComLimpeza);
      
      // Carrega os dados automaticamente ao iniciar
      carregarDadosPlanilha();
    });
    
    // Abre seÃ§Ã£o especÃ­fica do filtro
    function openFilterSection(filterName) {
      const panel = document.getElementById('advancedPanel');
      const section = document.getElementById(`section-${filterName}`);
      const card = document.querySelector(`[data-filter="${filterName}"]`);
      
      // Se a seÃ§Ã£o jÃ¡ estÃ¡ visÃ­vel, esconde
      if (section.classList.contains('show')) {
        section.classList.remove('show');
        section.classList.add('hidden');
        card.classList.remove('active');
        
        // Se todas as seÃ§Ãµes estÃ£o escondidas, fecha o painel
        const visibleSections = document.querySelectorAll('.filter-section.show');
        if (visibleSections.length === 0) {
          panel.classList.remove('open');
        }
      } else {
        // Abre o painel se estiver fechado
        if (!panel.classList.contains('open')) {
          panel.classList.add('open');
        }
        
        // Mostra a seÃ§Ã£o
        section.classList.remove('hidden');
        section.classList.add('show');
        card.classList.add('active');
        
        // Scroll suave atÃ© a seÃ§Ã£o
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // Busca nome de coluna
    function findColumn(data, possibleNames) {
      if (!data || data.length === 0) return null;
      const keys = Object.keys(data[0]);
      
      for (const possible of possibleNames) {
        const found = keys.find(k => {
          const kLower = k.toLowerCase().trim();
          const pLower = possible.toLowerCase().trim();
          // Busca exata ou que contenha (mas nÃ£o ao contrÃ¡rio para evitar "Idade" pegar "Identidade")
          return kLower === pLower || kLower.includes(pLower);
        });
        if (found) return found;
      }
      return null;
    }

    // ==============================
    // Carregamento de dados do Google Sheets via JSONP
    // ==============================
    
    // ID da planilha (extraÃ­do do link de ediÃ§Ã£o)
    // Usando configuraÃ§Ã£o centralizada (config.js)
    const SPREADSHEET_ID = (typeof CONFIG !== 'undefined' && CONFIG.SPREADSHEET_ID) 
      ? CONFIG.SPREADSHEET_ID 
      : '1A6a2ZLiHegPJBDpE3YLPGsa8RXVRLjpkXmKdauSlb9Y';
    
    function carregarDadosPlanilha(isUserAction = false) {
      // Armazena flag para uso no callback de sucesso
      window._carregarDadosPlanilhaIsUserAction = isUserAction;
      
      // âœ¨ Remove alerta e animaÃ§Ã£o quando usuÃ¡rio clica para carregar
      // (indica que ele viu a notificaÃ§Ã£o e estÃ¡ atualizando)
      if (typeof NotificationManager !== 'undefined' && NotificationManager.state === 'alert_showing') {
        NotificationManager.startAlertExit();
      }
      
      // Remove o alerta vermelho de notificaÃ§Ãµes novas
      const alertaExistente = document.getElementById('alerta-novas-notificacoes');
      if (alertaExistente) {
        alertaExistente.remove();
        console.log('[Painel] ğŸ”´ Alerta de notificaÃ§Ãµes removido do DOM');
      }
      
      // Remove animaÃ§Ã£o do botÃ£o
      desativarPulseBotao('btnAtualizar');
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO: SÃ³ marca como atualizado se for uma aÃ§Ã£o explÃ­cita do usuÃ¡rio
      // (nÃ£o marca se for chamada automaticamente durante navegaÃ§Ã£o ou carregamento inicial)
      if (isUserAction) {
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
        if (ultimoIdSalvo) {
          const notifId = parseInt(ultimoIdSalvo, 10);
          if (typeof marcarPopupAzulAtualizado === 'function') {
            marcarPopupAzulAtualizado(notifId);
          }
          // Atualiza Ãºltimo ID sincronizado imediatamente
          try {
            localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
            console.log('[Sync] âœ… Estado sincronizado limpo e Ãºltimo ID atualizado apÃ³s clique no botÃ£o Atualizar Dados');
            // Zera contador global de novas notificaÃ§Ãµes
            localStorage.removeItem('naam_new_notif_count');
          } catch (e) {
            console.warn('[Sync] âš ï¸ Erro ao atualizar estado sincronizado:', e);
          }
        }
      }
      
      // Limpa flag do localStorage
      try {
        localStorage.removeItem('naam_new_notif_flag');
      } catch (e) {
        console.warn('[carregarDadosPlanilha] Erro ao limpar flag:', e);
      }
      
      // Limpa cache e recarrega notificaÃ§Ãµes antes de carregar dados
      if (typeof limparCacheERecarregarNotificacoes === 'function') {
        limparCacheERecarregarNotificacoes();
      }
      
      // ValidaÃ§Ã£o: Verifica se SPREADSHEET_ID estÃ¡ configurado
      if (!SPREADSHEET_ID || SPREADSHEET_ID.includes('SEU_ID_DA_PLANILHA_AQUI') || SPREADSHEET_ID.trim() === '') {
        updateUploadStatus('error', 'âš ï¸ Configure SPREADSHEET_ID em config.js para carregar dados da planilha');
        console.error('âŒ SPREADSHEET_ID nÃ£o configurado em config.js');
        return;
      }
      
      updateUploadStatus('loading', 'â³ Carregando dados da planilha...');
      
      console.log('ğŸ”„ Buscando dados via JSONP...');
      
      // Remove script antigo se existir
      const oldScript = document.getElementById('jsonp-script');
      if (oldScript) {
        oldScript.remove();
      }
      
      // Timestamp para evitar cache
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 15);
      
      // Cria objeto global google.visualization para interceptar a resposta
      if (!window.google) {
        window.google = {};
      }
      if (!window.google.visualization) {
        window.google.visualization = {};
      }
      if (!window.google.visualization.Query) {
        window.google.visualization.Query = {};
      }
      
      // Define funÃ§Ã£o que receberÃ¡ os dados
      window.google.visualization.Query.setResponse = function(response) {
        try {
          console.log('âœ… Dados recebidos via JSONP');
          
          if (!response || !response.table || !response.table.rows) {
            updateUploadStatus('error', 'âŒ Formato de resposta invÃ¡lido');
            return;
          }
          
          // Extrai cabeÃ§alhos
          const headers = response.table.cols.map(col => col.label || '');
          
          // Converte linhas para objetos
          const data = response.table.rows.map(row => {
            const obj = {};
            row.c.forEach((cell, index) => {
              const header = headers[index];
              if (header) {
                obj[header] = cell && cell.v !== null && cell.v !== undefined ? cell.v : '';
              }
            });
            return obj;
          });
          
          console.log('ğŸ“Š Total de registros:', data.length);
          
          // Limpa dados anteriores
          originalData = [];
          filteredData = [];
          window.originalData = [];
          window.filteredData = [];
          
          processLoadedData(data);
          
          // âœ¨ SINCRONIZAÃ‡ÃƒO: ApÃ³s carregar dados com sucesso, atualiza Ãºltimo ID sincronizado
          // SÃ³ atualiza se foi uma aÃ§Ã£o explÃ­cita do usuÃ¡rio (isUserAction = true)
          // Isso Ã© controlado pela flag window._carregarDadosPlanilhaIsUserAction
          setTimeout(() => {
            if (window._carregarDadosPlanilhaIsUserAction) {
              const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
              if (ultimoIdSalvo) {
                const notifId = parseInt(ultimoIdSalvo, 10);
                try {
                  localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
                  console.log('[Sync] âœ… Ãšltimo ID sincronizado atualizado apÃ³s carregar dados (aÃ§Ã£o do usuÃ¡rio):', notifId);
                } catch (e) {
                  console.warn('[Sync] âš ï¸ Erro ao atualizar Ãºltimo ID sincronizado:', e);
                }
              }
              // Limpa a flag
              window._carregarDadosPlanilhaIsUserAction = false;
            }
          }, 1000);
          
        } catch (error) {
          console.error('âŒ Erro ao processar:', error);
          updateUploadStatus('error', 'âŒ Erro ao processar dados: ' + error.message);
        }
      };
      
      // Cria script tag para JSONP (nÃ£o usa fetch, nÃ£o precisa de proxy)
      const script = document.createElement('script');
      script.id = 'jsonp-script';
      script.src = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&_=${timestamp}&r=${random}`;
      
      script.onerror = function() {
        console.error('âŒ Erro ao carregar script');
        updateUploadStatus('error', 'âŒ Erro ao conectar com Google Sheets. Verifique se a planilha estÃ¡ compartilhada como "Qualquer pessoa com o link pode visualizar"');
      };
      
      document.head.appendChild(script);
    }

    function processLoadedData(data) {
      if (!data || data.length === 0) {
        updateUploadStatus('error', 'âŒ Arquivo vazio ou sem dados vÃ¡lidos');
        return;
      }
      
      originalData = data;
      filteredData = [...data];
      
      // Atualiza variÃ¡veis globais para dashboard-stats.js
      window.originalData = originalData;
      window.filteredData = filteredData;
      
      // Mapeia colunas - Atualizado para novo cabeÃ§alho
      columnNames = {
        // CrianÃ§a/Estudante
        crianca: findColumn(data, ['crianÃ§a/ estudante', 'crianca/ estudante', 'crianÃ§a/estudante', 'crianca/estudante', 'crianÃ§a', 'crianca', 'estud']),
        
        // Data da NT
        data: findColumn(data, ['data da nt', 'data nt', 'data da', 'data', 'dt']),
        
        // Idade
        idade: findColumn(data, ['idade']),
        
        // Identidade de GÃªnero
        genero: findColumn(data, ['identidade de gÃªnero', 'identidade de genero', 'gÃªnero', 'genero', 'sexo']),
        
        // Ã‰ PCD/tem Transtorno?
        pcd: findColumn(data, ['Ã© pcd/tem transtorno', 'e pcd/tem transtorno', 'pcd/tem transtorno', 'pcd', 'deficiÃªncia', 'deficiencia', 'transtorno']),
        
        // Qual o Transtorno?
        detalhePCD: findColumn(data, [
          'qual o transtorno',
          'qual transtorno',
          'transtorno',
          'detalhamento',
          'detalhamento pcd',
          'detalhamento transtorno',
          'tipo de deficiencia',
          'tipo de deficiÃªncia',
          'tipo de transtorno',
          'detalhamento de pcd',
          'detalhamento de transtorno'
        ]),
        
        // RaÃ§a/Cor
        raca: findColumn(data, ['raÃ§a/cor', 'raca/cor', 'raÃ§a', 'raca', 'cor']),
        
        // Qual a OrientaÃ§Ã£o Sexual?
        orientacaoSexual: findColumn(data, ['qual a orientaÃ§Ã£o sexual', 'qual a orientacao sexual', 'orientaÃ§Ã£o sexual', 'orientacao sexual', 'orientaÃ§Ã£o', 'orientacao']),
        
        // Tipo de ViolÃªncia
        tipo: findColumn(data, ['tipo de violÃªncia', 'tipo de violencia', 'tipo']),
        
        // Tipo de ViolÃªncia Institucional (coluna K)
        // OBS: Aceita tanto o novo cabeÃ§alho quanto o antigo ("motivaÃ§Ã£o da violÃªncia"),
        // mas SEMPRE trata essa coluna como detalhamento da violÃªncia institucional.
        tipoViolenciaInstitucional: findColumn(data, [
          // Novos nomes esperados
          'tipo de violÃªncia institucional',
          'tipo de violencia institucional',
          'violencia institucional',
          'violÃªncia institucional',
          'tipo violencia institucional',
          // Nomes antigos reaproveitados (motivaÃ§Ã£o da violÃªncia)
          'qual a motivaÃ§Ã£o da violencia',
          'qual a motivacao da violencia',
          'motivaÃ§Ã£o da violencia',
          'motivacao da violencia',
          'motivaÃ§Ã£o',
          'motivacao'
        ]),
        
        // Encaminhamento
        encaminhamento: findColumn(data, ['encaminhamento']),
        
        // CMEI/EMEF
        escola: findColumn(data, ['cmei/emef', 'cmei / emef', 'cmei', 'emef', 'escola']),
        
        // RegiÃ£o
        regiao: findColumn(data, ['regiÃ£o', 'regiao']),
        
        // ResponsÃ¡vel pelo Registro
        responsavel: findColumn(data, ['responsÃ¡vel pelo registro', 'responsavel pelo registro', 'responsÃ¡vel', 'responsavel']),
        
        // fonte informadores foi a escola?
        fonteInformada: findColumn(data, ['fonte informadores foi a escola', 'fonte informadora foi a escola', 'fonte informada', 'fonte']),
        
        // violÃªncia identificada pela escola ocorrida na escola
        violenciaEscolaOcorreu: findColumn(data, ['violÃªncia identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida']),
        
        // Algum profissional da escola foi autor da violÃªncia
        profissionalAutor: findColumn(data, ['algum profissional da escola foi autor da violÃªncia', 'algum profissional da escola foi autor', 'profissional da escola foi autor', 'profissional autor']),
        
        // Album estudante foi autor da violÃªncia?? (Algum)
        estudanteAutor: findColumn(data, ['album estudante foi autor da violÃªncia', 'algum estudante foi autor da violÃªncia', 'algum estudante foi autor', 'estudante foi autor', 'estudante autor']),
        
        // violÃªncia identificada pela escola nÃ£o ocorrida na escola
        violenciaNaoEscola: findColumn(data, ['violÃªncia identificada pela escola nÃ£o ocorrida na escola', 'violencia identificada pela escola nao ocorrida na escola', 'violÃªncia identificada pela escola nÃ£o ocorrida', 'violencia nao ocorrida']),
        
        // ocorreu na escola? 1.1
        ocorreu: findColumn(data, ['ocorreu na escola? 1.1', 'ocorreu na escola', 'ocorreu']),
        
        // violÃªncia informada a escola por qualquer um dos agentes que a compÃµe 1.2
        violenciaInformada: findColumn(data, ['violÃªncia informada a escola por qualquer um dos agentes que a compÃµe', 'violencia informada a escola', 'violÃªncia informada Ã  escola', 'violencia informada', 'violÃªncia informada']),
        
        // Estudo de Caso
        estudoCaso: findColumn(data, [
          'foi realizado estudo de caso',
          'foi realizado estudo de caso?',
          'estudo de caso',
          'estudo caso',
          'estudo caso?',
          'estudo'
        ])
        ,
        // Foi um membro familiar?
        foiMembroFamiliar: findColumn(data, [
          'foi um membro familiar?',
          'foi um membro familiar',
          'membro familiar',
          'foi membro familiar',
          'membro da famÃ­lia',
          'membro da familia',
          'familiar',
          'foi familiar'
        ])
      };
      
      // Debug essencial (reduzido)
      console.log('Todas as colunas do primeiro registro:', Object.keys(data[0]));
      if (columnNames.genero && data.length > 0) {
        console.log('Exemplo de gÃªnero (primeiro registro):', data[0][columnNames.genero]);
        console.log('Exemplo de gÃªnero (segundo registro):', data[1] ? data[1][columnNames.genero] : 'N/A');
        console.log('Exemplo de gÃªnero (terceiro registro):', data[2] ? data[2][columnNames.genero] : 'N/A');
      }
      if (columnNames.detalhePCD && data.length > 0) {
        console.log('Exemplo de detalhePCD (primeiro registro):', data[0][columnNames.detalhePCD]);
        console.log('Exemplo de detalhePCD (segundo registro):', data[1] ? data[1][columnNames.detalhePCD] : 'N/A');
        console.log('Exemplo de detalhePCD (terceiro registro):', data[2] ? data[2][columnNames.detalhePCD] : 'N/A');
      }
      
      // Verifica se estÃ¡ pegando a coluna errada
      if (columnNames.genero === 'Idade') {
        console.warn('âš ï¸ ERRO: GÃªnero estÃ¡ mapeado para coluna Idade!');
        // Tenta encontrar pela letra da coluna
        const primeiroRegistro = data[0];
        const colunas = Object.keys(primeiroRegistro);
        console.log('Colunas disponÃ­veis:', colunas);
        
        // Procura coluna que contenha apenas M ou F
        for (const col of colunas) {
          const valores = data.slice(0, 10).map(row => String(row[col] || '').trim().toUpperCase());
          const todosMouF = valores.every(v => v === '' || v === 'M' || v === 'F');
          if (todosMouF && valores.some(v => v === 'M' || v === 'F')) {
            console.log(`âœ“ Coluna candidata para gÃªnero: "${col}" - valores:`, valores);
          }
        }
      }
      
      console.log('=== FIM DEBUG ===');
      
      // Atualiza variÃ¡veis globais para dashboard-stats.js
      window.columnNames = columnNames;
      
      updateUploadStatus('success', `âœ… Arquivo carregado â€“ ${data.length} registros`);
      
      initializeFilters(data);
      
      document.getElementById('filtersSection').classList.remove('hidden');
      document.getElementById('statsSection').classList.remove('hidden');
      document.getElementById('chartsSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('dashboardExecutivo').classList.remove('hidden');
      
      // Resetar para primeira pÃ¡gina ao carregar dados
      paginaAtual = 1;
      
      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs do Dashboard Executivo
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 500);
    }

    function updateUploadStatus(type, message) {
      const statusDiv = document.getElementById('uploadStatus');
      statusDiv.textContent = message;
      statusDiv.className = 'p-4 rounded-md';
      
      if (type === 'loading') {
        statusDiv.classList.add('bg-blue-50', 'text-blue-700');
      } else if (type === 'success') {
        statusDiv.classList.add('bg-green-50', 'text-green-700');
      } else if (type === 'error') {
        statusDiv.classList.add('bg-red-50', 'text-red-700');
      } else {
        statusDiv.classList.add('bg-gray-50', 'text-gray-600');
      }
    }

    // ==============================
    // Filtros
    // ==============================
    function initializeFilters(data) {
      if (columnNames.regiao) {
        const valores = buildNormalizedOptions(columnNames.regiao, data);
        createCheckboxes('filterRegiaoContainer', valores, 'regiao');
      }
      if (columnNames.tipo) {
        // Usa funÃ§Ã£o especÃ­fica que NÃƒO separa por barra (mantÃ©m "Financeira/EconÃ´mica" junto)
        const valores = buildNormalizedOptionsTipoViolencia(columnNames.tipo, data);
        createCheckboxes('filterTipoViolenciaContainer', valores, 'tipoViolencia');
        
        // Adiciona listener para verificar quando "Institucional" Ã© selecionado
        const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]');
        tipoViolenciaCheckboxes.forEach(cb => {
          cb.addEventListener('change', verificarViolenciaInstitucionalNoFiltro);
        });
        
        // Verifica inicialmente se hÃ¡ "Institucional" jÃ¡ selecionado
        setTimeout(verificarViolenciaInstitucionalNoFiltro, 500);
      }
      if (columnNames.escola) {
        // Filtro por tipo de instituiÃ§Ã£o (CMEI/EMEF/NÃ£o Encontrada)
        const tiposSet = new Set();
        data.forEach(row => {
          const tipo = getTipoInstituicao(row[columnNames.escola]);
          if (tipo) {
            tiposSet.add(tipo);
          } else if (row[columnNames.escola]) {
            tiposSet.add('NÃ£o Encontrada');
          }
        });
        const tiposInstituicao = Array.from(tiposSet).sort();
        createCheckboxes('filterTipoInstituicaoContainer', tiposInstituicao, 'tipoInstituicao');
        
        // Filtro por escola especÃ­fica
        const valores = buildNormalizedOptions(columnNames.escola, data);
        createCheckboxes('filterEscolaContainer', valores, 'escola');
      }
      if (columnNames.encaminhamento) {
        const valores = buildNormalizedOptions(columnNames.encaminhamento, data);
        buildEncaminhamentoGroups(valores);
      }
      if (columnNames.raca) {
        const valores = buildNormalizedOptions(columnNames.raca, data);
        createCheckboxes('filterRacaContainer', valores, 'raca');
      }
      if (columnNames.genero) {
        const valores = buildGeneroOptions(data); // FunÃ§Ã£o especÃ­fica para gÃªnero
        createCheckboxes('filterGeneroContainer', valores, 'genero');
      }
      
      // NOVO FILTRO: Tipo de deficiÃªncia/transtorno
      // Gera automaticamente as opÃ§Ãµes a partir da coluna detalhePCD
      // Suporta valores mÃºltiplos separados por vÃ­rgula
      // APLICA NORMALIZAÃ‡ÃƒO para unificar variaÃ§Ãµes (TDAH/TDH/tdh, etc.)
      if (columnNames.detalhePCD) {
        const valoresBrutos = buildNormalizedOptions(columnNames.detalhePCD, data);
        const valoresNormalizados = normalizarListaTranstornos(valoresBrutos);
        createCheckboxes('filterTipoDeficienciaContainer', valoresNormalizados, 'tipoDeficiencia');
      }
      
      // NOVO FILTRO: OrientaÃ§Ã£o Sexual
      if (columnNames.orientacaoSexual) {
        const valores = buildNormalizedOptions(columnNames.orientacaoSexual, data);
        createCheckboxes('filterOrientacaoContainer', valores, 'orientacao');
      }
      
      // NOVO FILTRO: ViolÃªncias Institucionais (agrupadas, similar aos encaminhamentos)
      // SÃ³ constrÃ³i os grupos se a coluna existir (mas o card sÃ³ aparece quando "Institucional" estÃ¡ selecionado)
      if (columnNames.tipoViolenciaInstitucional) {
        buildViolenciaInstitucionalGroups(data);
      }
      
      // Verifica se "Institucional" jÃ¡ estÃ¡ selecionado ao carregar os dados
      setTimeout(verificarViolenciaInstitucionalNoFiltro, 1000);
      

      // Adiciona o filtro de membro familiar
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada', 'filterEstudoCaso',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI',
        'filterMembroFamiliar' // <-- Adicionado aqui
      ];

      filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          // Para inputs type="date", usar 'change' ao invÃ©s de 'input'
          const eventType = (element.type === 'date') ? 'change' : 
                           (element.tagName === 'INPUT') ? 'input' : 'change';
          element.addEventListener(eventType, applyFilters);
        }
      });

      function syncConditionalOcorreuEscola() {
        const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
        const ocorreuContainer = document.getElementById('filterOcorreuEscolaContainer');
        const ocorreuSelect = document.getElementById('filterOcorreuEscola');
        if (!violenciaInformadaEl || !ocorreuContainer || !ocorreuSelect) return;

        const shouldShow = String(violenciaInformadaEl.value || '') === 'S';

        const isHidden = ocorreuContainer.classList.contains('hidden');
        const isAnimating = ocorreuContainer.classList.contains('is-animating');

        const animateIn = () => {
          if (isAnimating) return;
          ocorreuContainer.classList.add('is-animating');
          ocorreuContainer.classList.remove('hidden');

          // Estado inicial: "de dentro" (contraÃ­do e levemente acima)
          ocorreuContainer.style.height = '0px';
          ocorreuContainer.style.opacity = '0';
          ocorreuContainer.style.transform = 'translateY(-8px) scaleY(0.98)';

          // ForÃ§a layout
          void ocorreuContainer.offsetHeight;

          const target = ocorreuContainer.scrollHeight;
          ocorreuContainer.style.transition = 'height 260ms cubic-bezier(0.16, 1, 0.3, 1), opacity 200ms ease, transform 260ms cubic-bezier(0.16, 1, 0.3, 1)';

          requestAnimationFrame(() => {
            ocorreuContainer.style.height = `${target}px`;
            ocorreuContainer.style.opacity = '1';
            ocorreuContainer.style.transform = 'translateY(0) scaleY(1)';
          });

          const onEnd = (ev) => {
            if (ev && ev.target !== ocorreuContainer) return;
            ocorreuContainer.removeEventListener('transitionend', onEnd);
            ocorreuContainer.style.transition = '';
            ocorreuContainer.style.height = '';
            ocorreuContainer.style.opacity = '';
            ocorreuContainer.style.transform = '';
            ocorreuContainer.classList.remove('is-animating');
            ocorreuContainer.style.overflow = '';
          };
          ocorreuContainer.addEventListener('transitionend', onEnd);
          setTimeout(() => onEnd({ target: ocorreuContainer }), 320);
        };

        const animateOut = () => {
          if (isAnimating) return;
          ocorreuContainer.classList.add('is-animating');

          const start = ocorreuContainer.getBoundingClientRect().height;
          ocorreuContainer.style.height = `${Math.max(0, start)}px`;
          ocorreuContainer.style.opacity = '1';
          ocorreuContainer.style.transform = 'translateY(0) scaleY(1)';

          // ForÃ§a layout
          void ocorreuContainer.offsetHeight;

          ocorreuContainer.style.transition = 'height 220ms ease, opacity 160ms ease, transform 220ms ease';
          requestAnimationFrame(() => {
            ocorreuContainer.style.height = '0px';
            ocorreuContainer.style.opacity = '0';
            ocorreuContainer.style.transform = 'translateY(-8px) scaleY(0.98)';
          });

          const onEnd = (ev) => {
            if (ev && ev.target !== ocorreuContainer) return;
            ocorreuContainer.removeEventListener('transitionend', onEnd);
            ocorreuContainer.style.transition = '';
            ocorreuContainer.style.height = '';
            ocorreuContainer.style.opacity = '';
            ocorreuContainer.style.transform = '';
            ocorreuContainer.classList.remove('is-animating');
            ocorreuContainer.style.overflow = '';
            ocorreuContainer.classList.add('hidden');
          };
          ocorreuContainer.addEventListener('transitionend', onEnd);
          setTimeout(() => onEnd({ target: ocorreuContainer }), 280);
        };

        if (shouldShow) {
          ocorreuSelect.disabled = false;
          if (isHidden) animateIn();
        } else {
          ocorreuSelect.disabled = true;
          if (ocorreuSelect.value) {
            ocorreuSelect.value = '';
            ocorreuSelect.dispatchEvent(new Event('change', { bubbles: true }));
          }
          if (!isHidden) animateOut();
        }
      }

      const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
      if (violenciaInformadaEl) {
        violenciaInformadaEl.addEventListener('change', syncConditionalOcorreuEscola);
      }
      syncConditionalOcorreuEscola();
      
      // Event listener especÃ­fico para o filtro TI com atualizaÃ§Ã£o de badge
      const filterTIElement = document.getElementById('filterTI');
      if (filterTIElement) {
        filterTIElement.addEventListener('change', function() {
          updateBadgeTI();
          applyFilters();
        });
      }
      
      document.getElementById('btnLimparFiltros').addEventListener('click', clearFilters);
      // Event listeners de exportaÃ§Ã£o jÃ¡ estÃ£o configurados no window.addEventListener('load')
    }

    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      const firstOption = select.options[0] || null;
      select.innerHTML = '';
      if (firstOption) {
        select.appendChild(firstOption);
      }
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // S/N
    function checkSN(value, filterValue) {
      if (!filterValue) return true;
      const val = String(value || '').toUpperCase().trim();
      if (!val) return false;
      const f = filterValue.toUpperCase();
      if (f === 'S') {
        return val === 'S' || val === 'SIM';
      }
      if (f === 'N') {
        return val === 'N' || val === 'NAO' || val === 'NÃƒO';
      }
      return false;
    }

    function applyFilters() {
      const filters = {
        regioes:         getCheckedValues('regiao'),
        tipos:           getCheckedValues('tipoViolencia'),
        tiposInstituicao: getCheckedValues('tipoInstituicao'),
        escolas:         getCheckedValues('escola'),
        encaminhamentos: gatherSelectedEncaminhamentos(),
        racas:           getCheckedValues('raca'),
        generos:         getCheckedValues('genero'),
        
        // NOVO FILTRO: Tipos de deficiÃªncia/transtorno selecionados
        tiposDeficiencia: getCheckedValues('tipoDeficiencia'),
        
        // NOVOS FILTROS
        orientacoes:     getCheckedValues('orientacao'),
        violenciasInstitucionais: gatherSelectedViolenciasInstitucionais(),

        pcd:                  document.getElementById('filterPCD').value,
        ocorreu:              document.getElementById('filterOcorreuEscola').value,
        fonteInformada:       document.getElementById('filterFonteInformada').value,
        violenciaEscolaOcorreu: document.getElementById('filterViolenciaEscolaOcorreu').value,
        profissionalAutor:    document.getElementById('filterProfissionalAutor').value,
        estudanteAutor:       document.getElementById('filterEstudanteAutor').value,
        violenciaNaoEscola:   document.getElementById('filterViolenciaNaoEscola').value,
        violenciaInformada:   document.getElementById('filterViolenciaInformada').value,

        estudoCaso:           document.getElementById('filterEstudoCaso').value,

        // NOVO FILTRO: Foi um membro familiar?
        membroFamiliar: document.getElementById('filterMembroFamiliar').value,

        idadeMin: document.getElementById('filterIdadeMin').value,
        idadeMax: document.getElementById('filterIdadeMax').value,

        nome: document.getElementById('filterNome').value.toLowerCase(),

        dataInicio: document.getElementById('filterDataInicio').value,
        dataFim:    document.getElementById('filterDataFim').value
      };

      const dataInicioDate = filters.dataInicio ? new Date(filters.dataInicio + 'T00:00:00') : null;
      const dataFimDate    = filters.dataFim    ? new Date(filters.dataFim    + 'T23:59:59') : null;
      
      filteredData = originalData.filter(row => {

                // FILTRO: Foi um membro familiar?
                // OpÃ§Ãµes: '' (Todos), 'Sim', 'NÃ£o', 'naoinformado'
                if (filters.membroFamiliar && columnNames.foiMembroFamiliar) {
                  const valor = String(row[columnNames.foiMembroFamiliar] || '').trim().toUpperCase();
                  console.log('[Filtro Membro Familiar] Valor na linha:', valor, '| Filtro selecionado:', filters.membroFamiliar);
                  if (filters.membroFamiliar === 'Sim' && valor !== 'S') return false;
                  if (filters.membroFamiliar === 'NÃ£o' && valor !== 'N') return false;
                  if (filters.membroFamiliar === 'naoinformado' && valor !== '') return false;
                }
        // Multi (OU) - com suporte a campos multi-valor separados por vÃ­rgula
        if (filters.regioes.length && columnNames.regiao) {
          const rowVals = String(row[columnNames.regiao] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.regioes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        if (filters.tipos.length && columnNames.tipo) {
          // Filtro de Tipo de ViolÃªncia: NÃƒO separa por barra (/)
          // "Financeira/EconÃ´mica" Ã© tratada como uma categoria Ãºnica
          const rowVals = String(row[columnNames.tipo] || '')
            .split(',')
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.tipos.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        // Filtro por tipo de instituiÃ§Ã£o (CMEI/EMEF/NÃ£o Encontrada)
        if (filters.tiposInstituicao.length && columnNames.escola) {
          const tipoEscola = getTipoInstituicao(row[columnNames.escola]);
          const tipoParaFiltro = tipoEscola || (row[columnNames.escola] ? 'NÃ£o Encontrada' : null);
          
          if (!tipoParaFiltro || !filters.tiposInstituicao.includes(tipoParaFiltro)) {
            return false;
          }
        }
        if (filters.escolas.length && columnNames.escola) {
          const rowVals = String(row[columnNames.escola] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.escolas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // FILTRO: Tempo Integral (corrigido para usar sigla â†’ nome completo)
        const selectTI = document.getElementById('filterTI');
        const filtroTI = selectTI ? selectTI.value : '';
        
        if (filtroTI && columnNames.escola) {
          const escola = row[columnNames.escola]; // Sigla da escola (ex.: "ABS", "AA")
          
          if (filtroTI === 'TI') {
            // SÃ³ mantÃ©m registros de escolas de tempo integral
            if (!isTempoIntegral(escola)) {
              return false;
            }
          } else if (filtroTI === 'Regular') {
            // SÃ³ mantÃ©m registros de escolas que NÃƒO sÃ£o TI
            if (isTempoIntegral(escola)) {
              return false;
            }
          }
          // Se filtroTI === '' â†’ nÃ£o filtra por tempo integral
        }
        
        if (filters.encaminhamentos.length && columnNames.encaminhamento) {
          if (!matchEncaminhamentoCell(row[columnNames.encaminhamento], filters.encaminhamentos)) {
            return false;
          }
        }
        if (filters.racas.length && columnNames.raca) {
          const rowVals = String(row[columnNames.raca] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.racas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        if (filters.generos.length && columnNames.genero) {
          // Para gÃªnero (coluna D), verifica se Ã© M ou F
          const rowValue = String(row[columnNames.genero] || '').trim().toUpperCase();
          const ok = filters.generos.some(v => v.toUpperCase() === rowValue);
          if (!ok) return false;
        }
        
        // NOVO FILTRO: Tipo de deficiÃªncia/transtorno
        // Este filtro trabalha em conjunto com o filtro de PCD
        // APLICA NORMALIZAÃ‡ÃƒO para que "TDAH", "TDH", "tdah" sejam considerados iguais
        if (filters.tiposDeficiencia.length && columnNames.detalhePCD) {
          // Se o usuÃ¡rio selecionou tipos de deficiÃªncia, o registro deve:
          // 1) Ser PCD (ter "S" ou "SIM" na coluna PCD)
          // 2) Ter um detalhamento que bata com as opÃ§Ãµes selecionadas
          
          // Verifica se Ã© PCD
          const isPCD = checkSN(row[columnNames.pcd], 'S');
          if (!isPCD) return false; // Se nÃ£o Ã© PCD, nÃ£o passa no filtro
          
          // Verifica se o detalhamento bate com alguma opÃ§Ã£o selecionada
          // Separa por vÃ­rgula E por barra (/) para considerar mÃºltiplos transtornos
          const rowVals = String(row[columnNames.detalhePCD] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          // APLICA NORMALIZAÃ‡ÃƒO aos valores do registro E aos filtros selecionados
          const rowNormalizados = rowVals.map(v => normalizarTranstorno(v));
          const filterNormalizados = filters.tiposDeficiencia; // JÃ¡ vem normalizado do checkbox
          
          // Compara usando normalizeText para remover acentos e maiÃºsculas
          const rowNorms = rowNormalizados.map(v => normalizeText(v));
          const filterNorms = filterNormalizados.map(v => normalizeText(v));
          
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // NOVO FILTRO: OrientaÃ§Ã£o Sexual (OU)
        if (filters.orientacoes.length && columnNames.orientacaoSexual) {
          const rowVals = String(row[columnNames.orientacaoSexual] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.orientacoes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // FILTRO: ViolÃªncias Institucionais
        // Aplica se o registro tem "Institucional" em tipoViolencia
        if (filters.violenciasInstitucionais && filters.violenciasInstitucionais.length > 0) {
          const tipoViolencia = String(row[columnNames.tipo] || '').toLowerCase();
          const temInstitucional = tipoViolencia.includes('institucional');
          
          if (!temInstitucional) {
            // Se nÃ£o tem "Institucional" em tipoViolencia, nÃ£o passa no filtro
            return false;
          }
          
          // Se tem "Institucional" em tipoViolencia, verifica o campo tipoViolenciaInstitucional
          if (columnNames.tipoViolenciaInstitucional) {
            const violenciaInstitucional = row[columnNames.tipoViolenciaInstitucional];
            
            // Se o campo estÃ¡ vazio, considera como "NÃ£o informado" e passa no filtro
            // (todos os registros com "Institucional" devem aparecer, mesmo sem detalhamento)
            if (!violenciaInstitucional || String(violenciaInstitucional).trim() === '') {
              // Campo vazio = "NÃ£o informado", passa no filtro
              // (todos os registros com violÃªncia institucional aparecem, independente do detalhamento)
            } else {
              // Se tem valor, verifica se corresponde aos filtros selecionados
              if (!matchViolenciaInstitucionalCell(violenciaInstitucional, filters.violenciasInstitucionais)) {
                return false;
              }
            }
          }
        }

        // S/N
        if (filters.pcd && columnNames.pcd && !checkSN(row[columnNames.pcd], filters.pcd)) return false;
        
        // FILTRO: Ocorreu na escola - Combina colunas U (ocorreu) e Q (violenciaEscolaOcorreu)
        // Se o usuÃ¡rio filtrar "Sim", mostra registros onde U OU Q = Sim
        // Se o usuÃ¡rio filtrar "NÃ£o", mostra registros onde U E Q = NÃ£o
        // FILTRO: Ocorreu na Escola? - Combina colunas U e Q
        if (filters.ocorreu && filters.ocorreu !== '') {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          const ocorreuNaEscola = ocorreuU || ocorreuQ;
          
          // Se filtro Ã© 'S', precisa ter ocorrido na escola (U ou Q = 'S')
          if (filters.ocorreu === 'S' && !ocorreuNaEscola) return false;
          
          // Se filtro Ã© 'N', precisa NÃƒO ter ocorrido na escola
          // Verifica se ambas colunas sÃ£o 'N' ou vazias
          if (filters.ocorreu === 'N') {
            const naoOcorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'N') : true;
            const naoOcorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'N') : true;
            // Se ocorreu na escola OU se nenhuma das colunas Ã© 'N', nÃ£o passa no filtro
            if (ocorreuNaEscola || (!naoOcorreuU && !naoOcorreuQ)) return false;
          }
        }
        
        if (filters.fonteInformada && columnNames.fonteInformada && !checkSN(row[columnNames.fonteInformada], filters.fonteInformada)) return false;
        
        // FILTRO: ViolÃªncia identificada pela escola ocorrida na escola - Usa APENAS coluna Q
        if (filters.violenciaEscolaOcorreu && columnNames.violenciaEscolaOcorreu &&
            !checkSN(row[columnNames.violenciaEscolaOcorreu], filters.violenciaEscolaOcorreu)) return false;
        
        // FILTRO: Autor da ViolÃªncia (colunas R e S)
        // LÃ³gica: Se profissionalAutor = 'S', mostra apenas casos onde R = 'S' (independente de S)
        // Se estudanteAutor = 'S', mostra apenas casos onde S = 'S' (independente de R)
        // Se ambos = 'N', mostra apenas casos onde R = 'N' E S = 'N'
        if (filters.profissionalAutor && filters.profissionalAutor !== '') {
          if (columnNames.profissionalAutor) {
            const profissionalS = checkSN(row[columnNames.profissionalAutor], 'S');
            const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');
            
            if (filters.profissionalAutor === 'S' && !profissionalS) return false;
            if (filters.profissionalAutor === 'N' && !profissionalN) return false;
          }
        }
        
        if (filters.estudanteAutor && filters.estudanteAutor !== '') {
          if (columnNames.estudanteAutor) {
            const estudanteS = checkSN(row[columnNames.estudanteAutor], 'S');
            const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');
            
            if (filters.estudanteAutor === 'S' && !estudanteS) return false;
            if (filters.estudanteAutor === 'N' && !estudanteN) return false;
          }
        }
        
        // Caso especial: Se ambos estÃ£o definidos como 'N', significa "Outro Agente"
        // Ambos devem ser 'N' para passar no filtro
        if (filters.profissionalAutor === 'N' && filters.estudanteAutor === 'N') {
          if (columnNames.profissionalAutor && columnNames.estudanteAutor) {
            const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');
            const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');
            if (!profissionalN || !estudanteN) return false;
          }
        }
        if (filters.violenciaNaoEscola && columnNames.violenciaNaoEscola &&
            !checkSN(row[columnNames.violenciaNaoEscola], filters.violenciaNaoEscola)) return false;
        if (filters.violenciaInformada && columnNames.violenciaInformada &&
            !checkSN(row[columnNames.violenciaInformada], filters.violenciaInformada)) return false;
        if (filters.estudoCaso && columnNames.estudoCaso &&
            !checkSN(row[columnNames.estudoCaso], filters.estudoCaso)) return false;

        // Idade
        if (columnNames.idade) {
          const idade = parseInt(row[columnNames.idade], 10);
          if (filters.idadeMin && !isNaN(idade) && idade < parseInt(filters.idadeMin, 10)) return false;
          if (filters.idadeMax && !isNaN(idade) && idade > parseInt(filters.idadeMax, 10)) return false;
        }

        // Nome (contains)
        if (filters.nome && columnNames.crianca) {
          const nome = String(row[columnNames.crianca] || '').toLowerCase();
          if (!nome.includes(filters.nome)) return false;
        }

        // Data - usa coluna dataNT (Data da NT) ou data
        const dataColumn = columnNames.dataNT || columnNames.data;
        if ((dataInicioDate || dataFimDate) && dataColumn !== undefined) {
          const rowDate = parseDateCell(row[dataColumn]);
          // Se houver filtro de data mas o registro nÃ£o tem data vÃ¡lida, exclui o registro
          if (!rowDate) {
            return false;
          }
          
          // Normaliza as datas para comparaÃ§Ã£o (apenas dia/mÃªs/ano, sem horas)
          const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
          const dataInicioOnly = dataInicioDate ? new Date(dataInicioDate.getFullYear(), dataInicioDate.getMonth(), dataInicioDate.getDate()) : null;
          const dataFimDateOnly = dataFimDate ? new Date(dataFimDate.getFullYear(), dataFimDate.getMonth(), dataFimDate.getDate()) : null;
          
          if (dataInicioOnly && rowDateOnly < dataInicioOnly) return false;
          if (dataFimDateOnly && rowDateOnly > dataFimDateOnly) return false;
        }

        return true;
      });

      // Atualiza variÃ¡vel global para dashboard-stats.js
      window.filteredData = filteredData;
      
      // Resetar para primeira pÃ¡gina ao aplicar filtros
      paginaAtual = 1;

      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs apÃ³s aplicar filtros
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 300);
    }

    function clearFilters() {
      // Limpar checkboxes dos filtros avanÃ§ados
      const allCheckboxes = document.querySelectorAll('.custom-checkbox');
      allCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
      });
      
      // Limpar badges
      const badges = document.querySelectorAll('.badge-count, .group-badge');
      badges.forEach(badge => badge.classList.add('hidden'));
      
      // Remover estados ativos dos cards
      const cards = document.querySelectorAll('.filter-card');
      cards.forEach(card => card.classList.remove('active'));
      
      // Esconder todas as seÃ§Ãµes
      const sections = document.querySelectorAll('.filter-section');
      sections.forEach(section => {
        section.classList.remove('show');
        section.classList.add('hidden');
      });
      
      // Fechar painel
      document.getElementById('advancedPanel').classList.remove('open');
      
      // Limpar selects e inputs
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI'
      ];
      
      filterIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          Array.from(el.options).forEach(o => o.selected = false);
        } else {
          el.value = '';
        }
      });

      // Reaplica regra do campo condicional (oculta e garante valor limpo)
      const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
      const ocorreuContainer = document.getElementById('filterOcorreuEscolaContainer');
      const ocorreuSelect = document.getElementById('filterOcorreuEscola');
      if (violenciaInformadaEl && ocorreuContainer && ocorreuSelect) {
        ocorreuContainer.classList.add('hidden');
        ocorreuSelect.disabled = true;
        ocorreuSelect.value = '';
      }
      
      filteredData = [...originalData];
      
      // Atualiza variÃ¡vel global para dashboard-stats.js
      window.filteredData = filteredData;
      
      // Esconde card de ViolÃªncias Institucionais ao limpar filtros
      const cardViolenciaInstitucional = document.getElementById('card-violenciaInstitucional');
      if (cardViolenciaInstitucional) {
        cardViolenciaInstitucional.classList.add('hidden');
      }
      
      // Resetar para primeira pÃ¡gina ao limpar filtros
      paginaAtual = 1;
      
      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs apÃ³s limpar filtros
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 300);
    }

    // ==============================
    // EstatÃ­sticas / Tabela
    // ==============================
    function renderStats(data) {
      const total = originalData.length;
      const filtrados = data.length;
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statFiltrados').textContent = filtrados;
      
      let countEscola = 0;
      // Considera AMBAS as colunas U (ocorreu na escola 1.1) e Q (violÃªncia identificada pela escola ocorrida na escola)
      // Se qualquer uma delas for 'S' ou 'Sim', conta como ocorrido na escola
      if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
        countEscola = data.reduce((acc, row) => {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          return acc + (ocorreuU || ocorreuQ ? 1 : 0);
        }, 0);
      }
      document.getElementById('statEscola').textContent = countEscola;
      
      const tiposDiv = document.getElementById('statTipos');
      tiposDiv.innerHTML = '';
      if (columnNames.tipo) {
        const mapa = {};
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (!tipo) return;
          const rotulo = String(tipo).trim();
          mapa[rotulo] = (mapa[rotulo] || 0) + 1;
        });
        const tipos = Object.keys(mapa).sort();
        if (tipos.length === 0) {
          tiposDiv.textContent = 'Nenhum tipo identificado nos registros filtrados.';
        } else {
          tipos.forEach(t => {
            const p = document.createElement('div');
            p.textContent = `${t}: ${mapa[t]}`;
            tiposDiv.appendChild(p);
          });
        }
      } else {
        tiposDiv.textContent = 'Coluna "Tipo de ViolÃªncia" nÃ£o encontrada.';
      }
    }
    
    // ==============================
    // GrÃ¡ficos
    // ==============================
    function renderCharts(data) {
      // Cores para os grÃ¡ficos
      const colors = [
        'rgba(59, 130, 246, 0.8)',   // azul
        'rgba(239, 68, 68, 0.8)',    // vermelho
        'rgba(34, 197, 94, 0.8)',    // verde
        'rgba(234, 179, 8, 0.8)',    // amarelo
        'rgba(168, 85, 247, 0.8)',   // roxo
        'rgba(236, 72, 153, 0.8)',   // rosa
        'rgba(20, 184, 166, 0.8)',   // teal
        'rgba(251, 146, 60, 0.8)',   // laranja
        'rgba(148, 163, 184, 0.8)',  // cinza
        'rgba(6, 182, 212, 0.8)'     // cyan
      ];
      
      // GrÃ¡fico: Tipos de ViolÃªncia (normalizado)
      if (columnNames.tipo) {
        const dados = {};
        const mapaNormalizado = {}; // norm -> label original mais comum
        
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (tipo) {
            const original = String(tipo).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              // Guarda o label original mais usado (capitalizado)
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        // Converte de volta para labels originais
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderPieChart('chartTipoViolencia', sorted, colors);
      }
      
      // GrÃ¡fico: Tipos de ViolÃªncia Institucional (normalizado)
      // SÃ³ renderiza se "Institucional" estiver selecionado no filtro de tipo de violÃªncia
      const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
      const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
      const temInstitucional = Array.from(tipoViolenciaCheckboxes).some(cb => {
        const valor = (cb.dataset.value || '').toLowerCase();
        return valor === 'institucional' || valor.includes('institucional');
      });
      
      if (temInstitucional && columnNames.tipoViolenciaInstitucional) {
        // Mostra o container do grÃ¡fico
        if (containerChartViolenciaInst) {
          containerChartViolenciaInst.classList.remove('hidden');
        }
        
        const dados = {};
        const mapaNormalizado = {};
        
        // Filtra apenas registros que tÃªm "Institucional" no tipo de violÃªncia
        // Usa os dados jÃ¡ filtrados (parÃ¢metro 'data' da funÃ§Ã£o renderCharts)
        const dataInstitucional = data.filter(row => {
          const tipoViolencia = row[columnNames.tipo];
          if (!tipoViolencia) return false;
          const tipoViolenciaStr = String(tipoViolencia).toLowerCase();
          return tipoViolenciaStr.includes('institucional');
        });
        
        dataInstitucional.forEach(row => {
          const tipoInst = row[columnNames.tipoViolenciaInstitucional];
          if (tipoInst) {
            const original = String(tipoInst).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              // Guarda o label original mais usado (capitalizado)
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        // Converte de volta para labels originais
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        
        // Se houver dados, renderiza o grÃ¡fico
        if (sorted.length > 0) {
          // Restaura o canvas se foi substituÃ­do por mensagem
          const canvas = document.getElementById('chartTipoViolenciaInstitucional');
          if (!canvas) {
            const container = document.getElementById('containerChartViolenciaInstitucional');
            if (container) {
              const canvasDiv = container.querySelector('.relative');
              if (canvasDiv) {
                canvasDiv.innerHTML = '<canvas id="chartTipoViolenciaInstitucional"></canvas>';
              }
            }
          }
          renderPieChart('chartTipoViolenciaInstitucional', sorted, colors);
        } else {
          // Se nÃ£o houver dados, mostra mensagem
          const canvas = document.getElementById('chartTipoViolenciaInstitucional');
          if (canvas && canvas.parentElement) {
            // Destroi o grÃ¡fico se existir
            if (charts['chartTipoViolenciaInstitucional']) {
              charts['chartTipoViolenciaInstitucional'].destroy();
              delete charts['chartTipoViolenciaInstitucional'];
            }
            canvas.parentElement.innerHTML = '<p class="text-gray-500 text-sm text-center mt-8">Nenhuma violÃªncia institucional encontrada nos dados filtrados.</p>';
          }
        }
      } else {
        // Esconde o container do grÃ¡fico se "Institucional" nÃ£o estiver selecionado
        if (containerChartViolenciaInst) {
          containerChartViolenciaInst.classList.add('hidden');
        }
        // Destroi o grÃ¡fico se existir
        if (charts['chartTipoViolenciaInstitucional']) {
          charts['chartTipoViolenciaInstitucional'].destroy();
          delete charts['chartTipoViolenciaInstitucional'];
        }
      }
      
      // GrÃ¡fico: Por RegiÃ£o (normalizado)
      if (columnNames.regiao) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const regiao = row[columnNames.regiao];
          if (regiao) {
            const original = String(regiao).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderBarChart('chartRegiao', sorted, colors);
      }
      
      // GrÃ¡fico: Top 10 Escolas (normalizado)
      if (columnNames.escola) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const escola = row[columnNames.escola];
          if (escola) {
            const original = String(escola).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        renderBarChart('chartEscola', sorted, colors);
      }
      
      // GrÃ¡fico: Faixa EtÃ¡ria
      if (columnNames.idade) {
        const faixas = {
          '0-5 anos': 0,
          '6-10 anos': 0,
          '11-14 anos': 0,
          '15-17 anos': 0,
          '18+ anos': 0
        };
        
        data.forEach(row => {
          const idade = parseInt(row[columnNames.idade], 10);
          if (!isNaN(idade)) {
            if (idade <= 5) faixas['0-5 anos']++;
            else if (idade <= 10) faixas['6-10 anos']++;
            else if (idade <= 14) faixas['11-14 anos']++;
            else if (idade <= 17) faixas['15-17 anos']++;
            else faixas['18+ anos']++;
          }
        });
        
        const sorted = Object.entries(faixas).filter(([k, v]) => v > 0);
        renderBarChart('chartIdade', sorted, colors);
      }
      
      // GrÃ¡fico: GÃªnero (Coluna D: M ou F)
      if (columnNames.genero) {
        const dados = { 'F': 0, 'M': 0 };
        data.forEach(row => {
          const genero = row[columnNames.genero];
          if (genero) {
            const key = String(genero).trim().toUpperCase();
            if (key === 'F') dados['F']++;
            else if (key === 'M') dados['M']++;
          }
        });
        
        // Filtra apenas os que tÃªm valores
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0).sort((a, b) => b[1] - a[1]);
        renderPieChart('chartGenero', sorted, colors);
      }
      
      // GrÃ¡fico: RaÃ§a/Cor (normalizado)
      if (columnNames.raca) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const raca = row[columnNames.raca];
          if (raca) {
            const original = String(raca).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderPieChart('chartRaca', sorted, colors);
      }
      
      // GrÃ¡fico: Linha do Tempo (sem logs detalhados de datas)
      if (columnNames.data) {
        const porMes = {};
        data.forEach((row) => {
          const rawData = row[columnNames.data];
          const date = parseDateCell(rawData);
          if (date) {
            const mes = date.getMonth();
            const ano = date.getFullYear();
            const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
            porMes[key] = (porMes[key] || 0) + 1;
          }
        });
        const sorted = Object.entries(porMes).sort((a, b) => a[0].localeCompare(b[0]));
        console.log('Meses ordenados:', sorted);
        
        const labels = sorted.map(([key]) => {
          const [ano, mes] = key.split('-');
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          return `${meses[parseInt(mes) - 1]}/${ano}`;
        });
        const valores = sorted.map(([, v]) => v);
        
        console.log('Labels para grÃ¡fico:', labels);
        console.log('Valores para grÃ¡fico:', valores);
        console.log('=== FIM DEBUG GRÃFICO TEMPORAL ===');
        
        renderLineChart('chartTemporal', labels, valores);
      }
      
      // GrÃ¡fico: Encaminhamentos (agrupado por redes)
      if (columnNames.encaminhamento) {
        // Contagem por grupo de rede
        const dadosPorGrupo = {};
        
        data.forEach(row => {
          const encaminhamento = row[columnNames.encaminhamento];
          if (encaminhamento) {
            // Suporta valores mÃºltiplos separados por vÃ­rgula e barra
            const valores = String(encaminhamento)
              .split(',')
              .flatMap(v => v.split('/'))
              .map(v => v.trim())
              .filter(v => v);
            
            valores.forEach(val => {
              const original = String(val).trim();
              const norm = normalizeText(original);
              
              if (norm) {
                // Encontrar grupo
                let grupoEncontrado = null;
                for (const groupKey in encaminhamentosAgrupados) {
                  const children = encaminhamentosAgrupados[groupKey];
                  if (children.some(child => normalizeText(child) === norm)) {
                    grupoEncontrado = groupKey;
                    break;
                  }
                }
                
                // Se nÃ£o encontrou grupo, usar "Outros"
                if (!grupoEncontrado) {
                  grupoEncontrado = 'outros';
                }
                
                // Contagem por grupo
                if (!dadosPorGrupo[grupoEncontrado]) {
                  dadosPorGrupo[grupoEncontrado] = 0;
                }
                dadosPorGrupo[grupoEncontrado]++;
              }
            });
          }
        });
        
        // Converter para array e ordenar
        const sorted = Object.entries(dadosPorGrupo)
          .map(([groupId, count]) => {
            const groupName = grupoNomes[groupId] || (groupId === 'outros' ? 'Outros Encaminhamentos' : groupId);
            return [groupName, count, groupId];
          })
          .sort((a, b) => b[1] - a[1]);
        
        if (sorted.length > 0) {
          // Usar cores diferentes para cada grupo
          const coresPorGrupo = {
            'redeAssistencia': 'rgba(59, 130, 246, 0.8)', // Azul
            'redeSaude': 'rgba(34, 197, 94, 0.8)', // Verde
            'redeEducacao': 'rgba(251, 146, 60, 0.8)', // Laranja
            'conselhoTutelar': 'rgba(168, 85, 247, 0.8)', // Roxo
            'redeSegurancaJustica': 'rgba(239, 68, 68, 0.8)', // Vermelho
            'outros': 'rgba(156, 163, 175, 0.8)' // Cinza
          };
          
          const cores = sorted.map(([, , groupId]) => coresPorGrupo[groupId] || coresPorGrupo['outros']);
          const dadosGrafico = sorted.map(([name, count]) => [name, count]);
          
          renderHorizontalBarChartGrouped('chartEncaminhamento', dadosGrafico, cores);
        }
      }
      
      // GrÃ¡fico: Autor da ViolÃªncia (baseado nas colunas R e S)
      // Coluna R (profissionalAutor): 'S' = Profissional da Escola
      // Coluna S (estudanteAutor): 'S' = Estudante
      // Se ambas = 'N': Outro Agente (Fora da InstituiÃ§Ã£o)
      if (columnNames.profissionalAutor || columnNames.estudanteAutor) {
        const dados = {
          'Profissional da Escola': 0,
          'Estudante': 0,
          'Outro Agente (Fora da InstituiÃ§Ã£o)': 0,
          'NÃ£o Informado': 0
        };
        
        data.forEach(row => {
          const profissionalS = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'S') : false;
          const profissionalN = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'N') : false;
          const estudanteS = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'S') : false;
          const estudanteN = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'N') : false;
          
          // Se coluna R = 'S' â†’ Profissional da Escola
          if (profissionalS) {
            dados['Profissional da Escola']++;
          }
          // Se coluna S = 'S' â†’ Estudante
          else if (estudanteS) {
            dados['Estudante']++;
          }
          // Se ambas colunas R e S = 'N' â†’ Outro Agente (Fora da InstituiÃ§Ã£o)
          else if (profissionalN && estudanteN) {
            dados['Outro Agente (Fora da InstituiÃ§Ã£o)']++;
          }
          // Caso contrÃ¡rio â†’ NÃ£o Informado
          else {
            dados['NÃ£o Informado']++;
          }
        });
        
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
        if (sorted.length > 0) {
          renderPieChart('chartAutor', sorted, colors);
        }
      }
      
      // GrÃ¡fico: Ocorreu na Escola? (Sim/NÃ£o)
      if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
        const dados = {
          'Sim': 0,
          'NÃ£o': 0,
          'NÃ£o Informado': 0
        };
        
        data.forEach(row => {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          const ocorreuNaEscola = ocorreuU || ocorreuQ;
          
          const naoOcorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'N') : false;
          const naoOcorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'N') : false;
          const naoOcorreuNaEscola = naoOcorreuU && naoOcorreuQ;
          
          if (ocorreuNaEscola) {
            dados['Sim']++;
          } else if (naoOcorreuNaEscola) {
            dados['NÃ£o']++;
          } else {
            dados['NÃ£o Informado']++;
          }
        });
        
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
        if (sorted.length > 0) {
          renderPieChart('chartOcorreuEscola', sorted, colors);
        }
      }
      
      // GrÃ¡fico: CorrelaÃ§Ã£o Tipo de ViolÃªncia vs Faixa EtÃ¡ria
      if (columnNames.tipo && columnNames.idade) {
        const faixasEtarias = ['0-5', '6-10', '11-14', '15-17', '18+'];
        const tiposViolencia = {};
        const correlacao = {};
        
        // Primeiro, identifica todos os tipos de violÃªncia
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (tipo) {
            const tipoNorm = normalizeText(String(tipo).trim());
            if (tipoNorm && !tiposViolencia[tipoNorm]) {
              tiposViolencia[tipoNorm] = String(tipo).trim();
            }
          }
        });
        
        // Cria estrutura de correlaÃ§Ã£o
        Object.keys(tiposViolencia).forEach(tipoNorm => {
          correlacao[tipoNorm] = {};
          faixasEtarias.forEach(faixa => {
            correlacao[tipoNorm][faixa] = 0;
          });
        });
        
        // Preenche os dados
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          const idade = row[columnNames.idade];
          
          if (tipo && idade) {
            const tipoNorm = normalizeText(String(tipo).trim());
            if (!tipoNorm) return;
            
            const idadeNum = parseInt(String(idade).trim(), 10);
            if (isNaN(idadeNum)) return;
            
            let faixa = '18+';
            if (idadeNum <= 5) faixa = '0-5';
            else if (idadeNum <= 10) faixa = '6-10';
            else if (idadeNum <= 14) faixa = '11-14';
            else if (idadeNum <= 17) faixa = '15-17';
            
            if (correlacao[tipoNorm] && correlacao[tipoNorm][faixa] !== undefined) {
              correlacao[tipoNorm][faixa]++;
            }
          }
        });
        
        // Prepara dados para o grÃ¡fico (top 5 tipos mais frequentes)
        const tiposOrdenados = Object.entries(tiposViolencia)
          .map(([norm, original]) => {
            const total = faixasEtarias.reduce((sum, faixa) => sum + (correlacao[norm]?.[faixa] || 0), 0);
            return { norm, original, total };
          })
          .sort((a, b) => b.total - a.total)
          .slice(0, 5);
        
        if (tiposOrdenados.length > 0) {
          const datasets = faixasEtarias.map((faixa, idx) => {
            return {
              label: faixa + ' anos',
              data: tiposOrdenados.map(({ norm }) => correlacao[norm]?.[faixa] || 0),
              backgroundColor: colors[idx % colors.length],
              borderColor: colors[idx % colors.length].replace('0.8', '1'),
              borderWidth: 2
            };
          });
          
          const labels = tiposOrdenados.map(({ original }) => original);
          renderGroupedBarChart('chartCorrelacaoTipoIdade', labels, datasets);
        }
      }
      
      // GrÃ¡fico: Comparativo Temporal (Ãšltimos 6 Meses vs PerÃ­odo Anterior)
      if (columnNames.data || columnNames.dataNT) {
        const dataCol = columnNames.data || columnNames.dataNT;
        const agora = new Date();
        const mesAtual = agora.getMonth();
        const anoAtual = agora.getFullYear();
        
        // FunÃ§Ã£o auxiliar para calcular mÃªs e ano corretamente
        const calcularMesAno = (mesesAtras) => {
          const dataAlvo = new Date(anoAtual, mesAtual - mesesAtras, 1);
          return {
            mes: dataAlvo.getMonth(),
            ano: dataAlvo.getFullYear()
          };
        };
        
        // Ãšltimos 6 meses (0 a 5 meses atrÃ¡s)
        const ultimos6Meses = {};
        for (let i = 0; i < 6; i++) {
          const { mes, ano } = calcularMesAno(i);
          const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
          ultimos6Meses[key] = { mes, ano, count: 0 };
        }
        
        // PerÃ­odo anterior (6 a 11 meses atrÃ¡s)
        const periodoAnterior = {};
        for (let i = 6; i < 12; i++) {
          const { mes, ano } = calcularMesAno(i);
          const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
          periodoAnterior[key] = { mes, ano, count: 0 };
        }
        
        // Conta os casos - INCLUI TODOS os dados que caem nos perÃ­odos
        data.forEach(row => {
          const rawData = row[dataCol];
          if (!rawData) return;
          
          const date = parseDateCell(rawData);
          if (!date || isNaN(date.getTime())) return;
          
          const rowMes = date.getMonth();
          const rowAno = date.getFullYear();
          const key = `${rowAno}-${String(rowMes + 1).padStart(2, '0')}`;
          
          // Verifica se o registro cai em algum dos perÃ­odos definidos
          if (ultimos6Meses[key]) {
            ultimos6Meses[key].count++;
          } else if (periodoAnterior[key]) {
            periodoAnterior[key].count++;
          }
        });
        
        // Prepara dados para o grÃ¡fico
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const labels = [];
        const dadosUltimos6 = [];
        const dadosAnterior = [];
        
        // Ordena por data (mais antigo primeiro)
        const sortedUltimos6 = Object.entries(ultimos6Meses)
          .sort((a, b) => a[0].localeCompare(b[0]));
        const sortedAnterior = Object.entries(periodoAnterior)
          .sort((a, b) => a[0].localeCompare(b[0]));
        
        // Cria um mapa do perÃ­odo anterior usando a chave completa (ano-mÃªs)
        const anteriorPorChave = {};
        sortedAnterior.forEach(([key, { mes, ano, count }]) => {
          anteriorPorChave[key] = count;
        });
        
        // Alinha os dados: para cada mÃªs dos Ãºltimos 6, busca o mÃªs correspondente do perÃ­odo anterior
        // O perÃ­odo anterior Ã© exatamente 6 meses antes, entÃ£o precisamos mapear corretamente
        sortedUltimos6.forEach(([keyUltimos6, { mes: mesUltimos6, ano: anoUltimos6, count: countUltimos6 }]) => {
          // Calcula o mÃªs correspondente no perÃ­odo anterior (6 meses antes)
          const dataAnterior = new Date(anoUltimos6, mesUltimos6 - 6, 1);
          const mesAnterior = dataAnterior.getMonth();
          const anoAnterior = dataAnterior.getFullYear();
          const keyAnterior = `${anoAnterior}-${String(mesAnterior + 1).padStart(2, '0')}`;
          
          labels.push(meses[mesUltimos6]);
          dadosUltimos6.push(countUltimos6);
          // Busca o count do perÃ­odo anterior usando a chave calculada
          dadosAnterior.push(anteriorPorChave[keyAnterior] || 0);
        });
        
        if (labels.length > 0) {
          // Calcula os perÃ­odos reais para as legendas dinÃ¢micas
          const primeiroMesUltimos6 = sortedUltimos6[0][1].mes;
          const ultimoMesUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].mes;
          const primeiroAnoUltimos6 = sortedUltimos6[0][1].ano;
          const ultimoAnoUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].ano;
          
          const primeiroMesAnterior = sortedAnterior[0][1].mes;
          const ultimoMesAnterior = sortedAnterior[sortedAnterior.length - 1][1].mes;
          const primeiroAnoAnterior = sortedAnterior[0][1].ano;
          const ultimoAnoAnterior = sortedAnterior[sortedAnterior.length - 1][1].ano;
          
          // Cria labels dinÃ¢micas
          let labelUltimos6 = '';
          let labelAnterior = '';
          
          // Se os meses estÃ£o no mesmo ano
          if (primeiroAnoUltimos6 === ultimoAnoUltimos6) {
            labelUltimos6 = `${meses[primeiroMesUltimos6]}-${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
          } else {
            labelUltimos6 = `${meses[primeiroMesUltimos6]} ${primeiroAnoUltimos6} - ${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
          }
          
          if (primeiroAnoAnterior === ultimoAnoAnterior) {
            labelAnterior = `${meses[primeiroMesAnterior]}-${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
          } else {
            labelAnterior = `${meses[primeiroMesAnterior]} ${primeiroAnoAnterior} - ${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
          }
          
          renderComparativeLineChart('chartComparativoTemporal', labels, dadosUltimos6, dadosAnterior, labelUltimos6, labelAnterior);
        }
      }
      
      // GrÃ¡fico: TendÃªncia Anual (ComparaÃ§Ã£o Ano Atual vs Ano Anterior)
      if (columnNames.data || columnNames.dataNT) {
        const dataCol = columnNames.data || columnNames.dataNT;
        const agora = new Date();
        const anoAtual = agora.getFullYear();
        const anoAnterior = anoAtual - 1;
        
        const dadosAnoAtual = {};
        const dadosAnoAnterior = {};
        
        // Inicializa todos os meses
        for (let mes = 0; mes < 12; mes++) {
          dadosAnoAtual[mes] = 0;
          dadosAnoAnterior[mes] = 0;
        }
        
        // Conta os casos
        data.forEach(row => {
          const rawData = row[dataCol];
          if (!rawData) return;
          
          const date = parseDateCell(rawData);
          if (!date || isNaN(date.getTime())) return;
          
          const rowMes = date.getMonth();
          const rowAno = date.getFullYear();
          
          if (rowAno === anoAtual && dadosAnoAtual[rowMes] !== undefined) {
            dadosAnoAtual[rowMes]++;
          } else if (rowAno === anoAnterior && dadosAnoAnterior[rowMes] !== undefined) {
            dadosAnoAnterior[rowMes]++;
          }
        });
        
        // Prepara dados para o grÃ¡fico
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const labels = meses;
        const dadosAtual = Object.values(dadosAnoAtual);
        const dadosAnterior = Object.values(dadosAnoAnterior);
        
        renderComparativeLineChart('chartTendenciaAnual', labels, dadosAtual, dadosAnterior, `Ano ${anoAtual}`, `Ano ${anoAnterior}`);
      }
    }
    
    // FunÃ§Ã£o para aplicar filtros baseado no clique do grÃ¡fico
    function aplicarFiltroDoGrafico(tipoGrafico, valor) {
      console.log('[aplicarFiltroDoGrafico] Chamado com:', tipoGrafico, valor);
      
      // Limpa filtros anteriores relacionados
      const filtrosRelacionados = {
        'chartTipoViolencia': ['tipoViolencia'],
        'chartTipoViolenciaInstitucional': ['violenciaInstitucional'],
        'chartRegiao': ['regiao'],
        'chartEscola': ['escola'],
        'chartIdade': ['idade'],
        'chartGenero': ['genero'],
        'chartRaca': ['raca'],
        'chartEncaminhamento': ['encaminhamento'],
        'chartAutor': ['profissionalAutor', 'estudanteAutor'],
        'chartOcorreuEscola': ['ocorreuEscola'],
        'chartTemporal': ['data'],
        'chartComparativoTemporal': ['data'],
        'chartTendenciaAnual': ['data']
      };
      
      // Limpa checkboxes relacionados
      if (filtrosRelacionados[tipoGrafico]) {
        filtrosRelacionados[tipoGrafico].forEach(filtro => {
          const checkboxes = document.querySelectorAll(`input[data-filter="${filtro}"]`);
          checkboxes.forEach(cb => cb.checked = false);
          // SÃ³ atualiza badge se existir
          const badge = document.getElementById(`badge-${filtro}`);
          if (badge) {
            updateBadge(filtro);
          }
        });
      }
      
      // Limpa filtros de select tambÃ©m
      if (tipoGrafico === 'chartAutor') {
        const filterProf = document.getElementById('filterProfissionalAutor');
        const filterEst = document.getElementById('filterEstudanteAutor');
        if (filterProf) filterProf.value = '';
        if (filterEst) filterEst.value = '';
      }
      if (tipoGrafico === 'chartOcorreuEscola') {
        const filterOcorreu = document.getElementById('filterOcorreuEscola');
        if (filterOcorreu) filterOcorreu.value = '';
      }
      if (tipoGrafico === 'chartIdade') {
        const filterIdadeMin = document.getElementById('filterIdadeMin');
        const filterIdadeMax = document.getElementById('filterIdadeMax');
        if (filterIdadeMin) filterIdadeMin.value = '';
        if (filterIdadeMax) filterIdadeMax.value = '';
      }
      if (tipoGrafico === 'chartTemporal' || tipoGrafico === 'chartComparativoTemporal' || tipoGrafico === 'chartTendenciaAnual') {
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        if (filterDataInicio) filterDataInicio.value = '';
        if (filterDataFim) filterDataFim.value = '';
      }
      
      // Normaliza o valor para comparaÃ§Ã£o
      const valorNormalizado = normalizeText(valor);
      
      // Aplica filtro especÃ­fico baseado no tipo de grÃ¡fico
      switch(tipoGrafico) {
        case 'chartTipoViolencia':
          // Marca checkbox do tipo de violÃªncia (usa data-filter e data-value com normalizaÃ§Ã£o)
          const tipoCheckboxes = document.querySelectorAll(`input[data-filter="tipoViolencia"]`);
          tipoCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('tipoViolencia');
          // Verifica se precisa mostrar card de ViolÃªncias Institucionais
          setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
          break;
          
        case 'chartRegiao':
          const regiaoCheckboxes = document.querySelectorAll(`input[data-filter="regiao"]`);
          regiaoCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('regiao');
          break;
          
        case 'chartEscola':
          const escolaCheckboxes = document.querySelectorAll(`input[data-filter="escola"]`);
          escolaCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('escola');
          break;
          
        case 'chartGenero':
          // Para gÃªnero, precisa mapear valores do grÃ¡fico para valores dos checkboxes
          let generoValor = valor;
          if (valor === 'Masculino' || valor === 'M') generoValor = 'M';
          if (valor === 'Feminino' || valor === 'F') generoValor = 'F';
          
          const generoCheckboxes = document.querySelectorAll(`input[data-filter="genero"]`);
          generoCheckboxes.forEach(cb => {
            const cbValue = cb.dataset.value || '';
            if (cbValue.toUpperCase() === generoValor.toUpperCase() || cbValue === valor) {
              cb.checked = true;
            }
          });
          updateBadge('genero');
          break;
          
        case 'chartRaca':
          const racaCheckboxes = document.querySelectorAll(`input[data-filter="raca"]`);
          racaCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('raca');
          break;
          
        case 'chartTipoViolenciaInstitucional':
          // Primeiro, garante que "Institucional" estÃ¡ selecionado no tipo de violÃªncia
          const tipoViolenciaCheckboxes = document.querySelectorAll(`input[data-filter="tipoViolencia"]`);
          let temInstitucional = false;
          tipoViolenciaCheckboxes.forEach(cb => {
            const cbValue = (cb.dataset.value || '').toLowerCase();
            if (cbValue === 'institucional' || cbValue.includes('institucional')) {
              cb.checked = true;
              temInstitucional = true;
            }
          });
          if (temInstitucional) {
            updateBadge('tipoViolencia');
            // Verifica e mostra o card de ViolÃªncias Institucionais se necessÃ¡rio
            setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
          }
          
          // Marca o checkbox de violÃªncia institucional especÃ­fico
          const violenciaInstCheckboxes = document.querySelectorAll(`input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)`);
          violenciaInstCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          
          // Atualiza o checkbox geral se todos estiverem marcados
          const allViolenciaInstCheckboxes = document.querySelectorAll(`input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)`);
          const checkedCount = Array.from(allViolenciaInstCheckboxes).filter(cb => cb.checked).length;
          const grupoGeral = document.getElementById('checkbox-violencia-institucional-geral');
          if (grupoGeral) {
            grupoGeral.checked = checkedCount === allViolenciaInstCheckboxes.length;
            grupoGeral.indeterminate = checkedCount > 0 && checkedCount < allViolenciaInstCheckboxes.length;
          }
          
          updateBadgeViolenciaInstitucionalTotal();
          break;
          
        case 'chartEncaminhamento':
          // Encaminhamento usa data-group e data-value nos checkboxes individuais
          // O grÃ¡fico mostra valores originais (mapaNormalizado), mas precisa encontrar checkboxes
          // Primeiro desmarca todos os checkboxes de encaminhamento
          const allEncCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]');
          allEncCheckboxes.forEach(cb => cb.checked = false);
          
          // Normaliza o valor clicado para comparaÃ§Ã£o
          const valorNorm = normalizeText(valor);
          const valorLower = valor.toLowerCase().trim();
          
          // Procura checkboxes que correspondem EXATAMENTE ao valor clicado
          // O valor do grÃ¡fico Ã© o valor original (ex: "CT", "CRAS", etc.)
          // Prioriza correspondÃªncia exata para evitar falsos positivos
          let encontrado = false;
          
          // Primeira passagem: busca exata (mais precisa)
          allEncCheckboxes.forEach(cb => {
            const cbValue = (cb.dataset.value || '').trim();
            if (!cbValue) return;
            
            const cbValueNorm = normalizeText(cbValue);
            const cbValueLower = cbValue.toLowerCase().trim();
            
            // Compara valores exatos primeiro (mais preciso)
            if (cbValue === valor || 
                cbValueNorm === valorNorm ||
                cbValueLower === valorLower) {
              cb.checked = true;
              encontrado = true;
            }
          });
          
          // Segunda passagem: busca parcial apenas se nÃ£o encontrou exato
          // Mas apenas se o valor Ã© uma substring completa (nÃ£o apenas parte de uma palavra)
          if (!encontrado) {
            allEncCheckboxes.forEach(cb => {
              const cbValue = (cb.dataset.value || '').trim();
              if (!cbValue) return;
              
              const cbValueNorm = normalizeText(cbValue);
              
              // Busca parcial: verifica se o valor normalizado corresponde exatamente
              // ou se um Ã© substring completa do outro (evita falsos positivos)
              // SÃ³ marca se for correspondÃªncia exata ou substring no inÃ­cio/fim com espaÃ§o ou barra
              const valorIsSubstring = cbValueNorm === valorNorm || 
                                      (cbValueNorm.includes(valorNorm) && 
                                       (cbValueNorm.startsWith(valorNorm + ' ') || 
                                        cbValueNorm.endsWith(' ' + valorNorm) ||
                                        cbValueNorm.startsWith(valorNorm + '/') ||
                                        cbValueNorm.endsWith('/' + valorNorm) ||
                                        cbValueNorm.startsWith(valorNorm + ',') ||
                                        cbValueNorm.endsWith(',' + valorNorm)));
              const cbIsSubstring = valorNorm === cbValueNorm || 
                                    (valorNorm.includes(cbValueNorm) && 
                                     (valorNorm.startsWith(cbValueNorm + ' ') || 
                                      valorNorm.endsWith(' ' + cbValueNorm) ||
                                      valorNorm.startsWith(cbValueNorm + '/') ||
                                      valorNorm.endsWith('/' + cbValueNorm) ||
                                      valorNorm.startsWith(cbValueNorm + ',') ||
                                      valorNorm.endsWith(',' + cbValueNorm)));
              
              if (valorIsSubstring || cbIsSubstring) {
                cb.checked = true;
                encontrado = true;
              }
            });
          }
          
          // Log para debug se nÃ£o encontrou
          if (!encontrado) {
            console.warn('[Filtro Encaminhamento] NÃ£o encontrou checkbox para:', valor);
            const valoresDisponiveis = Array.from(allEncCheckboxes).slice(0, 10).map(cb => cb.dataset.value);
            console.log('[Filtro Encaminhamento] Primeiros 10 checkboxes disponÃ­veis:', valoresDisponiveis);
          }
          
          // Atualiza badge e grupos
          const encSelected = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
          const encBadge = document.getElementById('badge-encaminhamento-total');
          if (encBadge) {
            if (encSelected.length > 0) {
              encBadge.textContent = encSelected.length;
              encBadge.classList.remove('hidden');
            } else {
              encBadge.classList.add('hidden');
            }
          }
          
          // Atualiza grupos que tÃªm checkboxes marcados
          const grupos = new Set();
          encSelected.forEach(cb => {
            const groupId = cb.closest('.encaminhamento-group')?.dataset.group;
            if (groupId) grupos.add(groupId);
          });
          grupos.forEach(groupId => {
            const groupCheckbox = document.getElementById(`group-${groupId}`);
            if (groupCheckbox) {
              const groupCheckboxes = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]`);
              const groupChecked = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]:checked`);
              groupCheckbox.checked = groupChecked.length > 0;
              groupCheckbox.indeterminate = groupChecked.length > 0 && groupChecked.length < groupCheckboxes.length;
            }
          });
          break;
          
        case 'chartAutor':
          console.log('[Filtro Autor] Aplicando filtro para:', valor);
          const filterProf = document.getElementById('filterProfissionalAutor');
          const filterEst = document.getElementById('filterEstudanteAutor');
          // Limpa ambos primeiro
          if (filterProf) filterProf.value = '';
          if (filterEst) filterEst.value = '';
          // Depois define conforme o valor clicado
          if (valor === 'Profissional da Escola' && filterProf) {
            filterProf.value = 'S';
            console.log('[Filtro Autor] Definido: profissionalAutor = S');
          } else if (valor === 'Estudante' && filterEst) {
            filterEst.value = 'S';
            console.log('[Filtro Autor] Definido: estudanteAutor = S');
          } else if (valor === 'Outro Agente (Fora da InstituiÃ§Ã£o)') {
            if (filterProf) filterProf.value = 'N';
            if (filterEst) filterEst.value = 'N';
            console.log('[Filtro Autor] Definido: profissionalAutor = N, estudanteAutor = N');
          } else {
            console.warn('[Filtro Autor] Valor nÃ£o reconhecido:', valor);
          }
          break;
          
        case 'chartOcorreuEscola':
          console.log('[Filtro OcorreuEscola] Aplicando filtro para:', valor);
          const filterOcorreu = document.getElementById('filterOcorreuEscola');
          if (filterOcorreu) {
            // Limpa primeiro
            filterOcorreu.value = '';
            // Depois define conforme o valor clicado
            if (valor === 'Sim') {
              filterOcorreu.value = 'S';
              console.log('[Filtro OcorreuEscola] Definido: ocorreu = S');
            } else if (valor === 'NÃ£o') {
              filterOcorreu.value = 'N';
              console.log('[Filtro OcorreuEscola] Definido: ocorreu = N');
            } else {
              console.warn('[Filtro OcorreuEscola] Valor nÃ£o reconhecido:', valor);
            }
          } else {
            console.error('[Filtro OcorreuEscola] Elemento filterOcorreuEscola nÃ£o encontrado');
          }
          break;
          
        case 'chartIdade':
          // Para idade, precisa extrair a faixa etÃ¡ria (formato: "0-5 anos", "6-10 anos", "18+ anos")
          const idadeMatch = valor.match(/(\d+)-(\d+)/);
          if (idadeMatch) {
            const filterIdadeMin = document.getElementById('filterIdadeMin');
            const filterIdadeMax = document.getElementById('filterIdadeMax');
            if (filterIdadeMin) filterIdadeMin.value = idadeMatch[1];
            if (filterIdadeMax) filterIdadeMax.value = idadeMatch[2];
          } else if (valor.includes('18+')) {
            // Para 18+ anos, define mÃ­nimo como 18 e mÃ¡ximo vazio
            const filterIdadeMin = document.getElementById('filterIdadeMin');
            const filterIdadeMax = document.getElementById('filterIdadeMax');
            if (filterIdadeMin) filterIdadeMin.value = '18';
            if (filterIdadeMax) filterIdadeMax.value = '';
          }
          break;
          
        case 'chartTemporal':
        case 'chartComparativoTemporal':
        case 'chartTendenciaAnual':
          // Para grÃ¡ficos temporais, filtra por mÃªs (formato: "Jan", "Fev", etc.)
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          const mesNome = valor.trim();
          const mesNum = meses.indexOf(mesNome) + 1;
          
          if (mesNum > 0) {
            const agora = new Date();
            const anoAtual = agora.getFullYear();
            
            // Para grÃ¡ficos comparativos, filtra pelo mÃªs no ano atual
            // Define data de inÃ­cio como primeiro dia do mÃªs
            const dataInicio = `${anoAtual}-${String(mesNum).padStart(2, '0')}-01`;
            // Define data de fim como Ãºltimo dia do mÃªs
            const ultimoDia = new Date(anoAtual, mesNum, 0).getDate();
            const dataFim = `${anoAtual}-${String(mesNum).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`;
            
            const filterDataInicio = document.getElementById('filterDataInicio');
            const filterDataFim = document.getElementById('filterDataFim');
            if (filterDataInicio) filterDataInicio.value = dataInicio;
            if (filterDataFim) filterDataFim.value = dataFim;
            console.log(`[Filtro ${tipoGrafico}] Aplicando filtro para mÃªs ${mesNome}:`, dataInicio, 'atÃ©', dataFim);
          } else {
            console.error(`[Filtro ${tipoGrafico}] MÃªs nÃ£o encontrado:`, mesNome);
          }
          break;
      }
      
      // Aplica filtros e rola atÃ© a tabela
      console.log('[aplicarFiltroDoGrafico] Aplicando filtros apÃ³s configurar:', tipoGrafico, 'valor:', valor);
      
      // Se for grÃ¡fico de Tipo ViolÃªncia ou ViolÃªncia Institucional, verifica se precisa mostrar card de ViolÃªncias Institucionais
      if (tipoGrafico === 'chartTipoViolencia' || tipoGrafico === 'chartTipoViolenciaInstitucional') {
        setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
      }
      
      applyFilters();
      
      // Aguarda um pouco para garantir que os filtros foram aplicados e a tabela foi atualizada
      setTimeout(() => {
        const tableContainer = document.getElementById('tableContainer');
        if (tableContainer) {
          tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        const count = filteredData ? filteredData.length : 0;
        console.log('[aplicarFiltroDoGrafico] âœ… Filtros aplicados! Registros filtrados:', count);
        if (count === 0) {
          console.warn('[aplicarFiltroDoGrafico] âš ï¸ Nenhum registro encontrado apÃ³s filtrar por:', valor);
        }
      }, 150);
    }
    
    function renderPieChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Pizza] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Pizza] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Pizza] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Pizza] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo: tenta detectar clique usando getElementsAtEventForMode
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Pizza] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Pizza] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 10,
                font: { size: 11 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} caso${value !== 1 ? 's' : ''} (${percentage}%)`;
                },
                footer: function(context) {
                  const total = context.reduce((sum, item) => sum + (item.parsed || 0), 0);
                  return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                }
              }
            }
          }
        }
      });
    }
    
    function renderBarChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: valores,
            backgroundColor: colors[0],
            borderColor: colors[0].replace('0.8', '1'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              aplicarFiltroDoGrafico(canvasId, label);
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.y;
                  return `${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
    
    function renderHorizontalBarChartGrouped(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Casos',
            data: valores,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.8', '1')),
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Encaminhamento] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Encaminhamento] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Encaminhamento] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Encaminhamento] Nenhum elemento encontrado no clique');
            }
          },
          onHover: (event, elements) => {
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.x;
                  return `${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { 
                stepSize: 1,
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              }
            },
            y: {
              ticks: { 
                font: { size: 11 },
                padding: 8
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
    
    function renderHorizontalBarChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      // Cores alternadas para melhor visualizaÃ§Ã£o
      const backgroundColors = valores.map((_, index) => {
        return colors[index % colors.length];
      });
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y', // Barras horizontais
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              aplicarFiltroDoGrafico(canvasId, label);
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Casos: ${context.parsed.x}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
    
    // Renderiza grÃ¡fico de barras agrupadas (para correlaÃ§Ãµes)
    function renderGroupedBarChart(canvasId, labels, datasets) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
        delete charts[canvasId];
      }
      
      const ctx = canvas.getContext('2d');
      charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 12, weight: 'bold' }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' casos';
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: false,
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Quantidade de Casos',
                font: { size: 12, weight: 'bold' }
              }
            }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const element = elements[0];
              const datasetIndex = element.datasetIndex;
              const index = element.index;
              const label = labels[index];
              const datasetLabel = datasets[datasetIndex].label;
              aplicarFiltroDoGrafico('chartCorrelacaoTipoIdade', `${label} - ${datasetLabel}`);
            }
          }
        }
      });
    }
    
    // Renderiza grÃ¡fico comparativo de linhas (para anÃ¡lises temporais)
    function renderComparativeLineChart(canvasId, labels, data1, data2, label1 = 'PerÃ­odo 1', label2 = 'PerÃ­odo 2') {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
        delete charts[canvasId];
      }
      
      const ctx = canvas.getContext('2d');
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: label1,
              data: data1,
              borderColor: 'rgba(59, 130, 246, 1)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(59, 130, 246, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            },
            {
              label: label2,
              data: data2,
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(239, 68, 68, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 13, weight: 'bold' },
                usePointStyle: true,
                pointStyle: 'circle',
                boxWidth: 12,
                boxHeight: 12
              },
              onClick: (e, legendItem, legend) => {
                // Permite clicar na legenda para mostrar/ocultar datasets
                const index = legendItem.datasetIndex;
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return 'MÃªs: ' + context[0].label;
                },
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' caso' + (context.parsed.y !== 1 ? 's' : '');
                },
                footer: function(context) {
                  const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                  return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Quantidade de Casos',
                font: { size: 12, weight: 'bold' }
              }
            }
          },
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Comparativo] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Comparativo] Elements recebidos:', elements);
            
            if (elements && elements.length > 0) {
              const element = elements[0];
              const index = element.index;
              const label = labels[index];
              console.log('[GrÃ¡fico Comparativo] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Comparativo] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo para grÃ¡fico de linha comparativo
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Comparativo] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Comparativo] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover sobre pontos
            if (event.native && event.native.target) {
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                event.native.target.style.cursor = points && points.length > 0 ? 'pointer' : 'default';
              }
            }
          }
        }
      });
    }
    
    function renderLineChart(canvasId, labels, valores) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      charts[canvasId] = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Casos por MÃªs',
            data: valores,
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Linha] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Linha] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Linha] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Linha] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo para grÃ¡fico de linha
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Linha] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Linha] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: { 
              display: true,
              labels: {
                font: { size: 12, weight: 'bold' },
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return 'MÃªs: ' + context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.y;
                  return `${context.dataset.label}: ${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      const recordCount = document.getElementById('recordCount');
      const noResults = document.getElementById('noResultsMessage');
      
      tbody.innerHTML = '';
      recordCount.textContent = data.length;
      
      if (data.length === 0) {
        noResults.classList.remove('hidden');
        document.getElementById('paginacao').style.display = 'none';
        return;
      } else {
        noResults.classList.add('hidden');
        document.getElementById('paginacao').style.display = 'flex';
      }
      
      // Calcular total de pÃ¡ginas
      totalPaginas = Math.ceil(data.length / registrosPorPagina);
      
      // Garantir que a pÃ¡gina atual seja vÃ¡lida
      if (paginaAtual > totalPaginas) {
        paginaAtual = totalPaginas;
      }
      if (paginaAtual < 1) {
        paginaAtual = 1;
      }
      
      // Calcular Ã­ndices para slice
      const inicio = (paginaAtual - 1) * registrosPorPagina;
      const fim = inicio + registrosPorPagina;
      
      // Pegar apenas os registros da pÃ¡gina atual
      const registrosPagina = data.slice(inicio, fim);
      
      registrosPagina.forEach((row, index) => {
        const tr = document.createElement('tr');
        // Adicionar classes para zebra stripes e hover effect modernos
        const zebraClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-50/50';
        tr.className = 'record-row ' + zebraClass;
        
        const nome = columnNames.crianca ? (row[columnNames.crianca] || 'NÃ£o informado') : 'NÃ£o informado';
        const idade = columnNames.idade ? (row[columnNames.idade] || 'NÃ£o informado') : 'NÃ£o informado';
        const dataViol = columnNames.data ? formatDate(row[columnNames.data]) : 'NÃ£o informado';
        const tipo = columnNames.tipo ? (row[columnNames.tipo] || 'NÃ£o informado') : 'NÃ£o informado';
        const escolaOriginal = columnNames.escola ? (row[columnNames.escola] || '') : '';
        const escola = escolaOriginal ? getDisplayName(escolaOriginal) : 'NÃ£o informado';
        const regiao = columnNames.regiao ? (row[columnNames.regiao] || 'NÃ£o informado') : 'NÃ£o informado';
        const encaminhamento = columnNames.encaminhamento ? (row[columnNames.encaminhamento] || 'NÃ£o informado') : 'NÃ£o informado';
        
        // Combinar colunas U (ocorreu na escola 1.1) e Q (violÃªncia identificada pela escola ocorrida na escola)
        let ocorreuNaEscola = '';
        const ocorreuU = columnNames.ocorreu ? (row[columnNames.ocorreu] || '') : '';
        const ocorreuQ = columnNames.violenciaEscolaOcorreu ? (row[columnNames.violenciaEscolaOcorreu] || '') : '';
        
        if (checkSN(ocorreuU, 'S') || checkSN(ocorreuQ, 'S')) {
          ocorreuNaEscola = 'Sim';
        } else if (checkSN(ocorreuU, 'N') || checkSN(ocorreuQ, 'N')) {
          ocorreuNaEscola = 'NÃ£o';
        } else if (ocorreuU || ocorreuQ) {
          ocorreuNaEscola = ocorreuU || ocorreuQ;
        } else {
          ocorreuNaEscola = 'NÃ£o informado';
        }
        
        const campos = [nome, idade, dataViol, tipo, escola, regiao, encaminhamento, ocorreuNaEscola];
        
        campos.forEach(valor => {
          const td = document.createElement('td');
          td.className = 'px-4 py-3.5 align-top text-gray-700 text-sm font-medium';
          
          // Estilizar "NÃ£o informado" com cor diferente e itÃ¡lico
          if (valor === 'NÃ£o informado') {
            td.className = 'px-4 py-3.5 align-top text-gray-400 text-sm italic';
          }
          
          td.textContent = valor;
          tr.appendChild(td);
        });
        
        // Adicionar coluna de aÃ§Ã£o com botÃ£o de ver detalhes
        const tdAcao = document.createElement('td');
        tdAcao.className = 'px-4 py-3.5 align-middle';
        const btnDetalhes = document.createElement('button');
        btnDetalhes.className = 'btn-ver-detalhes';
        btnDetalhes.title = 'Ver detalhes completos';
        btnDetalhes.setAttribute('data-record-index', index);
        btnDetalhes.innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        `;
        btnDetalhes.addEventListener('click', function(e) {
          e.stopPropagation();
          abrirModalDetalhes(row);
        });
        tdAcao.appendChild(btnDetalhes);
        tr.appendChild(tdAcao);
        
        tbody.appendChild(tr);
      });
      
      // Atualizar controles de paginaÃ§Ã£o
      updatePaginationControls();
    }

    // ==============================
    // MODAL DE DETALHES
    // ==============================
    function abrirModalDetalhes(record) {
      const modal = document.getElementById('modal-detalhes');
      const modalBody = document.getElementById('modal-detalhes-body');
      const modalTitulo = document.getElementById('modal-detalhes-titulo');
      const modalSubtitulo = document.getElementById('modal-detalhes-subtitulo');
      
      const nomeCrianca = record[columnNames.crianca] || record.Crianca || record.CrianÃ§a || 'Registro';
      const idNotificacao = record.idNotificacao || record.ID || record.Id || record['ID NotificaÃ§Ã£o'] || '';
      const dataNTValue = record[columnNames.data] || '';
      const dataNT = dataNTValue ? (formatDate(dataNTValue) || dataNTValue) : '';
      
      modalTitulo.textContent = nomeCrianca;
      modalSubtitulo.textContent = idNotificacao ? `ID: #${idNotificacao} â€¢ ${dataNT}` : (dataNT || 'Detalhes do Registro');

      const normalizeText = (v) => String(v || '').trim();
      const isEmptyValue = (v) => v === undefined || v === null || String(v).trim() === '' || String(v).trim() === 'NÃ£o informado';
      const toDisplay = (v) => isEmptyValue(v) ? 'NÃ£o informado' : String(v).trim();
      
      const toYesNoUnknown = (raw) => {
        const s = String(raw ?? '').trim();
        if (!s) return '';
        const up = s.toLowerCase();
        if (up === 's') return 'Sim';
        if (up === 'n') return 'NÃ£o';
        if (up === 'sim') return 'Sim';
        if (up === 'nÃ£o' || up === 'nao') return 'NÃ£o';
        return s;
      };

      const toYesNoUnknownText = (raw) => {
        const yn = toYesNoUnknown(raw);
        if (yn === 'Sim') return 'Sim';
        if (yn === 'NÃ£o') return 'NÃ£o';
        return 'NÃ£o informado';
      };

      const renderChips = (raw, emptyText = 'Nenhum item informado') => {
        if (isEmptyValue(raw)) {
          return `<span class="text-sm text-gray-500 italic">${emptyText}</span>`;
        }
        const parts = String(raw)
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);
        if (parts.length === 0) {
          return `<span class="text-sm text-gray-500 italic">${emptyText}</span>`;
        }
        return `
          <div class="flex flex-wrap gap-2">
            ${parts.map(p => `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700 border border-blue-200">${p}</span>`).join('')}
          </div>
        `;
      };

      const renderYesNoPill = (raw) => {
        const yn = toYesNoUnknown(raw);
        if (yn === 'Sim') {
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700 border border-green-200">âœ“ Sim</span>`;
        }
        if (yn === 'NÃ£o') {
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700 border border-red-200">âœ— NÃ£o</span>`;
        }
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-600 border border-gray-200">âŠ˜ NÃ£o informado</span>`;
      };

      const renderAnswerPill = (raw) => {
        const yn = toYesNoUnknown(raw);
        if (yn === 'Sim') {
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-blue-50 text-blue-700 border border-blue-200">Sim</span>`;
        }
        if (yn === 'NÃ£o') {
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-blue-50 text-blue-700 border border-blue-200">NÃ£o</span>`;
        }
        return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-gray-50 text-gray-600 border border-gray-200">NÃ£o informado</span>`;
      };

      const renderReadOnlyValue = (text) => {
        const value = String(text ?? '').trim();
        const display = value ? value : 'NÃ£o informado';
        return `<span class="inline-flex items-center px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-900 border border-indigo-200 font-semibold text-sm tracking-tight">${display}</span>`;
      };

      const renderField = (label, valueHtml) => {
        return `
          <div>
            <div class="text-xs sm:text-sm font-semibold text-gray-700 mb-2">${label}</div>
            <div class="text-gray-900">
              ${valueHtml}
            </div>
          </div>
        `;
      };

      const findKeyByContains = (needleParts) => {
        const keys = Object.keys(record || {});
        const normalizedNeedles = (needleParts || []).map(p => String(p).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''));
        for (const k of keys) {
          const nk = String(k).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          if (normalizedNeedles.every(p => nk.includes(p))) return k;
        }
        return null;
      };

      const getTipoInstituicao = (nomeEscola) => {
        const v = normalizeText(nomeEscola);
        if (!v) return '';
        if (v.toUpperCase().startsWith('CMEI')) return 'CMEI - Centro Municipal de EducaÃ§Ã£o Infantil';
        if (v.toUpperCase().startsWith('EMEF')) return 'EMEF - Escola Municipal de Ensino Fundamental';
        return '';
      };

      const escolaValue = record[columnNames.escola] || '';
      const tipoInstituicaoValue = getTipoInstituicao(escolaValue);

      const colaboradoresKey = findKeyByContains(['colaborador']);
      const colaboradoresValue = colaboradoresKey ? record[colaboradoresKey] : '';

      const htmlContent = `
        <div class="bg-gradient-to-br from-blue-50/30 via-indigo-50/20 to-purple-50/30">
          <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 md:p-8 lg:p-10 space-y-6 sm:space-y-8">

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">ğŸ‘¤</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Dados da CrianÃ§a/Estudante</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Preencha as informaÃ§Ãµes bÃ¡sicas da crianÃ§a ou estudante envolvido no caso</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  <div class="md:col-span-2">${renderField('Nome da CrianÃ§a/Estudante *', renderReadOnlyValue(toDisplay(record[columnNames.crianca] || '')))}</div>
                  ${renderField('Data da NotificaÃ§Ã£o (NT) *', renderReadOnlyValue(toDisplay(dataNT || '')))}
                  ${renderField('Idade *', renderReadOnlyValue(toDisplay(record[columnNames.idade] || '')))}
                  ${renderField('Identidade de GÃªnero *', renderReadOnlyValue(toDisplay(record[columnNames.genero] || '')))}
                  ${renderField('Ã‰ PCD/tem Transtorno?', renderReadOnlyValue(toDisplay(record[columnNames.pcd] || '')))}
                  ${renderField('RaÃ§a/Cor', renderReadOnlyValue(toDisplay(record[columnNames.raca] || '')))}
                  ${renderField('OrientaÃ§Ã£o Sexual', renderReadOnlyValue(toDisplay(record[columnNames.orientacaoSexual] || '')))}
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-amber-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-amber-100 text-amber-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">âš ï¸</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">SituaÃ§Ã£o da ViolÃªncia</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Descreva o tipo de violÃªncia ocorrida e os encaminhamentos realizados</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  <div class="md:col-span-2">${renderField('Tipo de ViolÃªncia *', renderChips(record[columnNames.tipo] || '', 'Nenhum tipo informado'))}</div>
                  <div class="md:col-span-2">${renderField('Encaminhamento', renderChips(record[columnNames.encaminhamento] || '', 'Nenhum encaminhamento informado'))}</div>
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-emerald-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-emerald-100 text-emerald-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">ğŸ«</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Dados da InstituiÃ§Ã£o</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Preencha informaÃ§Ãµes sobre a escola e regiÃ£o onde ocorreu o caso</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  ${renderField('Qual o tipo da instituiÃ§Ã£o de ensino? *', renderReadOnlyValue(toDisplay(tipoInstituicaoValue || '')))}
                  ${renderField('RegiÃ£o *', renderReadOnlyValue(toDisplay(record[columnNames.regiao] || '')))}
                  <div class="md:col-span-2">${renderField('InstituiÃ§Ã£o de Ensino *', renderReadOnlyValue(toDisplay(escolaValue || '')))}</div>
                  <div class="md:col-span-2">${renderField('ResponsÃ¡vel pelo Registro *', renderReadOnlyValue(toDisplay(record[columnNames.responsavel] || '')))}</div>
                  <div class="md:col-span-2">${renderField('Colaboradores (opcional)', renderChips(colaboradoresValue || '', 'Nenhum colaborador adicionado'))}</div>
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-purple-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">â“</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">InformaÃ§Ãµes Complementares</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Responda Ã s questÃµes adicionais sobre o contexto da violÃªncia</p>
                  </div>
                </div>
                ${(() => {
                  const foiMembroFamiliarValue = record[columnNames.foiMembroFamiliar] || '';
                  const fonteEscolaValue = record[columnNames.fonteInformada] || '';
                  const violenciaEscolaOcorreuValue = record[columnNames.violenciaEscolaOcorreu] || '';
                  const profissionalAutorValue = record[columnNames.profissionalAutor] || '';
                  const estudanteAutorValue = record[columnNames.estudanteAutor] || '';
                  const violenciaNaoEscolaValue = record[columnNames.violenciaNaoEscola] || '';
                  const violenciaInformadaValue = record[columnNames.violenciaInformada] || '';
                  const ocorreuValue = record[columnNames.ocorreu] || '';
                  const estudoCasoValue = record[columnNames.estudoCaso] || '';

                  const renderTooltip = (tooltipTitle, tooltipBody) => {
                    return `
                      <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                        <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">â“˜</span>
                        <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                          <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                          <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                            <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">${tooltipTitle}</div>
                            <div class="leading-relaxed text-gray-800">${tooltipBody}</div>
                          </span>
                        </span>
                      </span>
                    `;
                  };

                  const renderQ = (questionText, answerRaw, tooltipTitle, tooltipBody) => {
                    return `
                      <div class="space-y-1">
                        <div class="text-sm font-medium text-gray-800">
                          ${questionText}
                          ${renderTooltip(tooltipTitle, tooltipBody)}
                        </div>
                        <div>${renderReadOnlyValue(toYesNoUnknownText(answerRaw))}</div>
                      </div>
                    `;
                  };

                  const shouldShowOcorreu = toYesNoUnknown(violenciaInformadaValue) === 'Sim';

                  return `
                    <div class="space-y-4">
                      ${renderQ(
                        'O autor era membro da famÃ­lia?',
                        foiMembroFamiliarValue,
                        'Membro da famÃ­lia',
                        'Use esta informaÃ§Ã£o para entender se o caso tem indÃ­cio de violÃªncia intrafamiliar. Considere como familiar: pais ou responsÃ¡veis legais, avÃ³s, irmÃ£os, tios, primos e outros parentes consanguÃ­neos ou por afinidade. Quando marcado como â€œSimâ€, costuma indicar necessidade de atenÃ§Ã£o para contexto domÃ©stico e rede de proteÃ§Ã£o.'
                      )}

                      ${renderQ(
                        'O relato foi feito pela escola?',
                        fonteEscolaValue,
                        'Fonte do relato',
                        'Mostra quem iniciou o relato/notificaÃ§Ã£o do caso. â€œSimâ€ significa que a prÃ³pria escola identificou e registrou o caso (direÃ§Ã£o, coordenaÃ§Ã£o, professores ou equipe). â€œNÃ£oâ€ indica que o caso chegou Ã  escola por outra fonte (ex.: famÃ­lia, estudante, serviÃ§os, instituiÃ§Ãµes externas). Isso ajuda a interpretar como a escola tomou conhecimento do ocorrido.'
                      )}

                      ${renderQ(
                        'A escola identificou que a violÃªncia ocorreu na escola?',
                        violenciaEscolaOcorreuValue,
                        'Local confirmado (na escola)',
                        'Indica se, apÃ³s apuraÃ§Ã£o/verificaÃ§Ã£o, foi confirmado que o fato ocorreu dentro do ambiente escolar (ex.: sala, pÃ¡tio, banheiro, quadra). Este campo descreve o local do ocorrido â€” nÃ£o a autoria â€” e ajuda a diferenciar situaÃ§Ãµes internas da escola de situaÃ§Ãµes externas acompanhadas pela escola.'
                      )}

                      ${renderQ(
                        'Algum profissional/funcionÃ¡rio da escola foi autor da violÃªncia?',
                        profissionalAutorValue,
                        'Autoria (profissional)',
                        'Indica se a autoria do caso foi atribuÃ­da a profissional/funcionÃ¡rio da escola. Considere professores, coordenaÃ§Ã£o, direÃ§Ã£o, auxiliares, terceirizados (limpeza, seguranÃ§a, portaria, merenda) e demais colaboradores. Esse campo Ã© importante porque muda a interpretaÃ§Ã£o do caso e os encaminhamentos administrativos.'
                      )}

                      ${renderQ(
                        'Algum estudante foi autor da violÃªncia?',
                        estudanteAutorValue,
                        'Autoria (estudante)',
                        'Indica se a autoria foi atribuÃ­da a estudante (da mesma escola ou de outra unidade). Em geral, Ã© usado para casos como agressÃµes entre estudantes, bullying/cyberbullying e outras violÃªncias no contexto escolar entre pares.'
                      )}

                      ${renderQ(
                        'A escola identificou que a violÃªncia NÃƒO ocorreu na escola?',
                        violenciaNaoEscolaValue,
                        'Local confirmado (fora da escola)',
                        'Indica se, apÃ³s verificaÃ§Ã£o, foi confirmado que o fato ocorreu fora do ambiente escolar (ex.: residÃªncia, via pÃºblica, transporte, outros locais externos). Mesmo quando a escola acompanha ou identifica o caso, este campo ajuda a registrar que o local do ocorrido nÃ£o foi na escola.'
                      )}

                      ${renderQ(
                        'A violÃªncia foi comunicada Ã  escola por algum agente externo?',
                        violenciaInformadaValue,
                        'ComunicaÃ§Ã£o por terceiros',
                        'Indica se a escola tomou conhecimento do caso por comunicaÃ§Ã£o de terceiros (agentes externos), e nÃ£o por identificaÃ§Ã£o direta da equipe escolar. Exemplos: famÃ­lia, o prÃ³prio estudante, vizinhos, Conselho Tutelar, PolÃ­cia, UBS, CRAS, entre outros. Esse campo Ã© Ãºtil para interpretar a origem da informaÃ§Ã£o e o fluxo de notificaÃ§Ã£o.'
                      )}

                      ${shouldShowOcorreu ? renderQ(
                        'âœ A violÃªncia ocorreu na escola?',
                        ocorreuValue,
                        'ConfirmaÃ§Ã£o do local',
                        'Este campo aparece quando o caso foi comunicado por agente externo. Ele registra a conclusÃ£o (apÃ³s apuraÃ§Ã£o) sobre onde o fato ocorreu: dentro ou fora da escola. Serve para evitar interpretaÃ§Ãµes ambÃ­guas quando a informaÃ§Ã£o chegou por terceiros, mas o local do ocorrido ainda precisa ser confirmado.'
                      ) : ''}

                      ${renderQ(
                        'Foi realizado estudo de caso pela equipe?',
                        estudoCasoValue,
                        'Estudo de caso',
                        'Indica se a equipe realizou estudo de caso (anÃ¡lise estruturada do registro), geralmente com reuniÃµes, avaliaÃ§Ã£o multidisciplinar (pedagÃ³gica/psicossocial/direÃ§Ã£o), definiÃ§Ã£o de plano de intervenÃ§Ã£o e documentaÃ§Ã£o interna. Ajuda a entender o nÃ­vel de consolidaÃ§Ã£o do acompanhamento do caso.'
                      )}
                    </div>
                  `;
                })()}
              </div>
            </section>
          </div>
        </div>
      `;

      modalBody.innerHTML = htmlContent || '<p class="text-gray-500 text-center py-8">Nenhuma informaÃ§Ã£o disponÃ­vel</p>';
      
      // Capturar posiÃ§Ã£o atual do scroll
      const scrollY = window.scrollY || window.pageYOffset;
      
      // Salvar posiÃ§Ã£o do scroll para restaurar depois
      modal.dataset.scrollY = scrollY;
      
      // Bloquear scroll do body e manter posiÃ§Ã£o visual
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = '100%';
      document.body.classList.add('modal-open');
      
      // Abrir modal comeÃ§ando na posiÃ§Ã£o atual do scroll
      modal.style.top = `${scrollY}px`;
      modal.style.height = `${window.innerHeight}px`;
      modal.classList.add('visible');
      
      // Scrollar o modal para mostrar o conteÃºdo no topo
      setTimeout(() => {
        modal.scrollTop = 0;
      }, 10);
    }

    function fecharModalDetalhes() {
      const modal = document.getElementById('modal-detalhes');
      const scrollY = modal.dataset.scrollY || '0';
      
      // Remover bloqueio de scroll
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      document.body.classList.remove('modal-open');
      
      // Fechar modal
      modal.classList.remove('visible');
      modal.style.top = '';
      modal.style.height = '';
      
      // Restaurar posiÃ§Ã£o do scroll
      window.scrollTo(0, parseInt(scrollY));
    }

    // ==============================
    // FunÃ§Ãµes de PaginaÃ§Ã£o
    // ==============================
    function updatePaginationControls() {
      const info = document.getElementById('paginacaoInfo');
      const btnPrimeira = document.getElementById('btnPrimeiraPagina');
      const btnAnterior = document.getElementById('btnPaginaAnterior');
      const btnProxima = document.getElementById('btnProximaPagina');
      const btnUltima = document.getElementById('btnUltimaPagina');
      
      info.textContent = paginaAtual + ' de ' + totalPaginas;
      
      // Desabilitar botÃµes conforme necessÃ¡rio
      btnPrimeira.disabled = (paginaAtual === 1);
      btnAnterior.disabled = (paginaAtual === 1);
      btnProxima.disabled = (paginaAtual === totalPaginas);
      btnUltima.disabled = (paginaAtual === totalPaginas);
    }
    
    function irParaPagina(novaPagina) {
      if (novaPagina >= 1 && novaPagina <= totalPaginas) {
        paginaAtual = novaPagina;
        renderTable(filteredData);
        // Scroll suave para a seÃ§Ã£o de resultados
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    function alterarRegistrosPorPagina() {
      const select = document.getElementById('registrosPorPaginaSelect');
      registrosPorPagina = parseInt(select.value, 10);
      paginaAtual = 1; // Voltar para primeira pÃ¡gina
      renderTable(filteredData);
    }

    // ========================================
    // VERIFICAR AUTENTICAÃ‡ÃƒO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');
      
      // Se nÃ£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! FaÃ§a login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }

    // Ajusta visibilidade do menu para visualizador (somente painel)
    ajustarMenuPorRole(userRole);
    configurarLogoutVisualizador(userRole);
    }

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = document.getElementById('menuIcon');
      mobileMenu.classList.toggle('show');
      menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
    }
    
    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = document.getElementById('menuIcon');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          menuIcon.style.transform = 'rotate(0deg)';
        }
      }
    });

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');
      
      // Mostra botÃ£o de sair para TODOS os usuÃ¡rios
      if (btnSair) {
        btnSair.classList.remove('hidden');
      }
      if (btnSairMobile) {
        btnSairMobile.classList.remove('hidden');
      }
      
      // Menu Admin apenas para admin/superuser
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
      }
      
      // Configura botÃ£o de sair para visualizador (desktop e mobile)
      configurarLogoutVisualizador(userRole);
    }

  // Esconde links de criaÃ§Ã£o/gestÃ£o para visualizadores
  function ajustarMenuPorRole(role) {
    if (role !== 'visualizador') return;
    const seletorLinksRestritos = [
      'a[href="registro-novo-caso.html"]',
      'a[href="gerenciar-casos.html"]',
      'a[href="gerenciar-usuarios.html"]'
    ].join(',');
    
    document.querySelectorAll(seletorLinksRestritos).forEach(el => {
      el.style.display = 'none';
    });
  }

  // Mostra botÃ£o de sair especÃ­fico para visualizador (desktop e mobile)
  function configurarLogoutVisualizador(role) {
    const btnLogoutMobile = document.getElementById('btnLogoutVisualizadorMobile');
    const btnLogoutDesktop = document.getElementById('btnSairVisualizadorDesktop');
    
    if (role === 'visualizador') {
      // Mostra botÃ£o no mobile
      if (btnLogoutMobile) {
        btnLogoutMobile.classList.remove('hidden');
        btnLogoutMobile.onclick = () => sair();
      }
      // Mostra botÃ£o no desktop
      if (btnLogoutDesktop) {
        btnLogoutDesktop.classList.remove('hidden');
      }
    } else {
      // Esconde botÃµes se nÃ£o for visualizador
      if (btnLogoutMobile) {
        btnLogoutMobile.classList.add('hidden');
      }
      if (btnLogoutDesktop) {
        btnLogoutDesktop.classList.add('hidden');
      }
    }
  }

    // ========================================
    // FECHAR MENU MOBILE AO CLICAR EM LINK
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = document.getElementById('menuIcon');
          if (mobileMenu && menuIcon) {
            mobileMenu.classList.remove('show');
            menuIcon.style.transform = 'rotate(0deg)';
          }
        });
      });
      
      verificarMenuAdmin();
      
      // Carregar contador de notificaÃ§Ãµes
      carregarContadorNotificacoes();
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO ENTRE PÃGINAS: Listener para invalidaÃ§Ã£o de cache
      window.addEventListener('storage', (event) => {
        if (event.key === 'naam_cache_invalidation' && event.newValue) {
          try {
            const invalidationEvent = JSON.parse(event.newValue);
            if (invalidationEvent.type === 'cache_invalidation' && invalidationEvent.cacheKey === 'gerenciar_casos') {
              console.log('[SincronizaÃ§Ã£o] ğŸ“¡ Evento de invalidaÃ§Ã£o recebido da pÃ¡gina:', invalidationEvent.source);
              
              // Limpa cache local
              if (window.DataCache) {
                window.DataCache.clear('gerenciar_casos');
                window.DataCache.clearAll();
                console.log('[SincronizaÃ§Ã£o] âœ… Cache local invalidado');
              }
              
              // Recarrega dados automaticamente se estiver na pÃ¡gina de painel
              if (typeof carregarDadosPlanilha === 'function') {
                console.log('[SincronizaÃ§Ã£o] ğŸ”„ Recarregando dados da planilha...');
                // Aguarda 500ms para evitar conflito com a pÃ¡gina que iniciou
                setTimeout(() => {
                  carregarDadosPlanilha();
                }, 500);
              }
            }
          } catch (e) {
            console.warn('[SincronizaÃ§Ã£o] âš ï¸ Erro ao processar evento de invalidaÃ§Ã£o:', e);
          }
        }
      });
    });

    // ========================================
    // SISTEMA DE MÃQUINA DE ESTADOS PARA NOTIFICAÃ‡Ã•ES
    // Garante: Toast SEMPRE aparece antes do Alerta (nunca simultÃ¢neo)
    // ========================================
    
    const NOTIF_STATES = {
      IDLE: 'idle',                           // Nenhuma notificaÃ§Ã£o visÃ­vel
      TOAST_SHOWING: 'toast_showing',         // Toast estÃ¡ visÃ­vel/animando
      TOAST_EXITING: 'toast_exiting',         // Toast saindo (bloqueio ao alerta)
      ALERT_SHOWING: 'alert_showing',         // Alerta estÃ¡ visÃ­vel
      ALERT_EXITING: 'alert_exiting'          // Alerta saindo
    };
    
    // Flag global: indica que o usuÃ¡rio iniciou uma atualizaÃ§Ã£o manual
    // a partir do popup azul de nova notificaÃ§Ã£o.
    // Esta flag Ã© usada pelo ChangeDetector e pelos gerenciadores de alerta/toast
    // para suprimir qualquer alerta visual redundante nesse ciclo.
    window.atualizacaoDisparadaPeloUsuario = window.atualizacaoDisparadaPeloUsuario || false;
    // Alias compatÃ­vel com a nomenclatura sugerida na documentaÃ§Ã£o
    window.atualizacaoIniciadaViaPopup = window.atualizacaoDisparadaPeloUsuario;
    
    // ========================================
    // SISTEMA DE SINCRONIZAÃ‡ÃƒO ENTRE PÃGINAS
    // ========================================
    // Rastreia estado do popup azul e sincroniza entre painel-casos.html e gerenciar-casos.html
    const SYNC_STATE_KEY = 'naam_popup_azul_sync_state';
    const SYNC_LAST_NOTIF_ID_KEY = 'naam_last_synced_notif_id';
    
    /**
     * Salva estado de sincronizaÃ§Ã£o no localStorage
     * @param {Object} state - Estado a ser salvo
     */
    function salvarEstadoSincronizacao(state) {
      try {
        const syncState = {
          ...state,
          timestamp: Date.now(),
          pagina: window.location.pathname.includes('painel-casos') ? 'painel' : 'gerenciar'
        };
        localStorage.setItem(SYNC_STATE_KEY, JSON.stringify(syncState));
        console.log('[Sync] ğŸ’¾ Estado salvo:', syncState);
      } catch (e) {
        console.warn('[Sync] âš ï¸ Erro ao salvar estado:', e);
      }
    }
    
    /**
     * LÃª estado de sincronizaÃ§Ã£o do localStorage
     * @returns {Object|null} Estado ou null se nÃ£o existir
     */
    function lerEstadoSincronizacao() {
      try {
        const stored = localStorage.getItem(SYNC_STATE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.warn('[Sync] âš ï¸ Erro ao ler estado:', e);
      }
      return null;
    }
    
    /**
     * Limpa estado de sincronizaÃ§Ã£o
     */
    function limparEstadoSincronizacao() {
      try {
        localStorage.removeItem(SYNC_STATE_KEY);
        console.log('[Sync] ğŸ§¹ Estado limpo');
      } catch (e) {
        console.warn('[Sync] âš ï¸ Erro ao limpar estado:', e);
      }
    }
    
    /**
     * Marca que popup azul foi criado (ativo)
     * @param {number} notifId - ID da notificaÃ§Ã£o que gerou o popup
     */
    function marcarPopupAzulAtivo(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: true,
        popupFechadoSemAtualizar: false,
        popupAtualizado: false,
        notifId: notifId
      });
    }
    
    /**
     * Marca que popup azul foi fechado sem atualizar
     * @param {number} notifId - ID da notificaÃ§Ã£o
     */
    function marcarPopupAzulFechadoSemAtualizar(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: false,
        popupFechadoSemAtualizar: true,
        popupAtualizado: false,
        notifId: notifId
      });
    }
    
    /**
     * Marca que popup azul foi atualizado (usuÃ¡rio clicou em Atualizar)
     * @param {number} notifId - ID da notificaÃ§Ã£o
     */
    function marcarPopupAzulAtualizado(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: false,
        popupFechadoSemAtualizar: false,
        popupAtualizado: true,
        notifId: notifId
      });
      // Salva Ãºltimo ID sincronizado
      try {
        localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
      } catch (e) {
        console.warn('[Sync] âš ï¸ Erro ao salvar Ãºltimo ID sincronizado:', e);
      }
    }
    
    /**
     * Verifica estado sincronizado na inicializaÃ§Ã£o da pÃ¡gina
     * Se popup foi fechado sem atualizar em outra pÃ¡gina, mostra alerta vermelho
     */
    function verificarEstadoSincronizadoNaInicializacao() {
      const estado = lerEstadoSincronizacao();
      if (!estado) return;
      
      console.log('[Sync] ğŸ” Verificando estado sincronizado:', estado);
      
      // Se popup foi fechado sem atualizar E nÃ£o foi atualizado depois
      if (estado.popupFechadoSemAtualizar && !estado.popupAtualizado) {
        // Verifica se o ID da notificaÃ§Ã£o ainda Ã© relevante (nÃ£o foi atualizado em outra pÃ¡gina)
        const ultimoIdSincronizado = localStorage.getItem(SYNC_LAST_NOTIF_ID_KEY);
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
        
        console.log('[Sync] ğŸ“Š ComparaÃ§Ã£o de IDs:', {
          ultimoIdSincronizado,
          ultimoIdSalvo,
          estadoNotifId: estado.notifId
        });
        
        // Se nÃ£o hÃ¡ ID sincronizado, significa que nunca houve atualizaÃ§Ã£o via popup
        // Nesse caso, sempre mostra o alerta se o popup foi fechado sem atualizar
        if (!ultimoIdSincronizado) {
          console.log('[Sync] ğŸ”” Popup foi fechado sem atualizar (nunca houve atualizaÃ§Ã£o). Mostrando alerta vermelho...');
          
          // ForÃ§a mostrar alerta vermelho e animaÃ§Ã£o
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }
        
        // Se hÃ¡ ID sincronizado, verifica se o ID atual Ã© diferente (ainda hÃ¡ notificaÃ§Ã£o pendente)
        // OU se o ID do estado Ã© diferente do sincronizado (a notificaÃ§Ã£o que gerou o popup ainda nÃ£o foi processada)
        if (ultimoIdSalvo && ultimoIdSalvo !== ultimoIdSincronizado) {
          console.log('[Sync] ğŸ”” Popup foi fechado sem atualizar e hÃ¡ notificaÃ§Ã£o pendente. Mostrando alerta vermelho...');
          
          // ForÃ§a mostrar alerta vermelho e animaÃ§Ã£o
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }
        
        // Se o ID do estado Ã© diferente do sincronizado, tambÃ©m mostra (notificaÃ§Ã£o especÃ­fica nÃ£o foi processada)
        if (estado.notifId && String(estado.notifId) !== ultimoIdSincronizado) {
          console.log('[Sync] ğŸ”” Popup foi fechado sem atualizar e a notificaÃ§Ã£o especÃ­fica nÃ£o foi processada. Mostrando alerta vermelho...');
          
          // ForÃ§a mostrar alerta vermelho e animaÃ§Ã£o
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }
        
        // Se chegou aqui e o popup foi fechado sem atualizar, mostra o alerta de qualquer forma
        // (pode ser que o ID ainda nÃ£o tenha sido atualizado, mas o popup foi fechado)
        console.log('[Sync] ğŸ”” Popup foi fechado sem atualizar. Mostrando alerta vermelho (fallback)...');
        
        // ForÃ§a mostrar alerta vermelho e animaÃ§Ã£o
        window.popupAzulFechadoPeloUsuario = true;
        setTimeout(() => {
          if (typeof showAlertaNovasNotificacoes === 'function') {
            showAlertaNovasNotificacoes();
          }
        }, 500);
      }
    }
    
    /**
     * Detecta navegaÃ§Ã£o entre pÃ¡ginas e marca popup como fechado se estava ativo
     */
    function configurarDetecaoNavegacao() {
      // Detecta quando usuÃ¡rio estÃ¡ saindo da pÃ¡gina
      window.addEventListener('beforeunload', () => {
        const estado = lerEstadoSincronizacao();
        const popupAtivo = document.getElementById('notificacao-nova-notificacao');
        
        console.log('[Sync] ğŸšª beforeunload disparado. Estado:', estado, 'Popup ativo:', !!popupAtivo);
        
        // Se hÃ¡ popup azul ativo e usuÃ¡rio estÃ¡ navegando sem atualizar
        if (estado && estado.popupAtivo && popupAtivo) {
          console.log('[Sync] ğŸšª UsuÃ¡rio navegando com popup azul ativo. Marcando como fechado sem atualizar...');
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
          marcarPopupAzulFechadoSemAtualizar(notifId);
        } else if (popupAtivo) {
          // Se hÃ¡ popup ativo mas nÃ£o hÃ¡ estado salvo, cria o estado
          console.log('[Sync] ğŸšª Popup ativo mas sem estado. Criando estado e marcando como fechado...');
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
          marcarPopupAzulFechadoSemAtualizar(notifId);
        }
      });
      
      // TambÃ©m detecta quando a pÃ¡gina fica oculta (mudanÃ§a de aba)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          const estado = lerEstadoSincronizacao();
          const popupAtivo = document.getElementById('notificacao-nova-notificacao');
          
          console.log('[Sync] ğŸ‘ï¸ PÃ¡gina ocultada. Estado:', estado, 'Popup ativo:', !!popupAtivo);
          
          // Se hÃ¡ popup azul ativo e pÃ¡gina foi ocultada
          if (estado && estado.popupAtivo && popupAtivo) {
            console.log('[Sync] ğŸ‘ï¸ PÃ¡gina ocultada com popup azul ativo. Marcando como fechado sem atualizar...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
            marcarPopupAzulFechadoSemAtualizar(notifId);
          } else if (popupAtivo) {
            // Se hÃ¡ popup ativo mas nÃ£o hÃ¡ estado salvo, cria o estado
            console.log('[Sync] ğŸ‘ï¸ Popup ativo mas sem estado. Criando estado e marcando como fechado...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
            marcarPopupAzulFechadoSemAtualizar(notifId);
          }
        }
      });
    }
    
    // Configura detecÃ§Ã£o de navegaÃ§Ã£o ao carregar
    configurarDetecaoNavegacao();

    const NotificationManager = {
      state: NOTIF_STATES.IDLE,
      hasStoredNotif: false,
      timeoutMap: {},
      
      // ===== ESTADO MÃQUINA =====
      setState(newState) {
        if (newState === this.state) return;
        console.log(`[NotifState] ${this.state} â†’ ${newState}`);
        this.state = newState;
      },
      
      // ===== VERIFICAÃ‡Ã•ES DE SEGURANÃ‡A =====
      canShowToast() {
        return this.state === NOTIF_STATES.IDLE;
      },
      
      canShowAlert() {
        // Alerta SÃ“ pode aparecer se:
        // 1. Estado Ã© IDLE (nenhuma notificaÃ§Ã£o ativa)
        // 2. Toast NÃƒO estÃ¡ visÃ­vel
        return this.state === NOTIF_STATES.IDLE && 
               !this.isToastVisible();
      },
      
      isToastVisible() {
        const toast = document.getElementById('notificacao-nova-notificacao');
        if (!toast) return false;
        return toast.style.display !== 'none' && 
               !toast.classList.contains('notificacao-exit');
      },
      
      // ===== MOSTRAR TOAST =====
      showToast() {
        // Rejeita se nÃ£o estÃ¡ em IDLE
        if (!this.canShowToast()) {
          console.warn('[NotifManager] âŒ Toast rejeitado: estado nÃ£o Ã© IDLE');
          return false;
        }
        
        this.setState(NOTIF_STATES.TOAST_SHOWING);
        this.hasStoredNotif = true;
        
        // Bloqueia o alerta (se existir)
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.add('toast-blocking');
        }
        
        // Salva flag no localStorage (para recargas)
        try {
          localStorage.setItem('naam_new_notif_flag', '1');
        } catch (e) {
          console.warn('[NotifManager] Erro ao salvar flag:', e);
        }
        
        console.log('[NotifManager] âœ… Toast: MOSTRANDO');
        return true;
      },
      
      // ===== INICIAR SAÃDA DO TOAST =====
      startToastExit() {
        if (this.state !== NOTIF_STATES.TOAST_SHOWING) {
          console.warn('[NotifManager] âŒ Toast exit rejeitado: estado nÃ£o Ã© TOAST_SHOWING');
          return;
        }
        
        this.setState(NOTIF_STATES.TOAST_EXITING);
        console.log('[NotifManager] â¹ï¸ Toast: SAINDO (alerta BLOQUEADO)');
        
        // Libera o alerta apÃ³s a animaÃ§Ã£o (400ms)
        this.clearTimeout('toastExit');
        this.timeoutMap['toastExit'] = setTimeout(() => {
          this.completeToastExit();
        }, 400);
      },
      
      // ===== COMPLETAR SAÃDA DO TOAST =====
      completeToastExit() {
        this.setState(NOTIF_STATES.IDLE);
        console.log('[NotifManager] âœ… Toast: REMOVIDO - liberando Alerta');
        
        // Desbloqueia o alerta
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.remove('toast-blocking');
        }
        
        // Agora sim, mostra o alerta se foi marcado
        if (this.hasStoredNotif) {
          setTimeout(() => this.showAlert(), 50);
        }
      },
      
      // ===== MOSTRAR ALERTA =====
      showAlert() {
        // SEGURANÃ‡A: Rejeita se toast ainda estÃ¡ visÃ­vel
        if (!this.canShowAlert()) {
          console.warn('[NotifManager] âŒ Alerta rejeitado: Toast ainda estÃ¡ ativo ou estado invÃ¡lido');
          return false;
        }
        // Bloqueio global: se atualizaÃ§Ã£o foi iniciada via popup azul,
        // nÃ£o exibir alerta e remover qualquer instÃ¢ncia existente do DOM
        if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
          console.warn('[NotifManager] ğŸš« Alerta bloqueado: atualizaÃ§Ã£o iniciada via popup');
          const alertaBloquear = document.getElementById('alerta-novas-notificacoes');
          if (alertaBloquear) alertaBloquear.remove();
          return false;
        }
        
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (!alerta) return false;
        
        this.setState(NOTIF_STATES.ALERT_SHOWING);
        
        // Animar entrada do alerta
        alerta.style.display = 'flex';
        void alerta.offsetWidth; // ForÃ§a reflow
        alerta.classList.remove('hide');
        alerta.classList.add('show');
        
        // âœ¨ Ativa animaÃ§Ã£o de pulsar no botÃ£o de atualizar
        ativarPulseBotao('btnAtualizar');
        
        console.log('[NotifManager] âœ… Alerta: MOSTRANDO');
        return true;
      },
      
      // ===== INICIAR SAÃDA DO ALERTA =====
      startAlertExit() {
        if (this.state !== NOTIF_STATES.ALERT_SHOWING) {
          console.warn('[NotifManager] âš ï¸ Alert exit: estado nÃ£o Ã© ALERT_SHOWING, ignorando');
          return;
        }
        
        this.setState(NOTIF_STATES.ALERT_EXITING);
        console.log('[NotifManager] â¹ï¸ Alerta: SAINDO');
        
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.remove('show');
          alerta.classList.add('hide');
        }
        
        // Completa saÃ­da apÃ³s animaÃ§Ã£o
        this.clearTimeout('alertExit');
        this.timeoutMap['alertExit'] = setTimeout(() => {
          this.completeAlertExit();
        }, 400);
      },
      
      // ===== COMPLETAR SAÃDA DO ALERTA =====
      completeAlertExit() {
        this.setState(NOTIF_STATES.IDLE);
        this.hasStoredNotif = false;
        
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          // Se a saÃ­da foi disparada em um fluxo iniciado via popup azul,
          // removemos o alerta definitivamente do DOM para nÃ£o deixar resÃ­duos.
          if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
            alerta.remove();
          } else {
            alerta.style.display = 'none';
            alerta.classList.remove('show', 'hide');
          }
        }
        
        // âœ¨ Remove animaÃ§Ã£o de pulsar do botÃ£o de atualizar
        desativarPulseBotao('btnAtualizar');
        
        // Limpa localStorage
        try {
          localStorage.removeItem('naam_new_notif_flag');
        } catch (e) {
          console.warn('[NotifManager] Erro ao limpar flag:', e);
        }
        
        console.log('[NotifManager] âœ… Sistema: IDLE novamente');
      },
      
      // ===== HELPERS =====
      clearTimeout(key) {
        if (this.timeoutMap[key]) {
          clearTimeout(this.timeoutMap[key]);
          delete this.timeoutMap[key];
        }
      },
      
      cleanup() {
        Object.keys(this.timeoutMap).forEach(key => this.clearTimeout(key));
        this.state = NOTIF_STATES.IDLE;
      }
    };
    
    // ===== FUNÃ‡Ã•ES UTILITÃRIAS PARA ANIMAÃ‡ÃƒO DE PULSAR =====
    /**
     * Ativa a animaÃ§Ã£o de pulsar em um botÃ£o
     * @param {HTMLElement|string} botao - Elemento do botÃ£o ou ID do botÃ£o
     */
    function ativarPulseBotao(botao) {
      const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
      if (elemento) {
        elemento.classList.add('btn-pulse-active');
      }
    }
    
    /**
     * Desativa a animaÃ§Ã£o de pulsar em um botÃ£o
     * @param {HTMLElement|string} botao - Elemento do botÃ£o ou ID do botÃ£o
     */
    function desativarPulseBotao(botao) {
      const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
      if (elemento) {
        elemento.classList.remove('btn-pulse-active');
      }
    }
    
    // Restaura estado ao carregar pÃ¡gina (se havia notificaÃ§Ã£o pendente)
    (function restoreNotificationState() {
      try {
        const hasFlag = localStorage.getItem('naam_new_notif_flag') === '1';
        if (hasFlag) {
          NotificationManager.hasStoredNotif = true;
          // Mostra alerta apÃ³s DOM estar pronto
          setTimeout(() => {
            NotificationManager.showAlert();
          }, 100);
        }
      } catch (e) {
        console.warn('[NotifManager] Erro ao restaurar estado:', e);
      }
    })();
    
    // ===== WRAPPER COMPATÃVEL COM CÃ“DIGO ANTIGO =====
    function showAlertaNovasNotificacoes(count, deveAguardarToast = false) {
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');
      let alerta = document.getElementById('alerta-novas-notificacoes');

      // Determina contagem de novas notificaÃ§Ãµes, se fornecida ou salva globalmente
      let totalNovas = null;
      if (typeof count === 'number' && count > 0) {
        totalNovas = count;
      } else if (typeof count === 'string') {
        const parsed = parseInt(count, 10);
        if (!isNaN(parsed) && parsed > 0) {
          totalNovas = parsed;
        }
      }
      // Se nÃ£o veio via parÃ¢metro, tenta ler do localStorage (contador global)
      if (totalNovas === null) {
        try {
          const stored = localStorage.getItem('naam_new_notif_count');
          if (stored) {
            const parsed = parseInt(stored, 10);
            if (!isNaN(parsed) && parsed > 0) {
              totalNovas = parsed;
            }
          }
        } catch (e) {
          console.warn('[Alerta Painel] âš ï¸ Erro ao ler contador global de novas notificaÃ§Ãµes:', e);
        }
      }

      function aplicarTextoEContador() {
        if (!alerta) return;
        const titulo = alerta.querySelector('span.font-semibold');
        const descricao = alerta.querySelector('span.text-sm');

        if (titulo) {
          if (totalNovas === 1) {
            titulo.textContent = 'Existe 1 nova notificaÃ§Ã£o!';
          } else if (typeof totalNovas === 'number' && totalNovas > 1) {
            titulo.textContent = `Existem ${totalNovas} novas notificaÃ§Ãµes!`;
          } else {
            // fallback quando nÃ£o sabemos o nÃºmero exato
            titulo.textContent = 'Existem novas notificaÃ§Ãµes!';
          }
        }

        if (descricao) {
          // MantÃ©m o texto padrÃ£o do painel
          descricao.textContent = 'Clique em Atualizar Dados para recarregar.';
        }
      }

      function atualizarBadges() {
        const valorBadge = totalNovas != null ? String(totalNovas) : '!';
        if (badgeDesktop) {
          badgeDesktop.textContent = valorBadge;
          badgeDesktop.classList.remove('hidden');
        }
        if (badgeMobile) {
          badgeMobile.textContent = valorBadge;
          badgeMobile.classList.remove('hidden');
        }
      }

      // Bloqueio global: se atualizaÃ§Ã£o foi iniciada via popup azul,
      // nÃ£o exibir quaisquer alertas/badges e remover o alerta do DOM
      if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
        if (alerta) alerta.remove();
        if (badgeDesktop) badgeDesktop.classList.add('hidden');
        if (badgeMobile) badgeMobile.classList.add('hidden');
        console.log('[Alerta Painel] ğŸš« Bloqueado por atualizaÃ§Ã£o via popup; alerta removido do DOM');
        return;
      }
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO: Se popup foi fechado sem atualizar (em qualquer pÃ¡gina),
      // forÃ§a mostrar alerta vermelho e animaÃ§Ã£o
      const estado = lerEstadoSincronizacao();
      if (estado && estado.popupFechadoSemAtualizar && !estado.popupAtualizado) {
        const ultimoIdSincronizado = localStorage.getItem(SYNC_LAST_NOTIF_ID_KEY);
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
        
        // Se ainda hÃ¡ notificaÃ§Ã£o pendente
        if (!ultimoIdSincronizado || ultimoIdSalvo !== ultimoIdSincronizado) {
          console.log('[Alerta Painel] âœ… Popup foi fechado sem atualizar. FORÃ‡ANDO exibiÃ§Ã£o do alerta vermelho...');
          
          // Reseta estado da state machine
          if (typeof NotificationManager !== 'undefined') {
            NotificationManager.setState('idle');
            NotificationManager.hasStoredNotif = false;
          }
          
          // Garante que o elemento do alerta exista
          if (!alerta) {
            console.warn('[Alerta Painel] âš ï¸ Elemento #alerta-novas-notificacoes nÃ£o encontrado. Recriando alerta no DOM...');
            alerta = document.createElement('div');
            alerta.id = 'alerta-novas-notificacoes';
            alerta.className = 'alerta-novas-notificacoes mb-4';
            alerta.innerHTML = `
              <div class="flex items-center gap-3">
                <span class="text-lg">ğŸ””</span>
                <div class="flex flex-col">
                  <span class="font-semibold">Existem novas notificaÃ§Ãµes!</span>
                  <span class="text-sm text-rose-700">Clique em Atualizar Dados para recarregar.</span>
                </div>
              </div>
            `;
            
            // Insere o alerta logo acima do cabeÃ§alho
            const header = document.querySelector('.bg-white.rounded-2xl.shadow-xl.p-6.mb-6');
            if (header && header.parentElement) {
              header.parentElement.insertBefore(alerta, header);
            } else {
              document.body.insertBefore(alerta, document.body.firstChild);
            }
          }
          
          // ForÃ§a mostrar o alerta vermelho
          alerta.style.display = 'flex';
          void alerta.offsetWidth; // ForÃ§a reflow
          alerta.classList.remove('hide');
          alerta.classList.add('show');
          console.log('[Alerta Painel] âœ… Alerta vermelho FORÃ‡ADO a aparecer');

          // Atualiza textos e contador no prÃ³prio alerta
          aplicarTextoEContador();
          
          // ForÃ§a ativar animaÃ§Ã£o de pulsar no botÃ£o
          ativarPulseBotao('btnAtualizar');
          console.log('[Alerta Painel] âœ… AnimaÃ§Ã£o de pulsar FORÃ‡ADA no botÃ£o Atualizar Dados');
          
          // Atualiza badges (se ainda existirem no DOM)
          atualizarBadges();
          
          return;
        }
      }
      
      // Atualiza texto/contador no alerta com base na contagem (quando existir)
      if (alerta) {
        aplicarTextoEContador();
      }
      
      if (deveAguardarToast) {
        // Marca como pendente, mas NÃƒO mostra
        NotificationManager.hasStoredNotif = true;
        atualizarBadges();
        return;
      }
      
      // Tenta mostrar alerta via state machine
      const showed = NotificationManager.showAlert();
      if (showed) {
        atualizarBadges();
      }
    }
    
    function hideAlertaNovasNotificacoes(clearFlag = true) {
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');
      
      NotificationManager.startAlertExit();
      
      if (badgeDesktop) badgeDesktop.classList.add('hidden');
      if (badgeMobile) badgeMobile.classList.add('hidden');
      
      if (!clearFlag) {
        NotificationManager.hasStoredNotif = true; // MantÃ©m pendente
      }
    }
    
    function handleVerNotificacoesCTA() {
      hideAlertaNovasNotificacoes(true);
      window.location.href = 'minhas-notificacoes.html';
    }

    async function carregarContadorNotificacoes() {
      try {
        const email = localStorage.getItem('userEmail');
        if (!email) return;
        
        const url = window.CONFIG.APPS_SCRIPT_CASOS;
        const dados = {
          action: 'contarNaoLidas',
          emailUsuario: email
        };
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'data=' + encodeURIComponent(JSON.stringify(dados))
        });
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.count > 0) {
          const badgeDesktop = document.getElementById('badge-notif-desktop');
          const badgeMobile = document.getElementById('badge-notif-mobile');
          
          if (badgeDesktop) {
            badgeDesktop.textContent = resultado.count;
            badgeDesktop.classList.remove('hidden');
          }
          
          if (badgeMobile) {
            badgeMobile.textContent = resultado.count;
            badgeMobile.classList.remove('hidden');
          }

          showAlertaNovasNotificacoes(resultado.count);
        } else {
          // NÃ£o esconda se existe flag pendente; apenas limpa visuais quando usuÃ¡rio limpar flag
          hideAlertaNovasNotificacoes(false);
        }
      } catch (error) {
        console.error('Erro ao carregar contador de notificaÃ§Ãµes:', error);
      }
    }

    // ========================================
    // FUNÃ‡ÃƒO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // Chama verificaÃ§Ãµes ao carregar
    verificarAutenticacao();
    verificarMenuAdmin();
    
    // âœ¨ SINCRONIZAÃ‡ÃƒO: Verifica estado sincronizado na inicializaÃ§Ã£o
    // Se popup foi fechado sem atualizar em outra pÃ¡gina, mostra alerta vermelho
    setTimeout(() => {
      if (typeof verificarEstadoSincronizadoNaInicializacao === 'function') {
        verificarEstadoSincronizadoNaInicializacao();
      }
    }, 1500);
    
    // ========================================
    // SISTEMA DE DETECÃ‡ÃƒO AUTOMÃTICA DE MUDANÃ‡AS
    // ========================================
    // Inicializa o sistema de detecÃ§Ã£o de mudanÃ§as apÃ³s carregar os dados
    // Usa a mesma lÃ³gica que funcionou no teste manual
    if (window.ChangeDetector && window.DataCache && window.UpdateNotification) {
      // Aguarda os dados serem carregados primeiro
      setTimeout(() => {
        const url = window.CONFIG.APPS_SCRIPT_CASOS;
        const cacheKey = 'painel_casos';
        const pollingInterval = window.CONFIG ? (window.CONFIG.POLLING_INTERVAL || 45000) : 45000;
        
        console.log('ğŸ”„ [Painel Casos] Iniciando sistema de detecÃ§Ã£o automÃ¡tica de mudanÃ§as...');
        console.log('   â€¢ Intervalo: ' + (pollingInterval / 1000) + ' segundos');
        console.log('   â€¢ Cache key: ' + cacheKey);
        console.log('   â€¢ URL: ' + url);
        
        // Configura callback para recarregar dados quando usuÃ¡rio clicar em "Atualizar Agora"
        if (window.UpdateNotification) {
          window.UpdateNotification.onUpdate(() => {
            console.log('[Painel Casos] UsuÃ¡rio solicitou atualizaÃ§Ã£o - recarregando dados...');
            // Recarrega os dados quando usuÃ¡rio clicar em "Atualizar Agora"
            if (typeof carregarDadosPlanilha === 'function') {
              carregarDadosPlanilha();
            } else {
              location.reload();
            }
          });
        }
        
        // Inicia verificaÃ§Ã£o periÃ³dica usando a mesma lÃ³gica do teste manual
        // Chama checkForChanges diretamente com cacheKey e URL
        let pollingActive = true;
        let pollingIntervalId = null;
        let verificationCount = 0;
        
        // FunÃ§Ã£o para executar uma verificaÃ§Ã£o
        const executeCheck = async () => {
          // Pausa quando a pÃ¡gina estÃ¡ oculta
          if (document.hidden || !pollingActive) {
            console.log('[Painel Casos] â¸ï¸ VerificaÃ§Ã£o pausada (pÃ¡gina oculta ou polling inativo)');
            return;
          }
          
          verificationCount++;
          const checkTime = new Date().toLocaleTimeString();
          console.log(`[Painel Casos] ğŸ” VerificaÃ§Ã£o #${verificationCount} iniciada Ã s ${checkTime}`);
          
          try {
            // Usa a mesma lÃ³gica do teste manual que funcionou
            // O checkForChanges jÃ¡ dispara o evento 'dataChanged' se detectar mudanÃ§as
            const hasChanges = await window.ChangeDetector.checkForChanges(cacheKey, url);
            
            if (hasChanges) {
              console.log('[Painel Casos] âœ… MudanÃ§as detectadas na verificaÃ§Ã£o #' + verificationCount);
              showAlertaNovasNotificacoes();
            } else {
              console.log('[Painel Casos] âœ“ Nenhuma mudanÃ§a detectada na verificaÃ§Ã£o #' + verificationCount);
            }
          } catch (error) {
            console.error('[Painel Casos] âŒ Erro na verificaÃ§Ã£o periÃ³dica #' + verificationCount + ':', error);
            // NÃ£o para o polling mesmo se houver erro
          }
        };
        
        // FunÃ§Ã£o para iniciar o polling
        const startPolling = () => {
          // Limpa intervalo anterior se existir
          if (pollingIntervalId) {
            clearInterval(pollingIntervalId);
            pollingIntervalId = null;
          }
          
          console.log('[Painel Casos] ğŸš€ Iniciando polling contÃ­nuo...');
          
          // Executa primeira verificaÃ§Ã£o imediatamente
          executeCheck();
          
          // Configura intervalo para verificaÃ§Ãµes periÃ³dicas
          pollingIntervalId = setInterval(() => {
            executeCheck();
          }, pollingInterval);
          
          // Armazena o ID do intervalo para poder parar depois se necessÃ¡rio
          window._painelCasosPollingInterval = pollingIntervalId;
          
          console.log('[Painel Casos] âœ… Polling iniciado com sucesso!');
          console.log(`   â€¢ Intervalo: ${pollingInterval / 1000} segundos`);
          console.log(`   â€¢ PrÃ³xima verificaÃ§Ã£o em: ${pollingInterval / 1000} segundos`);
        };
        
        // Inicia o polling
        startPolling();
        
    // ========================================
    // SISTEMA SIMPLIFICADO DE VERIFICAÃ‡ÃƒO POR ID
    // ========================================
    // Verifica novas notificaÃ§Ãµes comparando apenas IDs numÃ©ricos
    let ultimoIdSalvo = null;
    let intervaloVerificacaoId = null;
    const STORAGE_KEY_ULTIMO_ID = 'naam_ultimo_id_notificacao';
    
    /**
     * Carrega Ãºltimo ID salvo do localStorage
     */
    function carregarUltimoIdSalvo() {
      try {
        const salvo = localStorage.getItem(STORAGE_KEY_ULTIMO_ID);
        if (salvo !== null && salvo !== undefined && salvo !== '') {
          const id = Number(salvo);
          if (!isNaN(id)) {
            ultimoIdSalvo = id;
            console.log('[Cache/NotificaÃ§Ãµes] âœ… ID carregado do cache:', ultimoIdSalvo);
            return id;
          }
        }
      } catch (error) {
        console.warn('[Cache/NotificaÃ§Ãµes] Erro ao carregar ID do cache:', error);
      }
      return null;
    }
    
    /**
     * Salva Ãºltimo ID no localStorage
     */
    function salvarUltimoId(id) {
      try {
        if (id !== null && id !== undefined) {
          localStorage.setItem(STORAGE_KEY_ULTIMO_ID, String(id));
          ultimoIdSalvo = id;
          console.log('[Cache/NotificaÃ§Ãµes] ğŸ’¾ ID salvo no cache:', id);
        }
      } catch (error) {
        console.warn('[Cache/NotificaÃ§Ãµes] Erro ao salvar ID no cache:', error);
      }
    }
    
    /**
     * Limpa Ãºltimo ID salvo do localStorage
     */
    function limparUltimoIdSalvo() {
      try {
        localStorage.removeItem(STORAGE_KEY_ULTIMO_ID);
        ultimoIdSalvo = null;
        console.log('[Cache/NotificaÃ§Ãµes] ğŸ§¹ ID removido do cache');
      } catch (error) {
        console.warn('[Cache/NotificaÃ§Ãµes] Erro ao limpar ID do cache:', error);
      }
    }
    
    /**
     * FunÃ§Ã£o 1: Buscar Ãºltimo ID da planilha
     */
    async function buscarUltimoId() {
      try {
        if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
          console.warn('[VerificaÃ§Ã£o ID] API nÃ£o disponÃ­vel');
          return null;
        }
        
        const resultado = await window.API.request(window.CONFIG.APPS_SCRIPT_CASOS, {
          action: 'getLastNotificationId'
        });
        
        if (resultado.success && resultado.lastId !== null && resultado.lastId !== undefined) {
          return Number(resultado.lastId);
        }
        
        return null;
      } catch (error) {
        console.error('[VerificaÃ§Ã£o ID] Erro ao buscar Ãºltimo ID:', error);
        return null;
      }
    }
    
    /**
     * FunÃ§Ã£o 2: VerificaÃ§Ã£o contÃ­nua de mudanÃ§as
     */
    async function verificarMudancasPorId() {
      try {
        // Chama FunÃ§Ã£o 1 para obter Ãºltimo ID da planilha
        const ultimoIdPlanilha = await buscarUltimoId();
        
        if (ultimoIdPlanilha === null) {
          console.log('[VerificaÃ§Ã£o ID] NÃ£o foi possÃ­vel obter ID da planilha');
          return;
        }
        
        // ComparaÃ§Ã£o: ultimoIdPlanilha vs ultimoIdSalvo
        if (ultimoIdSalvo === null) {
          // Primeira execuÃ§Ã£o: apenas salva o ID
          salvarUltimoId(ultimoIdPlanilha);
          console.log('[VerificaÃ§Ã£o ID] ID inicial salvo:', ultimoIdSalvo);
          return;
        }
        
        // ComparaÃ§Ã£o numÃ©rica estrita
        if (ultimoIdPlanilha === ultimoIdSalvo) {
          // IDs iguais â†’ nÃ£o hÃ¡ nova notificaÃ§Ã£o
          console.log('[VerificaÃ§Ã£o ID] Nenhuma mudanÃ§a detectada (ID:', ultimoIdPlanilha + ')');
          return;
        }
        
        // IDs diferentes â†’ hÃ¡ nova notificaÃ§Ã£o
        console.log('[VerificaÃ§Ã£o ID] ğŸ”” NOVA NOTIFICAÃ‡ÃƒO DETECTADA!');
        console.log('  â€¢ ID anterior:', ultimoIdSalvo);
        console.log('  â€¢ ID atual:', ultimoIdPlanilha);
        
        // Calcula uma contagem aproximada de novas notificaÃ§Ãµes
        let diff = null;
        if (typeof ultimoIdSalvo === 'number' && !isNaN(ultimoIdSalvo)) {
          diff = ultimoIdPlanilha - ultimoIdSalvo;
        }
        let countNovas = 1;
        if (diff !== null && diff > 0) {
          countNovas = diff;
        }
        console.log('[VerificaÃ§Ã£o ID] ğŸ§® Contagem estimada de novas notificaÃ§Ãµes:', countNovas);
        try {
          localStorage.setItem('naam_new_notif_count', String(countNovas));
        } catch (e) {
          console.warn('[VerificaÃ§Ã£o ID] âš ï¸ Erro ao salvar contador de novas notificaÃ§Ãµes:', e);
        }
        
        // Notificar sistema (popup azul + alerta, que lerÃ£o o contador)
        mostrarNotificacaoNovaNotificacao(countNovas);
        
        // Atualizar ultimoIdSalvo e salvar no cache
        salvarUltimoId(ultimoIdPlanilha);
        console.log('[VerificaÃ§Ã£o ID] ID atualizado para:', ultimoIdSalvo);
        
      } catch (error) {
        console.error('[VerificaÃ§Ã£o ID] Erro na verificaÃ§Ã£o:', error);
      }
    }
    
    /**
     * Atualiza cache de notificaÃ§Ãµes sem recarregar a pÃ¡gina
     */
    // Dispara atualizaÃ§Ã£o via popup azul com bloqueio de alertas
    function atualizarViaPopupNotificacao() {
      console.log('[Popup Azul Painel] â–¶ï¸ AtualizaÃ§Ã£o iniciada pelo usuÃ¡rio');
      // Seta flag global para bloquear qualquer alerta/contadores/animaÃ§Ãµes neste ciclo
      window.atualizacaoDisparadaPeloUsuario = true;
      window.atualizacaoIniciadaViaPopup = true;
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO: Marca que popup foi atualizado
      const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
      const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
      if (typeof marcarPopupAzulAtualizado === 'function') {
        marcarPopupAzulAtualizado(notifId);
      }
      try {
        localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
          state: true,
          timestamp: Date.now(),
          source: 'popup-azul-painel'
        }));
      } catch (e) {
        console.warn('[Popup Azul Painel] âš ï¸ Falha ao persistir estado global:', e);
      }

      // Remove imediatamente qualquer alerta persistente do DOM
      const alerta = document.getElementById('alerta-novas-notificacoes');
      if (alerta) alerta.remove();

      // Garante remoÃ§Ã£o de animaÃ§Ã£o do botÃ£o principal de atualizar
      desativarPulseBotao('btnAtualizar');

      // Executa o fluxo padrÃ£o de atualizaÃ§Ã£o (cache + recarregar)
      if (typeof atualizarCacheNotificacoes === 'function') {
        atualizarCacheNotificacoes();
      } else {
        // Fallback: remove toast e dÃ¡ reload
        const notificacao = document.getElementById('notificacao-nova-notificacao');
        if (notificacao) notificacao.remove();
        location.reload();
      }
    }

    function atualizarCacheNotificacoes() {
      console.log('[NotificaÃ§Ã£o] ğŸ”„ Atualizando cache de notificaÃ§Ãµes...');
      
      // Remove a notificaÃ§Ã£o visual com animaÃ§Ã£o de saÃ­da
      const notificacao = document.getElementById('notificacao-nova-notificacao');
      if (notificacao) {
        notificacao.classList.remove('notificacao-visible');
        notificacao.classList.add('notificacao-exit');
        setTimeout(() => {
          notificacao.remove();
        }, 400);
      }
      
      // Limpa cache de registros e atualiza ID
      limparCacheERecarregarNotificacoes();
      hideAlertaNovasNotificacoes(true);
      
      // Recarrega os dados da planilha sem recarregar a pÃ¡gina
      if (typeof carregarDadosPlanilha === 'function') {
        carregarDadosPlanilha();
        console.log('[NotificaÃ§Ã£o] âœ… Cache atualizado e dados recarregados');
        
        // âœ¨ SINCRONIZAÃ‡ÃƒO: ApÃ³s atualizaÃ§Ã£o bem-sucedida, atualiza Ãºltimo ID sincronizado
        // Aguarda um pouco para garantir que o ID foi atualizado
        setTimeout(() => {
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          if (ultimoIdSalvo && typeof marcarPopupAzulAtualizado === 'function') {
            const notifId = parseInt(ultimoIdSalvo, 10);
            // Atualiza o Ãºltimo ID sincronizado para refletir que esta notificaÃ§Ã£o foi processada
            try {
              localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
              console.log('[Sync] âœ… Ãšltimo ID sincronizado atualizado apÃ³s atualizaÃ§Ã£o:', notifId);
            } catch (e) {
              console.warn('[Sync] âš ï¸ Erro ao atualizar Ãºltimo ID sincronizado:', e);
            }
          }
        }, 2000);
      } else {
        console.warn('[NotificaÃ§Ã£o] âš ï¸ FunÃ§Ã£o carregarDadosPlanilha nÃ£o disponÃ­vel');
      }
    }
    
    /**
     * Atualiza o contador no alerta vermelho com animaÃ§Ã£o de shake e incrementa o valor
     * @param {number} countNovas - Quantidade de novas notificaÃ§Ãµes a adicionar
     */
    function atualizarContadorAlertaVermelhoComShake(countNovas) {
      const alerta = document.getElementById('alerta-novas-notificacoes');
      if (!alerta) return;
      
      // Verifica se o alerta estÃ¡ visÃ­vel
      const estaVisivel = alerta.classList.contains('show') || 
                          alerta.style.display === 'flex' ||
                          (alerta.offsetParent !== null && alerta.style.display !== 'none');
      
      if (!estaVisivel) return;
      
      const titulo = alerta.querySelector('span.font-semibold');
      if (!titulo) return;
      
      // Extrai o nÃºmero atual do texto do tÃ­tulo
      let contadorAtual = 0;
      const textoAtual = titulo.textContent;
      const match = textoAtual.match(/(\d+)/);
      if (match) {
        contadorAtual = parseInt(match[1], 10);
      } else if (textoAtual.includes('Existe 1 nova')) {
        contadorAtual = 1;
      } else if (textoAtual.includes('Existem novas')) {
        // Se nÃ£o tem nÃºmero, tenta ler do localStorage
        try {
          const stored = localStorage.getItem('naam_new_notif_count');
          if (stored) {
            contadorAtual = parseInt(stored, 10) || 0;
          }
        } catch (e) {
          console.warn('[Contador] âš ï¸ Erro ao ler contador:', e);
        }
      }
      
      // Incrementa o contador
      const novoTotal = contadorAtual + (countNovas || 1);
      
      // Atualiza o localStorage global
      try {
        localStorage.setItem('naam_new_notif_count', String(novoTotal));
      } catch (e) {
        console.warn('[Contador] âš ï¸ Erro ao salvar contador:', e);
      }
      
      // Atualiza o texto do tÃ­tulo
      if (novoTotal === 1) {
        titulo.textContent = 'Existe 1 nova notificaÃ§Ã£o!';
      } else {
        titulo.textContent = `Existem ${novoTotal} novas notificaÃ§Ãµes!`;
      }
      
      // Aplica animaÃ§Ã£o de shake no tÃ­tulo
      titulo.classList.add('contador-shake');
      setTimeout(() => {
        titulo.classList.remove('contador-shake');
      }, 500);
      
      // Atualiza badges se existirem
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');
      if (badgeDesktop) {
        badgeDesktop.textContent = String(novoTotal);
        badgeDesktop.classList.remove('hidden');
      }
      if (badgeMobile) {
        badgeMobile.textContent = String(novoTotal);
        badgeMobile.classList.remove('hidden');
      }
      
      console.log('[Contador] âœ… Contador atualizado com shake:', contadorAtual, 'â†’', novoTotal);
    }
    
    /**
     * Mostra notificaÃ§Ã£o visual elegante e compacta de nova notificaÃ§Ã£o
     */
    function mostrarNotificacaoNovaNotificacao(count) {
      // Verifica se o alerta vermelho jÃ¡ estÃ¡ visÃ­vel
      const alertaVermelho = document.getElementById('alerta-novas-notificacoes');
      const alertaEstaVisivel = alertaVermelho && (
        alertaVermelho.classList.contains('show') || 
        alertaVermelho.style.display === 'flex' ||
        (alertaVermelho.offsetParent !== null && alertaVermelho.style.display !== 'none')
      );
      
      // Se o alerta vermelho jÃ¡ estÃ¡ visÃ­vel, apenas atualiza o contador com shake
      if (alertaEstaVisivel) {
        console.log('[Popup Azul] âš ï¸ Alerta vermelho jÃ¡ estÃ¡ visÃ­vel. Atualizando contador com shake em vez de mostrar popup azul.');
        atualizarContadorAlertaVermelhoComShake(count || 1);
        return; // NÃ£o cria o popup azul
      }
      
      // Remove notificaÃ§Ã£o anterior se existir
      const notificacaoAnterior = document.getElementById('notificacao-nova-notificacao');
      if (notificacaoAnterior) {
        notificacaoAnterior.remove();
      }
      // Marca a flag mas nÃ£o mostra alerta ainda (aguardarÃ¡ saÃ­da do toast)
      // Passa a contagem (se fornecida) para o alerta vermelho
      showAlertaNovasNotificacoes(typeof count === 'number' ? count : null, true);
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO: Marca que popup azul estÃ¡ ativo
      const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
      const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
      if (typeof marcarPopupAzulAtivo === 'function') {
        marcarPopupAzulAtivo(notifId);
      }
      
      // Cria container principal
      const notificacao = document.createElement('div');
      notificacao.id = 'notificacao-nova-notificacao';
      notificacao.className = 'notificacao-nova-elegante';
      
      // HTML da notificaÃ§Ã£o harmÃ´nica e integrada
      notificacao.innerHTML = `
        <div class="notificacao-conteudo">
          <div class="notificacao-icone-container">
            <svg class="notificacao-icone" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="notificacao-texto">
            <div class="notificacao-titulo">
              <span class="notificacao-badge">NOVO</span>
              <span class="notificacao-mensagem-principal">Nova NotificaÃ§Ã£o Recebida</span>
            </div>
            <div class="notificacao-descricao">
              Banco de dados recebeu nova notificaÃ§Ã£o
            </div>
            <div class="notificacao-acoes">
              <button class="notificacao-btn-atualizar" onclick="if (typeof atualizarViaPopupNotificacao === 'function') { atualizarViaPopupNotificacao(); } else { this.closest('.notificacao-nova-elegante').remove(); location.reload(); }">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Atualizar
              </button>
              <button class="notificacao-btn-fechar" onclick="fecharNotificacaoToast(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="notificacao-progresso"></div>
      `;
      
      document.body.appendChild(notificacao);
      
      // AnimaÃ§Ã£o de entrada
      setTimeout(() => {
        notificacao.classList.add('notificacao-visible');
      }, 10);
      
      // Barra de progresso (15 segundos) - apenas visual, nÃ£o fecha mais sozinha
      const progresso = notificacao.querySelector('.notificacao-progresso');
      if (progresso) {
        progresso.style.animation = 'notificacaoProgresso 15s linear forwards';
      }
      
      // Removido o fechamento automÃ¡tico em 15s.
      // Este popup azul sÃ³ sai quando:
      // - UsuÃ¡rio clicar em "Atualizar" (atualiza os dados), ou
      // - UsuÃ¡rio clicar no "X" (fecha e forÃ§a o alerta vermelho).
    }
    
    /**
     * FunÃ§Ã£o para fechar a notificaÃ§Ã£o toast manualmente
     */
    function fecharNotificacaoToast(botao) {
      const notificacao = botao.closest('.notificacao-nova-elegante');
      if (notificacao) {
        // âœ¨ SINCRONIZAÃ‡ÃƒO: Marca que popup foi fechado sem atualizar
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
        const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
        if (typeof marcarPopupAzulFechadoSemAtualizar === 'function') {
          marcarPopupAzulFechadoSemAtualizar(notifId);
        }
        
        notificacao.classList.remove('notificacao-visible');
        notificacao.classList.add('notificacao-exit');
        
        // Remove do DOM apÃ³s animaÃ§Ã£o
        setTimeout(() => {
          notificacao.remove();
          // Mostra o alerta persistente apÃ³s fechar o toast
          if (typeof showAlertaNovasNotificacoes === 'function') {
            showAlertaNovasNotificacoes();
          }
        }, 400);
      }
    }

    // Torna a funÃ§Ã£o acessÃ­vel globalmente para o onclick inline
    if (typeof window !== 'undefined') {
      window.fecharNotificacaoToast = fecharNotificacaoToast;
    }
    
    /**
     * Limpa cache e recarrega notificaÃ§Ãµes
     * NOTA: NÃ£o limpa o Ãºltimo ID salvo, apenas atualiza para o ID atual da planilha
     */
    function limparCacheERecarregarNotificacoes() {
      console.log('[Cache/NotificaÃ§Ãµes] ğŸ§¹ Limpando cache de registros...');
      
      // Limpa cache de registros (mas mantÃ©m o ID de notificaÃ§Ã£o)
      if (window.DataCache) {
        window.DataCache.clear('gerenciar_casos');
        window.DataCache.clearAll(); // Limpa todos os caches para garantir
        console.log('[Cache/NotificaÃ§Ãµes] âœ… Cache limpo');
      }
      
      // âœ¨ SINCRONIZAÃ‡ÃƒO ENTRE PÃGINAS: Notifica outras pÃ¡ginas abertas
      try {
        const invalidationEvent = {
          type: 'cache_invalidation',
          timestamp: Date.now(),
          source: 'painel-casos',
          cacheKey: 'gerenciar_casos'
        };
        localStorage.setItem('naam_cache_invalidation', JSON.stringify(invalidationEvent));
        console.log('[Cache/NotificaÃ§Ãµes] ğŸ“¡ Evento de invalidaÃ§Ã£o enviado para outras pÃ¡ginas');
        console.log('[Painel] âœ… Solicitei atualizaÃ§Ã£o da aba "Gerenciar Registros" (cache "gerenciar_casos" invalidado e sincronizaÃ§Ã£o disparada)');
      } catch (e) {
        console.warn('[Cache/NotificaÃ§Ãµes] âš ï¸ Erro ao enviar evento de invalidaÃ§Ã£o:', e);
      }
      
      // Atualiza o Ãºltimo ID salvo com o ID atual da planilha (sem resetar)
      if (window.API && window.CONFIG && window.CONFIG.APPS_SCRIPT_CASOS) {
        buscarUltimoId().then(id => {
          if (id !== null) {
            salvarUltimoId(id);
            console.log('[Cache/NotificaÃ§Ãµes] âœ… ID atualizado para:', ultimoIdSalvo);
            
            // âœ¨ SINCRONIZAÃ‡ÃƒO: SÃ³ atualiza Ãºltimo ID sincronizado se for aÃ§Ã£o do usuÃ¡rio
            // (nÃ£o atualiza se for chamada automaticamente)
            if (window._carregarDadosPlanilhaIsUserAction) {
              try {
                localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(id));
                console.log('[Sync] âœ… Ãšltimo ID sincronizado atualizado (aÃ§Ã£o do usuÃ¡rio):', id);
              } catch (e) {
                console.warn('[Sync] âš ï¸ Erro ao atualizar Ãºltimo ID sincronizado:', e);
              }
            }
          }
        });
      }
    }
    
    /**
     * Inicia o sistema de verificaÃ§Ã£o contÃ­nua
     */
    function iniciarVerificacaoPorId() {
      // Verifica se API e CONFIG estÃ£o disponÃ­veis
      if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
        console.warn('[VerificaÃ§Ã£o ID] â³ Aguardando carregamento da API...');
        // Tenta novamente apÃ³s 1 segundo
        setTimeout(iniciarVerificacaoPorId, 1000);
        return;
      }
      
      // Limpa intervalo anterior se existir
      if (intervaloVerificacaoId) {
        clearInterval(intervaloVerificacaoId);
      }
      
      console.log('[VerificaÃ§Ã£o ID] ğŸš€ Iniciando sistema de verificaÃ§Ã£o por ID...');
      console.log('[VerificaÃ§Ã£o ID] API disponÃ­vel:', !!window.API);
      console.log('[VerificaÃ§Ã£o ID] CONFIG disponÃ­vel:', !!window.CONFIG);
      console.log('[VerificaÃ§Ã£o ID] APPS_SCRIPT_CASOS:', window.CONFIG.APPS_SCRIPT_CASOS);
      
      // Carrega ID salvo do cache primeiro
      const idSalvo = carregarUltimoIdSalvo();
      
      // Se nÃ£o hÃ¡ ID salvo, busca da planilha
      if (idSalvo === null) {
        buscarUltimoId().then(id => {
          if (id !== null) {
            salvarUltimoId(id);
            console.log('[VerificaÃ§Ã£o ID] âœ… ID inicial obtido e salvo:', ultimoIdSalvo);
          } else {
            console.warn('[VerificaÃ§Ã£o ID] âš ï¸ NÃ£o foi possÃ­vel obter ID inicial, tentando novamente...');
          }
        });
      } else {
        console.log('[VerificaÃ§Ã£o ID] âœ… ID carregado do cache:', ultimoIdSalvo);
      }
      
      // Intervalo de verificaÃ§Ã£o: 10 segundos (pode ser configurado)
      const intervalo = 10000; // 10 segundos
      
      // Executa primeira verificaÃ§Ã£o apÃ³s 5 segundos
      setTimeout(() => {
        verificarMudancasPorId();
      }, 5000);
      
      // Configura verificaÃ§Ã£o contÃ­nua
      intervaloVerificacaoId = setInterval(() => {
        verificarMudancasPorId();
      }, intervalo);
      
      console.log('[VerificaÃ§Ã£o ID] âœ… Sistema iniciado! Verificando a cada', intervalo / 1000, 'segundos');
    }
    
    // Aguarda carregamento completo antes de iniciar
    function aguardarEIniciar() {
      // Verifica se tudo estÃ¡ carregado
      if (typeof window !== 'undefined' && 
          typeof window.CONFIG !== 'undefined' && 
          typeof window.API !== 'undefined' &&
          window.CONFIG.APPS_SCRIPT_CASOS) {
        iniciarVerificacaoPorId();
      } else {
        // Tenta novamente apÃ³s 500ms
        setTimeout(aguardarEIniciar, 500);
      }
    }
    
    // Inicia verificaÃ§Ã£o quando a pÃ¡gina carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Aguarda um pouco mais para garantir que todos os scripts carregaram
        setTimeout(aguardarEIniciar, 1000);
      });
    } else {
      // PÃ¡gina jÃ¡ carregou, aguarda scripts
      setTimeout(aguardarEIniciar, 1000);
    }
    
    // Pausa quando a pÃ¡gina fica oculta e retoma quando fica visÃ­vel
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
            console.log('[Painel Casos] ğŸ‘ï¸ PÃ¡gina oculta - pausando verificaÃ§Ã£o');
            pollingActive = false;
          } else {
            console.log('[Painel Casos] ğŸ‘ï¸ PÃ¡gina visÃ­vel - retomando verificaÃ§Ã£o');
            pollingActive = true;
            // Executa uma verificaÃ§Ã£o imediatamente quando a pÃ¡gina fica visÃ­vel
            executeCheck();
          }
        });
        
        // Monitora se o intervalo ainda estÃ¡ ativo (para debug)
        setInterval(() => {
          if (pollingIntervalId) {
            console.log(`[Painel Casos] ğŸ“Š Status: Polling ativo | VerificaÃ§Ãµes realizadas: ${verificationCount} | PrÃ³xima em: ${pollingInterval / 1000}s`);
          } else {
            console.warn('[Painel Casos] âš ï¸ ATENÃ‡ÃƒO: Polling parado! Reiniciando...');
            startPolling();
          }
        }, 60000); // Log de status a cada 1 minuto
        
        console.log('âœ… [Painel Casos] Sistema de detecÃ§Ã£o de mudanÃ§as iniciado e rodando continuamente');
        console.log('   ğŸ’¡ O sistema ficarÃ¡ monitorando mudanÃ§as automaticamente');
        console.log('   ğŸ’¡ Quando detectar uma mudanÃ§a, mostrarÃ¡ uma notificaÃ§Ã£o no canto da tela');
      }, 3000); // Aguarda 3 segundos para garantir que os dados foram carregados
    } else {
        console.warn('âš ï¸ [Painel Casos] ChangeDetector, DataCache ou UpdateNotification nÃ£o disponÃ­veis');
    }
    
  </script>
  
  <!-- Script para suprimir erros de extensÃµes do navegador -->
  <script>
    // Suprime erros de extensÃµes do navegador que nÃ£o sÃ£o do nosso cÃ³digo
    (function() {
      const originalError = console.error;
      const originalWarn = console.warn;
      
      // Lista de padrÃµes de erros de extensÃµes para ignorar
      const ignorePatterns = [
        'content.bundle.js',
        'products.json',
        'chrome-extension://',
        'moz-extension://',
        'safari-extension://',
        'edge-extension://',
        'Uncaught SyntaxError: "undefined" is not valid JSON',
        'Unexpected token \'<\''
      ];
      
      console.error = function(...args) {
        const message = args.join(' ');
        // Ignora erros de extensÃµes
        if (ignorePatterns.some(pattern => message.includes(pattern))) {
          return; // Suprime o erro
        }
        originalError.apply(console, args);
      };
      
      console.warn = function(...args) {
        const message = args.join(' ');
        // Ignora avisos de extensÃµes
        if (ignorePatterns.some(pattern => message.includes(pattern))) {
          return; // Suprime o aviso
        }
        originalWarn.apply(console, args);
      };
      
      // Trata erros nÃ£o capturados de extensÃµes (captura fase de captura)
      window.addEventListener('error', function(e) {
        try {
          const errorMessage = String(e.message || '');
          const errorSource = String(e.filename || e.source || '');
          const errorStack = String(e.error?.stack || '');
          
          // Ignora erros de extensÃµes
          if (ignorePatterns.some(pattern => 
            errorMessage.includes(pattern) || 
            errorSource.includes(pattern) ||
            errorStack.includes(pattern)
          )) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
          }
        } catch (err) {
          // Se houver erro ao processar, deixa passar
        }
      }, true);
      
      // Trata promessas rejeitadas de extensÃµes
      window.addEventListener('unhandledrejection', function(e) {
        try {
          const reason = String(e.reason || '');
          const reasonStack = String(e.reason?.stack || '');
          
          // Ignora rejeiÃ§Ãµes de extensÃµes
          if (ignorePatterns.some(pattern => 
            reason.includes(pattern) || reasonStack.includes(pattern)
          )) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        } catch (err) {
          // Se houver erro ao processar, deixa passar
        }
      });
    })();
  </script>

  <!-- ========================================
       MODAL DE DETALHES DO REGISTRO
       ======================================== -->
  <div id="modal-detalhes" class="modal-detalhes">
    <div class="modal-detalhes-conteudo">
      <div class="modal-detalhes-header flex items-center justify-between px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b border-gray-200 bg-gradient-to-r from-white to-blue-50/30">
        <div>
          <h2 class="modal-detalhes-titulo text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2 sm:gap-3">
            <span class="text-2xl sm:text-3xl">ğŸ§¾</span>
            <span id="modal-detalhes-titulo">Detalhes do Registro</span>
          </h2>
          <p class="modal-detalhes-subtitulo text-xs sm:text-sm text-gray-600 mt-1" id="modal-detalhes-subtitulo"></p>
        </div>
        <button class="modal-detalhes-close text-gray-400 hover:text-gray-600 text-3xl font-light transition-colors w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg hover:bg-gray-100" onclick="fecharModalDetalhes()" aria-label="Fechar">Ã—</button>
      </div>
      
      <div class="modal-detalhes-body" id="modal-detalhes-body"></div>
    </div>
  </div>
</body>

<script>
  (function() {
    const DURATION_OPEN = 360;
    const DURATION_CLOSE = 280;
    const easingOpen = "cubic-bezier(0.16, 1, 0.3, 1)";
    const easingClose = "cubic-bezier(0.4, 0, 0.2, 1)";

    const raf = () => new Promise((r) => requestAnimationFrame(r));

    function initAccordion(details) {
      const summary = details.querySelector("summary");
      const content = details.querySelector(".filter-group-content");
      if (!summary || !content) return;

      // MantÃ©m o conteÃºdo sempre mensurÃ¡vel para evitar travadas/altura 0.
      const initiallyOpen = details.hasAttribute("open");
      details.open = true;

      details.dataset.expanded = initiallyOpen ? "true" : "false";
      content.style.overflow = initiallyOpen ? "visible" : "hidden";
      content.style.height = initiallyOpen ? "" : "0px";

      let isAnimating = false;
      let animation = null;

      const cancelAnimation = () => {
        if (animation) {
          animation.cancel();
          animation = null;
        }
      };

      const animateHeight = (from, to, duration, easing) => {
        cancelAnimation();
        animation = content.animate(
          [
            { height: `${from}px`, opacity: 0.92 },
            { height: `${to}px`, opacity: 1 },
          ],
          { duration, easing }
        );
        return animation;
      };

      const expand = async () => {
        if (isAnimating) return;
        isAnimating = true;
        details.dataset.expanded = "true";
        content.style.overflow = "hidden";

        // Garantir que estamos com altura 0 antes de medir a altura final.
        content.style.height = content.getBoundingClientRect().height + "px";
        await raf();
        await raf();
        const startHeight = content.getBoundingClientRect().height;
        const endHeight = content.scrollHeight;
        content.style.height = `${startHeight}px`;

        const a = animateHeight(startHeight, endHeight, DURATION_OPEN, easingOpen);
        a.onfinish = () => {
          content.style.height = "";
          content.style.overflow = "visible";
          isAnimating = false;
          animation = null;
        };
        a.oncancel = () => {
          isAnimating = false;
        };
      };

      const collapse = async () => {
        if (isAnimating) return;
        isAnimating = true;
        content.style.overflow = "hidden";

        // Trava a altura atual para animar atÃ© zero.
        content.style.height = content.scrollHeight + "px";
        await raf();
        const startHeight = content.getBoundingClientRect().height;
        const endHeight = 0;

        const a = animateHeight(startHeight, endHeight, DURATION_CLOSE, easingClose);
        a.onfinish = () => {
          content.style.height = "0px";
          details.dataset.expanded = "false";
          content.style.overflow = "hidden";
          isAnimating = false;
          animation = null;
        };
        a.oncancel = () => {
          isAnimating = false;
        };
      };

      summary.addEventListener("click", (e) => {
        e.preventDefault();
        const expanded = details.dataset.expanded === "true";
        if (expanded) {
          void collapse();
        } else {
          void expand();
        }
      });
    }

    function boot() {
      document.querySelectorAll("details.filter-group").forEach(initAccordion);
      setupEscolaAutocomplete();
    }

    window.toggleAdvancedFilters = function toggleAdvancedFilters() {
      const box = document.getElementById('quickAdvancedFiltersBox');
      const ids = [
        'filterGroupPeriodo',
        'filterGroupContextoEscolar',
        'filterGroupAutoriaAgente',
        'filterGroupPerfilEstudante'
      ];
      const groups = ids.map((id) => document.getElementById(id)).filter(Boolean);
      if (!groups.length) return;

      const wasHidden = box ? box.classList.contains('hidden') : false;

      // Mostra a box; os grupos devem aparecer fechados (conteÃºdo colapsado).
      if (box) {
        box.classList.remove('hidden');
      }

      // Se a box acabou de ser aberta agora, garante que todos os grupos estejam fechados.
      if (wasHidden) {
        groups.forEach((details) => {
          const expanded = (details.dataset.expanded || 'false') === 'true';
          if (!expanded) return;
          const summary = details.querySelector('summary');
          if (summary) summary.click();
        });
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", boot);
    } else {
      boot();
    }
  })();
</script>

<script>
  (function() {
    const svgChevron = "<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='m6 9 6 6 6-6'/></svg>";

    function closeAll(except) {
      document.querySelectorAll('.select-shell[data-open="true"]').forEach((el) => {
        if (except && el === except) return;
        el.dataset.open = 'false';
        const menu = el.__menu;
        const trigger = el.__trigger;
        if (menu) menu.classList.remove('open');
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
        if (el.__followRAF) {
          cancelAnimationFrame(el.__followRAF);
          el.__followRAF = null;
        }
      });
    }

    function getOverlay() {
      const filtersSection = document.getElementById('filtersSection');
      if (!filtersSection) return null;

      let overlay = document.getElementById('selectOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'selectOverlay';
        filtersSection.appendChild(overlay);
      }
      return overlay;
    }

    function positionMenu(shell) {
      const menu = shell.__menu;
      const trigger = shell.__trigger;
      const overlay = shell.__overlay || getOverlay();
      if (!menu || !trigger || !overlay) return;
      shell.__overlay = overlay;

      const rect = trigger.getBoundingClientRect();
      const overlayRect = overlay.getBoundingClientRect();
      const gap = 8;

      const left = rect.left - overlayRect.left;
      const top = rect.bottom - overlayRect.top + gap;

      menu.style.left = `${Math.max(0, left)}px`;
      menu.style.top = `${Math.max(0, top)}px`;
      menu.style.width = `${Math.max(220, rect.width)}px`;
    }

    function startFollowing(shell) {
      if (shell.__followRAF) return;
      const tick = () => {
        if (shell.dataset.open !== 'true') {
          shell.__followRAF = null;
          return;
        }
        positionMenu(shell);
        shell.__followRAF = requestAnimationFrame(tick);
      };
      shell.__followRAF = requestAnimationFrame(tick);
    }

    function buildCustomSelect(select) {
      if (!select || select.dataset.customized === 'true') return;
      select.dataset.customized = 'true';

      const shell = document.createElement('div');
      shell.className = 'select-shell';
      shell.dataset.open = 'false';

      const trigger = document.createElement('button');
      trigger.type = 'button';
      trigger.className = 'select-trigger';
      trigger.setAttribute('aria-haspopup', 'listbox');
      trigger.setAttribute('aria-expanded', 'false');

      const label = document.createElement('span');
      label.style.whiteSpace = 'nowrap';
      label.style.overflow = 'hidden';
      label.style.textOverflow = 'ellipsis';

      const icon = document.createElement('span');
      icon.className = 'select-trigger-icon';
      icon.innerHTML = svgChevron;

      trigger.appendChild(label);
      trigger.appendChild(icon);

      const menu = document.createElement('div');
      menu.className = 'select-menu';
      menu.setAttribute('role', 'listbox');

      // Keep references on shell for portal/positioning.
      shell.__menu = menu;
      shell.__trigger = trigger;

      const updateLabel = () => {
        const opt = select.options[select.selectedIndex];
        label.textContent = opt ? opt.textContent : '';
      };

      const rebuildOptions = () => {
        menu.innerHTML = '';
        Array.from(select.options).forEach((opt) => {
          const item = document.createElement('div');
          item.className = 'select-option';
          item.setAttribute('role', 'option');
          item.dataset.value = opt.value;
          item.textContent = opt.textContent;
          item.setAttribute('aria-selected', opt.selected ? 'true' : 'false');

          item.addEventListener('click', () => {
            select.value = opt.value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
            updateLabel();
            rebuildOptions();
            const closeWithAnimation = () => {
              if (!menu.classList.contains('open')) {
                shell.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                return;
              }

              menu.classList.add('closing');
              menu.classList.remove('open');
              const onEnd = (ev) => {
                if (ev && ev.target !== menu) return;
                menu.removeEventListener('transitionend', onEnd);
                menu.classList.remove('closing');
                shell.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                if (shell.__followRAF) {
                  cancelAnimationFrame(shell.__followRAF);
                  shell.__followRAF = null;
                }
              };
              menu.addEventListener('transitionend', onEnd);
              setTimeout(() => onEnd({ target: menu }), 260);
            };
            closeWithAnimation();
          });

          menu.appendChild(item);
        });
      };

      updateLabel();
      rebuildOptions();

      select.classList.add('select-native');

      const parent = select.parentElement;
      if (!parent) return;
      parent.insertBefore(shell, select);
      shell.appendChild(trigger);
      // Portal menu to overlay inside filtersSection (container pai)
      const overlay = getOverlay();
      if (overlay) {
        shell.__overlay = overlay;
        overlay.appendChild(menu);
      } else {
        // fallback
        document.body.appendChild(menu);
      }
      shell.appendChild(select);

      trigger.addEventListener('click', () => {
        const isOpen = shell.dataset.open === 'true';
        if (isOpen) {
          shell.dataset.open = 'false';
          trigger.setAttribute('aria-expanded', 'false');
          menu.classList.remove('open');
          if (shell.__followRAF) {
            cancelAnimationFrame(shell.__followRAF);
            shell.__followRAF = null;
          }
          return;
        }
        closeAll(shell);
        shell.dataset.open = 'true';
        trigger.setAttribute('aria-expanded', 'true');
        rebuildOptions();
        menu.classList.add('open');
        // Double rAF garante layout estÃ¡vel antes de medir/posicionar
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            positionMenu(shell);
            startFollowing(shell);
          });
        });
      });

      select.addEventListener('change', () => {
        updateLabel();
        rebuildOptions();
      });
    }

    function boot() {
      document.querySelectorAll('select.select-elegant').forEach(buildCustomSelect);

      document.addEventListener('click', (e) => {
        const target = e.target;
        const shell = target && target.closest ? target.closest('.select-shell') : null;
        closeAll(shell);
      });

      window.addEventListener('resize', () => {
        document.querySelectorAll('.select-shell[data-open="true"]').forEach((shell) => positionMenu(shell));
      });

      window.addEventListener('scroll', () => {
        document.querySelectorAll('.select-shell[data-open="true"]').forEach((shell) => positionMenu(shell));
      }, { passive: true });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  })();
</script>
</html>
