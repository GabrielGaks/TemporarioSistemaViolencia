<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Registros - Viol√™ncia Escolar</title>
  
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Configura√ß√£o Centralizada -->
  <script src="config.js?v=2"></script>
  
  <!-- Valida√ß√£o do CONFIG -->
  <script>
    // Verifica se CONFIG foi carregado
    if (typeof CONFIG === 'undefined') {
      alert('‚ùå ERRO CR√çTICO: Arquivo config.js n√£o foi carregado!\n\nRecarregue a p√°gina com Ctrl+F5');
      throw new Error('CONFIG n√£o definido - config.js n√£o carregado');
    }
    console.log('‚úÖ CONFIG carregado com sucesso');
  </script>
  
  <style>
    .alert {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show > div {
      animation: fadeInScale 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0.5rem;
    }

    table {
      min-width: 1000px;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Autocomplete Styles */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background-color: #eff6ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    /* Radio Button Custom Animations */
    input[type="radio"].peer:checked ~ div {
      transform: scale(1.05);
      transition: all 0.2s ease-out;
    }
    
    input[type="radio"].peer ~ div {
      transition: all 0.2s ease-out;
    }
    
    /* ========================================
       ESTILOS DOS FILTROS (COPIADO DO PAINEL-CASOS.HTML)
       ======================================== */
    
    /* Cards de filtros clic√°veis */
    .filter-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 80px;
      display: flex;
      align-items: center;
    }
    
    .filter-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .filter-card:hover::before {
      left: 100%;
    }
    
    .filter-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }
    
    .filter-card.active {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .filter-card-icon {
      transition: transform 0.3s ease;
    }
    
    .filter-card:hover .filter-card-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .filter-card.active .filter-card-icon {
      transform: scale(1.15);
    }
    
    .badge-count {
      animation: badgePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes badgePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    /* Painel avan√ßado colaps√°vel */
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }
    
    .advanced-panel.open {
      max-height: 2000px;
      opacity: 1;
    }
    
    .filter-section.show {
      animation: slideDown 0.3s ease-out;
    }
    
    .toggle-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    
    /* Checkboxes personalizados elegantes */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }
    
    .custom-checkbox:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
    }
    
    .custom-checkbox:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      color: white;
      font-size: 12px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes checkPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    .checkbox-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      font-size: 0.875rem;
    }
    
    .checkbox-container:hover .checkbox-label {
      color: #1e40af;
    }
    
    .checkbox-container {
      transition: all 0.2s ease;
    }
    
    .checkbox-container:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    input[type="radio"].peer:active ~ div {
      transform: scale(0.98);
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }
      
      .desktop-menu {
        display: none !important;
      }
      
      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Tabela respons√≠vel */
    @media (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select, textarea {
        min-height: 44px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-50 min-h-screen font-sans antialiased">

  <div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
    
    <!-- Menu de Navega√ß√£o -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
      <div class="px-4 py-3">
        <!-- Bot√£o Hamburguer (Mobile) -->
        <button onclick="toggleMobileMenu()" class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
          <span class="text-lg">üì± Menu</span>
          <svg id="menuIcon" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <!-- Menu Desktop -->
        <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
          <a href="painel-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìä Painel de Casos
          </a>
          <a href="registro-novo-caso.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìù Novo Registro
          </a>
          <a href="gerenciar-casos.html" class="px-5 py-2.5 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all">
            üìã Gerenciar Registros
          </a>
          <a id="menuAdmin" href="gerenciar-usuarios.html" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üîß Painel Admin
          </a>
          <button id="btnSair" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
            üö™ Sair
          </button>
        </nav>
        
        <!-- Menu Mobile (Dropdown) -->
        <nav id="mobileMenuNav" class="mobile-menu mt-3">
          <div class="flex flex-col gap-2">
            <a href="painel-casos.html" class="px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üìä Painel de Casos
            </a>
            <a href="registro-novo-caso.html" class="px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üìù Novo Registro
            </a>
            <a href="gerenciar-casos.html" class="px-5 py-3 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all text-center">
              üìã Gerenciar Registros
            </a>
            <a id="menuAdminMobile" href="gerenciar-usuarios.html" class="hidden px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üîß Painel Admin
            </a>
            <button id="btnSairMobile" onclick="sair()" class="hidden px-5 py-3 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all text-center">
              üö™ Sair
            </button>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl shadow-xl border border-white/60 backdrop-blur-sm p-6 mb-6">
      <div class="flex items-center justify-center gap-4 mb-3">
        <div class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
          üìã
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
          Gerenciar Registros
        </h1>
      </div>
      <p class="text-center text-gray-600">
        Visualize, edite ou exclua registros existentes
      </p>
    </div>
    
    <!-- √Årea de Alertas -->
    <div id="alertContainer"></div>

    <!-- Controles: Carregar e Buscar -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 items-stretch lg:items-center justify-between">
            <!-- Bot√£o Carregar -->
            <div class="flex items-center gap-4">
              <button 
                id="btnCarregar" 
                onclick="carregarRegistros()"
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition shadow-md hover:shadow-lg flex items-center gap-2">
                <span>üîÑ</span>
                <span>Carregar Registros</span>
              </button>
              <div id="loadingInfo" class="text-gray-600 text-sm font-medium"></div>
            </div>
            <!-- Campo de Busca e Filtro -->
            <div class="flex-1 flex flex-col sm:flex-row gap-2 max-w-2xl items-center justify-end">
              <div class="relative w-full sm:w-auto flex-1">
                <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input 
                  type="text" 
                  id="campoBusca" 
                  placeholder="Buscar por nome da crian√ßa/estudante..."
                  onkeyup="filtrarTabela()"
                  class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
              </div>
              <div class="w-full sm:w-auto">
                <select id="filtroMembroFamiliar" onchange="filtrarTabela()" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                  <option value="todos">Todos: Membro Familiar?</option>
                  <option value="Sim">Sim</option>
                  <option value="N√£o">N√£o</option>
                  <option value="naoinformado">N√£o informado</option>
                </select>
              </div>
            </div>
      </div>
      <!-- Bot√£o para Expandir Filtros -->
      <div class="mt-4 flex gap-2">
        <button 
          onclick="toggleFiltrosAvancados()" 
          class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg font-semibold hover:from-indigo-600 hover:to-indigo-700 transition shadow-md hover:shadow-lg flex items-center gap-2">
          <span id="toggleFiltrosIcon">‚ñº</span>
          <span>Mais Filtros</span>
        </button>
      </div>
    </div>

    <!-- SE√á√ÉO DE FILTROS AVAN√áADOS (ESTRUTURA ID√äNTICA AO PAINEL-CASOS.HTML) -->
    <section id="filtrosAvancadosSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">üîç Filtros</h2>
      
      <!-- Cards de Filtros Clic√°veis -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">üéØ Filtros R√°pidos</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="regiao" onclick="openFilterSection('regiao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">üìç</span>
                <span class="text-sm font-medium text-gray-700">Regi√£o</span>
              </div>
              <span id="badge-regiao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="tipoViolencia" onclick="openFilterSection('tipoViolencia')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">‚ö†Ô∏è</span>
                <span class="text-sm font-medium text-gray-700">Tipo Viol√™ncia</span>
              </div>
              <span id="badge-tipoViolencia" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="tipoInstituicao" onclick="openFilterSection('tipoInstituicao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">üè´</span>
                <span class="text-sm font-medium text-gray-700">Tipo Institui√ß√£o</span>
              </div>
              <span id="badge-tipoInstituicao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="escola" onclick="openFilterSection('escola')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">üè¢</span>
                <span class="text-sm font-medium text-gray-700">Escola Espec√≠fica</span>
              </div>
              <span id="badge-escola" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="raca" onclick="openFilterSection('raca')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">üë•</span>
                <span class="text-sm font-medium text-gray-700">Ra√ßa/Cor</span>
              </div>
              <span id="badge-raca" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="genero" onclick="openFilterSection('genero')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">‚ößÔ∏è</span>
                <span class="text-sm font-medium text-gray-700">G√™nero (M/F)</span>
              </div>
              <span id="badge-genero" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Outros Filtros -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">

        <!-- Filtro: Foi um membro familiar? -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Foi um membro familiar?</label>
          <select id="filterMembroFamiliar" onchange="filtrarTabela()" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
            <option value="naoinformado">N√£o informado</option>
          </select>
        </div>
        
        <!-- Filtro: √â PCD -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">√â PCD/tem defici√™ncia:</label>
          <select id="filterPCD" onchange="filtrarTabela()" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
        
        <!-- Filtro: Ocorreu na escola -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Ocorreu na escola?</label>
          <select id="filterOcorreuEscola" onchange="filtrarTabela()" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
        
        <!-- Filtro: Estudo de Caso -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">üìã Foi Realizado Estudo de Caso?</label>
          <select id="filterEstudoCaso" onchange="filtrarTabela()" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
        
        <!-- Filtro: Idade M√≠nima -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Idade M√≠nima:</label>
          <input type="number" id="filterIdadeMin" onchange="filtrarTabela()" placeholder="Ex: 5" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        
        <!-- Filtro: Idade M√°xima -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Idade M√°xima:</label>
          <input type="number" id="filterIdadeMax" onchange="filtrarTabela()" placeholder="Ex: 18" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        
      </div>
      
      <!-- Painel Avan√ßado -->
      <div id="advancedPanel" class="advanced-panel mt-6">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-6 border border-gray-200 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
            <span class="text-2xl">üîç</span>
            <span>Filtros Avan√ßados</span>
          </h3>
          
          <!-- Regi√£o -->
          <div id="section-regiao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">üìç Regi√£o</h4>
            <div id="filterRegiaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Tipo de Viol√™ncia -->
          <div id="section-tipoViolencia" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">‚ö†Ô∏è Tipo de Viol√™ncia</h4>
            <div id="filterTipoViolenciaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Tipo de Institui√ß√£o (CMEI/EMEF) -->
          <div id="section-tipoInstituicao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">üè´ Tipo de Institui√ß√£o</h4>
            <div id="filterTipoInstituicaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Escola Espec√≠fica -->
          <div id="section-escola" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">üè¢ Escola Espec√≠fica</h4>
            <input type="text" id="filterEscola" onkeyup="filtrarTabela()" placeholder="Digite parte do nome da escola..." class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          
          <!-- Ra√ßa/Cor -->
          <div id="section-raca" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">üë• Ra√ßa/Cor</h4>
            <div id="filterRacaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Identidade de G√™nero -->
          <div id="section-genero" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">‚ößÔ∏è G√™nero (M/F)</h4>
            <div id="filterGeneroContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Tipo de Viol√™ncia Institucional (CONDICIONAL - s√≥ aparece quando "Institucional" estiver selecionado) -->
          <div id="section-tipoViolenciaInstitucional" class="filter-section mb-6 hidden">
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
              <p class="text-sm text-yellow-800 font-medium">‚ö†Ô∏è Esta se√ß√£o s√≥ est√° vis√≠vel porque voc√™ selecionou "Viol√™ncia Institucional" acima</p>
            </div>
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">üèõÔ∏è Tipo de Viol√™ncia Institucional</h4>
            <div id="filterTipoViolenciaInstitucionalContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
        </div>
      </div>
      
      <div class="mt-4 flex gap-2 flex-wrap">
        <button onclick="limparFiltros()" class="btn-elegant btn-secondary-elegant px-4 py-2 rounded-md font-medium">
          üîÑ Limpar Filtros
        </button>
      </div>
    </section>

    <!-- Tabela de Registros -->
    <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6">
      <!-- Estat√≠sticas e Pagina√ß√£o -->
      <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4">
          <div class="px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
            <span class="text-sm text-gray-600">Total:</span>
            <span id="totalRegistros" class="ml-2 text-lg font-bold text-blue-600">0</span>
          </div>
          <div class="px-4 py-2 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-600">Exibindo:</span>
            <span id="registrosVisiveis" class="ml-2 text-lg font-bold text-green-600">0</span>
          </div>
        </div>
        
        <!-- Controles de Pagina√ß√£o -->
        <div class="flex items-center gap-3 bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-2 rounded-xl border border-gray-200">
          <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            Itens por p√°gina:
          </label>
          <div class="relative">
            <select id="itensPorPagina" onchange="mudarItensPorPagina()" class="appearance-none px-4 py-2 pr-10 bg-white border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-semibold text-gray-700 cursor-pointer hover:border-blue-400 hover:shadow-md">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="999999">Todos</option>
            </select>
            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          
          <div id="paginacaoControles" class="flex items-center gap-2"></div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabelaRegistros" class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th class="px-4 py-4 text-left text-sm font-bold">Crian√ßa/Estudante</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Data NT</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Idade</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Viol√™ncia</th>
              <th class="px-4 py-4 text-left text-sm font-bold">CMEI/EMEF</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Regi√£o</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Foi um membro familiar?</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Estudo Caso?</th>
              <th class="px-4 py-4 text-center text-sm font-bold">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="corpoTabela" class="divide-y divide-gray-200">
            <tr>
              <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center gap-3">
                  <div class="text-5xl">üìã</div>
                  <div class="text-lg font-medium">Nenhum registro carregado</div>
                  <div class="text-sm">Clique em "Carregar Registros" para visualizar os dados</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modalEdicao" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800">‚úèÔ∏è Editar Registro</h2>
        <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">√ó</button>
      </div>
      
      <form id="formEdicao" class="space-y-6">
        <input type="hidden" id="edit_linha">
        
        <!-- =============================================== -->
        <!-- SE√á√ÉO 1: Dados da Crian√ßa/Estudante -->
        <!-- =============================================== -->
        <section>
          <div class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl border border-gray-200 shadow-sm p-5 mb-6">
            <div class="flex items-start gap-3 mb-5">
              <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-blue-100 text-blue-600 text-xl flex-shrink-0 shadow-sm">
                üë§
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-800 mb-1">
                  Dados da Crian√ßa/Estudante
                </h3>
                <p class="text-xs text-gray-600">
                  Preencha as informa√ß√µes b√°sicas da crian√ßa ou estudante envolvido no caso
                </p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Crian√ßa/Estudante -->
          <div class="md:col-span-2">
            <label for="edit_criancaEstudante" class="block text-sm font-semibold text-gray-700 mb-2">
              Nome da Crian√ßa/Estudante <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="edit_criancaEstudante" 
              name="edit_criancaEstudante" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Digite o nome completo"
            >
          </div>
          
          <!-- Data da NT -->
          <div>
            <label for="edit_dataNT" class="block text-sm font-semibold text-gray-700 mb-2">
              Data da Notifica√ß√£o (NT) <span class="text-red-500">*</span>
            </label>
            <input 
              type="date" 
              id="edit_dataNT" 
              name="edit_dataNT" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
          </div>
          
          <!-- Idade -->
          <div>
            <label for="edit_idade" class="block text-sm font-semibold text-gray-700 mb-2">
              Idade <span class="text-red-500">*</span>
            </label>
            <input 
              type="number" 
              id="edit_idade" 
              name="edit_idade" 
              min="0" 
              max="120"
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Ex: 10"
            >
          </div>
          
          <!-- Identidade de G√™nero -->
          <div>
            <label for="edit_identidadeGenero" class="block text-sm font-semibold text-gray-700 mb-2">
              Identidade de G√™nero <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_identidadeGenero" 
              name="edit_identidadeGenero" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
              <option value="N√£o-bin√°rio">N√£o-bin√°rio</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          
          <!-- √â PCD/tem Transtorno? -->
          <div>
            <label for="edit_pcdTranstorno" class="block text-sm font-semibold text-gray-700 mb-2">
              √â PCD/tem Transtorno?
            </label>
            <select 
              id="edit_pcdTranstorno" 
              name="edit_pcdTranstorno"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
          <!-- Detalhes da defici√™ncia/transtorno (condicional) -->
          <div id="edit_pcdDetalhesContainer" class="md:col-span-2 hidden">
            <label for="edit_pcdDetalhes-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Se for PCD/tem transtorno, descreva quais (diagn√≥sticos, laudos, observa√ß√µes): <span class="text-red-500">*</span>
            </label>
            
            <!-- Container de tags -->
            <div id="edit_pcdDetalhes-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text" 
                id="edit_pcdDetalhes-input"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite ou selecione um transtorno/defici√™ncia..."
                autocomplete="off"
              />
              <div id="edit_pcdDetalhes-suggestions" class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_pcdDetalhes" name="edit_pcdDetalhes" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite para buscar ou adicione um novo transtorno/defici√™ncia. Pressione Enter para adicionar.
            </p>
          </div>
          
          <!-- Ra√ßa/Cor -->
          <div class="md:col-span-2">
            <label for="edit_racaCor" class="block text-sm font-semibold text-gray-700 mb-2">
              Ra√ßa/Cor
            </label>
            <select 
              id="edit_racaCor" 
              name="edit_racaCor"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Branca">Branca</option>
              <option value="Preta">Preta</option>
              <option value="Parda">Parda</option>
              <option value="Amarela">Amarela</option>
              <option value="Ind√≠gena">Ind√≠gena</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
          <!-- Orienta√ß√£o Sexual -->
          <div class="md:col-span-2">
            <label for="edit_orientacaoSexual" class="block text-sm font-semibold text-gray-700 mb-2">
              Orienta√ß√£o Sexual
            </label>
            <select 
              id="edit_orientacaoSexual" 
              name="edit_orientacaoSexual"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Heterossexual">Heterossexual</option>
              <option value="Homossexual">Homossexual</option>
              <option value="Bissexual">Bissexual</option>
              <option value="Assexual">Assexual</option>
              <option value="Pansexual">Pansexual</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 2: Situa√ß√£o da Viol√™ncia -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-red-50/50 to-orange-50/30 rounded-xl border border-red-200 shadow-sm p-5 mb-6">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-red-100 text-red-600 text-xl flex-shrink-0 shadow-sm">
            ‚ö†Ô∏è
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Situa√ß√£o da Viol√™ncia
            </h3>
            <p class="text-xs text-gray-600">
              Descreva o tipo de viol√™ncia ocorrida e os encaminhamentos realizados
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 gap-4">
          
          <div>
            <label for="edit_tipoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Tipo de Viol√™ncia <span class="text-red-500">*</span>
            </label>
            
            <!-- Container de tags -->
            <div id="edit_tipoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_tipoViolencia-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar tipo de viol√™ncia (ex: F√≠sica)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_tipoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_tipoViolencia" name="edit_tipoViolencia" required />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica).
            </p>
          </div>
          
          <!-- Tipo de Viol√™ncia Institucional (Condicional) -->
          <div id="edit_tipoViolenciaInstitucionalContainer" class="hidden">
            <label for="edit_tipoViolenciaInstitucional-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Qual o tipo da viol√™ncia institucional <span class="text-red-500">*</span>
            </label>
            
            <!-- Container de tags -->
            <div id="edit_tipoViolenciaInstitucional-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_tipoViolenciaInstitucional-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/60 focus:border-orange-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar tipo de viol√™ncia institucional (ex: F√≠sica, Psicol√≥gica)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_tipoViolenciaInstitucional-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_tipoViolenciaInstitucional" name="edit_tipoViolenciaInstitucional" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica). Este campo aparece apenas quando "Institucional" est√° selecionado no Tipo de Viol√™ncia.
            </p>
          </div>
          
          <div>
            <label for="edit_encaminhamento-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Encaminhamento
            </label>
            
            <!-- Container de tags -->
            <div id="edit_encaminhamentos-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_encaminhamento-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar encaminhamento (ex: Conselho Tutelar)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_encaminhamento-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_encaminhamento" name="edit_encaminhamento" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Clique no √ó para remover.
            </p>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 3: Unidade e Regi√£o -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-green-50/50 to-emerald-50/30 rounded-xl border border-green-200 shadow-sm p-5 mb-6">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-green-100 text-green-600 text-xl flex-shrink-0 shadow-sm">
            üè´
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Unidade e Regi√£o
            </h3>
            <p class="text-xs text-gray-600">
              Identifique a institui√ß√£o de ensino e regi√£o onde o caso foi registrado
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          
          <!-- Tipo de Institui√ß√£o -->
          <div class="md:col-span-2">
            <label for="edit_tipoInstituicao" class="block text-sm font-semibold text-gray-700 mb-2">
              Qual o tipo da institui√ß√£o de ensino? <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_tipoInstituicao" 
              name="edit_tipoInstituicao"
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione o tipo...</option>
              <option value="CMEI">CMEI - Centro Municipal de Educa√ß√£o Infantil</option>
              <option value="EMEF">EMEF - Escola Municipal de Ensino Fundamental</option>
            </select>
          </div>
          
          <!-- CMEI/EMEF com Autocomplete -->
          <div class="md:col-span-2">
            <label for="edit_cmeiEmef" class="block text-sm font-semibold text-gray-700 mb-2">
              Institui√ß√£o de Ensino <span class="text-red-500">*</span>
            </label>
            <div class="autocomplete-wrapper">
              <input 
                type="text" 
                id="edit_cmeiEmef" 
                name="edit_cmeiEmef" 
                required
                disabled
                autocomplete="off"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-500"
                placeholder="Primeiro selecione o tipo de institui√ß√£o"
              >
              <div class="autocomplete-list" id="edit_autocompleteList"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1.5">Digite para filtrar as institui√ß√µes dispon√≠veis</p>
          </div>
          
          <!-- Regi√£o -->
          <div>
            <label for="edit_regiao" class="block text-sm font-semibold text-gray-700 mb-2">
              Regi√£o <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_regiao" 
              name="edit_regiao" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <!-- Op√ß√µes carregadas dinamicamente via JavaScript -->
            </select>
          </div>
          
          <!-- Respons√°vel pelo Registro -->
          <div class="md:col-span-2">
            <label for="edit_responsavelRegistro" class="block text-sm font-semibold text-gray-700 mb-2">
              Respons√°vel pelo Registro <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="edit_responsavelRegistro" 
              name="edit_responsavelRegistro" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Nome do profissional que est√° registrando"
            >
          </div>

        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 4: Informa√ß√µes Complementares -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-purple-50/50 to-indigo-50/30 rounded-xl border border-purple-200 shadow-sm p-5">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-purple-100 text-purple-600 text-xl flex-shrink-0 shadow-sm">
            ‚ùì
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Informa√ß√µes Complementares
            </h3>
            <p class="text-xs text-gray-600">
              Responda √†s quest√µes adicionais sobre o contexto da viol√™ncia
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          
          <!-- Foi um membro familiar? -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Foi um membro familiar? <span class="text-red-500">*</span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" id="edit_foiMembroFamiliar_sim" name="edit_foiMembroFamiliar" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" id="edit_foiMembroFamiliar_nao" name="edit_foiMembroFamiliar" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" id="edit_foiMembroFamiliar_naoinformado" name="edit_foiMembroFamiliar" value="" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Campos adicionais -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                A fonte dos informadores foi a escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia identificada pela escola ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Algum profissional da escola foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Algum estudante foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia identificada pela escola N√ÉO ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Ocorreu na escola? (1.1)
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia informada √† escola por qualquer um dos agentes que a comp√µe? (1.2)
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
          
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                üìã Foi Realizado Estudo de Caso?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        </div>
      </div>
    </section>
        
        <div class="flex gap-4 pt-6 border-t">
          <button 
            type="submit" 
            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-[1.02]">
            üíæ Salvar Altera√ß√µes
          </button>
          <button 
            type="button" 
            onclick="fecharModal()" 
            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200 hover:shadow-md">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURA√á√ÉO DO GOOGLE APPS SCRIPT
    // ========================================
    // Usando configura√ß√£o centralizada (config.js)
    const APPS_SCRIPT_URL = CONFIG.APPS_SCRIPT_CASOS;
    
    // Debug: Verifica se a URL foi carregada corretamente
    console.log('üîß [DEBUG] APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
    
    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_SCRIPT')) {
      const msgErro = `
‚ùå ERRO DE CONFIGURA√á√ÉO
      
A URL do Apps Script n√£o est√° configurada corretamente!

SOLU√á√ÉO:
1. Abra o arquivo: config.js
2. Localize: APPS_SCRIPT_CASOS
3. Cole a URL correta do seu Apps Script
4. Salve o arquivo
5. Pressione Ctrl+Shift+R para recarregar

URL atual: ${APPS_SCRIPT_URL || 'undefined'}
`;
      console.error(msgErro);
      alert(msgErro);
      throw new Error('APPS_SCRIPT_CASOS n√£o configurado');
    }
    
    console.log('‚úÖ URL do Apps Script configurada corretamente');
    
    let registrosCache = [];
    let registrosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 25;

    // ========================================
    // LISTA DE TRANSTORNOS/DEFICI√äNCIAS PREDEFINIDOS
    // ========================================
    const transtornosPredefinidos = [
      'Autismo (TEA)',
      'TDAH (Transtorno de D√©ficit de Aten√ß√£o e Hiperatividade)',
      'S√≠ndrome de Down',
      'Defici√™ncia Intelectual',
      'Defici√™ncia Visual',
      'Defici√™ncia Auditiva',
      'Defici√™ncia F√≠sica',
      'Defici√™ncia M√∫ltipla',
      'Dist√∫rbio de Linguagem',
      'Encefalopatia Cr√¥nica',
      'Encefalopatia Epil√©tica',
      'Dislexia',
      'Discalculia',
      'Transtorno do Espectro Autista',
      'Paralisia Cerebral',
      'TOD (Transtorno Opositor Desafiador)',
      'Transtorno de Ansiedade',
      'Transtorno de P√¢nico',
      'Depress√£o Infantil',
      'S√≠ndrome de Asperger',
      'Transtorno Bipolar',
      'Esquizofrenia',
      'TOC',
      'TDI',
      'Transtorno Mental',
      'Transtorno de Conduta',
      'Transtorno Comportamental',
      'Altas Habilidades/Superdota√ß√£o',
      'Baixa Vis√£o',
      'Cegueira',
      'Surdez',
      'Surdocegueira',
      'Nanismo',
      'Hidrocefalia',
      'Microcefalia',
      'Epilepsia',
      'Outros'
    ];
    
    // ========================================
    // LISTAS PREDEFINIDAS - RA√áA/COR E TIPO DE VIOL√äNCIA
    // ========================================
    const racasCorPredefinidas = [
      'Branca',
      'Preta',
      'Parda',
      'Amarela',
      'Ind√≠gena',
      'N√£o informado'
    ];
    
    const tiposViolenciaPredefinidos = [
      'Autoprovocada',
      'Interpessoal/Intrafamiliar/Dom√©stica',
      'Interpessoal/Extrafamiliar/Comunit√°ria/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual'
    ];
    
    // LISTA DE CLASSIFICA√á√ïES DA VIOL√äNCIA
    // Deve coincidir EXATAMENTE com a valida√ß√£o da planilha
    const classificacoesViolenciaPredefinidas = [
      'Autoprovocada',
      'Intrafamiliar/Dom√©stica',
      'Extrafamiliar/Comunit√°ria/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual'
    ];
    
    // LISTA DE MOTIVA√á√ïES DA VIOL√äNCIA
    // IMPORTANTE: Valores devem coincidir EXATAMENTE com a valida√ß√£o da planilha
    const motivacoesViolenciaPredefinidas = [
      'Discrimina√ß√£o',
      'Racismo',
      'G√™nero',
      'LGBTQIAPN+fobia',
      'Intoler√¢ncia religiosa',
      'Gordofobia',
      'Bullying'
    ];
    
    let editTranstornosSelecionados = [];
    let editTiposViolenciaSelecionados = [];
    let editEncaminhamentosSelecionados = [];
    
    // ========================================
    // LISTA DE ENCAMINHAMENTOS PREDEFINIDOS
    // ========================================
    const encaminhamentosPredefinidos = [
       'CT',
      'Sa√∫de',
      'UBS',
      'US',
      'NAAM',
      'Educa√ß√£o',
      'Escola',
      'DEAM',
      'DACLE',
      'DPCA',
      'Defensoria P√∫blica',
      'DEPI',
      'Minist√©rio P√∫blico',
      'CRAS',
      'CREAS',
      'CAPSIN',
      'Casa Rosa',
      'Vara da Inf√¢ncia',
      'Assist√™ncia Social',
      'Psic√≥logo',
      'Outras Delegacias',
      'Outros'
    ];
    
    // ========================================
    // LISTA DE REGI√ïES
    // ========================================
    const regioesDisponiveis = [
      'Centro', 'Continental', 'S√£o Pedro', 'Santo Ant√¥nio',
      'Praia do Canto', 'Jardim da Penha', 'Jardim Camburi',
      'Maru√≠pe', 'Bento Ferreira'
    ];

    // ========================================
    // LISTA DE INSTITUI√á√ïES (CMEI E EMEF)
    // ========================================
    const instituicoes = [
      { tipo: "CMEI", nomeOriginal: "CMEI Adalberto Sim\u00e3o Nader" },
      { tipo: "CMEI", nomeOriginal: "CMEI Altair Siqueira Costa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Araci Cortes da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Beatriz Zouain de Oliveira Viana" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bernadete Candia Ferreira de Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bom Pastor" },
      { tipo: "CMEI", nomeOriginal: "CMEI Branca de Nieve Tayt-Sohn Martins de Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Carlos Alberto Martinelli" },
      { tipo: "CMEI", nomeOriginal: "CMEI Celina Damiao Linhalis" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clotildes Gomes do Nascimento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clovis Correa do Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Creche Tia Tereza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Deolinda Lage Caldeira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dilson Rodrigues Fonseca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Domingas de Souza Costalonga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dona Laura" },
      { tipo: "CMEI", nomeOriginal: "CMEI Eliene Rodrigues dos Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Elizabeth Santos Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ernesto Paulino de Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Floracy Peres Faria" },
      { tipo: "CMEI", nomeOriginal: "CMEI Francisco Coelho Avanza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Gilvan dos Santos Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Iracema Conceicao Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Irma Maria Horta" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jacyntha Simoes Ferreira Paiao" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jernida Ribeiro de Mendonca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Joao Pedro Paulista Pizzol" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jose Mario Vieira Barbosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jurema Santos Rangel" },
      { tipo: "CMEI", nomeOriginal: "CMEI Licinha Coco Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lucia Helena Rodrigues Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Magnolia Amaral da Cunha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Marcos e Mirtes Rosa Coelho da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Anselmo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Aparecida Gomes Soares" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria das Gracas Pimentel Lyra" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria de Lourdes Fraga Rocha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Odetina Santos Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Merces Macedo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ocarlina Nunes Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Olga Souza Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Perpetua M\u00e1rcia T Menezes" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Sueli Salles de Carvalho" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Thereza Costa Vervloet Sarmento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Maria Helena Souza de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Neusa Nunes Goncalves" },
      { tipo: "CMEI", nomeOriginal: "CMEI Projeto Quatro" },
      { tipo: "CMEI", nomeOriginal: "CMEI Recanto Feliz" },
      { tipo: "CMEI", nomeOriginal: "CMEI Regina Maura Rezende Sagrillo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Valdete Rouver de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Walma Rodrigues Correia" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adao Benezath" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adevalni Sysesmundo Ferreira de Azevedo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adilson da Silva Castro" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alberto de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvaro de Castro Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvimar Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Aristobulo Barbosa Leao" },
      { tipo: "EMEF", nomeOriginal: "EMEF Arthur da Costa e Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Castelo Branco" },
      { tipo: "EMEF", nomeOriginal: "EMEF Ceciliano Abel de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Custodia Dias de Campos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eber Louzada Zippinotti" },
      { tipo: "EMEF", nomeOriginal: "EMEF EJA Prof Admardo Serafim de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eliane Rodrigues dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Elzira Vivacqua dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Experimental de Vitoria - UFES" },
      { tipo: "EMEF", nomeOriginal: "EMEF Francisco Lacerda de Aguiar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Heloisa Abreu Judice de Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Irma Jacinta Soares de Souza Lima" },
      { tipo: "EMEF", nomeOriginal: "EMEF Juscelino Kubitschek de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Lenir Borlot" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marechal Mascarenhas de Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Jose Costa Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Leonor Pereira da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Madalena de Oliveira Domingues" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marieta Escobar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Mauro Braga" },
      { tipo: "EMEF", nomeOriginal: "EMEF Neusa Nunes Goncalves" },
      { tipo: "EMEF", nomeOriginal: "EMEF Octacilio Lomba" },
      { tipo: "EMEF", nomeOriginal: "EMEF Orlandina D'Almeida Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF Otto Ewald Junior" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Anchieta" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Guido Ceotto" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prezideu Amorim" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Joao Bandeira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Maria Stella de Novaes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Vercenilio da Silva Pascoal" },
      { tipo: "EMEF", nomeOriginal: "EMEF Professora Regina Maria Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Rita de Cassia Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Sao Vicente de Paulo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Suzete Cuendet" },
      { tipo: "EMEF", nomeOriginal: "EMEF Tancredo de Almeida Neves" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Amilton Monteiro da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Anacleta Schneider Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Edna de Mattos Siqueira Gaudio" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Izaura Marques da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Aureo Monjardim" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Lemos de Miranda" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Moacyr Avidos" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Reglus Neves Freire" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Roberto Vieira Gomes" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Professora Eunice Pereira Silveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Ronaldo Soares" },
      { tipo: "EMEF", nomeOriginal: "EMEF Zilda Andrade" }
    ];

    // Gera siglas para cada institui√ß√£o
    function gerarSiglaEdit(nomeCompleto) {
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');
      return sigla;
    }

    instituicoes.forEach(inst => {
      inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
    });

    // Vari√°veis de controle do autocomplete de institui√ß√µes
    let edit_tipoInstituicaoSelecionado = '';
    let edit_instituicoesFiltradas = [];
    let edit_indiceSelecionado = -1;
    
    // Renderiza as tags de transtornos selecionados no modal de edi√ß√£o
    function renderizarTagsTranstornosEdit() {
      const container = document.getElementById('edit_pcdDetalhes-tags');
      const hiddenInput = document.getElementById('edit_pcdDetalhes');
      
      if (editTranstornosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum transtorno/defici√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editTranstornosSelecionados.map((trans, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm">
          ${trans}
          <button 
            type="button" 
            onclick="removerTranstornoEdit(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = editTranstornosSelecionados.join(', ');
    }
    
    // Remove um transtorno
    function removerTranstornoEdit(index) {
      editTranstornosSelecionados.splice(index, 1);
      renderizarTagsTranstornosEdit();
    }
    
    // Adiciona um transtorno (suporta separa√ß√£o por barra /)
    function adicionarTranstornoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Separa por barra (/) para considerar m√∫ltiplos transtornos
      const transtornos = textoTrimmed.split('/').map(t => t.trim()).filter(t => t.length > 0);
      
      // Adiciona cada transtorno separadamente
      transtornos.forEach(transtorno => {
        // Evita duplicatas
        if (!editTranstornosSelecionados.includes(transtorno)) {
          editTranstornosSelecionados.push(transtorno);
        }
      });
      
      renderizarTagsTranstornosEdit();
      
      // Limpa input
      document.getElementById('edit_pcdDetalhes-input').value = '';
      document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de transtornos
    function mostrarSugestoesTranstornosEdit(query) {
      const suggestionsDiv = document.getElementById('edit_pcdDetalhes-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? transtornosPredefinidos.filter(trans => !editTranstornosSelecionados.includes(trans))
        : transtornosPredefinidos.filter(trans => 
            trans.toLowerCase().includes(query.toLowerCase()) &&
            !editTranstornosSelecionados.includes(trans)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhum transtorno encontrado. Pressione <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Enter</kbd> para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(trans => `
        <div 
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTranstornoEdit('${trans.replace(/'/g, "\\\'")}')">
          ${trans}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // Configura eventos do campo de transtornos no modal de edi√ß√£o
    function configurarEventosTranstornosEdit() {
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');
      
      // Listener para mostrar/ocultar campo de detalhes
      pcdTranstornoSelect.addEventListener('change', function() {
        if (this.value === 'Sim') {
          pcdDetalhesContainer.classList.remove('hidden');
        } else {
          pcdDetalhesContainer.classList.add('hidden');
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          pcdDetalhesInput.value = '';
        }
      });
      
      // Eventos do input de transtornos
      pcdDetalhesInput.addEventListener('focus', function(e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });
      
      pcdDetalhesInput.addEventListener('input', function(e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });
      
      pcdDetalhesInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTranstornoEdit(e.target.value);
        }
      });
      
      // Esconde sugest√µes ao clicar fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_pcdDetalhes-input') && !e.target.closest('#edit_pcdDetalhes-suggestions')) {
          document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
        }
      });
    }
    
    // Inicializa eventos quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      configurarEventosTranstornosEdit();
      configurarEventosTipoViolenciaEdit();
      configurarEventosTipoViolenciaInstitucionalEdit();
      configurarEventosEncaminhamentoEdit();
      configurarEventosInstituicaoEdit();
      carregarOpcoesRegiaoEdit();
      
      // Listener para mostrar/ocultar campo de detalhes PCD
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');
      
      pcdTranstornoSelect.addEventListener('change', function() {
        if (this.value === 'Sim') {
          // Mostra o campo de detalhes
          pcdDetalhesContainer.classList.remove('hidden');
          // Adiciona anima√ß√£o suave
          pcdDetalhesContainer.style.animation = 'slideDown 0.3s ease-out';
        } else {
          // Esconde o campo de detalhes
          pcdDetalhesContainer.classList.add('hidden');
          // Limpa os transtornos selecionados
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          // Limpa input
          pcdDetalhesInput.value = '';
        }
      });
    });
    
    // ========================================
    // SISTEMA TIPO DE VIOL√äNCIA - M√öLTIPLAS TAGS (EDI√á√ÉO)
    // ========================================
    
    // Renderiza as tags de tipo de viol√™ncia
    function renderizarTagsTipoViolenciaEdit() {
      const container = document.getElementById('edit_tipoViolencia-tags');
      const hiddenInput = document.getElementById('edit_tipoViolencia');
      
      if (editTiposViolenciaSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de viol√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editTiposViolenciaSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolenciaEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = editTiposViolenciaSelecionados.join(', ');
    }
    
    // Remove um tipo de viol√™ncia
    function removerTipoViolenciaEdit(index) {
      editTiposViolenciaSelecionados.splice(index, 1);
      renderizarTagsTipoViolenciaEdit();
      verificarViolenciaInstitucionalEdit();
    }
    
    // Adiciona um tipo de viol√™ncia
    function adicionarTipoViolenciaEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Evita duplicatas
      if (!editTiposViolenciaSelecionados.includes(textoTrimmed)) {
        editTiposViolenciaSelecionados.push(textoTrimmed);
        renderizarTagsTipoViolenciaEdit();
      }
      
      // Limpa input
      document.getElementById('edit_tipoViolencia-input').value = '';
      document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
      
      // Verifica se deve mostrar/esconder campo de viol√™ncia institucional
      verificarViolenciaInstitucionalEdit();
    }
    
    // Filtra e mostra sugest√µes de tipo de viol√™ncia
    function mostrarSuggestoesTipoViolenciaEdit(query) {
      const suggestionsDiv = document.getElementById('edit_tipoViolencia-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? tiposViolenciaPredefinidos.filter(tipo => !editTiposViolenciaSelecionados.includes(tipo))
        : tiposViolenciaPredefinidos.filter(tipo => 
            tipo.toLowerCase().includes(query.toLowerCase()) &&
            !editTiposViolenciaSelecionados.includes(tipo)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolenciaEdit('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosTipoViolenciaEdit() {
      const input = document.getElementById('edit_tipoViolencia-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolenciaEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_tipoViolencia-input') && !e.target.closest('#edit_tipoViolencia-suggestions')) {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA TIPO DE VIOL√äNCIA INSTITUCIONAL - M√öLTIPLAS TAGS (EDI√á√ÉO)
    // ========================================
    
    // Array para armazenar tipos de viol√™ncia institucional selecionados
    let editTiposViolenciaInstitucionalSelecionados = [];
    
    // Renderiza as tags de tipo de viol√™ncia institucional
    function renderizarTagsTipoViolenciaInstitucionalEdit() {
      const container = document.getElementById('edit_tipoViolenciaInstitucional-tags');
      const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');
      
      if (editTiposViolenciaInstitucionalSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de viol√™ncia institucional adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editTiposViolenciaInstitucionalSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolenciaInstitucionalEdit(${index})"
            class="hover:bg-orange-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = editTiposViolenciaInstitucionalSelecionados.join(', ');
    }
    
    // Remove um tipo de viol√™ncia institucional
    function removerTipoViolenciaInstitucionalEdit(index) {
      editTiposViolenciaInstitucionalSelecionados.splice(index, 1);
      renderizarTagsTipoViolenciaInstitucionalEdit();
    }
    
    // Adiciona um tipo de viol√™ncia institucional
    function adicionarTipoViolenciaInstitucionalEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Evita duplicatas
      if (!editTiposViolenciaInstitucionalSelecionados.includes(textoTrimmed)) {
        editTiposViolenciaInstitucionalSelecionados.push(textoTrimmed);
        renderizarTagsTipoViolenciaInstitucionalEdit();
      }
      
      // Limpa input
      document.getElementById('edit_tipoViolenciaInstitucional-input').value = '';
      document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de tipo de viol√™ncia institucional
    function mostrarSuggestoesTipoViolenciaInstitucionalEdit(query) {
      const suggestionsDiv = document.getElementById('edit_tipoViolenciaInstitucional-suggestions');
      
      // Carrega tipos de viol√™ncia institucional dispon√≠veis
      const tiposInstitucionalPredefinidos = carregarTiposViolenciaInstitucional();
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? tiposInstitucionalPredefinidos.filter(tipo => !editTiposViolenciaInstitucionalSelecionados.includes(tipo))
        : tiposInstitucionalPredefinidos.filter(tipo => 
            tipo.toLowerCase().includes(query.toLowerCase()) &&
            !editTiposViolenciaInstitucionalSelecionados.includes(tipo)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-orange-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolenciaInstitucionalEdit('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosTipoViolenciaInstitucionalEdit() {
      const input = document.getElementById('edit_tipoViolenciaInstitucional-input');
      
      if (!input) return;
      
      input.addEventListener('focus', function(e) {
        mostrarSuggestoesTipoViolenciaInstitucionalEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSuggestoesTipoViolenciaInstitucionalEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolenciaInstitucionalEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_tipoViolenciaInstitucional-input') && !e.target.closest('#edit_tipoViolenciaInstitucional-suggestions')) {
          document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
        }
      });
    }
    
    // Verifica se "Institucional" est√° selecionado no tipo de viol√™ncia e mostra/esconde o campo
    function verificarViolenciaInstitucionalEdit() {
      const tipoViolenciaInput = document.getElementById('edit_tipoViolencia');
      const container = document.getElementById('edit_tipoViolenciaInstitucionalContainer');
      
      if (!tipoViolenciaInput || !container) return;
      
      const tipoViolenciaValue = tipoViolenciaInput.value || '';
      const tiposSelecionados = tipoViolenciaValue.split(',').map(t => t.trim()).filter(t => t);
      const temInstitucional = tiposSelecionados.some(t => {
        const tLower = t.toLowerCase();
        return tLower === 'institucional' || tLower.includes('institucional');
      });
      
      if (temInstitucional) {
        container.classList.remove('hidden');
        // Adiciona anima√ß√£o suave
        container.style.animation = 'slideDown 0.3s ease-out';
        // Torna o campo obrigat√≥rio quando vis√≠vel
        const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = true;
      } else {
        container.classList.add('hidden');
        // Limpa os tipos selecionados
        editTiposViolenciaInstitucionalSelecionados = [];
        renderizarTagsTipoViolenciaInstitucionalEdit();
        // Limpa input
        const input = document.getElementById('edit_tipoViolenciaInstitucional-input');
        if (input) input.value = '';
        // Remove obrigatoriedade quando oculto
        const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = false;
      }
    }
    
    // Carrega tipos de viol√™ncia institucional dispon√≠veis
    function carregarTiposViolenciaInstitucional() {
      return [
        'F√≠sica',
        'Psicol√≥gica',
        'Administrativa',
        'Patrimonial',
        'Moral',
        'Sexual',
        'Neglig√™ncia',
        'N√£o informada'
      ];
    }

    // ========================================
    // SISTEMA DE ENCAMINHAMENTO COM TAGS (EDI√á√ÉO)
    // ========================================
    function renderizarTagsEncaminhamentoEdit() {
      const container = document.getElementById('edit_encaminhamentos-tags');
      const hiddenInput = document.getElementById('edit_encaminhamento');
      
      if (editEncaminhamentosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum encaminhamento adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editEncaminhamentosSelecionados.map((enc, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${enc}
          <button 
            type="button" 
            onclick="removerEncaminhamentoEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = editEncaminhamentosSelecionados.join(', ');
    }
    
    function removerEncaminhamentoEdit(index) {
      editEncaminhamentosSelecionados.splice(index, 1);
      renderizarTagsEncaminhamentoEdit();
    }
    
    function adicionarEncaminhamentoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      if (!editEncaminhamentosSelecionados.includes(textoTrimmed)) {
        editEncaminhamentosSelecionados.push(textoTrimmed);
        renderizarTagsEncaminhamentoEdit();
      }
      
      document.getElementById('edit_encaminhamento-input').value = '';
      document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
    }
    
    function mostrarSugestoesEncaminhamentoEdit(query) {
      const suggestionsDiv = document.getElementById('edit_encaminhamento-suggestions');
      
      const filtrados = query.trim() === '' 
        ? encaminhamentosPredefinidos.filter(enc => !editEncaminhamentosSelecionados.includes(enc))
        : encaminhamentosPredefinidos.filter(enc => 
            enc.toLowerCase().includes(query.toLowerCase()) &&
            !editEncaminhamentosSelecionados.includes(enc)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(enc => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarEncaminhamentoEdit('${enc}')">
          ${enc}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosEncaminhamentoEdit() {
      const input = document.getElementById('edit_encaminhamento-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarEncaminhamentoEdit(e.target.value);
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_encaminhamento-input') && !e.target.closest('#edit_encaminhamento-suggestions')) {
          document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA DE AUTOCOMPLETE CMEI/EMEF (EDI√á√ÉO)
    // ========================================
    function removerAcentosEdit(texto) {
      return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function filtrarInstituicoesEdit(termo) {
      const termoLower = removerAcentosEdit(termo.toLowerCase());
      const termoSemEspacos = termoLower.replace(/\s+/g, '');
      
      return edit_instituicoesFiltradas.filter(inst => {
        const nomeNormalizado = removerAcentosEdit(inst.nomeOriginal.toLowerCase());
        const siglaNormalizada = removerAcentosEdit(inst.sigla.toLowerCase());
        
        const palavras = termoLower.split(' ').filter(p => p.length > 0);
        const matchPorPalavras = palavras.every(palavra => nomeNormalizado.includes(palavra));
        const matchPorSigla = siglaNormalizada.includes(termoSemEspacos);
        const matchPorIniciaisConsecutivas = siglaNormalizada.startsWith(termoSemEspacos);
        
        return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
      });
    }

    function renderizarSugestoesEdit(resultados) {
      const autocompleteList = document.getElementById('edit_autocompleteList');
      
      if (resultados.length === 0) {
        autocompleteList.classList.remove('show');
        return;
      }
      
      autocompleteList.innerHTML = resultados
        .slice(0, 10)
        .map(inst => `
          <div class="autocomplete-item" data-value="${inst.nomeOriginal}">
            ${inst.nomeOriginal}
          </div>
        `).join('');
      
      autocompleteList.classList.add('show');
      
      autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
          document.getElementById('edit_cmeiEmef').value = this.getAttribute('data-value');
          autocompleteList.classList.remove('show');
        });
      });
    }

    function atualizarSelecaoVisualEdit(items) {
      items.forEach((item, index) => {
        if (index === edit_indiceSelecionado) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function configurarEventosInstituicaoEdit() {
      const tipoInstituicaoSelect = document.getElementById('edit_tipoInstituicao');
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      const autocompleteList = document.getElementById('edit_autocompleteList');
      
tipoInstituicaoSelect.addEventListener('change', function() {
  edit_tipoInstituicaoSelecionado = this.value;
  
  // CR√çTICO: N√£o limpa o campo se estamos carregando dados de edi√ß√£o
  const isLoading = cmeiEmefInput.getAttribute('data-loading') === 'true';
  
  if (edit_tipoInstituicaoSelecionado) {
    cmeiEmefInput.disabled = false;
    cmeiEmefInput.placeholder = 'Digite para buscar...';
    
    // S√≥ limpa o campo se N√ÉO estiver carregando dados
    if (!isLoading) {
      cmeiEmefInput.value = '';
      cmeiEmefInput.focus();
    }
    
    edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === edit_tipoInstituicaoSelecionado);
  } else {
    cmeiEmefInput.disabled = true;
    cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
    
    // S√≥ limpa o campo se N√ÉO estiver carregando dados
    if (!isLoading) {
      cmeiEmefInput.value = '';
    }
    
    autocompleteList.classList.remove('show');
  }
});
      
      cmeiEmefInput.addEventListener('input', function() {
        const termo = this.value.trim();
        edit_indiceSelecionado = -1;
        
        if (termo.length === 0) {
          autocompleteList.classList.remove('show');
          return;
        }
        
        const resultados = filtrarInstituicoesEdit(termo);
        renderizarSugestoesEdit(resultados);
      });
      
      cmeiEmefInput.addEventListener('keydown', function(e) {
        const items = autocompleteList.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          edit_indiceSelecionado = Math.min(edit_indiceSelecionado + 1, items.length - 1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          edit_indiceSelecionado = Math.max(edit_indiceSelecionado - 1, -1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (edit_indiceSelecionado >= 0 && items[edit_indiceSelecionado]) {
            items[edit_indiceSelecionado].click();
          }
        } else if (e.key === 'Escape') {
          autocompleteList.classList.remove('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!cmeiEmefInput.contains(e.target) && !autocompleteList.contains(e.target)) {
          autocompleteList.classList.remove('show');
        }
      });
    }

    // ========================================
    // CARREGAR OP√á√ïES DE REGI√ÉO (EDI√á√ÉO)
    // ========================================
    function carregarOpcoesRegiaoEdit() {
      const select = document.getElementById('edit_regiao');
      select.innerHTML = '<option value="">Selecione...</option>';
      
      regioesDisponiveis.forEach(function(regiao) {
        const option = document.createElement('option');
        option.value = regiao;
        option.textContent = regiao;
        select.appendChild(option);
      });
    }

    // ========================================
    // FUN√á√ïES DE ALERTA
    // ========================================
    function mostrarAlerta(mensagem, tipo = 'info') {
      const container = document.getElementById('alertContainer');
      const cores = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };
      
      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-lg shadow-md`;
      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <p class="font-medium">${mensagem}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-4">√ó</button>
        </div>
      `;
      
      container.appendChild(alerta);
      setTimeout(() => alerta.remove(), 5000);
    }

    // ========================================
    // CARREGAR REGISTROS DA PLANILHA
    // ========================================
    function carregarRegistros(manterPagina = false) {
      const btn = document.getElementById('btnCarregar');
      const info = document.getElementById('loadingInfo');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">‚è≥</span> <span>Carregando...</span>';
      btn.classList.add('opacity-75', 'cursor-not-allowed');
      info.textContent = 'Buscando dados da planilha...';
      info.classList.add('animate-pulse');
      
      console.log('[gerenciar] carregarRegistros iniciado');
      
      // Cria iframe oculto
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = APPS_SCRIPT_URL + '?action=list&t=' + Date.now();
      
      // Listener para receber resposta
      const messageHandler = function(event) {
        // Aceita APENAS mensagens do Google Apps Script
        if (!event.origin.includes('google')) {
          return; // Ignora silenciosamente outras origens
        }
        
        // Verifica se √© a resposta esperada (tem success e registros)
        if (!event.data || typeof event.data.success === 'undefined') {
          return; // Ignora mensagens que n√£o s√£o do nosso Apps Script
        }
        
        console.log('[gerenciar] Resposta do Apps Script recebida');
        
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Carregar Registros';
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        info.classList.remove('animate-pulse');
        
        if (event.data.success && event.data.registros) {
          console.log('[gerenciar] ‚úÖ Sucesso:', event.data.registros.length, 'registros');
          registrosCache = event.data.registros;
          renderizarTabela(event.data.registros, manterPagina);
          info.textContent = event.data.registros.length + ' registros encontrados';
          info.classList.remove('text-red-600');
          info.classList.add('text-green-600');
          // Popular op√ß√µes dos filtros avan√ßados
          popularFiltrosAvancados();
        } else {
          console.error('[gerenciar] ‚ùå Erro na resposta:', event.data.message);
          info.textContent = 'Erro ao carregar';
          info.classList.remove('text-green-600');
          info.classList.add('text-red-600');
          mostrarAlerta('‚ùå ' + (event.data.message || 'Erro ao carregar registros'), 'error');
        }
        
        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };
      
      window.addEventListener('message', messageHandler);
      document.body.appendChild(iframe);
      
      // Timeout
      setTimeout(() => {
        if (btn.disabled) {
          btn.disabled = false;
          btn.innerHTML = 'üîÑ Carregar Registros';
          btn.classList.remove('opacity-75', 'cursor-not-allowed');
          info.textContent = 'Timeout';
          info.classList.remove('animate-pulse', 'text-green-600');
          info.classList.add('text-red-600');
          window.removeEventListener('message', messageHandler);
          iframe.remove();
          mostrarAlerta('‚è±Ô∏è Timeout ao carregar', 'error');
        }
      }, 15000);
    }

    // ========================================
    // RENDERIZAR TABELA COM PAGINA√á√ÉO
    // ========================================
    function renderizarTabela(registros, manterPagina = false) {
      registrosFiltrados = registros || [];
      if (!manterPagina) {
        paginaAtual = 1; // Reset para primeira p√°gina apenas se n√£o for reload
      }
      renderizarPagina();
    }

    function renderizarPagina() {
      const tbody = document.getElementById('corpoTabela');
      const registros = registrosFiltrados;
      
      if (!registros || registros.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <div class="text-5xl">üîç</div>
                <div class="text-lg font-medium">Nenhum registro encontrado</div>
              </div>
            </td>
          </tr>
        `;
        atualizarContadores(0, 0);
        renderizarPaginacao(0);
        return;
      }
      
      // Calcula √≠ndices da pagina√ß√£o
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const registrosPagina = registros.slice(inicio, fim);
      
      tbody.innerHTML = registrosPagina.map((reg, idx) => {
        let membroFamiliar = '-';
        if (reg.foiMembroFamiliar === 'Sim') membroFamiliar = 'Sim';
        else if (reg.foiMembroFamiliar === 'N√£o') membroFamiliar = 'N√£o';
        else membroFamiliar = 'N√£o informado';
        return `
        <tr class="hover:bg-blue-50/50 transition-colors duration-150 border-b border-gray-100" data-nome="${(reg.criancaEstudante || '').toLowerCase()}">
          <td class="px-4 py-4 text-sm text-gray-800 font-medium">
            ${reg.criancaEstudante || '-'}
            ${(reg.pcdTranstorno === 'Sim' && reg.pcdDetalhes) ? '<span class="ml-2 text-blue-600" title="PCD: ' + (reg.pcdDetalhes || '').replace(/"/g, '&quot;') + '">‚ôø</span>' : ''}
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.dataNT || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.idade || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
              ${reg.tipoViolencia || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.cmeiEmef || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
              ${reg.regiao || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 ${membroFamiliar === 'Sim' ? 'bg-green-100 text-green-800' : membroFamiliar === 'N√£o' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'} rounded-full text-xs font-semibold">
              ${membroFamiliar}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 ${reg.estudoCaso === 'Sim' ? 'bg-green-100 text-green-800' : reg.estudoCaso === 'N√£o' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'} rounded-full text-xs font-semibold">
              ${reg.estudoCaso || 'N√£o informado'}
            </span>
          </td>
          <td class="px-4 py-4">
            <div class="flex gap-2 justify-center">
              <button 
                onclick="abrirEdicao(${reg.linha})"
                class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-blue-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>‚úèÔ∏è</span>
                <span>Editar</span>
              </button>
              <button 
                onclick="confirmarExclusao(${reg.linha}, '${(reg.criancaEstudante || '')
                  .replace(/\\/g, '\\\\')
                  .replace(/\n|\r/g, ' ')
                  .replace(/'/g, "\\'")}')"
                class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-red-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>üóëÔ∏è</span>
                <span>Excluir</span>
              </button>
            </div>
          </td>
        </tr>
        `;
      }).join('');
      
      atualizarContadores(registros.length, registrosPagina.length);
      renderizarPaginacao(registros.length);
    }

    // ========================================
    // PAGINA√á√ÉO
    // ========================================
    function renderizarPaginacao(total) {
      const container = document.getElementById('paginacaoControles');
      const totalPaginas = Math.ceil(total / itensPorPagina);
      
      if (totalPaginas <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Bot√£o Anterior
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual - 1})" 
          ${paginaAtual === 1 ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 ${paginaAtual === 1 ? '' : 'group-hover:-translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Anterior
          </span>
        </button>
      `;
      
      // N√∫meros das p√°ginas - mostra no m√°ximo 3 n√∫meros + primeira e √∫ltima
      const maxBotoesVisiveis = 3;
      
      // Se total de p√°ginas √© menor ou igual a 5, mostra todas
      if (totalPaginas <= 5) {
        for (let i = 1; i <= totalPaginas; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
      } else {
        // Sempre mostra primeira p√°gina
        html += `<button onclick="irParaPagina(1)" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === 1 ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">1</button>`;
        
        // Determina quais p√°ginas do meio mostrar
        let inicio, fim;
        
        if (paginaAtual <= 3) {
          // Pr√≥ximo √†s primeiras p√°ginas: mostra 2, 3, 4
          inicio = 2;
          fim = 4;
        } else if (paginaAtual >= totalPaginas - 2) {
          // Pr√≥ximo √†s √∫ltimas p√°ginas: mostra (total-3), (total-2), (total-1)
          inicio = totalPaginas - 3;
          fim = totalPaginas - 1;
        } else {
          // No meio: mostra (atual-1), atual, (atual+1)
          inicio = paginaAtual - 1;
          fim = paginaAtual + 1;
        }
        
        // Adiciona elipse antes se necess√°rio
        if (inicio > 2) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Mostra as p√°ginas do meio
        for (let i = inicio; i <= fim; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
        
        // Adiciona elipse depois se necess√°rio
        if (fim < totalPaginas - 1) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Sempre mostra √∫ltima p√°gina
        html += `<button onclick="irParaPagina(${totalPaginas})" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === totalPaginas ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">${totalPaginas}</button>`;
      }
      
      // Bot√£o Pr√≥ximo
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual + 1})" 
          ${paginaAtual === totalPaginas ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === totalPaginas ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            Pr√≥ximo
            <svg class="w-4 h-4 ${paginaAtual === totalPaginas ? '' : 'group-hover:translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </span>
        </button>
      `;
      
      container.innerHTML = html;
    }

    function irParaPagina(pagina) {
      const totalPaginas = Math.ceil(registrosFiltrados.length / itensPorPagina);
      if (pagina < 1 || pagina > totalPaginas) return;
      paginaAtual = pagina;
      renderizarPagina();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mudarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // FILTRAR TABELA COM M√öLTIPLOS CRIT√âRIOS
    // ========================================
    function filtrarTabela() {
      const busca = document.getElementById('campoBusca').value.toLowerCase().trim();
      const filtroMembroBasico = document.getElementById('filtroMembroFamiliar')?.value || 'todos';
      
      // Filtros avan√ßados - com fallback seguro
      const getFilterValue = (id) => {
        const elem = document.getElementById(id);
        return elem ? elem.value : '';
      };
      
      const getRadioValue = (name) => {
        const elem = document.querySelector(`input[name="${name}"]:checked`);
        return elem ? elem.value : '';
      };
      
      // Coleta checkboxes selecionados (para Regi√£o, Tipo de Viol√™ncia, Ra√ßa)
      const getCheckboxValues = (containerSelector) => {
        return Array.from(document.querySelectorAll(`${containerSelector} input[type="checkbox"]:checked`))
          .map(cb => cb.value);
      };
      
      const filterRegioes = getCheckboxValues('#filterRegiaoContainer');
      const filterTiposViolencia = getCheckboxValues('#filterTipoViolenciaContainer');
      const filterTiposViolenciaInstitucional = getCheckboxValues('#filterTipoViolenciaInstitucionalContainer');
      const filterRacas = getCheckboxValues('#filterRacaContainer');
      
      const filterEscola = (getFilterValue('filterEscola') || '').toLowerCase().trim();
      const filterTipoInstituicao = getRadioValue('tipoInstituicaoRadio');
      const filterGenero = getRadioValue('generoRadio');
      const filterPCD = getRadioValue('pcdRadio');
      const filterIdadeMin = parseInt(getFilterValue('filterIdadeMin') || '0');
      const filterIdadeMax = parseInt(getFilterValue('filterIdadeMax') || '999');
      const filterMembroRadio = getRadioValue('membroRadio');
      const filterOcorreuEscola = getFilterValue('filterOcorreuEscola');
      const filterEstudoCaso = getFilterValue('filterEstudoCaso');
      
      registrosFiltrados = registrosCache.filter(reg => {
        // Busca por nome
        const nomeMatch = (reg.criancaEstudante || '').toLowerCase().includes(busca);
        
        // Membro Familiar - usa radio se preenchido, sen√£o usa b√°sico
        let membroMatch = true;
        const filtroMembroAtual = filterMembroRadio || filtroMembroBasico;
        if (filtroMembroAtual === 'Sim') membroMatch = reg.foiMembroFamiliar === 'Sim';
        else if (filtroMembroAtual === 'N√£o') membroMatch = reg.foiMembroFamiliar === 'N√£o';
        else if (filtroMembroAtual === 'naoinformado') membroMatch = !reg.foiMembroFamiliar || reg.foiMembroFamiliar === '';
        
        // Regi√£o (checkboxes - se houver sele√ß√£o, usa isso; sen√£o, mostra todos)
        const regiaoMatch = filterRegioes.length === 0 || filterRegioes.includes(reg.regiao || '');
        
        // Tipo de Viol√™ncia (checkboxes) - APENAS COLUNA J
        const tipoViolenciaMatch = filterTiposViolencia.length === 0 || filterTiposViolencia.some(t => 
          (reg.tipoViolencia || '').includes(t)
        );
        
        // Tipo de Viol√™ncia Institucional (checkboxes) - APENAS COLUNA K (condicional)
        const tipoViolenciaInstitucionalMatch = filterTiposViolenciaInstitucional.length === 0 || 
          filterTiposViolenciaInstitucional.some(t => 
            (reg.tipoViolenciaInstitucional || '').includes(t)
          );
        
        // Tipo de Institui√ß√£o
        let tipoInstituicaoMatch = true;
        if (filterTipoInstituicao) {
          const cmeiEmef = reg.cmeiEmef || '';
          if (filterTipoInstituicao === 'CMEI') tipoInstituicaoMatch = cmeiEmef.startsWith('CMEI');
          else if (filterTipoInstituicao === 'EMEF') tipoInstituicaoMatch = cmeiEmef.startsWith('EMEF');
        }
        
        // Escola Espec√≠fica
        const escolaMatch = !filterEscola || (reg.cmeiEmef || '').toLowerCase().includes(filterEscola);
        
        // Ra√ßa/Cor (checkboxes)
        const racaMatch = filterRacas.length === 0 || filterRacas.includes(reg.racaCor || '');
        
        // G√™nero
        const generoMatch = !filterGenero || (reg.identidadeGenero || '').includes(filterGenero);
        
        // PCD/Defici√™ncia
        let pcdMatch = true;
        if (filterPCD === 'Sim') pcdMatch = reg.pcdTranstorno === 'Sim';
        else if (filterPCD === 'N√£o') pcdMatch = reg.pcdTranstorno !== 'Sim';
        
        // Idade
        const idade = parseInt(reg.idade || '0');
        const idadeMatch = idade >= filterIdadeMin && idade <= filterIdadeMax;
        
        // Ocorreu na Escola
        let ocorreuEscolaMatch = true;
        if (filterOcorreuEscola === 'Sim') ocorreuEscolaMatch = reg.ocorreuEscola === 'Sim';
        else if (filterOcorreuEscola === 'N√£o') ocorreuEscolaMatch = reg.ocorreuEscola === 'N√£o';
        
        // Estudo de Caso
        let estudoCasoMatch = true;
        if (filterEstudoCaso === 'Sim') estudoCasoMatch = reg.estudoCaso === 'Sim';
        else if (filterEstudoCaso === 'N√£o') estudoCasoMatch = reg.estudoCaso === 'N√£o';
        
        return nomeMatch && membroMatch && regiaoMatch && tipoViolenciaMatch && tipoViolenciaInstitucionalMatch && 
               tipoInstituicaoMatch && escolaMatch && racaMatch && generoMatch && pcdMatch && idadeMatch && 
               ocorreuEscolaMatch && estudoCasoMatch;
      });
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // ATUALIZAR CONTADORES
    // ========================================
    function atualizarContadores(total, visiveis) {
      document.getElementById('totalRegistros').textContent = total;
      document.getElementById('registrosVisiveis').textContent = visiveis;
    }

    // ========================================
    // ABRIR MODAL DE EDI√á√ÉO
    // ========================================
    function abrirEdicao(linha) {
      const registro = registrosCache.find(r => r.linha === linha);
      
      if (!registro) {
        mostrarAlerta('‚ùå Registro n√£o encontrado!', 'error');
        return;
      }
      
      console.log('[gerenciar] Abrindo edi√ß√£o do registro:', registro);
      console.log('[gerenciar] dataNT_ISO:', registro.dataNT_ISO);
      console.log('[gerenciar] identidadeGenero:', registro.identidadeGenero);
      
      // Preenche TODOS os campos do formul√°rio
      document.getElementById('edit_linha').value = linha;
      document.getElementById('edit_criancaEstudante').value = registro.criancaEstudante || '';
      document.getElementById('edit_dataNT').value = registro.dataNT_ISO || '';
      document.getElementById('edit_idade').value = registro.idade || '';
      
      // Mapeamento de identidade de g√™nero (compatibilidade com registros antigos)
      let identidadeGeneroValue = (registro.identidadeGenero || '').trim();
      const mapeamentoGenero = {
        'Menino': 'M',
        'Menina': 'F',
        'M': 'M',
        'F': 'F',
        'N√£o-bin√°rio': 'N√£o-bin√°rio',
        'Outro': 'Outro'
      };
      identidadeGeneroValue = mapeamentoGenero[identidadeGeneroValue] || identidadeGeneroValue;
      document.getElementById('edit_identidadeGenero').value = identidadeGeneroValue;
      console.log('[gerenciar] identidadeGenero original:', registro.identidadeGenero, '‚Üí mapeado:', identidadeGeneroValue);
      
      document.getElementById('edit_pcdTranstorno').value = (registro.pcdTranstorno || '').trim();
      document.getElementById('edit_encaminhamento').value = registro.encaminhamento || '';
      document.getElementById('edit_cmeiEmef').value = registro.cmeiEmef || '';
      document.getElementById('edit_regiao').value = registro.regiao || '';
      document.getElementById('edit_responsavelRegistro').value = registro.responsavelRegistro || '';
      
      // Preenche campos adicionais (radio buttons)
      // Fonte Escola
      const fonteEscolaValue = (registro.fonteEscola || '').trim();
      // Foi um membro familiar?
      let foiMembroFamiliarValue = '';
      if (registro.hasOwnProperty('foiMembroFamiliar')) {
        foiMembroFamiliarValue = (registro.foiMembroFamiliar || '').toString().trim();
      }
      let foiMembroFamiliarRadioValue = '';
      if (['Sim', 'S', 'sim', 's'].includes(foiMembroFamiliarValue)) {
        foiMembroFamiliarRadioValue = 'Sim';
      } else if (['N√£o', 'N', 'nao', 'n√£o', 'n'].includes(foiMembroFamiliarValue)) {
        foiMembroFamiliarRadioValue = 'N√£o';
      } else if (foiMembroFamiliarValue === '' || foiMembroFamiliarValue === 'N√£o informado' || foiMembroFamiliarValue === undefined) {
        foiMembroFamiliarRadioValue = '';
      } else {
        foiMembroFamiliarRadioValue = '';
      }
      // Limpa sele√ß√£o anterior
      document.querySelectorAll('input[name="edit_foiMembroFamiliar"]').forEach(radio => radio.checked = false);
      // Marca a op√ß√£o correta
      const foiMembroFamiliarRadio = document.querySelector(`input[name="edit_foiMembroFamiliar"][value="${foiMembroFamiliarRadioValue}"]`);
      if (foiMembroFamiliarRadio) foiMembroFamiliarRadio.checked = true;
      // Debug
      console.log('[gerenciar] Campo foiMembroFamiliar preenchido com:', foiMembroFamiliarValue, '| Radio selecionado:', foiMembroFamiliarRadioValue);
      const fonteEscolaRadio = document.querySelector(`input[name="edit_fonteEscola"][value="${fonteEscolaValue}"]`);
      if (fonteEscolaRadio) fonteEscolaRadio.checked = true;
      
      // Viol√™ncia Escola Ocorreu
      const violenciaEscolaValue = (registro.violenciaEscolaOcorreu || '').trim();
      const violenciaEscolaRadio = document.querySelector(`input[name="edit_violenciaEscolaOcorreu"][value="${violenciaEscolaValue}"]`);
      if (violenciaEscolaRadio) violenciaEscolaRadio.checked = true;
      
      // Profissional Autor
      const profissionalAutorValue = (registro.profissionalAutor || '').trim();
      const profissionalAutorRadio = document.querySelector(`input[name="edit_profissionalAutor"][value="${profissionalAutorValue}"]`);
      if (profissionalAutorRadio) profissionalAutorRadio.checked = true;
      
      // Estudante Autor
      const estudanteAutorValue = (registro.estudanteAutor || '').trim();
      const estudanteAutorRadio = document.querySelector(`input[name="edit_estudanteAutor"][value="${estudanteAutorValue}"]`);
      if (estudanteAutorRadio) estudanteAutorRadio.checked = true;
      
      // Viol√™ncia N√£o Escola
      const violenciaNaoEscolaValue = (registro.violenciaNaoEscola || '').trim();
      const violenciaNaoEscolaRadio = document.querySelector(`input[name="edit_violenciaNaoEscola"][value="${violenciaNaoEscolaValue}"]`);
      if (violenciaNaoEscolaRadio) violenciaNaoEscolaRadio.checked = true;
      
      // Ocorreu Escola
      const ocorreuEscolaValue = (registro.ocorreuEscola || '').trim();
      const ocorreuEscolaRadio = document.querySelector(`input[name="edit_ocorreuEscola"][value="${ocorreuEscolaValue}"]`);
      if (ocorreuEscolaRadio) ocorreuEscolaRadio.checked = true;
      
      // Viol√™ncia Informada
      const violenciaInformadaValue = (registro.violenciaInformada || '').trim();
      const violenciaInformadaRadio = document.querySelector(`input[name="edit_violenciaInformada"][value="${violenciaInformadaValue}"]`);
      if (violenciaInformadaRadio) violenciaInformadaRadio.checked = true;
      
      // Estudo de Caso
      const estudoCasoValue = (registro.estudoCaso || '').trim();
      const estudoCasoRadio = document.querySelector(`input[name="edit_estudoCaso"][value="${estudoCasoValue}"]`);
      if (estudoCasoRadio) estudoCasoRadio.checked = true;
      
      // Preenche campo pcdDetalhes e configura exibi√ß√£o condicional
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesValue = registro.pcdDetalhes || '';
      
      // Limpa transtornos anteriores e popula com os do registro
      editTranstornosSelecionados = [];
      if (pcdDetalhesValue) {
        // Separa por v√≠rgula e depois por barra para processar corretamente
        const transtornos = pcdDetalhesValue
          .split(',')
          .flatMap(t => t.split('/'))
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTranstornosSelecionados = transtornos;
      }
      renderizarTagsTranstornosEdit();
      
      // Preenche campo racaCor (select simples)
      const racaCorValue = (registro.racaCor || '').trim();
      document.getElementById('edit_racaCor').value = racaCorValue;
      console.log('[gerenciar] Campo racaCor preenchido com:', racaCorValue);
      
      // Preenche campo orientacaoSexual (select simples)
      const orientacaoSexualValue = (registro.orientacaoSexual || '').trim();
      document.getElementById('edit_orientacaoSexual').value = orientacaoSexualValue;
      console.log('[gerenciar] Campo orientacaoSexual preenchido com:', orientacaoSexualValue);
      
      // Preenche campo tipoViolencia (M√öLTIPLAS TAGS)
      editTiposViolenciaSelecionados = [];
      const tipoViolenciaValue = registro.tipoViolencia || '';
      if (tipoViolenciaValue) {
        const tipos = tipoViolenciaValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTiposViolenciaSelecionados = tipos;
      }
      renderizarTagsTipoViolenciaEdit();
      console.log('[gerenciar] Tipos de viol√™ncia carregados:', editTiposViolenciaSelecionados);
      
      // Preenche campo tipoViolenciaInstitucional (M√öLTIPLAS TAGS - CONDICIONAL)
      editTiposViolenciaInstitucionalSelecionados = [];
      const tipoViolenciaInstitucionalValue = registro.tipoViolenciaInstitucional || '';
      if (tipoViolenciaInstitucionalValue) {
        const tiposInst = tipoViolenciaInstitucionalValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTiposViolenciaInstitucionalSelecionados = tiposInst;
      }
      renderizarTagsTipoViolenciaInstitucionalEdit();
      // Verifica se deve mostrar o campo de viol√™ncia institucional
      verificarViolenciaInstitucionalEdit();
      console.log('[gerenciar] Tipos de viol√™ncia institucional carregados:', editTiposViolenciaInstitucionalSelecionados);
      
      // Preenche campo encaminhamento com sistema de tags
      editEncaminhamentosSelecionados = [];
      const encaminhamentoValue = registro.encaminhamento || '';
      if (encaminhamentoValue) {
        const encaminhamentos = encaminhamentoValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editEncaminhamentosSelecionados = encaminhamentos;
      }
      renderizarTagsEncaminhamentoEdit();
      console.log('[gerenciar] Encaminhamentos carregados:', editEncaminhamentosSelecionados);
      
      // Preenche campo CMEI/EMEF com autocomplete
      // Preenche campo CMEI/EMEF com autocomplete
const cmeiEmefValue = registro.cmeiEmef || '';
if (cmeiEmefValue) {
  // Detecta o tipo de institui√ß√£o a partir do nome
  const tipoDetectado = cmeiEmefValue.startsWith('CMEI') ? 'CMEI' : 'EMEF';
  
  // IMPORTANTE: Define uma flag para indicar que estamos CARREGANDO dados
  document.getElementById('edit_cmeiEmef').setAttribute('data-loading', 'true');
  
  // Preenche o tipo primeiro
  document.getElementById('edit_tipoInstituicao').value = tipoDetectado;
  
  // Habilita o campo e filtra institui√ß√µes
  edit_tipoInstituicaoSelecionado = tipoDetectado;
  edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === tipoDetectado);
  document.getElementById('edit_cmeiEmef').disabled = false;
  document.getElementById('edit_cmeiEmef').placeholder = 'Digite para buscar...';
  
  // CR√çTICO: Preenche o valor AP√ìS configurar tudo
  document.getElementById('edit_cmeiEmef').value = cmeiEmefValue;
  
  // Remove a flag ap√≥s um pequeno delay
  setTimeout(() => {
    document.getElementById('edit_cmeiEmef').removeAttribute('data-loading');
  }, 100);
  
  console.log('[gerenciar] CMEI/EMEF carregado:', cmeiEmefValue, 'Tipo:', tipoDetectado);
}
      // Preenche campo regi√£o (select)
      const regiaoValue = (registro.regiao || '').trim();
      document.getElementById('edit_regiao').value = regiaoValue;
      console.log('[gerenciar] Regi√£o preenchida com:', regiaoValue);
      
      // Mostra/oculta o campo conforme o valor de PCD
      if (registro.pcdTranstorno === 'Sim') {
        pcdDetalhesContainer.classList.remove('hidden');
      } else {
        pcdDetalhesContainer.classList.add('hidden');
      }
      
      console.log('[gerenciar] Valores recebidos do backend:');
      console.log('[gerenciar]   - fonteEscola:', registro.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', registro.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', registro.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', registro.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', registro.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', registro.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', registro.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', registro.estudoCaso);
      console.log('[gerenciar]   - pcdDetalhes:', registro.pcdDetalhes);
      
      console.log('[gerenciar] Campo dataNT preenchido com:', document.getElementById('edit_dataNT').value);
      console.log('[gerenciar] Campo identidadeGenero preenchido com:', document.getElementById('edit_identidadeGenero').value);
      
      // Mostra o modal
      document.getElementById('modalEdicao').classList.add('show');
    }

    // ========================================
    // FECHAR MODAL
    // ========================================
    function fecharModal() {
      document.getElementById('modalEdicao').classList.remove('show');
    }

    // ========================================
    // SALVAR EDI√á√ÉO
    // ========================================
    document.getElementById('formEdicao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Valida√ß√£o: se PCD = Sim, deve ter pelo menos um transtorno
      const pcdTranstorno = document.getElementById('edit_pcdTranstorno').value;
      const pcdDetalhes = document.getElementById('edit_pcdDetalhes').value;
      
      if (pcdTranstorno === 'Sim' && (!pcdDetalhes || pcdDetalhes.trim() === '')) {
        mostrarAlerta('‚ö†Ô∏è Por favor, adicione pelo menos um transtorno/defici√™ncia quando marcar "Sim" em PCD/Transtorno.', 'error');
        document.getElementById('edit_pcdDetalhes-tags').classList.add('border-red-500');
        setTimeout(() => {
          document.getElementById('edit_pcdDetalhes-tags').classList.remove('border-red-500');
        }, 3000);
        return;
      }
      
      const dados = {
        action: 'update',
        linha: document.getElementById('edit_linha').value,
        criancaEstudante: document.getElementById('edit_criancaEstudante').value,
        dataNT: document.getElementById('edit_dataNT').value,
        idade: document.getElementById('edit_idade').value,
        identidadeGenero: document.getElementById('edit_identidadeGenero').value,
        pcdTranstorno: document.getElementById('edit_pcdTranstorno').value,
        pcdDetalhes: document.getElementById('edit_pcdDetalhes').value,
        racaCor: document.getElementById('edit_racaCor').value,
        orientacaoSexual: document.getElementById('edit_orientacaoSexual').value,
        tipoViolencia: document.getElementById('edit_tipoViolencia').value,
        tipoViolenciaInstitucional: document.getElementById('edit_tipoViolenciaInstitucional').value,
        encaminhamento: document.getElementById('edit_encaminhamento').value,
        cmeiEmef: document.getElementById('edit_cmeiEmef').value,
        regiao: document.getElementById('edit_regiao').value,
        responsavelRegistro: document.getElementById('edit_responsavelRegistro').value,
        // Campos adicionais (radio buttons)
        fonteEscola: document.querySelector('input[name="edit_fonteEscola"]:checked')?.value || '',
        violenciaEscolaOcorreu: document.querySelector('input[name="edit_violenciaEscolaOcorreu"]:checked')?.value || '',
        profissionalAutor: document.querySelector('input[name="edit_profissionalAutor"]:checked')?.value || '',
        estudanteAutor: document.querySelector('input[name="edit_estudanteAutor"]:checked')?.value || '',
        violenciaNaoEscola: document.querySelector('input[name="edit_violenciaNaoEscola"]:checked')?.value || '',
        ocorreuEscola: document.querySelector('input[name="edit_ocorreuEscola"]:checked')?.value || '',
        violenciaInformada: document.querySelector('input[name="edit_violenciaInformada"]:checked')?.value || '',
        estudoCaso: document.querySelector('input[name="edit_estudoCaso"]:checked')?.value || ''
      };
      
      console.log('[gerenciar] === DADOS DE ATUALIZA√á√ÉO ===');
      console.log('[gerenciar] Campos de viol√™ncia sendo enviados:');
      console.log('[gerenciar]   - tipoViolencia:', dados.tipoViolencia);
      console.log('[gerenciar]   - tipoViolenciaInstitucional:', dados.tipoViolenciaInstitucional);
      console.log('[gerenciar] Campos adicionais sendo enviados:');
      console.log('[gerenciar]   - pcdDetalhes:', dados.pcdDetalhes);
      console.log('[gerenciar]   - fonteEscola:', dados.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', dados.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', dados.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', dados.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', dados.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', dados.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', dados.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', dados.estudoCaso);
      console.log('[gerenciar] Payload completo:', JSON.stringify(dados));
      
      mostrarAlerta('üîÑ Salvando altera√ß√µes...', 'info');
      enviarAtualizacao(dados);
    });

    function enviarAtualizacao(dados) {
      console.log('[gerenciar] enviarAtualizacao chamado');
      console.log('[gerenciar] Dados a enviar:', dados);
      
      // Cria iframe oculto
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      
      // Listener para resposta
      const messageHandler = function(event) {
        // Aceita APENAS mensagens do Google Apps Script com resposta v√°lida
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          return;
        }
        
        console.log('[gerenciar] Resposta de atualiza√ß√£o:', event.data);
        
        if (event.data && event.data.success) {
          console.log('[gerenciar] Atualiza√ß√£o conclu√≠da!');
          fecharModal();
          mostrarAlerta('‚úÖ Registro atualizado com sucesso!', 'success');
          setTimeout(() => carregarRegistros(true), 300);
        } else {
          mostrarAlerta('‚ùå Erro: ' + (event.data?.message || 'Falha ao atualizar'), 'error');
        }
        
        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };
      
      window.addEventListener('message', messageHandler);
      
      // Cria formul√°rio para enviar via POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name = 'frame_' + Date.now();
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);
      
      document.body.appendChild(iframe);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 100);
      
      // Timeout de seguran√ßa
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        iframe.remove();
      }, 10000);
    }

    // ========================================
    // CONFIRMAR EXCLUS√ÉO
    // ========================================
    function confirmarExclusao(linha, nome) {
      const confirmacao = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO - EXCLUS√ÉO PERMANENTE\n\n` +
        `Deseja realmente EXCLUIR o registro de:\n` +
        `"${nome}"\n\n` +
        `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
        `Clique em OK para confirmar a exclus√£o.`
      );
      
      if (confirmacao) {
        mostrarAlerta('üîÑ Excluindo registro...', 'info');
        excluirRegistro(linha);
      }
    }

    function excluirRegistro(linha) {
      console.log('[gerenciar] Excluindo registro da linha:', linha);

      const dados = {
        action: 'delete',
        linha: linha.toString()
      };

      // Envio por POST via iframe oculto (mesma estrat√©gia dos demais fluxos)
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.id = 'iframe-excluir-registro-' + Date.now();

      const messageHandler = function(event) {
        // Aceita apenas mensagens do Apps Script com campo de sucesso
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          return;
        }

        console.log('[excluirRegistro] Resposta:', event.data);

        if (event.data.success) {
          mostrarAlerta('üóëÔ∏è Registro exclu√≠do com sucesso!', 'success');
          setTimeout(() => carregarRegistros(true), 300);
        } else {
          const mensagem = event.data.message || 'Falha ao excluir';
          mostrarAlerta('‚ùå Erro: ' + mensagem, 'error');
        }

        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };

      window.addEventListener('message', messageHandler);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name = 'frame_' + Date.now();

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);

      document.body.appendChild(iframe);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 100);

      // Timeout de seguran√ßa
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        iframe.remove();
        mostrarAlerta('‚è±Ô∏è Timeout ao excluir. O servidor pode estar lento. Tente novamente.', 'error');
      }, 30000);
    }

    // ========================================
    // VERIFICAR AUTENTICA√á√ÉO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');
      
      // Se n√£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! Fa√ßa login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }
    }

    // ========================================
    // EXPANDIR/RECOLHER FILTROS AVAN√áADOS
    // ========================================
    function toggleFiltrosAvancados() {
      const section = document.getElementById('filtrosAvancadosSection');
      const icon = document.getElementById('toggleFiltrosIcon');
      
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.textContent = '‚ñ≤';
      } else {
        section.classList.add('hidden');
        icon.textContent = '‚ñº';
      }
    }
    
    // Expandir se√ß√£o individual de filtro
    // ========================================
    // CONTROLE CONDICIONAL DE VIOL√äNCIA INSTITUCIONAL
    // ========================================
    function verificarViolenciaInstitucionalFiltro() {
      const checkboxes = document.querySelectorAll('.filter-tipoviolencia');
      const secaoInstitucional = document.getElementById('section-tipoViolenciaInstitucional');
      
      // Verifica se algum checkbox de "Institucional" est√° marcado
      let temInstitucional = false;
      checkboxes.forEach(checkbox => {
        if (checkbox.checked && checkbox.value.toLowerCase().includes('institucional')) {
          temInstitucional = true;
        }
      });
      
      // Mostra ou esconde a se√ß√£o de Tipo de Viol√™ncia Institucional
      if (temInstitucional) {
        secaoInstitucional.classList.remove('hidden');
        secaoInstitucional.classList.add('show');
      } else {
        secaoInstitucional.classList.add('hidden');
        secaoInstitucional.classList.remove('show');
        // Desmarca todos os checkboxes de viol√™ncia institucional quando esconder
        const checkboxesInst = document.querySelectorAll('#filterTipoViolenciaInstitucionalContainer input[type="checkbox"]');
        checkboxesInst.forEach(cb => {
          cb.checked = false;
        });
      }
    }
    
    // ========================================
    // ABRIR/FECHAR SE√á√ÉO DE FILTRO (igual ao painel-casos.html)
    // ========================================
    function openFilterSection(filterName) {
      const panel = document.getElementById('advancedPanel');
      const section = document.getElementById(`section-${filterName}`);
      const card = document.querySelector(`[data-filter="${filterName}"]`);
      
      // Se a se√ß√£o j√° est√° vis√≠vel, esconde
      if (section.classList.contains('show')) {
        section.classList.remove('show');
        section.classList.add('hidden');
        card.classList.remove('active');
        
        // Se todas as se√ß√µes est√£o escondidas, fecha o painel
        const visibleSections = document.querySelectorAll('.filter-section.show');
        if (visibleSections.length === 0) {
          panel.classList.remove('open');
        }
      } else {
        // Abre o painel se estiver fechado
        if (!panel.classList.contains('open')) {
          panel.classList.add('open');
        }
        
        // Mostra a se√ß√£o
        section.classList.remove('hidden');
        section.classList.add('show');
        card.classList.add('active');
        
        // Scroll suave at√© a se√ß√£o
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }
    
    // ========================================
    // LIMPAR TODOS OS FILTROS
    // ========================================
    function limparFiltros() {
      // Limpar campos de busca
      document.getElementById('campoBusca').value = '';
      document.getElementById('filtroMembroFamiliar').value = 'todos';
      
      // Limpar inputs de texto
      document.getElementById('filterEscola').value = '';
      document.getElementById('filterIdadeMin').value = '';
      document.getElementById('filterIdadeMax').value = '';
      
      // Limpar selects
      const selectores = ['filterOcorreuEscola', 'filterEstudoCaso'];
      selectores.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.value = '';
      });
      
      // Limpar radios
      const radioGroups = ['tipoInstituicaoRadio', 'generoRadio', 'pcdRadio', 'membroRadio'];
      radioGroups.forEach(name => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
          radio.checked = false;
        });
      });
      
      // Limpar checkboxes dos filtros customizados
      document.querySelectorAll('.filter-checkbox-gerenciar').forEach(cb => {
        cb.checked = false;
      });
      
      // Esconder se√ß√£o de viol√™ncia institucional
      const secaoInstitucional = document.getElementById('section-tipoViolenciaInstitucional');
      if (secaoInstitucional) {
        secaoInstitucional.classList.add('hidden');
        secaoInstitucional.classList.remove('show');
      }
      
      // Recarregar tabela com todos os registros
      filtrarTabela();
      mostrarAlerta('‚úÖ Filtros limpos com sucesso!', 'success');
    }
    
    // ========================================
    // POPULAR OP√á√ïES DOS SELECTS (ao carregar registros)
    // ========================================
    function popularFiltrosAvancados() {
      // Coletar valores √∫nicos de cada campo
      const regioes = [...new Set(registrosCache.map(r => r.regiao).filter(v => v))].sort();
      
      // IMPORTANTE: tipoViolencia = APENAS COLUNA J (n√£o incluir viol√™ncia institucional aqui)
      const tiposViolencia = [...new Set(registrosCache.map(r => r.tipoViolencia).filter(v => v))].sort();
      
      // SEPARADO: tipoViolenciaInstitucional = APENAS COLUNA K (condicional)
      const tiposViolenciaInstitucional = [...new Set(
        registrosCache
          .map(r => r.tipoViolenciaInstitucional)
          .filter(v => v)
      )].sort();
      
      const racas = [...new Set(registrosCache.map(r => r.racaCor).filter(v => v))].sort();
      
      // Popular Regi√£o (checkboxes)
      const regiaoContainer = document.getElementById('filterRegiaoContainer');
      regiaoContainer.innerHTML = regioes.map(r => `
        <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
          <input type="checkbox" value="${r}" onchange="filtrarTabela()" class="filter-checkbox-gerenciar w-4 h-4">
          <span class="text-sm font-medium">${r}</span>
        </label>
      `).join('');
      
      // Popular Tipo de Viol√™ncia (checkboxes) - APENAS COLUNA J
      // Adiciona evento para controlar visibilidade de Viol√™ncia Institucional
      const tipoViolenciaContainer = document.getElementById('filterTipoViolenciaContainer');
      tipoViolenciaContainer.innerHTML = tiposViolencia.map(t => `
        <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
          <input type="checkbox" value="${t}" onchange="filtrarTabela(); verificarViolenciaInstitucionalFiltro()" class="filter-checkbox-gerenciar filter-tipoviolencia w-4 h-4">
          <span class="text-sm font-medium">${t}</span>
        </label>
      `).join('');
      
      // Popular Tipo de Viol√™ncia Institucional (checkboxes) - APENAS COLUNA K
      const tipoViolenciaInstitucionalContainer = document.getElementById('filterTipoViolenciaInstitucionalContainer');
      if (tiposViolenciaInstitucional.length > 0) {
        tipoViolenciaInstitucionalContainer.innerHTML = tiposViolenciaInstitucional.map(t => `
          <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
            <input type="checkbox" value="${t}" onchange="filtrarTabela()" class="filter-checkbox-gerenciar w-4 h-4">
            <span class="text-sm font-medium">${t}</span>
          </label>
        `).join('');
      } else {
        tipoViolenciaInstitucionalContainer.innerHTML = '<p class="text-sm text-gray-500">Nenhum tipo de viol√™ncia institucional cadastrado</p>';
      }
      
      // Popular Ra√ßa/Cor (checkboxes)
      const racaContainer = document.getElementById('filterRacaContainer');
      racaContainer.innerHTML = racas.map(r => `
        <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
          <input type="checkbox" value="${r}" onchange="filtrarTabela()" class="filter-checkbox-gerenciar w-4 h-4">
          <span class="text-sm font-medium">${r}</span>
        </label>
      `).join('');
      
      // Inicializa verifica√ß√£o de viol√™ncia institucional
      verificarViolenciaInstitucionalFiltro();
    }

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = document.getElementById('menuIcon');
      mobileMenu.classList.toggle('show');
      menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
    }
    
    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = document.getElementById('menuIcon');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          menuIcon.style.transform = 'rotate(0deg)';
        }
      }
    });

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');
      
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (btnSair) {
          btnSair.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
        if (btnSairMobile) {
          btnSairMobile.classList.remove('hidden');
        }
      }
    }

    // ========================================
    // FUN√á√ÉO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // Inicializa ao carregar p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      // Fecha o menu mobile ao clicar em qualquer link
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = document.getElementById('menuIcon');
          if (mobileMenu && menuIcon) {
            mobileMenu.classList.remove('show');
            menuIcon.style.transform = 'rotate(0deg)';
          }
        });
      });
      
      verificarAutenticacao();
      verificarMenuAdmin();
      carregarRegistros(); // Carrega os registros automaticamente
    });
  </script>

</body>
</html>
