<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Registros - Violência Escolar</title>

  <!-- Esconde conteúdo IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }

    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
    }
  </style>

  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">

  <!-- Configuração Centralizada -->
  <script src="config.js?v=2"></script>

  <!-- Sistema de Cache e Notificações -->
  <link rel="stylesheet" href="assets/css/update-notification.css">
  <script src="assets/js/utils/data-cache.js"></script>
  <script src="assets/js/utils/change-detector.js"></script>
  <script src="assets/js/utils/update-notification.js"
    onerror="(function(){try{console.warn('[Init] Falha ao carregar update-notification.js; tentando fallback');var s=document.createElement('script');s.src='/FormularioRegistroV2/assets/js/utils/update-notification.js';s.onload=function(){console.log('[Init] UpdateNotification carregado via fallback');};s.onerror=function(){console.error('[Init] Fallback também falhou para update-notification.js');};document.head.appendChild(s);}catch(e){console.error('[Init] Erro ao tentar fallback do update-notification.js',e);}}())"></script>

  <!-- Sistema de API e Segurança -->
  <script src="assets/js/utils/security.js"></script>
  <script src="assets/js/utils/api.js"></script>

  <!-- Sistema de Transições entre Páginas -->
  <script src="assets/js/utils/page-transitions.js"></script>

  <!-- Sistema de Loading Indicator Elegante -->
  <script src="assets/js/utils/loading-indicator.js"></script>

  <!-- Sistema de Navegação por Perfil -->
  <script src="assets/js/utils/navigation.js"></script>

  <!-- Sistema de Escolas por Técnico -->
  <script src="assets/js/utils/escolas-tecnico.js"></script>

  <!-- Intro.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
  <!-- Onboarding CSS -->
  <link rel="stylesheet" href="assets/css/onboarding.css">

  <!-- Validação do CONFIG -->
  <script>
    // Verifica se CONFIG foi carregado
    if (typeof CONFIG === 'undefined') {
      alert('ERRO CRITICO: Arquivo config.js nao foi carregado!\n\nRecarregue a pagina com Ctrl+F5');
      throw new Error('CONFIG nao definido - config.js nao carregado');
    }
    console.log('[Config] CONFIG carregado com sucesso');

    // Verifica acesso usando o sistema de navegacao por perfil
    // Permitido: estagiario, user, superuser, tecnico (restrito)
    document.addEventListener('DOMContentLoaded', function () {
      // INICIALIZAÇÃO DE FLAG DE RELOAD OTIMIZADO
      // Define como false por padrão. Só será true se houver sucesso no salvamento.
      try {
        sessionStorage.setItem('NOTIFICATIONS_RELOAD_REQUIRED', 'false');
        console.log('[Init] Flag de reload resetada para false');
      } catch (e) {
        console.warn('Erro ao definir flag de reload:', e);
      }

      const rolesPermitidos = ['estagiario', 'user', 'superuser', 'tecnico'];

      if (window.NAVMNavigation) {
        // Verifica acesso e renderiza menus
        if (!window.NAVMNavigation.verificarAcesso(rolesPermitidos)) {
          return; // Sera redirecionado
        }
        window.NAVMNavigation.renderMenus();
      } else {
        // Fallback caso navigation.js nao carregue
        const role = sessionStorage.getItem('userRole');
        if (!role) {
          window.location.href = 'index.html';
          return;
        }
        if (!rolesPermitidos.includes(role)) {
          alert('Voce nao tem permissao para acessar esta pagina.');
          window.location.href = 'painel-casos.html';
          return;
        }
      }

      // LÓGICA DE DUAL MODE PARA TÉCNICOS
      const userRole = sessionStorage.getItem('userRole');
      if (userRole === 'tecnico') {
        console.log('🔒 [Dual Mode] Técnico detectado. Ativando modo restrito.');

        // 1. Esconde o painel principal (tabela, filtros, etc)
        const painelConteudo = document.getElementById('painel-conteudo');
        if (painelConteudo) {
          painelConteudo.style.display = 'none';
        }

        // 2. Verifica se está tentando editar algo
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('editar');

        if (!editId) {
          // Se não tiver ID, chuta de volta para a lista deles
          alert('Acesso restrito: Você só pode acessar esta página para editar uma notificação específica.');
          window.location.href = 'minhas-notificacoes.html';
          return;
        }

        // 3. Mostra um feedback visual de carregamento
        // Criamos um overlay simples pois o LoadingIndicator pode ainda não estar pronto
        const overlay = document.createElement('div');
        overlay.id = 'tecnico-loader-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;';
        overlay.innerHTML = `
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
          <h2 class="text-xl font-semibold text-gray-700">Carregando Editor...</h2>
          <p class="text-gray-500">Aguarde enquanto preparamos o formulário.</p>
        `;
        document.body.appendChild(overlay);

        // 4. Aguarda o sistema carregar para abrir o modal
        // O script principal do gerenciar-casos já tem lógica para ler ?editar= e abrir o modal.
        // O nosso trabalho aqui é garantir que o painel continue escondido e o modal abra.

        // Monitora a abertura do modal para remover o loader
        const checkModalInterval = setInterval(() => {
          const modalEdicao = document.getElementById('modalEdicao');
          const isVisible = modalEdicao && (modalEdicao.style.display === 'flex' || modalEdicao.classList.contains('show') || modalEdicao.style.display === 'block');

          if (isVisible) {
            // Modal abriu!
            clearInterval(checkModalInterval);
            const loader = document.getElementById('tecnico-loader-overlay');
            if (loader) loader.remove();
          }
        }, 500);

        // Timeout de segurança (15s)
        setTimeout(() => {
          clearInterval(checkModalInterval);
          const loader = document.getElementById('tecnico-loader-overlay');
          if (loader) {
            loader.innerHTML = `
                    <div class="text-red-500 text-6xl mb-4">⚠️</div>
                    <h2 class="text-xl font-semibold text-gray-700">Tempo limite excedido</h2>
                    <p class="text-gray-500">Não foi possível carregar o editor.</p>
                    <button onclick="window.location.href='minhas-notificacoes.html'" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Voltar</button>
                 `;
          }
        }, 15000);
      }
    });
  </script>

  <style>
    .alert {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .modal {
      display: none !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(0, 0, 0, 0.5) !important;
      backdrop-filter: blur(4px) !important;
      z-index: 99999 !important;
      animation: fadeIn 0.2s ease-out;
      overflow-y: auto !important;
    }

    .modal.show {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px !important;
    }

    .modal.show>div {
      animation: fadeInScale 0.3s ease-out;
      position: relative !important;
      margin: auto !important;
      max-width: 95vw !important;
      max-height: 95vh !important;
      width: auto !important;
    }

    /* Garantir que o body não tenha scroll quando modal estiver aberto */
    body.modal-open {
      overflow: hidden !important;
    }

    /* ========================================
       ESTILOS DO SISTEMA DE ABAS DO MODAL
       ======================================== */
    .tab-button {
      position: relative;
      transition: all 0.2s ease;
    }

    .tab-button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }

    .tab-button:hover:not(.active) {
      background-color: #f3f4f6;
      border-radius: 0.5rem 0.5rem 0 0;
    }

    .aba-conteudo {
      display: block;
      animation: fadeInTab 0.3s ease-in-out;
    }

    .aba-conteudo.hidden {
      display: none;
    }

    @keyframes fadeInTab {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Largura fixa do form de edição */
    #formEdicao {
      width: 882.719px !important;
      max-width: 882.719px !important;
      min-width: 882.719px !important;
      overflow-x: hidden !important;
      box-sizing: border-box !important;
    }

    /* Garantir quebra de texto dentro do form */
    #formEdicao .texto-atualizacao,
    #formEdicao .nome-arquivo,
    #formEdicao .anexo-nome,
    #formEdicao .descricao-notificacao,
    #formEdicao .observacao-texto,
    #formEdicao .comentario-texto {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      white-space: pre-wrap !important;
      max-width: 100% !important;
      overflow: hidden !important;
      display: block !important;
    }

    #formEdicao .anexo-nome,
    #formEdicao .nome-arquivo {
      word-break: break-all !important;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0.5rem;
    }

    table {
      min-width: 1000px;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Autocomplete Styles - Rich Design from registro-novo-caso.html */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      max-height: 250px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-header {
      font-size: 0.75rem;
      color: #6b7280;
      padding: 0.5rem 0.75rem;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 500;
    }

    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background-color: #eff6ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .autocomplete-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .autocomplete-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .autocomplete-nome {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .autocomplete-list::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-list::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .autocomplete-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .autocomplete-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    #filterEscolaSearch.autocomplete-open {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      min-height: 44px;
    }

    .selected-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      font-size: 12px;
      color: #374151;
      max-width: 100%;
    }

    .selected-tag-label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 52ch;
    }

    .selected-tag-remove {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      line-height: 1;
      cursor: pointer;
      flex-shrink: 0;
    }

    .selected-tag-remove:hover {
      background: #e5e7eb;
      color: #374151;
    }

    /* Animações do autocomplete */
    .autocomplete-list {
      z-index: 9999;
      will-change: transform, opacity;
      transform-origin: top;
    }

    .autocomplete-list.show {
      display: block;
      animation: autocompleteIn 160ms ease-out;
    }

    .autocomplete-list.hide {
      display: block;
      animation: autocompleteOut 140ms ease-in forwards;
    }

    @keyframes autocompleteIn {
      from {
        opacity: 0;
        transform: translateY(-6px) scale(0.985);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes autocompleteOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateY(-6px) scale(0.985);
      }
    }

    /* Radio Button Custom Animations */
    input[type="radio"].peer:checked~div {
      transform: scale(1.05);
      transition: all 0.2s ease-out;
    }

    input[type="radio"].peer~div {
      transition: all 0.2s ease-out;
    }

    /* ========================================
       ESTILOS DOS FILTROS (COPIADO DO PAINEL-CASOS.HTML)
       ======================================== */

    /* Cards de filtros clicáveis */
    .filter-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 80px;
      display: flex;
      align-items: center;
    }

    .filter-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .filter-card:hover::before {
      left: 100%;
    }

    .filter-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }

    .filter-card.active {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .filter-card-icon {
      transition: transform 0.3s ease;
    }

    .filter-card:hover .filter-card-icon {
      transform: scale(1.1) rotate(5deg);
    }

    .filter-card.active .filter-card-icon {
      transform: scale(1.15);
    }

    .badge-count {
      animation: badgePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      margin-left: 0.75rem;
      /* Espaçamento entre o texto e o badge */
    }

    @keyframes badgePop {
      0% {
        transform: scale(0);
      }

      50% {
        transform: scale(1.2);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Painel avançado colapsável */
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }

    .advanced-panel.open {
      max-height: 2000px;
      opacity: 1;
    }

    .filter-section.show {
      animation: slideDown 0.3s ease-out;
    }

    .toggle-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    /* Checkboxes personalizados elegantes */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .custom-checkbox:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
    }

    .custom-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      color: white;
      font-size: 12px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes checkPop {
      0% {
        transform: translate(-50%, -50%) scale(0);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }

      100% {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Animações para notificação de nova notificação */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }

      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Alerta inline para novas notificações */
    .alerta-novas-notificacoes {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid #fecaca;
      background: linear-gradient(90deg, #fff1f2, #ffe4e6);
      color: #b91c1c;
      box-shadow: 0 8px 20px rgba(248, 113, 113, 0.15);
      opacity: 0;
      transform: translateY(-20px);
    }

    .alerta-novas-notificacoes.show {
      display: flex;
      animation: alertaEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .alerta-novas-notificacoes.hide {
      animation: alertaExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes alertaEntrance {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes alertaExit {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Animação de shake para o contador quando é incrementado */
    @keyframes shakeCounter {

      0%,
      100% {
        transform: translateX(0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-4px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(4px);
      }
    }

    .alerta-novas-notificacoes .contador-shake {
      animation: shakeCounter 0.5s ease-in-out;
      display: inline-block;
    }

    /* Esconder botão CTA */
    .alerta-novas-notificacoes .cta {
      display: none;
    }

    .alerta-novas-notificacoes .cta:hover {
      display: none;
    }

    /* Animação de pulsar unificada (reutilizável) */
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
      }

      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }

    /* Classe genérica para pulsar (sem ID específico) */
    .btn-pulse-active {
      animation: pulse 2s infinite !important;
      transition: none !important;
    }

    .alerta-novas-notificacoes .close-btn {
      background: transparent;
      color: #b91c1c;
      padding: 6px;
      border-radius: 8px;
      transition: background 0.15s ease;
    }

    .alerta-novas-notificacoes .close-btn:hover {
      background: rgba(185, 28, 28, 0.08);
    }

    /* Bloqueio quando toast está ativo */
    .alerta-novas-notificacoes.toast-blocking {
      pointer-events: none;
      opacity: 0.5;
    }


    /* ========================================
       NOTIFICAÇÃO ELEGANTE E COMPACTA
       ======================================== */
    .notificacao-nova-elegante {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 360px;
      max-width: calc(100vw - 40px);
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.05);
      z-index: 10000;
      overflow: hidden;
      opacity: 0;
      transform: translateX(100%) scale(0.95);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    }

    .notificacao-nova-elegante.notificacao-visible {
      animation: notificacaoEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .notificacao-nova-elegante.notificacao-exit {
      animation: notificacaoExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes notificacaoEntrance {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes notificacaoExit {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }
    }

    .notificacao-conteudo {
      position: relative;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: #ffffff;
    }

    .notificacao-icone-container {
      position: relative;
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eff6ff;
      border-radius: 8px;
      animation: notificacaoIconContainerPulse 2s ease-in-out infinite;
    }

    @keyframes notificacaoIconContainerPulse {

      0%,
      100% {
        background: #eff6ff;
        transform: scale(1);
      }

      50% {
        background: #dbeafe;
        transform: scale(1.05);
      }
    }

    .notificacao-icone {
      width: 20px;
      height: 20px;
      color: #3b82f6;
      animation: notificacaoIconEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes notificacaoIconEntrance {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }

      60% {
        transform: scale(1.2) rotate(10deg);
      }

      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .notificacao-texto {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .notificacao-titulo {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notificacao-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: #3b82f6;
      color: white;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-radius: 4px;
      flex-shrink: 0;
      animation: notificacaoBadgeEntrance 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes notificacaoBadgeEntrance {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      50% {
        transform: scale(1.15);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .notificacao-mensagem-principal {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.4;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.2s both;
    }

    @keyframes notificacaoTextFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notificacao-descricao {
      font-size: 12px;
      color: #64748b;
      line-height: 1.5;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.3s both;
    }

    .notificacao-acoes {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .notificacao-btn-atualizar {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.4s both;
    }

    @keyframes notificacaoButtonEntrance {
      from {
        opacity: 0;
        transform: translateX(10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notificacao-btn-atualizar:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .notificacao-btn-atualizar:active {
      transform: translateY(0);
    }

    .notificacao-btn-atualizar svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }

    .notificacao-btn-atualizar:hover svg {
      transform: rotate(180deg);
    }

    .notificacao-btn-fechar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.5s both;
    }

    .notificacao-btn-fechar:hover {
      background: #f1f5f9;
      color: #64748b;
      transform: rotate(90deg) scale(1.1);
    }

    .notificacao-progresso {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
      background-size: 200% 100%;
      width: 100%;
      transform-origin: left;
      animation: notificacaoProgresso 15s linear forwards, notificacaoProgressoShimmer 2s linear infinite;
    }

    @keyframes notificacaoProgresso {
      from {
        transform: scaleX(1);
      }

      to {
        transform: scaleX(0);
      }
    }

    @keyframes notificacaoProgressoShimmer {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 200% 50%;
      }
    }

    /* Responsivo */
    @media (max-width: 640px) {
      .notificacao-nova-elegante {
        width: calc(100vw - 32px);
        right: 16px;
        top: 16px;
      }

      .notificacao-conteudo {
        padding: 14px;
      }
    }

    .checkbox-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      font-size: 0.875rem;
    }

    .checkbox-container:hover .checkbox-label {
      color: #1e40af;
    }

    .checkbox-container {
      transition: all 0.2s ease;
    }

    .checkbox-container:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
    }

    /* Estado selecionado - visual óbvio */
    .checkbox-container:has(.custom-checkbox:checked) {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-color: #3b82f6;
      border-width: 2px;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .checkbox-container:has(.custom-checkbox:checked) .checkbox-label {
      color: #1e40af;
      font-weight: 600;
    }

    /* Estado desabilitado */
    .checkbox-container:has(.custom-checkbox:disabled) {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Grupos de Encaminhamento */
    .encaminhamento-group {
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      transition: all 0.3s ease;
      background: white;
    }

    .encaminhamento-group:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #e5e7eb;
    }

    .group-header:hover {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .group-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .group-checkbox-wrapper {
      display: flex;
      align-items: center;
    }

    .group-checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .group-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.9375rem;
    }

    .group-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      background: #2563eb;
      border-radius: 9999px;
      min-width: 1.5rem;
    }

    .group-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .group-body.expanded {
      max-height: 2000px;
    }

    .group-body-content {
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toggle-icon.rotated {
      transform: rotate(180deg);
    }

    .outros-detectados {
      border-color: #fbbf24;
      background: #fffbeb;
    }

    .outros-detectados .group-header {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    input[type="radio"].peer:active~div {
      transform: scale(0.98);
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }

      .desktop-menu {
        display: none !important;
      }

      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Tabela responsível */
    @media (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {

      button,
      a,
      input,
      select,
      textarea {
        min-height: 44px;
      }
    }

    /* ========================================
       ESTILOS DO LOADING INDICATOR ELEGANTE
       ======================================== */
    .indicador-carregamento-elegante {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 999999 !important;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .indicador-carregamento-elegante.show {
      opacity: 1;
      pointer-events: all;
    }

    .indicador-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1;
    }

    .indicador-conteudo {
      position: relative !important;
      z-index: 2 !important;
      background: white;
      padding: 3rem 3.5rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      min-width: 320px;
      max-width: 90vw;
      text-align: center;
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .indicador-spinner {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 1.5rem;
    }

    .spinner-ring {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 6px solid transparent;
      border-radius: 50%;
      animation: spinRing 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    }

    .spinner-ring:nth-child(1) {
      border-top-color: #3b82f6;
      animation-delay: 0s;
    }

    .spinner-ring:nth-child(2) {
      border-right-color: #8b5cf6;
      animation-delay: 0.2s;
    }

    .spinner-ring:nth-child(3) {
      border-bottom-color: #06b6d4;
      animation-delay: 0.4s;
    }

    @keyframes spinRing {
      0% {
        transform: rotate(0deg) scale(1);
      }

      50% {
        transform: rotate(180deg) scale(1.1);
      }

      100% {
        transform: rotate(360deg) scale(1);
      }
    }

    .indicador-texto {
      color: #1f2937;
    }

    .indicador-mensagem {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #111827;
    }

    .indicador-progresso {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .indicador-barra {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
      animation: gradientMove 2s ease infinite;
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .indicador-percentual {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
    }

    /* Destaque da linha editada */
    @keyframes highlightPulse {

      0%,
      100% {
        background-color: rgba(34, 197, 94, 0.2);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
      }

      50% {
        background-color: rgba(34, 197, 94, 0.35);
        box-shadow: 0 0 20px 5px rgba(34, 197, 94, 0.3);
      }
    }

    tr.highlight-edited {
      animation: highlightPulse 1.5s ease-in-out 2;
      background-color: rgba(34, 197, 94, 0.2) !important;
    }

    /* Botões de editar e excluir - sempre visíveis, sem piscada */
    .btn-editar,
    .btn-excluir {
      opacity: 1;
      pointer-events: auto;
      transition: all 0.2s ease-in-out;
    }

    /* Responsividade */
    @media (max-width: 480px) {
      .indicador-conteudo {
        padding: 2rem 2.5rem;
        min-width: 280px;
      }

      .indicador-spinner {
        width: 90px;
        height: 60px;
      }

      .indicador-mensagem {
        font-size: 1rem;
      }
    }

    /* ========================================
       MODAL DE CONFIRMAÇÃO DE EXCLUSÃO
       ======================================== */
    .confirm-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 100000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease-out;
    }

    .confirm-modal-overlay.active {
      display: flex;
    }

    .confirm-modal {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
    }

    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .confirm-modal-header {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      padding: 24px;
      text-align: center;
    }

    .confirm-modal-icon {
      font-size: 48px;
      margin-bottom: 8px;
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .confirm-modal-title {
      color: white;
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .confirm-modal-body {
      padding: 24px;
    }

    .confirm-modal-message {
      font-size: 15px;
      color: #374151;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .confirm-modal-details {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-left: 4px solid #dc2626;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .confirm-modal-details-title {
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .confirm-modal-details-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .confirm-modal-details-list li {
      padding: 6px 0;
      color: #7f1d1d;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .confirm-modal-details-list li::before {
      content: '🗑️';
      font-size: 14px;
    }

    .confirm-modal-warning {
      background: #fff7ed;
      border: 2px solid #fdba74;
      border-radius: 8px;
      padding: 12px 16px;
      color: #9a3412;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
    }

    .confirm-modal-buttons {
      display: flex;
      gap: 12px;
    }

    .confirm-modal-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .confirm-modal-btn-cancel {
      background: #f3f4f6;
      color: #374151;
    }

    .confirm-modal-btn-cancel:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .confirm-modal-btn-confirm {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .confirm-modal-btn-confirm:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }

    .confirm-modal-btn-confirm:active {
      transform: translateY(0);
    }

    @media (max-width: 480px) {
      .confirm-modal {
        max-width: 95%;
      }

      .confirm-modal-buttons {
        flex-direction: column-reverse;
      }

      .confirm-modal-btn {
        width: 100%;
      }
    }

    /* ============================================
       CORREÇÃO FILTROS - LAYOUT PARA CONTAINER MENOR
       ============================================ */

    /* Grid de 2 colunas para caber no container */
    #filtrosAvancadosSection .filters-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 0.75rem;
      position: relative;
      z-index: 20;
    }

    /* ============================================
       MODO PAINEL - CONTEÚDO ABRE EM ÁREA EXTERNA
       ============================================ */

    /* Esconde o conteúdo inline dos filtros (vai aparecer no painel externo) */
    details.filter-group[data-mode="panel"]>.filter-group-content {
      display: none !important;
    }

    /* Mostra o conteúdo quando movido para o painel externo */
    #advancedPanelContent .filter-group-content {
      display: block !important;
    }

    /* Card ativo quando filtro está aberto */
    details.filter-group.is-active {
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2), 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    /* Painel de conteúdo dos filtros */
    #advancedPanel {
      position: relative;
      z-index: 10;
    }

    /* Animações do conteúdo do painel */
    #advancedPanelContent {
      transition: opacity 450ms cubic-bezier(0.4, 0, 0.2, 1),
        transform 500ms cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    #advancedPanelContent.is-leaving {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
      transition: opacity 200ms cubic-bezier(0.4, 0, 1, 1),
        transform 200ms cubic-bezier(0.4, 0, 1, 1);
    }

    #advancedPanelContent.is-leaving-slow {
      opacity: 0;
      transform: translateY(-10px) scale(0.97);
      transition: opacity 400ms cubic-bezier(0.4, 0, 0.6, 1),
        transform 400ms cubic-bezier(0.4, 0, 0.6, 1);
    }

    #advancedPanelContent.is-entering {
      opacity: 0;
      transform: translateY(10px) scale(0.97);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
        transform 350ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Remove o chevron dos cards no modo painel */
    details.filter-group[data-mode="panel"] .filter-group-chevron {
      display: none !important;
    }

    /* Badge como sobreposição no card */
    details.filter-group[data-mode="panel"]>summary .filter-card-badge {
      position: absolute !important;
      top: 8px !important;
      right: 10px !important;
      z-index: 50 !important;
      pointer-events: none !important;
      display: none;
      align-items: center;
      justify-content: center;
      height: 18px !important;
      line-height: 18px !important;
      min-width: 18px !important;
      padding: 0 !important;
      border-radius: 9999px !important;
      font-size: 11px !important;
      font-weight: 600 !important;
      background: #2563eb !important;
      color: #ffffff !important;
      margin: 0 !important;
      border: 2px solid #ffffff !important;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12) !important;
    }

    /* Organização das categorias dentro do painel */
    #advancedPanelContent .filter-group-content>.px-4 {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #advancedPanelContent .filter-group-content>.px-4>div {
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
    }

    #advancedPanelContent .filter-group-content>.px-4>div>h4 {
      margin-bottom: 10px !important;
    }

    /* ============================================
       TOOLTIPS - OCULTOS POR PADRÃO
       ============================================ */
    .tooltip-trigger {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .tooltip-trigger:focus {
      outline: none;
    }

    .tooltip-popover {
      display: none;
      z-index: 50000;
    }

    .tooltip-trigger:hover .tooltip-popover,
    .tooltip-trigger:focus-within .tooltip-popover {
      display: block;
    }

    /* Tooltips menores e posicionamento corrigido */
    #filtrosAvancadosSection .tooltip-popover {
      left: 0 !important;
      transform: translateX(0) !important;
      right: auto;
    }

    #filtrosAvancadosSection .tooltip-popover>span:last-child {
      width: 14rem !important;
      max-width: 240px !important;
    }

    /* Sub-grid de filtros internos */
    #filtrosAvancadosSection .child-filters-grid,
    #advancedPanelContent .child-filters-grid {
      grid-template-columns: 1fr !important;
    }

    /* Mobile: coluna única */
    @media (max-width: 640px) {
      #filtrosAvancadosSection .filters-grid {
        grid-template-columns: 1fr !important;
      }
    }

    /* ============================================
       CARDS DE FILTROS INTERNOS (PERFIL, PCD, etc.)
       ============================================ */

    .child-filter-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }

    .child-filter-card.has-flyout {
      overflow: visible !important;
    }

    .child-filter-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
    }

    .child-filter-card-icon {
      width: 34px;
      height: 34px;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #ede9fe;
      color: #6d28d9;
      font-size: 16px;
      flex: none;
    }

    .child-filter-card-title {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      letter-spacing: 0.02em;
    }

    .child-filter-card-body {
      padding: 14px 16px 16px;
    }

    .child-filters-subgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 768px) {
      .child-filters-subgrid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 600;
      color: #6b7280;
      background: #f3f4f6;
      border-radius: 4px;
      margin-left: auto;
    }

    .conditional-indent {
      border-left: 3px solid #3b82f6;
      padding-left: 1rem;
      margin-left: 0.5rem;
    }

    /* ============================================
       CARDS DE TIPO DE VIOLÊNCIA
       ============================================ */

    /* Grid de cards de violência */
    #filterTipoViolenciaContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    @media (min-width: 768px) {
      #filterTipoViolenciaContainer {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }

    /* Card individual de tipo de violência */
    .violence-type-card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.875rem 0.5rem;
      min-height: 90px;
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      overflow: hidden;
    }

    .violence-type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--card-accent, #94a3b8) 0%, var(--card-accent-light, #cbd5e1) 100%);
      opacity: 0.6;
      transition: opacity 0.25s ease;
    }

    .violence-type-card:hover {
      border-color: #94a3b8;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08), 0 4px 8px rgba(15, 23, 42, 0.04);
    }

    .violence-type-card:hover::before {
      opacity: 1;
    }

    /* Estado selecionado */
    .violence-type-card.selected {
      background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
      border-color: #3b82f6;
      border-width: 2.5px;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12), 0 8px 20px rgba(59, 130, 246, 0.15);
    }

    .violence-type-card.selected::before {
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
      opacity: 1;
      height: 5px;
    }

    .violence-type-card.selected .violence-type-icon {
      transform: scale(1.1);
      filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
    }

    .violence-type-card.selected .violence-type-label {
      color: #1e40af;
      font-weight: 700;
    }

    .violence-type-card.selected .violence-type-check {
      opacity: 1;
      transform: scale(1);
    }

    /* Ícone do tipo */
    .violence-type-icon {
      font-size: 1.5rem;
      margin-bottom: 0.4rem;
      transition: transform 0.25s ease, filter 0.25s ease;
      line-height: 1;
    }

    /* Label do tipo */
    .violence-type-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #475569;
      line-height: 1.2;
      max-width: 100%;
      word-wrap: break-word;
      transition: color 0.2s ease, font-weight 0.2s ease;
    }

    /* Check mark no canto */
    .violence-type-check {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
      font-weight: bold;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
    }

    /* Input checkbox oculto */
    .violence-type-card input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 2;
    }

    /* Cores por tipo de violência */
    .violence-type-card[data-type="fisica"] {
      --card-accent: #ef4444;
      --card-accent-light: #fca5a5;
    }

    .violence-type-card[data-type="psicologica"] {
      --card-accent: #8b5cf6;
      --card-accent-light: #c4b5fd;
    }

    .violence-type-card[data-type="sexual"] {
      --card-accent: #ec4899;
      --card-accent-light: #f9a8d4;
    }

    .violence-type-card[data-type="negligencia"] {
      --card-accent: #f97316;
      --card-accent-light: #fdba74;
    }

    .violence-type-card[data-type="institucional"] {
      --card-accent: #0ea5e9;
      --card-accent-light: #7dd3fc;
    }

    .violence-type-card[data-type="bullying"] {
      --card-accent: #eab308;
      --card-accent-light: #fde047;
    }

    .violence-type-card[data-type="cyberbullying"] {
      --card-accent: #06b6d4;
      --card-accent-light: #67e8f9;
    }

    .violence-type-card[data-type="autolesao"] {
      --card-accent: #6366f1;
      --card-accent-light: #a5b4fc;
    }

    .violence-type-card[data-type="outros"] {
      --card-accent: #64748b;
      --card-accent-light: #94a3b8;
    }

    /* ============================================
       SUBGRUPO VIOLÊNCIA INSTITUCIONAL
       ============================================ */

    .violence-conditional-section {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.04) 0%, rgba(14, 165, 233, 0.08) 100%);
      border: 1px solid rgba(14, 165, 233, 0.2);
      border-radius: 12px;
    }

    .violence-conditional-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }

    @media (min-width: 768px) {
      .violence-conditional-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }

    /* Mini cards para violência institucional */
    .violence-sub-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.625rem;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .violence-sub-card:hover {
      border-color: #0ea5e9;
      background: #f0f9ff;
    }

    .violence-sub-card.selected {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-color: #0ea5e9;
      border-width: 2px;
    }

    .violence-sub-card.selected .violence-sub-label {
      color: #0369a1;
      font-weight: 600;
    }

    .violence-sub-card.selected .violence-sub-check {
      opacity: 1;
      transform: scale(1);
    }

    .violence-sub-icon {
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .violence-sub-label {
      font-size: 0.7rem;
      color: #475569;
      font-weight: 500;
      line-height: 1.2;
      flex: 1;
    }

    .violence-sub-check {
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 8px;
      font-weight: bold;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      flex-shrink: 0;
    }

    .violence-sub-card input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 2;
    }

    /* Título da seção condicional */
    .violence-conditional-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(14, 165, 233, 0.2);
    }

    .violence-conditional-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #0369a1;
    }
  </style>

  <!-- Estilos para Anexos -->
  <link rel="stylesheet" href="assets/css/anexos.css">
  <link rel="stylesheet" href="assets/css/atualizacoes.css">

  <!-- Intro.js - Sistema de Onboarding -->
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <link rel="stylesheet" href="assets/css/onboarding.css">
</head>

<!-- ========================================
     VARIÁVEIS GLOBAIS DE CONTROLE
     ======================================== -->
<script>
  /**
   * Flag de Controle de Atualização
   * 
   * Propósito: Impedir que o ChangeDetector mostre a notificação vermelha
   * quando a atualização já foi disparada pela notificação azul.
   * 
   * Estados:
   *   false = usuário não iniciou atualização (alertas podem aparecer)
   *   true  = usuário clicou em "Carregar Registros" (alertas bloqueados)
   * 
   * Fluxo:
   *   1. ChangeDetector detecta mudança
   *   2. Verifica: se atualizacaoDisparadaPeloUsuario === true, não mostra nada
   *   3. Usuário clica na notificação azul → seta como true
   *   4. carregarRegistros() executa → ao final, reseta como false
   */
  window.atualizacaoDisparadaPeloUsuario = false;
</script>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-50 min-h-screen font-sans antialiased">

  <!-- Modal de Confirmação de Exclusão -->
  <div id="confirmDeleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
      <div class="confirm-modal-header">
        <div class="confirm-modal-icon">⚠️</div>
        <h2 class="confirm-modal-title">Confirmação de Exclusão</h2>
      </div>
      <div class="confirm-modal-body">
        <div class="confirm-modal-message">
          <strong>Atenção!</strong> Você está prestes a excluir permanentemente o registro de:
          <div
            style="text-align: center; margin: 12px 0; padding: 8px; background: #f9fafb; border-radius: 8px; font-weight: 700; color: #1f2937;">
            "<span id="confirmDeleteNome"></span>"
          </div>
        </div>

        <div class="confirm-modal-details">
          <div class="confirm-modal-details-title">
            <span>🗑️</span>
            <span>Esta ação também deletará:</span>
          </div>
          <ul class="confirm-modal-details-list">
            <li>Todos os anexos associados</li>
            <li>Registros no banco de dados</li>
            <li>Arquivos no Google Drive</li>
            <li>Dados de rastreamento do sistema</li>
          </ul>
        </div>

        <div class="confirm-modal-warning">
          ⚠️ Esta ação NÃO pode ser desfeita!
        </div>

        <div class="confirm-modal-buttons">
          <button class="confirm-modal-btn confirm-modal-btn-cancel" onclick="fecharModalConfirmacao()">
            <span>✖️</span>
            <span>Cancelar</span>
          </button>
          <button id="btnConfirmarExclusao" class="confirm-modal-btn confirm-modal-btn-confirm">
            <span>🗑️</span>
            <span>Confirmar Exclusão</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação de Edição -->
  <div id="confirmEditModal" class="confirm-modal-overlay">
    <div class="confirm-modal" style="max-width: 860px;">
      <div class="confirm-modal-header">
        <div class="confirm-modal-icon">✅</div>
        <h2 class="confirm-modal-title">Confirmar Alterações</h2>
      </div>
      <div class="confirm-modal-body">
        <div class="confirm-modal-message">
          Revise as mudanças detectadas antes de salvar.
          <div id="confirmEditNome"
            style="text-align: center; margin: 12px 0; padding: 8px; background: #f9fafb; border-radius: 8px; font-weight: 700; color: #1f2937;">
          </div>
        </div>

        <div class="confirm-edit-summary">
          <span>Alteracoes:</span>
          <span id="confirmEditCount" class="confirm-edit-count">0</span>
        </div>

        <div id="confirmEditLista" class="confirm-edit-list"></div>

        <div class="confirm-modal-warning">
          Ao confirmar, as alteracoes serao salvas no registro.
        </div>

        <div class="confirm-modal-buttons">
          <button class="confirm-modal-btn confirm-modal-btn-cancel" onclick="fecharModalConfirmacaoEdicao()">
            <span>✖️</span>
            <span>Revisar</span>
          </button>
          <button id="btnConfirmarEdicao" class="confirm-modal-btn confirm-modal-btn-confirm"
            onclick="confirmarEdicaoSalvar()">
            <span>💾</span>
            <span>Confirmar e Salvar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="painel-conteudo" class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">

    <!-- Menu de Navegação -->
    <div data-tour="header" class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
      <div class="px-4 py-3">
        <!-- Botão Hamburguer (Mobile) -->
        <button onclick="toggleMobileMenu()"
          class="mobile-menu-button md:hidden w-full flex items-center justify-between text-white font-semibold">
          <span class="text-lg">📱 Menu</span>
          <svg id="menuIcon" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>

        <!-- Menu Desktop (renderizado dinamicamente por navigation.js) -->
        <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
          <!-- Menu sera renderizado por NAVMNavigation.renderMenus() -->
        </nav>

        <!-- Menu Mobile (Dropdown) -->
        <nav id="mobileMenuNav" class="mobile-menu mt-3">
          <div class="flex flex-col gap-2">
            <!-- Menu sera renderizado por NAVMNavigation.renderMenus() -->
          </div>
        </nav>
      </div>
    </div>

    <!-- Alerta de novas notificações -->
    <div id="alerta-novas-notificacoes" class="alerta-novas-notificacoes mb-4">
      <div class="flex items-center gap-3">
        <span class="text-lg">🔔</span>
        <div class="flex flex-col">
          <span class="font-semibold">Existem novas notificações!</span>
          <span class="text-sm text-rose-700">Clique em Carregar Registros para atualizar.</span>
        </div>
      </div>
    </div>

    <!-- Cabeçalho -->
    <div
      class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl shadow-xl border border-white/60 backdrop-blur-sm p-6 mb-6">
      <div class="flex items-center justify-center gap-4 mb-3">
        <div
          class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
          📋
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
          Gerenciar Registros
        </h1>
      </div>
      <p class="text-center text-gray-600">
        Visualize, edite ou exclua registros existentes
      </p>
    </div>

    <!-- Área de Alertas -->
    <div id="alertContainer"></div>

    <!-- Controles: Carregar e Buscar -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 items-stretch lg:items-center justify-between">
        <!-- Botão Carregar -->
        <div class="flex items-center gap-4">
          <button id="btnCarregar" onclick="carregarRegistros(false, null, null, false, true, true)"
            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition shadow-md hover:shadow-lg flex items-center gap-2">
            <span>🔄</span>
            <span>Carregar Registros</span>
          </button>
          <div id="loadingInfo" class="text-gray-600 text-sm font-medium"></div>
        </div>
        <!-- Campo de Busca e Filtro -->
        <div class="flex-1 flex flex-col sm:flex-row gap-2 max-w-2xl items-center justify-end">
          <div class="relative w-full sm:w-auto flex-1">
            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="campoBusca" placeholder="Buscar por nome da criança/estudante..."
              onkeyup="filtrarTabela()"
              class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
          <div class="w-full sm:w-auto">
            <select id="filtroMembroFamiliar" onchange="filtrarTabela()"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="todos">Todos: Membro Familiar?</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
              <option value="naoinformado">Não informado</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Botão para Expandir Filtros -->
      <div class="mt-4 flex gap-2">
        <button onclick="toggleFiltrosAvancados()"
          class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg font-semibold hover:from-indigo-600 hover:to-indigo-700 transition shadow-md hover:shadow-lg flex items-center gap-2">
          <span id="toggleFiltrosIcon">▼</span>
          <span>Mais Filtros</span>
        </button>
      </div>
    </div>

    <!-- FILTROS (ESTRUTURA IDÊNTICA AO PAINEL-CASOS.HTML) -->
    <section id="filtrosAvancadosSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">🔍 Filtros</h2>

      <!-- NOVO PAINEL DE FILTROS (único) -->
      <div id="quickAdvancedFiltersBox" class="mt-4">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-4 border border-gray-200 shadow-sm">
          <div class="filters-grid">

            <details id="filterGroupPeriodo"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">📅</div>
                  <span class="text-sm font-semibold text-gray-800">Período</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Filtro: Data Início -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">Data Início:</label>
                      <input type="date" id="filterDataInicio"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    </div>

                    <!-- Filtro: Data Fim -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">Data Fim:</label>
                      <input type="date" id="filterDataFim"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupContextoEscolar"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">🏫</div>
                  <span class="text-sm font-semibold text-gray-800">Escola / Contexto</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <!-- Região -->
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">📍 Região</h4>
                    <div id="filterRegiaoContainer"></div>
                  </div>

                  <!-- Tipo de Instituição -->
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">🏫 Tipo de
                      Instituição
                    </h4>
                    <div id="filterTipoInstituicaoContainer"></div>
                  </div>

                  <!-- Escola Específica -->
                  <div id="section-escola" class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">🏢 Escola
                      Específica
                    </h4>
                    <div class="autocomplete-wrapper mb-2">
                      <input type="text" id="filterEscolaSearch"
                        class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                        placeholder="Digite para buscar..." autocomplete="off">
                      <div class="autocomplete-list" id="filterEscolaAutocompleteList"></div>
                    </div>
                    <div id="filterEscolaSelectedTags" class="selected-tags mb-2"></div>
                    <p class="text-xs text-gray-500 mt-1.5">Digite para buscar e selecione uma instituição.</p>
                    <div id="filterEscolaContainer" style="display:none"></div>
                  </div>

                  <!-- Tempo Integral -->
                  <div id="section-ti" class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">⏱️ Tempo
                      Integral</h4>
                    <div class="flex gap-3 items-center">
                      <label class="text-sm font-medium text-gray-700">Filtrar por:</label>
                      <select id="filterTI"
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <option value="">Todos</option>
                        <option value="TI">Tempo Integral (TI)</option>
                        <option value="Regular">Tempo Regular (não TI)</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 2xl:grid-cols-3 gap-4">
                    <!-- Filtro: Fonte informada -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">O relato foi feito pela escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Fonte do
                                  relato</div>
                                <div class="leading-relaxed text-gray-800">Mostra quem iniciou o
                                  relato/notificação do
                                  caso. “Sim” significa que a própria escola identificou e
                                  registrou o caso (direção,
                                  coordenação, professores ou equipe). “Não” indica que o caso
                                  chegou à escola por outra
                                  fonte (ex.: família, estudante, serviços, instituições
                                  externas). Isso ajuda a
                                  interpretar como a escola tomou conhecimento do ocorrido.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterFonteInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência identificada pela escola ocorrida na escola (Coluna Q) -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Escola identificou que a violência ocorreu na
                            escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Local
                                  confirmado (na escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se, após
                                  apuração/verificação, foi
                                  confirmado que o fato ocorreu dentro do ambiente escolar (ex.:
                                  sala, pátio, banheiro,
                                  quadra). Este campo descreve o local do ocorrido — não a autoria
                                  — e ajuda a
                                  diferenciar situações internas da escola de situações externas
                                  acompanhadas pela
                                  escola.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaEscolaOcorreu" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência identificada não ocorrida na escola -->
                    <div>
                      <label class="block text-gray-700 font-medium text-sm" style="margin-bottom: 6px;">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Escola identificou que a violência NÃO ocorreu na
                            escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Local
                                  confirmado (fora da escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se, após
                                  verificação, foi confirmado
                                  que o fato ocorreu fora do ambiente escolar (ex.: residência,
                                  via pública, transporte,
                                  outros locais externos). Mesmo quando a escola acompanha ou
                                  identifica o caso, este
                                  campo ajuda a registrar que o local do ocorrido não foi na
                                  escola.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaNaoEscola" class="select-elegant w-full" style="margin-top: 2px;">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudo de Caso -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Foi realizado estudo de caso pela equipe?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Estudo de
                                  caso</div>
                                <div class="leading-relaxed text-gray-800">Indica se a equipe
                                  realizou estudo de caso
                                  (análise estruturada do registro), geralmente com reuniões,
                                  avaliação multidisciplinar
                                  (pedagógica/psicossocial/direção), definição de plano de
                                  intervenção e documentação
                                  interna. Ajuda a entender o nível de consolidação do
                                  acompanhamento do caso.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudoCaso" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência informada à escola -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Violência comunicada à escola por algum agente
                            externo?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Comunicação
                                  por terceiros</div>
                                <div class="leading-relaxed text-gray-800">Indica se a escola tomou
                                  conhecimento do caso
                                  por comunicação de terceiros (agentes externos), e não por
                                  identificação direta da
                                  equipe escolar. Exemplos: família, o próprio estudante,
                                  vizinhos, Conselho Tutelar,
                                  Polícia, UBS, CRAS, entre outros. Esse campo é útil para
                                  interpretar a origem da
                                  informação e o fluxo de notificação.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro (condicional): Ocorreu na escola (apenas quando agente externo = Sim) -->
                    <div id="filterOcorreuEscolaContainer" class="hidden conditional-indent">
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">➜ A violência ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Condição">
                            <span class="filter-badge">Condicional: Agente Externo = Sim</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Condição de
                                  exibição</div>
                                <div class="leading-relaxed text-gray-800">Exibido quando: “A
                                  violência foi comunicada à
                                  escola por algum agente externo?” = Sim.</div>
                              </span>
                            </span>
                          </span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Confirmação
                                  do local</div>
                                <div class="leading-relaxed text-gray-800">Este campo aparece quando
                                  o caso foi
                                  comunicado por agente externo. Ele registra a conclusão (após
                                  apuração) sobre onde o
                                  fato ocorreu: dentro ou fora da escola. Serve para evitar
                                  interpretações ambíguas
                                  quando a informação chegou por terceiros, mas o local do
                                  ocorrido ainda precisa ser
                                  confirmado.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterOcorreuEscola" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupAutoriaAgente"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">🧑‍🤝‍🧑</div>
                  <span class="text-sm font-semibold text-gray-800">Autoria / Agente</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Filtro: Foi um membro familiar? -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="inline-flex items-center gap-1">
                          O autor era membro da família?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Membro da
                                  família</div>
                                <div class="leading-relaxed text-gray-800">Use esta informação para
                                  entender se o caso
                                  tem indício de violência intrafamiliar. Considere como familiar:
                                  pais ou responsáveis
                                  legais, avós, irmãos, tios, primos e outros parentes
                                  consanguíneos ou por afinidade.
                                  Quando marcado como “Sim”, costuma indicar necessidade de
                                  atenção para contexto
                                  doméstico e rede de proteção.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterMembroFamiliar" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                        <option value="naoinformado">Não informado</option>
                      </select>
                    </div>

                    <!-- Filtro: Profissional autor -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="inline-flex items-center gap-1">
                          Profissional/funcionário foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Autoria
                                  (profissional)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria do
                                  caso foi atribuída a
                                  profissional/funcionário da escola. Considere professores,
                                  coordenação, direção,
                                  auxiliares, terceirizados (limpeza, segurança, portaria,
                                  merenda) e demais
                                  colaboradores. Esse campo é importante porque muda a
                                  interpretação do caso e os
                                  encaminhamentos administrativos.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterProfissionalAutor" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudante autor -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="inline-flex items-center gap-1">
                          Estudante foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span
                              class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-indigo-50 text-indigo-800 border border-indigo-300 text-[10px] leading-none select-none">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-56 max-w-[240px] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">
                                  Autoria
                                  (estudante)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria foi
                                  atribuída a estudante
                                  (da mesma escola ou de outra unidade). Em geral, é usado para
                                  casos como agressões
                                  entre estudantes, bullying/cyberbullying e outras violências no
                                  contexto escolar entre
                                  pares.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudanteAutor" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupViolencia"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">⚠️</div>
                  <span class="text-sm font-semibold text-gray-800">Violência</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <!-- Tipo de Violência - Redesign com Cards -->
                  <div class="mb-4">
                    <!-- Barra de ações -->
                    <div class="violence-actions-bar">
                      <h4 class="violence-actions-title">⚠️ Tipo de Violência</h4>
                      <div class="violence-actions-buttons">
                        <button type="button" class="violence-action-btn select-all" onclick="selectAllViolenceTypes()">
                          ✓ Todos
                        </button>
                        <button type="button" class="violence-action-btn clear-all" onclick="clearAllViolenceTypes()">
                          ✕ Limpar
                        </button>
                      </div>
                    </div>
                    <!-- Container de cards de tipos de violência -->
                    <div id="filterTipoViolenciaContainer"></div>
                  </div>

                  <!-- CONDICIONAL: Violência Institucional (integrado como subgrupo visual) -->
                  <div id="section-violenciaInstitucional" class="hidden">
                    <div class="violence-conditional-section">
                      <div class="violence-conditional-header">
                        <span class="violence-conditional-icon">🏛️</span>
                        <span class="violence-conditional-title">Detalhamento: Violências
                          Institucionais</span>
                        <span class="violence-conditional-badge">Filtro ativo</span>
                        <span id="badge-violenciaInstitucional-total"
                          class="badge-count hidden inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-sky-600 rounded-full ml-2">0</span>
                      </div>
                      <div id="filterViolenciaInstitucionalContainer" class="violence-conditional-grid"></div>
                    </div>
                  </div>

                </div>
              </div>
            </details>

            <details id="filterGroupEncaminhamentos"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">📋</div>
                  <span class="text-sm font-semibold text-gray-800">Encaminhamentos</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <div>
                    <h4
                      class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide flex items-center justify-between">
                      <span>📋 Encaminhamento</span>
                      <span id="badge-encaminhamento-total"
                        class="badge-count hidden inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">0</span>
                    </h4>
                    <div id="filterEncaminhamentoContainer" class="space-y-3"></div>
                  </div>

                </div>
              </div>
            </details>

            <details id="filterGroupPerfilEstudante"
              class="filter-group group rounded-xl border border-gray-200 bg-white shadow-sm" data-mode="panel">
              <summary
                class="flex cursor-pointer list-none items-center justify-between gap-3 px-4 py-3 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                  <div class="p-1.5 rounded-md bg-blue-100 text-blue-700">👥</div>
                  <span class="text-sm font-semibold text-gray-800">Criança / Perfil</span>
                </div>
                <span class="filter-group-chevron text-gray-400">▾</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="child-filters-grid">
                    <div class="child-filter-card">
                      <div class="child-filter-card-header">
                        <div class="child-filter-card-icon">📅</div>
                        <div class="child-filter-card-title">Faixa Etária</div>
                      </div>
                      <div class="child-filter-card-body">
                        <div class="child-age-grid">
                          <div>
                            <label class="block text-gray-700 font-medium mb-2">Idade Mínima:</label>
                            <input type="number" id="filterIdadeMin" placeholder="Ex: 5" class="child-age-input">
                          </div>
                          <div>
                            <label class="block text-gray-700 font-medium mb-2">Idade Máxima:</label>
                            <input type="number" id="filterIdadeMax" placeholder="Ex: 18" class="child-age-input">
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="child-filters-subgrid">
                      <div class="child-filter-card">
                        <div class="child-filter-card-header">
                          <div class="child-filter-card-icon">⚧️</div>
                          <div class="child-filter-card-title">GÊNERO (M/F)</div>
                        </div>
                        <div class="child-filter-card-body">
                          <div id="filterGeneroContainer"></div>
                        </div>
                      </div>

                      <div class="child-filter-card">
                        <div class="child-filter-card-header">
                          <div class="child-filter-card-icon">👥</div>
                          <div class="child-filter-card-title">RAÇA/COR</div>
                        </div>
                        <div class="child-filter-card-body">
                          <div id="filterRacaContainer"></div>
                        </div>
                      </div>

                      <div class="child-filter-card">
                        <div class="child-filter-card-header">
                          <div class="child-filter-card-icon">🌈</div>
                          <div class="child-filter-card-title">ORIENTAÇÃO SEXUAL</div>
                        </div>
                        <div class="child-filter-card-body">
                          <div id="filterOrientacaoContainer"></div>
                        </div>
                      </div>

                      <div class="child-filter-card">
                        <div class="child-filter-card-header">
                          <div class="child-filter-card-icon">♿</div>
                          <div class="child-filter-card-title">É PCD / TEM TRANSTORNO?</div>
                        </div>
                        <div class="child-filter-card-body">
                          <label class="block text-gray-700 font-medium mb-2">Selecione:</label>
                          <select id="filterPCD" class="select-elegant w-full">
                            <option value="">Todos</option>
                            <option value="S">Sim</option>
                            <option value="N">Não</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- CONDICIONAL: Tipo Deficiência -->
                  <div id="section-tipoDeficiencia" class="mt-4 hidden conditional-indent">
                    <div class="child-filter-card has-flyout">
                      <div class="child-filter-card-header">
                        <div class="child-filter-card-icon">♿</div>
                        <div class="child-filter-card-title">TIPO DE DEFICIÊNCIA / TRANSTORNO</div>
                        <span class="filter-badge">Condicional: PCD = Sim</span>
                      </div>
                      <div class="child-filter-card-body">
                        <div id="filterTipoDeficienciaSelectedTags" class="selected-tags mb-2"></div>
                        <div class="autocomplete-wrapper mb-2">
                          <input type="text" id="filterTipoDeficienciaSearch"
                            class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                            placeholder="Digite para buscar..." autocomplete="off">
                          <div class="autocomplete-list" id="filterTipoDeficienciaAutocompleteList"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1.5">Digite para buscar e selecione um ou mais
                          tipos.</p>
                        <div id="filterTipoDeficienciaContainer" style="display:none"></div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </details>

          </div>

          <!-- Painel (abre apenas 1 filtro por vez, como no backup) -->
          <div id="advancedPanel" class="advanced-panel mt-4">
            <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-4 border border-gray-200 shadow-sm">
              <div id="advancedPanelContent"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="btnLimparFiltros" class="btn-elegant btn-secondary-elegant px-4 py-2 rounded-md font-medium">
          🔄 Limpar Filtros
        </button>
      </div>
    </section>

    <!-- Tabela de Registros -->
    <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6">
      <!-- Estatísticas e Paginação -->
      <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4">
          <div class="px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
            <span class="text-sm text-gray-600">Total:</span>
            <span id="totalRegistros" class="ml-2 text-lg font-bold text-blue-600">0</span>
          </div>
          <div class="px-4 py-2 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-600">Exibindo:</span>
            <span id="registrosVisiveis" class="ml-2 text-lg font-bold text-green-600">0</span>
          </div>
        </div>

        <!-- Controles de Paginação -->
        <div
          class="flex items-center gap-3 bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-2 rounded-xl border border-gray-200">
          <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            Itens por página:
          </label>
          <div class="relative">
            <select id="itensPorPagina" onchange="mudarItensPorPagina()"
              class="appearance-none px-4 py-2 pr-10 bg-white border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-semibold text-gray-700 cursor-pointer hover:border-blue-400 hover:shadow-md">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="999999">Todos</option>
            </select>
            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none"
              fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>

          <div id="paginacaoControles" class="flex items-center gap-2"></div>
        </div>
      </div>

      <div class="table-wrapper" data-tour="lista-casos">
        <table id="tabelaRegistros" class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th class="px-4 py-4 text-left text-sm font-bold">Criança/Estudante</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Data NT</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Idade</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Violência</th>
              <th class="px-4 py-4 text-left text-sm font-bold">CMEI/EMEF</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Região</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Criada</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Última Edição</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Membro Familiar?</th>
              <th class="px-4 py-4 text-center text-sm font-bold">Ações</th>
            </tr>
          </thead>
          <tbody id="corpoTabela" class="divide-y divide-gray-200">
            <tr>
              <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center gap-3">
                  <div class="text-5xl">📋</div>
                  <div class="text-lg font-medium">Nenhum registro carregado</div>
                  <div class="text-sm">Clique em "Carregar Registros" para visualizar os dados</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal de Edição - NOVO DESIGN COM ABAS -->
  <div id="modalEdicao" class="modal">
    <div
      class="bg-white/95 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[95vh] overflow-hidden flex flex-col border border-white/60"
      style="position: relative !important; margin: auto !important; width: auto !important; max-width: 95vw !important;">
      <!-- Header do Modal -->
      <div
        class="flex items-center justify-between px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b border-gray-200 bg-white">
        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2 sm:gap-3">
          <span class="text-2xl sm:text-3xl">✏️</span>
          <span>Editar Registro</span>
        </h2>
        <button onclick="fecharModal()"
          class="text-gray-400 hover:text-gray-600 text-3xl font-light transition-colors w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg hover:bg-gray-100">×</button>
      </div>

      <!-- Sistema de Abas -->
      <div class="border-b border-gray-200 bg-white/80 backdrop-blur-sm">
        <div class="flex gap-1 px-4 sm:px-6">
        </div>
      </div>

      <!-- Conteúdo do Modal -->
      <div class="flex-1 overflow-y-auto bg-gradient-to-br from-blue-50/30 via-indigo-50/20 to-purple-50/30"
        style="max-width: 882.719px; width: 100%; margin: 0 auto;">
        <form id="formEdicao" class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 md:p-8 lg:p-10 space-y-6 sm:space-y-8">
          <input type="hidden" id="edit_linha">

          <!-- ABA: DADOS BÁSICOS -->
          <div id="aba-dados" class="aba-conteudo">

            <!-- =============================================== -->
            <!-- SEÇÃO 1: Dados da Criança/Estudante -->
            <!-- =============================================== -->
            <section>
              <div
                class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div
                    class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                    👤
                  </div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                      Dados da Criança/Estudante
                    </h2>
                    <p class="text-xs sm:text-sm text-gray-600">
                      Preencha as informações básicas da criança ou estudante envolvido no caso
                    </p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  <!-- Criança/Estudante -->
                  <div class="md:col-span-2">
                    <label for="edit_criancaEstudante" class="block text-sm font-semibold text-gray-700 mb-2">
                      Nome da Criança/Estudante <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="edit_criancaEstudante" name="edit_criancaEstudante" required
                      class="input-elegant w-full shadow-sm" placeholder="Digite o nome completo">
                  </div>

                  <!-- Data da NT -->
                  <div>
                    <label for="edit_dataNT" class="block text-sm font-semibold text-gray-700 mb-2">
                      Data da Notificação (NT) <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="edit_dataNT" name="edit_dataNT" required
                      class="input-elegant w-full shadow-sm">
                  </div>

                  <!-- Idade -->
                  <div>
                    <label for="edit_idade" class="block text-sm font-semibold text-gray-700 mb-2">
                      Idade <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="edit_idade" name="edit_idade" min="0" max="120" required
                      class="input-elegant w-full shadow-sm" placeholder="Ex: 10">
                  </div>

                  <!-- Identidade de Gênero -->
                  <div>
                    <label for="edit_identidadeGenero" class="block text-sm font-semibold text-gray-700 mb-2">
                      Identidade de Gênero <span class="text-red-500">*</span>
                    </label>
                    <select id="edit_identidadeGenero" name="edit_identidadeGenero" required
                      class="select-elegant w-full shadow-sm">
                      <option value="">Selecione...</option>
                      <option value="M">Masculino</option>
                      <option value="F">Feminino</option>
                      <option value="Não-binário">Não-binário</option>
                      <option value="Outro">Outro</option>
                    </select>
                  </div>

                  <!-- É PCD/tem Transtorno? -->
                  <div>
                    <label for="edit_pcdTranstorno" class="block text-sm font-semibold text-gray-700 mb-2">
                      É PCD/tem Transtorno?
                    </label>
                    <select id="edit_pcdTranstorno" name="edit_pcdTranstorno" class="select-elegant w-full shadow-sm">
                      <option value="">Selecione...</option>
                      <option value="Sim">Sim</option>
                      <option value="Não">Não</option>
                      <option value="Não informado">Não informado</option>
                    </select>
                  </div>

                  <!-- Detalhes da deficiência/transtorno (condicional) -->
                  <div id="edit_pcdDetalhesContainer" class="md:col-span-2 hidden">
                    <label for="edit_pcdDetalhes-input" class="block text-sm font-semibold text-gray-700 mb-2">
                      Se for PCD/tem transtorno, descreva quais (diagnósticos, laudos, observações): <span
                        class="text-red-500">*</span>
                    </label>

                    <!-- Container de tags -->
                    <div id="edit_pcdDetalhes-tags"
                      class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                    </div>

                    <!-- Input com autocomplete -->
                    <div class="relative">
                      <input type="text" id="edit_pcdDetalhes-input" class="input-elegant w-full shadow-sm"
                        placeholder="Digite ou selecione um transtorno/deficiência..." autocomplete="off" />
                      <div id="edit_pcdDetalhes-suggestions"
                        class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      </div>
                    </div>

                    <!-- Campo oculto que será enviado -->
                    <input type="hidden" id="edit_pcdDetalhes" name="edit_pcdDetalhes" />

                    <p class="text-xs text-gray-500 mt-1.5">
                      Digite para buscar ou adicione um novo transtorno/deficiência. Pressione Enter para adicionar.
                    </p>
                  </div>

                  <!-- Raça/Cor -->
                  <div class="md:col-span-2">
                    <label for="edit_racaCor" class="block text-sm font-semibold text-gray-700 mb-2">
                      Raça/Cor
                    </label>
                    <select id="edit_racaCor" name="edit_racaCor" class="select-elegant w-full shadow-sm">
                      <option value="">Selecione...</option>
                      <option value="Branca">Branca</option>
                      <option value="Preta">Preta</option>
                      <option value="Parda">Parda</option>
                      <option value="Amarela">Amarela</option>
                      <option value="Indígena">Indígena</option>
                      <option value="Não informado">Não informado</option>
                    </select>
                  </div>

                  <!-- Orientação Sexual -->
                  <div class="md:col-span-2">
                    <label for="edit_orientacaoSexual" class="block text-sm font-semibold text-gray-700 mb-2">
                      Orientação Sexual
                    </label>
                    <select id="edit_orientacaoSexual" name="edit_orientacaoSexual"
                      class="select-elegant w-full shadow-sm">
                      <option value="">Selecione...</option>
                      <option value="Heterossexual">Heterossexual</option>
                      <option value="Homossexual">Homossexual</option>
                      <option value="Bissexual">Bissexual</option>
                      <option value="Assexual">Assexual</option>
                      <option value="Pansexual">Pansexual</option>
                      <option value="Não informado">Não informado</option>
                    </select>
                  </div>

                </div>
              </div>


              <!-- =============================================== -->
              <!-- SEÇÃO 2: Situação da Violência -->
              <!-- =============================================== -->
              <section>
                <div
                  class="bg-gradient-to-r from-red-50/50 to-orange-50/30 rounded-xl sm:rounded-2xl border border-red-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
                  <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div
                      class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-red-100 text-red-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                      ⚠️
                    </div>
                    <div class="flex-1">
                      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                        Situação da Violência
                      </h2>
                      <p class="text-xs sm:text-sm text-gray-600">
                        Descreva o tipo de violência ocorrida e os encaminhamentos realizados
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 gap-4 sm:gap-6">

                    <div>
                      <label for="edit_tipoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
                        Tipo de Violência <span class="text-red-500">*</span>
                      </label>

                      <!-- Container de tags -->
                      <div id="edit_tipoViolencia-tags"
                        class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                      </div>

                      <!-- Input com autocomplete -->
                      <div class="relative">
                        <input type="text" id="edit_tipoViolencia-input" class="input-elegant w-full shadow-sm"
                          placeholder="Digite para adicionar tipo de violência (ex: Física)" autocomplete="off" />

                        <!-- Lista de sugestões -->
                        <div id="edit_tipoViolencia-suggestions"
                          class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        </div>
                      </div>

                      <!-- Campo oculto que será enviado -->
                      <input type="hidden" id="edit_tipoViolencia" name="edit_tipoViolencia" required />

                      <p class="text-xs text-gray-500 mt-1.5">
                        Digite e pressione Enter para adicionar. Pode adicionar múltiplos tipos (ex: Física,
                        Psicológica).
                      </p>
                    </div>

                    <!-- Tipo de Violência Institucional (Condicional) -->
                    <div id="edit_tipoViolenciaInstitucionalContainer" class="hidden">
                      <label for="edit_tipoViolenciaInstitucional-input"
                        class="block text-sm font-semibold text-gray-700 mb-2">
                        Qual o tipo da violência institucional <span class="text-red-500">*</span>
                      </label>

                      <!-- Container de tags -->
                      <div id="edit_tipoViolenciaInstitucional-tags"
                        class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                      </div>

                      <!-- Input com autocomplete -->
                      <div class="relative">
                        <input type="text" id="edit_tipoViolenciaInstitucional-input"
                          class="input-elegant w-full shadow-sm"
                          placeholder="Digite para adicionar tipo de violência institucional (ex: Física, Psicológica)"
                          autocomplete="off" />

                        <!-- Lista de sugestões -->
                        <div id="edit_tipoViolenciaInstitucional-suggestions"
                          class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        </div>
                      </div>

                      <!-- Campo oculto que será enviado -->
                      <input type="hidden" id="edit_tipoViolenciaInstitucional"
                        name="edit_tipoViolenciaInstitucional" />

                      <p class="text-xs text-gray-500 mt-1.5">
                        Digite e pressione Enter para adicionar. Pode adicionar múltiplos tipos (ex: Física,
                        Psicológica). Este campo aparece apenas quando "Institucional" está selecionado no Tipo de
                        Violência.
                      </p>
                    </div>

                    <div>
                      <label for="edit_encaminhamento-input" class="block text-sm font-semibold text-gray-700 mb-2">
                        Encaminhamento
                      </label>

                      <!-- Container de tags -->
                      <div id="edit_encaminhamentos-tags"
                        class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                      </div>

                      <!-- Input com autocomplete -->
                      <div class="relative">
                        <input type="text" id="edit_encaminhamento-input"
                          class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                          placeholder="Digite para adicionar encaminhamento (ex: Conselho Tutelar)"
                          autocomplete="off" />

                        <!-- Lista de sugestões -->
                        <div id="edit_encaminhamento-suggestions"
                          class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        </div>
                      </div>

                      <!-- Campo oculto que será enviado -->
                      <input type="hidden" id="edit_encaminhamento" name="edit_encaminhamento" />

                      <p class="text-xs text-gray-500 mt-1.5">
                        Digite e pressione Enter para adicionar. Clique no × para remover.
                      </p>
                    </div>

                  </div>
                </div>
              </section>

              <!-- =============================================== -->
              <!-- SEÇÃO 3: Unidade e Região -->
              <!-- =============================================== -->
              <section>
                <div
                  class="bg-gradient-to-r from-green-50/50 to-emerald-50/30 rounded-xl sm:rounded-2xl border border-green-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
                  <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div
                      class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-green-100 text-green-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                      🏫
                    </div>
                    <div class="flex-1">
                      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                        Unidade e Região
                      </h2>
                      <p class="text-xs sm:text-sm text-gray-600">
                        Identifique a instituição de ensino e região onde o caso foi registrado
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

                    <!-- Tipo de Instituição -->
                    <div class="md:col-span-2">
                      <label for="edit_tipoInstituicao" class="block text-sm font-semibold text-gray-700 mb-2">
                        Qual o tipo da instituição de ensino? <span class="text-red-500">*</span>
                      </label>
                      <select id="edit_tipoInstituicao" name="edit_tipoInstituicao" required
                        class="select-elegant w-full shadow-sm">
                        <option value="">Selecione o tipo...</option>
                        <option value="CMEI">CMEI - Centro Municipal de Educação Infantil</option>
                        <option value="EMEF">EMEF - Escola Municipal de Ensino Fundamental</option>
                      </select>
                    </div>

                    <!-- CMEI/EMEF com Autocomplete -->
                    <div class="md:col-span-2">
                      <!-- CABEÇALHO: Label + Botão Ver Todas -->
                      <div class="flex items-center justify-between mb-2">
                        <label for="edit_cmeiEmef" class="block text-sm font-semibold text-gray-700">
                          Instituição de Ensino <span class="text-red-500">*</span>
                        </label>

                        <!-- ⭐ BOTÃO VER TODAS - APENAS PARA TÉCNICOS -->
                        <div id="edit_filtro-escolas-container" class="hidden">
                          <button type="button" id="edit_btnVerTodasEscolas"
                            class="btn-elegant btn-primary-elegant text-xs px-3 py-1.5 rounded-full shadow-sm"
                            title="Alternar entre suas escolas e todas as escolas">
                            <span id="edit_btnVerTodasIcone">🌐</span>
                            <span id="edit_btnVerTodasText">Ver Todas</span>
                          </button>
                        </div>
                      </div>

                      <div class="autocomplete-wrapper">
                        <input type="text" id="edit_cmeiEmef" name="edit_cmeiEmef" required disabled autocomplete="off"
                          class="input-elegant w-full shadow-sm disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-500"
                          placeholder="Primeiro selecione o tipo de instituição">
                        <div class="autocomplete-list" id="edit_autocompleteList"></div>
                      </div>

                      <!-- ⭐ INDICADOR DE FILTRO ATIVO (APENAS TÉCNICOS) -->
                      <div id="edit_filtroAtivoContainer" class="hidden mt-1.5">
                        <p id="edit_filtroAtivoIndicador" class="text-xs text-green-600 flex items-center gap-1">
                          <span>✓</span>
                          <span id="edit_filtroAtivoTexto">Mostrando suas escolas atribuídas</span>
                        </p>
                      </div>

                      <p class="text-xs text-gray-500 mt-1.5">Digite para filtrar as instituições disponíveis</p>
                    </div>

                    <!-- Região (Preenchido automaticamente ao selecionar escola) -->
                    <div>
                      <label for="edit_regiao-display" class="block text-sm font-semibold text-gray-700 mb-2">
                        Região <span class="text-red-500">*</span>
                      </label>
                      <input type="text" id="edit_regiao-display" readonly
                        class="input-elegant w-full bg-gray-100 text-gray-600 cursor-not-allowed shadow-sm"
                        placeholder="Selecione uma escola primeiro">
                      <!-- Campo hidden para envio ao backend -->
                      <input type="hidden" id="edit_regiao" name="edit_regiao" required>
                      <p class="text-xs text-blue-500 mt-1.5 flex items-center gap-1">
                        <span>ℹ️</span> Preenchido automaticamente ao selecionar a escola
                      </p>
                    </div>

                    <!-- Responsável pelo Registro -->
                    <div class="md:col-span-2">
                      <label for="edit_responsavelRegistro" class="block text-sm font-semibold text-gray-700 mb-2">
                        Responsável pelo Registro <span class="text-red-500">*</span>
                      </label>
                      <input type="text" id="edit_responsavelRegistro" name="edit_responsavelRegistro" required readonly
                        class="input-elegant w-full bg-gray-50 shadow-sm cursor-not-allowed disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-600"
                        placeholder="Nome do profissional que está registrando">
                      <p class="text-xs text-gray-500 mt-1">Campo não pode ser alterado para evitar conflitos de
                        auditoria</p>
                    </div>

                    <!-- Colaboradores da Edição -->
                    <div class="md:col-span-2">
                      <label for="edit_colaboradores-input" class="block text-sm font-semibold text-gray-700 mb-2">
                        Colaboradores <span class="text-gray-400 text-xs">(opcional)</span>
                      </label>

                      <!-- Container de tags -->
                      <div id="edit_colaboradores-tags"
                        class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50">
                      </div>

                      <!-- Input com autocomplete -->
                      <div class="relative">
                        <input type="text" id="edit_colaboradores-input"
                          class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                          placeholder="Digite para adicionar colaborador..." autocomplete="off" />

                        <!-- Lista de sugestões -->
                        <div id="edit_colaboradores-suggestions"
                          class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        </div>
                      </div>

                      <!-- Campo oculto que será enviado -->
                      <input type="hidden" id="edit_colaboradores" name="edit_colaboradores" />

                      <p class="text-xs text-gray-500 mt-1.5">
                        Digite e pressione Enter para adicionar. Pode adicionar múltiplos colaboradores.
                      </p>
                    </div>

                  </div>
                </div>
              </section>

              <!-- =============================================== -->
              <!-- SEÇÃO 4: Informações Complementares -->
              <!-- =============================================== -->
              <section>
                <div
                  class="bg-gradient-to-r from-purple-50/50 to-indigo-50/30 rounded-xl sm:rounded-2xl border border-purple-200 shadow-sm p-4 sm:p-5 md:p-6">
                  <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div
                      class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                      ❓
                    </div>
                    <div class="flex-1">
                      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                        Informações Complementares
                      </h2>
                      <p class="text-xs sm:text-sm text-gray-600">
                        Responda às questões adicionais sobre o contexto da violência
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

                    <!-- Foi um membro familiar? -->
                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Foi um membro familiar? <span class="text-red-500">*</span>
                        </label>
                        <div class="flex flex-wrap gap-2 sm:gap-3">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" id="edit_foiMembroFamiliar_sim" name="edit_foiMembroFamiliar"
                              value="Sim" class="peer sr-only">
                            <div
                              class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" id="edit_foiMembroFamiliar_nao" name="edit_foiMembroFamiliar"
                              value="Não" class="peer sr-only">
                            <div
                              class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" id="edit_foiMembroFamiliar_naoinformado" name="edit_foiMembroFamiliar"
                              value="" class="peer sr-only">
                            <div
                              class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- Campos adicionais -->
                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          A fonte dos informadores foi a escola?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_fonteEscola" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_fonteEscola" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_fonteEscola" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Violência identificada pela escola ocorrida na escola?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaEscolaOcorreu" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaEscolaOcorreu" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaEscolaOcorreu" value="" checked
                              class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Algum profissional da escola foi autor da violência?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_profissionalAutor" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_profissionalAutor" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_profissionalAutor" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Algum estudante foi autor da violência?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudanteAutor" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudanteAutor" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudanteAutor" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Violência identificada pela escola NÃO ocorrida na escola?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaNaoEscola" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaNaoEscola" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaNaoEscola" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Ocorreu na escola? (1.1)
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_ocorreuEscola" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_ocorreuEscola" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_ocorreuEscola" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          Violência informada à escola por qualquer um dos agentes que a compõe? (1.2)
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaInformada" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaInformada" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_violenciaInformada" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="md:col-span-2">
                      <div
                        class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                          📋 Foi Realizado Estudo de Caso?
                        </label>
                        <div class="flex flex-wrap gap-2">
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudoCaso" value="Sim" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                              ✓ Sim
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudoCaso" value="Não" class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                              ✗ Não
                            </div>
                          </label>
                          <label class="relative flex items-center cursor-pointer">
                            <input type="radio" name="edit_estudoCaso" value="" checked class="peer sr-only">
                            <div
                              class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                              ⊘ Não informado
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
          </div>
          </section>

          <!-- ABA: HISTÓRICO DE ATUALIZAÇÕES -->
          <div id="aba-historico" class="aba-conteudo hidden">
            <div
              class="bg-gradient-to-br from-purple-50/80 via-indigo-50/60 to-purple-50/80 rounded-xl sm:rounded-2xl border border-purple-200/50 shadow-lg p-4 sm:p-5 md:p-6 lg:p-8">
              <div class="space-y-6 sm:space-y-8">
                <div
                  class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl sm:rounded-2xl border border-purple-200 shadow-sm p-4 sm:p-5 md:p-6">
                  <div class="flex items-start gap-3 sm:gap-4">
                    <div
                      class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                      📝
                    </div>
                    <div class="flex-1">
                      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Histórico de Atualizações
                      </h2>
                      <p class="text-xs sm:text-sm text-gray-600">Visualize e adicione atualizações sobre este caso</p>
                    </div>
                  </div>
                </div>

                <!-- Histórico de atualizações anteriores (somente leitura) -->
                <div id="historico-atualizacoes-editar"
                  class="historico-readonly bg-white/70 backdrop-blur-sm rounded-xl border border-purple-100 shadow-sm p-4 sm:p-5">
                  <div class="atualizacoes-loading">
                    <div class="atualizacoes-spinner"></div>
                    <p>Carregando atualizações...</p>
                  </div>
                </div>

                <!-- Campo para adicionar nova atualização -->
                <div
                  class="adicionar-atualizacao bg-white/90 backdrop-blur-sm rounded-xl sm:rounded-2xl border border-purple-200 shadow-sm p-4 sm:p-5 md:p-6">
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-3">
                    <strong>Adicionar Nova Atualização:</strong>
                  </label>
                  <textarea id="nova-atualizacao-editar"
                    placeholder="Descreva o que foi feito em relação a esta notificação..." rows="4" maxlength="1000"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500 transition-all duration-200 bg-white shadow-sm resize-none"></textarea>
                  <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Status da Atualizacao (opcional):
                    </label>
                    <select id="tag-status-atualizacao-editar"
                      class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500 transition-all duration-200 bg-white shadow-sm">
                      <option value="">Sem status</option>
                      <option value="Pendente">Pendente</option>
                      <option value="Em andamento">Em andamento</option>
                      <option value="Concluido">Concluido</option>
                    </select>
                  </div>
                  <button type="button" id="btn-adicionar-atualizacao-editar" onclick="adicionarAtualizacaoEdicao()"
                    class="mt-3 px-6 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg sm:rounded-full font-semibold hover:from-purple-700 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg inline-flex items-center gap-2">
                    <span>➕</span>
                    <span>Adicionar Atualização</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ABA: ANEXOS -->
          <div id="aba-anexos" class="aba-conteudo hidden">
            <div
              class="bg-gradient-to-br from-blue-50/80 via-cyan-50/60 to-blue-50/80 rounded-xl sm:rounded-2xl border border-blue-200/50 shadow-lg p-4 sm:p-5 md:p-6 lg:p-8">
              <div class="space-y-6 sm:space-y-8">
                <div
                  class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl sm:rounded-2xl border border-blue-200 shadow-sm p-4 sm:p-5 md:p-6">
                  <div class="flex items-start gap-3 sm:gap-4">
                    <div
                      class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
                      📎
                    </div>
                    <div class="flex-1">
                      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Anexos</h2>
                      <p class="text-xs sm:text-sm text-gray-600">Gerencie os arquivos anexados a este registro</p>
                    </div>
                  </div>
                </div>

                <!-- Lista de Anexos Existentes -->
                <div id="lista-anexos-editar"
                  class="bg-white/70 backdrop-blur-sm rounded-xl border border-blue-100 shadow-sm p-4 sm:p-5 mb-6">
                  <p class="text-sm text-gray-600 mb-3">Carregando anexos...</p>
                </div>

                <!-- Campo para Adicionar Novos Anexos -->
                <div
                  class="bg-white/90 backdrop-blur-sm rounded-xl sm:rounded-2xl border border-blue-200 shadow-sm p-4 sm:p-5 md:p-6">
                  <label class="block text-sm sm:text-base font-semibold text-gray-700 mb-3">
                    📁 Adicionar Novos Arquivos
                  </label>
                  <input type="file" id="anexos-editar" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                    class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-gradient-to-r file:from-blue-500 file:to-blue-600
                    file:text-white
                    hover:file:bg-gradient-to-r hover:file:from-blue-600 hover:file:to-blue-700
                    cursor-pointer
                    border-2 border-dashed border-blue-300
                    rounded-lg p-4
                    hover:border-blue-400
                    transition-colors" />
                  <div id="preview-anexos-editar" class="preview-anexos mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botões de Ação (sempre visíveis) -->
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-6 mt-6 border-t border-gray-200">
            <button id="btnSalvarEdicao" type="submit"
              class="btn-elegant btn-primary-elegant inline-flex items-center justify-center gap-2 px-6 sm:px-8 py-2.5 sm:py-3 text-white text-sm sm:text-base font-bold rounded-full shadow-lg flex-1 sm:flex-none">
              <span class="text-base sm:text-lg">💾</span>
              <span>Salvar Alterações</span>
            </button>
            <button type="button" onclick="fecharModal()"
              class="btn-elegant btn-secondary-elegant inline-flex items-center justify-center gap-2 px-6 sm:px-8 py-2.5 sm:py-3 text-sm sm:text-base font-semibold rounded-full shadow-md">
              <span>Cancelar</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    /* Container interno do modal (conteúdo) */
    #modalEdicao>div {
      position: relative !important;
      margin: auto !important;
      max-width: 95vw !important;
    }

    /* Formulário - layout normal - FORÇAR COLUNA VERTICAL */
    #formEdicao {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      display: block !important;
      flex-direction: column !important;
    }

    /* TODAS as divs filhas diretas do form devem ser block (vertical) */
    #formEdicao>div {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      float: none !important;
      clear: both !important;
      position: static !important;
      box-sizing: border-box !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    /* TODAS as seções do formulário devem ser block */
    #formEdicao>section {
      width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      box-sizing: border-box !important;
      margin-bottom: 0 !important;
    }

    /* FORÇAR que as divs de atualizações e anexos sejam block e empilhadas */
    /* Usar seletores mais específicos para pegar as divs corretas */
    #formEdicao section:last-child>div[style*="border-top"],
    #formEdicao section:last-child>div[style*="margin-top: 32px"],
    #formEdicao section:last-child>div[style*="width: 100% !important"] {
      width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      float: none !important;
      clear: both !important;
      position: static !important;
      box-sizing: border-box !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      margin-top: 32px !important;
      flex: none !important;
      flex-direction: unset !important;
      flex-wrap: unset !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      grid-auto-flow: unset !important;
      left: auto !important;
      right: auto !important;
    }

    /* Elementos de atualizações e anexos - FORÇAR BLOCK */
    #historico-atualizacoes-editar,
    .historico-readonly,
    .adicionar-atualizacao,
    #lista-anexos-editar,
    .preview-anexos {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      display: block !important;
      float: none !important;
      clear: both !important;
      position: static !important;
    }

    /* Textos longos devem quebrar - aplicar em TODOS os elementos */
    #lista-anexos-editar *,
    #lista-anexos-editar p,
    #lista-anexos-editar div,
    #lista-anexos-editar span {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      white-space: normal !important;
      max-width: 100% !important;
    }

    /* FORÇAR QUE TODOS OS ELEMENTOS DENTRO DE lista-anexos-editar SEJAM BLOCK */
    #lista-anexos-editar,
    #lista-anexos-editar>*,
    #lista-anexos-editar>div {
      width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      float: none !important;
      clear: both !important;
      box-sizing: border-box !important;
      position: static !important;
    }

    /* Garantir que divs renderizadas dinamicamente sejam block */
    #lista-anexos-editar>div>div {
      width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      margin-bottom: 12px !important;
      box-sizing: border-box !important;
      position: static !important;
      float: none !important;
      clear: both !important;
    }

    /* Garantir que os botões de ação fiquem no final */
    #formEdicao>div:last-child {
      width: 100% !important;
      display: block !important;
      clear: both !important;
      margin-top: 24px !important;
    }

    /* Remover qualquer flex ou grid que possa estar causando layout horizontal */
    #formEdicao section:last-child {
      display: block !important;
    }

    #formEdicao section:last-child>div {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      float: none !important;
      clear: both !important;
      position: static !important;
    }

    /* FORÇAR que TODAS as divs dentro da última seção sejam block */
    /* Selecionar especificamente as divs que contêm atualizações e anexos */
    #formEdicao section:last-child>div[style*="border-top: 2px solid"],
    #formEdicao section:last-child>div[style*="margin-top: 32px"],
    #formEdicao section:last-child>div[style*="width: 100% !important"] {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      float: none !important;
      clear: both !important;
      position: static !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      flex: none !important;
      flex-direction: unset !important;
      flex-wrap: unset !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      grid-auto-flow: unset !important;
      left: auto !important;
      right: auto !important;
      transform: none !important;
    }

    /* Garantir que a última seção não use grid ou flex horizontal */
    #formEdicao section:last-child {
      display: block !important;
    }

    #formEdicao section:last-child>div {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
    }

    /* Garantir que o container do modal não force layout horizontal */
    #modalEdicao>div>form {
      display: block !important;
      flex-direction: column !important;
    }

    /* FORÇAR que as divs de Atualizações e Anexos (que estão diretamente no form) fiquem em coluna */
    #formEdicao>div[style*="border-top: 2px solid"],
    #formEdicao>div[style*="margin-top: 32px"],
    #formEdicao>div[style*="width: 100% !important"] {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      float: none !important;
      clear: both !important;
      position: static !important;
      box-sizing: border-box !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      flex: none !important;
      flex-direction: unset !important;
      flex-wrap: unset !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      grid-auto-flow: unset !important;
    }

    .confirm-edit-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin: 12px 0;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-weight: 600;
      color: #334155;
    }

    .confirm-edit-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      border-radius: 999px;
      background: #2563eb;
      color: #ffffff;
      font-size: 12px;
      font-weight: 700;
    }

    .confirm-edit-list {
      display: grid;
      gap: 10px;
      margin: 12px 0 16px;
    }

    .confirm-edit-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
    }

    .confirm-edit-cell {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px;
    }

    .confirm-edit-cell-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #64748b;
      margin-bottom: 6px;
    }

    .confirm-edit-cell-value {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      word-break: break-word;
    }

    .confirm-edit-before {
      border-color: #fecaca;
      background: #fef2f2;
    }

    .confirm-edit-before .confirm-edit-cell-value {
      color: #b91c1c;
    }

    .confirm-edit-after {
      border-color: #bbf7d0;
      background: #ecfdf5;
    }

    .confirm-edit-after .confirm-edit-cell-value {
      color: #047857;
    }

    @media (max-width: 768px) {
      .confirm-edit-row {
        grid-template-columns: 1fr;
      }
    }

    .confirm-modal-overlay {
      overflow: hidden;
      padding: 24px 12px;
    }

    .confirm-modal {
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .confirm-modal-body {
      overflow-y: auto;
      max-height: calc(90vh - 120px);
    }

    /* Forçar que os botões fiquem no final */
    #formEdicao+div,
    #formEdicao~div {
      width: 100% !important;
      display: block !important;
      clear: both !important;
    }

    /* REGRA FINAL: Forçar que qualquer div filha direta da última seção seja block */
    /* Isso garante que atualizações e anexos fiquem empilhados */
    #formEdicao>section:last-child>div {
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      float: none !important;
      clear: both !important;
      position: static !important;
      box-sizing: border-box !important;
    }

    /* Garantir que não haja layout horizontal em nenhum nível */
    #formEdicao section:last-child .grid,
    #formEdicao section:last-child .flex {
      /* Manter grid e flex apenas para elementos internos dos cards, não para as divs principais */
    }

    /* Mas as divs principais de atualizações e anexos devem ser block */
    #formEdicao section:last-child>div:not(.grid):not(.flex) {
      display: block !important;
      width: 100% !important;
    }

    /* ============================================
       REGRA FINAL: FORÇAR LAYOUT VERTICAL COMPLETO
       ============================================ */

    /* Garantir que o form use layout de coluna (vertical) */
    #formEdicao {
      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
    }

    /* Todas as seções e divs dentro do form devem ocupar 100% da largura e ficar empilhadas */
    #formEdicao>section,
    #formEdicao>div {
      width: 100% !important;
      max-width: 100% !important;
      flex: 0 0 auto !important;
      display: block !important;
      box-sizing: border-box !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      float: none !important;
      clear: both !important;
    }

    /* Especificamente para as divs de Atualizações e Anexos */
    #formEdicao>div[style*="border-top: 2px solid"],
    #formEdicao>div[style*="margin-top: 32px"] {
      order: 2 !important;
      /* Depois da section de dados */
      width: 100% !important;
      max-width: 100% !important;
      display: block !important;
      flex: 0 0 auto !important;
      clear: both !important;
      float: none !important;
    }

    /* Section de dados da criança fica primeiro */
    #formEdicao>section {
      order: 1 !important;
    }

    /* Div de separador e botões fica por último */
    #formEdicao>div.my-6,
    #formEdicao>div.flex {
      order: 3 !important;
    }
  </style>

  <script>
    // ========================================
    // CONFIGURAÇÃO DO GOOGLE APPS SCRIPT
    // ========================================
    // Usando configuração centralizada (config.js)
    const APPS_SCRIPT_URL = CONFIG.APPS_SCRIPT_CASOS;
    const APPS_SCRIPT_CASOS = CONFIG.APPS_SCRIPT_CASOS; // Para compatibilidade com funções de anexo

    // Debug: Verifica se a URL foi carregada corretamente
    console.log('🔧 [DEBUG] APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
    console.log('🔧 [DEBUG] APPS_SCRIPT_CASOS:', APPS_SCRIPT_CASOS);

    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_SCRIPT')) {
      const msgErro = `
❌ ERRO DE CONFIGURAÇÃO
      
A URL do Apps Script não está configurada corretamente!

SOLUÇÃO:
1. Abra o arquivo: config.js
2. Localize: APPS_SCRIPT_CASOS
3. Cole a URL correta do seu Apps Script
4. Salve o arquivo
5. Pressione Ctrl+Shift+R para recarregar

URL atual: ${APPS_SCRIPT_URL || 'undefined'}
`;
      console.error(msgErro);
      alert(msgErro);
      throw new Error('APPS_SCRIPT_CASOS não configurado');
    }

    console.log('✅ URL do Apps Script configurada corretamente');

    let registrosCache = [];
    let registrosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 25;
    let paginaAntesEdicao = 1; // Armazena página antes de abrir edição
    let editColaboradoresSelecionados = []; // Colaboradores selecionados na edição

    // ========================================
    // LISTA DE TRANSTORNOS/DEFICIÊNCIAS PREDEFINIDOS
    // ========================================
    const transtornosPredefinidos = [
      'Autismo (TEA)',
      'TDAH (Transtorno de Déficit de Atenção e Hiperatividade)',
      'Síndrome de Down',
      'Deficiência Intelectual',
      'Deficiência Visual',
      'Deficiência Auditiva',
      'Deficiência Física',
      'Deficiência Múltipla',
      'Distúrbio de Linguagem',
      'Encefalopatia Crônica',
      'Encefalopatia Epilética',
      'Dislexia',
      'Discalculia',
      'Transtorno do Espectro Autista',
      'Paralisia Cerebral',
      'TOD (Transtorno Opositor Desafiador)',
      'Transtorno de Ansiedade',
      'Transtorno de Pânico',
      'Depressão Infantil',
      'Síndrome de Asperger',
      'Transtorno Bipolar',
      'Esquizofrenia',
      'TOC',
      'TDI',
      'Transtorno Mental',
      'Transtorno de Conduta',
      'Transtorno Comportamental',
      'Altas Habilidades/Superdotação',
      'Baixa Visão',
      'Cegueira',
      'Surdez',
      'Surdocegueira',
      'Nanismo',
      'Hidrocefalia',
      'Microcefalia',
      'Epilepsia',
      'Outros'
    ];

    // ========================================
    // LISTAS PREDEFINIDAS - RAÇA/COR E TIPO DE VIOLÊNCIA
    // ========================================
    const racasCorPredefinidas = [
      'Branca',
      'Preta',
      'Parda',
      'Amarela',
      'Indígena',
      'Não informado'
    ];

    const tiposViolenciaPredefinidos = [
      'Autoprovocada',
      'Bullying',
      'Tortura',
      'Cyberbullying',
      'Financeira/Econômica',
      'Física',
      'Institucional',
      'Negligência',
      'Psicológica',
      'Sexual',
      'Suposto Uso de Substâncias Ilícitas',
      'Suspeita de envenenamento',
      'Trabalho Infantil',
      'Verbal',
      'Ideação suicida',
      'Patrimonial',
      'Outra'
    ];

    // LISTA DE CLASSIFICAÇÕES DA VIOLÊNCIA
    // Deve coincidir EXATAMENTE com a validação da planilha
    const classificacoesViolenciaPredefinidas = [
      'Autoprovocada',
      'Intrafamiliar/Doméstica',
      'Extrafamiliar/Comunitária/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual'
    ];

    // LISTA DE MOTIVAÇÕES DA VIOLÊNCIA
    // IMPORTANTE: Valores devem coincidir EXATAMENTE com a validação da planilha
    const motivacoesViolenciaPredefinidas = [
      'Discriminação',
      'Racismo',
      'Gênero',
      'LGBTQIAPN+fobia',
      'Intolerância religiosa',
      'Gordofobia',
      'Bullying'
    ];

    let editTranstornosSelecionados = [];
    let editTiposViolenciaSelecionados = [];
    let editEncaminhamentosSelecionados = [];

    // ========================================
    // LISTA DE ENCAMINHAMENTOS PREDEFINIDOS
    // ========================================
    const encaminhamentosPredefinidos = [
      'CT',
      'Saúde',
      'UBS',
      'US',
      'NAAM',
      'Educação',
      'Escola',
      'DEAM',
      'DACLE',
      'DPCA',
      'Defensoria Pública',
      'DEPI',
      'Ministério Público',
      'CRAS',
      'CREAS',
      'CAPSIN',
      'Casa Rosa',
      'Vara da Infância',
      'Assistência Social',
      'Psicólogo',
      'Outras Delegacias',
      'Outros'
    ];

    // ========================================
    // LISTA DE REGIÕES
    // ========================================
    const regioesDisponiveis = [
      'Centro', 'Continental', 'São Pedro', 'Santo Antônio',
      'Praia do Canto', 'Jardim da Penha', 'Jardim Camburi',
      'Maruípe', 'Bento Ferreira'
    ];

    // ========================================
    // LISTA DE INSTITUIÇÕES (CMEI E EMEF)
    // ========================================
    const instituicoes = [
      { tipo: "CMEI", nomeOriginal: "CMEI Adalberto Sim\u00e3o Nader" },
      { tipo: "CMEI", nomeOriginal: "CMEI Altair Siqueira Costa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Araci Cortes da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Beatriz Zouain de Oliveira Viana" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bernadete Candia Ferreira de Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bom Pastor" },
      { tipo: "CMEI", nomeOriginal: "CMEI Branca de Nieve Tayt-Sohn Martins de Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Carlos Alberto Martinelli" },
      { tipo: "CMEI", nomeOriginal: "CMEI Celina Damiao Linhalis" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clotildes Gomes do Nascimento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clovis Correa do Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Creche Tia Tereza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Deolinda Lage Caldeira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dilson Rodrigues Fonseca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Domingas de Souza Costalonga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dona Laura" },
      { tipo: "CMEI", nomeOriginal: "CMEI Eliene Rodrigues dos Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Elizabeth Santos Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ernesto Paulino de Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Floracy Peres Faria" },
      { tipo: "CMEI", nomeOriginal: "CMEI Francisco Coelho Avanza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Gilvan dos Santos Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Iracema Conceicao Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Irma Maria Horta" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jacyntha Simoes Ferreira Paiao" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jernida Ribeiro de Mendonca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Joao Pedro Paulista Pizzol" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jose Mario Vieira Barbosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jurema Santos Rangel" },
      { tipo: "CMEI", nomeOriginal: "CMEI Licinha Coco Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lucia Helena Rodrigues Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Magnolia Amaral da Cunha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Marcos e Mirtes Rosa Coelho da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Anselmo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Aparecida Gomes Soares" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria das Gracas Pimentel Lyra" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria de Lourdes Fraga Rocha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Odetina Santos Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Merces Macedo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ocarlina Nunes Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Olga Souza Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Perpetua M\u00e1rcia T Menezes" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Sueli Salles de Carvalho" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Thereza Costa Vervloet Sarmento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Maria Helena Souza de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Neusa Nunes Goncalves" },
      { tipo: "CMEI", nomeOriginal: "CMEI Projeto Quatro" },
      { tipo: "CMEI", nomeOriginal: "CMEI Recanto Feliz" },
      { tipo: "CMEI", nomeOriginal: "CMEI Regina Maura Rezende Sagrillo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Valdete Rouver de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Walma Rodrigues Correia" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adao Benezath" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adevalni Sysesmundo Ferreira de Azevedo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adilson da Silva Castro" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alberto de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvaro de Castro Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvimar Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Aristobulo Barbosa Leao" },
      { tipo: "EMEF", nomeOriginal: "EMEF Arthur da Costa e Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Castelo Branco" },
      { tipo: "EMEF", nomeOriginal: "EMEF Ceciliano Abel de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Custodia Dias de Campos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eber Louzada Zippinotti" },
      { tipo: "EMEF", nomeOriginal: "EMEF EJA Prof Admardo Serafim de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eliane Rodrigues dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Elzira Vivacqua dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Experimental de Vitoria - UFES" },
      { tipo: "EMEF", nomeOriginal: "EMEF Francisco Lacerda de Aguiar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Heloisa Abreu Judice de Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Irma Jacinta Soares de Souza Lima" },
      { tipo: "EMEF", nomeOriginal: "EMEF Juscelino Kubitschek de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Lenir Borlot" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marechal Mascarenhas de Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Jose Costa Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Leonor Pereira da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Madalena de Oliveira Domingues" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marieta Escobar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Mauro Braga" },
      { tipo: "EMEF", nomeOriginal: "EMEF Neusa Nunes Goncalves" },
      { tipo: "EMEF", nomeOriginal: "EMEF Octacilio Lomba" },
      { tipo: "EMEF", nomeOriginal: "EMEF Orlandina D'Almeida Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF Otto Ewald Junior" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Anchieta" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Guido Ceotto" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prezideu Amorim" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Joao Bandeira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Maria Stella de Novaes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Vercenilio da Silva Pascoal" },
      { tipo: "EMEF", nomeOriginal: "EMEF Professora Regina Maria Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Rita de Cassia Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Sao Vicente de Paulo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Suzete Cuendet" },
      { tipo: "EMEF", nomeOriginal: "EMEF Tancredo de Almeida Neves" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Amilton Monteiro da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Anacleta Schneider Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Edna de Mattos Siqueira Gaudio" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Izaura Marques da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Aureo Monjardim" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Lemos de Miranda" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Moacyr Avidos" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Reglus Neves Freire" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Roberto Vieira Gomes" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Professora Eunice Pereira Silveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Ronaldo Soares" },
      { tipo: "EMEF", nomeOriginal: "EMEF Zilda Andrade" }
    ];

    // Gera siglas para cada instituição
    function gerarSiglaEdit(nomeCompleto) {
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');
      return sigla;
    }

    instituicoes.forEach(inst => {
      inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
    });

    // Variáveis de controle do autocomplete de instituições
    let edit_tipoInstituicaoSelecionado = '';
    let edit_instituicoesFiltradas = [];
    let edit_indiceSelecionado = -1;

    // Renderiza as tags de transtornos selecionados no modal de edição
    function renderizarTagsTranstornosEdit() {
      const container = document.getElementById('edit_pcdDetalhes-tags');
      const hiddenInput = document.getElementById('edit_pcdDetalhes');

      if (editTranstornosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum transtorno/deficiência adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = editTranstornosSelecionados.map((trans, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm">
          ${trans}
          <button 
            type="button" 
            onclick="removerTranstornoEdit(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por vírgula
      hiddenInput.value = editTranstornosSelecionados.join(', ');
    }

    // Remove um transtorno
    function removerTranstornoEdit(index) {
      editTranstornosSelecionados.splice(index, 1);
      renderizarTagsTranstornosEdit();
    }

    // Adiciona um transtorno (suporta separação por barra /)
    function adicionarTranstornoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Separa por barra (/) para considerar múltiplos transtornos
      const transtornos = textoTrimmed.split('/').map(t => t.trim()).filter(t => t.length > 0);

      // Adiciona cada transtorno separadamente
      transtornos.forEach(transtorno => {
        // Evita duplicatas
        if (!editTranstornosSelecionados.includes(transtorno)) {
          editTranstornosSelecionados.push(transtorno);
        }
      });

      renderizarTagsTranstornosEdit();

      // Limpa input
      document.getElementById('edit_pcdDetalhes-input').value = '';
      document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
    }

    // Filtra e mostra sugestões de transtornos
    function mostrarSugestoesTranstornosEdit(query) {
      const suggestionsDiv = document.getElementById('edit_pcdDetalhes-suggestions');

      // Se query vazia, mostra todas as opções disponíveis
      const filtrados = query.trim() === ''
        ? transtornosPredefinidos.filter(trans => !editTranstornosSelecionados.includes(trans))
        : transtornosPredefinidos.filter(trans =>
          trans.toLowerCase().includes(query.toLowerCase()) &&
          !editTranstornosSelecionados.includes(trans)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhum transtorno encontrado. Pressione <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Enter</kbd> para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(trans => `
        <div 
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTranstornoEdit('${trans.replace(/'/g, "\\\'")}')">
          ${trans}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    // Configura eventos do campo de transtornos no modal de edição
    function configurarEventosTranstornosEdit() {
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');

      // Listener para mostrar/ocultar campo de detalhes
      pcdTranstornoSelect.addEventListener('change', function () {
        if (this.value === 'Sim') {
          pcdDetalhesContainer.classList.remove('hidden');
        } else {
          pcdDetalhesContainer.classList.add('hidden');
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          pcdDetalhesInput.value = '';
        }
      });

      // Eventos do input de transtornos
      pcdDetalhesInput.addEventListener('focus', function (e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });

      pcdDetalhesInput.addEventListener('input', function (e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });

      pcdDetalhesInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTranstornoEdit(e.target.value);
        }
      });

      // Esconde sugestões ao clicar fora
      document.addEventListener('click', function (e) {
        if (!e.target.closest('#edit_pcdDetalhes-input') && !e.target.closest('#edit_pcdDetalhes-suggestions')) {
          document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
        }
      });
    }

    // Inicializa eventos quando o DOM estiver pronto
    // ========================================
    // DETECTAR PARÂMETRO ?editar= NA URL
    // ========================================
    let idNotificacaoParaEditar = null;
    let aguardandoCarregamento = false;

    function verificarParametroEditar() {
      const urlParams = new URLSearchParams(window.location.search);
      const idNotificacao = urlParams.get('editar');

      if (!idNotificacao) {
        return; // Não há parâmetro de edição
      }

      idNotificacaoParaEditar = idNotificacao;
      console.log('[gerenciar] Parâmetro ?editar= detectado:', idNotificacao);

      // PRIMEIRO: Verifica se há dados pré-carregados no sessionStorage
      const dadosPreCarregados = sessionStorage.getItem('notificacaoParaEditar');
      if (dadosPreCarregados) {
        try {
          const dados = JSON.parse(dadosPreCarregados);

          // Verifica se os dados são recentes (menos de 1 minuto) e correspondem ao ID
          const tempoDecorrido = Date.now() - dados.timestamp;
          if (dados.idNotificacao == idNotificacao && tempoDecorrido < 60000 && dados.registro) {
            console.log('[gerenciar] ✅ Usando dados pré-carregados do sessionStorage');

            // Adiciona o registro ao cache se ainda não estiver lá
            const jaExiste = registrosCache.find(r => r.idNotificacao == idNotificacao);
            if (!jaExiste) {
              registrosCache.push(dados.registro);
            }

            // Abre a edição imediatamente com os dados pré-carregados
            abrirEdicaoComDados(idNotificacao, dados.registro);

            // Limpa o sessionStorage
            sessionStorage.removeItem('notificacaoParaEditar');
            return;
          } else {
            // Dados expirados ou não correspondem, remove
            sessionStorage.removeItem('notificacaoParaEditar');
          }
        } catch (error) {
          console.error('[gerenciar] Erro ao processar dados pré-carregados:', error);
          sessionStorage.removeItem('notificacaoParaEditar');
        }
      }

      // Se não há dados pré-carregados, verifica se os dados já estão no cache
      if (registrosCache.length > 0) {
        abrirEdicaoComDados(idNotificacao);
      } else {
        // Se os dados ainda não foram carregados, aguarda
        console.log('[gerenciar] Aguardando carregamento dos dados para editar notificação...');
        aguardandoCarregamento = true;

        // Mostra indicador visual de carregamento
        mostrarIndicadorCarregamentoEdicao();

        // Tenta novamente após um pequeno delay (os dados podem estar carregando)
        const tentarAbrirEdicao = setInterval(() => {
          if (registrosCache.length > 0) {
            clearInterval(tentarAbrirEdicao);
            ocultarIndicadorCarregamentoEdicao();
            abrirEdicaoComDados(idNotificacao);
            aguardandoCarregamento = false;
          }
        }, 100);

        // Timeout de segurança (10 segundos)
        setTimeout(() => {
          if (aguardandoCarregamento) {
            clearInterval(tentarAbrirEdicao);
            ocultarIndicadorCarregamentoEdicao();
            aguardandoCarregamento = false;
            mostrarAlerta('⏱️ Timeout ao carregar dados da notificação. Tente novamente.', 'error');
          }
        }, 10000);
      }
    }

    function abrirEdicaoComDados(idNotificacao, registroForcado = null) {
      // Se um registro foi passado diretamente, usa ele
      let registro = registroForcado;

      // Caso contrário, busca no cache
      if (!registro) {
        registro = registrosCache.find(r => r.idNotificacao == idNotificacao);
      }

      if (registro) {
        console.log('[gerenciar] Registro encontrado para edição:', registro);
        // Abre a edição do registro
        abrirEdicao(registro.linha);

        // Remove o parâmetro da URL sem recarregar a página
        const novaUrl = window.location.pathname;
        window.history.replaceState({}, document.title, novaUrl);
        idNotificacaoParaEditar = null;
      } else {
        console.warn('[gerenciar] Registro não encontrado para ID:', idNotificacao);
        mostrarAlerta(`❌ Registro com ID #${idNotificacao} não encontrado.`, 'error');
        idNotificacaoParaEditar = null;
      }
    }

    function mostrarIndicadorCarregamentoEdicao(mensagem = 'Carregando dados da notificação...') {
      if (window.loadingIndicator) {
        window.loadingIndicator.show(mensagem);
      }
    }

    function ocultarIndicadorCarregamentoEdicao() {
      if (window.loadingIndicator) {
        window.loadingIndicator.hide();
      }
    }


    document.addEventListener('DOMContentLoaded', function () {
      // Verifica se há parâmetro ?editar= na URL
      verificarParametroEditar();
      configurarEventosTranstornosEdit();
      configurarEventosTipoViolenciaEdit();
      configurarEventosTipoViolenciaInstitucionalEdit();
      configurarEventosEncaminhamentoEdit();
      configurarEventosInstituicaoEdit();
      carregarOpcoesRegiaoEdit(false);

      // Variável global para preservar o valor da região durante a edição
      window._regiaoEditPreservada = null;

      // Listener para monitorar mudanças no select de região
      const regiaoSelect = document.getElementById('edit_regiao');
      if (regiaoSelect) {
        // Monitora mudanças no select
        regiaoSelect.addEventListener('change', function () {
          console.log('[gerenciar] 🔔 Select de região mudou para:', this.value);
          if (window._regiaoEditPreservada && this.value !== window._regiaoEditPreservada && this.value === '') {
            console.log('[gerenciar] ⚠️ Região foi resetada para vazio! Valor preservado:', window._regiaoEditPreservada);
            // Restaura imediatamente
            setTimeout(() => {
              for (let option of this.options) {
                if (option.value === window._regiaoEditPreservada || option.textContent.trim() === window._regiaoEditPreservada) {
                  this.value = option.value;
                  console.log('[gerenciar] ✅ Região restaurada após reset:', option.value);
                  break;
                }
              }
            }, 10);
          }
        });

        // Monitora quando o innerHTML é alterado (quando opções são recarregadas)
        let restaurandoRegiao = false; // Flag para evitar loops
        const observer = new MutationObserver((mutations) => {
          if (window._regiaoEditPreservada && !restaurandoRegiao) {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' && regiaoSelect.value !== window._regiaoEditPreservada) {
                console.log('[gerenciar] ⚠️ Select de região foi resetado! Restaurando valor:', window._regiaoEditPreservada);
                restaurandoRegiao = true;
                setTimeout(() => {
                  // Tenta encontrar a opção
                  let encontrada = false;
                  for (let option of regiaoSelect.options) {
                    if (option.value === window._regiaoEditPreservada || option.textContent.trim() === window._regiaoEditPreservada) {
                      regiaoSelect.value = option.value;
                      encontrada = true;
                      console.log('[gerenciar] ✅ Região restaurada:', option.value);
                      break;
                    }
                  }
                  // Se não encontrou, adiciona a opção
                  if (!encontrada) {
                    const novaOpcao = document.createElement('option');
                    novaOpcao.value = window._regiaoEditPreservada;
                    novaOpcao.textContent = window._regiaoEditPreservada;
                    regiaoSelect.appendChild(novaOpcao);
                    regiaoSelect.value = window._regiaoEditPreservada;
                    console.log('[gerenciar] ✅ Região adicionada e restaurada:', window._regiaoEditPreservada);
                  }
                  restaurandoRegiao = false;
                }, 10);
              }
            });
          }
        });

        observer.observe(regiaoSelect, { childList: true, subtree: true });
      }

      // Listener para mostrar/ocultar campo de detalhes PCD
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');

      pcdTranstornoSelect.addEventListener('change', function () {
        if (this.value === 'Sim') {
          // Mostra o campo de detalhes
          pcdDetalhesContainer.classList.remove('hidden');
          // Adiciona animação suave
          pcdDetalhesContainer.style.animation = 'slideDown 0.3s ease-out';
        } else {
          // Esconde o campo de detalhes
          pcdDetalhesContainer.classList.add('hidden');
          // Limpa os transtornos selecionados
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          // Limpa input
          pcdDetalhesInput.value = '';
        }
      });

      // ========================================
      // Listener para preview de anexos na edição
      // ========================================
      const inputAnexosEditar = document.getElementById('anexos-editar');
      if (inputAnexosEditar) {
        inputAnexosEditar.addEventListener('change', function (e) {
          if (window.criarPreviewAnexos && e.target.files.length > 0) {
            const previewContainer = document.getElementById('preview-anexos-editar');
            criarPreviewAnexos(e.target.files, previewContainer);
          }
        });
      }
    });

    // ========================================
    // SISTEMA TIPO DE VIOLÊNCIA - MÚLTIPLAS TAGS (EDIÇÃO)
    // ========================================

    // Renderiza as tags de tipo de violência
    function renderizarTagsTipoViolenciaEdit() {
      const container = document.getElementById('edit_tipoViolencia-tags');
      const hiddenInput = document.getElementById('edit_tipoViolencia');

      if (editTiposViolenciaSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de violência adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = editTiposViolenciaSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolenciaEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por vírgula
      hiddenInput.value = editTiposViolenciaSelecionados.join(', ');
    }

    // Remove um tipo de violência
    function removerTipoViolenciaEdit(index) {
      editTiposViolenciaSelecionados.splice(index, 1);
      renderizarTagsTipoViolenciaEdit();
      verificarViolenciaInstitucionalEdit();
    }

    // Adiciona um tipo de violência
    function adicionarTipoViolenciaEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Evita duplicatas
      if (!editTiposViolenciaSelecionados.includes(textoTrimmed)) {
        editTiposViolenciaSelecionados.push(textoTrimmed);
        renderizarTagsTipoViolenciaEdit();
      }

      // Limpa input
      document.getElementById('edit_tipoViolencia-input').value = '';
      document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');

      // Verifica se deve mostrar/esconder campo de violência institucional
      verificarViolenciaInstitucionalEdit();
    }

    // Filtra e mostra sugestões de tipo de violência
    function mostrarSuggestoesTipoViolenciaEdit(query) {
      const suggestionsDiv = document.getElementById('edit_tipoViolencia-suggestions');

      // Se query vazia, mostra todas as opções disponíveis
      const filtrados = query.trim() === ''
        ? tiposViolenciaPredefinidos.filter(tipo => !editTiposViolenciaSelecionados.includes(tipo))
        : tiposViolenciaPredefinidos.filter(tipo =>
          tipo.toLowerCase().includes(query.toLowerCase()) &&
          !editTiposViolenciaSelecionados.includes(tipo)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugestão. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolenciaEdit('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    function configurarEventosTipoViolenciaEdit() {
      const input = document.getElementById('edit_tipoViolencia-input');

      input.addEventListener('focus', function (e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });

      input.addEventListener('input', function (e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });

      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolenciaEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#edit_tipoViolencia-input') && !e.target.closest('#edit_tipoViolencia-suggestions')) {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA TIPO DE VIOLÊNCIA INSTITUCIONAL - MÚLTIPLAS TAGS (EDIÇÃO)
    // ========================================

    // Array para armazenar tipos de violência institucional selecionados
    let editTiposViolenciaInstitucionalSelecionados = [];

    // Renderiza as tags de tipo de violência institucional
    function renderizarTagsTipoViolenciaInstitucionalEdit() {
      const container = document.getElementById('edit_tipoViolenciaInstitucional-tags');
      const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');

      if (editTiposViolenciaInstitucionalSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de violência institucional adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = editTiposViolenciaInstitucionalSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolenciaInstitucionalEdit(${index})"
            class="hover:bg-orange-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por vírgula
      hiddenInput.value = editTiposViolenciaInstitucionalSelecionados.join(', ');
    }

    // Remove um tipo de violência institucional
    function removerTipoViolenciaInstitucionalEdit(index) {
      editTiposViolenciaInstitucionalSelecionados.splice(index, 1);
      renderizarTagsTipoViolenciaInstitucionalEdit();
    }

    // Adiciona um tipo de violência institucional
    function adicionarTipoViolenciaInstitucionalEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Evita duplicatas
      if (!editTiposViolenciaInstitucionalSelecionados.includes(textoTrimmed)) {
        editTiposViolenciaInstitucionalSelecionados.push(textoTrimmed);
        renderizarTagsTipoViolenciaInstitucionalEdit();
      }

      // Limpa input
      document.getElementById('edit_tipoViolenciaInstitucional-input').value = '';
      document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
    }

    // Filtra e mostra sugestões de tipo de violência institucional
    function mostrarSuggestoesTipoViolenciaInstitucionalEdit(query) {
      const suggestionsDiv = document.getElementById('edit_tipoViolenciaInstitucional-suggestions');

      // Carrega tipos de violência institucional disponíveis
      const tiposInstitucionalPredefinidos = carregarTiposViolenciaInstitucional();

      // Se query vazia, mostra todas as opções disponíveis
      const filtrados = query.trim() === ''
        ? tiposInstitucionalPredefinidos.filter(tipo => !editTiposViolenciaInstitucionalSelecionados.includes(tipo))
        : tiposInstitucionalPredefinidos.filter(tipo =>
          tipo.toLowerCase().includes(query.toLowerCase()) &&
          !editTiposViolenciaInstitucionalSelecionados.includes(tipo)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugestão. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-orange-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolenciaInstitucionalEdit('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    function configurarEventosTipoViolenciaInstitucionalEdit() {
      const input = document.getElementById('edit_tipoViolenciaInstitucional-input');

      if (!input) return;

      input.addEventListener('focus', function (e) {
        mostrarSuggestoesTipoViolenciaInstitucionalEdit(e.target.value);
      });

      input.addEventListener('input', function (e) {
        mostrarSuggestoesTipoViolenciaInstitucionalEdit(e.target.value);
      });

      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolenciaInstitucionalEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
        }
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#edit_tipoViolenciaInstitucional-input') && !e.target.closest('#edit_tipoViolenciaInstitucional-suggestions')) {
          document.getElementById('edit_tipoViolenciaInstitucional-suggestions').classList.add('hidden');
        }
      });
    }

    // Verifica se "Institucional" está selecionado no tipo de violência e mostra/esconde o campo
    function verificarViolenciaInstitucionalEdit() {
      const tipoViolenciaInput = document.getElementById('edit_tipoViolencia');
      const container = document.getElementById('edit_tipoViolenciaInstitucionalContainer');

      if (!tipoViolenciaInput || !container) return;

      const tipoViolenciaValue = tipoViolenciaInput.value || '';
      const tiposSelecionados = tipoViolenciaValue.split(',').map(t => t.trim()).filter(t => t);
      const temInstitucional = tiposSelecionados.some(t => {
        const tLower = t.toLowerCase();
        return tLower === 'institucional' || tLower.includes('institucional');
      });

      if (temInstitucional) {
        container.classList.remove('hidden');
        // Adiciona animação suave
        container.style.animation = 'slideDown 0.3s ease-out';
        // Torna o campo obrigatório quando visível
        const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = true;
      } else {
        container.classList.add('hidden');
        // Limpa os tipos selecionados
        editTiposViolenciaInstitucionalSelecionados = [];
        renderizarTagsTipoViolenciaInstitucionalEdit();
        // Limpa input
        const input = document.getElementById('edit_tipoViolenciaInstitucional-input');
        if (input) input.value = '';
        // Remove obrigatoriedade quando oculto
        const hiddenInput = document.getElementById('edit_tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = false;
      }
    }

    // Carrega tipos de violência institucional disponíveis
    function carregarTiposViolenciaInstitucional() {
      return [
        'Física',
        'Psicológica',
        'Administrativa',
        'Patrimonial',
        'Moral',
        'Sexual',
        'Negligência',
        'Não informada'
      ];
    }

    // ========================================
    // SISTEMA DE ENCAMINHAMENTO COM TAGS (EDIÇÃO)
    // ========================================
    function renderizarTagsEncaminhamentoEdit() {
      const container = document.getElementById('edit_encaminhamentos-tags');
      const hiddenInput = document.getElementById('edit_encaminhamento');

      if (editEncaminhamentosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum encaminhamento adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = editEncaminhamentosSelecionados.map((enc, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${enc}
          <button 
            type="button" 
            onclick="removerEncaminhamentoEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      hiddenInput.value = editEncaminhamentosSelecionados.join(', ');
    }

    function removerEncaminhamentoEdit(index) {
      editEncaminhamentosSelecionados.splice(index, 1);
      renderizarTagsEncaminhamentoEdit();
    }

    function adicionarEncaminhamentoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      if (!editEncaminhamentosSelecionados.includes(textoTrimmed)) {
        editEncaminhamentosSelecionados.push(textoTrimmed);
        renderizarTagsEncaminhamentoEdit();
      }

      document.getElementById('edit_encaminhamento-input').value = '';
      document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
    }

    function mostrarSugestoesEncaminhamentoEdit(query) {
      const suggestionsDiv = document.getElementById('edit_encaminhamento-suggestions');

      const filtrados = query.trim() === ''
        ? encaminhamentosPredefinidos.filter(enc => !editEncaminhamentosSelecionados.includes(enc))
        : encaminhamentosPredefinidos.filter(enc =>
          enc.toLowerCase().includes(query.toLowerCase()) &&
          !editEncaminhamentosSelecionados.includes(enc)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugestão. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(enc => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarEncaminhamentoEdit('${enc}')">
          ${enc}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    function configurarEventosEncaminhamentoEdit() {
      const input = document.getElementById('edit_encaminhamento-input');

      input.addEventListener('focus', function (e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });

      input.addEventListener('input', function (e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });

      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarEncaminhamentoEdit(e.target.value);
        }
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#edit_encaminhamento-input') && !e.target.closest('#edit_encaminhamento-suggestions')) {
          document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA DE AUTOCOMPLETE CMEI/EMEF (EDIÇÃO)
    // ========================================
    // ========================================
    // SISTEMA DE AUTOCOMPLETE CMEI/EMEF (EDIÇÃO)
    // ========================================
    function removerAcentosEdit(texto) {
      return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function filtrarInstituicoesEdit(termo) {
      const termoLower = removerAcentosEdit(termo.toLowerCase());
      const termoSemEspacos = termoLower.replace(/\s+/g, '');

      return edit_instituicoesFiltradas.filter(inst => {
        const nomeNormalizado = removerAcentosEdit(inst.nomeOriginal.toLowerCase());
        // Proteção para sigla undefined - gera dinamicamente se necessário
        const sigla = inst.sigla || gerarSiglaEdit(inst.nomeOriginal);
        const siglaNormalizada = removerAcentosEdit(sigla.toLowerCase());

        // Busca por palavras no nome
        const palavras = termoLower.split(' ').filter(p => p.length > 0);
        const matchPorPalavras = palavras.every(palavra => nomeNormalizado.includes(palavra));

        // Busca pela sigla (sem espaços)
        const matchPorSigla = siglaNormalizada.includes(termoSemEspacos);

        // Busca pela sigla com caracteres consecutivos (ex: "ACM" encontra "Ana Chaves Mendes")
        const matchPorIniciaisConsecutivas = siglaNormalizada.startsWith(termoSemEspacos);

        return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
      });
    }

    function renderizarSugestoesEdit(resultados) {
      const autocompleteList = document.getElementById('edit_autocompleteList');
      autocompleteList.innerHTML = '';

      if (resultados.length === 0) {
        autocompleteList.innerHTML = '<div class="no-results">🔍 Nenhuma instituição encontrada</div>';
        autocompleteList.classList.add('show');
        return;
      }

      // Mostra todas as escolas, sem limite de exibicao
      const totalResultados = resultados.length;

      if (totalResultados > 5) {
        const header = document.createElement('div');
        header.className = 'autocomplete-header';
        header.innerHTML = `📋 ${totalResultados} escola${totalResultados > 1 ? 's' : ''} disponíve${totalResultados > 1 ? 'is' : 'l'} - digite para filtrar`;
        autocompleteList.appendChild(header);
      }

      resultados.forEach((inst, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';

        // Badge do tipo
        const badge = document.createElement('span');
        badge.className = `autocomplete-badge ${inst.tipo.toLowerCase()}`;
        badge.textContent = inst.tipo;

        // Container para nome e sigla
        const infoContainer = document.createElement('div');
        infoContainer.className = 'flex flex-col';

        // Nome sem a redundância da sigla
        const nomeSemTipo = inst.nomeOriginal.replace(inst.tipo + ' ', '');
        const nomeSpan = document.createElement('span');
        nomeSpan.className = 'autocomplete-nome';
        nomeSpan.textContent = nomeSemTipo;

        // Sigla (menor e em cinza)
        const siglaSpan = document.createElement('span');
        siglaSpan.className = 'text-xs text-gray-500 mt-0.5';
        siglaSpan.textContent = inst.sigla ? `Sigla: ${inst.sigla}` : '';

        infoContainer.appendChild(nomeSpan);
        infoContainer.appendChild(siglaSpan);

        item.appendChild(badge);
        item.appendChild(infoContainer);

        // Evento de clique
        item.addEventListener('click', function () {
          selecionarInstituicaoEdit(inst);
        });

        autocompleteList.appendChild(item);
      });

      autocompleteList.classList.add('show');
    }

    // Função separada para selecionar a instituição na edição
    function selecionarInstituicaoEdit(inst) {
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      const autocompleteList = document.getElementById('edit_autocompleteList');

      // Define o valor completo original no campo
      cmeiEmefInput.value = inst.nomeOriginal;

      // Fecha a lista
      autocompleteList.classList.remove('show');

      // ====== AUTO-PREENCHIMENTO DE REGIÃO ======
      // Prioriza a região que vem do banco de dados (inst.regiao = school_region)
      let regiao = inst.regiao || '';

      // Fallback: busca região via módulo caso inst.regiao esteja vazio
      if (!regiao && window.NAVMEscolasTecnico) {
        regiao = window.NAVMEscolasTecnico.getRegiaoEscola(inst.nomeOriginal) || '';
        if (regiao) console.log('[Escolas Edit] Região obtida via fallback (getRegiaoEscola):', regiao);
      }

      const regiaoDisplay = document.getElementById('edit_regiao-display');
      const regiaoHidden = document.getElementById('edit_regiao');

      if (regiao) {
        if (regiaoDisplay) regiaoDisplay.value = regiao;
        if (regiaoHidden) regiaoHidden.value = regiao;
        console.log('[Escolas Edit] Região preenchida automaticamente:', regiao);
      } else {
        if (regiaoDisplay) regiaoDisplay.value = '';
        if (regiaoHidden) regiaoHidden.value = '';
        console.warn('[Escolas Edit] Região não encontrada para:', inst.nomeOriginal);
      }
    }

    function atualizarSelecaoVisualEdit(items) {
      items.forEach((item, index) => {
        if (index === edit_indiceSelecionado) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // ==========================================
    // SISTEMA DE FILTRO DE ESCOLAS (EDIÇÃO)
    // ==========================================
    let edit_escolasDisponiveis = []; // Array de escolas carregadas (filtradas ou todas)
    let edit_mostrandoTodasEscolas = false; // Estado do toggle

    /**
     * Inicializa o filtro de escolas para o modal de edição
     */
    async function inicializarFiltroEscolasEdit() {
      const userEmail = sessionStorage.getItem('userEmail');
      const userRole = sessionStorage.getItem('userRole');
      const userName = sessionStorage.getItem('userName'); // PRIORIDADE: usar nome

      console.log('[Escolas Edit] Inicializando filtro de escolas...');
      console.log('[Escolas Edit] Nome:', userName, '| Email:', userEmail, '| Role:', userRole);

      // Verifica se o módulo está disponível
      if (!window.NAVMEscolasTecnico) {
        console.warn('[Escolas Edit] Modulo NAVMEscolasTecnico não carregado. Usando lista padrão.');
        return;
      }

      // Feedback visual: carregando
      mostrarStatusEscolasEdit('Carregando escolas...', 'loading');

      // RESET IMPORTANTE: Sempre começa mostrando apenas as do técnico (se for técnico)
      // Mas se já estivesse mostrando todas (ex: reabriu modal), preserva? 
      // Não, melhor resetar para o padrão "minhas escolas" ao abrir o modal,
      // a menos que o usuário explicitamente mude.
      // edit_mostrandoTodasEscolas = false; // Opcional, já é o default

      // Carrega escolas do usuário (ASSÍNCRONO) - PRIORIZA NOME sobre EMAIL
      edit_escolasDisponiveis = await window.NAVMEscolasTecnico.getEscolasUsuario(
        userEmail,
        userRole,
        edit_mostrandoTodasEscolas,
        userName
      );

      console.log('[Escolas Edit] Total de escolas disponíveis:', edit_escolasDisponiveis.length);

      // Feedback visual: resultado
      if (edit_escolasDisponiveis.length > 0) {
        mostrarStatusEscolasEdit(edit_escolasDisponiveis.length + ' escolas carregadas', 'success');
      } else {
        mostrarStatusEscolasEdit('Nenhuma escola encontrada', 'error');
      }

      // Verifica se é técnico para mostrar botão "Ver Todas"
      const isTecnico = userRole === 'tecnico';

      if (isTecnico) {
        const filtroContainer = document.getElementById('edit_filtro-escolas-container');
        const filtroAtivoContainer = document.getElementById('edit_filtroAtivoContainer');

        // MOSTRA OS ELEMENTOS APENAS PARA TÉCNICOS
        if (filtroContainer) filtroContainer.classList.remove('hidden');
        if (filtroAtivoContainer) filtroAtivoContainer.classList.remove('hidden');

        // Identifica o técnico - PRIORIZA NOME sobre EMAIL
        let tecnico = null;
        if (userName) {
          tecnico = window.NAVMEscolasTecnico.identificarTecnicoPorNome(userName);
        }
        if (!tecnico && userEmail) {
          tecnico = window.NAVMEscolasTecnico.identificarTecnico(userEmail);
        }

        if (tecnico) {
          console.log('[Escolas Edit] Técnico identificado:', tecnico);
          atualizarIndicadorFiltroEdit();
        } else {
          console.warn('[Escolas Edit] Técnico não identificado. Nome:', userName, '| Email:', userEmail);
        }
      } else {
        // Se não for técnico, esconde os controles (caso tenham ficado visíveis)
        const filtroContainer = document.getElementById('edit_filtro-escolas-container');
        const filtroAtivoContainer = document.getElementById('edit_filtroAtivoContainer');
        if (filtroContainer) filtroContainer.classList.add('hidden');
        if (filtroAtivoContainer) filtroAtivoContainer.classList.add('hidden');
      }

      // Configura evento do botão "Ver Todas" (remove listener anterior para não duplicar, se possível, ou usa onclick direto no HTML ou check de flag)
      // Como a função é chamada ao abrir modal, ideal é garantir que o listener não acumule.
      // Mas o botão está no HTML estático, então o listener deve ser adicionado apenas UMA VEZ na inicialização da página?
      // O 'inicializarFiltroEscolasEdit' pode ser chamado múltiplas vezes.
      // Melhor mover o addEventListener para fora ou verificar.
      const btnVerTodas = document.getElementById('edit_btnVerTodasEscolas');
      if (btnVerTodas) {
        // Remove anterior para garantir
        btnVerTodas.removeEventListener('click', toggleVerTodasEscolasEdit);
        btnVerTodas.addEventListener('click', toggleVerTodasEscolasEdit);
      }

      // Atualiza a UI do botão baseada no estado atual
      atualizarInterfaceBotaoEdit();
    }

    /**
     * Alterna entre ver todas as escolas e apenas as do técnico
     */
    async function toggleVerTodasEscolasEdit() {
      edit_mostrandoTodasEscolas = !edit_mostrandoTodasEscolas;

      const userEmail = sessionStorage.getItem('userEmail');
      const userRole = sessionStorage.getItem('userRole');
      const userName = sessionStorage.getItem('userName');

      // Feedback visual
      mostrarStatusEscolasEdit(
        edit_mostrandoTodasEscolas ? 'Carregando todas as escolas...' : 'Carregando suas escolas...',
        'loading'
      );

      // Recarrega escolas com o novo estado (ASSÍNCRONO)
      edit_escolasDisponiveis = await window.NAVMEscolasTecnico.getEscolasUsuario(
        userEmail,
        userRole,
        edit_mostrandoTodasEscolas,
        userName
      );

      // Feedback visual: resultado
      mostrarStatusEscolasEdit(
        edit_escolasDisponiveis.length + ' escolas ' + (edit_mostrandoTodasEscolas ? 'totais' : 'atribuídas'),
        'success'
      );

      // Atualiza UI do botão
      atualizarInterfaceBotaoEdit();

      // Limpa campo de escola e região (comportamento padrão de filtro)
      // Mas na edição, cuidado se o usuário clicou sem querer.
      // O requisito diz "Mesma lógica". Lá limpa.
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      const regiaoDisplay = document.getElementById('edit_regiao-display');
      const regiaoHidden = document.getElementById('edit_regiao');

      if (cmeiEmefInput) cmeiEmefInput.value = '';
      if (regiaoDisplay) regiaoDisplay.value = '';
      if (regiaoHidden) regiaoHidden.value = '';

      // Re-filtra instituições se um tipo já estiver selecionado
      // update: edit_tipoInstituicaoSelecionado é a variável usada no closure de configurarEventosInstituicaoEdit
      // precisamos acessá-la ou garantir que edit_instituicoesFiltradas seja atualizada corretamente
      const selectTipo = document.getElementById('edit_tipoInstituicao');
      if (selectTipo && selectTipo.value) {
        // Re-executa o filtro
        // Como edit_instituicoesFiltradas é global (ou escopo superior), podemos atualizar
        if (edit_escolasDisponiveis.length > 0) {
          edit_instituicoesFiltradas = edit_escolasDisponiveis.filter(inst => inst.tipo === selectTipo.value);
          // Siglas
          edit_instituicoesFiltradas.forEach(inst => {
            if (!inst.sigla) inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
          });
          // Se o campo de texto estiver focado, atualiza sugestões?
          // Simule input vazio para recarregar lista se tiver foco
          if (document.activeElement === cmeiEmefInput) {
            renderizarSugestoesEdit(edit_instituicoesFiltradas);
          }
        }
      }

      // Atualiza indicador DEPOIS de re-filtrar
      atualizarIndicadorFiltroEdit();

      console.log('[Escolas Edit] Toggle Ver Todas:', edit_mostrandoTodasEscolas, '| Total filtrado:', edit_instituicoesFiltradas.length);
    }

    function atualizarInterfaceBotaoEdit() {
      const btnTexto = document.getElementById('edit_btnVerTodasText');
      const btnIcone = document.getElementById('edit_btnVerTodasIcone');

      if (edit_mostrandoTodasEscolas) {
        if (btnTexto) btnTexto.textContent = 'Minhas Escolas';
        if (btnIcone) btnIcone.textContent = '👤';
      } else {
        if (btnTexto) btnTexto.textContent = 'Ver Todas';
        if (btnIcone) btnIcone.textContent = '🌐';
      }
    }

    function atualizarIndicadorFiltroEdit() {
      const indicador = document.getElementById('edit_filtroAtivoIndicador');
      const texto = document.getElementById('edit_filtroAtivoTexto');

      if (!indicador || !texto) return;

      // Usa a quantidade filtrada por tipo se houver tipo selecionado
      const tipoSelect = document.getElementById('edit_tipoInstituicao');
      const temTipo = tipoSelect && tipoSelect.value;

      const quantidadeExibida = temTipo && edit_instituicoesFiltradas.length > 0
        ? edit_instituicoesFiltradas.length
        : edit_escolasDisponiveis.length;

      const tipoTexto = temTipo ? ` (${tipoSelect.value})` : '';

      if (edit_mostrandoTodasEscolas) {
        indicador.className = 'text-xs text-orange-600 flex items-center gap-1';
        texto.textContent = `Mostrando todas as ${quantidadeExibida} escolas${tipoTexto}`;
      } else {
        indicador.className = 'text-xs text-green-600 flex items-center gap-1';
        texto.textContent = `Mostrando suas ${quantidadeExibida} escolas atribuídas${tipoTexto}`;
      }
    }

    function mostrarStatusEscolasEdit(mensagem, tipo) {
      // Simplificado: apenas log ou status pequeno, já que não temos o elemento de status criado no HTML do plano
      // O plano mencionou "mostrarStatusEscolasEdit (opcional)" e "Feedback visual (Recomendado)"
      // Vamos tentar usar o autocomplete-wrapper para inserir msn se não existir
      const wrapper = document.querySelector('#edit_cmeiEmef')?.closest('.autocomplete-wrapper');
      if (!wrapper) return;

      let statusEl = document.getElementById('edit_escolasStatusFeedback');
      if (!statusEl) {
        statusEl = document.createElement('p');
        statusEl.id = 'edit_escolasStatusFeedback';
        statusEl.className = 'text-xs mt-1 transition-opacity duration-300';
        wrapper.parentElement.insertBefore(statusEl, wrapper.nextSibling); // Insere DEPOIS do wrapper
      }

      if (tipo === 'loading') {
        statusEl.textContent = '⏳ ' + mensagem;
        statusEl.className = 'text-xs mt-1 text-blue-600';
      } else if (tipo === 'success') {
        statusEl.textContent = '✅ ' + mensagem;
        statusEl.className = 'text-xs mt-1 text-green-600';
      } else if (tipo === 'error') {
        statusEl.textContent = '❌ ' + mensagem;
        statusEl.className = 'text-xs mt-1 text-red-600';
      }

      statusEl.style.opacity = '1';
      setTimeout(() => { statusEl.style.opacity = '0'; }, 3000);
    }

    function configurarEventosInstituicaoEdit() {
      const tipoInstituicaoSelect = document.getElementById('edit_tipoInstituicao');
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      const autocompleteList = document.getElementById('edit_autocompleteList');

      tipoInstituicaoSelect.addEventListener('change', async function () {
        edit_tipoInstituicaoSelecionado = this.value;

        // CRÍTICO: Não limpa o campo se estamos carregando dados de edição
        const isLoading = cmeiEmefInput.getAttribute('data-loading') === 'true';

        if (edit_tipoInstituicaoSelecionado) {
          cmeiEmefInput.disabled = false;
          cmeiEmefInput.placeholder = 'Digite para buscar...';

          // Só limpa o campo se NÃO estiver carregando dados
          if (!isLoading) {
            cmeiEmefInput.value = '';
            cmeiEmefInput.focus();
          }

          // Usa módulo de escolas por técnico se disponível (fallback para lista local)
          if (window.NAVMEscolasTecnico) {
            // Se a lista de escolas disponíveis ainda estiver vazia (primeiro acesso), inicializa
            if (edit_escolasDisponiveis.length === 0) {
              await inicializarFiltroEscolasEdit();
            }

            if (Array.isArray(edit_escolasDisponiveis)) {
              // Filtra da lista global já carregada (que respeita o toggle "minhas/todas")
              edit_instituicoesFiltradas = edit_escolasDisponiveis.filter(inst => inst.tipo === edit_tipoInstituicaoSelecionado);

              // Garante que todas as escolas tenham sigla
              edit_instituicoesFiltradas.forEach(inst => {
                if (!inst.sigla) inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
              });

              // ATUALIZA O INDICADOR DE FILTRO (Quantidade muda por tipo)
              atualizarIndicadorFiltroEdit();
            } else {
              console.error('[Escolas Edit] Erro: edit_escolasDisponiveis não é um array');
              edit_instituicoesFiltradas = [];
            }
          } else {
            edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === edit_tipoInstituicaoSelecionado);
          }
        } else {
          cmeiEmefInput.disabled = true;
          cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de instituição';

          // Só limpa o campo se NÃO estiver carregando dados
          if (!isLoading) {
            cmeiEmefInput.value = '';
          }

          autocompleteList.classList.remove('show');
        }
      });

      cmeiEmefInput.addEventListener('input', function () {
        const termo = this.value.trim();
        edit_indiceSelecionado = -1;

        if (termo.length === 0) {
          // Se vazio, mostra TODAS as escolas (comportamento rico)
          renderizarSugestoesEdit(edit_instituicoesFiltradas);
          return;
        }

        const resultados = filtrarInstituicoesEdit(termo);
        renderizarSugestoesEdit(resultados);
      });

      // EVENTO: Focus no campo mostra lista
      cmeiEmefInput.addEventListener('focus', function () {
        if (edit_instituicoesFiltradas.length > 0) {
          const termo = this.value.trim();
          if (termo.length === 0) {
            renderizarSugestoesEdit(edit_instituicoesFiltradas);
          } else {
            const resultados = filtrarInstituicoesEdit(termo);
            renderizarSugestoesEdit(resultados);
          }
        }
      });

      cmeiEmefInput.addEventListener('keydown', function (e) {
        const items = autocompleteList.querySelectorAll('.autocomplete-item');

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          edit_indiceSelecionado = Math.min(edit_indiceSelecionado + 1, items.length - 1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          edit_indiceSelecionado = Math.max(edit_indiceSelecionado - 1, -1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (edit_indiceSelecionado >= 0 && items[edit_indiceSelecionado]) {
            items[edit_indiceSelecionado].click();
          }
        } else if (e.key === 'Escape') {
          autocompleteList.classList.remove('show');
        }
      });

      document.addEventListener('click', function (e) {
        if (!cmeiEmefInput.contains(e.target) && !autocompleteList.contains(e.target)) {
          autocompleteList.classList.remove('show');
        }
      });
    }

    // ========================================
    // CARREGAR OPÇÕES DE REGIÃO (EDIÇÃO)
    // ========================================
    function carregarOpcoesRegiaoEdit(preservarValor = false) {
      const select = document.getElementById('edit_regiao');
      if (!select) return;

      // Preserva o valor atual se solicitado
      const valorAtual = preservarValor ? select.value : '';

      select.innerHTML = '<option value="">Selecione...</option>';

      regioesDisponiveis.forEach(function (regiao) {
        const option = document.createElement('option');
        option.value = regiao;
        option.textContent = regiao;
        select.appendChild(option);
      });

      // Restaura o valor se foi preservado
      if (preservarValor && valorAtual) {
        select.value = valorAtual;
      }
    }

    // ========================================
    // FUNÇÕES DE ALERTA
    // ========================================
    function mostrarAlerta(mensagem, tipo = 'info') {
      const container = document.getElementById('alertContainer');
      const cores = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };

      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-lg shadow-md`;
      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <p class="font-medium">${mensagem}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-4">×</button>
        </div>
      `;

      container.appendChild(alerta);
      setTimeout(() => alerta.remove(), 5000);
    }

    // ========================================
    // CARREGAR REGISTROS DA PLANILHA
    // ========================================
    function carregarRegistros(manterPagina = false, linhaEditada = null, paginaRetorno = null, forceReload = false, limparCache = false, isUserAction = false) {
      // Armazena flag para uso no callback de sucesso
      window._carregarRegistrosIsUserAction = isUserAction;

      const btn = document.getElementById('btnCarregar');
      const info = document.getElementById('loadingInfo');

      // ✨ Remove alerta e animação quando usuário clica para carregar
      // (indica que ele viu a notificação e está atualizando)
      if (!linhaEditada) { // Só faz isso se não for reload automático após edição
        // Fecha o alerta se estiver visível
        if (typeof NotificationManager !== 'undefined' && NotificationManager.state === 'alert_showing') {
          NotificationManager.startAlertExit();
        }

        // Remove o alerta vermelho de notificações novas
        const alertaExistente = document.getElementById('alerta-novas-notificacoes');
        if (alertaExistente) {
          alertaExistente.remove();
          console.log('[gerenciar] 🔴 Alerta de notificações removido do DOM');
        }

        // Remove animação do botão
        desativarPulseBotao('btnCarregar');

        // ✨ SINCRONIZAÇÃO: Só marca como atualizado se for uma ação explícita do usuário
        // (não marca se for chamada automaticamente durante navegação ou carregamento inicial)
        if (isUserAction) {
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          if (ultimoIdSalvo) {
            const notifId = parseInt(ultimoIdSalvo, 10);
            if (typeof marcarPopupAzulAtualizado === 'function') {
              marcarPopupAzulAtualizado(notifId);
            }
            // Atualiza último ID sincronizado imediatamente
            try {
              localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
              console.log('[Sync] ✅ Estado sincronizado limpo e último ID atualizado após clique no botão Carregar Registros');
              // Zera contador global de novas notificações
              localStorage.removeItem('naam_new_notif_count');
            } catch (e) {
              console.warn('[Sync] ⚠️ Erro ao atualizar estado sincronizado:', e);
            }
          }
        }

        // Limpa flag do localStorage
        try {
          localStorage.removeItem('naam_new_notif_flag');
        } catch (e) {
          console.warn('[carregarRegistros] Erro ao limpar flag:', e);
        }
      }

      // Só limpa cache se for uma ação explícita do usuário (limparCache = true)
      if (limparCache) {
        limparCacheERecarregarNotificacoes();
      }

      // Verifica cache primeiro (se não for reload forçado)
      if (!forceReload && !linhaEditada && window.DataCache && window.CONFIG && window.CONFIG.CACHE_ENABLED) {
        const cachedData = window.DataCache.get('gerenciar_casos');
        if (cachedData) {
          console.log('[gerenciar] ✅ Dados carregados do cache');

          // Não exibir alerta ao carregar do cache; apenas renderiza

          registrosCache = cachedData;
          renderizarTabela(cachedData, manterPagina);
          info.textContent = cachedData.length + ' registros encontrados (cache)';
          info.classList.remove('text-red-600', 'animate-pulse');
          info.classList.add('text-green-600');
          popularFiltrosAvancados();

          // Se estava aguardando carregamento para editar, abre a edição agora
          if (aguardandoCarregamento && idNotificacaoParaEditar) {
            ocultarIndicadorCarregamentoEdicao();
            abrirEdicaoComDados(idNotificacaoParaEditar);
            aguardandoCarregamento = false;
          }

          verificarParametroEditar();
          return;
        }
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">⏳</span> <span>Carregando...</span>';
      btn.classList.add('opacity-75', 'cursor-not-allowed');
      info.textContent = 'Buscando dados da planilha...';
      info.classList.add('animate-pulse');

      console.log('[gerenciar] carregarRegistros iniciado');

      // Atualiza loading indicator se estiver visível
      if (window.loadingIndicator && linhaEditada) {
        window.loadingIndicator.update('Recarregando lista de registros...', 95);
      }

      // Cria iframe oculto
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = APPS_SCRIPT_URL + '?action=list&t=' + Date.now();

      // Listener para receber resposta
      const messageHandler = function (event) {
        // Aceita APENAS mensagens do Google Apps Script
        if (!event.origin.includes('google')) {
          return; // Ignora silenciosamente outras origens
        }

        // Verifica se é a resposta esperada (tem success e registros)
        if (!event.data || typeof event.data.success === 'undefined') {
          return; // Ignora mensagens que não são do nosso Apps Script
        }

        console.log('[gerenciar] Resposta do Apps Script recebida');

        btn.disabled = false;
        btn.innerHTML = '🔄 Carregar Registros';
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        info.classList.remove('animate-pulse');

        if (event.data.success && event.data.registros) {
          console.log('[gerenciar] ✅ Sucesso:', event.data.registros.length, 'registros');
          registrosCache = event.data.registros;

          // Salva no cache
          if (window.DataCache && window.CONFIG && window.CONFIG.CACHE_ENABLED) {
            const expiry = window.CONFIG.CACHE_EXPIRY || 3600000;
            window.DataCache.set('gerenciar_casos', event.data.registros, { expiry: expiry });
            console.log('[gerenciar] 💾 Dados salvos no cache');

            // 🔴 Remove alerta vermelho automaticamente quando cache é atualizado
            // (atualização bem-sucedida = cache mudou = botão foi clicado)
            const alertaExistente = document.getElementById('alerta-novas-notificacoes');
            if (alertaExistente) {
              alertaExistente.remove();
              console.log('[gerenciar] 🔴 Alerta vermelho removido automaticamente do DOM (cache atualizado)');
            }
          }

          // Se estava aguardando carregamento para editar, abre a edição agora
          if (aguardandoCarregamento && idNotificacaoParaEditar) {
            ocultarIndicadorCarregamentoEdicao();
            abrirEdicaoComDados(idNotificacaoParaEditar);
            aguardandoCarregamento = false;
          }

          // Sempre verifica se há parâmetro ?editar= após carregar registros
          // (pode ter sido carregado antes mas não encontrado)
          verificarParametroEditar();

          // Se foi uma edição, define a página ANTES de renderizar (PRIORITÁRIO)
          if (linhaEditada && paginaRetorno) {
            console.log('[gerenciar] 🎯 FORÇANDO paginaAtual =', paginaRetorno, '(era:', paginaAtual + ')');
            paginaAtual = paginaRetorno;
            // Força manterPagina = true para garantir que não será resetado
            manterPagina = true;
          }

          renderizarTabela(event.data.registros, manterPagina);
          info.textContent = event.data.registros.length + ' registros encontrados';
          info.classList.remove('text-red-600');
          info.classList.add('text-green-600');
          // Popular opções dos filtros avançados
          popularFiltrosAvancados();

          // ✨ SINCRONIZAÇÃO: Após carregar dados com sucesso, atualiza último ID sincronizado
          // Só atualiza se foi uma ação explícita do usuário (isUserAction = true)
          // Isso é controlado pela flag window._carregarRegistrosIsUserAction
          setTimeout(() => {
            if (window._carregarRegistrosIsUserAction) {
              const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
              if (ultimoIdSalvo) {
                const notifId = parseInt(ultimoIdSalvo, 10);
                try {
                  localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
                  console.log('[Sync] ✅ Último ID sincronizado atualizado após carregar registros (ação do usuário):', notifId);
                } catch (e) {
                  console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
                }
              }
              // Limpa a flag
              window._carregarRegistrosIsUserAction = false;
            }
          }, 1000);

          // Se o recarregamento foi disparado pelo estado global, reseta a variável para false
          if (window.PendingGlobalRefresh) {
            try {
              localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
                state: false,
                timestamp: Date.now(),
                source: 'gerenciar-casos'
              }));
              console.log('[Gerenciar] 🔁 Estado global resetado para false após atualização bem-sucedida');
            } catch (e) {
              console.warn('[Gerenciar] ⚠️ Falha ao resetar estado global:', e);
            } finally {
              window.PendingGlobalRefresh = false;
            }
          }

          // ✅ Reseta flag de atualização disparada pelo usuário
          window.atualizacaoDisparadaPeloUsuario = false;
          console.log('[gerenciar] ✅ Flag de atualização resetado para false. Alertas podem aparecer novamente.');

          // Log informativo: atualização concluída pela página Gerenciar Registros
          console.log('[gerenciar] ✅ Foi possível atualizar os dados pela página Gerenciar Registros');

          console.log('[gerenciar] 📄 Após renderizar - paginaAtual:', paginaAtual);

          // Se foi uma edição, destaca e faz scroll até a linha editada
          if (linhaEditada) {
            setTimeout(() => {
              // ========================================
              // NOVO FLUXO: Verificar paginaAntesEdicao e navegar automaticamente (ANTES de buscar o elemento)
              // ========================================
              console.log('[gerenciar] 📋 paginaAntesEdicao =', paginaAntesEdicao);

              if (paginaAntesEdicao && paginaAntesEdicao !== 1) {
                console.log('[gerenciar] 🎯 Navegando para página:', paginaAntesEdicao);
                // Renderização já ocorreu, agora navega para a página armazenada
                paginaAtual = paginaAntesEdicao;
                renderizarPagina();

                // Força uma segunda renderização visual para garantir que a página mudou
                setTimeout(() => {
                  console.log('[gerenciar] 🔄 Reforçando renderização da página:', paginaAtual);
                  renderizarPagina();
                }, 100);

                console.log('[gerenciar] ✅ Página alterada para:', paginaAtual);
                // Reseta a variável para próximo carregamento
                paginaAntesEdicao = 1;
              } else {
                console.log('[gerenciar] ℹ️ paginaAntesEdicao === 1 ou não definida, mantendo página inicial');
              }

              // AGORA SIM, procura pela linha (DEPOIS de navegar para a página correta)
              console.log('[gerenciar] 🔍 Procurando linha:', linhaEditada, 'na página:', paginaAtual);
              const linhaElemento = document.querySelector(`tr[data-linha="${linhaEditada}"]`);
              console.log('[gerenciar] Elemento encontrado:', linhaElemento ? '✅ SIM' : '❌ NÃO');

              if (linhaElemento) {
                // Destaca a linha com animação
                linhaElemento.classList.add('highlight-edited');

                // Scroll suave até a linha
                linhaElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });

                console.log('[gerenciar] ✅ Linha destacada, escondendo loading...');

                // Esconde o loading APÓS destacar
                if (window.loadingIndicator) {
                  window.loadingIndicator.hide();
                }

                // Mostra alerta de sucesso
                mostrarAlerta('✅ Registro atualizado com sucesso!', 'success');

                // Remove destaque após 3 segundos
                setTimeout(() => {
                  linhaElemento.classList.remove('highlight-edited');
                }, 3000);
              } else {
                console.warn('[gerenciar] ⚠️ Elemento não encontrado no DOM');
                console.warn('[gerenciar] Página atual:', paginaAtual);
                console.warn('[gerenciar] Total de registros filtrados:', registrosFiltrados.length);
                console.warn('[gerenciar] Linhas disponíveis:',
                  Array.from(document.querySelectorAll('tr[data-linha]')).map(el => el.getAttribute('data-linha')));
                // Esconde loading mesmo sem encontrar
                if (window.loadingIndicator) {
                  window.loadingIndicator.hide();
                }
                mostrarAlerta('✅ Registro atualizado com sucesso!', 'success');
              }
            }, 1200); // Aumentado para 1200ms para garantir renderização completa
          }
        } else {
          console.error('[gerenciar] ❌ Erro na resposta:', event.data.message);
          info.textContent = 'Erro ao carregar';
          info.classList.remove('text-green-600');
          info.classList.add('text-red-600');
          mostrarAlerta('❌ ' + (event.data.message || 'Erro ao carregar registros'), 'error');
          // ✅ Reseta flag mesmo em caso de erro
          window.atualizacaoDisparadaPeloUsuario = false;
          console.log('[gerenciar] ⚠️ Flag de atualização resetado (erro). Alertas podem aparecer novamente.');
        }

        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };

      window.addEventListener('message', messageHandler);
      document.body.appendChild(iframe);

      // Timeout
      setTimeout(() => {
        if (btn.disabled) {
          btn.disabled = false;
          btn.innerHTML = '🔄 Carregar Registros';
          btn.classList.remove('opacity-75', 'cursor-not-allowed');
          info.textContent = 'Timeout';
          info.classList.remove('animate-pulse', 'text-green-600');
          info.classList.add('text-red-600');
          window.removeEventListener('message', messageHandler);
          iframe.remove();
          mostrarAlerta('⏱️ Timeout ao carregar registros. Isso pode acontecer se houver muitos dados. Tente novamente.', 'error');
          // ✅ Reseta flag mesmo em caso de timeout
          window.atualizacaoDisparadaPeloUsuario = false;
          console.log('[gerenciar] ⏱️ Flag de atualização resetado (timeout). Alertas podem aparecer novamente.');
        }
      }, 30000); // Aumentado de 15s para 30s
    }

    // ========================================
    // POSICIONAR NA NOTIFICAÇÃO EDITADA (DEPRECATED - LÓGICA MOVIDA PARA carregarRegistros)
    // ========================================
    function posicionarNaNotificacao(linha, paginaRetorno) {
      // Esta função foi simplificada - a lógica agora está em carregarRegistros
      // para garantir que a página seja definida ANTES de renderizar a tabela
      console.log('[gerenciar] posicionarNaNotificacao chamado (deprecated)');
    }

    // ========================================
    // RENDERIZAR TABELA COM PAGINAÇÃO
    // ========================================
    function renderizarTabela(registros, manterPagina = false) {
      console.log('[renderizarTabela] Chamado com manterPagina:', manterPagina, '| paginaAtual antes:', paginaAtual);
      registrosFiltrados = registros || [];
      if (!manterPagina) {
        console.log('[renderizarTabela] Resetando para página 1');
        paginaAtual = 1; // Reset para primeira página apenas se não for reload
      } else {
        console.log('[renderizarTabela] Mantendo página:', paginaAtual);
      }
      renderizarPagina();
      console.log('[renderizarTabela] Finalizado | paginaAtual depois:', paginaAtual);
    }

    function renderizarPagina() {
      const tbody = document.getElementById('corpoTabela');
      const registros = registrosFiltrados;

      if (!registros || registros.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <div class="text-5xl">🔍</div>
                <div class="text-lg font-medium">Nenhum registro encontrado</div>
              </div>
            </td>
          </tr>
        `;
        atualizarContadores(0, 0);
        renderizarPaginacao(0);
        return;
      }

      // Calcula índices da paginação
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const registrosPagina = registros.slice(inicio, fim);

      tbody.innerHTML = registrosPagina.map((reg, idx) => {
        let membroFamiliar = '-';
        if (reg.foiMembroFamiliar === 'Sim') membroFamiliar = 'Sim';
        else if (reg.foiMembroFamiliar === 'Não') membroFamiliar = 'Não';
        else membroFamiliar = 'Não informado';

        // Formata data de criação para DD/MM/YYYY
        let dataCriacaoFormatada = 'Sem informação';
        if (reg.dataCriacao) {
          // Se vier no formato DD/MM/YYYY HH:MM, pega só a data
          if (reg.dataCriacao.includes('/')) {
            dataCriacaoFormatada = reg.dataCriacao.split(' ')[0];
          }
          // Se vier no formato ISO (2026-01-15T19:39:58...)
          else if (reg.dataCriacao.includes('T') || reg.dataCriacao.includes('-')) {
            const data = new Date(reg.dataCriacao);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            dataCriacaoFormatada = dia + '/' + mes + '/' + ano;
          }
        }

        // Formata data de última edição para DD/MM/YYYY
        let dataUltimaEdicaoFormatada = 'Nenhuma edição';
        if (reg.dataUltimaEdicao) {
          // Se vier no formato DD/MM/YYYY HH:MM, pega só a data
          if (reg.dataUltimaEdicao.includes('/')) {
            dataUltimaEdicaoFormatada = reg.dataUltimaEdicao.split(' ')[0];
          }
          // Se vier no formato ISO
          else if (reg.dataUltimaEdicao.includes('T') || reg.dataUltimaEdicao.includes('-')) {
            const data = new Date(reg.dataUltimaEdicao);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            dataUltimaEdicaoFormatada = dia + '/' + mes + '/' + ano;
          }
        }

        return `
        <tr class="hover:bg-blue-50/50 transition-colors duration-150 border-b border-gray-100" data-nome="${(reg.criancaEstudante || '').toLowerCase()}" data-linha="${reg.linha}">
          <td class="px-4 py-4 text-sm text-gray-800 font-medium">
            ${reg.criancaEstudante || '-'}
            ${(reg.pcdTranstorno === 'Sim' && reg.pcdDetalhes) ? '<span class="ml-2 text-blue-600" title="PCD: ' + (reg.pcdDetalhes || '').replace(/"/g, '&quot;') + '">♿</span>' : ''}
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.dataNT || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.idade || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
              ${reg.tipoViolencia || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.cmeiEmef || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
              ${reg.regiao || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-xs text-gray-500">
            <div class="font-medium text-gray-700">${dataCriacaoFormatada}</div>
          </td>
          <td class="px-4 py-4 text-xs text-gray-500">
            ${dataUltimaEdicaoFormatada !== 'Nenhuma edição' ? `
              <div class="font-medium text-gray-700">${dataUltimaEdicaoFormatada}</div>
            ` : `
              <div class="text-gray-400 italic">Sem edições</div>
            `}
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 ${membroFamiliar === 'Sim' ? 'bg-green-100 text-green-800' : membroFamiliar === 'Não' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'} rounded-full text-xs font-semibold">
              ${membroFamiliar}
            </span>
          </td>
          <td class="px-4 py-4">
            <div class="flex gap-2 justify-center">
              <button 
                onclick="abrirEdicao(${reg.linha})"
                class="btn-editar px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-blue-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>✏️</span>
                <span>Editar</span>
              </button>
              <button 
                onclick="confirmarExclusao(${reg.linha}, '${(reg.criancaEstudante || '')
            .replace(/\\/g, '\\\\')
            .replace(/\n|\r/g, ' ')
            .replace(/'/g, "\\'")}')"
                class="btn-excluir px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-red-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>🗑️</span>
                <span>Excluir</span>
              </button>
            </div>
          </td>
        </tr>
        `;
      }).join('');

      atualizarContadores(registros.length, registrosPagina.length);
      renderizarPaginacao(registros.length);
    }

    // ========================================
    // PAGINAÇÃO
    // ========================================
    function renderizarPaginacao(total) {
      const container = document.getElementById('paginacaoControles');
      const totalPaginas = Math.ceil(total / itensPorPagina);

      if (totalPaginas <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';

      // Botão Anterior
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual - 1})" 
          ${paginaAtual === 1 ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 ${paginaAtual === 1 ? '' : 'group-hover:-translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Anterior
          </span>
        </button>
      `;

      // Números das páginas - mostra no máximo 3 números + primeira e última
      const maxBotoesVisiveis = 3;

      // Se total de páginas é menor ou igual a 5, mostra todas
      if (totalPaginas <= 5) {
        for (let i = 1; i <= totalPaginas; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
      } else {
        // Sempre mostra primeira página
        html += `<button onclick="irParaPagina(1)" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === 1 ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">1</button>`;

        // Determina quais páginas do meio mostrar
        let inicio, fim;

        if (paginaAtual <= 3) {
          // Próximo às primeiras páginas: mostra 2, 3, 4
          inicio = 2;
          fim = 4;
        } else if (paginaAtual >= totalPaginas - 2) {
          // Próximo às últimas páginas: mostra (total-3), (total-2), (total-1)
          inicio = totalPaginas - 3;
          fim = totalPaginas - 1;
        } else {
          // No meio: mostra (atual-1), atual, (atual+1)
          inicio = paginaAtual - 1;
          fim = paginaAtual + 1;
        }

        // Adiciona elipse antes se necessário
        if (inicio > 2) {
          html += '<span class="text-gray-400 font-bold px-2">•••</span>';
        }

        // Mostra as páginas do meio
        for (let i = inicio; i <= fim; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }

        // Adiciona elipse depois se necessário
        if (fim < totalPaginas - 1) {
          html += '<span class="text-gray-400 font-bold px-2">•••</span>';
        }

        // Sempre mostra última página
        html += `<button onclick="irParaPagina(${totalPaginas})" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === totalPaginas ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">${totalPaginas}</button>`;
      }

      // Botão Próximo
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual + 1})" 
          ${paginaAtual === totalPaginas ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === totalPaginas ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            Próximo
            <svg class="w-4 h-4 ${paginaAtual === totalPaginas ? '' : 'group-hover:translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </span>
        </button>
      `;

      container.innerHTML = html;
    }

    function irParaPagina(pagina) {
      const totalPaginas = Math.ceil(registrosFiltrados.length / itensPorPagina);
      if (pagina < 1 || pagina > totalPaginas) return;
      paginaAtual = pagina;
      renderizarPagina();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mudarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // CONSTANTES E FUNÇÕES AUXILIARES (COPIADAS DO PAINEL-CASOS.HTML)
    // ========================================

    // Dados CSV inline das listas de CMEIs e EMEFs
    const CSV_CMEIS = `Nome,Sigla
Adácio Bispo dos Santos TI,ABS
Álvaro Fernandes Lima TI,AFL
Ana Maria Chaves Colares,AMCC
Anízio Spínola Teixeira,AST
Carlos Alberto Martinelli de Souza TI,EAMS
Carlita Corrêa Pereira TI,CCP
Carlos Mendes,CM
Darcy Castello de Mendonça,DCM
Dom. João Batista da Motta e Albuquerque TI,JBMA
Dr. Denizart Santos TI,DS
Darcy Vargas,DV
Edlma Maria Soares Braga TTI,EMSB
Ernestina Pessoa,EP
Gilda de Athayde Ramos,GAR
Gisela da Cruz Militão,GCM
Georgiana da Trindade Faria,GTF
Hecy Alves Fraga TI,HAF
Jacivinha Ferreira de Souza Simões TI,JFSS
Juízo Pedro de Aguiar,JPA
Luiz Carlos Grecco TI,LCG
Laurentina Mendonça Corrêa,LMC
Luíza Pereira Muniz Corrêa TI,LPMC
Lidia Rocha Feitosa,LRF
Lisandra Ignes Carpanedo do Carmo,LICC
Magnólia Dias Miranda Cunha TTI,MUMC
Maria Goretti Coutinho Cosme TI,MGCC
Menino Jesus TI,MJ
Maria Nazareth Menegueli TTI,MNM
Marlene Dilande Simonetti,MDS
Nalcyrley Silva Braga,NSB
Oscalina Nunes Andrade,ONA
Odila Simões,OS
Professora Cida Barreto,PCB
Dr. Pedro Feu Rosa,PFR
Padre Giovanni Bartesaghi TTI,PGB
Rubem Braga,RB
Rubens Duarte de Albuquerque TTI,RDA
Robson José Nassur Peçoto TI,RJNP
Rubens José Vervloet Gomes TI,RJVG
Reinaldo Ridolfi,RR
Professora Sophia Musengiyvi Loureiro,SML
Sinclair Phillips,SP
Silvanete da Silva Rosa Rocha TI,SSRR
Thomas Tommasi TTI,TT
Terezinha Vasconcellos Salvador,TVS
Valdivia de Penna Antunes Rodrigues TI,VPAR
Yolanda Lucas da Silva,VLS
Zilmar Alves de Melo,ZAM
Zulmira Gomes Martins Marcarini Cavalcanti,ZGMC
Zélia Viana de Aguiar,ZVA`;

    const CSV_EMEFS = `Nome,Sigla
Alberto de Almeida,AA
Adão Benezath,AB
Aristóbulo Barbosa Leão,ABL
Álvaro de Castro Mattos,ACM
Arthur da Costa e Silva,ACS
Amilton Monteiro da Silva,AMS
Alvimar Silva,AS
Adilson da Silva Castro,ASC
Adevalni Sysesmundo Ferreira de Azevedo,ASFA
Anacleta Schneider Lucas TI,ASLC
Ceciliano Abel de Almeida,CAA
Castelo Branco,CB
Custódia Dias de Campos,CDC
CEJA Prof. Admardo Serafim de Oliveira,EJA ASO
Éber Louzada Zippinotti,ELZ
Edna de Mattos Siqueira Gaudio TI,EMSG
Eunice Perreira Silveira TI,EPS
Eliane Rodrigues dos Santos,ERS
Escola Experimental de Vitória-UFES,UFES
Elzira Vivacqua dos Santos,EVS
Francisco Lacerda de Aguiar,FLA
Heloisa Abreu Júdice de Mattos,HAJM
Irmã Jacinta Soares de Souza Lima,IJSSL
Izaura Marques da Silva TI,IMS
José Áureo Monjardim TI,JAM
João Bandeira,JB
Juscelino Kubitschek de Oliveira,JKO
José Lemos de Miranda TI,JLM
Lenir Borlot,LB
Moacyr Avidos TI,MA
Mauro Braga,MB
Marieta Escobar,ME
Maria José Costa Moraes,MJCM
Maria Leonor Pereira da Silva,MLPS
Marechal Mascarenhas de Moraes,MMM
Maria Madalena Oliveira Domingues,MMOD
Maria Stella de Novaes,MSN
Neusa Nunes Gonçalves,NNG
Orlandina D'Almeida Lucas,ODAL
Otto Ewald Júnior,OEJ
Octacílio Lomba,OL
Prezideu Amorim,PA
Padre Anchieta,PAN
Padre Guido Ceotto,PGC
Paulo Reglus Neves Freire TI,PRNF
Paulo Roberto Vieira Gomes,PRVG
Rita de Cássia Oliveira,RCO
Regina Maria Silva,RMS
Ronaldo Soares,RS
Suzete Cuendet,SC
São Vicente de Paulo,SVP
Tancredo de Almeida Neves,TAN
Vercenílio da Silva Pascoal,VSP
Zilda Andrade,ZA`;

    // Função para processar os CSVs e criar os mapeamentos
    function processarCSVs() {
      const linhasCMEI = CSV_CMEIS.split('\n').slice(1);
      const linhasEMEF = CSV_EMEFS.split('\n').slice(1);

      const cmeiSiglas = {};
      const emefSiglas = {};

      linhasCMEI.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            cmeiSiglas[sigla] = nome;
          }
        }
      });

      linhasEMEF.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            emefSiglas[sigla] = nome;
          }
        }
      });

      return { cmeiSiglas, emefSiglas };
    }

    const { cmeiSiglas: CMEI_SIGLAS, emefSiglas: EMEF_SIGLAS } = processarCSVs();

    // Normalização para reduzir erro de digitação
    function normalizeText(str) {
      return String(str || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s\/]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Identifica se uma escola é EMEF ou CMEI
    function getTipoInstituicao(nomeEscola) {
      if (!nomeEscola) return null;
      const nome = String(nomeEscola).trim().toUpperCase();
      if (EMEF_SIGLAS[nome]) return 'EMEF';
      if (CMEI_SIGLAS[nome]) return 'CMEI';
      for (const sigla in EMEF_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) return 'EMEF';
      }
      for (const sigla in CMEI_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) return 'CMEI';
      }
      if (nome.includes('EMEF')) return 'EMEF';
      if (nome.includes('CMEI')) return 'CMEI';
      return null;
    }

    // ========================================
    // AUTOCOMPLETE DE ESCOLAS
    // ========================================
    function setupEscolaAutocomplete() {
      const input = document.getElementById('filterEscolaSearch');
      const container = document.getElementById('filterEscolaContainer');
      const list = document.getElementById('filterEscolaAutocompleteList');
      const tagsContainer = document.getElementById('filterEscolaSelectedTags');
      if (!input || !container || !list) return;

      if (input.dataset.bound === 'true') return;
      input.dataset.bound = 'true';

      let cached = [];
      let selectedIndex = -1;
      let closeTimer = null;

      const buildReverseSiglas = () => {
        const rev = { cmei: {}, emef: {} };
        if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS) {
          Object.keys(CMEI_SIGLAS).forEach((sigla) => {
            const nome = CMEI_SIGLAS[sigla];
            if (!sigla || !nome) return;
            const full = `CMEI ${String(nome).trim()}`;
            rev.cmei[normalizeText(full)] = String(sigla).trim();
          });
        }
        if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS) {
          Object.keys(EMEF_SIGLAS).forEach((sigla) => {
            const nome = EMEF_SIGLAS[sigla];
            if (!sigla || !nome) return;
            const full = `EMEF ${String(nome).trim()}`;
            rev.emef[normalizeText(full)] = String(sigla).trim();
          });
        }
        return rev;
      };

      const reverseSiglas = buildReverseSiglas();

      const getNomeFromSigla = (sigla) => {
        const s = String(sigla || '').trim().toUpperCase();
        if (!s) return '';
        if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS && CMEI_SIGLAS[s]) return `CMEI ${CMEI_SIGLAS[s]}`;
        if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS && EMEF_SIGLAS[s]) return `EMEF ${EMEF_SIGLAS[s]}`;
        return '';
      };

      const renderSelectedTags = () => {
        if (!tagsContainer) return;
        const checked = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]:checked'));
        tagsContainer.innerHTML = '';

        if (!checked.length) {
          tagsContainer.innerHTML = '<span class="text-xs text-gray-500">Nenhuma escola selecionada</span>';
          return;
        }

        checked.forEach((cb) => {
          const raw = String(cb.getAttribute('data-value') || '').trim();
          const nomeFromSigla = getNomeFromSigla(raw);
          const label = nomeFromSigla || raw;

          const tag = document.createElement('span');
          tag.className = 'selected-tag';

          const tipo = getTipoInstituicao(label) || getTipoInstituicao(raw) || '';
          if (tipo) {
            const badge = document.createElement('span');
            badge.className = `autocomplete-badge ${String(tipo).toLowerCase()}`;
            badge.textContent = tipo;
            tag.appendChild(badge);
          }

          const text = document.createElement('span');
          text.className = 'selected-tag-label';
          text.textContent = label;
          tag.appendChild(text);

          const remove = document.createElement('button');
          remove.type = 'button';
          remove.className = 'selected-tag-remove';
          remove.textContent = '×';
          remove.addEventListener('click', () => {
            cb.checked = false;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
          });
          tag.appendChild(remove);

          tagsContainer.appendChild(tag);
        });
      };

      const rebuildCache = () => {
        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]'));

        cached = checkboxes
          .map((cb) => {
            const raw = String(cb.getAttribute('data-value') || '').trim();
            if (!raw) return null;

            const nomeFromSigla = getNomeFromSigla(raw);
            const value = nomeFromSigla || raw;
            const tipo = getTipoInstituicao(value) || getTipoInstituicao(raw) || '';

            let sigla = '';
            if (nomeFromSigla) {
              sigla = raw;
            } else {
              const key = normalizeText(raw);
              sigla = reverseSiglas.cmei[key] || reverseSiglas.emef[key] || '';
            }

            const normalized = normalizeText(value);
            const siglaNormalized = normalizeText(sigla);

            return {
              checkboxValue: raw,
              value,
              tipo,
              sigla,
              siglaNormalized,
              normalized,
            };
          })
          .filter(Boolean);
      };

      const closeList = () => {
        if (closeTimer) {
          window.clearTimeout(closeTimer);
          closeTimer = null;
        }
        if (!list.classList.contains('show')) {
          list.classList.remove('hide');
          input.classList.remove('autocomplete-open');
          selectedIndex = -1;
          return;
        }

        list.classList.add('hide');
        list.classList.remove('show');
        input.classList.remove('autocomplete-open');
        selectedIndex = -1;

        window.setTimeout(() => {
          list.classList.remove('hide');
          list.style.display = 'none';
        }, 160);
      };

      const openList = () => {
        list.style.display = 'block';
        list.classList.remove('hide');
        if (!list.classList.contains('show')) list.classList.add('show');
        input.classList.add('autocomplete-open');
      };

      const updateSelectedVisual = () => {
        const items = Array.from(list.querySelectorAll('.autocomplete-item'));
        items.forEach((el, idx) => {
          if (idx === selectedIndex) el.classList.add('active');
          else el.classList.remove('active');
        });
        if (selectedIndex >= 0 && items[selectedIndex]) {
          items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      };

      const filterItems = (termRaw) => {
        const termoLower = normalizeText(String(termRaw || '')).trim();
        const termoSemEspacos = termoLower.replace(/\s+/g, '');
        const palavras = termoLower.split(/\s+/).filter(Boolean);

        if (!termoLower) return [];

        const selectedSet = new Set(
          Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]:checked'))
            .map((cb) => normalizeText(String(cb.getAttribute('data-value') || '').trim()))
            .filter(Boolean)
        );

        return cached.filter((it) => {
          const key = normalizeText(String(it.checkboxValue || '').trim());
          if (key && selectedSet.has(key)) return false;

          const nomeNormalizado = it.normalized;
          const siglaNormalizada = it.siglaNormalized || '';

          const matchPorPalavras = palavras.length ? palavras.every(p => nomeNormalizado.includes(p)) : true;
          const matchPorSigla = termoSemEspacos ? siglaNormalizada.includes(termoSemEspacos) : true;
          const matchPorIniciaisConsecutivas = termoSemEspacos ? siglaNormalizada.startsWith(termoSemEspacos) : true;

          return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
        });
      };

      const selectItem = (it) => {
        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]'));
        const target = normalizeText(String(it.checkboxValue || '').trim());
        const cbMatch = checkboxes.find((cb) => {
          const v = String(cb.getAttribute('data-value') || '').trim();
          return normalizeText(v) === target;
        });

        if (cbMatch) {
          cbMatch.checked = !cbMatch.checked;
          cbMatch.dispatchEvent(new Event('change', { bubbles: true }));
        }

        input.value = '';
        input.focus();
        closeList();
      };

      const render = (results) => {
        list.innerHTML = '';

        if (!results.length) {
          list.innerHTML = '<div class="no-results">🔍 Nenhuma instituição encontrada</div>';
          openList();
          return;
        }

        results.slice(0, 60).forEach((it, idx) => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';

          const badge = document.createElement('span');
          badge.className = `autocomplete-badge ${String(it.tipo || '').toLowerCase()}`;
          badge.textContent = it.tipo || '';

          const infoContainer = document.createElement('div');
          infoContainer.className = 'flex flex-col';

          const nomeSemTipo = it.tipo ? String(it.value).replace(String(it.tipo) + ' ', '') : it.value;
          const nomeSpan = document.createElement('span');
          nomeSpan.className = 'autocomplete-nome';
          nomeSpan.textContent = nomeSemTipo;

          const siglaSpan = document.createElement('span');
          siglaSpan.className = 'text-xs text-gray-500 mt-0.5';
          siglaSpan.textContent = `Sigla: ${it.sigla || ''}`;

          infoContainer.appendChild(nomeSpan);
          infoContainer.appendChild(siglaSpan);

          if (it.tipo) item.appendChild(badge);
          item.appendChild(infoContainer);

          item.addEventListener('click', () => selectItem(it));
          list.appendChild(item);
          if (idx === 0) selectedIndex = 0;
        });

        openList();
        updateSelectedVisual();
      };

      input.addEventListener('input', function () {
        const termRaw = String(this.value || '').trim();
        selectedIndex = -1;
        if (termRaw.length === 0) {
          list.innerHTML = '';
          closeList();
          return;
        }
        const results = filterItems(termRaw);
        render(results);
      });

      input.addEventListener('keydown', function (e) {
        const items = Array.from(list.querySelectorAll('.autocomplete-item'));
        if (!items.length) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedVisual();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedVisual();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
          }
        } else if (e.key === 'Escape') {
          closeList();
        }
      });

      document.addEventListener('click', function (e) {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          closeList();
        }
      });

      // Mantém cache atualizado quando checkboxes forem recriados
      const obs = new MutationObserver(() => {
        rebuildCache();
        renderSelectedTags();
      });
      obs.observe(container, { childList: true, subtree: true });

      // Atualiza tags quando checkboxes mudarem
      container.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.matches && t.matches('input[type="checkbox"][data-filter="escola"]')) {
          renderSelectedTags();
        }
      });

      rebuildCache();
      renderSelectedTags();
    }

    // Detecta se escola é Tempo Integral
    function isTempoIntegral(escolaValor) {
      if (!escolaValor) return false;
      const sigla = String(escolaValor).trim().toUpperCase();
      let nomeCompleto = null;
      if (CMEI_SIGLAS[sigla]) {
        nomeCompleto = CMEI_SIGLAS[sigla];
      } else if (EMEF_SIGLAS[sigla]) {
        nomeCompleto = EMEF_SIGLAS[sigla];
      } else {
        nomeCompleto = String(escolaValor).trim();
      }
      const nomeUpper = nomeCompleto.toUpperCase();
      return nomeUpper.endsWith(' TI') || nomeUpper.endsWith(' TTI');
    }

    // Verifica S/N
    function checkSN(value, filterValue) {
      if (!filterValue) return true;
      const val = String(value || '').toUpperCase().trim();
      if (!val) return false;
      const f = filterValue.toUpperCase();
      if (f === 'S') {
        return val === 'S' || val === 'SIM';
      }
      if (f === 'N') {
        return val === 'N' || val === 'NAO' || val === 'NÃO';
      }
      return false;
    }

    // Converte data
    function parseDateCell(value) {
      const str = String(value || '').trim();
      if (!str) return null;
      const dateMatch = str.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
      if (dateMatch) {
        const ano = parseInt(dateMatch[1], 10);
        const mes = parseInt(dateMatch[2], 10);
        const dia = parseInt(dateMatch[3], 10);
        return new Date(ano, mes, dia);
      }
      const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let dia = parseInt(m[1], 10);
        let mes = parseInt(m[2], 10) - 1;
        let ano = parseInt(m[3], 10);
        if (ano < 100) ano += 2000;
        const d = new Date(ano, mes, dia);
        if (d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia) {
          return d;
        }
        return null;
      }
      const num = parseFloat(str);
      if (!isNaN(num) && num > 1 && num < 100000) {
        const excelEpoch = new Date(1899, 11, 30);
        const days = num >= 60 ? num - 1 : num;
        const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
        return date;
      }
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    // Grupos de encaminhamento
    const encaminhamentosAgrupados = {
      redeAssistencia: ['Assistência Social', 'CRAS', 'CREAS', 'Casa Rosa', 'Psicólogo'],
      redeSaude: ['Saúde', 'UBS', 'US', 'CAPSIN'],
      redeEducacao: ['NAAM', 'Educação', 'Escola'],
      conselhoTutelar: ['CT'],
      redeSegurancaJustica: ['DACLE', 'DEAM', 'DEPI', 'DPCA', 'Defensoria Pública', 'Ministério Público', 'Outras delegacias']
    };

    const grupoNomes = {
      redeAssistencia: 'Rede de Assistência Social',
      redeSaude: 'Rede de Saúde',
      redeEducacao: 'Rede de Educação',
      conselhoTutelar: 'Conselho Tutelar',
      redeSegurancaJustica: 'Rede de Segurança e Justiça'
    };

    function belongsToAnyGroup(term) {
      const termNorm = normalizeText(term);
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        if (children.some(child => normalizeText(child) === termNorm)) {
          return true;
        }
      }
      return false;
    }

    // Normaliza transtorno
    function normalizarTranstorno(label) {
      if (!label) return label;
      const norm = normalizeText(label);
      const equivalenciasTDAH = ['tdah', 'tdh', 'tda h', 't d a h', 'deficit de atencao', 'deficit atencao', 'deficitdeatencao', 'deficit hiperatividade', 'transtorno de deficit', 'transtorno deficit', 'transtorno de deficit de atencao', 'transtorno deficit atencao', 'deficit de atencao e hiperatividade', 'deficit de atencao hiperatividade'];
      if (equivalenciasTDAH.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TDAH (Déficit de Atenção e Hiperatividade)';
      }
      const equivalenciasTEA = ['tea', 't e a', 'autismo', 'autista', 'transtorno do espectro autista', 'espectro autista', 'transtorno autista'];
      if (equivalenciasTEA.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TEA (Transtorno do Espectro Autista)';
      }
      const equivalenciasDI = ['di ', ' di', 'd i', 'deficiencia intelectual', 'deficiencia mental'];
      if (equivalenciasDI.some(e => norm === e || norm.includes(e))) {
        return 'DI (Deficiência Intelectual)';
      }
      const equivalenciasTOD = ['tod', 't o d', 'transtorno opositor', 'opositor desafiador', 'transtorno opositor desafiador'];
      if (equivalenciasTOD.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TOD (Transtorno Opositor Desafiador)';
      }
      return label;
    }

    function normalizarListaTranstornos(opcoes) {
      const map = new Map();
      opcoes.forEach(opt => {
        const normalizado = normalizarTranstorno(opt);
        if (!map.has(normalizado)) {
          map.set(normalizado, true);
        }
      });
      return Array.from(map.keys()).sort();
    }

    // Gera opções normalizadas
    function buildNormalizedOptions(colKey, data) {
      const map = new Map();
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        const valores = String(raw)
          .split(',')
          .flatMap(v => v.split('/'))
          .map(v => v.trim())
          .filter(v => v);
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }

    // Gera opções para TIPO DE VIOLÊNCIA (NÃO separa por barra)
    function buildNormalizedOptionsTipoViolencia(colKey, data) {
      const map = new Map();
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        const valores = String(raw)
          .split(',')
          .map(v => v.trim())
          .filter(v => v);
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }

    // Gera opções para Gênero (apenas M ou F)
    function buildGeneroOptions(data) {
      const valores = new Set();
      data.forEach(row => {
        const genero = row.identidadeGenero;
        if (genero) {
          const val = String(genero).trim().toUpperCase();
          if (val === 'M' || val === 'F') {
            valores.add(val);
          }
        }
      });
      return Array.from(valores).sort();
    }

    // ========================================
    // CRIAÇÃO DE CARDS DE REGIÃO (NOVO)
    // ========================================
    function createRegionCards(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      // Ajusta container para grid
      container.className = 'grid grid-cols-2 md:grid-cols-3 gap-3';

      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;

        // Wrapper do card
        const cardLabel = document.createElement('label');
        cardLabel.className = 'region-card relative flex items-center justify-center p-3 cursor-pointer rounded-lg border border-gray-200 bg-white hover:bg-blue-50 hover:border-blue-300 transition-all select-none text-sm font-medium text-gray-700 text-center h-full min-h-[50px]';
        cardLabel.htmlFor = id;

        // Checkbox oculto
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.className = 'peer sr-only custom-checkbox'; // sr-only esconde visualmente mas mantém acessível
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;

        // Estilos de seleção via CSS peer (Tailwind arbitrary variants ou CSS custom)
        // Como o Tailwind pode ser limitado aqui, usaremos JS change event para toggle de classe 'selected'
        // Mas também podemos usar :checked + div se estruturarmos assim. 
        // Vamos manter simples com JS toggle class no pai, similar ao plano.

        // Conteúdo do card
        const span = document.createElement('span');
        span.textContent = opt;

        cardLabel.appendChild(checkbox);
        cardLabel.appendChild(span);
        container.appendChild(cardLabel);

        // Event Listeners
        checkbox.addEventListener('change', function () {
          if (this.checked) {
            cardLabel.classList.add('selected', 'bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
            cardLabel.classList.remove('bg-white', 'text-gray-700', 'border-gray-200', 'hover:bg-blue-50');
          } else {
            cardLabel.classList.remove('selected', 'bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
            cardLabel.classList.add('bg-white', 'text-gray-700', 'border-gray-200', 'hover:bg-blue-50');
          }

          updateBadge(filterName);
          filtrarTabela();
        });
      });
    }

    // ========================================
    // CARDS DE TIPO DE VIOLÊNCIA
    // ========================================
    const VIOLENCE_TYPE_CONFIG = {
      'fisica': { icon: '👊', color: 'fisica', keywords: ['física', 'fisica', 'agressão física', 'agressao fisica'] },
      'psicologica': { icon: '🧠', color: 'psicologica', keywords: ['psicológica', 'psicologica', 'emocional', 'mental'] },
      'sexual': { icon: '⚠️', color: 'sexual', keywords: ['sexual', 'abuso sexual'] },
      'negligencia': { icon: '🚫', color: 'negligencia', keywords: ['negligência', 'negligencia', 'abandono', 'omissão'] },
      'institucional': { icon: '🏛️', color: 'institucional', keywords: ['institucional'] },
      'bullying': { icon: '😢', color: 'bullying', keywords: ['bullying'] },
      'cyberbullying': { icon: '💻', color: 'cyberbullying', keywords: ['cyberbullying', 'cyber'] },
      'autolesao': { icon: '💔', color: 'autolesao', keywords: ['autolesão', 'autolesao', 'automutilação', 'suicídio'] },
      'financeira': { icon: '💰', color: 'outros', keywords: ['financeira', 'econômica', 'patrimonial'] },
      'outros': { icon: '📋', color: 'outros', keywords: ['outro', 'outros', 'outra'] }
    };

    function detectViolenceType(text) {
      const normalized = normalizeText(text);
      for (const [key, config] of Object.entries(VIOLENCE_TYPE_CONFIG)) {
        for (const keyword of config.keywords) {
          if (normalized.includes(normalizeText(keyword))) {
            return { key, ...config };
          }
        }
      }
      return { key: 'outros', icon: '📋', color: 'outros', keywords: [] };
    }

    function createViolenceTypeCards(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = '';

      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;
        const typeConfig = detectViolenceType(opt);

        const card = document.createElement('div');
        card.className = 'violence-type-card';
        card.dataset.type = typeConfig.key;
        card.dataset.value = opt;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;
        checkbox.addEventListener('change', function () {
          if (this.checked) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
          updateBadge(filterName);
          filtrarTabela();
          if (filterName === 'tipoViolencia') {
            verificarViolenciaInstitucionalNoFiltro();
          }
        });

        const icon = document.createElement('div');
        icon.className = 'violence-type-icon';
        icon.textContent = typeConfig.icon;

        const label = document.createElement('div');
        label.className = 'violence-type-label';
        label.textContent = opt;

        const check = document.createElement('div');
        check.className = 'violence-type-check';
        check.textContent = '✓';

        card.appendChild(checkbox);
        card.appendChild(icon);
        card.appendChild(label);
        card.appendChild(check);

        card.addEventListener('click', function (e) {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });

        container.appendChild(card);
      });
    }

    function createViolenceSubCards(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = '';

      const INST_ICONS = {
        'verbal': '🗣️',
        'física': '👊',
        'omissão': '🚫',
        'discriminação': '🎯',
        'negligência': '⚡',
        'exposição': '👁️',
        'humilhação': '😔',
        'constrangimento': '😣',
        'default': '📌'
      };

      const getInstIcon = (text) => {
        const normalized = normalizeText(text);
        for (const [key, icon] of Object.entries(INST_ICONS)) {
          if (key !== 'default' && normalized.includes(normalizeText(key))) {
            return icon;
          }
        }
        return INST_ICONS.default;
      };

      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;

        const card = document.createElement('div');
        card.className = 'violence-sub-card';
        card.dataset.value = opt;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;
        checkbox.addEventListener('change', function () {
          if (this.checked) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
          updateBadge(filterName);
          filtrarTabela();
        });

        const icon = document.createElement('span');
        icon.className = 'violence-sub-icon';
        icon.textContent = getInstIcon(opt);

        const label = document.createElement('span');
        label.className = 'violence-sub-label';
        label.textContent = opt;

        const check = document.createElement('span');
        check.className = 'violence-sub-check';
        check.textContent = '✓';

        card.appendChild(checkbox);
        card.appendChild(icon);
        card.appendChild(label);
        card.appendChild(check);

        card.addEventListener('click', function (e) {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });

        container.appendChild(card);
      });
    }

    // Cria checkboxes
    function createCheckboxes(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;
        const div = document.createElement('div');
        div.className = 'checkbox-container flex items-center gap-2.5 p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.className = 'custom-checkbox';
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;
        checkbox.addEventListener('change', function () {
          updateBadge(filterName);
          filtrarTabela();
          if (filterName === 'tipoViolencia') {
            verificarViolenciaInstitucionalNoFiltro();
          }
        });
        const label = document.createElement('label');
        label.htmlFor = id;
        label.className = 'checkbox-label flex-1 text-gray-700';
        label.textContent = opt;
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    // Obtém valores selecionados
    function getCheckedValues(filterName) {
      const checkboxes = document.querySelectorAll(`input[data-filter="${filterName}"]:checked`);
      return Array.from(checkboxes).map(cb => cb.dataset.value);
    }

    // Atualiza badge
    function updateBadge(filterName) {
      const count = getCheckedValues(filterName).length;
      const badge = document.getElementById(`badge-${filterName}`);
      if (!badge) return;
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // Atualiza badge TI
    function updateBadgeTI() {
      const selectTI = document.getElementById('filterTI');
      const badge = document.getElementById('badge-ti');
      if (selectTI && selectTI.value && selectTI.value !== '') {
        badge.textContent = '1';
        badge.classList.remove('hidden');
      } else if (badge) {
        badge.classList.add('hidden');
      }
    }

    // Match encaminhamento
    function matchEncaminhamentoCell(cellValue, selectedTerms) {
      if (selectedTerms.length === 0) return true;
      if (!cellValue) return false;
      const cellValues = String(cellValue)
        .split(',')
        .flatMap(v => v.split('/'))
        .map(v => normalizeText(v.trim()))
        .filter(v => v);
      if (cellValues.length === 0) return false;
      const selectedNormalized = selectedTerms.map(t => normalizeText(t));
      return cellValues.some(cv => selectedNormalized.includes(cv));
    }

    // Match violência institucional
    function matchViolenciaInstitucionalCell(cellValue, selectedTerms) {
      if (selectedTerms.length === 0) return true;
      if (!cellValue) return false;
      const cellValues = String(cellValue)
        .split(',')
        .map(v => normalizeText(v.trim()))
        .filter(v => v);
      if (cellValues.length === 0) return false;
      const selectedNormalized = selectedTerms.map(t => normalizeText(t));
      return cellValues.some(cv => selectedNormalized.includes(cv));
    }

    // Coleta encaminhamentos selecionados
    function gatherSelectedEncaminhamentos() {
      const selectedCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
    }

    // Coleta violências institucionais selecionadas
    function gatherSelectedViolenciasInstitucionais() {
      const selectedCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
      return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
    }

    // ========================================
    // CONDICIONAL: filterPCD → section-tipoDeficiencia
    // ========================================
    function toggleTipoDeficienciaSection() {
      const filterPCD = document.getElementById('filterPCD');
      const sectionTipoDeficiencia = document.getElementById('section-tipoDeficiencia');

      if (!filterPCD || !sectionTipoDeficiencia) return;

      if (filterPCD.value === 'S') {
        sectionTipoDeficiencia.classList.remove('hidden');
      } else {
        sectionTipoDeficiencia.classList.add('hidden');
      }
    }

    // ========================================
    // FILTRAR TABELA (LÓGICA DO PAINEL-CASOS.HTML ADAPTADA)
    // ========================================
    function filtrarTabela() {
      const filters = {
        regioes: getCheckedValues('regiao'),
        tipos: getCheckedValues('tipoViolencia'),
        tiposInstituicao: getCheckedValues('tipoInstituicao'),
        escolas: getCheckedValues('escola'),
        encaminhamentos: gatherSelectedEncaminhamentos(),
        racas: getCheckedValues('raca'),
        generos: getCheckedValues('genero'),
        tiposDeficiencia: getCheckedValues('tipoDeficiencia'),
        orientacoes: getCheckedValues('orientacao'),
        violenciasInstitucionais: gatherSelectedViolenciasInstitucionais(),
        pcd: document.getElementById('filterPCD')?.value || '',
        ocorreu: document.getElementById('filterOcorreuEscola')?.value || '',
        fonteInformada: document.getElementById('filterFonteInformada')?.value || '',
        violenciaEscolaOcorreu: document.getElementById('filterViolenciaEscolaOcorreu')?.value || '',
        profissionalAutor: document.getElementById('filterProfissionalAutor')?.value || '',
        estudanteAutor: document.getElementById('filterEstudanteAutor')?.value || '',
        violenciaNaoEscola: document.getElementById('filterViolenciaNaoEscola')?.value || '',
        violenciaInformada: document.getElementById('filterViolenciaInformada')?.value || '',
        estudoCaso: document.getElementById('filterEstudoCaso')?.value || '',
        membroFamiliar: document.getElementById('filterMembroFamiliar')?.value || '',
        idadeMin: document.getElementById('filterIdadeMin')?.value || '',
        idadeMax: document.getElementById('filterIdadeMax')?.value || '',
        nome: document.getElementById('filterNome')?.value.toLowerCase() || document.getElementById('campoBusca')?.value.toLowerCase().trim() || '',
        dataInicio: document.getElementById('filterDataInicio')?.value || '',
        dataFim: document.getElementById('filterDataFim')?.value || ''
      };

      const dataInicioDate = filters.dataInicio ? new Date(filters.dataInicio + 'T00:00:00') : null;
      const dataFimDate = filters.dataFim ? new Date(filters.dataFim + 'T23:59:59') : null;

      registrosFiltrados = registrosCache.filter(reg => {
        // FILTRO: Foi um membro familiar?
        if (filters.membroFamiliar) {
          const valor = String(reg.foiMembroFamiliar || '').trim().toUpperCase();
          if (filters.membroFamiliar === 'Sim' && valor !== 'S' && valor !== 'SIM') return false;
          if (filters.membroFamiliar === 'Não' && valor !== 'N' && valor !== 'NAO' && valor !== 'NÃO') return false;
          if (filters.membroFamiliar === 'naoinformado' && valor !== '' && valor !== 'NÃO INFORMADO') return false;
        }

        // Multi (OU) - com suporte a campos multi-valor separados por vírgula
        if (filters.regioes.length) {
          const rowVals = String(reg.regiao || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.regioes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        if (filters.tipos.length) {
          const rowVals = String(reg.tipoViolencia || '')
            .split(',')
            .map(v => v.trim())
            .filter(v => v);
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.tipos.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        // Filtro por tipo de instituição (CMEI/EMEF/Não Encontrada)
        if (filters.tiposInstituicao.length) {
          const tipoEscola = getTipoInstituicao(reg.cmeiEmef);
          const tipoParaFiltro = tipoEscola || (reg.cmeiEmef ? 'Não Encontrada' : null);
          if (!tipoParaFiltro || !filters.tiposInstituicao.includes(tipoParaFiltro)) {
            return false;
          }
        }

        if (filters.escolas.length) {
          const rowVals = String(reg.cmeiEmef || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.escolas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        // FILTRO: Tempo Integral
        const selectTI = document.getElementById('filterTI');
        const filtroTI = selectTI ? selectTI.value : '';
        if (filtroTI) {
          if (filtroTI === 'TI') {
            if (!isTempoIntegral(reg.cmeiEmef)) return false;
          } else if (filtroTI === 'Regular') {
            if (isTempoIntegral(reg.cmeiEmef)) return false;
          }
        }

        if (filters.encaminhamentos.length) {
          if (!matchEncaminhamentoCell(reg.encaminhamento, filters.encaminhamentos)) {
            return false;
          }
        }

        if (filters.racas.length) {
          const rowVals = String(reg.racaCor || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.racas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        if (filters.generos.length) {
          const rowValue = String(reg.identidadeGenero || '').trim().toUpperCase();
          const ok = filters.generos.some(v => v.toUpperCase() === rowValue);
          if (!ok) return false;
        }

        // NOVO FILTRO: Tipo de deficiência/transtorno
        if (filters.tiposDeficiencia.length) {
          const isPCD = reg.pcdTranstorno === 'Sim' || String(reg.pcdTranstorno || '').toUpperCase() === 'S';
          if (!isPCD) return false;
          const rowVals = String(reg.pcdDetalhes || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          const rowNormalizados = rowVals.map(v => normalizarTranstorno(v));
          const filterNormalizados = filters.tiposDeficiencia;
          const rowNorms = rowNormalizados.map(v => normalizeText(v));
          const filterNorms = filterNormalizados.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        // NOVO FILTRO: Orientação Sexual (OU)
        if (filters.orientacoes.length) {
          const rowVals = String(reg.orientacaoSexual || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.orientacoes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        // FILTRO: Violências Institucionais
        if (filters.violenciasInstitucionais && filters.violenciasInstitucionais.length > 0) {
          const tipoViolencia = String(reg.tipoViolencia || '').toLowerCase();
          const temInstitucional = tipoViolencia.includes('institucional');
          if (temInstitucional) {
            if (!matchViolenciaInstitucionalCell(reg.tipoViolenciaInstitucional, filters.violenciasInstitucionais)) {
              return false;
            }
          } else {
            return false;
          }
        }

        // S/N
        if (filters.pcd && !checkSN(reg.pcdTranstorno, filters.pcd)) return false;

        // FILTRO: Ocorreu na escola - Combina colunas U (ocorreu) e Q (violenciaEscolaOcorreu)
        if (filters.ocorreu && filters.ocorreu !== '') {
          const ocorreuU = checkSN(reg.ocorreuEscola, 'S');
          const ocorreuQ = checkSN(reg.violenciaEscolaOcorreu, 'S');
          const ocorreuNaEscola = ocorreuU || ocorreuQ;
          if (filters.ocorreu === 'S' && !ocorreuNaEscola) return false;
          if (filters.ocorreu === 'N') {
            const naoOcorreuU = checkSN(reg.ocorreuEscola, 'N');
            const naoOcorreuQ = checkSN(reg.violenciaEscolaOcorreu, 'N');
            if (ocorreuNaEscola || (!naoOcorreuU && !naoOcorreuQ)) return false;
          }
        }

        if (filters.fonteInformada && !checkSN(reg.fonteEscola, filters.fonteInformada)) return false;
        if (filters.violenciaEscolaOcorreu && !checkSN(reg.violenciaEscolaOcorreu, filters.violenciaEscolaOcorreu)) return false;
        if (filters.profissionalAutor && filters.profissionalAutor !== '') {
          const profissionalS = checkSN(reg.profissionalAutor, 'S');
          const profissionalN = checkSN(reg.profissionalAutor, 'N');
          if (filters.profissionalAutor === 'S' && !profissionalS) return false;
          if (filters.profissionalAutor === 'N' && !profissionalN) return false;
        }
        if (filters.estudanteAutor && filters.estudanteAutor !== '') {
          const estudanteS = checkSN(reg.estudanteAutor, 'S');
          const estudanteN = checkSN(reg.estudanteAutor, 'N');
          if (filters.estudanteAutor === 'S' && !estudanteS) return false;
          if (filters.estudanteAutor === 'N' && !estudanteN) return false;
        }
        if (filters.profissionalAutor === 'N' && filters.estudanteAutor === 'N') {
          const profissionalN = checkSN(reg.profissionalAutor, 'N');
          const estudanteN = checkSN(reg.estudanteAutor, 'N');
          if (!profissionalN || !estudanteN) return false;
        }
        if (filters.violenciaNaoEscola && !checkSN(reg.violenciaNaoEscola, filters.violenciaNaoEscola)) return false;
        if (filters.violenciaInformada && !checkSN(reg.violenciaInformada, filters.violenciaInformada)) return false;
        if (filters.estudoCaso && !checkSN(reg.estudoCaso, filters.estudoCaso)) return false;

        // Idade
        const idade = parseInt(reg.idade || '0', 10);
        if (filters.idadeMin && !isNaN(idade) && idade < parseInt(filters.idadeMin, 10)) return false;
        if (filters.idadeMax && !isNaN(idade) && idade > parseInt(filters.idadeMax, 10)) return false;

        // Nome (contains)
        if (filters.nome) {
          const nome = String(reg.criancaEstudante || '').toLowerCase();
          if (!nome.includes(filters.nome)) return false;
        }

        // Data - converte dataNT para Date
        if ((dataInicioDate || dataFimDate)) {
          let rowDate = null;
          if (reg.dataNT_ISO) {
            rowDate = new Date(reg.dataNT_ISO + 'T00:00:00');
          } else if (reg.dataNT) {
            rowDate = parseDateCell(reg.dataNT);
          }
          if (!rowDate || isNaN(rowDate.getTime())) {
            return false;
          }
          const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
          const dataInicioOnly = dataInicioDate ? new Date(dataInicioDate.getFullYear(), dataInicioDate.getMonth(), dataInicioDate.getDate()) : null;
          const dataFimDateOnly = dataFimDate ? new Date(dataFimDate.getFullYear(), dataFimDate.getMonth(), dataFimDate.getDate()) : null;
          if (dataInicioOnly && rowDateOnly < dataInicioOnly) return false;
          if (dataFimDateOnly && rowDateOnly > dataFimDateOnly) return false;
        }

        return true;
      });

      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // ATUALIZAR CONTADORES
    // ========================================
    function atualizarContadores(total, visiveis) {
      document.getElementById('totalRegistros').textContent = total;
      document.getElementById('registrosVisiveis').textContent = visiveis;
    }

    // ========================================
    // ABRIR MODAL DE EDIÇÃO
    // ========================================
    /**
     * Gera sigla para a escola (ex: CMEI Maria da Penha -> MP)
     */
    function gerarSiglaEdit(nome) {
      if (!nome) return '';
      return nome.replace(/^(CMEI|EMEF)\s+/i, '')
        .split(/\s+/)
        .map(w => w[0])
        .join('')
        .toUpperCase();
    }

    async function abrirEdicao(linha) {
      // Inicializa filtro de escolas se necessário (comportamento de técnico)
      await inicializarFiltroEscolasEdit();

      // Armazena a página atual antes de abrir a edição
      paginaAntesEdicao = paginaAtual;
      console.log('[gerenciar] Página atual armazenada:', paginaAntesEdicao);

      // LIMPA ANEXOS ANTIGOS IMEDIATAMENTE ao abrir nova edição
      const containerAnexos = document.getElementById('lista-anexos-editar');
      if (containerAnexos) {
        containerAnexos.innerHTML = '<p class="text-sm text-gray-600 mb-3">⏳ Carregando anexos...</p>';
      }

      // LIMPA HISTÓRICO DE ATUALIZAÇÕES ANTIGO ao abrir nova edição
      const containerAtualizacoes = document.getElementById('historico-atualizacoes-editar');
      if (containerAtualizacoes) {
        containerAtualizacoes.innerHTML = '<p class="text-sm text-gray-600">⏳ Carregando atualizações...</p>';
      }

      const registro = registrosCache.find(r => r.linha === linha);

      if (!registro) {
        mostrarAlerta('❌ Registro não encontrado!', 'error');
        return;
      }

      console.log('[gerenciar] Abrindo edição do registro:', registro);
      console.log('[gerenciar] identidadeGenero:', registro.identidadeGenero);

      // Snapshot do registro original para confirmar alteracoes
      editRegistroOriginal = JSON.parse(JSON.stringify(registro));
      editDadosPendentes = null;

      // Preenche TODOS os campos do formulário
      document.getElementById('edit_linha').value = linha;
      document.getElementById('edit_criancaEstudante').value = registro.criancaEstudante || '';
      document.getElementById('edit_dataNT').value = registro.dataNT_ISO || '';
      document.getElementById('edit_idade').value = registro.idade || '';

      // Mapeamento de identidade de gênero (compatibilidade com registros antigos)
      let identidadeGeneroValue = (registro.identidadeGenero || '').trim();
      const mapeamentoGenero = {
        'Menino': 'M',
        'Menina': 'F',
        'M': 'M',
        'F': 'F',
        'Não-binário': 'Não-binário',
        'Outro': 'Outro'
      };
      identidadeGeneroValue = mapeamentoGenero[identidadeGeneroValue] || identidadeGeneroValue;
      document.getElementById('edit_identidadeGenero').value = identidadeGeneroValue;
      console.log('[gerenciar] identidadeGenero original:', registro.identidadeGenero, '→ mapeado:', identidadeGeneroValue);

      document.getElementById('edit_pcdTranstorno').value = (registro.pcdTranstorno || '').trim();
      document.getElementById('edit_encaminhamento').value = registro.encaminhamento || '';
      document.getElementById('edit_cmeiEmef').value = registro.cmeiEmef || '';

      // Preenche região (campo hidden e display)
      // Preenche região (escolha inicial, lógica mais complexa abaixo para o select)
      const regiaoValueInitial = registro.regiao || '';
      document.getElementById('edit_regiao').value = regiaoValueInitial;
      const regiaoDisplay = document.getElementById('edit_regiao-display');
      if (regiaoDisplay) regiaoDisplay.value = regiaoValueInitial;
      // Parseia campo combinado "autor/colaboradores" quando presente
      const participantesStr = (registro.responsavelRegistro || '').toString();
      const participantes = participantesStr.includes('/')
        ? participantesStr.split('/').map(s => s.trim()).filter(Boolean)
        : [(participantesStr || '').trim()].filter(Boolean);

      // Primeiro nome é o autor da notificação
      document.getElementById('edit_responsavelRegistro').value = participantes[0] || '';

      // Demais são os colaboradores (ou usa array legado se existir)
      editColaboradoresSelecionados = (registro.colaboradores && Array.isArray(registro.colaboradores) && registro.colaboradores.length > 0)
        ? [...registro.colaboradores]
        : participantes.slice(1);
      renderizarTagsColaboradoresEdit();

      // Configura eventos de autocomplete de colaboradores
      configurarEventosColaboradoresEdit();

      // Preenche campos adicionais (radio buttons)
      // Fonte Escola
      const fonteEscolaValue = (registro.fonteEscola || '').trim();
      // Foi um membro familiar?
      let foiMembroFamiliarValue = '';
      if (registro.hasOwnProperty('foiMembroFamiliar')) {
        foiMembroFamiliarValue = (registro.foiMembroFamiliar || '').toString().trim();
      }
      let foiMembroFamiliarRadioValue = '';
      if (['Sim', 'S', 'sim', 's'].includes(foiMembroFamiliarValue)) {
        foiMembroFamiliarRadioValue = 'Sim';
      } else if (['Não', 'N', 'nao', 'não', 'n'].includes(foiMembroFamiliarValue)) {
        foiMembroFamiliarRadioValue = 'Não';
      } else if (foiMembroFamiliarValue === '' || foiMembroFamiliarValue === 'Não informado' || foiMembroFamiliarValue === undefined) {
        foiMembroFamiliarRadioValue = '';
      } else {
        foiMembroFamiliarRadioValue = '';
      }
      // Limpa seleção anterior
      document.querySelectorAll('input[name="edit_foiMembroFamiliar"]').forEach(radio => radio.checked = false);
      // Marca a opção correta
      const foiMembroFamiliarRadio = document.querySelector(`input[name="edit_foiMembroFamiliar"][value="${foiMembroFamiliarRadioValue}"]`);
      if (foiMembroFamiliarRadio) foiMembroFamiliarRadio.checked = true;
      // Debug
      console.log('[gerenciar] Campo foiMembroFamiliar preenchido com:', foiMembroFamiliarValue, '| Radio selecionado:', foiMembroFamiliarRadioValue);
      const fonteEscolaRadio = document.querySelector(`input[name="edit_fonteEscola"][value="${fonteEscolaValue}"]`);
      if (fonteEscolaRadio) fonteEscolaRadio.checked = true;

      // Violência Escola Ocorreu
      const violenciaEscolaValue = (registro.violenciaEscolaOcorreu || '').trim();
      const violenciaEscolaRadio = document.querySelector(`input[name="edit_violenciaEscolaOcorreu"][value="${violenciaEscolaValue}"]`);
      if (violenciaEscolaRadio) violenciaEscolaRadio.checked = true;

      // Profissional Autor
      const profissionalAutorValue = (registro.profissionalAutor || '').trim();
      const profissionalAutorRadio = document.querySelector(`input[name="edit_profissionalAutor"][value="${profissionalAutorValue}"]`);
      if (profissionalAutorRadio) profissionalAutorRadio.checked = true;

      // Estudante Autor
      const estudanteAutorValue = (registro.estudanteAutor || '').trim();
      const estudanteAutorRadio = document.querySelector(`input[name="edit_estudanteAutor"][value="${estudanteAutorValue}"]`);
      if (estudanteAutorRadio) estudanteAutorRadio.checked = true;

      // Violência Não Escola
      const violenciaNaoEscolaValue = (registro.violenciaNaoEscola || '').trim();
      const violenciaNaoEscolaRadio = document.querySelector(`input[name="edit_violenciaNaoEscola"][value="${violenciaNaoEscolaValue}"]`);
      if (violenciaNaoEscolaRadio) violenciaNaoEscolaRadio.checked = true;

      // Ocorreu Escola
      const ocorreuEscolaValue = (registro.ocorreuEscola || '').trim();
      const ocorreuEscolaRadio = document.querySelector(`input[name="edit_ocorreuEscola"][value="${ocorreuEscolaValue}"]`);
      if (ocorreuEscolaRadio) ocorreuEscolaRadio.checked = true;

      // Violência Informada
      const violenciaInformadaValue = (registro.violenciaInformada || '').trim();
      const violenciaInformadaRadio = document.querySelector(`input[name="edit_violenciaInformada"][value="${violenciaInformadaValue}"]`);
      if (violenciaInformadaRadio) violenciaInformadaRadio.checked = true;

      // Estudo de Caso
      const estudoCasoValue = (registro.estudoCaso || '').trim();
      const estudoCasoRadio = document.querySelector(`input[name="edit_estudoCaso"][value="${estudoCasoValue}"]`);
      if (estudoCasoRadio) estudoCasoRadio.checked = true;

      // Preenche campo pcdDetalhes e configura exibição condicional
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesValue = registro.pcdDetalhes || '';

      // Limpa transtornos anteriores e popula com os do registro
      editTranstornosSelecionados = [];
      if (pcdDetalhesValue) {
        // Separa por vírgula e depois por barra para processar corretamente
        const transtornos = pcdDetalhesValue
          .split(',')
          .flatMap(t => t.split('/'))
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTranstornosSelecionados = transtornos;
      }
      renderizarTagsTranstornosEdit();

      // Preenche campo racaCor (select simples)
      const racaCorValue = (registro.racaCor || '').trim();
      document.getElementById('edit_racaCor').value = racaCorValue;
      console.log('[gerenciar] Campo racaCor preenchido com:', racaCorValue);

      // Preenche campo orientacaoSexual (select simples)
      const orientacaoSexualValue = (registro.orientacaoSexual || '').trim();
      document.getElementById('edit_orientacaoSexual').value = orientacaoSexualValue;
      console.log('[gerenciar] Campo orientacaoSexual preenchido com:', orientacaoSexualValue);

      // Preenche campo tipoViolencia (MÚLTIPLAS TAGS)
      editTiposViolenciaSelecionados = [];
      const tipoViolenciaValue = registro.tipoViolencia || '';
      if (tipoViolenciaValue) {
        const tipos = tipoViolenciaValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTiposViolenciaSelecionados = tipos;
      }
      renderizarTagsTipoViolenciaEdit();
      console.log('[gerenciar] Tipos de violência carregados:', editTiposViolenciaSelecionados);

      // Preenche campo tipoViolenciaInstitucional (MÚLTIPLAS TAGS - CONDICIONAL)
      editTiposViolenciaInstitucionalSelecionados = [];
      const tipoViolenciaInstitucionalValue = registro.tipoViolenciaInstitucional || '';
      if (tipoViolenciaInstitucionalValue) {
        const tiposInst = tipoViolenciaInstitucionalValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTiposViolenciaInstitucionalSelecionados = tiposInst;
      }
      renderizarTagsTipoViolenciaInstitucionalEdit();
      // Verifica se deve mostrar o campo de violência institucional
      verificarViolenciaInstitucionalEdit();
      console.log('[gerenciar] Tipos de violência institucional carregados:', editTiposViolenciaInstitucionalSelecionados);

      // Preenche campo encaminhamento com sistema de tags
      editEncaminhamentosSelecionados = [];
      const encaminhamentoValue = registro.encaminhamento || '';
      if (encaminhamentoValue) {
        const encaminhamentos = encaminhamentoValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editEncaminhamentosSelecionados = encaminhamentos;
      }
      renderizarTagsEncaminhamentoEdit();
      console.log('[gerenciar] Encaminhamentos carregados:', editEncaminhamentosSelecionados);

      // Preenche campo CMEI/EMEF com autocomplete
      // Preenche campo CMEI/EMEF com autocomplete
      const cmeiEmefValue = registro.cmeiEmef || '';
      if (cmeiEmefValue) {
        // Detecta o tipo de instituição a partir do nome
        const tipoDetectado = cmeiEmefValue.startsWith('CMEI') ? 'CMEI' : 'EMEF';

        // IMPORTANTE: Define uma flag para indicar que estamos CARREGANDO dados
        document.getElementById('edit_cmeiEmef').setAttribute('data-loading', 'true');

        // Preenche o tipo primeiro
        document.getElementById('edit_tipoInstituicao').value = tipoDetectado;

        // Habilita o campo e filtra instituições
        edit_tipoInstituicaoSelecionado = tipoDetectado;

        // Usa lógica avançada de escolas se disponível
        if (window.NAVMEscolasTecnico && edit_escolasDisponiveis.length > 0) {
          edit_instituicoesFiltradas = edit_escolasDisponiveis.filter(inst => inst.tipo === tipoDetectado);

          // Garante siglas
          edit_instituicoesFiltradas.forEach(inst => {
            if (!inst.sigla) inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
          });

          atualizarIndicadorFiltroEdit();
        } else {
          // Fallback
          edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === tipoDetectado);
        }
        document.getElementById('edit_cmeiEmef').disabled = false;
        document.getElementById('edit_cmeiEmef').placeholder = 'Digite para buscar...';

        // CRÍTICO: Preenche o valor APÓS configurar tudo
        document.getElementById('edit_cmeiEmef').value = cmeiEmefValue;

        // Remove a flag após um pequeno delay
        setTimeout(() => {
          document.getElementById('edit_cmeiEmef').removeAttribute('data-loading');
        }, 100);

        console.log('[gerenciar] CMEI/EMEF carregado:', cmeiEmefValue, 'Tipo:', tipoDetectado);
      }
      // Preenche campo região (select) - com garantia de que opções estejam carregadas
      const regiaoValue = (registro.regiao || '').trim();
      const regiaoSelect = document.getElementById('edit_regiao');

      if (regiaoSelect && regiaoValue) {
        // CRÍTICO: Garante que as opções estejam carregadas PRIMEIRO (APENAS SE FOR SELECT)
        if (regiaoSelect.tagName === 'SELECT') {
          // Se o select só tem a opção padrão "Selecione...", recarrega as opções
          if (regiaoSelect.options.length <= 1) {
            carregarOpcoesRegiaoEdit(false);
          }
        }

        // Função auxiliar para definir o valor da região
        const definirRegiao = () => {
          // SE FOR INPUT (HIDDEN OU TEXT), APENAS DEFINE O VALOR
          if (regiaoSelect.tagName !== 'SELECT') {
            regiaoSelect.value = regiaoValue;
            console.log('[gerenciar] ✅ Região definida em input:', regiaoValue);
            return true;
          }

          const regiaoNormalizada = regiaoValue.toLowerCase().trim();

          // Tenta encontrar a opção exata primeiro
          for (let option of regiaoSelect.options) {
            const optionValue = option.value.trim();
            const optionText = option.textContent.trim();

            // Compara valor exato
            if (optionValue === regiaoValue || optionText === regiaoValue) {
              regiaoSelect.value = optionValue;
              console.log('[gerenciar] ✅ Região preenchida com:', optionValue, '(correspondência exata)');
              return true;
            }

            // Compara normalizado (case-insensitive)
            if (optionValue.toLowerCase() === regiaoNormalizada ||
              optionText.toLowerCase() === regiaoNormalizada) {
              regiaoSelect.value = optionValue;
              console.log('[gerenciar] ✅ Região preenchida com:', optionValue, '(normalizada de:', regiaoValue + ')');
              return true;
            }
          }

          // Se não encontrou, adiciona a opção se necessário e define
          const opcaoExiste = Array.from(regiaoSelect.options).some(opt =>
            opt.value === regiaoValue || opt.textContent.trim() === regiaoValue
          );

          if (!opcaoExiste) {
            // Adiciona a opção se não existir
            const novaOpcao = document.createElement('option');
            novaOpcao.value = regiaoValue;
            novaOpcao.textContent = regiaoValue;
            regiaoSelect.appendChild(novaOpcao);
            console.log('[gerenciar] ⚠️ Opção de região adicionada:', regiaoValue);
          }

          regiaoSelect.value = regiaoValue;
          console.log('[gerenciar] ✅ Região definida diretamente:', regiaoValue);
          return true;
        };

        // CRÍTICO: Aguarda que o DOM seja atualizado antes de definir o valor
        // Usa múltiplas tentativas para garantir que funcione
        setTimeout(() => {
          definirRegiao();

          // Verifica se o valor foi mantido após um delay adicional
          setTimeout(() => {
            const valorAtual = regiaoSelect.value;
            if (valorAtual !== regiaoValue && regiaoValue) {
              console.log('[gerenciar] ⚠️ Valor foi perdido! Tentando restaurar...');
              console.log('[gerenciar]   - Valor esperado:', regiaoValue);
              console.log('[gerenciar]   - Valor atual:', valorAtual);
              definirRegiao();
            }

            // Log final
            console.log('[gerenciar] 📋 Região final no select:', regiaoSelect.value);
            if (regiaoSelect.tagName === 'SELECT') {
              console.log('[gerenciar] 📋 Todas as opções disponíveis:', Array.from(regiaoSelect.options).map(o => ({ value: o.value, text: o.textContent })));
            }
          }, 300);
        }, 50);
      } else if (regiaoSelect && regiaoSelect.tagName === 'SELECT') {
        // Se não há valor, apenas garante que as opções estejam carregadas (APENAS PARA SELECT)
        carregarOpcoesRegiaoEdit(false);
        console.log('[gerenciar] ⚠️ Região vazia no registro, opções recarregadas');
      }

      // Mostra/oculta o campo conforme o valor de PCD
      if (registro.pcdTranstorno === 'Sim') {
        pcdDetalhesContainer.classList.remove('hidden');
      } else {
        pcdDetalhesContainer.classList.add('hidden');
      }

      console.log('[gerenciar] Valores recebidos do backend:');
      console.log('[gerenciar]   - fonteEscola:', registro.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', registro.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', registro.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', registro.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', registro.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', registro.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', registro.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', registro.estudoCaso);
      console.log('[gerenciar]   - pcdDetalhes:', registro.pcdDetalhes);

      console.log('[gerenciar] Campo identidadeGenero preenchido com:', document.getElementById('edit_identidadeGenero').value);

      // Salva o ID da notificação para uso posterior
      document.getElementById('formEdicao').dataset.idNotificacao = registro.idNotificacao || linha;
      document.getElementById('formEdicao').dataset.linha = linha;

      // Carrega atualizações da notificação (usa ID da planilha diretamente)
      const idNotificacao = registro.idNotificacao || linha;
      if (idNotificacao) {
        carregarAtualizacoesEdicao(idNotificacao);
      }

      // Carrega os anexos existentes - usa idNotificacao da planilha para buscar a PK no Supabase
      if (window.carregarAnexosParaEdicao) {
        // Busca a PK do Supabase baseada no idNotificacao da planilha
        buscarPKSupabase(registro.idNotificacao || linha).then(pkSupabase => {
          if (pkSupabase) {
            console.log('[gerenciar] PK Supabase encontrada:', pkSupabase, 'para idNotificacao:', registro.idNotificacao || linha);
            // Armazena a PK do Supabase no dataset para uso posterior (ex: upload de anexos)
            document.getElementById('formEdicao').dataset.pkSupabase = pkSupabase;
            carregarAnexosParaEdicao(pkSupabase);
          } else {
            console.warn('[gerenciar] PK Supabase não encontrada. Anexos não serão carregados.');
            // Limpa o dataset caso não encontre a PK
            delete document.getElementById('formEdicao').dataset.pkSupabase;
            const container = document.getElementById('lista-anexos-editar');
            if (container) {
              container.innerHTML = '<p class="text-sm text-gray-500 italic">Nenhum anexo neste registro (ID não encontrado no banco)</p>';
            }
          }
        });
      }

      // Esconde os botões de "Novo Registro" quando abrir edição
      const botoesNovoRegistro = document.querySelectorAll('a[href="registro-novo-caso.html"]');
      botoesNovoRegistro.forEach(btn => {
        btn.style.display = 'none';
      });

      // Previne scroll do body quando modal estiver aberto
      document.body.classList.add('modal-open');

      // Mostra o modal
      const modal = document.getElementById('modalEdicao');
      modal.style.display = ''; // Limpa display: none inline se existir
      modal.classList.remove('fading-out'); // Garante que não tenha classe de saída
      modal.classList.add('show');

      // Inicializa a aba "Dados" como ativa
      trocarAbaModal('dados');

      // CRÍTICO: Garante que a região seja definida após o modal ser exibido
      // Isso é necessário porque o modal pode estar oculto quando o valor é definido
      if (window._regiaoEditPreservada) {
        const regiaoValue = window._regiaoEditPreservada;

        // Função para garantir que a região seja definida
        const garantirRegiao = () => {
          const regiaoSelect = document.getElementById('edit_regiao');
          if (!regiaoSelect || !regiaoValue) return;

          // Garante que as opções estejam carregadas
          if (regiaoSelect.options.length <= 1) {
            carregarOpcoesRegiaoEdit(false);
          }

          // Aguarda um frame para garantir que as opções foram recarregadas
          requestAnimationFrame(() => {
            // Tenta encontrar e definir a opção
            let encontrada = false;
            for (let option of regiaoSelect.options) {
              if (option.value === regiaoValue || option.textContent.trim() === regiaoValue) {
                regiaoSelect.value = option.value;
                encontrada = true;
                console.log('[gerenciar] 🔄 Região definida após modal abrir:', option.value);
                break;
              }
            }

            // Se não encontrou, adiciona a opção
            if (!encontrada && regiaoValue) {
              const novaOpcao = document.createElement('option');
              novaOpcao.value = regiaoValue;
              novaOpcao.textContent = regiaoValue;
              regiaoSelect.appendChild(novaOpcao);
              regiaoSelect.value = regiaoValue;
              console.log('[gerenciar] 🔄 Região adicionada e definida após modal abrir:', regiaoValue);
            }

            // Verificação final após um delay
            setTimeout(() => {
              if (regiaoSelect.value !== regiaoValue) {
                console.log('[gerenciar] ⚠️ Região foi perdida novamente! Restaurando...');
                regiaoSelect.value = regiaoValue;
              }
              console.log('[gerenciar] ✅ Região final garantida:', regiaoSelect.value);
            }, 500);
          });
        };

        // Executa após o modal ser exibido
        requestAnimationFrame(() => {
          garantirRegiao();
        });
      }
    }

    // ========================================
    // BUSCAR PK DO SUPABASE
    // ========================================
    async function buscarPKSupabase(idNotificacaoPlanilha) {
      try {
        console.log('[gerenciar] Buscando PK Supabase para idNotificacao planilha:', idNotificacaoPlanilha);

        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'buscarPKSupabase',
          idNotificacaoPlanilha: idNotificacaoPlanilha
        });

        console.log('[gerenciar] Resultado buscarPKSupabase:', resultado);

        if (resultado.success && resultado.pk) {
          return resultado.pk;
        }
        return null;
      } catch (erro) {
        console.error('[gerenciar] Erro ao buscar PK Supabase:', erro);
        return null;
      }
    }

    // ========================================
    // SISTEMA DE COLABORADORES - MÚLTIPLAS TAGS (EDIÇÃO)
    // ========================================

    // Cache de todos os usuários disponíveis
    let todosColaboradoresCache = [];

    // Debounce para busca
    let debounceTimer = null;

    // Renderiza as tags de colaboradores
    function renderizarTagsColaboradoresEdit() {
      const container = document.getElementById('edit_colaboradores-tags');
      const hiddenInput = document.getElementById('edit_colaboradores');

      if (editColaboradoresSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum colaborador adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = editColaboradoresSelecionados.map((colab, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm">
          ${colab}
          <button 
            type="button" 
            onclick="removerColaboradorEdit(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por vírgula
      hiddenInput.value = editColaboradoresSelecionados.join(', ');
    }

    // Remove um colaborador
    function removerColaboradorEdit(index) {
      editColaboradoresSelecionados.splice(index, 1);
      renderizarTagsColaboradoresEdit();
    }

    // Adiciona um colaborador
    function adicionarColaboradorEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Evita duplicatas
      if (!editColaboradoresSelecionados.includes(textoTrimmed)) {
        editColaboradoresSelecionados.push(textoTrimmed);
        renderizarTagsColaboradoresEdit();
      }

      // Limpa input
      document.getElementById('edit_colaboradores-input').value = '';
      document.getElementById('edit_colaboradores-suggestions').classList.add('hidden');
    }

    // Filtra e mostra sugestões de colaboradores com debounce
    function mostrarSugestoesColaboradoresEdit(query) {
      // Limpa timer anterior
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      const suggestionsDiv = document.getElementById('edit_colaboradores-suggestions');

      // Se vazio, esconde sugestões
      if (query.trim() === '') {
        suggestionsDiv.classList.add('hidden');
        return;
      }

      // Mostra loading
      suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">⏳ Buscando colaboradores...</div>';
      suggestionsDiv.classList.remove('hidden');

      // Debounce de 300ms antes de fazer a busca
      debounceTimer = setTimeout(async () => {
        try {
          // Se cache vazio, busca do backend
          if (todosColaboradoresCache.length === 0) {
            const url = window.CONFIG.APPS_SCRIPT_AUTH;
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: 'data=' + encodeURIComponent(JSON.stringify({ action: 'listarUsuarios' }))
            });

            const resultado = await response.json();
            console.log('Resposta do backend (listarUsuarios):', resultado);

            if (resultado.sucesso && resultado.usuarios && Array.isArray(resultado.usuarios)) {
              todosColaboradoresCache = resultado.usuarios;
              console.log('✅ Colaboradores carregados:', todosColaboradoresCache.length);
            } else if (resultado.data && Array.isArray(resultado.data)) {
              // Fallback para formato antigo
              todosColaboradoresCache = resultado.data;
              console.log('✅ Colaboradores carregados (formato antigo):', todosColaboradoresCache.length);
            } else {
              console.error('❌ Formato de resposta inválido:', resultado);
            }
          }

          // Filtra usuários
          const userEmail = sessionStorage.getItem('userEmail');
          const nomeUsuarioLogado = document.getElementById('edit_responsavelRegistro')?.value || '';

          const filtrados = todosColaboradoresCache.filter(usuario =>
            usuario.nome.toLowerCase().includes(query.toLowerCase()) &&
            usuario.email !== userEmail &&
            usuario.nome !== nomeUsuarioLogado &&
            !editColaboradoresSelecionados.includes(usuario.nome)
          );

          if (filtrados.length === 0) {
            suggestionsDiv.innerHTML = `
              <div class="p-3 text-sm text-gray-500 text-center">
                Nenhum colaborador encontrado
              </div>
            `;
            suggestionsDiv.classList.remove('hidden');
            return;
          }

          // Renderiza sugestões
          suggestionsDiv.innerHTML = filtrados.map(usuario => `
            <div 
              class="px-4 py-2.5 hover:bg-blue-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
              onclick="adicionarColaboradorEdit('${usuario.nome.replace(/'/g, "\\'")}')">
              <div class="font-medium text-gray-800">${usuario.nome}</div>
              <div class="text-xs text-gray-500">${usuario.email}</div>
            </div>
          `).join('');

          suggestionsDiv.classList.remove('hidden');
        } catch (error) {
          console.error('Erro ao buscar colaboradores:', error);
          suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-red-500 text-center">❌ Erro ao buscar colaboradores</div>';
        }
      }, 300);
    }

    // Configurar eventos de colaboradores
    function configurarEventosColaboradoresEdit() {
      const input = document.getElementById('edit_colaboradores-input');
      if (!input) return;

      input.addEventListener('focus', function (e) {
        if (e.target.value.trim()) {
          mostrarSugestoesColaboradoresEdit(e.target.value);
        }
      });

      input.addEventListener('input', function (e) {
        mostrarSugestoesColaboradoresEdit(e.target.value);
      });

      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarColaboradorEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_colaboradores-suggestions').classList.add('hidden');
        }
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#edit_colaboradores-input') && !e.target.closest('#edit_colaboradores-suggestions')) {
          document.getElementById('edit_colaboradores-suggestions').classList.add('hidden');
        }
      });
    }

    // Injeta estilos de animação dinamicamente e estilos de CARD DE REGIÃO
    (function addFadeStyles() {
      if (!document.getElementById('modal-fade-styles')) {
        const style = document.createElement('style');
        style.id = 'modal-fade-styles';
        style.textContent = `
          .modal.fading-out {
            animation: fadeOut 0.3s ease-out forwards;
            pointer-events: none;
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
          /* Estilos extras para cards de região (fallback se Tailwind falhar) */
          .region-card.selected {
            background-color: #2563eb !important; /* blue-600 */
            color: white !important;
            border-color: #2563eb !important;
          }
        `;
        document.head.appendChild(style);
      }
    })();

    // ========================================
    // FECHAR MODAL COM ANIMAÇÃO
    // ========================================
    function fecharModal() {
      const modal = document.getElementById('modalEdicao');
      if (!modal) return;

      // Evita duplo clique
      if (modal.classList.contains('fading-out')) return;

      console.log('[fecharModal] Iniciando fechamento do modal...');

      // Adiciona classe de animação
      modal.classList.add('fading-out');

      // Aguarda animação terminar
      setTimeout(() => {
        modal.classList.remove('show');
        modal.classList.remove('fading-out');
        document.body.classList.remove('modal-open');

        // Limpa a variável global de região preservada
        window._regiaoEditPreservada = null;

        // Mostra novamente os botões de "Novo Registro"
        const botoesNovoRegistro = document.querySelectorAll('a[href="registro-novo-caso.html"]');
        botoesNovoRegistro.forEach(btn => {
          btn.style.display = '';
        });

        // LÓGICA DE REDIRECIONAMENTO PARA TÉCNICOS
        const userRole = sessionStorage.getItem('userRole');
        const origem = sessionStorage.getItem('origemEdicao');

        if (userRole === 'tecnico' || origem === 'minhas-notificacoes') {
          console.log('[fecharModal] Redirecionando técnico/origem para minhas notificações...');
          sessionStorage.removeItem('origemEdicao');
          sessionStorage.removeItem('notificacaoParaEditar');
          // Pequeno fade no body para transição suave de página
          document.body.style.opacity = '0';
          document.body.style.transition = 'opacity 0.3s ease';
          setTimeout(() => {
            window.location.href = 'minhas-notificacoes.html';
          }, 300);
        }
      }, 300); // Tempo da animação CSS
    }

    // ========================================
    // EVENT LISTENERS GLOBAIS PARA FECHAR MODAL
    // ========================================
    // Remove listeners antigos antes de adicionar novos para evitar duplicidade
    // (Embora em um script normal isso rode uma vez, é boa prática em SPAs/Live edits)
    const handleEscKey = function (event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('modalEdicao');
        // Verifica se está visível (show class e display não none)
        const isVisible = modal && modal.classList.contains('show') && getComputedStyle(modal).display !== 'none';

        if (isVisible) {
          console.log('[EventListener] Escape pressionado, fechando modal...');
          fecharModal();
        }
      }
    };

    const handleClickOutside = function (event) {
      const modal = document.getElementById('modalEdicao');
      // Verifica se o clique foi EXATAMENTE no background do modal
      if (modal && event.target === modal) {
        console.log('[EventListener] Clique fora do modal, fechando...');
        fecharModal();
      }
    };

    document.addEventListener('keydown', handleEscKey);
    // Usa um listener direto no elemento modal (já que ele existe no DOM)
    // Mas garante que o elemento existe antes de adicionar
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('modalEdicao');
      if (modal) {
        modal.removeEventListener('click', handleClickOutside); // Tenta remover anterior
        modal.addEventListener('click', handleClickOutside);
      }
    });
    // Fallback caso o DOM já esteja carregado
    if (document.getElementById('modalEdicao')) {
      document.getElementById('modalEdicao').addEventListener('click', handleClickOutside);
    }

    // ========================================
    // TROCAR ABA DO MODAL
    // ========================================
    function trocarAbaModal(aba) {
      // Remove classe active de todas as abas
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-600');
      });

      // Esconde todo o conteúdo das abas
      document.querySelectorAll('.aba-conteudo').forEach(conteudo => {
        conteudo.classList.add('hidden');
      });

      // Ativa a aba selecionada
      const tabButton = document.getElementById(`tab-${aba}`);
      const abaConteudo = document.getElementById(`aba-${aba}`);

      if (tabButton && abaConteudo) {
        tabButton.classList.add('active', 'border-blue-600', 'text-blue-600');
        tabButton.classList.remove('border-transparent', 'text-gray-600');
        abaConteudo.classList.remove('hidden');
      }
    }

    // ========================================
    // FUNÇÕES DE ATUALIZAÇÕES
    // ========================================

    // Função auxiliar para cores de status
    function getCorTagStatusLocal(tagStatus) {
      if (!tagStatus) return '';
      const cores = {
        'Pendente': 'bg-yellow-100 text-yellow-800 border-yellow-300',
        'Em andamento': 'bg-blue-100 text-blue-800 border-blue-300',
        'Concluido': 'bg-green-100 text-green-800 border-green-300'
      };
      return cores[tagStatus] || 'bg-gray-100 text-gray-800 border-gray-300';
    }

    async function carregarAtualizacoesEdicao(idNotificacao) {
      const container = document.getElementById('historico-atualizacoes-editar');
      if (!container) {
        console.error('[carregarAtualizacoesEdicao] Container não encontrado');
        return;
      }

      try {
        console.log('[carregarAtualizacoesEdicao] Carregando atualizações para ID:', idNotificacao);
        container.innerHTML = '<div class="atualizacoes-loading"><div class="atualizacoes-spinner"></div><p>Carregando atualizações...</p></div>';

        // Verificar se window.API está disponível
        if (!window.API) {
          throw new Error('Módulo API não carregado');
        }

        // Chamar diretamente via API
        console.log('[carregarAtualizacoesEdicao] Chamando API...');
        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'buscarAtualizacoes',
          idNotificacao: idNotificacao
        });

        console.log('[carregarAtualizacoesEdicao] Resultado recebido:', resultado);

        if (resultado.success !== false && resultado.atualizacoes !== undefined) {
          const atualizacoes = resultado.atualizacoes || [];
          console.log('[carregarAtualizacoesEdicao] Total de atualizações:', atualizacoes.length);

          if (atualizacoes.length === 0) {
            container.innerHTML = '<p class="sem-atualizacoes">Nenhuma atualização registrada ainda.</p>';
          } else {
            // Renderizar manualmente
            let html = '<div class="lista-atualizacoes">';
            atualizacoes.sort((a, b) => new Date(b.data) - new Date(a.data));

            // Renderizar HTML primeiro sem quebra de texto
            atualizacoes.forEach(atualizacao => {
              const dataFormatada = formatarDataHoraBRAtualizacao(atualizacao.data);
              const textoOriginal = (atualizacao.texto || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

              // Badge de status (se existir)
              let badgeHtml = '';
              if (atualizacao.tag_status) {
                const corBadge = getCorTagStatusLocal(atualizacao.tag_status);
                badgeHtml = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ml-2 ${corBadge}">${atualizacao.tag_status}</span>`;
              }

              html += `
        <div class="atualizacao-item">
          <div class="atualizacao-header">
            <div class="flex items-center flex-wrap gap-2">
              <span class="data-atualizacao">📅 ${dataFormatada}</span>
              ${badgeHtml}
            </div>
            <span class="usuario-atualizacao">👤 ${atualizacao.usuario || 'Usuário desconhecido'}</span>
          </div>
          <p class="texto-atualizacao" data-texto-original="${textoOriginal.replace(/" /g, '&quot;')}">${textoOriginal}</p>
      </div>
    `;
            });
            html += '</div>';
            container.innerHTML = html;

            // Agora aplicar quebra de texto usando elementos reais do DOM
            container.querySelectorAll('.texto-atualizacao').forEach(el => {
              const textoOriginal = el.getAttribute('data-texto-original') || el.textContent || '';
              const fonte = getComputedStyle(el).font;

              // Calcular largura disponível do elemento real
              const estilo = getComputedStyle(el);
              const paddingLeft = parseFloat(estilo.paddingLeft) || 0;
              const paddingRight = parseFloat(estilo.paddingRight) || 0;
              const larguraElemento = el.offsetWidth || el.clientWidth || 840;
              const larguraDisponivel = larguraElemento - paddingLeft - paddingRight;

              // Aplicar quebra de texto
              const textoQuebrado = quebrarTextoPorLargura(textoOriginal, larguraDisponivel, fonte);
              el.innerHTML = textoQuebrado;
              el.removeAttribute('data-texto-original');
            });

            console.log('[carregarAtualizacoesEdicao] ✅ Atualizações renderizadas com sucesso');
          }
        } else {
          console.warn('[carregarAtualizacoesEdicao] Resposta não sucesso:', resultado);
          container.innerHTML = '<p class="sem-atualizacoes">Erro ao carregar atualizações: ' + (resultado.error || resultado.message || 'Erro desconhecido') + '</p>';
        }
      } catch (error) {
        console.error('[carregarAtualizacoesEdicao] ❌ Erro:', error);
        container.innerHTML = '<p class="sem-atualizacoes">Erro ao carregar atualizações: ' + error.message + '</p>';
      }
    }

    function formatarDataHoraBRAtualizacao(isoString) {
      try {
        const data = new Date(isoString);
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        const hora = String(data.getHours()).padStart(2, '0');
        const min = String(data.getMinutes()).padStart(2, '0');
        return `${dia} /${mes}/${ano} ${hora}:${min} `;
      } catch (error) {
        return isoString;
      }
    }

    // Normaliza apenas espaços múltiplos (sem alterar pontuação)
    function normalizarTexto(texto) {
      return texto
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Quebra texto mantendo largura máxima usando fonte real do elemento
    function quebrarTextoPorLargura(texto, larguraPx = 840, fonte = '14px Inter, system-ui, sans-serif') {
      if (!texto) return '';

      texto = normalizarTexto(texto);

      const medidor = document.createElement('span');
      medidor.style.position = 'absolute';
      medidor.style.visibility = 'hidden';
      medidor.style.whiteSpace = 'nowrap';
      medidor.style.font = fonte;
      medidor.style.padding = '0';
      medidor.style.margin = '0';
      medidor.style.left = '-9999px';
      medidor.style.top = '-9999px';

      document.body.appendChild(medidor);

      const palavras = texto.split(' ');
      const linhas = [];
      let linhaAtual = '';

      for (let i = 0; i < palavras.length; i++) {
        const palavra = palavras[i];

        if (!palavra) continue; // Pula palavras vazias

        // Tenta adicionar a palavra atual à linha
        const tentativa = linhaAtual ? linhaAtual + ' ' + palavra : palavra;
        medidor.textContent = tentativa;

        // Força reflow para garantir medição precisa
        void medidor.offsetWidth;

        const larguraTentativa = medidor.offsetWidth;

        // Se cabe (com margem de tolerância de 2px para evitar quebras por arredondamento)
        if (larguraTentativa <= larguraPx + 2) {
          linhaAtual = tentativa;
          continue;
        }

        // Não cabe - precisa quebrar
        if (linhaAtual) {
          // Salva a linha atual (sem a palavra que não coube)
          linhas.push(linhaAtual);
          linhaAtual = '';
        }

        // Tenta adicionar a palavra sozinha
        medidor.textContent = palavra;
        void medidor.offsetWidth;

        if (medidor.offsetWidth <= larguraPx + 2) {
          // Palavra cabe sozinha
          linhaAtual = palavra;
        } else {
          // Palavra muito longa - quebra por caractere
          let parcial = '';
          for (const char of palavra) {
            const tentativaChar = parcial + char;
            medidor.textContent = tentativaChar;
            void medidor.offsetWidth;

            if (medidor.offsetWidth > larguraPx + 2 && parcial) {
              linhas.push(parcial);
              parcial = char;
            } else {
              parcial = tentativaChar;
            }
          }
          linhaAtual = parcial;
        }
      }

      // Adiciona última linha se houver conteúdo
      if (linhaAtual) {
        linhas.push(linhaAtual);
      }

      document.body.removeChild(medidor);
      return linhas.join('<br>');
    }

    function dividirPalavraLonga(palavra, larguraPx, ctx, linhas) {
      let pedaco = '';
      for (const ch of palavra) {
        const tentativa = pedaco + ch;
        if (ctx.measureText(tentativa).width > larguraPx && pedaco) {
          linhas.push(pedaco);
          pedaco = ch;
        } else {
          pedaco = tentativa;
        }
      }
      if (pedaco) linhas.push(pedaco);
    }

    function aplicarQuebraEmElementos(seletorRaiz, seletoresFilhos, larguraPx = 882.719) {
      const raiz = document.querySelector(seletorRaiz);
      if (!raiz) return;
      seletoresFilhos.forEach(sel => {
        raiz.querySelectorAll(sel).forEach(el => {
          const fonte = getComputedStyle(el).font;
          const textoOriginal = el.textContent || '';
          const textoQuebrado = quebrarTextoPorLargura(textoOriginal, larguraPx, fonte);
          el.innerHTML = textoQuebrado;
        });
      });
    }

    async function adicionarAtualizacaoEdicao() {
      const idNotificacao = document.getElementById('formEdicao').dataset.idNotificacao;
      const texto = document.getElementById('nova-atualizacao-editar').value;
      const emailUsuario = sessionStorage.getItem('userEmail');
      const tagStatus = document.getElementById('tag-status-atualizacao-editar').value || null;
      const btn = document.getElementById('btn-adicionar-atualizacao-editar');

      if (!idNotificacao) {
        alert('Erro: ID da notificação não encontrado');
        return;
      }

      if (!texto || texto.trim() === '') {
        alert('Por favor, digite uma atualização antes de adicionar.');
        return;
      }

      if (!emailUsuario) {
        alert('Erro: Usuário não autenticado');
        return;
      }

      if (!window.API) {
        alert('Erro: Módulo API não carregado');
        return;
      }

      // Desabilita botão
      btn.disabled = true;
      btn.textContent = '⏳ Adicionando...';

      try {
        console.log('[adicionarAtualizacaoEdicao] Adicionando atualização...');
        // Chamar diretamente via API
        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'adicionarAtualizacao',
          idNotificacao: idNotificacao,
          textoAtualizacao: texto,
          emailUsuario: emailUsuario,
          tagStatus: tagStatus
        });

        console.log('[adicionarAtualizacaoEdicao] Resultado:', resultado);

        if (resultado.success) {
          document.getElementById('nova-atualizacao-editar').value = '';
          document.getElementById('tag-status-atualizacao-editar').value = '';
          await carregarAtualizacoesEdicao(idNotificacao);
          alert('✅ Atualização adicionada com sucesso!');
        } else {
          alert('Erro: ' + (resultado.error || 'Erro desconhecido'));
        }
      } catch (error) {
        console.error('[adicionarAtualizacaoEdicao] ❌ Erro:', error);
        alert('Erro ao adicionar atualização: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '➕ Adicionar Atualização';
      }
    }

    // ========================================
    // CARREGAR ANEXOS PARA EDIÇÃO
    // ========================================
    async function carregarAnexosParaEdicao(idNotificacao) {
      console.log('[gerenciar] carregarAnexosParaEdicao chamada com idNotificacao:', idNotificacao);
      console.log('[gerenciar] APPS_SCRIPT_CASOS:', APPS_SCRIPT_CASOS);

      const container = document.getElementById('lista-anexos-editar');
      if (!container) {
        console.error('[gerenciar] Container lista-anexos-editar não encontrado');
        return;
      }

      try {
        container.innerHTML = '<p class="text-sm text-gray-600 mb-3">⏳ Carregando anexos...</p>';

        console.log('[gerenciar] Fazendo requisição para listar anexos...');
        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'listarAnexosNotificacao',
          idNotificacao: idNotificacao
        });

        console.log('[gerenciar] Resultado da requisição:', resultado);
        console.log('[gerenciar] resultado.success:', resultado.success);
        console.log('[gerenciar] resultado.anexos:', resultado.anexos);
        console.log('[gerenciar] resultado.anexos.length:', resultado.anexos ? resultado.anexos.length : 'undefined');

        if (resultado.success && resultado.anexos && resultado.anexos.length > 0) {
          console.log('[gerenciar] ✅ Anexos encontrados:', resultado.anexos.length);
          let html = '<div style="width: 100% !important; max-width: 100% !important; display: block !important; float: none !important; clear: both !important; box-sizing: border-box !important;">';

          resultado.anexos.forEach(anexo => {
            console.log('[gerenciar] Renderizando anexo:', anexo.nome_arquivo_original);
            html += `
      <div style="width: 100% !important; max-width: 100% !important; display: block !important; margin-bottom: 12px !important; padding: 16px !important; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important; border: 1px solid #e5e7eb !important; border-radius: 12px !important; box-sizing: border-box !important; float: none !important; clear: both !important; position: static !important;">
        <div style="width: 100% !important; max-width: 100% !important; display: block !important; margin-bottom: 8px !important; box-sizing: border-box !important;">
          <div style="display: flex !important; align-items: center !important; gap: 12px !important; margin-bottom: 8px !important; flex-wrap: wrap !important;">
            <span style="font-size: 24px !important; flex-shrink: 0 !important;">${obterIconeTipoArquivo(anexo.tipo_arquivo)}</span>
            <div style="flex: 1 !important; min-width: 0 !important; max-width: 100% !important; box-sizing: border-box !important;">
              <p style="font-size: 14px !important; font-weight: 600 !important; color: #1f2937 !important; margin: 0 0 4px 0 !important; word-wrap: break-word !important; overflow-wrap: break-word !important; word-break: break-word !important; white-space: normal !important; max-width: 100% !important; box-sizing: border-box !important;" title="${anexo.nome_arquivo_original}">
                ${anexo.nome_arquivo_original}
              </p>
              <p style="font-size: 12px !important; color: #6b7280 !important; margin: 0 !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">
                ${formatarDataUpload(anexo.data_upload)} • ${formatarTamanhoByte(anexo.tamanho_original)} → ${formatarTamanhoByte(anexo.tamanho_comprimido)} (${Math.round(anexo.taxa_compressao * 100)}%)
              </p>
            </div>
          </div>
          <div style="display: flex !important; gap: 8px !important; justify-content: flex-end !important; margin-top: 8px !important; flex-wrap: wrap !important;">
            <button
              onclick="visualizarAnexo('${anexo.url_download}', '${anexo.tipo_arquivo}')"
              style="padding: 8px 16px !important; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important; color: white !important; border: none !important; border-radius: 8px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; transition: all 0.3s ease !important; flex-shrink: 0 !important;"
              title="Visualizar"
            >
              👁️ Ver
            </button>
            <button
              onclick="excluirAnexoDuranteEdicao('${anexo.id}')"
              style="padding: 8px 16px !important; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important; color: white !important; border: none !important; border-radius: 8px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; transition: all 0.3s ease !important; flex-shrink: 0 !important;"
              title="Deletar"
            >
              🗑️ Deletar
            </button>
          </div>
        </div>
              </div>
      `;
          });

          html += '</div>';
          container.innerHTML = html;
        } else {
          console.warn('[gerenciar] ⚠️ Nenhum anexo encontrado ou resposta não-sucesso');
          console.warn('[gerenciar] Motivo:', !resultado.success ? 'success=false' : !resultado.anexos ? 'anexos undefined' : 'anexos.length = 0');
          container.innerHTML = '<p class="text-sm text-gray-500 italic">Nenhum anexo neste registro</p>';
        }
      } catch (erro) {
        console.error('[gerenciar] ❌ Erro ao carregar anexos:', erro);
        console.error('[gerenciar] Stack:', erro.stack);
        container.innerHTML = '<p class="text-sm text-red-600">❌ Erro ao carregar anexos: ' + erro.message + '</p>';
      }
    }

    // ========================================
    // DELETAR ANEXO DURANTE EDIÇÃO
    // ========================================
    async function excluirAnexoDuranteEdicao(anexoId) {
      if (!confirm('Deseja realmente deletar este anexo?')) return;

      try {
        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'excluirAnexo',
          anexoId: anexoId
        });

        if (resultado.success) {
          mostrarAlerta('✅ Anexo deletado!', 'success');
          // Usa a PK do Supabase para recarregar os anexos
          const pkSupabase = document.getElementById('formEdicao').dataset.pkSupabase;
          if (pkSupabase) {
            carregarAnexosParaEdicao(pkSupabase);
          } else {
            console.warn('[gerenciar] PK Supabase não encontrada no dataset ao deletar anexo');
          }
        } else {
          mostrarAlerta('❌ Erro ao deletar anexo', 'error');
        }
      } catch (erro) {
        console.error('[gerenciar] Erro ao deletar anexo:', erro);
        mostrarAlerta('❌ Erro ao deletar anexo', 'error');
      }
    }

    // ========================================
    // FUNÇÕES AUXILIARES PARA ANEXOS
    // ========================================
    function obterIconeTipoArquivo(tipo) {
      const mapeamento = {
        'application/pdf': '📄',
        'image/jpeg': '🖼️',
        'image/png': '🖼️',
        'application/msword': '📝',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '📝',
        'application/vnd.ms-excel': '📊',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '📊'
      };
      return mapeamento[tipo] || '📎';
    }

    function formatarDataUpload(dataISO) {
      try {
        const data = new Date(dataISO);
        return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return dataISO;
      }
    }

    function formatarTamanhoByte(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    // ========================================
    // CONFIRMACAO DE EDICAO
    // ========================================
    let editRegistroOriginal = null;
    let editDadosPendentes = null;

    const EDIT_CONFIRM_FIELDS = [
      { key: 'criancaEstudante', label: 'Crianca/Estudante', type: 'text' },
      { key: 'dataNT', label: 'Data da Notificacao (NT)', type: 'date' },
      { key: 'idade', label: 'Idade', type: 'text' },
      { key: 'identidadeGenero', label: 'Identidade de Genero', type: 'text' },
      { key: 'pcdTranstorno', label: 'PCD/Transtorno', type: 'text' },
      { key: 'pcdDetalhes', label: 'Detalhes PCD/Transtorno', type: 'list' },
      { key: 'racaCor', label: 'Raca/Cor', type: 'text' },
      { key: 'orientacaoSexual', label: 'Orientacao Sexual', type: 'text' },
      { key: 'tipoViolencia', label: 'Tipo de Violencia', type: 'list' },
      { key: 'tipoViolenciaInstitucional', label: 'Violencia Institucional', type: 'list' },
      { key: 'encaminhamento', label: 'Encaminhamento', type: 'list' },
      { key: 'cmeiEmef', label: 'Instituicao de Ensino', type: 'text' },
      { key: 'regiao', label: 'Regiao', type: 'text' },
      { key: 'responsavelRegistro', label: 'Responsavel pelo Registro', type: 'text' },
      { key: 'colaboradores', label: 'Colaboradores', type: 'list' },
      { key: 'foiMembroFamiliar', label: 'Foi membro familiar', type: 'yesno' },
      { key: 'fonteEscola', label: 'Fonte informada pela escola', type: 'yesno' },
      { key: 'violenciaEscolaOcorreu', label: 'Violencia ocorreu na escola', type: 'yesno' },
      { key: 'profissionalAutor', label: 'Profissional autor', type: 'yesno' },
      { key: 'estudanteAutor', label: 'Estudante autor', type: 'yesno' },
      { key: 'violenciaNaoEscola', label: 'Violencia nao ocorreu na escola', type: 'yesno' },
      { key: 'ocorreuEscola', label: 'Ocorreu na escola', type: 'yesno' },
      { key: 'violenciaInformada', label: 'Violencia informada a escola', type: 'yesno' },
      { key: 'estudoCaso', label: 'Estudo de caso', type: 'yesno' }
    ];

    function mapIdentidadeGeneroOriginal(value) {
      const mapeamentoGenero = {
        'Menino': 'M',
        'Menina': 'F',
        'M': 'M',
        'F': 'F',
        'Nao-binario': 'Nao-binario',
        'Não-binário': 'Não-binário',
        'Outro': 'Outro'
      };
      const raw = String(value || '').trim();
      return mapeamentoGenero[raw] || raw;
    }

    function normalizeYesNoValue(value) {
      const v = normalizeText(value);
      if (!v) return '';
      if (v === 'nao informado' || v === 'naoinformado' || v.startsWith('nao informad')) return '';
      if (v === 's' || v === 'sim') return 'sim';
      if (v === 'n' || v === 'nao' || v === 'não') return 'nao';
      return v;
    }

    function splitListValue(value) {
      if (Array.isArray(value)) return value;
      if (!value) return [];
      return String(value)
        .split(/[\/|,]/)
        .map((item) => item.trim())
        .filter((item) => item.length > 0);
    }

    function normalizeListValue(value) {
      const items = splitListValue(value)
        .map((item) => normalizeText(item))
        .filter((item) => item.length > 0)
        .sort();
      return items.join('|');
    }

    function normalizeDateForCompare(value) {
      if (!value) return '';
      const str = String(value).trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      const match = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (match) {
        const dia = match[1].padStart(2, '0');
        const mes = match[2].padStart(2, '0');
        let ano = match[3];
        if (ano.length === 2) ano = `20${ano}`;
        return `${ano}-${mes}-${dia}`;
      }
      const parsed = new Date(str);
      if (!isNaN(parsed.getTime())) {
        const ano = parsed.getFullYear();
        const mes = String(parsed.getMonth() + 1).padStart(2, '0');
        const dia = String(parsed.getDate()).padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
      }
      return str;
    }

    function formatDateDisplay(value) {
      const normalizado = normalizeDateForCompare(value);
      if (/^\d{4}-\d{2}-\d{2}$/.test(normalizado)) {
        const [ano, mes, dia] = normalizado.split('-');
        return `${dia}/${mes}/${ano}`;
      }
      return value || 'Nao informado';
    }

    function formatDisplayValue(value, type) {
      if (type === 'list') {
        const items = splitListValue(value);
        return items.length ? items.join(', ') : 'Nao informado';
      }
      if (type === 'date') {
        return value ? formatDateDisplay(value) : 'Nao informado';
      }
      if (type === 'yesno') {
        const normalized = normalizeYesNoValue(value);
        if (normalized === 'sim') return 'Sim';
        if (normalized === 'nao') return 'Nao';
        return 'Nao informado';
      }
      const str = String(value || '').trim();
      return str ? str : 'Nao informado';
    }

    function buildOriginalDataForDiff(registro) {
      if (!registro) return {};
      const colaboradores = Array.isArray(registro.colaboradores)
        ? registro.colaboradores
        : (registro.responsavelRegistro || '')
          .split('/')
          .slice(1)
          .map((item) => item.trim())
          .filter(Boolean);

      return {
        criancaEstudante: registro.criancaEstudante || '',
        dataNT: registro.dataNT_ISO || registro.dataNT || '',
        idade: registro.idade || '',
        identidadeGenero: mapIdentidadeGeneroOriginal(registro.identidadeGenero),
        pcdTranstorno: registro.pcdTranstorno || '',
        pcdDetalhes: registro.pcdDetalhes || '',
        racaCor: registro.racaCor || '',
        orientacaoSexual: registro.orientacaoSexual || '',
        tipoViolencia: registro.tipoViolencia || '',
        tipoViolenciaInstitucional: registro.tipoViolenciaInstitucional || '',
        encaminhamento: registro.encaminhamento || '',
        cmeiEmef: registro.cmeiEmef || '',
        regiao: registro.regiao || '',
        responsavelRegistro: registro.responsavelRegistro || '',
        colaboradores: colaboradores,
        foiMembroFamiliar: registro.foiMembroFamiliar || '',
        fonteEscola: registro.fonteEscola || '',
        violenciaEscolaOcorreu: registro.violenciaEscolaOcorreu || '',
        profissionalAutor: registro.profissionalAutor || '',
        estudanteAutor: registro.estudanteAutor || '',
        violenciaNaoEscola: registro.violenciaNaoEscola || '',
        ocorreuEscola: registro.ocorreuEscola || '',
        violenciaInformada: registro.violenciaInformada || '',
        estudoCaso: registro.estudoCaso || ''
      };
    }

    function getCompareValue(value, type) {
      if (type === 'list') return normalizeListValue(value);
      if (type === 'date') return normalizeDateForCompare(value);
      if (type === 'yesno') return normalizeYesNoValue(value);
      return normalizeText(String(value || ''));
    }

    function gerarDiffEdicao(original, atual) {
      const diffs = [];
      EDIT_CONFIRM_FIELDS.forEach((field) => {
        const before = original[field.key];
        const after = atual[field.key];
        if (getCompareValue(before, field.type) !== getCompareValue(after, field.type)) {
          diffs.push({
            label: field.label,
            before: formatDisplayValue(before, field.type),
            after: formatDisplayValue(after, field.type)
          });
        }
      });
      return diffs;
    }

    function renderizarDiffEdicao(diffs) {
      const lista = document.getElementById('confirmEditLista');
      if (!lista) return;
      lista.innerHTML = '';

      diffs.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'confirm-edit-row';

        const campoCell = document.createElement('div');
        campoCell.className = 'confirm-edit-cell';
        const campoTitle = document.createElement('div');
        campoTitle.className = 'confirm-edit-cell-title';
        campoTitle.textContent = 'Campo';
        const campoValue = document.createElement('div');
        campoValue.className = 'confirm-edit-cell-value';
        campoValue.textContent = item.label;
        campoCell.appendChild(campoTitle);
        campoCell.appendChild(campoValue);

        const beforeCell = document.createElement('div');
        beforeCell.className = 'confirm-edit-cell confirm-edit-before';
        const beforeTitle = document.createElement('div');
        beforeTitle.className = 'confirm-edit-cell-title';
        beforeTitle.textContent = 'Antes';
        const beforeValue = document.createElement('div');
        beforeValue.className = 'confirm-edit-cell-value';
        beforeValue.textContent = item.before;
        beforeCell.appendChild(beforeTitle);
        beforeCell.appendChild(beforeValue);

        const afterCell = document.createElement('div');
        afterCell.className = 'confirm-edit-cell confirm-edit-after';
        const afterTitle = document.createElement('div');
        afterTitle.className = 'confirm-edit-cell-title';
        afterTitle.textContent = 'Depois';
        const afterValue = document.createElement('div');
        afterValue.className = 'confirm-edit-cell-value';
        afterValue.textContent = item.after;
        afterCell.appendChild(afterTitle);
        afterCell.appendChild(afterValue);

        row.appendChild(campoCell);
        row.appendChild(beforeCell);
        row.appendChild(afterCell);
        lista.appendChild(row);
      });

      const count = document.getElementById('confirmEditCount');
      if (count) count.textContent = String(diffs.length);
    }

    function abrirConfirmacaoEdicao(dados) {
      if (!editRegistroOriginal) {
        mostrarAlerta('⚠️ Nao foi possivel localizar o registro original para comparar.', 'error');
        return;
      }
      const original = buildOriginalDataForDiff(editRegistroOriginal);
      const diffs = gerarDiffEdicao(original, dados);
      if (diffs.length === 0) {
        mostrarAlerta('Nenhuma alteracao detectada. Nada para salvar.', 'info');
        return;
      }

      editDadosPendentes = dados;
      const nomeRegistro = dados.criancaEstudante
        ? `Registro: ${dados.criancaEstudante}`
        : 'Registro em edicao';
      const nomeEl = document.getElementById('confirmEditNome');
      if (nomeEl) nomeEl.textContent = nomeRegistro;

      renderizarDiffEdicao(diffs);

      const modal = document.getElementById('confirmEditModal');
      if (modal) {
        modal.classList.add('active');
        document.body.classList.add('modal-open');
      }
    }

    function fecharModalConfirmacaoEdicao() {
      const modal = document.getElementById('confirmEditModal');
      if (modal) {
        modal.classList.remove('active');
      }
      editDadosPendentes = null;
      const modalEdicao = document.getElementById('modalEdicao');
      const editVisible = modalEdicao && modalEdicao.classList.contains('show');
      if (!editVisible) {
        document.body.classList.remove('modal-open');
      }
    }

    function confirmarEdicaoSalvar() {
      if (!editDadosPendentes) {
        fecharModalConfirmacaoEdicao();
        return;
      }
      const dados = editDadosPendentes;
      editDadosPendentes = null;
      fecharModalConfirmacaoEdicao();
      enviarAtualizacaoComAnexos(dados);
    }

    // ========================================
    // SALVAR EDIÇÃO
    // ========================================
    document.getElementById('formEdicao').addEventListener('submit', function (e) {
      e.preventDefault();

      // Validação: se PCD = Sim, deve ter pelo menos um transtorno
      const pcdTranstorno = document.getElementById('edit_pcdTranstorno').value;
      const pcdDetalhes = document.getElementById('edit_pcdDetalhes').value;

      if (pcdTranstorno === 'Sim' && (!pcdDetalhes || pcdDetalhes.trim() === '')) {
        mostrarAlerta('⚠️ Por favor, adicione pelo menos um transtorno/deficiência quando marcar "Sim" em PCD/Transtorno.', 'error');
        document.getElementById('edit_pcdDetalhes-tags').classList.add('border-red-500');
        setTimeout(() => {
          document.getElementById('edit_pcdDetalhes-tags').classList.remove('border-red-500');
        }, 3000);
        return;
      }

      const dados = {
        action: 'update',
        linha: document.getElementById('edit_linha').value,
        criancaEstudante: document.getElementById('edit_criancaEstudante').value,
        dataNT: document.getElementById('edit_dataNT').value,
        idade: document.getElementById('edit_idade').value,
        identidadeGenero: document.getElementById('edit_identidadeGenero').value,
        pcdTranstorno: document.getElementById('edit_pcdTranstorno').value,
        pcdDetalhes: document.getElementById('edit_pcdDetalhes').value,
        racaCor: document.getElementById('edit_racaCor').value,
        orientacaoSexual: document.getElementById('edit_orientacaoSexual').value,
        tipoViolencia: document.getElementById('edit_tipoViolencia').value,
        tipoViolenciaInstitucional: document.getElementById('edit_tipoViolenciaInstitucional').value,
        encaminhamento: document.getElementById('edit_encaminhamento').value,
        cmeiEmef: document.getElementById('edit_cmeiEmef').value,
        regiao: (() => {
          const regiaoEl = document.getElementById('edit_regiao');
          let regiaoValue = regiaoEl ? regiaoEl.value.trim() : '';

          console.log('[gerenciar] 🔍 Coletando região para envio:');
          console.log('[gerenciar]   - Elemento encontrado:', !!regiaoEl);
          console.log('[gerenciar]   - Valor coletado do select:', regiaoValue);
          console.log('[gerenciar]   - Opções disponíveis:', (regiaoEl && regiaoEl.options) ? Array.from(regiaoEl.options).map(o => ({ value: o.value, text: o.textContent })) : 'N/A');

          // Se o valor está vazio mas deveria ter um valor, tenta recuperar do registro original
          if (!regiaoValue && regiaoEl) {
            const linha = document.getElementById('edit_linha').value;
            const registroOriginal = registrosCache.find(r => r.linha == linha);
            if (registroOriginal && registroOriginal.regiao) {
              const regiaoOriginal = (registroOriginal.regiao || '').trim();
              console.log('[gerenciar] ⚠️ Região estava vazia, tentando recuperar do registro original:', regiaoOriginal);

              // Tenta encontrar a opção correspondente (apenas se for SELECT)
              if (regiaoEl.options) {
                for (let option of regiaoEl.options) {
                  if (option.value === regiaoOriginal || option.textContent.trim() === regiaoOriginal) {
                    regiaoEl.value = option.value;
                    regiaoValue = option.value;
                    console.log('[gerenciar] ✅ Região recuperada e definida:', regiaoValue);
                    break;
                  }
                }
              }

              // Se não encontrou, define diretamente
              if (!regiaoValue && regiaoOriginal) {
                regiaoEl.value = regiaoOriginal;
                regiaoValue = regiaoOriginal;
                console.log('[gerenciar] ✅ Região recuperada e definida diretamente:', regiaoValue);
              }
            }
          }

          console.log('[gerenciar] 📤 Região final que será enviada:', regiaoValue);
          return regiaoValue;
        })(),
        // Envia campo combinado "autor/colaboradores"
        responsavelRegistro: (() => {
          const autor = document.getElementById('edit_responsavelRegistro').value;
          const colabs = editColaboradoresSelecionados || [];
          return [autor, ...colabs].filter(Boolean).join('/');
        })(),
        // Mantém array de colaboradores por compatibilidade
        colaboradores: editColaboradoresSelecionados,
        // Campos adicionais (radio buttons)
        foiMembroFamiliar: document.querySelector('input[name="edit_foiMembroFamiliar"]:checked')?.value || '',
        fonteEscola: document.querySelector('input[name="edit_fonteEscola"]:checked')?.value || '',
        violenciaEscolaOcorreu: document.querySelector('input[name="edit_violenciaEscolaOcorreu"]:checked')?.value || '',
        profissionalAutor: document.querySelector('input[name="edit_profissionalAutor"]:checked')?.value || '',
        estudanteAutor: document.querySelector('input[name="edit_estudanteAutor"]:checked')?.value || '',
        violenciaNaoEscola: document.querySelector('input[name="edit_violenciaNaoEscola"]:checked')?.value || '',
        ocorreuEscola: document.querySelector('input[name="edit_ocorreuEscola"]:checked')?.value || '',
        violenciaInformada: document.querySelector('input[name="edit_violenciaInformada"]:checked')?.value || '',
        estudoCaso: document.querySelector('input[name="edit_estudoCaso"]:checked')?.value || ''
      };

      console.log('[gerenciar] === DADOS DE ATUALIZAÇÃO ===');
      console.log('[gerenciar] Campos de violência sendo enviados:');
      console.log('[gerenciar]   - tipoViolencia:', dados.tipoViolencia);
      console.log('[gerenciar]   - tipoViolenciaInstitucional:', dados.tipoViolenciaInstitucional);
      console.log('[gerenciar] Campos adicionais sendo enviados:');
      console.log('[gerenciar]   - pcdDetalhes:', dados.pcdDetalhes);
      console.log('[gerenciar]   - fonteEscola:', dados.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', dados.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', dados.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', dados.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', dados.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', dados.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', dados.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', dados.estudoCaso);
      console.log('[gerenciar] Payload completo:', JSON.stringify(dados));

      // O feedback visual será mostrado através do botão (atualizarEstadoBotaoSalvar)
      abrirConfirmacaoEdicao(dados);
    });

    // ========================================
    // FUNÇÕES AUXILIARES PARA FEEDBACK VISUAL
    // ========================================
    function atualizarEstadoBotaoSalvar(estado, mensagem = null) {
      const btnSalvar = document.getElementById('btnSalvarEdicao');
      if (!btnSalvar) return;

      if (estado === 'salvando') {
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = `
      < span class="inline-flex items-center" >
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
            ${mensagem || '⏳ Salvando...'}
          </span >
      `;
        btnSalvar.classList.remove('hover:from-blue-700', 'hover:to-blue-800', 'hover:shadow-lg', 'hover:scale-[1.02]');
      } else if (estado === 'upload') {
        btnSalvar.disabled = true; // Mantém desabilitado durante upload
        btnSalvar.innerHTML = `
      < span class="inline-flex items-center" >
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
            ${mensagem || '📤 Enviando anexos...'}
          </span >
      `;
        btnSalvar.classList.remove('hover:from-blue-700', 'hover:to-blue-800', 'hover:shadow-lg', 'hover:scale-[1.02]');
      } else if (estado === 'normal') {
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = '💾 Salvar Alterações';
        btnSalvar.classList.add('hover:from-blue-700', 'hover:to-blue-800', 'hover:shadow-lg', 'hover:scale-[1.02]');
      }
    }

    // ========================================
    // ENVIAR ATUALIZAÇÃO COM UPLOAD DE ANEXOS
    // ========================================
    async function enviarAtualizacaoComAnexos(dados) {
      console.log('[gerenciar] enviarAtualizacaoComAnexos chamado');

      // Mostra indicador elegante de carregamento
      if (window.loadingIndicator) {
        window.loadingIndicator.show('Preparando salvamento...');
        window.loadingIndicator.update('Validando dados...', 10);
      }

      // Atualiza o botão para estado de salvando
      atualizarEstadoBotaoSalvar('salvando', '⏳ Salvando alterações...');

      // Atualiza progresso
      if (window.loadingIndicator) {
        window.loadingIndicator.update('Salvando alterações do registro...', 30);
      }

      // Primeiro, envia a atualização do registro
      const resultadoUpdate = await new Promise((resolve) => {
        enviarAtualizacao(dados, resolve);
      });

      if (resultadoUpdate.success) {
        // Atualiza progresso após sucesso do registro
        if (window.loadingIndicator) {
          window.loadingIndicator.update('Registro salvo! Verificando anexos...', 60);
        }

        // Após sucesso, verifica se há novos arquivos para upload
        const inputAnexos = document.getElementById('anexos-editar');
        if (inputAnexos && inputAnexos.files && inputAnexos.files.length > 0) {
          // Atualiza o botão para estado de upload
          atualizarEstadoBotaoSalvar('upload', '📤 Enviando anexos...');

          // Atualiza progresso para upload
          if (window.loadingIndicator) {
            window.loadingIndicator.update('Enviando anexos...', 70);
          }

          // Usa a PK do Supabase (não o ID da planilha) para upload de anexos
          let pkSupabase = document.getElementById('formEdicao').dataset.pkSupabase;
          const idNotificacaoPlanilha = document.getElementById('formEdicao').dataset.idNotificacao;

          if (!pkSupabase) {
            console.error('[gerenciar] ❌ PK Supabase não encontrada no dataset. Tentando buscar novamente...');
            // Tenta buscar a PK novamente se não estiver no dataset
            pkSupabase = await buscarPKSupabase(idNotificacaoPlanilha);
            if (pkSupabase) {
              document.getElementById('formEdicao').dataset.pkSupabase = pkSupabase;
              console.log('[gerenciar] ✓ PK Supabase encontrada após busca:', pkSupabase);
            } else {
              console.error('[gerenciar] ❌ Não foi possível encontrar a PK do Supabase. Upload de anexos cancelado.');
              mostrarAlerta('❌ Erro: Não foi possível identificar o registro no banco de dados. Anexos não foram enviados.', 'error');
              atualizarEstadoBotaoSalvar('normal');
              return;
            }
          }

          console.log('[gerenciar] Usando PK Supabase para upload:', pkSupabase, '(ID planilha:', idNotificacaoPlanilha + ')');
          const userEmail = sessionStorage.getItem('userEmail') || 'usuario@sistema.com';

          // Pega o nome da criança do formulário de edição
          const nomeCriancaParaUpload = document.getElementById('edit_criancaEstudante')?.value || '';
          console.log('[gerenciar] Nome da criança para upload:', nomeCriancaParaUpload);

          try {
            await uploadAnexos(pkSupabase, Array.from(inputAnexos.files),
              (atual, total, nome) => {
                const percentual = Math.round((atual / total) * 100);
                const progressoGeral = 70 + Math.round((percentual / 100) * 25); // 70% a 95%
                atualizarEstadoBotaoSalvar('upload', `📤 Enviando anexos... ${percentual}% `);
                if (window.loadingIndicator) {
                  window.loadingIndicator.update(`Enviando anexo ${atual} de ${total}...`, progressoGeral);
                }
              },
              (sucessos, erros, total) => {
                // Atualiza progresso final
                if (window.loadingIndicator) {
                  window.loadingIndicator.update('Finalizando...', 95);
                }

                if (erros > 0) {
                  atualizarEstadoBotaoSalvar('normal');
                  if (window.loadingIndicator) {
                    window.loadingIndicator.hide();
                  }
                  mostrarAlerta(`⚠️ Registro atualizado.${sucessos} anexo(s) enviado(s), ${erros} erro(s).`, 'error');
                } else {
                  atualizarEstadoBotaoSalvar('normal');
                  if (window.loadingIndicator) {
                    window.loadingIndicator.update('Concluído!', 100);
                    setTimeout(() => {
                      window.loadingIndicator.hide();
                    }, 500);
                  }
                  mostrarAlerta('✅ Tudo atualizado com sucesso!', 'success');

                  // CRÍTICO: Marca que houve alteração para forçar reload na lista
                  sessionStorage.setItem('NOTIFICATIONS_RELOAD_REQUIRED', 'true');

                  inputAnexos.value = '';
                  // Usa a PK do Supabase para recarregar os anexos
                  carregarAnexosParaEdicao(pkSupabase);

                  // Verifica se veio de minhas-notificacoes e redireciona de volta
                  const origem = sessionStorage.getItem('origemEdicao');
                  if (origem === 'minhas-notificacoes') {
                    sessionStorage.removeItem('origemEdicao');
                    sessionStorage.removeItem('notificacaoParaEditar');
                    setTimeout(() => {
                      window.location.href = 'minhas-notificacoes.html';
                    }, 500);
                  } else {
                    // Limpa cache e recarrega notificações após atualizar registro
                    limparCacheERecarregarNotificacoes();
                    setTimeout(() => fecharModal(), 500);
                    setTimeout(() => carregarRegistros(true, null, null, false, false), 800);
                  }
                }
              },
              nomeCriancaParaUpload  // 5º parâmetro: nome da criança
            );
          } catch (erro) {
            console.error('[gerenciar] Erro ao fazer upload de anexos:', erro);
            atualizarEstadoBotaoSalvar('normal');
            if (window.loadingIndicator) {
              window.loadingIndicator.hide();
            }
            mostrarAlerta('⚠️ Registro atualizado, mas houve erro ao enviar anexos. Tente novamente.', 'error');
          }
        } else {
          // Se não há arquivos, fecha o modal e recarrega mantendo o loading
          atualizarEstadoBotaoSalvar('normal');

          // Verifica se veio de minhas-notificacoes e redireciona de volta
          const origem = sessionStorage.getItem('origemEdicao');
          if (origem === 'minhas-notificacoes') {
            if (window.loadingIndicator) {
              window.loadingIndicator.update('Concluído!', 100);
              setTimeout(() => {
                window.loadingIndicator.hide();
              }, 500);
            }
            mostrarAlerta('✅ Registro atualizado com sucesso!', 'success');

            // CRÍTICO: Marca que houve alteração para forçar reload na lista
            sessionStorage.setItem('NOTIFICATIONS_RELOAD_REQUIRED', 'true');

            sessionStorage.removeItem('origemEdicao');
            sessionStorage.removeItem('notificacaoParaEditar');
            setTimeout(() => {
              window.location.href = 'minhas-notificacoes.html';
            }, 300);
          } else {
            // Guarda a linha editada antes de fechar o modal
            const linhaEditada = document.getElementById('edit_linha').value;
            fecharModal();

            // Limpa cache e recarrega notificações após atualizar registro
            limparCacheERecarregarNotificacoes();

            // Mantém o loading visível enquanto carrega os registros
            // Ele será ocultado automaticamente quando carregarRegistros() terminar
            carregarRegistros(true, linhaEditada, paginaAntesEdicao, false, false);
          }
        }
      } else {
        // Se houve erro na atualização, restaura o botão
        atualizarEstadoBotaoSalvar('normal');
        if (window.loadingIndicator) {
          window.loadingIndicator.hide();
        }
      }
    }

    function enviarAtualizacao(dados, callback) {
      console.log('[gerenciar] enviarAtualizacao chamado');
      console.log('[gerenciar] Dados a enviar:', dados);

      // Cria iframe oculto
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';

      // Listener para resposta
      const messageHandler = function (event) {
        // Aceita APENAS mensagens do Google Apps Script com resposta válida
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          return;
        }

        console.log('[gerenciar] Resposta de atualização:', event.data);

        if (event.data && event.data.success) {
          console.log('[gerenciar] Atualização concluída!');
          // Não mostra alerta aqui, será mostrado em enviarAtualizacaoComAnexos

          if (callback) {
            callback({ success: true, data: event.data });
          }
        } else {
          // Restaura o botão em caso de erro
          const btnSalvar = document.getElementById('btnSalvarEdicao');
          if (btnSalvar) {
            atualizarEstadoBotaoSalvar('normal');
          }
          mostrarAlerta('❌ Erro: ' + (event.data?.message || 'Falha ao atualizar'), 'error');
          if (callback) {
            callback({ success: false, error: event.data?.message });
          }
        }

        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };

      window.addEventListener('message', messageHandler);

      // Cria formulário para enviar via POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name = 'frame_' + Date.now();

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);

      document.body.appendChild(iframe);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 100);

      // Timeout de segurança
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        iframe.remove();
      }, 10000);
    }

    // ========================================
    // CONFIRMAR EXCLUSÃO
    // ========================================
    function confirmarExclusao(linha, nome) {
      // Preenche o nome no modal
      document.getElementById('confirmDeleteNome').textContent = nome || 'Este registro';

      // Mostra o modal
      const modal = document.getElementById('confirmDeleteModal');
      modal.classList.add('active');
      document.body.classList.add('modal-open');

      // Configura o botão de confirmação
      const btnConfirmar = document.getElementById('btnConfirmarExclusao');
      btnConfirmar.onclick = function () {
        fecharModalConfirmacao();
        mostrarAlerta('🔄 Excluindo registro e todos os dados associados...', 'info');
        excluirRegistro(linha);
      };
    }

    function fecharModalConfirmacao() {
      const modal = document.getElementById('confirmDeleteModal');
      modal.classList.remove('active');
      document.body.classList.remove('modal-open');
    }

    // Fecha modal ao clicar fora dele
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('confirmDeleteModal');
      if (modal) {
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            fecharModalConfirmacao();
          }
        });
      }

      // Fecha modal com tecla ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          fecharModalConfirmacao();
        }
      });
    });

    // Fecha modal de confirmacao de edicao ao clicar fora ou pressionar ESC
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('confirmEditModal');
      if (modal) {
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            fecharModalConfirmacaoEdicao();
          }
        });
      }

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          fecharModalConfirmacaoEdicao();
        }
      });
    });

    function excluirRegistro(linha) {
      console.log('[gerenciar] Excluindo registro da linha:', linha);

      const dados = {
        action: 'delete',
        linha: linha.toString(),
        emailUsuario: sessionStorage.getItem('userEmail') || 'desconhecido'
      };

      console.log('[excluirRegistro] Dados a enviar:', dados);

      // Usa o mesmo padrão da API para garantir que funcione
      if (!window.API) {
        console.error('[excluirRegistro] ❌ Módulo API não disponível');
        mostrarAlerta('❌ Erro: Sistema de API não disponível', 'error');
        return;
      }

      const url = APPS_SCRIPT_URL || window.CONFIG.APPS_SCRIPT_CASOS;
      if (!url) {
        console.error('[excluirRegistro] ❌ URL do backend não configurada');
        mostrarAlerta('❌ Erro: URL do backend não configurada', 'error');
        return;
      }

      console.log('[excluirRegistro] Enviando para:', url);

      // Cria iframe oculto para receber resposta
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.id = 'iframe-excluir-registro-' + Date.now();

      const messageHandler = function (event) {
        // Aceita apenas mensagens do Apps Script
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          console.log('[excluirRegistro] Mensagem ignorada:', event);
          return;
        }

        console.log('[excluirRegistro] ✅ Resposta recebida:', event.data);

        if (event.data.success) {
          mostrarAlerta('🗑️ ✅ Registro e TODOS os anexos foram excluídos permanentemente!', 'success');
          setTimeout(() => carregarRegistros(true), 300);
        } else {
          const mensagem = event.data.message || 'Falha ao excluir';
          console.error('[excluirRegistro] ❌ Erro:', mensagem);
          mostrarAlerta('❌ Erro: ' + mensagem, 'error');
        }

        window.removeEventListener('message', messageHandler);
        setTimeout(() => {
          if (iframe && iframe.parentNode) {
            iframe.remove();
          }
        }, 100);
      };

      window.addEventListener('message', messageHandler);

      // Cria formulário e envia
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = url;
      form.target = iframe.name = 'frame_' + Date.now();

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);

      console.log('[excluirRegistro] Form action:', form.action);
      console.log('[excluirRegistro] Form target:', form.target);
      console.log('[excluirRegistro] Input value:', input.value);

      document.body.appendChild(iframe);
      document.body.appendChild(form);

      console.log('[excluirRegistro] Enviando formulário...');
      form.submit();

      setTimeout(() => {
        if (form && form.parentNode) {
          form.remove();
        }
      }, 100);

      // Timeout de segurança
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        if (iframe && iframe.parentNode) {
          iframe.remove();
        }
        console.warn('[excluirRegistro] ⏱️ Timeout atingido');
        mostrarAlerta('⏱️ Timeout ao excluir. O servidor pode estar lento. Verifique se a exclusão foi concluída e recarregue a página.', 'error');
      }, 30000);
    }

    // ========================================
    // VERIFICAR AUTENTICAÇÃO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');

      // Se não estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! Faça login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }
    }

    // ========================================
    // EXPANDIR/RECOLHER FILTROS AVANÇADOS
    // ========================================
    function toggleFiltrosAvancados() {
      const section = document.getElementById('filtrosAvancadosSection');
      const icon = document.getElementById('toggleFiltrosIcon');

      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.textContent = '▲';
      } else {
        section.classList.add('hidden');
        icon.textContent = '▼';
      }
    }


    // ========================================
    // ABRIR/FECHAR SEÇÃO DE FILTRO (igual ao painel-casos.html)
    // ========================================
    function openFilterSection(filterName) {
      const panel = document.getElementById('advancedPanel');
      const section = document.getElementById(`section - ${filterName} `);
      const card = document.querySelector(`[data - filter= "${filterName}"]`);

      // Se a seção já está visível, esconde
      if (section.classList.contains('show')) {
        section.classList.remove('show');
        section.classList.add('hidden');
        card.classList.remove('active');

        // Se todas as seções estão escondidas, fecha o painel
        const visibleSections = document.querySelectorAll('.filter-section.show');
        if (visibleSections.length === 0) {
          panel.classList.remove('open');
        }
      } else {
        // Abre o painel se estiver fechado
        if (!panel.classList.contains('open')) {
          panel.classList.add('open');
        }

        // Mostra a seção
        section.classList.remove('hidden');
        section.classList.add('show');
        card.classList.add('active');

        // Scroll suave até a seção
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // ========================================
    // LIMPAR TODOS OS FILTROS (LÓGICA DO CLEARFILTERS)
    // ========================================
    function limparFiltros() {
      // Limpar checkboxes dos filtros avançados
      const allCheckboxes = document.querySelectorAll('.custom-checkbox');
      allCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
        // Resetar estilo dos cards de região
        if (cb.closest('.region-card')) {
          const cardLabel = cb.closest('.region-card');
          cardLabel.classList.remove('selected', 'bg-blue-600', 'text-white', 'border-blue-600', 'shadow-md');
          cardLabel.classList.add('bg-white', 'text-gray-700', 'border-gray-200', 'hover:bg-blue-50');
        }
      });

      // Limpar badges
      const badges = document.querySelectorAll('.badge-count, .group-badge');
      badges.forEach(badge => badge.classList.add('hidden'));

      // Remover estados ativos dos cards
      const cards = document.querySelectorAll('.filter-card');
      cards.forEach(card => card.classList.remove('active'));

      // Esconder todas as seções
      const sections = document.querySelectorAll('.filter-section');
      sections.forEach(section => {
        section.classList.remove('show');
        section.classList.add('hidden');
      });

      // Fechar painel
      const advancedPanel = document.getElementById('advancedPanel');
      if (advancedPanel) {
        advancedPanel.classList.remove('open');
      }

      // Limpar selects e inputs
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI', 'filterMembroFamiliar',
        'campoBusca'
      ];

      filterIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      });

      // Esconde card de Violências Institucionais ao limpar filtros
      const cardViolenciaInstitucional = document.getElementById('card-violenciaInstitucional');
      if (cardViolenciaInstitucional) {
        cardViolenciaInstitucional.classList.add('hidden');
      }

      // Resetar para primeira página ao limpar filtros
      paginaAtual = 1;

      // Aplicar filtros (vai mostrar todos os registros)
      filtrarTabela();
      mostrarAlerta('✅ Filtros limpos com sucesso!', 'success');
    }

    // ========================================
    // FUNÇÕES DE CONSTRUÇÃO DE GRUPOS (ENCAMINHAMENTO E VIOLÊNCIA INSTITUCIONAL)
    // ========================================

    // Constrói os grupos de encaminhamento
    function buildEncaminhamentoGroups(availableEncaminhamentos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      if (!container) return;
      container.innerHTML = '';
      const availableNormalized = availableEncaminhamentos.map(e => normalizeText(e));
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        const childrenPresent = children.filter(child =>
          availableNormalized.includes(normalizeText(child))
        );
        if (childrenPresent.length === 0) continue;
        renderEncaminhamentoGroup(groupKey, childrenPresent);
      }
      const outrosDetectados = availableEncaminhamentos.filter(term => !belongsToAnyGroup(term));
      if (outrosDetectados.length > 0) {
        renderOutrosDetectados(outrosDetectados);
      }
    }

    // Renderiza um grupo de encaminhamento
    function renderEncaminhamentoGroup(groupId, childrenPresent) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      if (!container) return;
      const groupName = grupoNomes[groupId] || groupId;
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group';
      groupDiv.dataset.group = groupId;
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group - ${groupId} `;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      checkboxWrapper.appendChild(groupCheckbox);
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = groupName;
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      const badge = document.createElement('span');
      badge.id = `badge - ${groupId} `;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle - ${groupId} `;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      const body = document.createElement('div');
      body.id = `body - ${groupId} `;
      body.className = 'group-body';
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      childrenPresent.forEach((child, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-gray-50 rounded-lg border border-gray-200';
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index} `;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = child;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index} `;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = child;
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      body.appendChild(bodyContent);
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }

    // Renderiza grupo "Outros detectados"
    function renderOutrosDetectados(termos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      if (!container) return;
      const groupId = 'outrosDetectados';
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group outros-detectados';
      groupDiv.dataset.group = groupId;
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group - ${groupId} `;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      checkboxWrapper.appendChild(groupCheckbox);
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = '⚠️ Outros detectados';
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      const badge = document.createElement('span');
      badge.id = `badge - ${groupId} `;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle - ${groupId} `;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      const body = document.createElement('div');
      body.id = `body - ${groupId} `;
      body.className = 'group-body';
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      termos.forEach((termo, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-amber-50 rounded-lg border border-amber-300';
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index} `;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = termo;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index} `;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = termo;
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      body.appendChild(bodyContent);
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }

    // Toggle panel de um grupo
    function toggleGroupPanel(groupId) {
      const body = document.getElementById(`body - ${groupId} `);
      const icon = document.getElementById(`toggle - ${groupId} `);
      if (body && icon) {
        body.classList.toggle('expanded');
        icon.classList.toggle('rotated');
      }
    }

    // Handler quando checkbox de grupo muda
    function onGroupCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group - ${groupId} `);
      const childCheckboxes = document.querySelectorAll(`input[data - group= "${groupId}"]`);
      childCheckboxes.forEach(child => {
        child.checked = groupCheckbox.checked;
      });
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      filtrarTabela();
    }

    // Handler quando checkbox de filho muda
    function onChildCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group - ${groupId} `);
      const childCheckboxes = document.querySelectorAll(`input[data - group= "${groupId}"]`);
      const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(childCheckboxes).some(cb => cb.checked);
      groupCheckbox.checked = allChecked;
      groupCheckbox.indeterminate = someChecked && !allChecked;
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      filtrarTabela();
    }

    // Atualiza badge de um grupo específico
    function updateGroupBadge(groupId) {
      const childCheckboxes = document.querySelectorAll(`input[data - group= "${groupId}"]: checked`);
      const count = childCheckboxes.length;
      const badge = document.getElementById(`badge - ${groupId} `);
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // Atualiza badge total de encaminhamento
    function updateBadgeEncaminhamentoTotal() {
      const allChildCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      const count = allChildCheckboxes.length;
      const badge = document.getElementById('badge-encaminhamento-total');
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // Constrói grupos de violências institucionais com cards
    function buildViolenciaInstitucionalGroups(data) {
      const container = document.getElementById('filterViolenciaInstitucionalContainer');
      if (!container) return;
      container.innerHTML = '';

      // Coleta todas as violências institucionais dos dados
      const availableViolencias = new Set();
      data.forEach(reg => {
        const violenciaInst = reg.tipoViolenciaInstitucional;
        if (violenciaInst) {
          String(violenciaInst).split(',').forEach(v => {
            const trimmed = v.trim();
            if (trimmed) availableViolencias.add(trimmed);
          });
        }
      });

      const availableViolenciasArray = Array.from(availableViolencias).sort();

      // Usa createViolenceSubCards para criar os sub-cards
      createViolenceSubCards('filterViolenciaInstitucionalContainer', availableViolenciasArray, 'violenciaInstitucional');

      // Sobrescreve o handler de change para atualizar badge corretamente
      const cards = container.querySelectorAll('.violence-sub-card');
      cards.forEach(card => {
        const checkbox = card.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.removeEventListener('change', checkbox._changeHandler);
          checkbox._changeHandler = function () {
            if (this.checked) {
              card.classList.add('selected');
            } else {
              card.classList.remove('selected');
            }
            updateBadgeViolenciaInstitucionalTotal();
            filtrarTabela();
          };
          checkbox.addEventListener('change', checkbox._changeHandler);
        }
      });
    }

    // Atualiza badge total de violências institucionais
    function updateBadgeViolenciaInstitucionalTotal() {
      const allCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
      const count = allCheckboxes.length;
      const badge = document.getElementById('badge-violenciaInstitucional-total');
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // Verifica se "Institucional" está selecionado no filtro de Tipo Violência
    function verificarViolenciaInstitucionalNoFiltro() {
      let cardViolenciaInstitucional = document.getElementById('card-violenciaInstitucional');
      const sectionViolenciaInstitucional = document.getElementById('section-violenciaInstitucional');
      const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
      const temInstitucional = Array.from(tipoViolenciaCheckboxes).some(cb => {
        const valor = (cb.dataset.value || '').toLowerCase();
        return valor === 'institucional' || valor.includes('institucional');
      });

      if (temInstitucional) {
        if (!cardViolenciaInstitucional) {
          const cardTipoViolencia = document.querySelector('[data-filter="tipoViolencia"]');
          if (cardTipoViolencia) {
            const novoCard = document.createElement('div');
            novoCard.id = 'card-violenciaInstitucional';
            novoCard.className = 'filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm';
            novoCard.setAttribute('data-filter', 'violenciaInstitucional');
            novoCard.onclick = () => openFilterSection('violenciaInstitucional');
            novoCard.innerHTML = `
      < div class="flex items-center justify-between" >
                <div class="flex items-center gap-2">
                  <span class="filter-card-icon text-2xl">🏛️</span>
                  <span class="text-sm font-medium text-gray-700">Violências Institucionais</span>
                </div>
                <span id="badge-violenciaInstitucional-total" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
              </div >
      `;
            cardTipoViolencia.insertAdjacentElement('afterend', novoCard);
            cardViolenciaInstitucional = novoCard;
          }
        } else {
          cardViolenciaInstitucional.classList.remove('hidden');
          cardViolenciaInstitucional.style.display = '';
          const cardTipoViolencia = document.querySelector('[data-filter="tipoViolencia"]');
          if (cardTipoViolencia) {
            const proximoIrmao = cardTipoViolencia.nextElementSibling;
            if (!proximoIrmao || proximoIrmao.id !== 'card-violenciaInstitucional') {
              if (cardViolenciaInstitucional.parentElement) {
                cardViolenciaInstitucional.remove();
              }
              cardTipoViolencia.insertAdjacentElement('afterend', cardViolenciaInstitucional);
            }
          }
        }
        setTimeout(() => {
          const grupoGeralCheckbox = document.getElementById('checkbox-violencia-institucional-geral');
          if (grupoGeralCheckbox && !grupoGeralCheckbox.checked) {
            grupoGeralCheckbox.checked = true;
            grupoGeralCheckbox.dispatchEvent(new Event('change'));
          }
          if (sectionViolenciaInstitucional && sectionViolenciaInstitucional.classList.contains('hidden')) {
            openFilterSection('violenciaInstitucional');
          }
        }, 100);
      } else {
        if (cardViolenciaInstitucional) {
          cardViolenciaInstitucional.classList.add('hidden');
          cardViolenciaInstitucional.style.display = 'none';
        }
        const viCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]');
        viCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.indeterminate = false;
        });
        const grupoGeralCheckbox = document.getElementById('checkbox-violencia-institucional-geral');
        if (grupoGeralCheckbox) {
          grupoGeralCheckbox.checked = false;
          grupoGeralCheckbox.indeterminate = false;
        }
        updateBadgeViolenciaInstitucionalTotal();
        if (sectionViolenciaInstitucional && sectionViolenciaInstitucional.classList.contains('show')) {
          sectionViolenciaInstitucional.classList.remove('show');
          sectionViolenciaInstitucional.classList.add('hidden');
          cardViolenciaInstitucional.classList.remove('active');
        }
        filtrarTabela();
      }
    }

    window.verificarViolenciaInstitucionalNoFiltro = verificarViolenciaInstitucionalNoFiltro;

    // ========================================
    // POPULAR OPÇÕES DOS FILTROS (ao carregar registros) - LÓGICA DO INITIALIZEFILTERS
    // ========================================
    function popularFiltrosAvancados() {
      if (!registrosCache || registrosCache.length === 0) return;

      // Converte registrosCache para formato similar ao painel-casos (com mapeamento de campos)
      const data = registrosCache.map(reg => ({
        regiao: reg.regiao,
        tipo: reg.tipoViolencia,
        tipoViolenciaInstitucional: reg.tipoViolenciaInstitucional,
        escola: reg.cmeiEmef,
        encaminhamento: reg.encaminhamento,
        raca: reg.racaCor,
        genero: reg.identidadeGenero,
        detalhePCD: reg.pcdDetalhes,
        orientacaoSexual: reg.orientacaoSexual
      }));

      // Região
      if (data.some(r => r.regiao)) {
        const valores = buildNormalizedOptions('regiao', data);
        // USAR A NOVA FUNÇÃO DE CARDS
        createRegionCards('filterRegiaoContainer', valores, 'regiao');
      }

      // Tipo de Violência
      if (data.some(r => r.tipo)) {
        const valores = buildNormalizedOptionsTipoViolencia('tipo', data);
        createViolenceTypeCards('filterTipoViolenciaContainer', valores, 'tipoViolencia');
        const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]');
        tipoViolenciaCheckboxes.forEach(cb => {
          cb.addEventListener('change', verificarViolenciaInstitucionalNoFiltro);
        });
        setTimeout(verificarViolenciaInstitucionalNoFiltro, 500);
      }

      // Tipo de Instituição (CMEI/EMEF)
      if (data.some(r => r.escola)) {
        const tiposSet = new Set();
        registrosCache.forEach(reg => {
          const tipo = getTipoInstituicao(reg.cmeiEmef);
          if (tipo) {
            tiposSet.add(tipo);
          } else if (reg.cmeiEmef) {
            tiposSet.add('Não Encontrada');
          }
        });
        const tiposInstituicao = Array.from(tiposSet).sort();
        createCheckboxes('filterTipoInstituicaoContainer', tiposInstituicao, 'tipoInstituicao');

        // Escola Específica
        const valores = buildNormalizedOptions('escola', data);
        createCheckboxes('filterEscolaContainer', valores, 'escola');
        setupEscolaAutocomplete();
      }

      // Encaminhamento
      if (data.some(r => r.encaminhamento)) {
        const valores = buildNormalizedOptions('encaminhamento', data);
        buildEncaminhamentoGroups(valores);
      }

      // Raça/Cor
      if (data.some(r => r.raca)) {
        const valores = buildNormalizedOptions('raca', data);
        createCheckboxes('filterRacaContainer', valores, 'raca');
      }

      // Gênero
      if (data.some(r => r.genero)) {
        const valores = buildGeneroOptions(data.map(r => ({ identidadeGenero: r.genero })));
        createCheckboxes('filterGeneroContainer', valores, 'genero');
      }

      // Tipo de deficiência/transtorno
      if (data.some(r => r.detalhePCD)) {
        const valoresBrutos = buildNormalizedOptions('detalhePCD', data);
        const valoresNormalizados = normalizarListaTranstornos(valoresBrutos);
        createCheckboxes('filterTipoDeficienciaContainer', valoresNormalizados, 'tipoDeficiencia');
      }

      // Orientação Sexual
      if (data.some(r => r.orientacaoSexual)) {
        const valores = buildNormalizedOptions('orientacaoSexual', data);
        createCheckboxes('filterOrientacaoContainer', valores, 'orientacao');
      }

      // Violências Institucionais
      if (data.some(r => r.tipoViolenciaInstitucional)) {
        buildViolenciaInstitucionalGroups(registrosCache);
      }

      setTimeout(verificarViolenciaInstitucionalNoFiltro, 1000);

      // Adiciona event listeners aos filtros
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada', 'filterEstudoCaso',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI',
        'filterMembroFamiliar'
      ];

      filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          const eventType = (element.type === 'date') ? 'change' :
            (element.tagName === 'INPUT') ? 'input' : 'change';
          element.addEventListener(eventType, filtrarTabela);
        }
      });

      // Event listener específico para o filtro TI
      const filterTIElement = document.getElementById('filterTI');
      if (filterTIElement) {
        filterTIElement.addEventListener('change', function () {
          updateBadgeTI();
          filtrarTabela();
        });
      }

      // Event listener para filterPCD → toggle seção Tipo Deficiência
      const filterPCDElement = document.getElementById('filterPCD');
      if (filterPCDElement) {
        filterPCDElement.addEventListener('change', function () {
          toggleTipoDeficienciaSection();
        });
      }

      // Event listener para limpar filtros
      const btnLimparFiltros = document.getElementById('btnLimparFiltros');
      if (btnLimparFiltros) {
        btnLimparFiltros.addEventListener('click', limparFiltros);
      }
    }

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = document.getElementById('menuIcon');
      mobileMenu.classList.toggle('show');
      menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
    }

    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function () {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = document.getElementById('menuIcon');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          menuIcon.style.transform = 'rotate(0deg)';
        }
      }
    });

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');

      // Mostra botão de sair para TODOS os usuários
      if (btnSair) {
        btnSair.classList.remove('hidden');
      }
      if (btnSairMobile) {
        btnSairMobile.classList.remove('hidden');
      }

      // Menu Admin apenas para admin/superuser
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
        // Botoes de System Updates
        const btnSystemUpdates = document.getElementById('btnSystemUpdates');
        const btnSystemUpdatesMobile = document.getElementById('btnSystemUpdatesMobile');
        if (btnSystemUpdates) {
          btnSystemUpdates.classList.remove('hidden');
        }
        if (btnSystemUpdatesMobile) {
          btnSystemUpdatesMobile.classList.remove('hidden');
        }
      }
    }

    // ========================================
    // FUNÇÃO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // Inicializa ao carregar página
    window.addEventListener('DOMContentLoaded', () => {
      // Fecha o menu mobile ao clicar em qualquer link
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function () {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = document.getElementById('menuIcon');
          if (mobileMenu && menuIcon) {
            mobileMenu.classList.remove('show');
            menuIcon.style.transform = 'rotate(0deg)';
          }
        });
      });

      verificarAutenticacao();
      verificarMenuAdmin();

      // ✨ SINCRONIZAÇÃO: Verifica estado sincronizado na inicialização
      // Se popup foi fechado sem atualizar em outra página, mostra alerta vermelho
      setTimeout(() => {
        if (typeof verificarEstadoSincronizadoNaInicializacao === 'function') {
          verificarEstadoSincronizadoNaInicializacao();
        }
      }, 1500);

      carregarRegistros(false, null, null, false, false); // Carrega os registros do cache sem limpar

      // 🧭 Verifica estado global ao entrar na página e força recarregar se necessário
      function checkGlobalUpdateStateAndReload() {
        try {
          const raw = localStorage.getItem('naam_estado_atualizacao_painel');
          if (!raw) return;
          const state = JSON.parse(raw);
          if (state && state.state === true) {
            console.log('[Gerenciar] 🧭 Estado global = true. Recarregando dados com limpeza de cache...');
            window.PendingGlobalRefresh = true;
            if (typeof carregarRegistros === 'function') {
              carregarRegistros(false, null, null, true, true); // Force reload + limpar cache
            }
          }
        } catch (e) {
          console.warn('[Gerenciar] ⚠️ Erro ao verificar estado global:', e);
        }
      }

      // Checa imediatamente ao carregar
      checkGlobalUpdateStateAndReload();
      // Checa sempre que a aba voltar a ficar visível
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          checkGlobalUpdateStateAndReload();
        }
      });

      // Inicia detecção de mudanças se cache estiver habilitado
      if (window.CONFIG && window.CONFIG.CACHE_ENABLED && window.ChangeDetector && window.CONFIG.APPS_SCRIPT_CASOS) {
        // Função para verificar mudanças usando método melhorado
        const checkChanges = async () => {
          if (!window.DataCache) return false;

          const cachedHash = window.DataCache.getHash('gerenciar_casos');
          const cachedTimestamp = window.DataCache.getLastUpdate('gerenciar_casos');

          if (!cachedHash || !cachedTimestamp) return false;

          // Tenta usar endpoint leve primeiro
          try {
            const response = await fetch(window.CONFIG.APPS_SCRIPT_CASOS, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: 'data=' + encodeURIComponent(JSON.stringify({
                action: 'checkUpdates'
              })),
              signal: AbortSignal.timeout(10000)
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                // Usa timestamp se disponível - compara serverLastModified salvo com atual
                if (result.lastModified) {
                  const cachedServerLastModified = window.DataCache.getServerLastModified('gerenciar_casos');
                  if (cachedServerLastModified) {
                    const serverDate = new Date(result.lastModified);
                    const cachedDate = new Date(cachedServerLastModified);
                    // Compara com margem de 2 segundos para evitar falsos positivos
                    if (serverDate.getTime() > cachedDate.getTime() + 2000) {
                      console.log('[gerenciar-casos] Mudanças confirmadas via timestamp:', {
                        cached: cachedDate.toISOString(),
                        server: serverDate.toISOString(),
                        ids: result.recentNotificationIds || []
                      });
                      return true;
                    }
                    // Se timestamps são iguais ou próximos, não há mudanças
                    return false;
                  } else {
                    // Primeira vez - salva o serverLastModified e não detecta mudanças
                    const cachedData = window.DataCache.get('gerenciar_casos');
                    if (cachedData && result.lastModified) {
                      const expiry = window.CONFIG ? (window.CONFIG.CACHE_EXPIRY || 3600000) : 3600000;
                      window.DataCache.set('gerenciar_casos', cachedData, {
                        expiry: expiry,
                        serverLastModified: result.lastModified
                      });
                    }
                    return false;
                  }
                }

                // Se não há lastModified, usa outros métodos como fallback
                if (!result.lastModified) {
                  // Usa contador de registros
                  if (result.totalRecords !== undefined) {
                    const cachedData = window.DataCache.get('gerenciar_casos');
                    const cachedCount = cachedData ? cachedData.length : 0;
                    if (result.totalRecords !== cachedCount) {
                      console.log('[gerenciar-casos] Mudanças detectadas via contador (sem timestamp):', {
                        cached: cachedCount,
                        server: result.totalRecords
                      });
                      return true;
                    }
                  }

                  // Usa hash como fallback
                  if (result.hash && result.hash !== cachedHash) {
                    console.log('[gerenciar-casos] Mudanças detectadas via hash (sem timestamp)');
                    return true;
                  }
                }

                // Se chegou aqui, não há mudanças
                return false;
              }
            }
          } catch (error) {
            // Se endpoint não estiver disponível, usa método alternativo
            console.log('[ChangeDetector] Endpoint leve não disponível, usando método alternativo');
          }

          // Método alternativo: compara via iframe
          return new Promise((resolve) => {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = window.CONFIG.APPS_SCRIPT_CASOS + '?action=list&t=' + Date.now();

            const messageHandler = function (event) {
              if (!event.origin.includes('google')) return;
              if (!event.data || typeof event.data.success === 'undefined') return;

              if (event.data.success && event.data.registros) {
                // Compara contagem primeiro
                const cachedData = window.DataCache.get('gerenciar_casos');
                const cachedCount = cachedData ? cachedData.length : 0;

                if (event.data.registros.length !== cachedCount) {
                  window.removeEventListener('message', messageHandler);
                  setTimeout(() => iframe.remove(), 100);
                  resolve(true);
                  return;
                }

                // Se contagem é igual, compara hash
                const str = JSON.stringify(event.data.registros);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                  const char = str.charCodeAt(i);
                  hash = ((hash << 5) - hash) + char;
                  hash = hash & hash;
                }
                const newHash = Math.abs(hash).toString(36);

                window.removeEventListener('message', messageHandler);
                setTimeout(() => iframe.remove(), 100);
                resolve(newHash !== cachedHash);
              } else {
                window.removeEventListener('message', messageHandler);
                setTimeout(() => iframe.remove(), 100);
                resolve(false);
              }
            };

            window.addEventListener('message', messageHandler);
            document.body.appendChild(iframe);

            setTimeout(() => {
              window.removeEventListener('message', messageHandler);
              if (iframe.parentNode) iframe.remove();
              resolve(false);
            }, 10000);
          });
        };

        // Registra callback para mudanças
        window.ChangeDetector.onChange(async () => {
          const hasChanges = await checkChanges();

          // ✅ VERIFICAÇÃO DO FLAG: Se usuário já iniciou atualização, não mostra alertas
          if (hasChanges && !window.atualizacaoDisparadaPeloUsuario) {
            console.log('[ChangeDetector] 🔔 Mudanças detectadas. Exibindo notificações...');
            showAlertaNovasNotificacoes();
            if (window.UpdateNotification) {
              window.UpdateNotification.show('Banco de dados atualizado. Existem novas notificações disponíveis.', {
                callback: () => {
                  // Marca que usuário iniciou atualização
                  window.atualizacaoDisparadaPeloUsuario = true;
                  console.log('[UpdateNotification] ✅ Usuário clicou na notificação azul. Flag ativado.');
                  carregarRegistros(false, null, null, true, true); // Force reload com limpeza de cache
                }
              });
            }
          } else if (hasChanges && window.atualizacaoDisparadaPeloUsuario) {
            console.log('[ChangeDetector] ⏸️ Mudanças detectadas, mas atualização já foi iniciada. Nenhum alerta exibido.');
          }
        });

        // Inicia detecção periódica
        window.ChangeDetector.start({
          interval: window.CONFIG.POLLING_INTERVAL || 45000
        });
      }

      // Listener para evento de atualização solicitada
      if (window.UpdateNotification) {
        window.addEventListener('updateRequested', () => {
          carregarRegistros(false, null, null, true); // Force reload
        });
      }

      // ✨ SINCRONIZAÇÃO ENTRE PÁGINAS: Listener para invalidação de cache
      window.addEventListener('storage', (event) => {
        console.log('[Storage Event] 📡 Evento detectado:', event.key);
        if (event.key === 'naam_cache_invalidation' && event.newValue) {
          try {
            const invalidationEvent = JSON.parse(event.newValue);
            console.log('[Storage Event] 📊 Conteúdo do evento:', invalidationEvent);
            if (invalidationEvent.type === 'cache_invalidation' && invalidationEvent.cacheKey === 'gerenciar_casos') {
              console.log('[Sincronização] 📡 Evento de invalidação recebido da página:', invalidationEvent.source);

              // 🔴 Remove alerta quando cache é invalidado (significa que atualização foi feita)
              const alerta = document.getElementById('alerta-novas-notificacoes');
              if (alerta) {
                alerta.classList.remove('show');
                alerta.classList.add('hide');
                console.log('[Sincronização] 🔴 Alerta removido (cache invalidado)');
              }

              // Limpa cache local
              if (window.DataCache) {
                window.DataCache.clear('gerenciar_casos');
                console.log('[Sincronização] ✅ Cache local invalidado');
              }

              // Recarrega dados automaticamente se estiver na página de gerenciar
              if (typeof carregarRegistros === 'function') {
                console.log('[Sincronização] 🔄 Recarregando registros com dados atualizados...');
                carregarRegistros(false, null, null, true, false); // Force reload sem limpar novamente
              }
            }
          } catch (e) {
            console.warn('[Sincronização] ⚠️ Erro ao processar evento de invalidação:', e);
          }
        }

        // 🧭 Estado global de atualização vindo do Painel
        if (event.key === 'naam_estado_atualizacao_painel' && event.newValue) {
          try {
            const updateEvent = JSON.parse(event.newValue);
            console.log('[Sincronização] 🧭 Estado recebido:', updateEvent);
            if (updateEvent && updateEvent.state === true) {
              // Garante limpeza de cache local
              if (window.DataCache) {
                window.DataCache.clear('gerenciar_casos');
                console.log('[Gerenciar] 🧹 Cache local limpo por sinal do Painel');
              }
              // Dispara comportamento equivalente ao clique manual
              const btn = document.getElementById('btnCarregar');
              if (btn && typeof btn.click === 'function') {
                console.log('[Gerenciar] ▶️ Disparando clique programático em "Carregar Registros"');
                btn.click();
              } else if (typeof carregarRegistros === 'function') {
                console.log('[Gerenciar] ▶️ Chamando carregarRegistros() com força e limpeza de cache');
                carregarRegistros(false, null, null, true, true);
              } else {
                console.warn('[Gerenciar] ⚠️ Elemento/funcão de carregamento não disponível');
              }
            }
          } catch (e) {
            console.warn('[Gerenciar] ⚠️ Erro ao processar estado global:', e);
          }
        }
      });
    });

    /**
     * Mostra notificação de sincronização quando dados são atualizados por outra aba
     */
    function mostrarNotificacaoSincronizacao(mensagem, origem) {
      const alertaExistente = document.getElementById('alerta-novas-notificacoes');

      if (alertaExistente) {
        // Limpa as classes de animação anteriores
        alertaExistente.classList.remove('hide');

        // Atualiza o conteúdo do alerta
        alertaExistente.innerHTML = `
      < div class="flex items-center gap-3" >
            <span class="text-lg">🔔</span>
            <div class="flex flex-col">
              <span class="font-semibold">${mensagem}</span>
              <span class="text-sm text-rose-700">Sincronizado da aba: ${origem}</span>
            </div>
          </div >
      `;

        // Mostra o alerta
        alertaExistente.classList.add('show');
        console.log('[Notificação] ✅ Alerta exibido:', mensagem);

        // Remove as classes após 4 segundos
        setTimeout(() => {
          alertaExistente.classList.remove('show');
          alertaExistente.classList.add('hide');
        }, 4000);
      } else {
        console.warn('[Notificação] ⚠️ Elemento alerta não encontrado');
      }
    }

    // ========================================
    // SISTEMA SIMPLIFICADO DE VERIFICAÇÃO POR ID
    // ========================================
    // Verifica novas notificações comparando apenas IDs numéricos
    let ultimoIdSalvo = null;
    let intervaloVerificacaoId = null;
    const STORAGE_KEY_ULTIMO_ID = 'naam_ultimo_id_notificacao';

    /**
     * Carrega último ID salvo do localStorage
     */
    function carregarUltimoIdSalvo() {
      try {
        const salvo = localStorage.getItem(STORAGE_KEY_ULTIMO_ID);
        if (salvo !== null && salvo !== undefined && salvo !== '') {
          const id = Number(salvo);
          if (!isNaN(id)) {
            ultimoIdSalvo = id;
            console.log('[Cache/Notificações] ✅ ID carregado do cache:', ultimoIdSalvo);
            return id;
          }
        }
      } catch (error) {
        console.warn('[Cache/Notificações] Erro ao carregar ID do cache:', error);
      }
      return null;
    }

    /**
     * Salva último ID no localStorage
     */
    function salvarUltimoId(id) {
      try {
        if (id !== null && id !== undefined) {
          localStorage.setItem(STORAGE_KEY_ULTIMO_ID, String(id));
          ultimoIdSalvo = id;
          console.log('[Cache/Notificações] 💾 ID salvo no cache:', id);
        }
      } catch (error) {
        console.warn('[Cache/Notificações] Erro ao salvar ID no cache:', error);
      }
    }

    /**
     * Limpa último ID salvo do localStorage
     */
    function limparUltimoIdSalvo() {
      try {
        localStorage.removeItem(STORAGE_KEY_ULTIMO_ID);
        ultimoIdSalvo = null;
        console.log('[Cache/Notificações] 🧹 ID removido do cache');
      } catch (error) {
        console.warn('[Cache/Notificações] Erro ao limpar ID do cache:', error);
      }
    }

    /**
     * Função 1: Buscar último ID da planilha
     */
    async function buscarUltimoId() {
      try {
        if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
          console.warn('[Verificação ID] API não disponível');
          return null;
        }

        const resultado = await window.API.request(window.CONFIG.APPS_SCRIPT_CASOS, {
          action: 'getLastNotificationId'
        });

        if (resultado.success && resultado.lastId !== null && resultado.lastId !== undefined) {
          return Number(resultado.lastId);
        }

        return null;
      } catch (error) {
        console.error('[Verificação ID] Erro ao buscar último ID:', error);
        return null;
      }
    }

    // ========================================
    // SISTEMA DE MÁQUINA DE ESTADOS PARA NOTIFICAÇÕES
    // Garante: Toast SEMPRE aparece antes do Alerta (nunca simultâneo)
    // ========================================

    const NOTIF_STATES = {
      IDLE: 'idle',                           // Nenhuma notificação visível
      TOAST_SHOWING: 'toast_showing',         // Toast está visível/animando
      TOAST_EXITING: 'toast_exiting',         // Toast saindo (bloqueio ao alerta)
      ALERT_SHOWING: 'alert_showing',         // Alerta está visível
      ALERT_EXITING: 'alert_exiting'          // Alerta saindo
    };

    // Variável global: indica se o usuário fechou o popup azul clicando no X
    // Quando true, força a exibição do alerta vermelho e animação do botão
    window.popupAzulFechadoPeloUsuario = window.popupAzulFechadoPeloUsuario || false;

    // ========================================
    // SISTEMA DE SINCRONIZAÇÃO ENTRE PÁGINAS
    // ========================================
    // Rastreia estado do popup azul e sincroniza entre painel-casos.html e gerenciar-casos.html
    const SYNC_STATE_KEY = 'naam_popup_azul_sync_state';
    const SYNC_LAST_NOTIF_ID_KEY = 'naam_last_synced_notif_id';

    /**
     * Salva estado de sincronização no localStorage
     * @param {Object} state - Estado a ser salvo
     */
    function salvarEstadoSincronizacao(state) {
      try {
        const syncState = {
          ...state,
          timestamp: Date.now(),
          pagina: window.location.pathname.includes('painel-casos') ? 'painel' : 'gerenciar'
        };
        localStorage.setItem(SYNC_STATE_KEY, JSON.stringify(syncState));
        console.log('[Sync] 💾 Estado salvo:', syncState);
      } catch (e) {
        console.warn('[Sync] ⚠️ Erro ao salvar estado:', e);
      }
    }

    /**
     * Lê estado de sincronização do localStorage
     * @returns {Object|null} Estado ou null se não existir
     */
    function lerEstadoSincronizacao() {
      try {
        const stored = localStorage.getItem(SYNC_STATE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.warn('[Sync] ⚠️ Erro ao ler estado:', e);
      }
      return null;
    }

    /**
     * Limpa estado de sincronização
     */
    function limparEstadoSincronizacao() {
      try {
        localStorage.removeItem(SYNC_STATE_KEY);
        console.log('[Sync] 🧹 Estado limpo');
      } catch (e) {
        console.warn('[Sync] ⚠️ Erro ao limpar estado:', e);
      }
    }

    /**
     * Marca que popup azul foi criado (ativo)
     * @param {number} notifId - ID da notificação que gerou o popup
     */
    function marcarPopupAzulAtivo(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: true,
        popupFechadoSemAtualizar: false,
        popupAtualizado: false,
        notifId: notifId
      });
    }

    /**
     * Marca que popup azul foi fechado sem atualizar
     * @param {number} notifId - ID da notificação
     */
    function marcarPopupAzulFechadoSemAtualizar(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: false,
        popupFechadoSemAtualizar: true,
        popupAtualizado: false,
        notifId: notifId
      });
    }

    /**
     * Marca que popup azul foi atualizado (usuário clicou em Atualizar)
     * @param {number} notifId - ID da notificação
     */
    function marcarPopupAzulAtualizado(notifId) {
      salvarEstadoSincronizacao({
        popupAtivo: false,
        popupFechadoSemAtualizar: false,
        popupAtualizado: true,
        notifId: notifId
      });
      // Salva último ID sincronizado
      try {
        localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
      } catch (e) {
        console.warn('[Sync] ⚠️ Erro ao salvar último ID sincronizado:', e);
      }
    }

    /**
     * Verifica estado sincronizado na inicialização da página
     * Se popup foi fechado sem atualizar em outra página, mostra alerta vermelho
     */
    function verificarEstadoSincronizadoNaInicializacao() {
      const estado = lerEstadoSincronizacao();
      if (!estado) return;

      console.log('[Sync] 🔍 Verificando estado sincronizado:', estado);

      // Se popup foi fechado sem atualizar E não foi atualizado depois
      if (estado.popupFechadoSemAtualizar && !estado.popupAtualizado) {
        // Verifica se o ID da notificação ainda é relevante (não foi atualizado em outra página)
        const ultimoIdSincronizado = localStorage.getItem(SYNC_LAST_NOTIF_ID_KEY);
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');

        console.log('[Sync] 📊 Comparação de IDs:', {
          ultimoIdSincronizado,
          ultimoIdSalvo,
          estadoNotifId: estado.notifId
        });

        // Se não há ID sincronizado, significa que nunca houve atualização via popup
        // Nesse caso, sempre mostra o alerta se o popup foi fechado sem atualizar
        if (!ultimoIdSincronizado) {
          console.log('[Sync] 🔔 Popup foi fechado sem atualizar (nunca houve atualização). Mostrando alerta vermelho...');

          // Força mostrar alerta vermelho e animação
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }

        // Se há ID sincronizado, verifica se o ID atual é diferente (ainda há notificação pendente)
        // OU se o ID do estado é diferente do sincronizado (a notificação que gerou o popup ainda não foi processada)
        if (ultimoIdSalvo && ultimoIdSalvo !== ultimoIdSincronizado) {
          console.log('[Sync] 🔔 Popup foi fechado sem atualizar e há notificação pendente. Mostrando alerta vermelho...');

          // Força mostrar alerta vermelho e animação
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }

        // Se o ID do estado é diferente do sincronizado, também mostra (notificação específica não foi processada)
        if (estado.notifId && String(estado.notifId) !== ultimoIdSincronizado) {
          console.log('[Sync] 🔔 Popup foi fechado sem atualizar e a notificação específica não foi processada. Mostrando alerta vermelho...');

          // Força mostrar alerta vermelho e animação
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
          return;
        }

        // Se chegou aqui e o popup foi fechado sem atualizar, mostra o alerta de qualquer forma
        // (pode ser que o ID ainda não tenha sido atualizado, mas o popup foi fechado)
        console.log('[Sync] 🔔 Popup foi fechado sem atualizar. Mostrando alerta vermelho (fallback)...');

        // Força mostrar alerta vermelho e animação
        window.popupAzulFechadoPeloUsuario = true;
        setTimeout(() => {
          if (typeof showAlertaNovasNotificacoes === 'function') {
            showAlertaNovasNotificacoes();
          }
        }, 500);
      }
    }

    /**
     * Detecta navegação entre páginas e marca popup como fechado se estava ativo
     */
    function configurarDetecaoNavegacao() {
      // Detecta quando usuário está saindo da página
      window.addEventListener('beforeunload', () => {
        const estado = lerEstadoSincronizacao();
        const popupAtivo = document.getElementById('notificacao-nova-notificacao');

        console.log('[Sync] 🚪 beforeunload disparado. Estado:', estado, 'Popup ativo:', !!popupAtivo);

        // Se há popup azul ativo e usuário está navegando sem atualizar
        if (estado && estado.popupAtivo && popupAtivo) {
          console.log('[Sync] 🚪 Usuário navegando com popup azul ativo. Marcando como fechado sem atualizar...');
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
          marcarPopupAzulFechadoSemAtualizar(notifId);
        } else if (popupAtivo) {
          // Se há popup ativo mas não há estado salvo, cria o estado
          console.log('[Sync] 🚪 Popup ativo mas sem estado. Criando estado e marcando como fechado...');
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
          marcarPopupAzulFechadoSemAtualizar(notifId);
        }
      });

      // Também detecta quando a página fica oculta (mudança de aba)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          const estado = lerEstadoSincronizacao();
          const popupAtivo = document.getElementById('notificacao-nova-notificacao');

          console.log('[Sync] 👁️ Página ocultada. Estado:', estado, 'Popup ativo:', !!popupAtivo);

          // Se há popup azul ativo e página foi ocultada
          if (estado && estado.popupAtivo && popupAtivo) {
            console.log('[Sync] 👁️ Página ocultada com popup azul ativo. Marcando como fechado sem atualizar...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
            marcarPopupAzulFechadoSemAtualizar(notifId);
          } else if (popupAtivo) {
            // Se há popup ativo mas não há estado salvo, cria o estado
            console.log('[Sync] 👁️ Popup ativo mas sem estado. Criando estado e marcando como fechado...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
            marcarPopupAzulFechadoSemAtualizar(notifId);
          }
        }
      });
    }

    // Configura detecção de navegação ao carregar
    configurarDetecaoNavegacao();

    const NotificationManager = {
      state: NOTIF_STATES.IDLE,
      hasStoredNotif: false,
      timeoutMap: {},

      // ===== ESTADO MÁQUINA =====
      setState(newState) {
        if (newState === this.state) return;
        console.log(`[NotifState] ${this.state} → ${newState} `);
        this.state = newState;
      },

      // ===== VERIFICAÇÕES DE SEGURANÇA =====
      canShowToast() {
        return this.state === NOTIF_STATES.IDLE;
      },

      canShowAlert() {
        // Alerta SÓ pode aparecer se:
        // 1. Estado é IDLE (nenhuma notificação ativa)
        // 2. Toast NÃO está visível
        return this.state === NOTIF_STATES.IDLE &&
          !this.isToastVisible();
      },

      isToastVisible() {
        const toast = document.getElementById('notificacao-nova-notificacao');
        if (!toast) return false;
        // Verifica se o toast está realmente visível (não está saindo e não está oculto)
        const isExiting = toast.classList.contains('notificacao-exit');
        const isVisible = toast.classList.contains('notificacao-visible');
        const isHidden = toast.style.display === 'none' || toast.offsetParent === null;
        return !isExiting && isVisible && !isHidden;
      },

      // ===== MOSTRAR TOAST =====
      showToast() {
        // Rejeita se não está em IDLE
        if (!this.canShowToast()) {
          console.warn('[NotifManager] ❌ Toast rejeitado: estado não é IDLE');
          return false;
        }

        this.setState(NOTIF_STATES.TOAST_SHOWING);
        this.hasStoredNotif = true;

        // Bloqueia o alerta (se existir)
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.add('toast-blocking');
        }

        // Salva flag no localStorage (para recargas)
        try {
          localStorage.setItem('naam_new_notif_flag', '1');
        } catch (e) {
          console.warn('[NotifManager] Erro ao salvar flag:', e);
        }

        console.log('[NotifManager] ✅ Toast: MOSTRANDO');
        return true;
      },

      // ===== INICIAR SAÍDA DO TOAST =====
      startToastExit() {
        if (this.state !== NOTIF_STATES.TOAST_SHOWING) {
          console.warn('[NotifManager] ❌ Toast exit rejeitado: estado não é TOAST_SHOWING');
          return;
        }

        this.setState(NOTIF_STATES.TOAST_EXITING);
        console.log('[NotifManager] ⏹️ Toast: SAINDO (alerta BLOQUEADO)');

        // Libera o alerta após a animação (400ms)
        this.clearTimeout('toastExit');
        this.timeoutMap['toastExit'] = setTimeout(() => {
          this.completeToastExit();
        }, 400);
      },

      // ===== COMPLETAR SAÍDA DO TOAST =====
      completeToastExit() {
        this.setState(NOTIF_STATES.IDLE);
        console.log('[NotifManager] ✅ Toast: REMOVIDO - liberando Alerta');

        // Desbloqueia o alerta
        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.remove('toast-blocking');
        }

        // Agora sim, mostra o alerta se foi marcado
        // Usa showAlertaNovasNotificacoes() diretamente que já tem toda a lógica
        if (this.hasStoredNotif) {
          setTimeout(() => {
            // Chama showAlertaNovasNotificacoes() que vai usar showAlert() internamente
            // mas com todas as verificações necessárias
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 50);
        }
      },

      // ===== MOSTRAR ALERTA =====
      showAlert() {
        // SEGURANÇA: Rejeita se toast ainda está visível
        if (!this.canShowAlert()) {
          console.warn('[NotifManager] ❌ Alerta rejeitado: Toast ainda está ativo ou estado inválido');
          return false;
        }
        // Bloqueio global: se atualização foi iniciada via popup azul,
        // não exibir alerta e remover qualquer instância existente do DOM
        if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
          console.warn('[NotifManager] 🚫 Alerta bloqueado: atualização iniciada via popup');
          const alertaBloquear = document.getElementById('alerta-novas-notificacoes');
          if (alertaBloquear) alertaBloquear.remove();
          return false;
        }

        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (!alerta) return false;

        this.setState(NOTIF_STATES.ALERT_SHOWING);

        // Animar entrada do alerta
        alerta.style.display = 'flex';
        void alerta.offsetWidth; // Força reflow
        alerta.classList.remove('hide');
        alerta.classList.add('show');

        // ✨ Ativa animação de pulsar no botão de carregar
        ativarPulseBotao('btnCarregar');

        console.log('[NotifManager] ✅ Alerta: MOSTRANDO');
        return true;
      },

      // ===== INICIAR SAÍDA DO ALERTA =====
      startAlertExit() {
        if (this.state !== NOTIF_STATES.ALERT_SHOWING) {
          console.warn('[NotifManager] ⚠️ Alert exit: estado não é ALERT_SHOWING, ignorando');
          return;
        }

        this.setState(NOTIF_STATES.ALERT_EXITING);
        console.log('[NotifManager] ⏹️ Alerta: SAINDO');

        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          alerta.classList.remove('show');
          alerta.classList.add('hide');
        }

        // Completa saída após animação
        this.clearTimeout('alertExit');
        this.timeoutMap['alertExit'] = setTimeout(() => {
          this.completeAlertExit();
        }, 400);
      },

      // ===== COMPLETAR SAÍDA DO ALERTA =====
      completeAlertExit() {
        this.setState(NOTIF_STATES.IDLE);
        this.hasStoredNotif = false;

        const alerta = document.getElementById('alerta-novas-notificacoes');
        if (alerta) {
          if (window.atualizacaoDisparadaPeloUsuario) {
            // Remoção definitiva quando o fluxo foi iniciado via popup azul
            alerta.remove();
          } else {
            alerta.style.display = 'none';
            alerta.classList.remove('show', 'hide');
          }
        }

        // ✨ Remove animação de pulsar do botão de carregar
        desativarPulseBotao('btnCarregar');

        // Limpa localStorage
        try {
          localStorage.removeItem('naam_new_notif_flag');
        } catch (e) {
          console.warn('[NotifManager] Erro ao limpar flag:', e);
        }

        console.log('[NotifManager] ✅ Sistema: IDLE novamente');
      },

      // ===== HELPERS =====
      clearTimeout(key) {
        if (this.timeoutMap[key]) {
          clearTimeout(this.timeoutMap[key]);
          delete this.timeoutMap[key];
        }
      },

      cleanup() {
        Object.keys(this.timeoutMap).forEach(key => this.clearTimeout(key));
        this.state = NOTIF_STATES.IDLE;
      }
    };

    // ===== FUNÇÕES UTILITÁRIAS PARA ANIMAÇÃO DE PULSAR =====
    /**
     * Ativa a animação de pulsar em um botão
     * @param {HTMLElement|string} botao - Elemento do botão ou ID do botão
     */
    function ativarPulseBotao(botao) {
      const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
      if (elemento) {
        elemento.classList.add('btn-pulse-active');
      }
    }

    /**
     * Desativa a animação de pulsar em um botão
     * @param {HTMLElement|string} botao - Elemento do botão ou ID do botão
     */
    function desativarPulseBotao(botao) {
      const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
      if (elemento) {
        elemento.classList.remove('btn-pulse-active');
      }
    }

    // Restaura estado ao carregar página (se havia notificação pendente)
    (function restoreNotificationState() {
      try {
        const hasFlag = localStorage.getItem('naam_new_notif_flag') === '1';
        if (hasFlag) {
          NotificationManager.hasStoredNotif = true;
          // Mostra alerta após DOM estar pronto
          setTimeout(() => {
            NotificationManager.showAlert();
          }, 100);
        }
      } catch (e) {
        console.warn('[NotifManager] Erro ao restaurar estado:', e);
      }
    })();

    // ===== WRAPPER COMPATÍVEL COM CÓDIGO ANTIGO =====
    function showAlertaNovasNotificacoes(count, deveAguardarToast = false) {
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');
      let alerta = document.getElementById('alerta-novas-notificacoes');

      // Determina contagem de novas notificações, se fornecida ou salva globalmente
      let totalNovas = null;
      if (typeof count === 'number' && count > 0) {
        totalNovas = count;
      } else if (typeof count === 'string') {
        const parsed = parseInt(count, 10);
        if (!isNaN(parsed) && parsed > 0) {
          totalNovas = parsed;
        }
      }
      // Se não veio via parâmetro, tenta ler do localStorage (contador global)
      if (totalNovas === null) {
        try {
          const stored = localStorage.getItem('naam_new_notif_count');
          if (stored) {
            const parsed = parseInt(stored, 10);
            if (!isNaN(parsed) && parsed > 0) {
              totalNovas = parsed;
            }
          }
        } catch (e) {
          console.warn('[Alerta] ⚠️ Erro ao ler contador global de novas notificações:', e);
        }
      }

      function aplicarTextoEContador() {
        if (!alerta) return;
        const titulo = alerta.querySelector('span.font-semibold');
        const descricao = alerta.querySelector('span.text-sm');

        if (titulo) {
          if (totalNovas === 1) {
            titulo.textContent = 'Existe 1 nova notificação!';
          } else if (typeof totalNovas === 'number' && totalNovas > 1) {
            titulo.textContent = `Existem ${totalNovas} novas notificações!`;
          } else {
            // fallback quando não sabemos o número exato
            titulo.textContent = 'Existem novas notificações!';
          }
        }

        if (descricao) {
          // Mantém o texto padrão da página de Gerenciar Registros
          descricao.textContent = 'Clique em Carregar Registros para atualizar.';
        }
      }

      function atualizarBadges() {
        const valorBadge = totalNovas != null ? String(totalNovas) : '!';
        if (badgeDesktop) {
          badgeDesktop.textContent = valorBadge;
          badgeDesktop.classList.remove('hidden');
        }
        if (badgeMobile) {
          badgeMobile.textContent = valorBadge;
          badgeMobile.classList.remove('hidden');
        }
      }

      // Bloqueio global: se atualização foi iniciada via popup azul,
      // não exibir quaisquer alertas/badges e remover o alerta do DOM
      if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
        if (alerta) alerta.remove();
        if (badgeDesktop) badgeDesktop.classList.add('hidden');
        if (badgeMobile) badgeMobile.classList.add('hidden');
        console.log('[Alerta] 🚫 Bloqueado por atualização via popup; alerta removido do DOM');
        return;
      }

      // FORÇA EXIBIÇÃO: Se o usuário fechou o popup azul clicando no X
      // (ou por timeout), força mostrar o alerta vermelho e animação do botão,
      // ignorando completamente a state machine
      if (window.popupAzulFechadoPeloUsuario) {
        console.log('[Alerta] ✅ Popup azul foi fechado pelo usuário. FORÇANDO exibição do alerta vermelho...');

        // Reseta estado da state machine para garantir
        if (typeof NotificationManager !== 'undefined') {
          NotificationManager.setState('idle');
          NotificationManager.hasStoredNotif = false;
        }

        // Garante que o elemento do alerta exista.
        // Se já foi removido do DOM, recria a partir do markup padrão.
        if (!alerta) {
          console.warn('[Alerta] ⚠️ Elemento #alerta-novas-notificacoes não encontrado. Recriando alerta no DOM...');
          alerta = document.createElement('div');
          alerta.id = 'alerta-novas-notificacoes';
          alerta.className = 'alerta-novas-notificacoes mb-4';
          alerta.innerHTML = `
      <div class="flex items-center gap-3">
              <span class="text-lg">🔔</span>
              <div class="flex flex-col">
                <span class="font-semibold">Existem novas notificações!</span>
                <span class="text-sm text-rose-700">Clique em Carregar Registros para atualizar.</span>
              </div>
            </div>
      `;

          // Insere o alerta logo acima do cabeçalho, como no HTML original
          const header = document.querySelector('.bg-gradient-to-r.from-white.to-blue-50\\/30')
            || document.querySelector('.bg-white.rounded-xl.shadow-xl.p-6.mb-6');
          if (header && header.parentElement) {
            header.parentElement.insertBefore(alerta, header);
          } else {
            // Fallback: adiciona no topo do body
            document.body.insertBefore(alerta, document.body.firstChild);
          }
        }

        // Força mostrar o alerta vermelho diretamente
        alerta.style.display = 'flex';
        void alerta.offsetWidth; // Força reflow
        alerta.classList.remove('hide');
        alerta.classList.add('show');
        console.log('[Alerta] ✅ Alerta vermelho FORÇADO a aparecer');

        // Atualiza textos e contador no próprio alerta
        aplicarTextoEContador();

        // Força ativar animação de pulsar no botão de carregar
        ativarPulseBotao('btnCarregar');
        console.log('[Alerta] ✅ Animação de pulsar FORÇADA no botão Carregar Registros');

        // Atualiza badges (se ainda existirem no DOM)
        atualizarBadges();

        // Reseta a variável após usar (para não interferir em próximas notificações)
        window.popupAzulFechadoPeloUsuario = false;
        return;
      }

      // Atualiza texto/contador no alerta com base na contagem (quando existir)
      if (alerta) {
        aplicarTextoEContador();
      }

      if (deveAguardarToast) {
        // Marca como pendente, mas NÃO mostra
        NotificationManager.hasStoredNotif = true;
        atualizarBadges();
        return;
      }

      // Tenta mostrar alerta via state machine
      const showed = NotificationManager.showAlert();
      if (showed) {
        atualizarBadges();
      }
    }

    function hideAlertaNovasNotificacoes(clearFlag = true) {
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');

      NotificationManager.startAlertExit();

      if (badgeDesktop) badgeDesktop.classList.add('hidden');
      if (badgeMobile) badgeMobile.classList.add('hidden');

      if (!clearFlag) {
        NotificationManager.hasStoredNotif = true; // Mantém pendente
      }
    }

    function handleVerNotificacoesCTA() {
      hideAlertaNovasNotificacoes(true);
      window.location.href = 'minhas-notificacoes.html';
    }

    /**
     * Função 2: Verificação contínua de mudanças
     */
    async function verificarMudancasPorId() {
      try {
        // Bloqueio: se atualização foi iniciada via popup azul, não criar alertas/toasts
        if (window.atualizacaoDisparadaPeloUsuario) {
          console.log('[Verificação ID] 🚫 Suprimido: atualização iniciada via popup, sem alertas adicionais.');
          return;
        }
        // Chama Função 1 para obter último ID da planilha
        const ultimoIdPlanilha = await buscarUltimoId();

        if (ultimoIdPlanilha === null) {
          console.log('[Verificação ID] Não foi possível obter ID da planilha');
          return;
        }

        // Comparação: ultimoIdPlanilha vs ultimoIdSalvo
        if (ultimoIdSalvo === null) {
          // Primeira execução: apenas salva o ID
          salvarUltimoId(ultimoIdPlanilha);
          console.log('[Verificação ID] ID inicial salvo:', ultimoIdSalvo);
          return;
        }

        // Comparação numérica estrita
        if (ultimoIdPlanilha === ultimoIdSalvo) {
          // IDs iguais → não há nova notificação
          console.log('[Verificação ID] Nenhuma mudança detectada (ID:', ultimoIdPlanilha + ')');
          return;
        }

        // IDs diferentes → há nova notificação
        console.log('[Verificação ID] 🔔 NOVA NOTIFICAÇÃO DETECTADA!');
        console.log('  • ID anterior:', ultimoIdSalvo);
        console.log('  • ID atual:', ultimoIdPlanilha);

        // Calcula uma contagem aproximada de novas notificações
        let diff = null;
        if (typeof ultimoIdSalvo === 'number' && !isNaN(ultimoIdSalvo)) {
          diff = ultimoIdPlanilha - ultimoIdSalvo;
        }
        let countNovas = 1;
        if (diff !== null && diff > 0) {
          countNovas = diff;
        }
        console.log('[Verificação ID] 🧮 Contagem estimada de novas notificações:', countNovas);
        try {
          localStorage.setItem('naam_new_notif_count', String(countNovas));
        } catch (e) {
          console.warn('[Verificação ID] ⚠️ Erro ao salvar contador de novas notificações:', e);
        }

        // Notificar sistema (popup azul + alerta, que lerão o contador)
        mostrarNotificacaoNovaNotificacao(countNovas);

        // Atualizar ultimoIdSalvo e salvar no cache
        salvarUltimoId(ultimoIdPlanilha);
        console.log('[Verificação ID] ID atualizado para:', ultimoIdSalvo);

      } catch (error) {
        console.error('[Verificação ID] Erro na verificação:', error);
      }
    }

    // Dispara atualização via popup azul com bloqueio de alertas
    function atualizarViaPopupNotificacao() {
      console.log('[Popup Azul] ▶️ Atualização iniciada pelo usuário');
      // Reseta variável de fechamento (usuário escolheu atualizar, não fechar)
      window.popupAzulFechadoPeloUsuario = false;
      // Seta flag global para bloquear qualquer alerta/contadores/anim.
      window.atualizacaoDisparadaPeloUsuario = true;
      window.atualizacaoIniciadaViaPopup = true;

      // ✨ SINCRONIZAÇÃO: Marca que popup foi atualizado
      const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
      const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
      if (typeof marcarPopupAzulAtualizado === 'function') {
        marcarPopupAzulAtualizado(notifId);
      }
      try {
        localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
          state: true,
          timestamp: Date.now(),
          source: 'popup-azul-gerenciar'
        }));
      } catch (e) {
        console.warn('[Popup Azul] ⚠️ Falha ao persistir estado global:', e);
      }

      // Remove imediatamente qualquer alerta persistente do DOM
      const alerta = document.getElementById('alerta-novas-notificacoes');
      if (alerta) alerta.remove();

      // Garante remoção de animação do botão
      desativarPulseBotao('btnCarregar');

      // Executa o fluxo padrão de atualização (cache + recarregar)
      if (typeof atualizarCacheNotificacoes === 'function') {
        atualizarCacheNotificacoes();
      } else {
        // Fallback: remove toast e dá reload
        const notificacao = document.getElementById('notificacao-nova-notificacao');
        if (notificacao) notificacao.remove();
        location.reload();
      }
    }

    function atualizarCacheNotificacoes() {
      console.log('[Notificação] 🔄 Atualizando cache de notificações...');

      // Remove a notificação visual com animação de saída
      const notificacao = document.getElementById('notificacao-nova-notificacao');
      if (notificacao) {
        notificacao.classList.remove('notificacao-visible');
        notificacao.classList.add('notificacao-exit');

        setTimeout(() => {
          notificacao.remove();
          // Notifica state machine que toast saiu
          NotificationManager.completeToastExit();
        }, 400);
      }

      // Limpa cache de registros e atualiza ID
      limparCacheERecarregarNotificacoes();

      // Recarrega os registros sem recarregar a página
      if (typeof carregarRegistros === 'function') {
        carregarRegistros(false, null, null, true, false);
        console.log('[Notificação] ✅ Cache atualizado e registros recarregados');

        // ✨ SINCRONIZAÇÃO: Após atualização bem-sucedida, atualiza último ID sincronizado
        // Aguarda um pouco para garantir que o ID foi atualizado
        setTimeout(() => {
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          if (ultimoIdSalvo && typeof marcarPopupAzulAtualizado === 'function') {
            const notifId = parseInt(ultimoIdSalvo, 10);
            // Atualiza o último ID sincronizado para refletir que esta notificação foi processada
            try {
              localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
              console.log('[Sync] ✅ Último ID sincronizado atualizado após atualização:', notifId);
            } catch (e) {
              console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
            }
          }
        }, 2000);
      } else {
        console.warn('[Notificação] ⚠️ Função carregarRegistros não disponível');
      }
    }

    /**
     * Atualiza o contador no alerta vermelho com animação de shake e incrementa o valor
     * @param {number} countNovas - Quantidade de novas notificações a adicionar
     */
    function atualizarContadorAlertaVermelhoComShake(countNovas) {
      const alerta = document.getElementById('alerta-novas-notificacoes');
      if (!alerta) return;

      // Verifica se o alerta está visível
      const estaVisivel = alerta.classList.contains('show') ||
        alerta.style.display === 'flex' ||
        (alerta.offsetParent !== null && alerta.style.display !== 'none');

      if (!estaVisivel) return;

      const titulo = alerta.querySelector('span.font-semibold');
      if (!titulo) return;

      // Extrai o número atual do texto do título
      let contadorAtual = 0;
      const textoAtual = titulo.textContent;
      const match = textoAtual.match(/(\d+)/);
      if (match) {
        contadorAtual = parseInt(match[1], 10);
      } else if (textoAtual.includes('Existe 1 nova')) {
        contadorAtual = 1;
      } else if (textoAtual.includes('Existem novas')) {
        // Se não tem número, tenta ler do localStorage
        try {
          const stored = localStorage.getItem('naam_new_notif_count');
          if (stored) {
            contadorAtual = parseInt(stored, 10) || 0;
          }
        } catch (e) {
          console.warn('[Contador] ⚠️ Erro ao ler contador:', e);
        }
      }

      // Incrementa o contador
      const novoTotal = contadorAtual + (countNovas || 1);

      // Atualiza o localStorage global
      try {
        localStorage.setItem('naam_new_notif_count', String(novoTotal));
      } catch (e) {
        console.warn('[Contador] ⚠️ Erro ao salvar contador:', e);
      }

      // Atualiza o texto do título
      if (novoTotal === 1) {
        titulo.textContent = 'Existe 1 nova notificação!';
      } else {
        titulo.textContent = `Existem ${novoTotal} novas notificações!`;
      }

      // Aplica animação de shake no título
      titulo.classList.add('contador-shake');
      setTimeout(() => {
        titulo.classList.remove('contador-shake');
      }, 500);

      // Atualiza badges se existirem
      const badgeDesktop = document.getElementById('badge-notif-desktop');
      const badgeMobile = document.getElementById('badge-notif-mobile');
      if (badgeDesktop) {
        badgeDesktop.textContent = String(novoTotal);
        badgeDesktop.classList.remove('hidden');
      }
      if (badgeMobile) {
        badgeMobile.textContent = String(novoTotal);
        badgeMobile.classList.remove('hidden');
      }

      console.log('[Contador] ✅ Contador atualizado com shake:', contadorAtual, '→', novoTotal);
    }

    /**
     * Mostra notificação visual elegante e compacta de nova notificação
     */
    function mostrarNotificacaoNovaNotificacao(count) {
      // Verifica se o alerta vermelho já está visível
      const alertaVermelho = document.getElementById('alerta-novas-notificacoes');
      const alertaEstaVisivel = alertaVermelho && (
        alertaVermelho.classList.contains('show') ||
        alertaVermelho.style.display === 'flex' ||
        (alertaVermelho.offsetParent !== null && alertaVermelho.style.display !== 'none')
      );

      // Se o alerta vermelho já está visível, apenas atualiza o contador com shake
      if (alertaEstaVisivel) {
        console.log('[Popup Azul] ⚠️ Alerta vermelho já está visível. Atualizando contador com shake em vez de mostrar popup azul.');
        atualizarContadorAlertaVermelhoComShake(count || 1);
        return; // Não cria o popup azul
      }

      // Remove notificação anterior se existir
      const notificacaoAnterior = document.getElementById('notificacao-nova-notificacao');
      if (notificacaoAnterior) {
        notificacaoAnterior.remove();
      }
      // Marca a flag mas não mostra alerta ainda (aguardará saída do toast)
      // Passa a contagem (se fornecida) para o alerta vermelho
      showAlertaNovasNotificacoes(typeof count === 'number' ? count : null, true);

      // ✨ SINCRONIZAÇÃO: Marca que popup azul está ativo
      const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
      const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
      if (typeof marcarPopupAzulAtivo === 'function') {
        marcarPopupAzulAtivo(notifId);
      }

      // Cria container principal
      const notificacao = document.createElement('div');
      notificacao.id = 'notificacao-nova-notificacao';
      notificacao.className = 'notificacao-nova-elegante';

      // HTML da notificação harmônica e integrada
      notificacao.innerHTML = `
      <div class="notificacao-conteudo">
          <div class="notificacao-icone-container">
            <svg class="notificacao-icone" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="notificacao-texto">
            <div class="notificacao-titulo">
              <span class="notificacao-badge">NOVO</span>
              <span class="notificacao-mensagem-principal">Nova Notificação Recebida</span>
            </div>
            <div class="notificacao-descricao">
              Banco de dados recebeu nova notificação
            </div>
            <div class="notificacao-acoes">
              <button class="notificacao-btn-atualizar" onclick="if (typeof atualizarViaPopupNotificacao === 'function') { atualizarViaPopupNotificacao(); } else { this.closest('.notificacao-nova-elegante').remove(); location.reload(); }">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Atualizar
              </button>
              <button class="notificacao-btn-fechar" onclick="fecharNotificacaoToast(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
      <div class="notificacao-progresso"></div>
      `;

      document.body.appendChild(notificacao);

      // Animação de entrada
      setTimeout(() => {
        notificacao.classList.add('notificacao-visible');
      }, 10);

      // Barra de progresso (15 segundos) - apenas visual, não fecha mais sozinha
      const progresso = notificacao.querySelector('.notificacao-progresso');
      if (progresso) {
        progresso.style.animation = 'notificacaoProgresso 15s linear forwards';
      }

      // Removido o fechamento automático em 15s.
      // Este popup azul só sai quando:
      // - Usuário clicar em "Atualizar" (atualiza os dados), ou
      // - Usuário clicar no "X" (fecha e força o alerta vermelho).
    }

    /**
     * Função para fechar a notificação toast manualmente
     */
    function fecharNotificacaoToast(botao) {
      const notificacao = botao.closest('.notificacao-nova-elegante');
      if (notificacao) {
        // Marca que o usuário fechou o popup azul clicando no X
        window.popupAzulFechadoPeloUsuario = true;
        console.log('[Popup Azul] ❌ Usuário fechou o popup azul. Forçando exibição do alerta vermelho...');

        // ✨ SINCRONIZAÇÃO: Marca que popup foi fechado sem atualizar
        const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
        const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
        if (typeof marcarPopupAzulFechadoSemAtualizar === 'function') {
          marcarPopupAzulFechadoSemAtualizar(notifId);
        }

        notificacao.classList.remove('notificacao-visible');
        notificacao.classList.add('notificacao-exit');

        // Remove do DOM após animação
        setTimeout(() => {
          notificacao.remove();
          // Força mostrar o alerta vermelho e animação do botão
          if (typeof showAlertaNovasNotificacoes === 'function') {
            showAlertaNovasNotificacoes();
          }
        }, 400);
      }
    }

    // Torna a função acessível globalmente para o onclick inline
    if (typeof window !== 'undefined') {
      window.fecharNotificacaoToast = fecharNotificacaoToast;
    }

    /**
     * Limpa cache e recarrega notificações
     * NOTA: Não limpa o último ID salvo, apenas atualiza para o ID atual da planilha
     */
    function limparCacheERecarregarNotificacoes() {
      console.log('[Cache/Notificações] 🧹 Limpando cache de registros...');

      // Limpa cache de registros (mas mantém o ID de notificação)
      if (window.DataCache) {
        window.DataCache.clear('gerenciar_casos');
        console.log('[Cache/Notificações] ✅ Cache de registros limpo');
      }

      // 🔴 Remove alerta quando cache é limpo (significa que atualização foi feita)
      const alerta = document.getElementById('alerta-novas-notificacoes');
      if (alerta) {
        alerta.remove();
        console.log('[Cache/Notificações] 🔴 Alerta removido do DOM (cache limpo)');
      }

      // ✨ SINCRONIZAÇÃO ENTRE PÁGINAS: Notifica outras páginas abertas
      try {
        const invalidationEvent = {
          type: 'cache_invalidation',
          timestamp: Date.now(),
          source: 'gerenciar-casos',
          cacheKey: 'gerenciar_casos'
        };
        localStorage.setItem('naam_cache_invalidation', JSON.stringify(invalidationEvent));
        console.log('[Cache/Notificações] 📡 Evento de invalidação enviado para outras páginas');
      } catch (e) {
        console.warn('[Cache/Notificações] ⚠️ Erro ao enviar evento de invalidação:', e);
      }

      // Atualiza o último ID salvo com o ID atual da planilha (sem resetar)
      if (window.API && window.CONFIG && window.CONFIG.APPS_SCRIPT_CASOS) {
        buscarUltimoId().then(id => {
          if (id !== null) {
            salvarUltimoId(id);
            console.log('[Cache/Notificações] ✅ ID atualizado para:', ultimoIdSalvo);

            // ✨ SINCRONIZAÇÃO: Só atualiza último ID sincronizado se for ação do usuário
            // (não atualiza se for chamada automaticamente)
            if (window._carregarRegistrosIsUserAction) {
              try {
                localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(id));
                console.log('[Sync] ✅ Último ID sincronizado atualizado (ação do usuário):', id);
              } catch (e) {
                console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
              }
            }
          }
        });
      }
    }

    /**
     * Inicia o sistema de verificação contínua
     */
    function iniciarVerificacaoPorId() {
      // Verifica se API e CONFIG estão disponíveis
      if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
        console.warn('[Verificação ID] ⏳ Aguardando carregamento da API...');
        // Tenta novamente após 1 segundo
        setTimeout(iniciarVerificacaoPorId, 1000);
        return;
      }

      // Limpa intervalo anterior se existir
      if (intervaloVerificacaoId) {
        clearInterval(intervaloVerificacaoId);
      }

      console.log('[Verificação ID] 🚀 Iniciando sistema de verificação por ID...');
      console.log('[Verificação ID] API disponível:', !!window.API);
      console.log('[Verificação ID] CONFIG disponível:', !!window.CONFIG);
      console.log('[Verificação ID] APPS_SCRIPT_CASOS:', window.CONFIG.APPS_SCRIPT_CASOS);

      // Carrega ID salvo do cache primeiro
      const idSalvo = carregarUltimoIdSalvo();

      // Se não há ID salvo, busca da planilha
      if (idSalvo === null) {
        buscarUltimoId().then(id => {
          if (id !== null) {
            salvarUltimoId(id);
            console.log('[Verificação ID] ✅ ID inicial obtido e salvo:', ultimoIdSalvo);
          } else {
            console.warn('[Verificação ID] ⚠️ Não foi possível obter ID inicial, tentando novamente...');
          }
        });
      } else {
        console.log('[Verificação ID] ✅ ID carregado do cache:', ultimoIdSalvo);
      }

      // Intervalo de verificação: 10 segundos (pode ser configurado)
      const intervalo = 10000; // 10 segundos

      // Executa primeira verificação após 5 segundos
      setTimeout(() => {
        verificarMudancasPorId();
      }, 5000);

      // Configura verificação contínua
      intervaloVerificacaoId = setInterval(() => {
        verificarMudancasPorId();
      }, intervalo);

      console.log('[Verificação ID] ✅ Sistema iniciado! Verificando a cada', intervalo / 1000, 'segundos');
    }

    // Aguarda carregamento completo antes de iniciar
    function aguardarEIniciar() {
      // Verifica se tudo está carregado
      if (typeof window !== 'undefined' &&
        typeof window.CONFIG !== 'undefined' &&
        typeof window.API !== 'undefined' &&
        window.CONFIG.APPS_SCRIPT_CASOS) {
        iniciarVerificacaoPorId();
      } else {
        // Tenta novamente após 500ms
        setTimeout(aguardarEIniciar, 500);
      }
    }

    // Inicia verificação quando a página carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Aguarda um pouco mais para garantir que todos os scripts carregaram
        setTimeout(aguardarEIniciar, 1000);
      });
    } else {
      // Página já carregou, aguarda scripts
      setTimeout(aguardarEIniciar, 1000);
    }
  </script>

  <!-- Modal de Atualizacoes do Sistema (apenas admins) -->
  <div id="modal-system-updates"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Atualizacoes do Sistema</h2>
        <button onclick="fecharModalSystemUpdates()"
          class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
          <span class="text-2xl">&times;</span>
        </button>
      </div>
      <div class="p-6">
        <!-- Filtros -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por tipo:</label>
            <select id="filtro-tipo-system-update"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              onchange="carregarSystemUpdates()">
              <option value="">Todos os tipos</option>
              <option value="CRIACAO">Criacao</option>
              <option value="EDICAO">Edicao</option>
              <option value="EXCLUSAO">Exclusao</option>
              <option value="LOGIN">Login</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="carregarSystemUpdates()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
              <span>🔄</span> Atualizar
            </button>
          </div>
        </div>
        <!-- Lista de atualizacoes -->
        <div id="lista-system-updates" class="overflow-y-auto max-h-[60vh] space-y-3">
          <div class="text-center py-8 text-gray-500">
            <p>Clique em Atualizar para carregar as atualizacoes</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // FUNCOES PARA SYSTEM UPDATES
    // ========================================

    function abrirModalSystemUpdates() {
      const modal = document.getElementById('modal-system-updates');
      if (modal) {
        modal.classList.remove('hidden');
        carregarSystemUpdates();
      }
    }

    function fecharModalSystemUpdates() {
      const modal = document.getElementById('modal-system-updates');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    async function carregarSystemUpdates() {
      const container = document.getElementById('lista-system-updates');
      const filtroTipo = document.getElementById('filtro-tipo-system-update').value;

      if (!container) return;

      // Loading
      container.innerHTML = `
      <div class="text-center py-8">
          <div class="inline-block w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
          <p class="mt-2 text-gray-500">Carregando atualizacoes...</p>
        </div>
      `;

      try {
        if (!window.API) {
          throw new Error('Modulo API nao carregado');
        }

        const resultado = await window.API.request(APPS_SCRIPT_CASOS, {
          action: 'listarSystemUpdates',
          limit: 100,
          offset: 0
        });

        if (resultado.success && resultado.updates) {
          let updates = resultado.updates;

          // Aplicar filtro se necessario
          if (filtroTipo) {
            updates = updates.filter(u => u.tipo_acao === filtroTipo);
          }

          if (updates.length === 0) {
            container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <p>Nenhuma atualizacao encontrada</p>
              </div>
      `;
            return;
          }

          let html = '';
          updates.forEach(update => {
            const data = formatarDataHoraSystemUpdate(update.created_at);
            const corTipo = getCorTipoAcao(update.tipo_acao);
            const icone = getIconeTipoAcao(update.tipo_acao);

            html += `
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                <div class="flex justify-between items-start mb-2 flex-wrap gap-2">
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${corTipo}">
                    ${icone} ${update.tipo_acao || 'N/A'}
                  </span>
                  <span class="text-sm text-gray-500">${data}</span>
                </div>
                <p class="text-gray-800 font-medium mb-1">${update.resumo || 'Sem resumo'}</p>
                <p class="text-sm text-gray-600">
                  <strong>Tabela:</strong> ${update.tabela_afetada || 'N/A'} |
                  <strong>Autor:</strong> ${update.autor_nome || update.autor_email || 'Sistema'}
                </p>
              </div>
      `;
          });

          container.innerHTML = html;
        } else {
          container.innerHTML = `
      <div class="text-center py-8 text-red-500">
        <p>Erro ao carregar: ${resultado.error || 'Erro desconhecido'}</p>
            </div>
      `;
        }
      } catch (error) {
        console.error('[carregarSystemUpdates] Erro:', error);
        container.innerHTML = `
      <div class="text-center py-8 text-red-500">
        <p>Erro: ${error.message}</p>
          </div>
      `;
      }
    }

    function getCorTipoAcao(tipo) {
      const t = (tipo || '').toUpperCase();
      const cores = {
        'CRIACAO': 'bg-green-100 text-green-800 border border-green-300',
        'INSERT': 'bg-green-100 text-green-800 border border-green-300',

        'EDICAO': 'bg-blue-100 text-blue-800 border border-blue-300',
        'UPDATE': 'bg-blue-100 text-blue-800 border-blue-300',

        'EXCLUSAO': 'bg-red-100 text-red-800 border border-red-300',
        'DELETE': 'bg-red-100 text-red-800 border border-red-300',

        'LOGIN': 'bg-purple-100 text-purple-800 border border-purple-300'
      };
      return cores[t] || 'bg-gray-100 text-gray-800 border border-gray-300';
    }

    function getIconeTipoAcao(tipo) {
      const t = (tipo || '').toUpperCase();
      const icones = {
        'CRIACAO': '➕',
        'INSERT': '➕',

        'EDICAO': '✏️',
        'UPDATE': '✏️',

        'EXCLUSAO': '🗑️',
        'DELETE': '🗑️',

        'LOGIN': '🔐'
      };
      return icones[t] || '📝';
    }

    function formatarDataHoraSystemUpdate(isoString) {
      if (!isoString) return 'Data desconhecida';
      const data = new Date(isoString);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      const hora = String(data.getHours()).padStart(2, '0');
      const min = String(data.getMinutes()).padStart(2, '0');
      return `${dia} /${mes}/${ano} ${hora}:${min}`;
    }

    // Fechar modal ao clicar fora
    document.addEventListener('click', function (e) {
      const modal = document.getElementById('modal-system-updates');
      if (e.target === modal) {
        fecharModalSystemUpdates();
      }
    });
    // ========================================
    // VERIFICAR PARÂMETRO COM ID PARA EDIÇÃO DIRETA
    // ========================================
    function verificarParametroEditar() {
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('editar');

      if (!editId) return;

      console.log('[verificarParametroEditar] Verificando parâmetro de edição:', editId);

      if (!registrosCache || registrosCache.length === 0) {
        console.log('[verificarParametroEditar] Cache vazio, aguardando carregamento...');
        return;
      }

      // Procura o registro pelo ID da notificação
      // Nota: idNotificacao no registro pode ser número ou string
      const registro = registrosCache.find(r =>
        String(r.idNotificacao) === String(editId)
      );

      if (registro) {
        console.log('[verificarParametroEditar] Registro encontrado (linha ' + registro.linha + '), abrindo edição...');

        // Pequeno delay para garantir que UI esteja pronta
        setTimeout(() => {
          abrirEdicao(registro.linha);

          // Se for técnico, remove o overlay de carregamento se existir
          const loadingOverlay = document.getElementById('loading-overlay-tecnico');
          if (loadingOverlay) {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.remove(), 500);
          }
        }, 300);
      } else {
        console.warn('[verificarParametroEditar] Registro não encontrado para ID:', editId);

        // Se for técnico e não achou o registro, avisa e volta
        const userRole = sessionStorage.getItem('userRole');
        if (userRole === 'tecnico') {
          // Verifica se é porque a lista ainda está filtrada (embora registrosCache deva ter tudo)
          // Se realmente não achou, alerta.
          alert('Registro não encontrado ou você não tem permissão para editá-lo.');
          window.location.href = 'minhas-notificacoes.html';
        }
      }
    }

    // Expoe globalmente
    window.verificarParametroEditar = verificarParametroEditar;
  </script>

  <!-- Scripts para gerenciamento de anexos -->
  <script src="assets/js/utils/api.js"></script>
  <script src="assets/js/modules/anexos-handler.js"></script>
  <script src="assets/js/modules/atualizacoes-notificacoes.js"></script>

  <!-- Sistema de Painel para Filtros Avançados -->
  <script>
    (function () {
      const DURATION_OPEN = 360;
      const DURATION_CLOSE = 280;
      const easingOpen = "cubic-bezier(0.16, 1, 0.3, 1)";
      const easingClose = "cubic-bezier(0.4, 0, 0.2, 1)";

      const raf = () => new Promise((r) => requestAnimationFrame(r));

      function initFilterAccordion(details) {
        const summary = details.querySelector("summary");
        const content = details.querySelector(".filter-group-content");
        if (!summary || !content) return;

        // Guarda referência fixa ao conteúdo para o modo painel
        details.__panelContent = content;
        content.__panelOwner = details;

        // Modo painel: não expande inline; clique abre o advancedPanel abaixo
        if ((details.dataset.mode || '') === 'panel') {
          details.open = false;
          details.dataset.expanded = 'false';
          content.style.overflow = 'hidden';
          content.style.height = '';

          summary.addEventListener('click', (e) => {
            e.preventDefault();
            openFilterPanel(details);
          });
          return;
        }
      }

      function openFilterPanel(details) {
        const panel = document.getElementById('advancedPanel');
        const host = document.getElementById('advancedPanelContent');
        const content = details.__panelContent || details.querySelector('.filter-group-content');
        if (!panel || !host || !content) return;

        // Lock para evitar cliques durante animação
        if (host.__swapLock) {
          host.__queuedDetails = details;
          return;
        }

        const active = details.classList.contains('is-active');

        const ensureFiltersVisible = () => {
          const filtersGrid = document.querySelector('.filters-grid');
          if (!filtersGrid) return;
          setTimeout(() => {
            filtersGrid.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
          }, 50);
        };

        const centerSelectedCard = () => {
          const summary = details.querySelector('summary') || details;
          summary.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        };

        // Animação RÁPIDA para troca entre filtros
        const animateSwap = (fn) => {
          host.__swapLock = true;
          host.classList.remove('is-entering');
          host.classList.remove('is-leaving-slow');
          host.classList.add('is-leaving');

          setTimeout(() => {
            fn();
            host.classList.remove('is-leaving');
            host.classList.add('is-entering');
            ensureFiltersVisible();

            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                host.classList.remove('is-entering');
                host.__swapLock = false;

                if (host.__queuedDetails) {
                  const next = host.__queuedDetails;
                  host.__queuedDetails = null;
                  setTimeout(() => openFilterPanel(next), 0);
                }
              });
            });
          }, 200);
        };

        // Animação LENTA para fechamento
        const animateClose = (fn) => {
          host.__swapLock = true;
          setTimeout(() => {
            host.classList.remove('is-entering');
            host.classList.remove('is-leaving');
            host.classList.add('is-leaving-slow');

            setTimeout(() => {
              fn();
              host.classList.remove('is-leaving-slow');
              host.__swapLock = false;
            }, 400);
          }, 300);
        };

        const restoreActive = () => {
          const prevContent = host.querySelector('.filter-group-content');
          const prevOwner = prevContent ? prevContent.__panelOwner : null;
          if (prevOwner) {
            prevOwner.classList.remove('is-active');
            prevOwner.dataset.expanded = 'false';
          }
          if (prevContent && prevContent.__panelPlaceholder) {
            prevContent.__panelPlaceholder.replaceWith(prevContent);
            prevContent.__panelPlaceholder = null;
          }
        };

        // Se clicou no mesmo, fecha painel
        if (active) {
          centerSelectedCard();
          animateClose(() => {
            restoreActive();
            host.innerHTML = '';
            panel.classList.remove('open');
          });
          return;
        }

        // Troca de filtro: Animação RÁPIDA
        animateSwap(() => {
          restoreActive();
          host.innerHTML = '';
          const placeholder = document.createComment('filter-group-content-placeholder');
          content.parentNode.insertBefore(placeholder, content);
          content.__panelPlaceholder = placeholder;
          host.appendChild(content);

          details.classList.add('is-active');
          details.dataset.expanded = 'true';
          panel.classList.add('open');
        });
      }

      function closeFilterPanel() {
        const panel = document.getElementById('advancedPanel');
        const host = document.getElementById('advancedPanelContent');
        if (!panel || !host) return;
        if (!panel.classList.contains('open')) return;

        host.classList.remove('is-entering');
        host.classList.remove('is-leaving');
        host.classList.add('is-leaving-slow');

        setTimeout(() => {
          const prevContent = host.querySelector('.filter-group-content');
          const prevOwner = prevContent ? prevContent.__panelOwner : null;

          if (prevOwner) {
            prevOwner.classList.remove('is-active');
            prevOwner.dataset.expanded = 'false';
          }

          if (prevContent && prevContent.__panelPlaceholder) {
            prevContent.__panelPlaceholder.replaceWith(prevContent);
            prevContent.__panelPlaceholder = null;
          }

          host.innerHTML = '';
          panel.classList.remove('open');
          host.classList.remove('is-leaving-slow');
        }, 450);
      }

      function bootFilterAccordions() {
        document.querySelectorAll("details.filter-group[data-mode='panel']").forEach(initFilterAccordion);
      }

      // Expoe globalmente
      window.openFilterPanel = openFilterPanel;
      window.closeFilterPanel = closeFilterPanel;

      // Inicializa quando o DOM estiver pronto
      document.addEventListener("DOMContentLoaded", bootFilterAccordions);
    })();
  </script>

  <!-- Intro.js - Sistema de Onboarding -->
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <script src="assets/js/utils/onboarding.js"></script>
  <script>
    // Inicializar onboarding após carregamento completo da página
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function () {
        if (window.NAAMOnboarding) {
          NAAMOnboarding.init('gerenciar-casos');
        }
      }, 2000);
    });
  </script>

  <!-- Inicialização de Eventos de Edição -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Configura listeners para os componentes do modal de edição
      if (typeof configurarEventosInstituicaoEdit === 'function') configurarEventosInstituicaoEdit();
      if (typeof configurarEventosTipoViolenciaEdit === 'function') configurarEventosTipoViolenciaEdit();
      if (typeof configurarEventosTipoViolenciaInstitucionalEdit === 'function') configurarEventosTipoViolenciaInstitucionalEdit();
    });
  </script>
</body>

</html>