<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Casos - Viol√™ncia Escolar</title>

  <!-- Esconde conte√∫do IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }

    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>

  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Flatpickr - Date Picker Elegante -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/light.css">

  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">

  <!-- Intro.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
  <!-- Onboarding CSS -->
  <link rel="stylesheet" href="assets/css/onboarding.css">

  <!-- Estilos para Sistema de Anexos -->
  <link rel="stylesheet" href="assets/css/anexos.css">

  <!-- Estilos para Sistema de Atualiza√ß√µes -->
  <link rel="stylesheet" href="assets/css/atualizacoes.css">

  <!-- Configura√ß√£o Centralizada -->
  <script src="config.js"></script>
  <script src="assets/js/utils/config-loader.js"></script>

  <!-- Sistema de Transi√ß√µes entre P√°ginas -->
  <script src="assets/js/utils/page-transitions.js"></script>

  <!-- Sistema de Loading Indicator Elegante -->
  <script src="assets/js/utils/loading-indicator.js"></script>

  <!-- Sistema de Navega√ß√£o por Perfil -->
  <script src="assets/js/utils/navigation.js"></script>

  <!-- Sistema de Escolas por T√©cnico -->
  <script src="assets/js/utils/escolas-tecnico.js"></script>

  <!-- Flatpickr - Date Picker Script -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

  <script>
    // Verifica acesso usando o sistema de navegacao por perfil
    // Permitido: estagiario, user, tecnico
    document.addEventListener('DOMContentLoaded', function () {
      if (window.NAVMNavigation) {
        // Verifica acesso e renderiza menus
        if (!window.NAVMNavigation.verificarAcesso(['estagiario', 'user', 'tecnico', 'superuser'])) {
          return; // Sera redirecionado
        }
        window.NAVMNavigation.renderMenus();
      } else {
        // Fallback caso navigation.js nao carregue
        const role = sessionStorage.getItem('userRole');
        if (!role) {
          window.location.href = 'index.html';
          return;
        }
        if (!['estagiario', 'user', 'tecnico', 'superuser'].includes(role)) {
          alert('Voce nao tem permissao para acessar esta pagina.');
          window.location.href = 'painel-casos.html';
        }
      }
    });
  </script>

  <style>
    /* ============================================= */
    /* TOKENS DE MOTION - PADRONIZA√á√ÉO GLOBAL */
    /* ============================================= */
    :root {
      --motion-fast: 0.2s ease-in-out;
      --motion-medium: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      --motion-slow: 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      --motion-enter-delay: 0.08s;
    }

    /* ============================================= */
    /* SCROLL SUAVE E OTIMIZADO */
    /* ============================================= */
    * {
      scroll-behavior: smooth;
    }

    html {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    body {
      scroll-behavior: smooth;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Melhora performance do scroll */
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .field-error {
      border-color: #ef4444 !important;
      background-color: #fee2e2 !important;
    }

    #alertContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 500px;
      width: calc(100% - 40px);
    }

    .alert {
      animation: alertSlideIn var(--motion-medium);
      transition: all var(--motion-fast);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .alert.alert-removing {
      animation: alertSlideOut var(--motion-fast) forwards;
    }

    @keyframes alertSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes alertSlideOut {
      from {
        opacity: 1;
        transform: translateX(0);
        max-height: 200px;
        margin-bottom: 1rem;
      }

      to {
        opacity: 0;
        transform: translateX(100%);
        max-height: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
      }
    }

    /* Anima√ß√£o suave para progressIndicator */
    #progressIndicator {
      transition: all var(--motion-slow);
      transform-origin: top center;
    }

    #progressIndicator.hidden {
      opacity: 0;
      transform: translateY(-20px);
      max-height: 0;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden;
    }

    #progressIndicator:not(.hidden) {
      animation: progressSlideIn var(--motion-slow);
    }

    @keyframes progressSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
      }

      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px;
      }
    }

    /* Estilos para Autocomplete */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.75rem 0.75rem;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .autocomplete-list.show {
      display: block;
    }

    /* Estilos para Sugest√µes de Crian√ßa */
    #criancaEstudante-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom, #ffffff 0%, #f9fafb 100%);
      border: 1px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 0 0 0.75rem 0.75rem;
      max-height: 320px;
      overflow-y: auto;
      z-index: 1100;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      display: none;
      margin-top: 2px;
    }

    #criancaEstudante-suggestions:not(.hidden) {
      display: block;
      animation: slideDownSuggestionsChild var(--motion-fast);
    }

    @keyframes slideDownSuggestionsChild {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #criancaEstudante-suggestions.closing {
      animation: slideUpSuggestions var(--motion-fast) forwards;
    }

    /* Estilos e anima√ß√µes para modal de sugest√µes PCD */
    #pcdDetalhes-suggestions {
      transition: opacity 0.35s ease-out, transform 0.35s ease-out;
      transform-origin: top center;
    }

    #pcdDetalhes-suggestions:not(.hidden) {
      animation: slideDownSuggestions 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    #pcdDetalhes-suggestions.closing {
      animation: slideUpSuggestions 0.35s cubic-bezier(0.4, 0, 1, 1) forwards;
    }

    @keyframes slideDownSuggestions {
      from {
        opacity: 0;
        transform: translateY(-12px) scaleY(0.92);
      }

      to {
        opacity: 1;
        transform: translateY(0) scaleY(1);
      }
    }

    @keyframes slideUpSuggestions {
      from {
        opacity: 1;
        transform: translateY(0) scaleY(1);
      }

      to {
        opacity: 0;
        transform: translateY(-12px) scaleY(0.92);
      }
    }

    /* Anima√ß√£o gen√©rica de expans√£o de conte√∫do */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Anima√ß√£o fade-in para notifica√ß√µes */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    #criancaEstudante-suggestions>div {
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: all var(--motion-fast);
      font-size: 14px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #criancaEstudante-suggestions>div:before {
      content: "üëß";
      font-size: 16px;
      flex-shrink: 0;
    }

    #criancaEstudante-suggestions>div:hover {
      background: linear-gradient(to right, #dbeafe 0%, #eff6ff 100%);
      color: #1e40af;
      padding-left: 20px;
      border-left: 3px solid #3b82f6;
      padding-left: 13px;
    }

    /* Anima√ß√£o do bloco condicional "Ocorreu na escola" */
    #ocorreu-escola-wrapper {
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
      overflow: hidden;
      pointer-events: none;
      margin-top: -0.25rem !important;
      margin-bottom: -0.25rem !important;
      transition: max-height var(--motion-medium), opacity var(--motion-fast), transform var(--motion-fast), margin var(--motion-fast);
      border: 1px dashed transparent;
      padding: 0 !important;
      box-shadow: none !important;
    }

    #ocorreu-escola-wrapper.is-visible {
      max-height: 800px;
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
      margin-top: 0.25rem !important;
      margin-bottom: 1rem !important;
      border-color: #c084fc;
      box-shadow: 0 10px 25px -12px rgba(124, 58, 237, 0.35);
      padding: 1rem !important;
    }

    .conditional-hint {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #c7d2fe;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .conditional-hint .dot {
      width: 8px;
      height: 8px;
      border-radius: 9999px;
      background: #a855f7;
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.12);
    }

    /* Badge de ajuda/tooltip nas perguntas complementares */
    .info-tooltip-wrapper {
      position: relative;
      display: inline-block;
      vertical-align: middle;
    }

    .info-tip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 6px;
      border-radius: 9999px;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #c7d2fe;
      font-size: 11px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      transition: all var(--motion-fast);
      user-select: none;
    }

    .info-tip:hover {
      background: #e0e7ff;
      color: #312e81;
      box-shadow: 0 2px 8px -4px rgba(79, 70, 229, 0.55);
      transform: scale(1.1);
    }

    .info-tip:active {
      transform: scale(0.95);
    }

    .info-tooltip-content {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(8px);
      min-width: 220px;
      max-width: 280px;
      background: linear-gradient(135deg, #f1f6ff 0%, #e0f0ff 100%);
      backdrop-filter: blur(12px) saturate(180%);
      border: 1.5px solid rgba(99, 102, 241, 0.2);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 0 30px rgba(79, 70, 229, 0.12), 0 10px 25px -5px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--motion-medium);
      pointer-events: none;
    }

    .info-tooltip-content::before {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 12px;
      height: 12px;
      background: linear-gradient(135deg, #f1f6ff, #e0f0ff);
      border: 0.75px solid rgba(99, 102, 241, 0.2);
      border-radius: 2px;
    }

    .info-tooltip-content::after {
      content: '';
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 15px solid transparent;
    }

    .info-tooltip-wrapper:hover .info-tooltip-content {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-8px);
      pointer-events: auto;
    }

    .info-tooltip-content p {
      margin: 0;
      font-size: 13px;
      line-height: 1.6;
      color: #1f2933;
      letter-spacing: 0.3px;
    }

    .info-tooltip-content strong {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #1d4ed8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .info-tooltip-content strong::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #3b82f6;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
      flex-shrink: 0;
    }

    .tooltip-highlight {
      color: #8b5cf6;
      font-weight: 500;
    }

    /* CSS ESPEC√çFICO PARA TOOLTIP DO CAMPO CONDICIONAL "Ocorreu na escola?" */
    /* Permite que o tooltip extrapole as bordas dos containers pai */
    #ocorreu-escola-wrapper {
      overflow: visible !important;
    }

    #ocorreu-escola-wrapper .info-tooltip-wrapper {
      overflow: visible !important;
    }

    /* Ajuste responsivo para telas pequenas */
    @media (max-width: 640px) {
      .info-tooltip-content {
        left: auto;
        right: -10px;
        transform: translateX(0) translateY(10px) scale(0.95);
        min-width: 200px;
        max-width: 250px;
        backdrop-filter: blur(10px) saturate(180%);
      }

      .info-tooltip-content::before {
        right: 16px;
        left: auto;
      }

      .info-tooltip-wrapper:hover .info-tooltip-content {
        transform: translateX(0) translateY(0) scale(1);
      }
    }

    #criancaEstudante-suggestions>div:last-child {
      border-bottom: none;
    }

    #criancaEstudante-suggestions>div.text-center {
      padding: 20px 16px;
      text-align: center;
      color: #9ca3af;
      cursor: default;
    }

    #criancaEstudante-suggestions>div.text-center:before {
      content: "";
    }

    #criancaEstudante-suggestions::-webkit-scrollbar {
      width: 6px;
    }

    #criancaEstudante-suggestions::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    #criancaEstudante-suggestions::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    #criancaEstudante-suggestions::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all var(--motion-fast);
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
      background-color: #eff6ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    /* Anima√ß√£o de sa√≠da para tags */
    @keyframes tagRemove {
      0% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        opacity: 0;
        transform: scale(0.8);
      }
    }

    .tag-removing {
      animation: tagRemove 0.3s ease-out forwards;
      pointer-events: none;
    }

    .autocomplete-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .autocomplete-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .autocomplete-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .autocomplete-nome {
      font-size: 14px;
      color: #374151;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .autocomplete-list::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-list::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .autocomplete-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .autocomplete-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Estilos para Select Customizado */
    .custom-select-wrapper {
      position: relative;
    }

    .custom-select-trigger {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .custom-select-trigger::after {
      content: '‚ñº';
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #6b7280;
      transition: transform var(--motion-fast);
      pointer-events: none;
    }

    .custom-select-trigger.open::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .custom-select-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      max-height: 280px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
      display: none;
      animation: dropdownSlide var(--motion-fast);
    }

    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-select-dropdown.show {
      display: block;
    }

    .custom-select-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all var(--motion-fast);
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
      color: #374151;
    }

    .custom-select-option:last-child {
      border-bottom: none;
    }

    .custom-select-option:hover {
      background-color: #f3f4f6;
    }

    .custom-select-option.selected {
      background-color: #eff6ff;
      color: #1e40af;
      font-weight: 600;
    }

    .custom-select-option.selected::before {
      content: '‚úì ';
      margin-right: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .custom-select-dropdown::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Esconder select nativo mas manter funcionalidade */
    .custom-select-wrapper select {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Estilos para Date Input Customizado */
    input[type="date"] {
      position: relative;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 42px;
      color: #374151;
      font-family: inherit;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 0;
      left: 0;
      top: 0;
      bottom: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      opacity: 0;
      z-index: 10;
    }

    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
      -webkit-appearance: none;
    }

    input[type="date"]::-webkit-datetime-edit {
      padding: 0;
      color: #374151;
    }

    /* ============================================= */
    /* FLATPICKR DATE PICKER - ESTILO CUSTOMIZADO */
    /* ============================================= */

    /* Input com √≠cone de calend√°rio */
    .flatpickr-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 45px !important;
      cursor: pointer;
    }

    .flatpickr-input:focus {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    }

    /* Calend√°rio popup */
    .flatpickr-calendar {
      background: white;
      border: 1.5px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      padding: 16px;
      width: 360px !important;
    }

    .flatpickr-calendar.arrowTop:before,
    .flatpickr-calendar.arrowTop:after {
      border-bottom-color: white;
    }

    /* Meses */
    .flatpickr-months {
      padding: 12px 0;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .flatpickr-month {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .flatpickr-current-month {
      font-size: 17px;
      font-weight: 600;
      color: #1f2937;
      padding: 8px 12px;
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: static !important;
      width: auto !important;
      left: auto !important;
      transform: none !important;
    }

    .flatpickr-current-month input.cur-year {
      font-weight: 600;
      color: #1f2937;
      padding: 4px 8px;
      width: 70px !important;
      text-align: center;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months {
      padding: 4px 8px;
      font-weight: 600;
      color: #1f2937;
      background: transparent;
      appearance: none;
      text-align: center;
    }

    /* Setas de navega√ß√£o */
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      padding: 10px;
      fill: #6b7280;
      transition: all var(--motion-fast);
      position: absolute !important;
      width: 36px !important;
      height: 36px !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 8px;
    }

    .flatpickr-months .flatpickr-prev-month {
      left: 0;
    }

    .flatpickr-months .flatpickr-next-month {
      right: 0;
    }

    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
      width: 18px !important;
      height: 18px !important;
    }

    .flatpickr-months .flatpickr-prev-month:hover,
    .flatpickr-months .flatpickr-next-month:hover {
      fill: #3b82f6;
      background: #eff6ff;
    }

    /* Dias da semana */
    .flatpickr-weekdays {
      height: 40px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      width: 100%;
    }

    .flatpickr-weekday {
      color: #6b7280;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex: 1;
      text-align: center;
    }

    /* Dias do m√™s */
    .flatpickr-days {
      border: none;
      width: 100% !important;
    }

    .dayContainer {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
    }

    .flatpickr-day {
      border-radius: 10px;
      margin: 3px;
      color: #374151;
      font-weight: 500;
      transition: all var(--motion-fast);
      height: 40px !important;
      line-height: 40px !important;
      flex-basis: calc(14.2857% - 6px) !important;
      max-width: calc(14.2857% - 6px) !important;
    }

    .flatpickr-day:hover {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1e40af;
      transform: scale(1.05);
    }

    /* Dia selecionado */
    .flatpickr-day.selected,
    .flatpickr-day.selected:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transform: scale(1.05);
    }

    /* Dia de hoje */
    .flatpickr-day.today {
      border: 2px solid #3b82f6;
      color: #1e40af;
      font-weight: 600;
    }

    .flatpickr-day.today:hover {
      background: #eff6ff;
      border-color: #3b82f6;
    }

    /* Dias desabilitados */
    .flatpickr-day.disabled,
    .flatpickr-day.disabled:hover {
      color: #d1d5db;
      cursor: not-allowed;
    }

    /* Dias de outros meses */
    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
      color: #d1d5db;
    }

    /* ============================================= */
    /* ALERT DIALOG - CONFIRMA√á√ÉO */
    /* ============================================= */

    /* Overlay de fundo */
    .alert-dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(99, 102, 241, 0.1);
      backdrop-filter: blur(8px) saturate(180%);
      z-index: 50;
      display: none;
      animation: overlayShow var(--motion-fast);
    }

    .alert-dialog-overlay.show {
      display: block;
    }

    .alert-dialog-overlay.hide {
      animation: overlayHide var(--motion-fast) forwards;
    }

    @keyframes overlayShow {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes overlayHide {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Container do di√°logo */
    .alert-dialog-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.98) translateY(16px);
      background: linear-gradient(to bottom, #ffffff 0%, #fefeff 100%);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 24px;
      padding: 32px;
      width: 90%;
      max-width: 480px;
      z-index: 51;
      box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.1),
        0 10px 10px -5px rgba(0, 0, 0, 0.04),
        0 0 0 1px rgba(255, 255, 255, 0.5) inset;
      display: none;
      animation: contentShow var(--motion-medium);
    }

    .alert-dialog-content.show {
      display: block;
      transform: translate(-50%, -50%) scale(1) translateY(0);
    }

    .alert-dialog-content.hide {
      animation: contentHide var(--motion-fast) forwards;
    }

    @keyframes contentShow {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.98) translateY(16px);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) translateY(0);
      }
    }

    @keyframes contentHide {
      from {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) translateY(0);
      }

      to {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.98) translateY(8px);
      }
    }

    /* √çcone do di√°logo */
    .alert-dialog-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #fee2e2 0%, #fef3c7 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 12px -2px rgba(251, 146, 60, 0.2),
        0 0 0 1px rgba(251, 146, 60, 0.1) inset;
      animation: iconBounce var(--motion-medium) cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s;
    }

    @keyframes iconBounce {
      0% {
        transform: scale(0.95) translateY(8px);
        opacity: 0;
      }

      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    /* Header do di√°logo */
    .alert-dialog-header {
      margin-bottom: 20px;
      text-align: center;
    }

    .alert-dialog-title {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 12px 0;
      line-height: 1.4;
    }

    .alert-dialog-description {
      font-size: 15px;
      color: #6b7280;
      line-height: 1.7;
      margin: 0;
    }

    /* Footer com bot√µes */
    .alert-dialog-footer {
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      margin-top: 28px;
    }

    @media (min-width: 640px) {
      .alert-dialog-footer {
        flex-direction: row;
        justify-content: center;
        gap: 16px;
      }
    }

    /* Bot√µes do di√°logo */
    .alert-dialog-cancel,
    .alert-dialog-action {
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      outline: none;
      position: relative;
      overflow: hidden;
    }

    .alert-dialog-cancel {
      background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
      color: #4b5563;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .alert-dialog-cancel:hover {
      background: linear-gradient(to bottom, #f3f4f6 0%, #e5e7eb 100%);
      border-color: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1);
    }

    .alert-dialog-cancel:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .alert-dialog-action {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      color: white;
      box-shadow: 0 4px 12px -2px rgba(251, 146, 60, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
    }

    .alert-dialog-action:hover {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      box-shadow: 0 6px 16px -2px rgba(251, 146, 60, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.3) inset;
      transform: translateY(-2px);
    }

    .alert-dialog-action:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px -2px rgba(251, 146, 60, 0.4);
    }

    /* Estilos do Modal de Confirma√ß√£o de Registro */
    #resumoRegistro .resumo-item {
      display: flex;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    #resumoRegistro .resumo-item:last-child {
      border-bottom: none;
    }

    #resumoRegistro .resumo-label {
      font-weight: 600;
      color: #374151;
      min-width: 140px;
      flex-shrink: 0;
    }

    #resumoRegistro .resumo-valor {
      color: #6b7280;
      word-break: break-word;
    }

    #btnConfirmarEnvio {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.4);
    }

    #btnConfirmarEnvio:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      box-shadow: 0 6px 16px -2px rgba(5, 150, 105, 0.5);
    }

    input[type="date"]::-webkit-datetime-edit-text {
      color: #6b7280;
      padding: 0 2px;
    }

    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field {
      padding: 2px 4px;
      border-radius: 4px;
      color: #374151;
    }

    input[type="date"]::-webkit-datetime-edit-month-field:focus,
    input[type="date"]::-webkit-datetime-edit-day-field:focus,
    input[type="date"]::-webkit-datetime-edit-year-field:focus {
      background-color: #dbeafe;
      color: #1e40af;
      outline: none;
    }

    input[type="date"]:hover {
      border-color: #9ca3af;
    }

    input[type="date"]:focus {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    }

    /* Estiliza√ß√£o do popup do calend√°rio */
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      cursor: pointer;
      background: transparent;
    }

    /* Firefox */
    input[type="date"]::-moz-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0;
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }

      .desktop-menu {
        display: none !important;
      }

      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {

      button,
      a,
      input,
      select,
      textarea {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* ============================================= */
    /* ANIMA√á√ïES DOS BOT√ïES DE R√ÅDIO COMPLEMENTARES */
    /* ============================================= */

    /* Estilo base para a label dos radio buttons */
    label.relative.flex.items-center.cursor-pointer {
      position: relative;
      overflow: visible;
    }

    /* Pseudo-elemento para anima√ß√£o de fundo */
    label.relative.flex.items-center.cursor-pointer::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      z-index: -1;
      transition: all var(--motion-medium) cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border-radius: 8px;
      background-color: transparent;
      border: 2px solid transparent;
    }

    /* Efeito hover */
    label.relative.flex.items-center.cursor-pointer:hover::before {
      transition: all var(--motion-fast);
      background-color: rgba(79, 70, 229, 0.05);
    }

    /* Input radio oculto */
    label.relative.flex.items-center.cursor-pointer input[type="radio"] {
      position: relative;
    }

    /* Anima√ß√£o quando o radio √© selecionado */
    label.relative.flex.items-center.cursor-pointer input[type="radio"]:checked+div {
      animation: pulse var(--motion-slow) forwards;
    }

    /* Keyframe da anima√ß√£o de pulse - apenas sombra, sem scale */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.5);
        opacity: 1;
      }

      70% {
        box-shadow: 0 0 0 8px rgba(79, 70, 229, 0);
        opacity: 0.8;
      }

      100% {
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
        opacity: 1;
      }
    }

    /* Aprimoramento das transi√ß√µes existentes */
    label.relative.flex.items-center.cursor-pointer div {
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
    }

    /* Efeito de escala ao hover */
    label.relative.flex.items-center.cursor-pointer:hover div {
      transition: all 0.2s ease;
    }

    /* Estado selecionado com anima√ß√£o */
    label.relative.flex.items-center.cursor-pointer input[type="radio"]:checked+div {
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
    }

    /* ============================================= */
    /* ANIMA√á√ïES DOS INPUT BOXES (Floating Label) */
    /* ============================================= */

    /* Estilo base para input com anima√ß√£o floating label */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
      position: relative;
      transition: all var(--motion-medium) cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* Input focus com efeito visual */
    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus,
    input[type="tel"]:focus,
    textarea:focus,
    select:focus {
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1),
        0 4px 12px rgba(99, 102, 241, 0.15) !important;
      outline: none;
    }

    /* Label com transi√ß√£o suave */
    label {
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
    }

    /* Efeito ao sair do focus (v√°lido/com valor) */
    input[type="text"]:not(:placeholder-shown),
    input[type="date"]:not(:placeholder-shown),
    input[type="number"]:not(:placeholder-shown),
    input[type="email"]:not(:placeholder-shown),
    input[type="tel"]:not(:placeholder-shown),
    textarea:not(:placeholder-shown),
    select:not([value=""]),
    select:not([value]) {
      border-bottom-color: #6366f1 !important;
    }

    /* Input readonly sem anima√ß√£o de focus */
    input[readonly] {
      cursor: not-allowed !important;
      opacity: 0.85;
    }

    input[readonly]:focus {
      box-shadow: none !important;
      border-color: #d1d5db !important;
    }

    /* Efeito de borda animado no input */
    input[type="text"]:focus::before,
    input[type="date"]:focus::before,
    input[type="number"]:focus::before,
    input[type="email"]:focus::before,
    input[type="tel"]:focus::before,
    textarea:focus::before,
    select:focus::before {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(to right, #6366f1, #a855f7);
      animation: expandBorder var(--motion-medium) cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    @keyframes expandBorder {
      0% {
        width: 0;
        left: 50%;
        opacity: 0.6;
      }

      50% {
        left: 0;
        opacity: 0.8;
      }

      100% {
        width: 100%;
        left: 0;
        opacity: 1;
      }
    }

    /* Transi√ß√£o suave de cores no placeholder */
    input[type="text"]::placeholder,
    input[type="date"]::placeholder,
    input[type="number"]::placeholder,
    input[type="email"]::placeholder,
    input[type="tel"]::placeholder,
    textarea::placeholder {
      color: #d1d5db;
      transition: color var(--motion-fast);
    }

    input[type="text"]:focus::placeholder,
    input[type="date"]:focus::placeholder,
    input[type="number"]:focus::placeholder,
    input[type="email"]:focus::placeholder,
    input[type="tel"]:focus::placeholder,
    textarea:focus::placeholder {
      color: #a5b4fc;
    }

    /* Anima√ß√£o de escala sutil no label */
    label {
      user-select: none;
    }

    /* Input text animado com sugest√µes */
    .autocomplete-wrapper input:focus,
    .relative input:focus {
      animation: inputPulse var(--motion-medium) ease-out;
    }

    @keyframes inputPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.5);
        opacity: 1;
      }

      70% {
        box-shadow: 0 0 0 5px rgba(99, 102, 241, 0);
        opacity: 0.85;
      }

      100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        opacity: 1;
      }
    }

    /* Transi√ß√£o ao preencher campo */
    input[type="text"]:valid,
    input[type="date"]:valid,
    input[type="number"]:valid,
    input[type="email"]:valid,
    input[type="tel"]:valid {
      border-bottom-color: #10b981 !important;
    }

    /* Estado disabled */
    input:disabled,
    select:disabled,
    textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #f9fafb !important;
    }

    /* Transi√ß√£o suave no select */
    select {
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
    }

    select:focus {
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1),
        0 4px 12px rgba(99, 102, 241, 0.15) !important;
    }

    /* Textarea com efeito de expans√£o */
    textarea:focus {
      resize: vertical;
    }

    textarea {
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
    }
  </style>

  <!-- Intro.js - Sistema de Onboarding -->
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <link rel="stylesheet" href="assets/css/onboarding.css">
  <script>
    window.addEventListener('load', function () {
      // For√ßa o scroll para o topo ao carregar a p√°gina
      window.scrollTo(0, 0);

      // Tenta novamente ap√≥s um breve delay para garantir
      setTimeout(() => window.scrollTo(0, 0), 10);
      setTimeout(() => window.scrollTo(0, 0), 100);
    });
  </script>
</head>

<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen py-10 px-4">

  <!-- Container Principal -->
  <div class="max-w-5xl mx-auto">

    <!-- Menu de Navega√ß√£o -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
      <div class="px-4 py-3">
        <!-- Bot√£o Hamburguer (Mobile) -->
        <button onclick="toggleMobileMenu()"
          class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
          <span>üì± Menu</span>
          <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>

        <!-- Menu Desktop (renderizado dinamicamente por navigation.js) -->
        <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
          <!-- Menu sera renderizado por NAVMNavigation.renderMenus() -->
        </nav>

        <!-- Menu Mobile (Dropdown) -->
        <nav id="mobileMenuNav" class="mobile-menu mt-3">
          <div class="flex flex-col gap-2">
            <!-- Menu sera renderizado por NAVMNavigation.renderMenus() -->
          </div>
        </nav>
      </div>
    </div>

    <!-- Cabe√ßalho -->
    <div
      class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl sm:rounded-2xl shadow-xl border border-white/60 backdrop-blur-sm p-4 sm:p-6 md:p-8 mb-6 sm:mb-8">
      <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-3">
        <div
          class="h-12 w-12 sm:h-14 sm:w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-2xl sm:text-3xl shadow-sm flex-shrink-0">
          üìã
        </div>
        <div class="text-center">
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 leading-tight" data-tour="header">
            Registro de Casos de Viol√™ncia Escolar
          </h1>
        </div>
      </div>
      <div class="flex flex-col items-center gap-2">
        <p class="text-center text-gray-600 text-sm sm:text-base px-2">
          Preencha todos os campos obrigat√≥rios com aten√ß√£o e cuidado
        </p>
        <div class="inline-flex items-center gap-2 bg-blue-100/50 px-3 sm:px-4 py-1.5 rounded-full">
          <span class="text-xs font-semibold text-blue-700">Sistema Interno</span>
          <span class="text-blue-400">¬∑</span>
          <span class="text-xs font-medium text-blue-600">SME Vit√≥ria</span>
        </div>
      </div>
    </div>

    <!-- √Årea de Alertas -->
    <div id="alertContainer"></div>

    <!-- Indicador de Progresso -->
    <div id="progressIndicator"
      class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 p-4 sm:p-5 mb-6 hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <span class="text-lg sm:text-xl">üìä</span>
          <div>
            <h3 class="text-sm sm:text-base font-semibold text-gray-800">Progresso do Formul√°rio</h3>
            <p class="text-xs sm:text-sm text-gray-600" id="progressText">Calculando...</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Indicador de Auto-Save -->
          <div id="indicadorRascunho" class="hidden"></div>

          <button id="btnSalvarRascunho" type="button" onclick="salvarRascunhoComFeedback()"
            class="inline-flex items-center gap-2 px-4 py-2 text-xs font-bold rounded-lg shadow-md bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white transition-all duration-200 hover:shadow-lg hover:scale-105 active:scale-95"
            title="Salvar rascunho agora">
            <span id="iconSalvarRascunho">üíæ</span>
            <span class="hidden sm:inline" id="textoSalvarRascunho">SALVAR AGORA</span>
          </button>

          <button type="button" onclick="openAlertDialogRascunho()"
            class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg shadow-sm bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-500 hover:to-gray-600 text-white transition-all duration-200 hover:shadow-md hover:scale-105 active:scale-95"
            title="Limpar rascunho salvo">
            <span>üóëÔ∏è</span>
            <span class="hidden sm:inline">Limpar</span>
          </button>

          <span id="draftStatus" class="text-xs text-gray-500 hidden">
            <span id="draftLastSave"></span>
          </span>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3 sm:h-4 overflow-hidden shadow-inner">
        <div id="progressBar"
          class="bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm"
          style="width: 0%"></div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-600">
        <span id="progressDetails"></span>
      </div>
    </div>

    <!-- Formul√°rio -->
    <form id="registroForm" data-tour="formulario"
      class="bg-white/80 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl border border-white/60 p-4 sm:p-6 md:p-8 lg:p-10 space-y-6 sm:space-y-8">

      <!-- =============================================== -->
      <!-- SE√á√ÉO 1: Dados da Crian√ßa/Estudante -->
      <!-- =============================================== -->
      <section data-tour="dados-crianca">
        <div
          class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div
              class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              üë§
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Dados da Crian√ßa/Estudante
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Preencha as informa√ß√µes b√°sicas da crian√ßa ou estudante envolvido no caso
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

            <!-- Crian√ßa/Estudante -->
            <div class="md:col-span-2">
              <label for="criancaEstudante" class="block text-sm font-semibold text-gray-700 mb-2">
                Nome da Crian√ßa/Estudante <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input type="text" id="criancaEstudante" name="criancaEstudante" required
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite o nome completo" autocomplete="off">
                <div id="criancaEstudante-suggestions"
                  class="absolute top-full left-0 right-0 bg-white border border-gray-200 border-t-0 rounded-b-lg max-h-60 overflow-y-auto z-1000 hidden shadow-md">
                </div>
              </div>

            </div>

            <!-- Data da NT -->
            <div>
              <label for="dataNT" class="block text-sm font-semibold text-gray-700 mb-2">
                Data da Notifica√ß√£o (NT) <span class="text-red-500">*</span>
              </label>
              <input type="text" id="dataNT" name="dataNT" required placeholder="Selecione a data"
                class="flatpickr-input w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                readonly>
            </div>

            <!-- Idade -->
            <div>
              <label for="idade" class="block text-sm font-semibold text-gray-700 mb-2">
                Idade <span class="text-red-500">*</span>
              </label>
              <input type="number" id="idade" name="idade" min="0" max="120" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Ex: 10">
            </div>

            <!-- Identidade de G√™nero -->
            <div>
              <label for="identidadeGenero" class="block text-sm font-semibold text-gray-700 mb-2">
                Identidade de G√™nero <span class="text-red-500">*</span>
              </label>
              <select id="identidadeGenero" name="identidadeGenero" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm">
                <option value="">Selecione...</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
                <option value="N√£o-bin√°rio">N√£o-bin√°rio</option>
                <option value="Outro">Outro</option>
              </select>
            </div>

            <!-- √â PCD/tem Transtorno? -->
            <div>
              <label for="pcdTranstorno" class="block text-sm font-semibold text-gray-700 mb-2">
                √â PCD/tem Transtorno? <span class="text-red-500">*</span>
              </label>
              <select id="pcdTranstorno" name="pcdTranstorno" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm">
                <option value="">Selecione...</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
                <option value="N√£o informado">N√£o informado</option>
              </select>
            </div>

            <!-- Detalhes da defici√™ncia/transtorno (condicional) -->
            <div id="pcdDetalhesContainer" class="md:col-span-2 hidden">
              <label for="pcdDetalhes-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Se for PCD/tem transtorno, descreva quais (diagn√≥sticos, laudos, observa√ß√µes): <span
                  class="text-red-500">*</span>
              </label>

              <!-- Container de tags -->
              <div id="pcdDetalhes-tags"
                class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>

              <!-- Input com autocomplete -->
              <div class="relative">
                <input type="text" id="pcdDetalhes-input"
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite ou selecione um transtorno/defici√™ncia..." autocomplete="off" />
                <div id="pcdDetalhes-suggestions"
                  class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                </div>
              </div>

              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="pcdDetalhes" name="pcdDetalhes" />

              <p class="text-xs text-gray-500 mt-1.5">
                Digite para buscar ou adicione um novo transtorno/defici√™ncia. Pressione Enter para adicionar.
              </p>
            </div>

            <!-- Ra√ßa/Cor -->
            <div class="md:col-span-2">
              <label for="racaCor" class="block text-sm font-semibold text-gray-700 mb-2">
                Ra√ßa/Cor <span class="text-red-500">*</span>
              </label>
              <select id="racaCor" name="racaCor" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm">
                <option value="">Selecione...</option>
                <option value="Branca">Branca</option>
                <option value="Preta">Preta</option>
                <option value="Parda">Parda</option>
                <option value="Amarela">Amarela</option>
                <option value="Ind√≠gena">Ind√≠gena</option>
                <option value="N√£o informado">N√£o informado</option>
              </select>
            </div>

            <!-- Orienta√ß√£o Sexual -->
            <div class="md:col-span-2">
              <label for="orientacaoSexual" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual a Orienta√ß√£o Sexual? <span class="text-red-500">*</span>
              </label>
              <select id="orientacaoSexual" name="orientacaoSexual" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm">
                <option value="">Selecione...</option>
                <option value="Heterossexual">Heterossexual</option>
                <option value="Homossexual">Homossexual</option>
                <option value="Bissexual">Bissexual</option>
                <option value="Outro">Outro</option>
                <option value="N√£o informado">N√£o informado</option>
              </select>
            </div>

          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- SE√á√ÉO 2: Situa√ß√£o da Viol√™ncia -->
      <!-- =============================================== -->
      <section data-tour="dados-violencia">
        <div
          class="bg-gradient-to-r from-red-50/50 to-orange-50/30 rounded-xl sm:rounded-2xl border border-red-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div
              class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-red-100 text-red-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              ‚ö†Ô∏è
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Situa√ß√£o da Viol√™ncia
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Descreva o tipo de viol√™ncia ocorrida e os encaminhamentos realizados
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 sm:gap-6">

            <!-- Tipo de Viol√™ncia -->
            <div>
              <label for="tipoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Tipo de Viol√™ncia <span class="text-red-500">*</span>
              </label>

              <!-- Container de tags -->
              <div id="tipoViolencia-tags"
                class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>

              <!-- Input com autocomplete -->
              <div class="relative">
                <input type="text" id="tipoViolencia-input"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar tipo de viol√™ncia (ex: F√≠sica)" autocomplete="off" />

                <!-- Lista de sugest√µes -->
                <div id="tipoViolencia-suggestions"
                  class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                </div>
              </div>

              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="tipoViolencia" name="tipoViolencia" required />

              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica).
              </p>
            </div>

            <!-- Tipo de Viol√™ncia Institucional (Condicional) -->
            <div id="tipoViolenciaInstitucionalContainer" class="hidden">
              <label for="tipoViolenciaInstitucional-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual o tipo da viol√™ncia institucional <span class="text-red-500">*</span>
              </label>

              <!-- Container de tags -->
              <div id="tipoViolenciaInstitucional-tags"
                class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>

              <!-- Input com autocomplete -->
              <div class="relative">
                <input type="text" id="tipoViolenciaInstitucional-input"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar tipo de viol√™ncia institucional (ex: F√≠sica, Psicol√≥gica)"
                  autocomplete="off" />

                <!-- Lista de sugest√µes -->
                <div id="tipoViolenciaInstitucional-suggestions"
                  class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                </div>
              </div>

              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="tipoViolenciaInstitucional" name="tipoViolenciaInstitucional" />

              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica). Este
                campo aparece apenas quando "Institucional" est√° selecionado no Tipo de Viol√™ncia.
              </p>
            </div>

            <!-- Encaminhamento -->
            <div>
              <label for="encaminhamento-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Encaminhamento <span class="text-red-500">*</span>
              </label>

              <!-- Container de tags -->
              <div id="encaminhamentos-tags"
                class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>

              <!-- Input com autocomplete -->
              <div class="relative">
                <input type="text" id="encaminhamento-input"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar encaminhamento (ex: Conselho Tutelar)" autocomplete="off" />

                <!-- Lista de sugest√µes -->
                <div id="encaminhamento-suggestions"
                  class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                </div>
              </div>

              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="encaminhamento" name="encaminhamento" required />

              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Clique no √ó para remover.
              </p>
            </div>

          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- SE√á√ÉO 3: Unidade e Regi√£o -->
      <!-- =============================================== -->
      <section data-tour="dados-escola">
        <div
          class="bg-gradient-to-r from-green-50/50 to-emerald-50/30 rounded-xl sm:rounded-2xl border border-green-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div
              class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-green-100 text-green-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              üè´
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Unidade e Regi√£o
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Identifique a institui√ß√£o de ensino e regi√£o onde o caso foi registrado
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

            <!-- Tipo de Institui√ß√£o -->
            <div class="md:col-span-2">
              <label for="tipoInstituicao" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual o tipo da institui√ß√£o de ensino? <span class="text-red-500">*</span>
              </label>
              <select id="tipoInstituicao" name="tipoInstituicao" required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm">
                <option value="">Selecione o tipo...</option>
                <option value="CMEI">CMEI - Centro Municipal de Educa√ß√£o Infantil</option>
                <option value="EMEF">EMEF - Escola Municipal de Ensino Fundamental</option>
              </select>
            </div>

            <!-- CMEI/EMEF com Autocomplete -->
            <div class="md:col-span-2">
              <div class="flex items-center justify-between mb-2">
                <label for="cmeiEmef" class="block text-sm font-semibold text-gray-700">
                  Institui√ß√£o de Ensino <span class="text-red-500">*</span>
                </label>
                <!-- Bot√£o Ver Todas - Apenas para t√©cnicos -->
                <div id="filtro-escolas-container" class="hidden">
                  <button type="button" id="btnVerTodasEscolas"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold rounded-full transition-all duration-200 bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700 shadow-sm hover:shadow-md"
                    title="Alternar entre suas escolas e todas as escolas">
                    <span id="btnVerTodasIcone">üåê</span>
                    <span id="btnVerTodasText">Ver Todas</span>
                  </button>
                </div>
              </div>
              <div class="autocomplete-wrapper">
                <input type="text" id="cmeiEmef" name="cmeiEmef" required disabled autocomplete="off"
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-500"
                  placeholder="Primeiro selecione o tipo de institui√ß√£o">
                <div class="autocomplete-list" id="autocompleteList"></div>
              </div>
              <!-- Indicador de filtro ativo (apenas t√©cnicos) -->
              <div id="filtroAtivoContainer" class="hidden mt-1.5">
                <p id="filtroAtivoIndicador" class="text-xs text-green-600 flex items-center gap-1">
                  <span>‚úì</span> <span id="filtroAtivoTexto">Mostrando suas escolas atribu√≠das</span>
                </p>
              </div>
              <p class="text-xs text-gray-500 mt-1.5">Digite para filtrar as institui√ß√µes dispon√≠veis</p>
            </div>

            <!-- Regi√£o (Preenchido automaticamente ao selecionar escola) -->
            <div>
              <label for="regiao-display" class="block text-sm font-semibold text-gray-700 mb-2">
                Regi√£o <span class="text-red-500">*</span>
              </label>
              <input type="text" id="regiao-display" readonly
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed shadow-sm"
                placeholder="Selecione uma escola primeiro">
              <!-- Campo hidden para envio ao backend -->
              <input type="hidden" id="regiao" name="regiao" required>
              <p class="text-xs text-blue-500 mt-1.5 flex items-center gap-1">
                <span>‚ÑπÔ∏è</span> Preenchido automaticamente ao selecionar a escola
              </p>
            </div>

            <!-- Respons√°vel pelo Registro -->
            <div class="md:col-span-2">
              <label for="responsavelRegistro" class="block text-sm font-semibold text-gray-700 mb-2">
                Respons√°vel pelo Registro <span class="text-red-500">*</span>
              </label>
              <input type="text" id="responsavelRegistro" name="responsavelRegistro" required readonly
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-gray-50 shadow-sm cursor-not-allowed"
                placeholder="Carregando nome do usu√°rio...">
              <p class="text-xs text-gray-500 mt-1">Preenchido automaticamente com seu nome</p>
            </div>

            <!-- Colaboradores do Registro -->
            <div class="md:col-span-2">
              <label for="colaboradores-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Colaboradores do Registro <span class="text-gray-400 text-xs">(opcional)</span>
              </label>

              <!-- Container de tags -->
              <div id="colaboradores-tags"
                class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>

              <!-- Input com autocomplete -->
              <div class="relative">
                <input type="text" id="colaboradores-input"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar colaborador..." autocomplete="off" />

                <!-- Lista de sugest√µes -->
                <div id="colaboradores-suggestions"
                  class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                </div>
              </div>

              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="colaboradores" name="colaboradores" />

              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Colaboradores tamb√©m receber√£o acesso a esta notifica√ß√£o.
              </p>
            </div>

          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- SE√á√ÉO 4: Perguntas Complementares (Sim/N√£o) -->
      <!-- =============================================== -->
      <section>
        <div
          class="bg-gradient-to-r from-purple-50/50 to-indigo-50/30 rounded-xl sm:rounded-2xl border border-purple-200 shadow-sm p-4 sm:p-5 md:p-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div
              class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              ‚ùì
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Informa√ß√µes Complementares
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Responda √†s quest√µes adicionais sobre o contexto da viol√™ncia
              </p>
            </div>
          </div>

          <div class="space-y-4">

            <!-- Fonte informadores foi a escola? -->
            <!-- Foi um membro familiar? -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                O autor era membro da fam√≠lia?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Membro da Fam√≠lia</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> se o autor da viol√™ncia √© um familiar da
                      v√≠tima: pais, respons√°veis legais, av√≥s, irm√£os, tios, primos ou outros parentes consangu√≠neos ou
                      por afinidade. Esta informa√ß√£o ajuda a identificar casos de viol√™ncia dom√©stica ou intrafamiliar.
                    </p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="foiMembroFamiliar" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="foiMembroFamiliar" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="foiMembroFamiliar" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-2 sm:mb-3 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                O relato foi feito pela escola?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Relato pela Escola</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> quando a pr√≥pria escola ‚Äî por meio da dire√ß√£o,
                      coordena√ß√£o, professores ou outros funcion√°rios ‚Äî identificar a viol√™ncia e realizar o relato
                      oficial do caso.</p>
                    <p>Marque <span class="tooltip-highlight">N√£o</span> quando o relato tiver sido feito por outras
                      fontes, como pais ou respons√°veis, alunos ou institui√ß√µes externas.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Viol√™ncia identificada pela escola ocorrida na escola -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                A escola identificou que a viol√™ncia ocorreu na escola?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Identifica√ß√£o pela Escola</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> quando, ap√≥s apura√ß√£o ou investiga√ß√£o interna,
                      a escola confirmar que a viol√™ncia ocorreu dentro do ambiente escolar, como salas de aula, p√°tio,
                      banheiros, quadra ou outros espa√ßos da escola.</p>
                    <p>Esta quest√£o refere-se exclusivamente ao local onde o fato ocorreu, independentemente de quem
                      identificou ou comunicou o caso.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Algum profissional da escola foi autor da viol√™ncia -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Algum profissional/funcion√°rio da escola foi autor da viol√™ncia?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Profissional / Funcion√°rio</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> quando a viol√™ncia tiver sido praticada por
                      profissional ou funcion√°rio da escola, incluindo professores, pedagogos, diretores, coordenadores,
                      auxiliares, merendeiras, porteiros, seguran√ßas, pessoal de limpeza ou qualquer outro funcion√°rio
                      efetivo, contratado ou terceirizado.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Algum estudante foi autor da viol√™ncia? -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Algum estudante foi autor da viol√™ncia?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Estudante Autor</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> quando a viol√™ncia tiver sido praticada por
                      outro estudante, seja ele da mesma escola ou de outra unidade da rede.</p>
                    <p>Incluem-se casos de bullying, agress√µes f√≠sicas, cyberbullying ou qualquer outra forma de
                      viol√™ncia entre estudantes.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Viol√™ncia identificada pela escola N√ÉO ocorrida na escola -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                A escola identificou que a viol√™ncia N√ÉO ocorreu na escola?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Fora da Escola</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> quando, ap√≥s verifica√ß√£o, a escola confirmar
                      que a viol√™ncia n√£o ocorreu no <span class="tooltip-highlight">ambiente escolar</span>, mas em
                      local externo, como resid√™ncia do aluno, via p√∫blica, transporte p√∫blico ou outros espa√ßos fora da
                      escola.</p>
                    <p>Mesmo que a escola tenha identificado ou acompanhado o caso, considere <span
                        class="tooltip-highlight">Sim</span> se o local da ocorr√™ncia foi externo ao ambiente escolar.
                    </p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Viol√™ncia informada √† escola por qualquer um dos agentes que a comp√µe 1.2 -->
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                A viol√™ncia foi comunicada √† escola por algum agente externo?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Comunica√ß√£o Externa</strong>
                    <p>Selecione <span class="tooltip-highlight">Sim</span> quando a viol√™ncia n√£o tiver sido
                      identificada diretamente pela escola, mas informada por <span class="tooltip-highlight">agentes
                        externos</span>, como pais ou respons√°veis, o pr√≥prio aluno, familiares, vizinhos, Conselho
                      Tutelar, Pol√≠cia, UBS, CRAS ou outras institui√ß√µes.</p>
                    <p>Nesses casos, considera-se que a escola tomou conhecimento da ocorr√™ncia por meio de terceiros.
                    </p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

            <!-- Ocorreu na escola? 1.1 (condicional) -->
            <div id="ocorreu-escola-wrapper"
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <div class="flex items-center gap-2 mb-2 sm:mb-3">
                <span class="conditional-hint"><span class="dot"></span>Campo condicional</span>
                <span class="text-[11px] sm:text-xs text-gray-500">Exibido quando ‚ÄúViol√™ncia informada √† escola‚Äù =
                  Sim</span>
              </div>
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                ‚ûú A viol√™ncia ocorreu na escola?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Campo Condicional</strong>
                    <p>Este campo ser√° exibido somente se, na pergunta anterior, voc√™ marcar a op√ß√£o <span
                        class="tooltip-highlight">Sim</span>.</p>
                    <p>Aqui, informe se a viol√™ncia relatada por terceiros ocorreu ou n√£o dentro do <span
                        class="tooltip-highlight">ambiente escolar</span>, considerando a apura√ß√£o realizada pela equipe
                      respons√°vel.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="Sim" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>

          </div>

          <!-- Foi Realizado Estudo de Caso? -->
          <div class="md:col-span-2">
            <div
              class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 mt-4 sm:mt-5 mb-4 sm:mb-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Foi realizado estudo de caso pela equipe?
                <span class="info-tooltip-wrapper">
                  <span class="info-tip">?</span>
                  <div class="info-tooltip-content">
                    <strong>üí° Estudo de Caso</strong>
                    <p>Marque <span class="tooltip-highlight">Sim</span> se foi realizada uma an√°lise formal e
                      estruturada do caso pela equipe escolar (pedag√≥gica, psicossocial, dire√ß√£o). O estudo de caso
                      envolve reuni√µes, avalia√ß√£o multidisciplinar, plano de interven√ß√£o e documenta√ß√£o oficial.</p>
                  </div>
                </span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="Sim" class="peer sr-only" required>
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="N√£o" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="" class="peer sr-only">
                  <div
                    class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- SE√á√ÉO: Observa√ß√µes Iniciais (Opcional) -->
      <!-- =============================================== -->
      <section data-tour="dados-detalhes">
        <div
          class="bg-gradient-to-r from-blue-50/50 to-cyan-50/30 rounded-xl sm:rounded-2xl border border-blue-200 shadow-sm p-4 sm:p-5 md:p-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div
              class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              üìù
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Observa√ß√µes Iniciais
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Adicione observa√ß√µes ou notas iniciais sobre este caso (opcional)
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-4 sm:gap-6">
            <div>
              <label for="observacoesIniciais" class="block text-sm font-semibold text-gray-700 mb-2">
                Observa√ß√µes Iniciais
                <span class="text-gray-500 font-normal text-xs">(opcional)</span>
              </label>
              <textarea id="observacoesIniciais" name="observacoesIniciais" rows="4" maxlength="1000"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm resize-y"
                placeholder="Ex: Primeira conversa com o aluno realizada em 15/01/2026. Observa√ß√µes sobre o comportamento inicial..."></textarea>
              <p class="text-xs text-gray-500 mt-1">
                Esta observa√ß√£o ser√° salva automaticamente com data/hora e nome do respons√°vel
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- SE√á√ÉO DE ANEXOS -->
      <!-- =============================================== -->
      <section class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 sm:mb-8 border-l-4 border-orange-500">
        <div class="space-y-4 sm:space-y-6">
          <div>
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-2xl">üìé</span>
              Anexar Arquivos (Opcional)
            </h3>
            <p class="text-xs sm:text-sm text-gray-600">Voc√™ pode adicionar documentos, fotos ou PDFs. M√°ximo 10MB por
              arquivo.</p>
          </div>

          <!-- Campo de Upload -->
          <div class="space-y-2">
            <label for="anexos" class="block text-sm font-semibold text-gray-700">
              üìÅ Selecione arquivos
            </label>
            <input type="file" id="anexos" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-gradient-to-r file:from-orange-500 file:to-orange-600
                file:text-white
                hover:file:bg-gradient-to-r hover:file:from-orange-600 hover:file:to-orange-700
                cursor-pointer
                border-2 border-dashed border-orange-300
                rounded-lg p-4
                hover:border-orange-400
                transition-colors" />
            <p class="text-xs text-gray-500">
              ‚úì PDF ‚Ä¢ JPG ‚Ä¢ PNG ‚Ä¢ DOC ‚Ä¢ DOCX ‚Ä¢ XLS ‚Ä¢ XLSX
            </p>
          </div>

          <!-- Preview de Arquivos -->
          <div id="preview-anexos" class="preview-anexos"></div>

          <!-- Informa√ß√µes -->
          <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
            <p class="text-xs sm:text-sm text-blue-800">
              <strong>üí° Dica:</strong> Os arquivos ser√£o comprimidos automaticamente para economizar espa√ßo (30-90% de
              redu√ß√£o).
            </p>
          </div>
        </div>
      </section>

      <!-- =============================================== -->
      <!-- BOT√ïES DE A√á√ÉO -->
      <!-- =============================================== -->
      <div
        class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-end pt-6 sm:pt-8 mt-6 sm:mt-8 border-t-2 border-gray-200">
        <button type="button" onclick="openAlertDialog()"
          class="inline-flex items-center justify-center gap-2 px-5 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white text-sm sm:text-base font-semibold rounded-full hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 sm:hover:scale-105">
          <span class="text-base sm:text-lg">üîÑ</span>
          <span>Limpar Formul√°rio</span>
        </button>

        <button type="submit" id="btnSalvar" data-tour="btn-enviar"
          class="btn-elegant btn-primary-elegant inline-flex items-center justify-center gap-2 px-6 sm:px-8 py-2.5 sm:py-3 text-white text-sm sm:text-base font-bold rounded-full shadow-lg">
          <span class="text-base sm:text-lg">üíæ</span>
          <span>Salvar Registro</span>
        </button>
      </div>

    </form>

    <!-- Alert Dialog - Confirma√ß√£o de Limpar Formul√°rio -->
    <div id="alertDialogOverlay" class="alert-dialog-overlay" onclick="closeAlertDialog()"></div>
    <div id="alertDialogContent" class="alert-dialog-content">
      <div class="alert-dialog-icon">‚ö†Ô∏è</div>
      <div class="alert-dialog-header">
        <h2 class="alert-dialog-title">Limpar todos os dados?</h2>
        <p class="alert-dialog-description">
          Todos os campos preenchidos ser√£o apagados e n√£o poder√£o ser recuperados. Esta a√ß√£o √© permanente.
        </p>
      </div>
      <div class="alert-dialog-footer">
        <button class="alert-dialog-cancel transition-all duration-200 hover:bg-gray-200 active:scale-95"
          onclick="closeAlertDialog()">üö´ Cancelar</button>
        <button class="alert-dialog-action transition-all duration-200 hover:bg-red-600 active:scale-95"
          onclick="confirmarLimparFormulario()">üóëÔ∏è Limpar Tudo</button>
      </div>
    </div>

    <!-- Alert Dialog - Confirma√ß√£o de Limpar Rascunho -->
    <div id="alertDialogOverlayRascunho" class="alert-dialog-overlay" onclick="closeAlertDialogRascunho()"></div>
    <div id="alertDialogContentRascunho" class="alert-dialog-content">
      <div class="alert-dialog-icon">üíæ</div>
      <div class="alert-dialog-header">
        <h2 class="alert-dialog-title">Limpar rascunho salvo?</h2>
        <p class="alert-dialog-description">
          O rascunho autom√°tico ser√° exclu√≠do. Voc√™ poder√° salvar um novo rascunho depois.
        </p>
      </div>
      <div class="alert-dialog-footer">
        <button class="alert-dialog-cancel transition-all duration-200 hover:bg-gray-200 active:scale-95"
          onclick="closeAlertDialogRascunho()">üö´ Cancelar</button>
        <button class="alert-dialog-action transition-all duration-200 hover:bg-red-600 active:scale-95"
          onclick="confirmarLimparRascunho()">üóëÔ∏è Limpar Rascunho</button>
      </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Registro -->
    <div id="confirmRegistroOverlay" class="alert-dialog-overlay" onclick="fecharModalConfirmacao()"></div>
    <div id="confirmRegistroContent" class="alert-dialog-content" style="max-width: 500px;">
      <div class="alert-dialog-icon">üìã</div>
      <div class="alert-dialog-header">
        <h2 class="alert-dialog-title">Confirmar Registro</h2>
        <p class="alert-dialog-description">
          Revise os dados principais antes de salvar:
        </p>
      </div>

      <!-- Resumo dos dados -->
      <div id="resumoRegistro" class="bg-gray-50 rounded-lg p-4 mb-4 text-left text-sm max-h-64 overflow-y-auto">
        <!-- Preenchido via JavaScript -->
      </div>

      <div class="alert-dialog-footer">
        <button class="alert-dialog-cancel transition-all duration-200 hover:bg-gray-200 active:scale-95"
          onclick="fecharModalConfirmacao()">‚úèÔ∏è Revisar</button>
        <button id="btnConfirmarEnvio"
          class="alert-dialog-action bg-green-600 hover:bg-green-700 transition-all duration-200 active:scale-95"
          onclick="confirmarEnvioRegistro()">‚úÖ Confirmar e Salvar</button>
      </div>
    </div>

    <!-- Rodap√© -->
    <div class="text-center mt-6 sm:mt-8 mb-4">
      <div
        class="inline-block bg-white/60 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-md border border-white/60 px-4 sm:px-6 md:px-8 py-4 sm:py-5 max-w-full mx-2">
        <p class="text-gray-700 font-semibold text-sm sm:text-base mb-1">Sistema de Registro de Casos de Viol√™ncia
          Escolar</p>
        <p class="text-gray-600 text-xs sm:text-sm">Secretaria Municipal de Educa√ß√£o ¬∑ Vit√≥ria/ES</p>
        <div class="mt-3 pt-3 border-t border-gray-200">
          <p class="text-xs text-gray-500">¬© 2025 - Todos os direitos reservados</p>
        </div>
      </div>
    </div>

  </div>

  <!-- =============================================== -->
  <!-- JAVASCRIPT -->
  <!-- =============================================== -->
  <script>
    // ========================================
    // CONFIGURA√á√ÉO DO GOOGLE APPS SCRIPT
    // ========================================
    // Usando configura√ß√£o centralizada (config.js)
    // Fun√ß√£o para obter a URL do Apps Script de forma segura
    function obterURLAppsScript() {
      // Aguarda um pouco para garantir que config.js foi carregado
      if (typeof CONFIG === 'undefined') {
        console.warn('‚ö†Ô∏è CONFIG n√£o est√° dispon√≠vel ainda. Tentando aguardar...');
        // Tenta novamente ap√≥s um pequeno delay
        setTimeout(() => {
          if (typeof CONFIG !== 'undefined' && CONFIG.APPS_SCRIPT_CASOS) {
            console.log('‚úÖ CONFIG carregado ap√≥s delay');
          } else {
            console.error('‚ùå CONFIG ainda n√£o dispon√≠vel ap√≥s delay');
          }
        }, 100);
      }

      console.log('üîß Verificando configura√ß√£o do Apps Script...');
      console.log('CONFIG dispon√≠vel?', typeof CONFIG !== 'undefined');

      if (typeof CONFIG !== 'undefined') {
        console.log('CONFIG completo:', CONFIG);
        console.log('CONFIG.APPS_SCRIPT_CASOS?', CONFIG.APPS_SCRIPT_CASOS);
      }

      const url = (typeof CONFIG !== 'undefined' && CONFIG.APPS_SCRIPT_CASOS)
        ? CONFIG.APPS_SCRIPT_CASOS
        : 'https://script.google.com/macros/s/SEU_ID_AQUI/exec';

      console.log('üì° URL do Apps Script obtida:', url);

      // Valida√ß√£o: Verifica se est√° configurado
      if (url.includes('SEU_ID_AQUI')) {
        console.error('‚ùå ATEN√á√ÉO: Configure APPS_SCRIPT_CASOS em config.js para salvar registros');
        console.error('‚ö†Ô∏è A URL do Apps Script n√£o est√° configurada!');
        return null; // Retorna null se n√£o estiver configurado
      } else {
        console.log('‚úÖ URL do Apps Script configurada corretamente:', url);
        return url;
      }
    }

    // Obt√©m a URL (pode ser null se n√£o estiver configurada)
    // Aguarda o carregamento completo da p√°gina para garantir que config.js foi carregado
    let APPS_SCRIPT_URL = null;

    // Fun√ß√£o para inicializar a URL quando o DOM estiver pronto
    function inicializarURLAppsScript() {
      // Usa window.CONFIG diretamente (n√£o pode reatribuir const)
      const config = typeof window !== 'undefined' ? window.CONFIG : (typeof CONFIG !== 'undefined' ? CONFIG : null);

      if (config && config.APPS_SCRIPT_CASOS) {
        APPS_SCRIPT_URL = config.APPS_SCRIPT_CASOS;
        console.log('‚úÖ URL do Apps Script inicializada:', APPS_SCRIPT_URL);
        console.log('üîç Verificando se √© a URL correta...');

        // Verifica se √© a URL antiga (que pode estar em cache)
        if (APPS_SCRIPT_URL.includes('AKfycbz-Ocm2sp-6c7bFAdLF1Da4FtRVd_gWV0deScEvOko-Sii2NpTqHwkzG0mBYjIct2-o')) {
          console.warn('‚ö†Ô∏è ATEN√á√ÉO: Voc√™ pode estar usando uma URL antiga em cache!');
          console.warn('üí° Solu√ß√£o: Limpe o cache do navegador (Ctrl+Shift+Delete) ou fa√ßa um Hard Refresh (Ctrl+F5)');
        }
      } else {
        console.error('‚ùå CONFIG.APPS_SCRIPT_CASOS n√£o est√° dispon√≠vel');
        console.error('CONFIG dispon√≠vel?', typeof config !== 'undefined' && config !== null);
        if (config) {
          console.error('CONFIG completo:', config);
        }
        APPS_SCRIPT_URL = 'https://script.google.com/macros/s/SEU_ID_AQUI/exec';
      }
    }

    // Tenta inicializar imediatamente
    if (document.readyState === 'loading') {
      // Se ainda est√° carregando, aguarda DOMContentLoaded
      document.addEventListener('DOMContentLoaded', inicializarURLAppsScript);
    } else {
      // Se j√° carregou, inicializa imediatamente
      inicializarURLAppsScript();
    }

    // ========================================
    // FUN√á√ïES DE FORMATA√á√ÉO (do backend)
    // ========================================

    // ========================================
    // FUN√á√ÉO: Toggle de Tooltips Interativos
    // ========================================
    // Tooltips agora funcionam com hover - sem necessidade de JavaScript adicional

    // Fecha tooltips ao clicar fora
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.info-tooltip-wrapper')) {
        document.querySelectorAll('.info-tooltip-wrapper.active').forEach(w => {
          w.classList.remove('active');
        });
      }
    });

    // Fecha tooltips ao pressionar ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.info-tooltip-wrapper.active').forEach(w => {
          w.classList.remove('active');
        });
      }
    });

    // ========================================
    // FUN√á√ÉO AUXILIAR: Convers√£o Sim/N√£o
    // ========================================

    // Fun√ß√£o auxiliar para converter Sim/N√£o em S/N
    function converterSimNao(valor) {
      if (!valor || valor.trim() === '' || valor === 'N√£o informado') return '';
      if (valor === 'Sim') return 'S';
      if (valor === 'N√£o') return 'N';
      return valor;
    }

    // Fun√ß√£o para extrair sigla da escola
    function extrairSiglaEscola(nomeCompleto) {
      if (!nomeCompleto) return '';

      // Remove o prefixo CMEI/EMEF e TI
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');

      // Palavras que devem ser ignoradas ao gerar siglas
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];

      // Separa as palavras e pega as iniciais das palavras importantes
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');

      return sigla;
    }

    // Fun√ß√£o para converter data de YYYY-MM-DD para DD/MM/YYYY
    function formatarData(dataISO) {
      if (!dataISO) return '';
      const partes = dataISO.split('-');
      if (partes.length === 3) {
        return partes[2] + '/' + partes[1] + '/' + partes[0];
      }
      return dataISO;
    }

    // ========================================
    // DADOS DAS INSTITUI√á√ïES
    // ========================================

    // ========================================
    // FUN√á√ÉO AUXILIAR: Encontrar melhor correspond√™ncia similar
    // ========================================
    function encontrarMelhorCorrespondencia(textoDigitado, opcoesDisponiveis, opcoesJaSelecionadas = []) {
      if (!textoDigitado || !opcoesDisponiveis || opcoesDisponiveis.length === 0) {
        return null;
      }

      const textoNormalizado = normalizarTexto(textoDigitado);
      const textoLower = textoNormalizado.toLowerCase();

      // Filtra op√ß√µes j√° selecionadas
      const opcoesDisponiveisFiltradas = opcoesDisponiveis.filter(op => !opcoesJaSelecionadas.includes(op));

      if (opcoesDisponiveisFiltradas.length === 0) {
        return null;
      }

      let melhorCorrespondencia = null;
      let melhorScore = 0;

      opcoesDisponiveisFiltradas.forEach(opcao => {
        const opcaoNormalizada = normalizarTexto(opcao);
        const opcaoLower = opcaoNormalizada.toLowerCase();

        // Verifica correspond√™ncia exata (ap√≥s normaliza√ß√£o)
        if (opcaoLower === textoLower) {
          melhorCorrespondencia = opcao;
          melhorScore = 1.0;
          return;
        }

        // Verifica se o texto digitado est√° contido na op√ß√£o ou vice-versa
        if (opcaoLower.includes(textoLower) || textoLower.includes(opcaoLower)) {
          const score = Math.min(textoLower.length, opcaoLower.length) / Math.max(textoLower.length, opcaoLower.length);
          if (score > melhorScore) {
            melhorScore = score;
            melhorCorrespondencia = opcao;
          }
        }

        // Calcula similaridade usando Levenshtein simplificado
        const similaridade = calcularSimilaridade(textoLower, opcaoLower);
        if (similaridade > melhorScore && similaridade >= 0.7) { // 70% de similaridade m√≠nima
          melhorScore = similaridade;
          melhorCorrespondencia = opcao;
        }
      });

      // Retorna apenas se a similaridade for alta o suficiente (70%+)
      return melhorScore >= 0.7 ? melhorCorrespondencia : null;
    }

    // Normaliza texto para compara√ß√£o
    function normalizarTexto(texto) {
      return String(texto || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Calcula similaridade entre duas strings (0 a 1)
    function calcularSimilaridade(str1, str2) {
      if (str1 === str2) return 1.0;
      if (str1.length === 0 || str2.length === 0) return 0;

      // Se uma cont√©m a outra, retorna alta similaridade
      if (str1.includes(str2) || str2.includes(str1)) {
        return 0.9;
      }

      // Calcula dist√¢ncia de Levenshtein simplificada
      const maxLen = Math.max(str1.length, str2.length);
      const distancia = distanciaLevenshtein(str1, str2);
      return 1 - (distancia / maxLen);
    }

    // Calcula dist√¢ncia de Levenshtein entre duas strings
    function distanciaLevenshtein(str1, str2) {
      const matrix = [];
      const len1 = str1.length;
      const len2 = str2.length;

      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }

      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          if (str1[i - 1] === str2[j - 1]) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + 1
            );
          }
        }
      }

      return matrix[len1][len2];
    }

    // ========================================
    // LISTA DE TRANSTORNOS/DEFICI√äNCIAS PREDEFINIDOS
    // ========================================
    const transtornosPredefinidos = [
      'Autismo (TEA)',
      'TDAH (Transtorno de D√©ficit de Aten√ß√£o e Hiperatividade)',
      'S√≠ndrome de Down',
      'Defici√™ncia Intelectual',
      'Defici√™ncia Visual',
      'Dist√∫rbio de Linguagem',
      'Defici√™ncia Auditiva',
      'Defici√™ncia F√≠sica',
      'Defici√™ncia M√∫ltipla',
      'Dislexia',
      'Discalculia',
      'Transtorno do Espectro Autista',
      'Transtorno de P√¢nico',
      'Paralisia Cerebral',
      'TOD (Transtorno Opositor Desafiador)',
      'Transtorno de Ansiedade',
      'Encefalopatia Cr√¥nica',
      'Depress√£o Infantil',
      'Transtorno Mental',
      'Muliplas Defici√™ncias',
      'Encefalopatia Epil√©tica',
      'S√≠ndrome de Asperger',
      'Transtorno Comportamental',
      'Transtorno Bipolar',
      'Esquizofrenia',
      'Transtorno de Conduta',
      'Altas Habilidades/Superdota√ß√£o',
      'Baixa Vis√£o',
      'Cegueira',
      'Surdez',
      'Surdocegueira',
      'Nanismo',
      'Hidrocefalia',
      'Microcefalia',
      'Epilepsia',
      'Outros'
    ];

    let transtornosSelecionados = [];

    // Renderiza as tags de transtornos selecionados
    function renderizarTagsTranstornos() {
      const container = document.getElementById('pcdDetalhes-tags');
      const hiddenInput = document.getElementById('pcdDetalhes');

      if (transtornosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum transtorno/defici√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = transtornosSelecionados.map((trans, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm transition-all duration-200 hover:bg-blue-200 hover:shadow-md hover:scale-105">
          ${trans}
          <button 
            type="button" 
            data-index="${index}"
            onclick="removerTranstorno(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-all duration-200 active:scale-90">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = transtornosSelecionados.join(', ');
    }

    // Remove um transtorno
    function removerTranstorno(index) {
      const container = document.getElementById('pcdDetalhes-tags');
      const tags = container.querySelectorAll('span');
      const tagToRemove = tags[index];

      if (tagToRemove) {
        tagToRemove.classList.add('tag-removing');
        setTimeout(() => {
          transtornosSelecionados.splice(index, 1);
          renderizarTagsTranstornos();

          // Salva automaticamente ap√≥s remover tag
          if (typeof AutoSave !== 'undefined') {
            AutoSave.salvar();
          }
        }, 300);
      }
    }

    // Adiciona um transtorno
    function adicionarTranstorno(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Separa por barra (/) para considerar m√∫ltiplos transtornos
      const transtornos = textoTrimmed.split('/').map(t => t.trim()).filter(t => t.length > 0);

      // Adiciona cada transtorno separadamente
      transtornos.forEach(transtorno => {
        // Primeiro, tenta encontrar uma correspond√™ncia similar
        const correspondencia = encontrarMelhorCorrespondencia(
          transtorno,
          transtornosPredefinidos,
          transtornosSelecionados
        );

        // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
        const valorFinal = correspondencia || transtorno;

        // Evita duplicatas
        if (!transtornosSelecionados.includes(valorFinal)) {
          transtornosSelecionados.push(valorFinal);
        }
      });

      renderizarTagsTranstornos();

      // Limpa input
      document.getElementById('pcdDetalhes-input').value = '';
      fecharModalPcdSugestoes();

      // Salva automaticamente ap√≥s adicionar tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }

    // ========================================
    // SISTEMA DE SUGEST√ïES - NOME DA CRIAN√áA
    // ========================================
    let nomesChildrenCache = [];
    let dadosChildrenCache = new Map(); // Mapa: nome -> dados mais recentes do estudante

    async function carregarNomesChildrenCache() {
      try {
        // Obt√©m o email do usu√°rio logado
        const userEmail = sessionStorage.getItem('userEmail');

        if (!userEmail) {
          console.warn('[registro] Email do usu√°rio n√£o encontrado em sessionStorage');
          nomesChildrenCache = [];
          dadosChildrenCache.clear();
          return;
        }

        // Chama a mesma action que minhas-notificacoes.html usa
        // Isso garante que retorna APENAS as crian√ßas com notifica√ß√µes do usu√°rio
        const resultado = await window.API.request(window.CONFIG.APPS_SCRIPT_CASOS, {
          action: 'listarMinhasNotificacoes',
          emailUsuario: userEmail
        });

        if (resultado.success && resultado.grupos) {
          // Extrai apenas os nomes das crian√ßas (chaves do objeto grupos)
          const nomesOriginais = Object.keys(resultado.grupos);

          // Remove duplicatas usando normaliza√ß√£o e armazena dados do estudante
          const mapaDeduplicado = new Map();
          dadosChildrenCache.clear();

          nomesOriginais.forEach(nome => {
            const nomeNormalizado = normalizarNomeChild(nome);
            // Mant√©m a primeira ocorr√™ncia (que j√° vem normalizada do backend)
            if (!mapaDeduplicado.has(nomeNormalizado)) {
              mapaDeduplicado.set(nomeNormalizado, nome);
            }

            // Armazena os dados mais recentes do estudante (maior idNotificacao = mais recente)
            const notificacoes = resultado.grupos[nome];
            if (notificacoes && notificacoes.length > 0) {
              // Ordena por idNotificacao (decrescente) para pegar o mais recente
              const maisRecente = notificacoes.reduce((a, b) =>
                (Number(b.idNotificacao) > Number(a.idNotificacao)) ? b : a
              );

              // Usa o nome normalizado como chave para evitar duplicatas
              const nomeParaCache = mapaDeduplicado.get(nomeNormalizado);
              if (!dadosChildrenCache.has(nomeParaCache)) {
                dadosChildrenCache.set(nomeParaCache, maisRecente);
              }
            }
          });

          // Converte de volta para array e ordena
          nomesChildrenCache = Array.from(mapaDeduplicado.values()).sort();

          console.log('[registro] Nomes de crian√ßas com notifica√ß√µes carregados:', nomesChildrenCache.length, 'crian√ßas √∫nicas');
          console.log('[registro] Dados em cache para autofill:', dadosChildrenCache.size, 'estudantes');
        } else {
          console.warn('[registro] Nenhuma notifica√ß√£o encontrada para este usu√°rio');
          nomesChildrenCache = [];
          dadosChildrenCache.clear();
        }
      } catch (erro) {
        console.error('[registro] Erro ao carregar nomes de crian√ßas:', erro);
        nomesChildrenCache = [];
        dadosChildrenCache.clear();
      }
    }

    function normalizarNomeChild(nome) {
      return String(nome || '')
        .trim()
        .replace(/\s+/g, ' ') // Remove espa√ßos m√∫ltiplos
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }

    function mostrarSugestoesChild(query) {
      const suggestionsDiv = document.getElementById('criancaEstudante-suggestions');

      if (!query.trim()) {
        suggestionsDiv.classList.add('hidden');
        return;
      }

      const queryNormalizado = normalizarNomeChild(query);

      // Filtra nomes que correspondem √† busca
      const filtrados = nomesChildrenCache.filter(nome => {
        const nomeNormalizado = normalizarNomeChild(nome);
        return nomeNormalizado.includes(queryNormalizado);
      });

      if (filtrados.length === 0) {
        suggestionsDiv.innerHTML = `
          <div class="text-center">
            Nenhuma crian√ßa encontrada
          </div>
        `;
        suggestionsDiv.classList.remove('hidden');
        return;
      }

      suggestionsDiv.innerHTML = filtrados.slice(0, 10).map(nome => `
        <div 
          class="suggestion-item"
          onclick="selecionarChild('${nome.replace(/'/g, "\\'")}')">
          ${nome}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    function selecionarChild(nome) {
      document.getElementById('criancaEstudante').value = nome;
      document.getElementById('criancaEstudante-suggestions').classList.add('hidden');

      // Tenta preencher dados do estudante se dispon√≠veis no cache
      if (dadosChildrenCache.has(nome)) {
        const dados = dadosChildrenCache.get(nome);
        preencherDadosEstudante(dados);
      }

      // Salva automaticamente ap√≥s selecionar
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }

    // Helper para encontrar a melhor op√ß√£o em um select (fuzzy match)
    function encontrarMelhorOpcao(selectElement, valorBusca) {
      if (!valorBusca || !selectElement) return '';

      const valorNormalizado = valorBusca.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      console.log(`[autofill-debug] Buscando: '${valorBusca}' (Norm: '${valorNormalizado}') em ID: ${selectElement.id}`);

      // 1. Tentativa exata (sem normaliza√ß√£o, original)
      for (let opt of selectElement.options) {
        if (opt.value === valorBusca) {
          console.log(`[autofill-debug] Match EXATO encontrado: '${opt.value}'`);
          return opt.value;
        }
      }

      // 2. Tentativa normalizada (valor e texto)
      for (let opt of selectElement.options) {
        if (!opt.value) continue;
        const optValNorm = opt.value.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const optTxtNorm = opt.text.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        if (optValNorm === valorNormalizado || optTxtNorm === valorNormalizado) {
          console.log(`[autofill-debug] Match NORMALIZADO encontrado. Option: '${opt.value}' (ValNorm: '${optValNorm}', TxtNorm: '${optTxtNorm}')`);
          return opt.value;
        }
      }

      // 3. Mapeamentos espec√≠ficos comuns (Branco->Branca, etc)
      const mapeamentos = {
        'branco': 'Branca',
        'branca': 'Branca',
        'preto': 'Preta',
        'preta': 'Preta',
        'pardo': 'Parda',
        'parda': 'Parda',
        'amarelo': 'Amarela',
        'amarela': 'Amarela',
        'indigena': 'Ind√≠gena',
        'homossexual': 'Homossexual',
        'heterossexual': 'Heterossexual',
        'bissexual': 'Bissexual',
        'menino': 'M',
        'menina': 'F',
        'masculino': 'M',
        'feminino': 'F'
      };

      // Tenta encontrar key que bata com valor normalizado
      for (let key in mapeamentos) {
        if (valorNormalizado === key || valorNormalizado.includes(key)) {
          // Verifica se o valor mapeado existe no select target
          for (let opt of selectElement.options) {
            if (opt.value === mapeamentos[key]) {
              console.log(`[autofill-debug] Match MAPEADO encontrado. Key: '${key}' -> Map: '${mapeamentos[key]}' -> Option: '${opt.value}'`);
              return opt.value;
            }
          }
        }
      }

      console.warn(`[autofill-debug] NENHUM match encontrado para '${valorBusca}' em ${selectElement.id}`);
      return '';
    }

    // Helper robusto para definir valor de select e garantir que o change dispara
    function definirValorSelect(selectElement, valor) {
      if (!selectElement || !valor) return false;

      console.log(`[autofill-debug] Tentando definir '${valor}' em ${selectElement.id}...`);

      // 1. Tenta atribui√ß√£o direta
      selectElement.value = valor;

      // Verifica se funcionou (o value deve bater)
      if (selectElement.value === valor) {
        console.log(`[autofill-debug] Sucesso atribui√ß√£o direta para ${selectElement.id}`);
        selectElement.dispatchEvent(new Event('change', { bubbles: true }));
        return true;
      }

      // 2. Se falhou, tenta buscar a op√ß√£o e marcar selected manualmente
      console.warn(`[autofill-debug] Atribui√ß√£o direta falhou para ${selectElement.id}. Tentando via index...`);
      for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].value == valor) { // "==" para tolerar convers√£o de tipos
          selectElement.selectedIndex = i;
          console.log(`[autofill-debug] Sucesso via selectedIndex [${i}] para ${selectElement.id}`);
          selectElement.dispatchEvent(new Event('change', { bubbles: true }));
          return true;
        }
      }

      console.error(`[autofill-debug] FALHA TOTAL ao definir valor '${valor}' para ${selectElement.id}`);
      return false;
    }

    // Preenche os campos do formul√°rio com dados do estudante do cache
    function preencherDadosEstudante(dados) {
      if (!dados) return;

      // DEBUG: Mostra dados recebidos para diagn√≥stico
      console.log('[autofill] Dados recebidos:', dados);

      // Obt√©m refer√™ncias aos elementos
      const idadeInput = document.getElementById('idade');
      const generoSelect = document.getElementById('identidadeGenero');
      const racaSelect = document.getElementById('racaCor');
      const orientacaoSelect = document.getElementById('orientacaoSexual');
      const pcdSelect = document.getElementById('pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');

      let camposPreenchidos = 0;

      // ========================================
      // Idade
      // ========================================
      if (idadeInput && dados.idade) {
        idadeInput.value = dados.idade;
        idadeInput.dispatchEvent(new Event('input', { bubbles: true }));
        camposPreenchidos++;
      }

      // ========================================
      // Identidade de G√™nero
      // ========================================
      if (generoSelect && dados.identidadeGenero) {
        const melhorOpcao = encontrarMelhorOpcao(generoSelect, dados.identidadeGenero);
        if (melhorOpcao) {
          if (definirValorSelect(generoSelect, melhorOpcao)) {
            camposPreenchidos++;
          }
        }
      }

      // ========================================
      // Ra√ßa/Cor
      // ========================================
      if (racaSelect && dados.racaCor) {
        const melhorOpcao = encontrarMelhorOpcao(racaSelect, dados.racaCor);
        if (melhorOpcao) {
          if (definirValorSelect(racaSelect, melhorOpcao)) {
            camposPreenchidos++;
          }
        }
      }

      // ========================================
      // Orienta√ß√£o Sexual
      // ========================================
      if (orientacaoSelect && dados.orientacaoSexual) {
        const melhorOpcao = encontrarMelhorOpcao(orientacaoSelect, dados.orientacaoSexual);
        if (melhorOpcao) {
          if (definirValorSelect(orientacaoSelect, melhorOpcao)) {
            camposPreenchidos++;
          }
        }
      }

      // ========================================
      // PCD/Transtorno
      // ========================================
      transtornosSelecionados = [];

      if (pcdSelect && dados.pcdTranstorno) {
        const melhorOpcao = encontrarMelhorOpcao(pcdSelect, dados.pcdTranstorno);

        if (melhorOpcao) {
          if (definirValorSelect(pcdSelect, melhorOpcao)) {
            camposPreenchidos++;

            // Se PCD = Sim, o listener do change deve abrir o container
            // Mas for√ßamos a verifica√ß√£o visual aqui para garantir
            if (melhorOpcao === 'Sim' && pcdDetalhesContainer) {
              pcdDetalhesContainer.classList.remove('hidden');

              // Preenche os transtornos selecionados
              if (dados.pcdDetalhes && dados.pcdDetalhes.trim()) {
                const transtornos = dados.pcdDetalhes.split(',').map(t => t.trim()).filter(t => t);
                transtornos.forEach(trans => {
                  if (!transtornosSelecionados.includes(trans)) {
                    transtornosSelecionados.push(trans);
                  }
                });
                // Incrementa contador s√≥ se realmente adicionou detalhes n√£o √© redundante
              }
            } else if (pcdDetalhesContainer) {
              pcdDetalhesContainer.classList.add('hidden');
            }
          }
        }
      }

      // Renderiza as tags (vazio ou com novos valores)
      if (typeof renderizarTagsTranstornos === 'function') {
        renderizarTagsTranstornos();
      }

      // Mostra notifica√ß√£o de sucesso se algum campo foi preenchido
      if (camposPreenchidos > 0) {
        mostrarNotificacaoAutofill(camposPreenchidos);
        console.log('[autofill] Sucesso! Campos preenchidos:', camposPreenchidos);

        // For√ßa valida√ß√£o visual de todos os campos preenchidos
        setTimeout(() => {
          if (typeof validarCampo === 'function') {
            [idadeInput, generoSelect, racaSelect, orientacaoSelect, pcdSelect].forEach(el => {
              if (el) validarCampo(el);
            });
          }
        }, 300);
      }
    }

    // Mostra notifica√ß√£o tempor√°ria de autofill
    function mostrarNotificacaoAutofill(qtdCampos) {
      // Remove notifica√ß√£o anterior se existir
      const notifAnterior = document.getElementById('autofill-notification');
      if (notifAnterior) {
        notifAnterior.remove();
      }

      const notif = document.createElement('div');
      notif.id = 'autofill-notification';
      notif.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in';
      notif.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>${qtdCampos} campo${qtdCampos > 1 ? 's' : ''} preenchido${qtdCampos > 1 ? 's' : ''} automaticamente</span>
      `;

      document.body.appendChild(notif);

      // Remove ap√≥s 3 segundos
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateY(10px)';
        notif.style.transition = 'opacity 0.3s, transform 0.3s';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // Fun√ß√£o helper para fechar modal com anima√ß√£o smooth
    function fecharModalPcdSugestoes() {
      const suggestionsDiv = document.getElementById('pcdDetalhes-suggestions');
      if (!suggestionsDiv.classList.contains('hidden')) {
        suggestionsDiv.classList.add('closing');
        setTimeout(() => {
          suggestionsDiv.classList.add('hidden');
          suggestionsDiv.classList.remove('closing');
        }, 350); // Dura√ß√£o da anima√ß√£o smooth (350ms para mais suavidade)
      }
    }

    // Filtra e mostra sugest√µes de transtornos
    function mostrarSugestoesTranstornos(query) {
      const suggestionsDiv = document.getElementById('pcdDetalhes-suggestions');

      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === ''
        ? transtornosPredefinidos.filter(trans => !transtornosSelecionados.includes(trans))
        : transtornosPredefinidos.filter(trans =>
          trans.toLowerCase().includes(query.toLowerCase()) &&
          !transtornosSelecionados.includes(trans)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhum transtorno encontrado. Pressione <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Enter</kbd> para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
          suggestionsDiv.classList.remove('closing');
        } else {
          fecharModalPcdSugestoes();
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(trans => `
        <div
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-all duration-200 border-b border-gray-100 last:border-0 active:bg-blue-100"
          onclick="adicionarTranstorno('${trans.replace(/'/g, "\\'")}')"
        >
          ${trans}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
      suggestionsDiv.classList.remove('closing');
    }

    // ========================================
    // SISTEMA DE ENCAMINHAMENTOS COM TAGS
    // ========================================
    const encaminhamentosPredefinidos = [
      'CT',
      'Sa√∫de',
      'UBS',
      'US',
      'NAAM',
      'Educa√ß√£o',
      'Escola',
      'DEAM',
      'DACLE',
      'DPCA',
      'Defensoria P√∫blica',
      'DEPI',
      'Minist√©rio P√∫blico',
      'CRAS',
      'CREAS',
      'CAPSIN',
      'Casa Rosa',
      'Vara da Inf√¢ncia',
      'Assist√™ncia Social',
      'Psic√≥logo',
      'Outras Delegacias',
      'Outros'
    ];

    let encaminhamentosSelecionados = [];

    // Renderiza as tags selecionadas
    function renderizarTags() {
      const container = document.getElementById('encaminhamentos-tags');
      const hiddenInput = document.getElementById('encaminhamento');

      if (encaminhamentosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum encaminhamento adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = encaminhamentosSelecionados.map((enc, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm transition-all duration-200 hover:bg-red-200 hover:shadow-md hover:scale-105">
          ${enc}
          <button 
            type="button" 
            data-index="${index}"
            onclick="removerEncaminhamento(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-all duration-200 active:scale-90">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = encaminhamentosSelecionados.join(', ');
    }

    // Remove um encaminhamento
    function removerEncaminhamento(index) {
      const container = document.getElementById('encaminhamentos-tags');
      const tags = container.querySelectorAll('span');
      const tagToRemove = tags[index];

      if (tagToRemove) {
        tagToRemove.classList.add('tag-removing');
        setTimeout(() => {
          encaminhamentosSelecionados.splice(index, 1);
          renderizarTags();

          // Salva automaticamente ap√≥s remover tag
          if (typeof AutoSave !== 'undefined') {
            AutoSave.salvar();
          }
        }, 300);
      }
    }

    // Adiciona um encaminhamento
    function adicionarEncaminhamento(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed,
        encaminhamentosPredefinidos,
        encaminhamentosSelecionados
      );

      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;

      // Evita duplicatas
      if (!encaminhamentosSelecionados.includes(valorFinal)) {
        encaminhamentosSelecionados.push(valorFinal);
        renderizarTags();

        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }

      // Limpa input
      document.getElementById('encaminhamento-input').value = '';
      document.getElementById('encaminhamento-suggestions').classList.add('hidden');
    }

    // Filtra e mostra sugest√µes
    function mostrarSugestoes(query) {
      const suggestionsDiv = document.getElementById('encaminhamento-suggestions');

      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === ''
        ? encaminhamentosPredefinidos.filter(enc => !encaminhamentosSelecionados.includes(enc))
        : encaminhamentosPredefinidos.filter(enc =>
          enc.toLowerCase().includes(query.toLowerCase()) &&
          !encaminhamentosSelecionados.includes(enc)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(enc => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-all duration-200 border-b border-gray-100 last:border-0 active:bg-red-100"
          onclick="adicionarEncaminhamento('${enc}')">
          ${enc}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    // ========================================
    // SISTEMA DE TAGS - RA√áA/COR
    // ========================================
    const racasCorPredefinidas = [
      'Branca',
      'Preta',
      'Parda',
      'Amarela',
      'Ind√≠gena',
      'N√£o informado'
    ];

    // ========================================
    // SISTEMA DE TAGS - TIPO DE VIOL√äNCIA
    // ========================================
    const tiposViolenciaPredefinidos = [
      'Autoprovocada',
      'Bullying',
      'Tortura',
      'Cyberbullying',
      'Financeira/Econ√¥mica',
      'F√≠sica',
      'Institucional',
      'Neglig√™ncia',
      'Psicol√≥gica',
      'Sexual',
      'Suposto Uso de Subst√¢ncias Il√≠citas',
      'Suspeita de envenenamento',
      'Trabalho Infantil',
      'Verbal',
      'Idea√ß√£o suicida',
      'Patrimonial',
      'Outra'
    ];

    let tiposViolenciaSelecionados = [];

    // Renderiza as tags de tipo de viol√™ncia
    function renderizarTagsTipoViolencia() {
      const container = document.getElementById('tipoViolencia-tags');
      const hiddenInput = document.getElementById('tipoViolencia');

      if (tiposViolenciaSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de viol√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = tiposViolenciaSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm transition-all duration-200 hover:bg-red-200 hover:shadow-md hover:scale-105">
          ${tipo}
          <button 
            type="button" 
            data-index="${index}"
            onclick="removerTipoViolencia(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-all duration-200 active:scale-90">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = tiposViolenciaSelecionados.join(', ');
    }

    // Remove um tipo de viol√™ncia
    function removerTipoViolencia(index) {
      const container = document.getElementById('tipoViolencia-tags');
      const tags = container.querySelectorAll('span');
      const tagToRemove = tags[index];

      if (tagToRemove) {
        tagToRemove.classList.add('tag-removing');
        setTimeout(() => {
          tiposViolenciaSelecionados.splice(index, 1);
          renderizarTagsTipoViolencia();

          // Salva automaticamente ap√≥s remover tag
          if (typeof AutoSave !== 'undefined') {
            AutoSave.salvar();
          }
        }, 300);
      }
    }

    // Adiciona um tipo de viol√™ncia
    function adicionarTipoViolencia(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed,
        tiposViolenciaPredefinidos,
        tiposViolenciaSelecionados
      );

      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;

      // Evita duplicatas
      if (!tiposViolenciaSelecionados.includes(valorFinal)) {
        tiposViolenciaSelecionados.push(valorFinal);
        renderizarTagsTipoViolencia();

        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }

      // Limpa input
      document.getElementById('tipoViolencia-input').value = '';
      document.getElementById('tipoViolencia-suggestions').classList.add('hidden');
    }

    // Filtra e mostra sugest√µes de tipo de viol√™ncia
    function mostrarSuggestoesTipoViolencia(query) {
      const suggestionsDiv = document.getElementById('tipoViolencia-suggestions');

      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === ''
        ? tiposViolenciaPredefinidos.filter(tipo => !tiposViolenciaSelecionados.includes(tipo))
        : tiposViolenciaPredefinidos.filter(tipo =>
          tipo.toLowerCase().includes(query.toLowerCase()) &&
          !tiposViolenciaSelecionados.includes(tipo)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-all duration-200 border-b border-gray-100 last:border-0 active:bg-red-100"
          onclick="adicionarTipoViolencia('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    // ========================================
    // SISTEMA DE TAGS - TIPO DE VIOL√äNCIA INSTITUCIONAL (CONDICIONAL)
    // ========================================
    let tiposViolenciaInstitucionalSelecionados = [];
    let tiposViolenciaInstitucionalDisponiveis = []; // Ser√° preenchido com dados existentes da planilha

    // Renderiza as tags de tipo de viol√™ncia institucional
    function renderizarTagsViolenciaInstitucional() {
      const container = document.getElementById('tipoViolenciaInstitucional-tags');
      const hiddenInput = document.getElementById('tipoViolenciaInstitucional');

      if (!container || !hiddenInput) return;

      if (tiposViolenciaInstitucionalSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo adicionado</span>';
        hiddenInput.value = '';
        return;
      }

      container.innerHTML = tiposViolenciaInstitucionalSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium border border-indigo-200 shadow-sm transition-all duration-200 hover:bg-indigo-200 hover:shadow-md hover:scale-105">
          ${tipo}
          <button 
            type="button" 
            data-index="${index}"
            onclick="removerViolenciaInstitucional(${index})"
            class="hover:bg-indigo-200 rounded-full p-0.5 transition-all duration-200 active:scale-90">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');

      hiddenInput.value = tiposViolenciaInstitucionalSelecionados.join(', ');
    }

    // Remove um tipo de viol√™ncia institucional
    function removerViolenciaInstitucional(index) {
      const container = document.getElementById('tipoViolenciaInstitucional-tags');
      const tags = container.querySelectorAll('span');
      const tagToRemove = tags[index];

      if (tagToRemove) {
        tagToRemove.classList.add('tag-removing');
        setTimeout(() => {
          tiposViolenciaInstitucionalSelecionados.splice(index, 1);
          renderizarTagsViolenciaInstitucional();

          // Salva automaticamente ap√≥s remover tag
          if (typeof AutoSave !== 'undefined') {
            AutoSave.salvar();
          }
        }, 300);
      }
    }

    // Adiciona um tipo de viol√™ncia institucional
    function adicionarViolenciaInstitucional(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;

      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed,
        tiposViolenciaInstitucionalDisponiveis,
        tiposViolenciaInstitucionalSelecionados
      );

      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;

      if (!tiposViolenciaInstitucionalSelecionados.includes(valorFinal)) {
        tiposViolenciaInstitucionalSelecionados.push(valorFinal);
        renderizarTagsViolenciaInstitucional();

        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }

      const input = document.getElementById('tipoViolenciaInstitucional-input');
      const suggestions = document.getElementById('tipoViolenciaInstitucional-suggestions');
      if (input) input.value = '';
      if (suggestions) suggestions.classList.add('hidden');
    }

    // Filtra e mostra sugest√µes de tipo de viol√™ncia institucional
    function mostrarSugestoesViolenciaInstitucional(query) {
      const suggestionsDiv = document.getElementById('tipoViolenciaInstitucional-suggestions');
      if (!suggestionsDiv) return;

      // Se ainda n√£o carregou os dados dispon√≠veis, tenta carregar
      if (tiposViolenciaInstitucionalDisponiveis.length === 0) {
        carregarTiposViolenciaInstitucionalDisponiveis();
      }

      const filtrados = query.trim() === ''
        ? tiposViolenciaInstitucionalDisponiveis.filter(tipo => !tiposViolenciaInstitucionalSelecionados.includes(tipo))
        : tiposViolenciaInstitucionalDisponiveis.filter(tipo =>
          tipo.toLowerCase().includes(query.toLowerCase()) &&
          !tiposViolenciaInstitucionalSelecionados.includes(tipo)
        );

      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }

      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm transition-all duration-200 border-b border-gray-100 last:border-0 active:bg-indigo-100"
          onclick="adicionarViolenciaInstitucional('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');

      suggestionsDiv.classList.remove('hidden');
    }

    // Carrega tipos de viol√™ncia institucional dispon√≠veis da planilha (via dados j√° carregados)
    function carregarTiposViolenciaInstitucionalDisponiveis() {
      // Esta fun√ß√£o ser√° chamada quando os dados forem carregados do painel
      // Por enquanto, usa valores comuns
      tiposViolenciaInstitucionalDisponiveis = [
        'F√≠sica',
        'Psicol√≥gica',
        'Sexual',
        'Verbal',
        'Neglig√™ncia',
        'Patrimonial',
        'Bullying',
        'Cyberbullying',
        'N√£o informada'
      ];
    }

    // Verifica se "Institucional" est√° selecionado no tipo de viol√™ncia
    function verificarViolenciaInstitucional() {
      const tipoViolenciaInput = document.getElementById('tipoViolencia');
      const container = document.getElementById('tipoViolenciaInstitucionalContainer');

      if (!tipoViolenciaInput || !container) return;

      const tipoViolenciaValue = tipoViolenciaInput.value || '';
      const tiposSelecionados = tipoViolenciaValue.split(',').map(t => t.trim()).filter(t => t);
      const temInstitucional = tiposSelecionados.some(t => {
        const tLower = t.toLowerCase();
        return tLower === 'institucional' || tLower.includes('institucional');
      });

      if (temInstitucional) {
        container.classList.remove('hidden');
        // Anima√ß√£o ser√° feita por CSS quando .hidden for removido
        // Torna o campo obrigat√≥rio quando vis√≠vel
        const hiddenInput = document.getElementById('tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = true;
      } else {
        container.classList.add('hidden');
        // Limpa os tipos selecionados
        tiposViolenciaInstitucionalSelecionados = [];
        renderizarTagsViolenciaInstitucional();
        // Limpa input
        const input = document.getElementById('tipoViolenciaInstitucional-input');
        if (input) input.value = '';
        // Remove obrigatoriedade quando oculto
        const hiddenInput = document.getElementById('tipoViolenciaInstitucional');
        if (hiddenInput) hiddenInput.required = false;
      }
    }

    // Torna as fun√ß√µes acess√≠veis globalmente
    window.adicionarViolenciaInstitucional = adicionarViolenciaInstitucional;
    window.removerViolenciaInstitucional = removerViolenciaInstitucional;
    window.verificarViolenciaInstitucional = verificarViolenciaInstitucional;

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
      if (mobileMenu) {
        mobileMenu.classList.toggle('show');
        if (menuIcon) {
          menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
        }
      }
    }

    // Fecha o menu mobile ao clicar em qualquer link
    document.addEventListener('DOMContentLoaded', function () {
      // Inicializa Flatpickr para o campo de data
      const dataNTInput = document.getElementById('dataNT');
      if (dataNTInput) {
        flatpickr(dataNTInput, {
          locale: 'pt',
          dateFormat: 'd/m/Y',
          altInput: true,
          altFormat: 'd/m/Y',
          allowInput: true,
          disableMobile: true,
          monthSelectorType: 'static',
          prevArrow: '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>',
          nextArrow: '<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>',
          onReady: function (selectedDates, dateStr, instance) {
            instance.calendarContainer.classList.add('flatpickr-custom');
          }
        });
      }

      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function () {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
          if (mobileMenu) {
            mobileMenu.classList.remove('show');
            if (menuIcon) {
              menuIcon.style.transform = 'rotate(0deg)';
            }
          }
        });
      });

      // Event delegation para bot√µes de remover tags (fallback)
      document.body.addEventListener('click', function (e) {
        const button = e.target.closest('button[data-index]');
        if (!button) return;

        const index = parseInt(button.getAttribute('data-index'));
        if (isNaN(index)) return;

        // Identifica qual tipo de tag est√° sendo removida
        const container = button.closest('#pcdDetalhes-tags, #encaminhamentos-tags, #tipoViolencia-tags, #tipoViolenciaInstitucional-tags');
        if (!container) return;

        e.preventDefault();
        e.stopPropagation();

        if (container.id === 'pcdDetalhes-tags' && typeof removerTranstorno === 'function') {
          removerTranstorno(index);
        } else if (container.id === 'encaminhamentos-tags' && typeof removerEncaminhamento === 'function') {
          removerEncaminhamento(index);
        } else if (container.id === 'tipoViolencia-tags' && typeof removerTipoViolencia === 'function') {
          removerTipoViolencia(index);
        } else if (container.id === 'tipoViolenciaInstitucional-tags' && typeof removerViolenciaInstitucional === 'function') {
          removerViolenciaInstitucional(index);
        }
      });
    });

    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function () {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          if (menuIcon) {
            menuIcon.style.transform = 'rotate(0deg)';
          }
        }
      }
    });

    // ========================================
    // CONTROLE CONDICIONAL DO CAMPO PCD DETALHES
    // ========================================
    document.addEventListener('DOMContentLoaded', function () {
      const pcdTranstornoSelect = document.getElementById('pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('pcdDetalhes-input');
      const pcdDetalhesHidden = document.getElementById('pcdDetalhes');

      // Renderiza estado inicial das tags
      renderizarTagsTranstornos();
      renderizarTagsTipoViolencia();
      renderizarTagsViolenciaInstitucional();
      carregarTiposViolenciaInstitucionalDisponiveis();

      // Configura menu baseado no role
      verificarMenuAdmin();
      verificarAutenticacao();

      // Listener para mostrar/ocultar campo de detalhes
      pcdTranstornoSelect.addEventListener('change', function () {
        if (this.value === 'Sim') {
          // Mostra o campo de detalhes
          pcdDetalhesContainer.classList.remove('hidden');
        } else {
          // Esconde o campo de detalhes
          pcdDetalhesContainer.classList.add('hidden');
          // Limpa os transtornos selecionados
          transtornosSelecionados = [];
          renderizarTagsTranstornos();
          // Limpa input
          pcdDetalhesInput.value = '';
          // Remove classe de erro se houver
          pcdDetalhesInput.classList.remove('field-error');
          document.getElementById('pcdDetalhes-tags').classList.remove('field-error');
        }
      });

      // Configura eventos do input de transtornos
      // Mostra todas op√ß√µes ao focar no campo vazio
      pcdDetalhesInput.addEventListener('focus', function (e) {
        mostrarSugestoesTranstornos(e.target.value);
      });

      // Filtra sugest√µes ao digitar
      pcdDetalhesInput.addEventListener('input', function (e) {
        mostrarSugestoesTranstornos(e.target.value);
      });

      // Adiciona ao pressionar Enter
      pcdDetalhesInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTranstorno(e.target.value);
        }
      });

      // Esconde sugest√µes ao clicar fora com anima√ß√£o
      document.addEventListener('click', function (e) {
        if (!e.target.closest('#pcdDetalhes-input') && !e.target.closest('#pcdDetalhes-suggestions')) {
          fecharModalPcdSugestoes();
        }
      });

      // Esconde sugest√µes ao scrollar fora do modal (com delay para suavidade)
      let scrollTimeout;
      document.addEventListener('scroll', function (e) {
        const suggestionsDiv = document.getElementById('pcdDetalhes-suggestions');

        // Se o modal est√° vis√≠vel e o scroll n√£o √© dentro do pr√≥prio modal
        if (!suggestionsDiv.classList.contains('hidden') && e.target !== suggestionsDiv) {
          // Limpa timeout anterior se existir
          if (scrollTimeout) {
            clearTimeout(scrollTimeout);
          }

          // Aguarda o scroll terminar antes de fechar (scroll primeiro, depois fecha)
          scrollTimeout = setTimeout(() => {
            fecharModalPcdSugestoes();
          }, 250); // Delay de 250ms - scroll acontece suavemente, depois o modal fecha
        }
      }, true); // Use capture phase para pegar todos os scrolls

      // === Eventos para Tipo de Viol√™ncia ===
      const tipoViolenciaInput = document.getElementById('tipoViolencia-input');

      tipoViolenciaInput.addEventListener('focus', function (e) {
        mostrarSuggestoesTipoViolencia(e.target.value);
      });

      tipoViolenciaInput.addEventListener('input', function (e) {
        mostrarSuggestoesTipoViolencia(e.target.value);
      });

      tipoViolenciaInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolencia(e.target.value);
        }
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#tipoViolencia-input') && !e.target.closest('#tipoViolencia-suggestions')) {
          document.getElementById('tipoViolencia-suggestions').classList.add('hidden');
        }
      });

      // === L√≥gica Condicional para Viol√™ncia Institucional ===
      // Listener no campo tipoViolencia para verificar se "Institucional" est√° selecionado
      const tipoViolenciaHiddenInput = document.getElementById('tipoViolencia');
      if (tipoViolenciaHiddenInput) {
        // Verifica quando o campo muda (incluindo quando tags s√£o adicionadas/removidas)
        const observer = new MutationObserver(function () {
          verificarViolenciaInstitucional();
        });

        // Observa mudan√ßas no campo oculto
        observer.observe(tipoViolenciaHiddenInput, { attributes: true, attributeFilter: ['value'] });

        // Tamb√©m verifica quando tags s√£o renderizadas
        const originalRenderizar = window.renderizarTagsTipoViolencia;
        if (originalRenderizar) {
          window.renderizarTagsTipoViolencia = function () {
            originalRenderizar();
            setTimeout(verificarViolenciaInstitucional, 100);
          };
        }

        // Verifica inicialmente
        setTimeout(verificarViolenciaInstitucional, 500);
      }

      // === Eventos para Tipo de Viol√™ncia Institucional ===
      const tipoViolenciaInstitucionalInput = document.getElementById('tipoViolenciaInstitucional-input');

      if (tipoViolenciaInstitucionalInput) {
        tipoViolenciaInstitucionalInput.addEventListener('focus', function (e) {
          mostrarSugestoesViolenciaInstitucional(e.target.value);
        });

        tipoViolenciaInstitucionalInput.addEventListener('input', function (e) {
          mostrarSugestoesViolenciaInstitucional(e.target.value);
        });

        tipoViolenciaInstitucionalInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            adicionarViolenciaInstitucional(e.target.value);
          }
        });

        document.addEventListener('click', function (e) {
          if (!e.target.closest('#tipoViolenciaInstitucional-input') && !e.target.closest('#tipoViolenciaInstitucional-suggestions')) {
            const suggestions = document.getElementById('tipoViolenciaInstitucional-suggestions');
            if (suggestions) suggestions.classList.add('hidden');
          }
        });
      }

      // === Eventos para Nome da Crian√ßa ===
      // Carrega nomes do cache ao inicializar a p√°gina
      carregarNomesChildrenCache();

      const criancaEstudanteInput = document.getElementById('criancaEstudante');
      if (criancaEstudanteInput) {
        // Mostra sugest√µes ao digitar
        criancaEstudanteInput.addEventListener('input', function (e) {
          mostrarSugestoesChild(e.target.value);
        });

        // Mostra sugest√µes ao focar
        criancaEstudanteInput.addEventListener('focus', function (e) {
          if (e.target.value.trim()) {
            mostrarSugestoesChild(e.target.value);
          }
        });

        // Esconde sugest√µes ao clicar fora
        document.addEventListener('click', function (e) {
          if (!e.target.closest('#criancaEstudante') && !e.target.closest('#criancaEstudante-suggestions')) {
            document.getElementById('criancaEstudante-suggestions').classList.add('hidden');
          }
        });
      }
    });

    // Configura eventos do input
    document.addEventListener('DOMContentLoaded', function () {
      const input = document.getElementById('encaminhamento-input');

      // Renderiza estado inicial
      renderizarTags();

      // Mostra todas op√ß√µes ao focar no campo vazio
      input.addEventListener('focus', function (e) {
        mostrarSugestoes(e.target.value);
      });

      // Filtra sugest√µes ao digitar
      input.addEventListener('input', function (e) {
        mostrarSugestoes(e.target.value);
      });

      // Adiciona ao pressionar Enter
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarEncaminhamento(e.target.value);
        }
      });

      // Esconde sugest√µes ao clicar fora
      document.addEventListener('click', function (e) {
        if (!e.target.closest('#encaminhamento-input') && !e.target.closest('#encaminhamento-suggestions')) {
          document.getElementById('encaminhamento-suggestions').classList.add('hidden');
        }
      });
    });

    // ========================================
    const instituicoes = [
      // CMEIs (51 unidades)
      { tipo: "CMEI", nomeOriginal: "CMEI Ana Maria Chaves Colares" },
      { tipo: "CMEI", nomeOriginal: "CMEI Anisio Spinola Teixeira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Cecilia Meireles" },
      { tipo: "CMEI", nomeOriginal: "CMEI Darcy Castello de Mendonca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Darcy Vargas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dr Pedro Feu Rosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ernestina Pessoa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Georgina da Trindade Faria" },
      { tipo: "CMEI", nomeOriginal: "CMEI Gilda de Athayde Ramos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Joao Pedro de Aguiar" },
      { tipo: "CMEI", nomeOriginal: "CMEI Laurentina Mendonca Correa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lidia Rocha Feitosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lizandre Ignes Carpanedo do Carmo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Marlene Orlande Simonetti" },
      { tipo: "CMEI", nomeOriginal: "CMEI Nelcy da Silva Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ocarlina Nunes Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Odila Simoes" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Sophia Musengny Loureiro" },
      { tipo: "CMEI", nomeOriginal: "CMEI Reinaldo Ridolfi" },
      { tipo: "CMEI", nomeOriginal: "CMEI Rubem Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Sinclair Phillips" },
      { tipo: "CMEI", nomeOriginal: "CMEI Terezinha Vasconcellos Salvador" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Aecio Bispo dos Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Alvaro Fernandes Lima" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Carlita Correa Pereira" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Denizart Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Dom Joao Batista da Motta e Albuquerque" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Dr Thomaz Tommasi" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Eldina Maria Soares Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Geisla da Cruz Militao" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Jacy Alves Fraga" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Jacyntha Ferreira de Souza Simoes" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Luiz Carlos Grecco" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Luiza Pereira Muniz Correa" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Magnolia Dias Miranda Cunha" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Maria Goretti Coutinho Cosme" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Maria Nazareth Menegueli" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Menino Jesus" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Padre Giovanni Bartesaghi" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Professor Carlos Alberto Martinelli de Souza" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Professora Cida Barreto" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Robson Jose Nassur Peixoto" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Rubens Duarte de Albuquerque" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Rubens Jose Vervloet Gomes" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Sebastiao Perovano" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Silvanete da Silva Rosa Rocha" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Valdivia da Penha Antunes Rodrigues" },
      { tipo: "CMEI", nomeOriginal: "CMEI Yolanda Lucas da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zelia Vianna de Aguiar" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zenaide Genoveva Marcarini Cavalcanti" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zilmar Alves de Melo" },

      // EMEFs (55 unidades)
      { tipo: "EMEF", nomeOriginal: "EMEF Adao Benezath" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adevalni Sysesmundo Ferreira de Azevedo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adilson da Silva Castro" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alberto de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvaro de Castro Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvimar Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Aristobulo Barbosa Leao" },
      { tipo: "EMEF", nomeOriginal: "EMEF Arthur da Costa e Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Castelo Branco" },
      { tipo: "EMEF", nomeOriginal: "EMEF Ceciliano Abel de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Custodia Dias de Campos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eber Louzada Zippinotti" },
      { tipo: "EMEF", nomeOriginal: "EMEF EJA Prof Admardo Serafim de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eliane Rodrigues dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Elzira Vivacqua dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Experimental de Vitoria - UFES" },
      { tipo: "EMEF", nomeOriginal: "EMEF Francisco Lacerda de Aguiar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Heloisa Abreu Judice de Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Irma Jacinta Soares de Souza Lima" },
      { tipo: "EMEF", nomeOriginal: "EMEF Juscelino Kubitschek de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Lenir Borlot" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marechal Mascarenhas de Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Jose Costa Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Leonor Pereira da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Madalena de Oliveira Domingues" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marieta Escobar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Mauro Braga" },
      { tipo: "EMEF", nomeOriginal: "EMEF Neusa Nunes Goncalves" },
      { tipo: "EMEF", nomeOriginal: "EMEF Octacilio Lomba" },
      { tipo: "EMEF", nomeOriginal: "EMEF Orlandina D'Almeida Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF Otto Ewald Junior" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Anchieta" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Guido Ceotto" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prezideu Amorim" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Joao Bandeira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Maria Stella de Novaes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Vercenilio da Silva Pascoal" },
      { tipo: "EMEF", nomeOriginal: "EMEF Professora Regina Maria Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Rita de Cassia Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Sao Vicente de Paulo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Suzete Cuendet" },
      { tipo: "EMEF", nomeOriginal: "EMEF Tancredo de Almeida Neves" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Amilton Monteiro da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Anacleta Schneider Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Edna de Mattos Siqueira Gaudio" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Izaura Marques da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Aureo Monjardim" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Lemos de Miranda" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Moacyr Avidos" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Reglus Neves Freire" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Roberto Vieira Gomes" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Professora Eunice Pereira Silveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Ronaldo Soares" },
      { tipo: "EMEF", nomeOriginal: "EMEF Zilda Andrade" }
    ];

    // ========================================
    // GERAR SIGLAS AUTOMATICAMENTE
    // ========================================
    function gerarSigla(nomeCompleto) {
      // Remove o prefixo CMEI/EMEF e TI
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');

      // Palavras que devem ser ignoradas ao gerar siglas
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];

      // Separa as palavras e pega as iniciais das palavras importantes
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');

      return sigla;
    }

    // Adiciona siglas a cada institui√ß√£o
    instituicoes.forEach(inst => {
      inst.sigla = gerarSigla(inst.nomeOriginal);
    });

    // ========================================
    // VARI√ÅVEIS DE CONTROLE DO AUTOCOMPLETE
    // ========================================
    let tipoSelecionado = '';
    let instituicoesFiltradas = [];
    let indiceSelecionado = -1;

    // ========================================
    // ELEMENTOS DO DOM
    // ========================================
    const tipoInstituicaoSelect = document.getElementById('tipoInstituicao');
    const cmeiEmefInput = document.getElementById('cmeiEmef');
    const autocompleteList = document.getElementById('autocompleteList');

    // ========================================
    // EVENTO: Mudan√ßa no tipo de institui√ß√£o
    // ========================================
    tipoInstituicaoSelect.addEventListener('change', function () {
      tipoSelecionado = this.value;

      if (tipoSelecionado) {
        // Habilita o campo de institui√ß√£o
        cmeiEmefInput.disabled = false;
        cmeiEmefInput.placeholder = 'Digite para buscar...';
        cmeiEmefInput.value = '';

        // Filtra institui√ß√µes pelo tipo ANTES do focus (sen√£o focus v√™ lista vazia)
        instituicoesFiltradas = getInstituicoesFiltradas(tipoSelecionado);
        console.log('[Escolas] Tipo selecionado:', tipoSelecionado, '| Institui√ß√µes:', instituicoesFiltradas.length);

        // Atualiza indicador com quantidade filtrada por tipo
        atualizarIndicadorFiltro();

        // Agora faz focus e mostra a lista (instituicoesFiltradas ja esta populado)
        cmeiEmefInput.focus();
        if (instituicoesFiltradas.length > 0) {
          renderizarSugestoes(instituicoesFiltradas);
        }

        // Limpa regi√£o ao trocar tipo
        const regiaoDisplay = document.getElementById('regiao-display');
        const regiaoHidden = document.getElementById('regiao');
        if (regiaoDisplay) regiaoDisplay.value = '';
        if (regiaoHidden) regiaoHidden.value = '';
      } else {
        // Desabilita o campo de institui√ß√£o
        cmeiEmefInput.disabled = true;
        cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
        cmeiEmefInput.value = '';
        autocompleteList.classList.remove('show');

        // Limpa regi√£o
        const regiaoDisplay = document.getElementById('regiao-display');
        const regiaoHidden = document.getElementById('regiao');
        if (regiaoDisplay) regiaoDisplay.value = '';
        if (regiaoHidden) regiaoHidden.value = '';
      }
    });

    // ========================================
    // EVENTO: Input no campo de autocomplete
    // ========================================
    cmeiEmefInput.addEventListener('input', function () {
      const termo = this.value.trim();
      indiceSelecionado = -1;

      // Se campo vazio, mostra TODAS as institui√ß√µes filtradas por tipo (sem aplicar filter de texto)
      if (termo.length === 0) {
        // Mostra todas as escolas do tipo selecionado
        renderizarSugestoes(instituicoesFiltradas);
        return;
      }

      // Filtra as institui√ß√µes com base no termo
      const resultados = filtrarInstituicoes(termo);

      // Renderiza as sugest√µes
      renderizarSugestoes(resultados);
    });

    // ========================================
    // EVENTO: Focus no campo mostra lista
    // ========================================
    cmeiEmefInput.addEventListener('focus', function () {
      // Se h√° institui√ß√µes filtradas e campo vazio ou com texto, mostra a lista
      if (instituicoesFiltradas.length > 0) {
        const termo = this.value.trim();
        if (termo.length === 0) {
          // Mostra todas as escolas do tipo selecionado
          renderizarSugestoes(instituicoesFiltradas);
        } else {
          // Filtra pelo termo atual
          const resultados = filtrarInstituicoes(termo);
          renderizarSugestoes(resultados);
        }
      }
    });

    // ========================================
    // EVENTO: Navega√ß√£o por teclado
    // ========================================
    cmeiEmefInput.addEventListener('keydown', function (e) {
      const items = autocompleteList.querySelectorAll('.autocomplete-item');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        indiceSelecionado = Math.min(indiceSelecionado + 1, items.length - 1);
        atualizarSelecaoVisual(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        indiceSelecionado = Math.max(indiceSelecionado - 1, -1);
        atualizarSelecaoVisual(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (indiceSelecionado >= 0 && items[indiceSelecionado]) {
          items[indiceSelecionado].click();
        }
      } else if (e.key === 'Escape') {
        autocompleteList.classList.remove('show');
      }
    });

    // ========================================
    // EVENTO: Clique fora fecha autocomplete
    // ========================================
    document.addEventListener('click', function (e) {
      if (!cmeiEmefInput.contains(e.target) && !autocompleteList.contains(e.target)) {
        autocompleteList.classList.remove('show');
      }
    });

    // ========================================
    // FUN√á√ÉO: Filtrar institui√ß√µes
    // ========================================
    function filtrarInstituicoes(termo) {
      const termoLower = removerAcentos(termo.toLowerCase());
      const termoSemEspacos = termoLower.replace(/\s+/g, '');

      return instituicoesFiltradas.filter(inst => {
        const nomeNormalizado = removerAcentos(inst.nomeOriginal.toLowerCase());
        // Prote√ß√£o para sigla undefined
        const sigla = inst.sigla || gerarSigla(inst.nomeOriginal);
        const siglaNormalizada = removerAcentos(sigla.toLowerCase());

        // Busca por palavras no nome
        const palavras = termoLower.split(' ').filter(p => p.length > 0);
        const matchPorPalavras = palavras.every(palavra => nomeNormalizado.includes(palavra));

        // Busca pela sigla (sem espa√ßos)
        const matchPorSigla = siglaNormalizada.includes(termoSemEspacos);

        // Busca pela sigla com caracteres consecutivos (ex: "ACM" encontra "Ana Chaves Mendes")
        const matchPorIniciaisConsecutivas = siglaNormalizada.startsWith(termoSemEspacos);

        return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
      });
    }

    // ========================================
    // FUN√á√ÉO: Remover acentos
    // ========================================
    function removerAcentos(texto) {
      return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // ========================================
    // FUN√á√ÉO: Renderizar sugest√µes
    // ========================================
    function renderizarSugestoes(resultados) {
      autocompleteList.innerHTML = '';

      if (resultados.length === 0) {
        autocompleteList.innerHTML = '<div class="no-results">üîç Nenhuma institui√ß√£o encontrada</div>';
        autocompleteList.classList.add('show');
        return;
      }

      // Mostra todas as escolas, sem limite de exibicao
      const totalResultados = resultados.length;

      if (totalResultados > 5) {
        const header = document.createElement('div');
        header.className = 'autocomplete-header text-xs text-gray-500 px-3 py-2 bg-gray-50 border-b';
        header.innerHTML = `üìã ${totalResultados} escola${totalResultados > 1 ? 's' : ''} dispon√≠ve${totalResultados > 1 ? 'is' : 'l'} - digite para filtrar`;
        autocompleteList.appendChild(header);
      }

      resultados.forEach((inst, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';

        // Badge do tipo
        const badge = document.createElement('span');
        badge.className = `autocomplete-badge ${inst.tipo.toLowerCase()}`;
        badge.textContent = inst.tipo;

        // Container para nome e sigla
        const infoContainer = document.createElement('div');
        infoContainer.className = 'flex flex-col';

        // Nome sem a redund√¢ncia da sigla
        const nomeSemTipo = inst.nomeOriginal.replace(inst.tipo + ' ', '');
        const nomeSpan = document.createElement('span');
        nomeSpan.className = 'autocomplete-nome';
        nomeSpan.textContent = nomeSemTipo;

        // Sigla (menor e em cinza)
        const siglaSpan = document.createElement('span');
        siglaSpan.className = 'text-xs text-gray-500 mt-0.5';
        siglaSpan.textContent = inst.sigla ? `Sigla: ${inst.sigla}` : '';

        infoContainer.appendChild(nomeSpan);
        infoContainer.appendChild(siglaSpan);

        item.appendChild(badge);
        item.appendChild(infoContainer);

        // Evento de clique
        item.addEventListener('click', function () {
          selecionarInstituicao(inst);
        });

        autocompleteList.appendChild(item);
      });

      autocompleteList.classList.add('show');
    }

    // ========================================
    // FUN√á√ÉO: Selecionar institui√ß√£o
    // ========================================
    function selecionarInstituicao(inst) {
      // Define o valor completo original no campo (para envio ao backend)
      cmeiEmefInput.value = inst.nomeOriginal;

      // Fecha a lista
      autocompleteList.classList.remove('show');

      // Remove classe de erro se houver
      cmeiEmefInput.classList.remove('field-error');

      // ====== AUTO-PREENCHIMENTO DE REGI√ÉO ======
      // Prioriza a regi√£o que vem do banco de dados (inst.regiao = school_region)
      let regiao = inst.regiao || '';

      // Fallback: busca regi√£o via m√≥dulo caso inst.regiao esteja vazio
      if (!regiao && window.NAVMEscolasTecnico) {
        regiao = window.NAVMEscolasTecnico.getRegiaoEscola(inst.nomeOriginal) || '';
        if (regiao) console.log('[Escolas] Regi√£o obtida via fallback (getRegiaoEscola):', regiao);
      }

      const regiaoDisplay = document.getElementById('regiao-display');
      const regiaoHidden = document.getElementById('regiao');

      if (regiao) {
        if (regiaoDisplay) regiaoDisplay.value = regiao;
        if (regiaoHidden) regiaoHidden.value = regiao;
        console.log('[Escolas] Regi√£o preenchida do banco de dados:', regiao);
      } else {
        if (regiaoDisplay) regiaoDisplay.value = '';
        if (regiaoHidden) regiaoHidden.value = '';
        console.warn('[Escolas] Regi√£o n√£o encontrada para:', inst.nomeOriginal);
      }
    }

    // ========================================
    // FUN√á√ÉO: Atualizar sele√ß√£o visual
    // ========================================
    function atualizarSelecaoVisual(items) {
      items.forEach((item, index) => {
        if (index === indiceSelecionado) {
          item.classList.add('active');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          item.classList.remove('active');
        }
      });
    }

    // ========================================
    // SISTEMA DE FILTRO DE ESCOLAS POR T√âCNICO
    // ========================================
    let mostrandoTodasEscolas = false;
    let escolasDisponiveis = [];

    /**
     * Inicializa o sistema de filtro de escolas por t√©cnico
     */
    /**
     * Mostra/atualiza indicador de status do carregamento de escolas
     */
    function mostrarStatusEscolas(mensagem, tipo) {
      let statusEl = document.getElementById('status-carregamento-escolas');
      if (!statusEl) {
        // Cria o elemento na primeira vez, inserido abaixo do autocomplete-wrapper
        const wrapper = document.querySelector('.autocomplete-wrapper');
        if (!wrapper) return;
        statusEl = document.createElement('div');
        statusEl.id = 'status-carregamento-escolas';
        statusEl.className = 'mt-1.5 text-xs flex items-center gap-1.5 transition-all duration-300';
        wrapper.parentNode.insertBefore(statusEl, wrapper.nextSibling);
      }

      if (tipo === 'loading') {
        statusEl.className = 'mt-1.5 text-xs flex items-center gap-1.5 transition-all duration-300 text-blue-600';
        statusEl.innerHTML = '<span class="inline-block w-3 h-3 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></span>' + mensagem;
        statusEl.style.opacity = '1';
      } else if (tipo === 'success') {
        statusEl.className = 'mt-1.5 text-xs flex items-center gap-1.5 transition-all duration-300 text-green-600';
        statusEl.innerHTML = '<span>&#10003;</span> ' + mensagem;
        statusEl.style.opacity = '1';
        setTimeout(() => { statusEl.style.opacity = '0'; }, 4000);
      } else if (tipo === 'error') {
        statusEl.className = 'mt-1.5 text-xs flex items-center gap-1.5 transition-all duration-300 text-amber-600';
        statusEl.innerHTML = '<span>&#9888;</span> ' + mensagem;
        statusEl.style.opacity = '1';
        setTimeout(() => { statusEl.style.opacity = '0'; }, 6000);
      }
    }

    async function inicializarFiltroEscolas() {
      const userEmail = sessionStorage.getItem('userEmail');
      const userRole = sessionStorage.getItem('userRole');
      const userName = sessionStorage.getItem('userName'); // PRIORIDADE: usar nome do usuario

      console.log('[Escolas] Inicializando filtro de escolas...');
      console.log('[Escolas] Nome:', userName, '| Email:', userEmail, '| Role:', userRole);

      // Verifica se o modulo esta disponivel
      if (!window.NAVMEscolasTecnico) {
        console.warn('[Escolas] Modulo NAVMEscolasTecnico nao carregado. Usando lista padrao.');
        return;
      }

      // Feedback visual: carregando
      mostrarStatusEscolas('Carregando escolas...', 'loading');

      // Carrega escolas do usuario (agora async) - PRIORIZA NOME sobre EMAIL
      escolasDisponiveis = await window.NAVMEscolasTecnico.getEscolasUsuario(userEmail, userRole, mostrandoTodasEscolas, userName);
      console.log('[Escolas] Total de escolas disponiveis:', escolasDisponiveis.length);

      // Feedback visual: resultado
      if (escolasDisponiveis.length > 0) {
        mostrarStatusEscolas(escolasDisponiveis.length + ' escolas carregadas', 'success');
      } else {
        mostrarStatusEscolas('Nenhuma escola encontrada', 'error');
      }

      // Verifica se √© t√©cnico para mostrar bot√£o "Ver Todas"
      const isTecnico = userRole === 'tecnico';

      if (isTecnico) {
        const filtroContainer = document.getElementById('filtro-escolas-container');
        const filtroAtivoContainer = document.getElementById('filtroAtivoContainer');

        if (filtroContainer) filtroContainer.classList.remove('hidden');
        if (filtroAtivoContainer) filtroAtivoContainer.classList.remove('hidden');

        // Identifica o t√©cnico - PRIORIZA NOME sobre EMAIL
        let tecnico = null;
        if (userName) {
          tecnico = window.NAVMEscolasTecnico.identificarTecnicoPorNome(userName);
        }
        if (!tecnico && userEmail) {
          tecnico = window.NAVMEscolasTecnico.identificarTecnico(userEmail);
        }

        if (tecnico) {
          console.log('[Escolas] T√©cnico identificado:', tecnico);
          atualizarIndicadorFiltro();
        } else {
          console.warn('[Escolas] T√©cnico n√£o identificado. Nome:', userName, '| Email:', userEmail);
        }
      }

      // Configura evento do bot√£o "Ver Todas"
      const btnVerTodas = document.getElementById('btnVerTodasEscolas');
      if (btnVerTodas) {
        btnVerTodas.addEventListener('click', toggleVerTodasEscolas);
      }

      // Se um tipo ja estava selecionado (ex: rascunho restaurado antes do async),
      // re-popula a lista de instituicoes agora que escolasDisponiveis esta carregado
      const tipoAtual = tipoInstituicaoSelect ? tipoInstituicaoSelect.value : '';
      if (tipoAtual && escolasDisponiveis.length > 0) {
        tipoSelecionado = tipoAtual;
        instituicoesFiltradas = getInstituicoesFiltradas(tipoAtual);
        console.log(`[Escolas] Re-sync pos-load: tipo="${tipoAtual}", ${instituicoesFiltradas.length} instituicoes`);
        atualizarIndicadorFiltro();
      }
    }

    /**
     * Alterna entre ver todas as escolas e apenas as do t√©cnico
     */
    async function toggleVerTodasEscolas() {
      mostrandoTodasEscolas = !mostrandoTodasEscolas;

      const userEmail = sessionStorage.getItem('userEmail');
      const userRole = sessionStorage.getItem('userRole');
      const userName = sessionStorage.getItem('userName'); // Usa nome do usuario

      // Feedback visual
      mostrarStatusEscolas(mostrandoTodasEscolas ? 'Carregando todas as escolas...' : 'Carregando suas escolas...', 'loading');

      // Recarrega escolas com o novo estado (agora async) - PRIORIZA NOME sobre EMAIL
      escolasDisponiveis = await window.NAVMEscolasTecnico.getEscolasUsuario(userEmail, userRole, mostrandoTodasEscolas, userName);

      // Feedback visual: resultado
      mostrarStatusEscolas(escolasDisponiveis.length + ' escolas ' + (mostrandoTodasEscolas ? 'totais' : 'atribuidas'), 'success');

      // Atualiza UI do bot√£o
      const btnTexto = document.getElementById('btnVerTodasText');
      const btnIcone = document.getElementById('btnVerTodasIcone');

      if (mostrandoTodasEscolas) {
        if (btnTexto) btnTexto.textContent = 'Minhas Escolas';
        if (btnIcone) btnIcone.textContent = 'üë§';
      } else {
        if (btnTexto) btnTexto.textContent = 'Ver Todas';
        if (btnIcone) btnIcone.textContent = 'üåê';
      }

      // Limpa campo de escola e regi√£o
      const cmeiEmefInput = document.getElementById('cmeiEmef');
      const regiaoDisplay = document.getElementById('regiao-display');
      const regiaoHidden = document.getElementById('regiao');

      if (cmeiEmefInput) cmeiEmefInput.value = '';
      if (regiaoDisplay) regiaoDisplay.value = '';
      if (regiaoHidden) regiaoHidden.value = '';

      // Re-filtra institui√ß√µes se um tipo j√° estiver selecionado
      if (tipoSelecionado) {
        instituicoesFiltradas = getInstituicoesFiltradas(tipoSelecionado);
      }

      // Atualiza indicador DEPOIS de re-filtrar (para mostrar quantidade correta por tipo)
      atualizarIndicadorFiltro();

      console.log('[Escolas] Toggle Ver Todas:', mostrandoTodasEscolas, '| Total filtrado:', instituicoesFiltradas.length);
    }

    /**
     * Atualiza o indicador visual de filtro ativo
     * Usa instituicoesFiltradas (filtrado por tipo) quando dispon√≠vel
     */
    function atualizarIndicadorFiltro() {
      const indicador = document.getElementById('filtroAtivoIndicador');
      const texto = document.getElementById('filtroAtivoTexto');

      if (!indicador || !texto) return;

      // Usa a quantidade filtrada por tipo se houver tipo selecionado
      const quantidadeExibida = tipoSelecionado && instituicoesFiltradas.length > 0
        ? instituicoesFiltradas.length
        : escolasDisponiveis.length;

      const tipoTexto = tipoSelecionado ? ` (${tipoSelecionado})` : '';

      if (mostrandoTodasEscolas) {
        indicador.className = 'text-xs text-orange-600 flex items-center gap-1';
        texto.textContent = `Mostrando todas as ${quantidadeExibida} escolas${tipoTexto}`;
      } else {
        indicador.className = 'text-xs text-green-600 flex items-center gap-1';
        texto.textContent = `Mostrando suas ${quantidadeExibida} escolas atribu√≠das${tipoTexto}`;
      }
    }

    /**
     * Obt√©m institui√ß√µes filtradas por tipo usando o m√≥dulo de escolas
     * @param {string} tipo - "CMEI" ou "EMEF"
     * @returns {Array} Institui√ß√µes filtradas com sigla
     */
    function getInstituicoesFiltradas(tipo) {
      let escolasFiltradas;

      if (!window.NAVMEscolasTecnico) {
        // Fallback para lista local se modulo nao estiver disponivel
        escolasFiltradas = instituicoes.filter(inst => inst.tipo === tipo);
      } else {
        // Filtra escolas disponiveis pelo tipo (ja carregadas via async inicializarFiltroEscolas)
        escolasFiltradas = escolasDisponiveis.filter(inst => inst.tipo === tipo);
      }

      // Garante que todas as escolas tenham a propriedade sigla
      escolasFiltradas.forEach(inst => {
        if (!inst.sigla) {
          inst.sigla = gerarSigla(inst.nomeOriginal);
        }
      });

      return escolasFiltradas;
    }

    // Inicializa o filtro de escolas quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
      // Aguarda um pequeno delay para garantir que os m√≥dulos foram carregados
      setTimeout(inicializarFiltroEscolas, 100);
    });

    // ========================================
    // M√ìDULO DE AUTO-SAVE
    // ========================================
    const AutoSave = {
      CHAVE_STORAGE: 'rascunho_novo_caso',
      DEBOUNCE_TIMEOUT: null,
      DEBOUNCE_DELAY: 1000, // 1 segundo
      BACKUP_INTERVAL: null,
      BACKUP_DELAY: 30000, // 30 segundos

      // Inicializar sistema de auto-save
      inicializar() {
        console.log('üîÑ Inicializando auto-save...');

        // Carregar rascunho ao abrir p√°gina (aguarda um pouco para garantir que tudo est√° carregado)
        setTimeout(() => {
          this.carregarRascunho();
        }, 1000);

        // Configurar listeners para todos os campos
        this.configurarListeners();

        // Iniciar backup autom√°tico a cada 30s
        this.iniciarBackupAutomatico();

        // Salvar antes de sair da p√°gina
        window.addEventListener('beforeunload', () => this.salvar());
      },

      // Configurar eventos de salvamento
      configurarListeners() {
        // SALVAMENTO AUTOM√ÅTICO DESABILITADO
        // Agora s√≥ salva quando o usu√°rio clicar em "SALVAR AGORA"

        // Removi todos os listeners autom√°ticos
        // O salvamento agora √© 100% manual via bot√£o
      },

      // Salvamento com debounce (para campos de texto)
      salvarComDebounce() {
        clearTimeout(this.DEBOUNCE_TIMEOUT);
        this.DEBOUNCE_TIMEOUT = setTimeout(() => {
          this.salvar();
        }, this.DEBOUNCE_DELAY);
      },

      // Salvar dados no localStorage
      salvar() {
        try {
          const dados = this.coletarDados();

          // N√£o salva se n√£o houver dados
          if (Object.keys(dados).length === 0) {
            return;
          }

          const rascunho = {
            timestamp: Date.now(),
            versao: "1.0",
            dados: dados
          };

          localStorage.setItem(this.CHAVE_STORAGE, JSON.stringify(rascunho));

          // Atualizar indicador visual
          this.atualizarIndicadorSalvamento(new Date());

          console.log('üíæ Auto-save: rascunho salvo');

        } catch (error) {
          console.error('‚ùå Erro ao salvar rascunho:', error);
          if (error.name === 'QuotaExceededError') {
            console.warn('‚ö†Ô∏è localStorage cheio, tentando limpar e salvar novamente...');
            localStorage.removeItem(this.CHAVE_STORAGE);
            try {
              const dados = this.coletarDados();
              const rascunho = {
                timestamp: Date.now(),
                versao: "1.0",
                dados: dados
              };
              localStorage.setItem(this.CHAVE_STORAGE, JSON.stringify(rascunho));
              this.atualizarIndicadorSalvamento(new Date());
            } catch (e2) {
              console.error('‚ùå Erro persistente ao salvar:', e2);
            }
          }
        }
      },

      // Coletar dados de todos os campos
      coletarDados() {
        const dados = {};
        const form = document.getElementById('registroForm');
        if (!form) return dados;

        // Campos simples (input, select, textarea)
        form.querySelectorAll('input, select, textarea').forEach(campo => {
          // Ignora bot√µes e campos de input de tags
          if (campo.type === 'button' || campo.type === 'submit') return;
          if (campo.id && (campo.id.includes('-input') || campo.id.includes('-tags'))) return;

          const name = campo.name || campo.id;
          if (!name) return;

          let valor = '';

          if (campo.type === 'radio') {
            if (campo.checked) {
              dados[name] = campo.value;
            }
          } else if (campo.type === 'checkbox') {
            if (campo.checked) {
              dados[name] = campo.value;
            }
          } else if (campo.tagName === 'SELECT') {
            valor = campo.value || '';
            if (valor) dados[name] = valor;
          } else if (campo.type === 'hidden') {
            valor = campo.value || '';
            if (valor) dados[name] = valor;
          } else {
            valor = campo.value || '';
            if (valor && valor.trim() !== '') {
              dados[name] = valor;
            }
          }
        });

        // Campos hidden de tags (que cont√™m os valores reais)
        ['pcdDetalhes', 'tipoViolencia', 'tipoViolenciaInstitucional', 'encaminhamento'].forEach(id => {
          const campo = document.getElementById(id);
          if (campo && campo.value) {
            dados[id] = campo.value;
          }
        });

        // Arrays de tags (backup)
        if (typeof transtornosSelecionados !== 'undefined' && Array.isArray(transtornosSelecionados) && transtornosSelecionados.length > 0) {
          dados.transtornosSelecionados = [...transtornosSelecionados];
        }
        if (typeof tiposViolenciaSelecionados !== 'undefined' && Array.isArray(tiposViolenciaSelecionados) && tiposViolenciaSelecionados.length > 0) {
          dados.tiposViolenciaSelecionados = [...tiposViolenciaSelecionados];
        }
        if (typeof classificacoesSelecionadas !== 'undefined' && Array.isArray(classificacoesSelecionadas) && classificacoesSelecionadas.length > 0) {
          dados.classificacoesSelecionadas = [...classificacoesSelecionadas];
        }
        if (typeof motivacoesSelecionadas !== 'undefined' && Array.isArray(motivacoesSelecionadas) && motivacoesSelecionadas.length > 0) {
          dados.motivacoesSelecionadas = [...motivacoesSelecionadas];
        }
        if (typeof encaminhamentosSelecionados !== 'undefined' && Array.isArray(encaminhamentosSelecionados) && encaminhamentosSelecionados.length > 0) {
          dados.encaminhamentosSelecionados = [...encaminhamentosSelecionados];
        }
        if (typeof colaboradoresSelecionados !== 'undefined' && Array.isArray(colaboradoresSelecionados) && colaboradoresSelecionados.length > 0) {
          dados.colaboradoresSelecionados = [...colaboradoresSelecionados];
        }

        return dados;
      },

      // Carregar rascunho do localStorage
      carregarRascunho() {
        try {
          const rascunhoStr = localStorage.getItem(this.CHAVE_STORAGE);

          if (!rascunhoStr) {
            console.log('‚ÑπÔ∏è Nenhum rascunho encontrado');
            return;
          }

          const rascunho = JSON.parse(rascunhoStr);

          if (!rascunho.dados || Object.keys(rascunho.dados).length === 0) {
            console.log('‚ÑπÔ∏è Rascunho vazio encontrado');
            localStorage.removeItem(this.CHAVE_STORAGE);
            return;
          }

          console.log('üìÇ Carregando rascunho salvo em:', new Date(rascunho.timestamp));

          this.preencherFormulario(rascunho.dados);
          this.atualizarIndicadorSalvamento(new Date(rascunho.timestamp));

          // Mostrar notifica√ß√£o discreta
          this.mostrarNotificacaoRascunho(rascunho.timestamp);

        } catch (error) {
          console.error('‚ùå Erro ao carregar rascunho:', error);
          // Limpar rascunho corrompido
          localStorage.removeItem(this.CHAVE_STORAGE);
        }
      },

      // Preencher formul√°rio com dados salvos
      preencherFormulario(dados) {
        const form = document.getElementById('registroForm');
        if (!form) return;

        // Primeiro, restaurar campos normais
        Object.keys(dados).forEach(id => {
          // Ignora arrays de tags (ser√£o restaurados depois)
          if (id.endsWith('Selecionados') || id.endsWith('Selecionadas')) {
            return;
          }

          const valor = dados[id];
          if (valor === null || valor === undefined || valor === '') return;

          // Tenta encontrar por name primeiro
          let campo = form.querySelector(`[name="${id}"]`);

          // Se n√£o encontrar, tenta por id
          if (!campo) {
            campo = document.getElementById(id);
          }

          if (campo) {
            try {
              if (campo.type === 'radio') {
                // Radio buttons
                const radio = document.querySelector(`input[name="${id}"][value="${valor}"]`);
                if (radio) {
                  radio.checked = true;
                  radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
              } else if (campo.tagName === 'SELECT') {
                // Selects
                campo.value = valor;
                // Atualiza visualmente selects customizados
                const wrapper = campo.closest('.custom-select-wrapper');
                if (wrapper) {
                  const trigger = wrapper.querySelector('.custom-select-trigger');
                  if (trigger) {
                    const selectedOption = campo.options[campo.selectedIndex];
                    if (selectedOption) {
                      trigger.textContent = selectedOption.textContent;
                    }
                  }
                }
                // Disparar evento change para atualizar campos dependentes
                campo.dispatchEvent(new Event('change', { bubbles: true }));

                // Tratamento especial para campo PCD condicional
                if (id === 'pcdTranstorno') {
                  const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
                  if (pcdDetalhesContainer) {
                    if (valor === 'Sim') {
                      pcdDetalhesContainer.classList.remove('hidden');
                      // Anima√ß√£o ser√° feita por CSS quando .hidden for removido
                    } else {
                      pcdDetalhesContainer.classList.add('hidden');
                    }
                  }
                }

                // Tratamento especial para tipoInstituicao (habilita campo de autocomplete)
                if (id === 'tipoInstituicao') {
                  const cmeiEmefInput = document.getElementById('cmeiEmef');
                  if (cmeiEmefInput) {
                    cmeiEmefInput.disabled = !valor;
                    if (!valor) {
                      cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
                    } else {
                      cmeiEmefInput.placeholder = 'Digite para filtrar as institui√ß√µes dispon√≠veis';
                    }
                  }
                }
              } else if (campo.type === 'date') {
                // Campos de data
                campo.value = valor;
              } else if (campo.type === 'hidden') {
                // Campos hidden (tags)
                campo.value = valor;
              } else {
                // Campos normais
                campo.value = valor;
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è Erro ao restaurar campo', id, ':', e);
            }
          }
        });

        // Aguarda um pouco e depois restaura tags
        setTimeout(() => {
          // Restaurar arrays de tags
          if (dados.transtornosSelecionados && Array.isArray(dados.transtornosSelecionados)) {
            if (typeof transtornosSelecionados !== 'undefined') {
              transtornosSelecionados = [...dados.transtornosSelecionados];
              if (typeof renderizarTagsTranstornos === 'function') {
                renderizarTagsTranstornos();
              }
            }
          }

          if (dados.tiposViolenciaSelecionados && Array.isArray(dados.tiposViolenciaSelecionados)) {
            if (typeof tiposViolenciaSelecionados !== 'undefined') {
              tiposViolenciaSelecionados = [...dados.tiposViolenciaSelecionados];
              if (typeof renderizarTagsTipoViolencia === 'function') {
                renderizarTagsTipoViolencia();
              }
            }
          }

          if (dados.tiposViolenciaInstitucionalSelecionados && Array.isArray(dados.tiposViolenciaInstitucionalSelecionados)) {
            if (typeof tiposViolenciaInstitucionalSelecionados !== 'undefined') {
              tiposViolenciaInstitucionalSelecionados = [...dados.tiposViolenciaInstitucionalSelecionados];
              if (typeof renderizarTagsViolenciaInstitucional === 'function') {
                renderizarTagsViolenciaInstitucional();
              }
            }
          }

          if (dados.encaminhamentosSelecionados && Array.isArray(dados.encaminhamentosSelecionados)) {
            if (typeof encaminhamentosSelecionados !== 'undefined') {
              encaminhamentosSelecionados = [...dados.encaminhamentosSelecionados];
              if (typeof renderizarTags === 'function') {
                renderizarTags();
              }
            }
          }

          // Restaurar colaboradores selecionados
          if (dados.colaboradoresSelecionados && Array.isArray(dados.colaboradoresSelecionados)) {
            if (typeof colaboradoresSelecionados !== 'undefined') {
              colaboradoresSelecionados = [...dados.colaboradoresSelecionados];
              if (typeof renderizarTagsColaboradores === 'function') {
                renderizarTagsColaboradores();
              }
            }
          }

          // Restaurar tags a partir de strings (campos hidden)
          if (dados.pcdDetalhes) {
            this.recriarTags('pcdDetalhes', dados.pcdDetalhes);
          }
          if (dados.tipoViolencia) {
            this.recriarTags('tipoViolencia', dados.tipoViolencia);
          }
          if (dados.tipoViolenciaInstitucional) {
            this.recriarTags('tipoViolenciaInstitucional', dados.tipoViolenciaInstitucional);
          }
          if (dados.encaminhamento) {
            this.recriarTags('encaminhamento', dados.encaminhamento);
          }

          // Atualizar progresso
          if (typeof atualizarProgresso === 'function') {
            atualizarProgresso();
          }
        }, 300);
      },

      // Recriar tags visuais a partir de string salva
      recriarTags(campoId, valorString) {
        if (!valorString) return;

        // Separa por v√≠rgula e limpa espa√ßos
        const valores = valorString.split(',').map(v => v.trim()).filter(v => v);

        // Determinar qual sistema de tags usar baseado no ID
        let funcaoAdicionar;
        if (campoId === 'pcdDetalhes') {
          funcaoAdicionar = window.adicionarTranstorno;
        } else if (campoId === 'tipoViolencia') {
          funcaoAdicionar = window.adicionarTipoViolencia;
        } else if (campoId === 'tipoViolenciaInstitucional') {
          funcaoAdicionar = window.adicionarViolenciaInstitucional;
        } else if (campoId === 'encaminhamento') {
          funcaoAdicionar = window.adicionarEncaminhamento;
        }

        if (funcaoAdicionar) {
          valores.forEach(valor => {
            try {
              funcaoAdicionar(valor);
            } catch (e) {
              console.warn('‚ö†Ô∏è Erro ao recriar tag', valor, ':', e);
            }
          });
        }
      },

      // Observar mudan√ßas nos sistemas de tags
      observarMudancasTags() {
        // Observar mudan√ßas nos campos hidden de tags
        ['pcdDetalhes', 'tipoViolencia', 'tipoViolenciaInstitucional', 'encaminhamento'].forEach(id => {
          const campo = document.getElementById(id);
          if (campo) {
            // Usar MutationObserver para detectar mudan√ßas no value
            const observer = new MutationObserver(() => this.salvar());
            observer.observe(campo, { attributes: true, attributeFilter: ['value'] });

            // Tamb√©m observar mudan√ßas diretas
            campo.addEventListener('change', () => this.salvar());

            // Observar mudan√ßas no input event tamb√©m
            const inputCampo = document.getElementById(id + '-input');
            if (inputCampo) {
              inputCampo.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                  setTimeout(() => this.salvar(), 100);
                }
              });
            }
          }
        });
      },

      // Iniciar backup autom√°tico
      iniciarBackupAutomatico() {
        this.BACKUP_INTERVAL = setInterval(() => {
          this.salvar();
          console.log('‚è∞ Backup autom√°tico executado');
        }, this.BACKUP_DELAY);
      },

      // Atualizar indicador visual de salvamento
      atualizarIndicadorSalvamento(data) {
        const indicador = document.getElementById('indicadorRascunho');
        if (!indicador) return;

        const tempo = this.formatarTempoRelativo(data);
        indicador.innerHTML = `
          <span class="text-xs text-green-600 flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Rascunho salvo ${tempo}
          </span>
        `;
        indicador.classList.remove('hidden');
      },

      // Mostrar notifica√ß√£o discreta de rascunho carregado
      mostrarNotificacaoRascunho(timestamp) {
        const tempo = this.formatarTempoRelativo(new Date(timestamp));

        if (typeof mostrarAlerta === 'function') {
          mostrarAlerta(`üìÇ Rascunho recuperado (salvo ${tempo})`, 'info');
        }
      },

      // Formatar tempo relativo (ex: "h√° 2 minutos")
      formatarTempoRelativo(data) {
        const agora = new Date();
        const diff = agora - data;
        const segundos = Math.floor(diff / 1000);
        const minutos = Math.floor(segundos / 60);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);

        if (segundos < 60) return 'agora h√° pouco';
        if (minutos < 60) return `h√° ${minutos} minuto${minutos > 1 ? 's' : ''}`;
        if (horas < 24) return `h√° ${horas} hora${horas > 1 ? 's' : ''}`;
        if (dias < 7) return `h√° ${dias} dia${dias > 1 ? 's' : ''}`;
        return `em ${data.toLocaleDateString('pt-BR')}`;
      },

      // Limpar rascunho
      limpar() {
        localStorage.removeItem(this.CHAVE_STORAGE);
        console.log('üóëÔ∏è Rascunho limpo');

        const indicador = document.getElementById('indicadorRascunho');
        if (indicador) {
          indicador.classList.add('hidden');
        }

        // Atualizar status antigo tamb√©m (compatibilidade)
        if (typeof atualizarStatusRascunho === 'function') {
          atualizarStatusRascunho(false);
        }
      },

      // Parar backup autom√°tico (ao sair da p√°gina)
      parar() {
        if (this.BACKUP_INTERVAL) {
          clearInterval(this.BACKUP_INTERVAL);
          this.BACKUP_INTERVAL = null;
        }
        if (this.DEBOUNCE_TIMEOUT) {
          clearTimeout(this.DEBOUNCE_TIMEOUT);
          this.DEBOUNCE_TIMEOUT = null;
        }
      }
    };

    // Fun√ß√µes de compatibilidade (manter para n√£o quebrar c√≥digo existente)
    function salvarRascunho() {
      AutoSave.salvar();
    }

    function limparRascunho() {
      AutoSave.limpar();
    }

    function carregarRascunho() {
      AutoSave.carregarRascunho();
    }

    // Fun√ß√£o de compatibilidade para atualizarStatusRascunho (mantida para compatibilidade)
    function atualizarStatusRascunho(temRascunho) {
      if (temRascunho) {
        try {
          const rascunhoStr = localStorage.getItem(AutoSave.CHAVE_STORAGE);
          if (rascunhoStr) {
            const rascunho = JSON.parse(rascunhoStr);
            const draftStatus = document.getElementById('draftStatus');
            const draftLastSave = document.getElementById('draftLastSave');
            if (draftStatus) draftStatus.classList.remove('hidden');
            if (draftLastSave) draftLastSave.textContent = `Salvo: ${new Date(rascunho.timestamp).toLocaleString('pt-BR')}`;
          }
        } catch (e) {
          const draftStatus = document.getElementById('draftStatus');
          if (draftStatus) draftStatus.classList.add('hidden');
        }
      } else {
        const draftStatus = document.getElementById('draftStatus');
        if (draftStatus) draftStatus.classList.add('hidden');
      }
    }

    // ========================================
    // INDICADOR DE PROGRESSO
    // ========================================
    function calcularProgresso() {
      const form = document.getElementById('registroForm');
      const camposObrigatorios = form.querySelectorAll('[required]');

      // Agrupa radio buttons por name para evitar contagem duplicada
      const gruposRadioProcessados = new Set();
      const camposUnicos = [];

      camposObrigatorios.forEach(campo => {
        if (campo.type === 'radio') {
          if (!gruposRadioProcessados.has(campo.name)) {
            gruposRadioProcessados.add(campo.name);
            camposUnicos.push(campo);
          }
        } else {
          camposUnicos.push(campo);
        }
      });

      const totalCampos = camposUnicos.length;
      let camposPreenchidos = 0;
      const camposPendentes = [];

      console.log('üìä Calculando progresso - Total de campos obrigat√≥rios:', totalCampos);

      camposUnicos.forEach(campo => {
        let preenchido = false;

        // Valida√ß√£o especial para campos hidden de tags ANTES da valida√ß√£o padr√£o
        // tipoViolencia (sempre obrigat√≥rio)
        if (campo.id === 'tipoViolencia' || campo.name === 'tipoViolencia') {
          const valorHidden = campo.value && campo.value.trim() !== '';
          const temArray = typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0;
          preenchido = valorHidden || temArray;
        }
        // pcdDetalhes (obrigat√≥rio apenas se PCD = Sim)
        else if (campo.id === 'pcdDetalhes' || campo.name === 'pcdDetalhes') {
          const pcdTranstorno = document.getElementById('pcdTranstorno')?.value || '';
          if (pcdTranstorno === 'Sim') {
            const valorHidden = campo.value && campo.value.trim() !== '';
            const temArray = typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0;
            preenchido = valorHidden || temArray;
          } else {
            preenchido = true; // N√£o √© obrigat√≥rio se PCD = N√£o
          }
        }
        // Valida√ß√£o padr√£o para outros campos
        else if (campo.type === 'radio') {
          // Para radio buttons, verifica se ALGUMA op√ß√£o foi selecionada (incluindo "N√£o informado" com value="")
          const radioGroup = form.querySelectorAll(`input[type="radio"][name="${campo.name}"]`);
          const algumSelecionado = Array.from(radioGroup).find(radio => radio.checked);
          preenchido = !!algumSelecionado;

          // Log para debug de radio buttons
          if (!preenchido && campo.hasAttribute('required')) {
            console.log('‚ö†Ô∏è Radio button obrigat√≥rio n√£o selecionado:', {
              name: campo.name,
              grupo: Array.from(radioGroup).map(r => ({ value: r.value, checked: r.checked }))
            });
          }
        } else if (campo.type === 'checkbox') {
          preenchido = campo.checked;
        } else if (campo.tagName === 'SELECT') {
          preenchido = campo.value && campo.value !== '' && campo.value !== 'Selecione...';
        } else if (campo.type === 'hidden') {
          // Campos hidden devem ter valor n√£o vazio
          preenchido = campo.value && campo.value.trim() !== '';
        } else {
          preenchido = campo.value && campo.value.trim() !== '';
        }

        if (preenchido) {
          camposPreenchidos++;
        } else {
          // Tenta encontrar o label de forma mais robusta
          let label = '';

          // Para radio buttons, pega o label do grupo (n√£o da op√ß√£o espec√≠fica)
          if (campo.type === 'radio') {
            const labelElement = form.querySelector(`label[for="${campo.name}"]`) ||
              campo.closest('div')?.querySelector('label:not([for])') ||
              campo.closest('fieldset')?.querySelector('legend');
            if (labelElement) {
              label = labelElement.textContent || '';
            }
          } else {
            label = campo.getAttribute('aria-label') ||
              campo.closest('div')?.querySelector('label')?.textContent ||
              campo.closest('label')?.textContent ||
              campo.name ||
              campo.id ||
              'Campo';
          }

          // Limpa o label: remove asteriscos, checkmarks, e espa√ßos extras
          label = label.replace(/\*/g, '')
            .replace(/[‚úì‚úî]/g, '')
            .replace(/\s+/g, ' ')
            .trim();

          // Se ainda n√£o tem label √∫til, usa o name ou id
          if (!label || label.length < 2) {
            label = campo.name || campo.id || 'Campo';
          }

          if (label && !camposPendentes.includes(label)) {
            camposPendentes.push(label);
            console.log('‚ö†Ô∏è Campo pendente detectado:', {
              id: campo.id,
              name: campo.name,
              type: campo.type,
              value: campo.value,
              label: label
            });
          }
        }
      });

      console.log('üìä Progresso calculado:', {
        preenchidos: camposPreenchidos,
        total: totalCampos,
        percentual: Math.round((camposPreenchidos / totalCampos) * 100),
        pendentes: camposPendentes
      });

      const percentual = totalCampos > 0 ? Math.round((camposPreenchidos / totalCampos) * 100) : 0;

      return {
        percentual,
        camposPreenchidos,
        totalCampos,
        camposPendentes: camposPendentes.slice(0, 5) // Limita a 5 para n√£o poluir a UI
      };
    }

    function atualizarProgresso() {
      const progressIndicator = document.getElementById('progressIndicator');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressDetails = document.getElementById('progressDetails');

      const progresso = calcularProgresso();

      // Mostra o indicador se houver algum preenchimento com anima√ß√£o suave
      if (progresso.camposPreenchidos > 0 || progresso.percentual > 0) {
        // Remove a classe hidden para ativar a anima√ß√£o
        if (progressIndicator.classList.contains('hidden')) {
          progressIndicator.classList.remove('hidden');
        }
      }

      // Atualiza barra de progresso com transi√ß√£o suave
      if (progressBar) {
        progressBar.style.transition = 'width 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
        progressBar.style.width = `${progresso.percentual}%`;
      }

      // Atualiza texto
      progressText.textContent = `${progresso.camposPreenchidos} de ${progresso.totalCampos} campos obrigat√≥rios preenchidos (${progresso.percentual}%)`;

      // Atualiza detalhes
      if (progresso.camposPendentes.length > 0) {
        progressDetails.innerHTML = `
          <span class="font-semibold text-gray-700">Pendentes:</span>
          <span class="text-gray-600">${progresso.camposPendentes.join(', ')}${progresso.camposPendentes.length >= 5 ? '...' : ''}</span>
        `;
      } else if (progresso.percentual === 100) {
        progressDetails.innerHTML = '<span class="text-green-600 font-semibold">‚úÖ Todos os campos obrigat√≥rios preenchidos!</span>';
      } else {
        progressDetails.innerHTML = '';
      }

      // Muda cor da barra baseado no progresso
      if (progresso.percentual === 100) {
        progressBar.className = 'bg-gradient-to-r from-green-500 via-green-600 to-emerald-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else if (progresso.percentual >= 75) {
        progressBar.className = 'bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else if (progresso.percentual >= 50) {
        progressBar.className = 'bg-gradient-to-r from-yellow-500 via-yellow-600 to-orange-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else {
        progressBar.className = 'bg-gradient-to-r from-red-500 via-red-600 to-pink-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      }
    }

    // ========================================
    // VALIDA√á√ÉO INTELIGENTE
    // ========================================
    function validarInteligente() {
      const erros = [];
      const avisos = [];

      // 1. Valida√ß√£o de Idade vs Data da Notifica√ß√£o
      const idade = parseInt(document.getElementById('idade')?.value || '0', 10);
      const dataNT = document.getElementById('dataNT')?.value;

      if (dataNT && !isNaN(idade) && idade > 0) {
        const dataNotificacao = new Date(dataNT);
        const hoje = new Date();
        const anoNascimentoEstimado = hoje.getFullYear() - idade;
        const dataNascimentoEstimada = new Date(anoNascimentoEstimado, hoje.getMonth(), hoje.getDate());
        const idadeCalculada = Math.floor((hoje - dataNascimentoEstimada) / (365.25 * 24 * 60 * 60 * 1000));

        if (Math.abs(idadeCalculada - idade) > 1) {
          avisos.push(`‚ö†Ô∏è A idade informada (${idade} anos) pode estar inconsistente com a data da notifica√ß√£o. Verifique se est√° correta.`);
        }
      }

      // 2. Valida√ß√£o de Data Futura
      if (dataNT) {
        // Converte data no formato dd/mm/yyyy para Date object
        // Formato esperado: "02/01/2026"
        const [dia, mes, ano] = dataNT.split('/');
        const dataNotificacao = new Date(ano, mes - 1, dia); // mes - 1 porque janeiro √© 0

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        dataNotificacao.setHours(0, 0, 0, 0);

        // DEBUG: log das datas para verificar
        console.log('[validacao] Data digitada:', dataNT);
        console.log('[validacao] Data parseada:', dataNotificacao.toLocaleDateString('pt-BR'));
        console.log('[validacao] Data hoje:', hoje.toLocaleDateString('pt-BR'));
        console.log('[validacao] Compara√ß√£o (dataNotificacao > hoje):', dataNotificacao > hoje);

        if (dataNotificacao > hoje) {
          erros.push('‚ùå A data da notifica√ß√£o n√£o pode ser futura. Por favor, corrija a data.');
          const campoData = document.getElementById('dataNT');
          if (campoData) {
            campoData.classList.add('field-error');
          }
        }
      }

      // 3. Valida√ß√£o de Idade M√≠nima/M√°xima
      if (!isNaN(idade) && idade > 0) {
        if (idade < 0 || idade > 120) {
          erros.push('‚ùå A idade deve estar entre 0 e 120 anos.');
          const campoIdade = document.getElementById('idade');
          if (campoIdade) {
            campoIdade.classList.add('field-error');
          }
        } else if (idade < 3) {
          avisos.push('‚ö†Ô∏è A idade informada √© muito baixa. Verifique se est√° correta.');
        } else if (idade > 25) {
          avisos.push('‚ö†Ô∏è A idade informada √© muito alta para um estudante. Verifique se est√° correta.');
        }
      }

      // 4. Valida√ß√£o de Nome (m√≠nimo de caracteres)
      const nome = document.getElementById('criancaEstudante')?.value?.trim() || '';
      if (nome && nome.length < 3) {
        erros.push('‚ùå O nome deve ter pelo menos 3 caracteres.');
        const campoNome = document.getElementById('criancaEstudante');
        if (campoNome) {
          campoNome.classList.add('field-error');
        }
      } else if (nome && nome.split(' ').length < 2) {
        avisos.push('‚ö†Ô∏è Recomenda-se informar o nome completo (nome e sobrenome).');
      }

      // 5. Valida√ß√£o de Consist√™ncia: Ocorreu na Escola
      const ocorreuEscola = document.querySelector('input[name="ocorreuEscola"]:checked')?.value;
      const cmeiEmef = document.getElementById('cmeiEmef')?.value?.trim() || '';

      if (ocorreuEscola === 'Sim' && !cmeiEmef) {
        avisos.push('‚ö†Ô∏è Se a viol√™ncia ocorreu na escola, recomenda-se informar a escola.');
      }

      // 6. Valida√ß√£o de Consist√™ncia: Autor da Viol√™ncia
      const profissionalAutor = document.querySelector('input[name="profissionalAutor"]:checked')?.value;
      const estudanteAutor = document.querySelector('input[name="estudanteAutor"]:checked')?.value;

      if (profissionalAutor === 'Sim' && estudanteAutor === 'Sim') {
        avisos.push('‚ö†Ô∏è Verifique: tanto profissional quanto estudante foram marcados como autores. Isso √© poss√≠vel, mas confirme se est√° correto.');
      }

      if (profissionalAutor === 'N√£o' && estudanteAutor === 'N√£o' && ocorreuEscola === 'Sim') {
        avisos.push('‚ö†Ô∏è Se ocorreu na escola mas nenhum profissional nem estudante foi autor, verifique se h√° outro agente envolvido.');
      }

      return { erros, avisos };
    }

    // Fun√ß√£o de valida√ß√£o no frontend (atualizada)
    function validarFormulario() {
      const form = document.getElementById('registroForm');
      const camposObrigatorios = form.querySelectorAll('[required]');
      let valido = true;
      let primeiroErro = null; // Rastreia o primeiro campo com erro para scroll

      // Remove classes de erro anteriores
      camposObrigatorios.forEach(function (campo) {
        campo.classList.remove('field-error');
      });

      // Valida√ß√£o especial para tipoViolencia PRIMEIRO (campo obrigat√≥rio de tags)
      // Isso garante que se houver erro, ser√° o primeiro a ser scrollado
      const tipoViolenciaHidden = document.getElementById('tipoViolencia');
      const tipoViolenciaTagsContainer = document.getElementById('tipoViolencia-tags');
      const tipoViolenciaInput = document.getElementById('tipoViolencia-input');
      if (tipoViolenciaHidden && tipoViolenciaHidden.hasAttribute('required')) {
        const tipoViolenciaValue = tipoViolenciaHidden.value || '';
        const temTiposViolencia = (typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0) || tipoViolenciaValue.trim() !== '';

        if (!temTiposViolencia) {
          if (tipoViolenciaTagsContainer) {
            tipoViolenciaTagsContainer.classList.add('field-error');
            // Rastreia como primeiro erro se n√£o houver outro antes
            if (!primeiroErro) {
              primeiroErro = tipoViolenciaTagsContainer;
            }
          }
          valido = false;
        } else {
          if (tipoViolenciaTagsContainer) {
            tipoViolenciaTagsContainer.classList.remove('field-error');
          }
        }
      }

      // Valida cada campo obrigat√≥rio (exceto radio buttons, que t√™m valida√ß√£o especial)
      camposObrigatorios.forEach(function (campo) {
        // Ignora radio buttons - eles t√™m valida√ß√£o especial abaixo
        if (campo.type === 'radio') {
          return;
        }
        if (!campo.value || campo.value.trim() === '') {
          campo.classList.add('field-error');
          if (!primeiroErro) {
            primeiroErro = campo;
          }
          valido = false;
        }
      });

      // Valida√ß√£o especial para tipoViolenciaInstitucional (campo condicional obrigat√≥rio)
      const tipoViolenciaInstitucionalContainer = document.getElementById('tipoViolenciaInstitucionalContainer');
      const tipoViolenciaInstitucionalHidden = document.getElementById('tipoViolenciaInstitucional');
      const tipoViolenciaInstitucionalTagsContainer = document.getElementById('tipoViolenciaInstitucional-tags');

      // S√≥ valida se o container estiver vis√≠vel (ou seja, "Institucional" est√° selecionado)
      if (tipoViolenciaInstitucionalContainer && !tipoViolenciaInstitucionalContainer.classList.contains('hidden')) {
        const tipoViolenciaInstitucionalValue = tipoViolenciaInstitucionalHidden?.value || '';
        const temTiposViolenciaInstitucional = (typeof tiposViolenciaInstitucionalSelecionados !== 'undefined' && tiposViolenciaInstitucionalSelecionados.length > 0) || tipoViolenciaInstitucionalValue.trim() !== '';

        if (!temTiposViolenciaInstitucional) {
          if (tipoViolenciaInstitucionalTagsContainer) {
            tipoViolenciaInstitucionalTagsContainer.classList.add('field-error');
          }
          valido = false;
          mostrarAlerta('‚ùå Por favor, adicione pelo menos um tipo de viol√™ncia institucional.', 'error');
        } else {
          if (tipoViolenciaInstitucionalTagsContainer) {
            tipoViolenciaInstitucionalTagsContainer.classList.remove('field-error');
          }
        }
      }

      // Valida√ß√£o condicional: se PCD = Sim, ent√£o deve ter pelo menos um transtorno selecionado
      const pcdTranstorno = document.getElementById('pcdTranstorno')?.value || '';
      const pcdDetalhesHidden = document.getElementById('pcdDetalhes');
      const pcdDetalhesTagsContainer = document.getElementById('pcdDetalhes-tags');

      if (pcdTranstorno === 'Sim') {
        const temTranstornos = (typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0) ||
          (pcdDetalhesHidden && pcdDetalhesHidden.value && pcdDetalhesHidden.value.trim() !== '');

        if (!temTranstornos) {
          if (pcdDetalhesTagsContainer) {
            pcdDetalhesTagsContainer.classList.add('field-error');
          }
          valido = false;
        } else {
          // Remove classe de erro se estava presente
          if (pcdDetalhesTagsContainer) {
            pcdDetalhesTagsContainer.classList.remove('field-error');
          }
        }
      }

      // Valida√ß√£o especial para encaminhamento (campo obrigat√≥rio de tags)
      const encaminhamentoHidden = document.getElementById('encaminhamento');
      const encaminhamentoTagsContainer = document.getElementById('encaminhamentos-tags');
      if (encaminhamentoHidden && encaminhamentoHidden.hasAttribute('required')) {
        const encaminhamentoValue = encaminhamentoHidden.value || '';
        const temEncaminhamentos = (typeof encaminhamentosSelecionados !== 'undefined' && encaminhamentosSelecionados.length > 0) || encaminhamentoValue.trim() !== '';

        if (!temEncaminhamentos) {
          if (encaminhamentoTagsContainer) {
            encaminhamentoTagsContainer.classList.add('field-error');
          }
          valido = false;
        } else {
          if (encaminhamentoTagsContainer) {
            encaminhamentoTagsContainer.classList.remove('field-error');
          }
        }
      }

      // Valida√ß√£o para grupos de radio buttons obrigat√≥rios
      const ocorreuEscolaVisivel = document.getElementById('ocorreu-escola-wrapper')?.classList.contains('is-visible');
      const gruposRadioObrigatorios = [
        'foiMembroFamiliar',
        'fonteEscola',
        'violenciaEscolaOcorreu',
        'profissionalAutor',
        'estudanteAutor',
        'violenciaNaoEscola',
        ...(ocorreuEscolaVisivel ? ['ocorreuEscola'] : []),
        'violenciaInformada',
        'estudoCaso'
      ];

      gruposRadioObrigatorios.forEach(function (nomeGrupo) {
        const radios = form.querySelectorAll(`input[type="radio"][name="${nomeGrupo}"]`);
        const radioSelecionado = form.querySelector(`input[type="radio"][name="${nomeGrupo}"]:checked`);

        if (radios.length > 0 && radios[0].hasAttribute('required')) {
          if (!radioSelecionado) {
            // Adiciona classe de erro ao container do grupo
            radios.forEach(function (radio) {
              const container = radio.closest('.bg-white');
              if (container) {
                container.classList.add('field-error');
                container.style.borderColor = '#ef4444';
              }
            });
            valido = false;
          } else {
            // Remove classe de erro se estava presente
            radios.forEach(function (radio) {
              const container = radio.closest('.bg-white');
              if (container) {
                container.classList.remove('field-error');
                container.style.borderColor = '';
              }
            });
          }
        }
      });

      // Valida√ß√£o inteligente
      const validacaoInteligente = validarInteligente();

      // Mostra erros primeiro
      if (validacaoInteligente.erros.length > 0) {
        validacaoInteligente.erros.forEach(erro => {
          mostrarAlerta(erro, 'error');
        });
        valido = false;
      }

      // Depois mostra avisos (n√£o bloqueiam o envio)
      if (validacaoInteligente.avisos.length > 0) {
        validacaoInteligente.avisos.forEach(aviso => {
          mostrarAlerta(aviso, 'info');
        });
      }

      if (!valido) {

        // Scroll autom√°tico para o primeiro campo com erro
        if (primeiroErro) {
          // Aguarda um pouco para garantir que o alerta foi renderizado
          setTimeout(() => {
            console.log('üîç Tentando scroll para:', primeiroErro);

            // Tenta focar em um input dentro do elemento se houver
            const inputDentro = primeiroErro.querySelector('input');
            if (inputDentro && inputDentro.focus) {
              inputDentro.focus();
            }

            // Faz scroll do elemento para a vis√£o
            try {
              primeiroErro.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
              });
              console.log('‚úÖ Scroll executado com sucesso');
            } catch (e) {
              console.error('‚ùå Erro ao fazer scroll:', e);
              // Fallback: scroll simples para o topo do elemento
              window.scrollTo({
                top: primeiroErro.offsetTop - 100,
                behavior: 'smooth'
              });
            }
          }, 200); // Aumentado o delay para garantir que o alerta foi renderizado
        }
      }

      return valido;
    }

    // Fun√ß√£o para coletar dados do formul√°rio
    function coletarDadosFormulario() {
      const form = document.getElementById('registroForm');
      if (!form) {
        console.error('Formul√°rio n√£o encontrado!');
        return {};
      }

      const dados = {};

      // Coleta todos os campos do formul√°rio
      form.querySelectorAll('input, select, textarea').forEach(campo => {
        // Ignora bot√µes, arquivos e campos de input de tags
        if (campo.type === 'button' || campo.type === 'submit') return;
        if (campo.type === 'file') return; // Anexos s√£o enviados separadamente ap√≥s salvar
        if (campo.id && (campo.id.includes('-input') || campo.id.includes('-tags'))) return;

        const name = campo.name || campo.id;
        if (!name) return;

        let valor = '';

        if (campo.type === 'radio') {
          // Radio buttons - s√≥ salva se estiver marcado
          if (campo.checked) {
            // Para foiMembroFamiliar, aceita string vazia como "N√£o informado" (valor v√°lido)
            dados[name] = campo.value; // Inclui string vazia se for "N√£o informado"
          }
        } else if (campo.type === 'checkbox') {
          // Checkboxes - s√≥ salva se estiver marcado
          if (campo.checked) {
            dados[name] = campo.value;
          }
        } else if (campo.tagName === 'SELECT') {
          valor = campo.value || '';
          if (valor) dados[name] = valor;
        } else if (campo.type === 'hidden') {
          // Campos hidden (tags) - s√£o cr√≠ticos
          valor = campo.value || '';
          if (valor) dados[name] = valor;
        } else {
          valor = campo.value || '';
          if (valor && valor.trim() !== '') {
            dados[name] = valor;
          }
        }
      });

      // Garante que campos hidden de tags sejam coletados (backup)
      ['pcdDetalhes', 'tipoViolencia', 'tipoViolenciaInstitucional', 'encaminhamento'].forEach(id => {
        const campo = document.getElementById(id);
        if (campo && campo.value) {
          dados[id] = campo.value;
        }
      });

      // Se campos hidden de tags estiverem vazios mas arrays tiverem valores, preenche
      if (!dados.tipoViolencia || dados.tipoViolencia.trim() === '') {
        if (typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0) {
          dados.tipoViolencia = tiposViolenciaSelecionados.join(', ');
          console.log('üìù tipoViolencia preenchido a partir do array:', dados.tipoViolencia);
        }
      }
      if (!dados.tipoViolenciaInstitucional || dados.tipoViolenciaInstitucional.trim() === '') {
        if (typeof tiposViolenciaInstitucionalSelecionados !== 'undefined' && tiposViolenciaInstitucionalSelecionados.length > 0) {
          dados.tipoViolenciaInstitucional = tiposViolenciaInstitucionalSelecionados.join(', ');
        }
      }
      if (!dados.encaminhamento || dados.encaminhamento.trim() === '') {
        if (typeof encaminhamentosSelecionados !== 'undefined' && encaminhamentosSelecionados.length > 0) {
          dados.encaminhamento = encaminhamentosSelecionados.join(', ');
        }
      }
      if (!dados.pcdDetalhes || dados.pcdDetalhes.trim() === '') {
        if (typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0) {
          dados.pcdDetalhes = transtornosSelecionados.join(', ');
        }
      }

      // Garante que foiMembroFamiliar seja sempre enviado (mesmo que seja string vazia para "N√£o informado")
      if (!('foiMembroFamiliar' in dados)) {
        // Se n√£o foi coletado, verifica se algum radio est√° marcado
        const radioFoiMembro = form.querySelector('input[name="foiMembroFamiliar"]:checked');
        if (radioFoiMembro) {
          dados.foiMembroFamiliar = radioFoiMembro.value; // Pode ser "Sim", "N√£o" ou "" (N√£o informado)
        } else {
          // Se nenhum est√° marcado, n√£o envia (ser√° rejeitado pelo backend)
          console.warn('‚ö†Ô∏è foiMembroFamiliar n√£o foi selecionado');
        }
      }

      // Log detalhado dos campos obrigat√≥rios
      const camposObrigatorios = ['criancaEstudante', 'dataNT', 'idade', 'identidadeGenero', 'tipoViolencia', 'cmeiEmef', 'regiao', 'responsavelRegistro', 'foiMembroFamiliar'];
      console.log('üìã Status dos campos obrigat√≥rios:');
      camposObrigatorios.forEach(campo => {
        const valor = dados[campo];
        // Para foiMembroFamiliar, string vazia √© v√°lida (significa "N√£o informado")
        if (campo === 'foiMembroFamiliar') {
          const status = valor !== undefined && valor !== null ? '‚úÖ' : '‚ùå';
          console.log(`  ${status} ${campo}:`, valor === '' ? '(N√£o informado)' : (valor || '(n√£o selecionado)'));
        } else {
          const status = valor && valor.toString().trim() !== '' ? '‚úÖ' : '‚ùå';
          console.log(`  ${status} ${campo}:`, valor || '(vazio)');
        }
      });

      // Converte valores Sim/N√£o para S/N conforme necess√°rio
      const camposSimNao = ['fonteEscola', 'violenciaEscolaOcorreu', 'profissionalAutor', 'estudanteAutor',
        'violenciaNaoEscola', 'ocorreuEscola', 'violenciaInformada', 'estudoCaso'];
      camposSimNao.forEach(campo => {
        if (dados[campo] !== undefined) {
          dados[campo] = converterSimNao(dados[campo]);
        }
      });

      // Monta campo combinado autor/colaboradores usando "/" como separador
      const autorNome = (dados.responsavelRegistro || document.getElementById('responsavelRegistro')?.value || '').trim();
      const colaboradores = Array.isArray(colaboradoresSelecionados) ? colaboradoresSelecionados : [];
      dados.responsavelRegistro = [autorNome, ...colaboradores].filter(Boolean).join('/');
      // Mant√©m array de colaboradores por compatibilidade (se houver)
      if (colaboradores.length > 0) {
        dados.colaboradores = colaboradores;
      }

      console.log('üì§ Dados coletados para envio:', Object.keys(dados));

      return dados;
    }

    // ========================================
    // SISTEMA DE COLABORADORES
    // ========================================
    let colaboradoresSelecionados = [];
    let todosUsuarios = [];

    // Carregar nome do usu√°rio logado ao carregar a p√°gina
    async function carregarNomeUsuarioLogado() {
      try {
        const userEmail = sessionStorage.getItem('userEmail');
        if (!userEmail) {
          console.warn('Email do usu√°rio n√£o encontrado');
          return;
        }

        // PRIMEIRO: Verifica se o nome j√° est√° no sessionStorage
        let nomeUsuario = sessionStorage.getItem('userName');

        if (nomeUsuario) {
          // Nome j√° est√° no sessionStorage, usa diretamente
          const campoResponsavel = document.getElementById('responsavelRegistro');
          if (campoResponsavel) {
            campoResponsavel.value = nomeUsuario;
            campoResponsavel.readOnly = true;
            campoResponsavel.classList.remove('bg-yellow-50', 'cursor-text');
            campoResponsavel.classList.add('bg-green-50', 'cursor-not-allowed');
            console.log('‚úÖ Nome do usu√°rio carregado do sessionStorage:', nomeUsuario);
          }
          return;
        }

        // SEGUNDO: Se n√£o estiver no sessionStorage, busca do backend
        console.log('Nome n√£o encontrado no sessionStorage, buscando do backend...');
        const url = window.CONFIG.APPS_SCRIPT_CASOS;
        const dados = {
          action: 'buscarNomeUsuarioLogado',
          emailUsuario: userEmail
        };

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'data=' + encodeURIComponent(JSON.stringify(dados))
        });

        const resultado = await response.json();

        if (resultado.success && resultado.nome) {
          // Salva no sessionStorage para pr√≥ximas vezes
          sessionStorage.setItem('userName', resultado.nome);

          const campoResponsavel = document.getElementById('responsavelRegistro');
          if (campoResponsavel) {
            campoResponsavel.value = resultado.nome;
            campoResponsavel.readOnly = true;
            campoResponsavel.classList.remove('bg-yellow-50', 'cursor-text');
            campoResponsavel.classList.add('bg-green-50', 'cursor-not-allowed');
            console.log('‚úÖ Nome do usu√°rio carregado do backend e salvo:', resultado.nome);
          }
        } else {
          console.warn('Nome do usu√°rio n√£o encontrado no backend');
          const campoResponsavel = document.getElementById('responsavelRegistro');
          if (campoResponsavel) {
            // N√ÉO usa mais email.split('@')[0] - torna o campo edit√°vel para o usu√°rio preencher
            campoResponsavel.value = '';
            campoResponsavel.readOnly = false;
            campoResponsavel.classList.remove('bg-gray-50', 'cursor-not-allowed');
            campoResponsavel.classList.add('bg-yellow-50', 'cursor-text');
            campoResponsavel.placeholder = 'Digite o nome do respons√°vel';
            console.warn('‚ö†Ô∏è Campo tornou-se edit√°vel - usu√°rio deve preencher manualmente');
          }
        }
      } catch (error) {
        console.error('Erro ao carregar nome do usu√°rio:', error);
        const campoResponsavel = document.getElementById('responsavelRegistro');
        if (campoResponsavel) {
          // N√ÉO usa mais email.split('@')[0] - torna o campo edit√°vel para o usu√°rio preencher
          campoResponsavel.value = '';
          campoResponsavel.readOnly = false;
          campoResponsavel.classList.remove('bg-gray-50', 'cursor-not-allowed');
          campoResponsavel.classList.add('bg-yellow-50', 'cursor-text');
          campoResponsavel.placeholder = 'Digite o nome do respons√°vel';
          console.warn('‚ö†Ô∏è Erro ao buscar nome - campo tornou-se edit√°vel para preenchimento manual');
        }
      }
    }

    // Carregar lista de usu√°rios para sele√ß√£o de colaboradores
    async function carregarListaUsuarios() {
      try {
        const url = window.CONFIG.APPS_SCRIPT_CASOS;
        const dados = {
          action: 'listarUsuariosComNomes'
        };

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'data=' + encodeURIComponent(JSON.stringify(dados))
        });

        const resultado = await response.json();

        if (resultado.success && resultado.usuarios) {
          todosUsuarios = resultado.usuarios;
          console.log('‚úÖ Lista de usu√°rios carregada:', todosUsuarios.length, 'usu√°rios');
        } else {
          console.warn('Erro ao carregar lista de usu√°rios');
          todosUsuarios = [];
        }
      } catch (error) {
        console.error('Erro ao carregar lista de usu√°rios:', error);
        todosUsuarios = [];
      }
    }

    // ===== Sistema de Autocomplete para Colaboradores =====
    let todosColaboradoresCache = null;
    let debounceTimer = null;

    // Fun√ß√£o para renderizar tags de colaboradores
    function renderizarTagsColaboradores() {
      const container = document.getElementById('colaboradores-tags');
      const hiddenInput = document.getElementById('colaboradores');

      if (!container) return;

      if (colaboradoresSelecionados.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-400 italic w-full">Nenhum colaborador adicionado</p>';
        if (hiddenInput) hiddenInput.value = '';
        return;
      }

      let html = '';
      colaboradoresSelecionados.forEach((nome, index) => {
        html += `
          <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
            <span>${nome}</span>
            <button 
              type="button"
              onclick="removerColaborador(${index})"
              class="text-blue-600 hover:text-blue-800 hover:bg-blue-200 rounded-full w-5 h-5 flex items-center justify-center font-bold transition-all duration-200 active:scale-90"
              title="Remover"
            >
              √ó
            </button>
          </span>
        `;
      });

      container.innerHTML = html;

      // Atualiza campo oculto
      if (hiddenInput) {
        hiddenInput.value = JSON.stringify(colaboradoresSelecionados);
      }
    }

    // Adicionar colaborador
    function adicionarColaborador(nomeCompleto) {
      if (!colaboradoresSelecionados.includes(nomeCompleto)) {
        colaboradoresSelecionados.push(nomeCompleto);
        renderizarTagsColaboradores();
      }

      // Limpa input
      const input = document.getElementById('colaboradores-input');
      if (input) input.value = '';

      // Esconde sugest√µes
      const suggestionsDiv = document.getElementById('colaboradores-suggestions');
      if (suggestionsDiv) suggestionsDiv.classList.add('hidden');
    }

    // Remover colaborador
    function removerColaborador(index) {
      colaboradoresSelecionados.splice(index, 1);
      renderizarTagsColaboradores();
    }

    // Mostrar sugest√µes com debounce
    async function mostrarSugestoesColaboradores(query) {
      // Cancela timer anterior
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      const suggestionsDiv = document.getElementById('colaboradores-suggestions');
      if (!suggestionsDiv) return;

      // Se query est√° vazia, esconde sugest√µes
      if (!query || query.trim().length === 0) {
        suggestionsDiv.classList.add('hidden');
        return;
      }

      // Mostra loading imediatamente
      suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">‚è≥ Buscando colaboradores...</div>';
      suggestionsDiv.classList.remove('hidden');

      // Aguarda 300ms antes de buscar (debounce)
      debounceTimer = setTimeout(async () => {
        // Carrega usu√°rios se ainda n√£o carregou
        if (!todosColaboradoresCache) {
          try {
            const response = await fetch(CONFIG.APPS_SCRIPT_AUTH, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                data: JSON.stringify({ action: 'listarUsuarios' })
              })
            });

            const data = await response.json();
            console.log('Resposta do backend (listarUsuarios):', data);

            // Suporta tanto formato direto quanto aninhado
            todosColaboradoresCache = data.usuarios || data.data || [];

            if (Array.isArray(todosColaboradoresCache)) {
              console.log('‚úÖ Colaboradores carregados:', todosColaboradoresCache.length);
            } else {
              console.error('‚ùå Formato inv√°lido:', todosColaboradoresCache);
              todosColaboradoresCache = [];
            }
          } catch (error) {
            console.error('Erro ao carregar colaboradores:', error);
            todosColaboradoresCache = [];
          }
        }

        // Filtra usu√°rios baseado na busca
        const userEmail = sessionStorage.getItem('userEmail');
        const queryLower = query.toLowerCase();
        const usuariosFiltrados = todosColaboradoresCache.filter(u => {
          const jaAdicionado = colaboradoresSelecionados.includes(u.nome);
          const ehUsuarioLogado = u.email === userEmail;
          const matchBusca = u.nome.toLowerCase().includes(queryLower) ||
            u.email.toLowerCase().includes(queryLower);

          return !jaAdicionado && !ehUsuarioLogado && matchBusca;
        });

        // Mostra sugest√µes
        if (usuariosFiltrados.length === 0) {
          suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-gray-500 italic">Nenhum usu√°rio encontrado</div>';
          suggestionsDiv.classList.remove('hidden');
        } else {
          let html = '';
          usuariosFiltrados.slice(0, 8).forEach(usuario => {
            html += `
              <div 
                class="p-3 hover:bg-blue-50 cursor-pointer transition-all duration-200 border-b last:border-b-0 active:bg-blue-100"
                onclick="adicionarColaborador('${usuario.nome.replace(/'/g, "\\'")}')"
              >
                <div class="font-medium text-gray-800">${usuario.nome}</div>
                <div class="text-xs text-gray-500">${usuario.email}</div>
              </div>
            `;
          });
          suggestionsDiv.innerHTML = html;
          suggestionsDiv.classList.remove('hidden');
        }
      }, 300);
    }

    // Configurar eventos do autocomplete
    function configurarEventosColaboradores() {
      const input = document.getElementById('colaboradores-input');
      const suggestionsDiv = document.getElementById('colaboradores-suggestions');

      if (!input) return;

      // Input em tempo real
      input.addEventListener('input', function () {
        mostrarSugestoesColaboradores(this.value);
      });

      // Enter para adicionar
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const primeiroItem = suggestionsDiv?.querySelector('[onclick]');
          if (primeiroItem) {
            primeiroItem.click();
          }
        }
      });

      // Clique fora fecha sugest√µes
      document.addEventListener('click', function (e) {
        if (!input.contains(e.target) && !suggestionsDiv?.contains(e.target)) {
          suggestionsDiv?.classList.add('hidden');
        }
      });

      // Renderiza estado inicial
      renderizarTagsColaboradores();
    }

    // ========================================
    // MODAL DE CONFIRMA√á√ÉO DE REGISTRO
    // ========================================

    /**
     * Abre o modal de confirma√ß√£o com resumo dos dados
     */
    function abrirModalConfirmacao() {
      // Gera resumo dos dados
      const resumoHTML = gerarResumoRegistro();
      document.getElementById('resumoRegistro').innerHTML = resumoHTML;

      // Mostra o modal
      document.getElementById('confirmRegistroOverlay').classList.add('show');
      document.getElementById('confirmRegistroContent').classList.add('show');
    }

    /**
     * Fecha o modal de confirma√ß√£o
     */
    function fecharModalConfirmacao() {
      document.getElementById('confirmRegistroOverlay').classList.remove('show');
      document.getElementById('confirmRegistroContent').classList.remove('show');
    }

    // Fecha modal de confirma√ß√£o com ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('confirmRegistroContent');
        if (modal && modal.classList.contains('show')) {
          fecharModalConfirmacao();
        }
      }
    });

    /**
     * Gera HTML com resumo dos campos principais
     */
    function gerarResumoRegistro() {
      const campos = [
        { label: 'Crian√ßa/Estudante', id: 'criancaEstudante' },
        { label: 'Data da Notifica√ß√£o', id: 'dataNT' },
        { label: 'Idade', id: 'idade' },
        { label: 'Identidade de G√™nero', id: 'identidadeGenero', isSelect: true },
        { label: 'Institui√ß√£o', id: 'cmeiEmef' },
        { label: 'Regi√£o', id: 'regiao' },
        { label: 'Tipo de Viol√™ncia', id: 'tipoViolencia' },
        { label: 'Encaminhamento', id: 'encaminhamento' },
        { label: 'Respons√°vel', id: 'responsavelRegistro' }
      ];

      let html = '';
      campos.forEach(campo => {
        const elemento = document.getElementById(campo.id);
        let valor = '';

        if (elemento) {
          if (campo.isSelect && elemento.tagName === 'SELECT') {
            valor = elemento.options[elemento.selectedIndex]?.text || '';
          } else {
            valor = elemento.value || '';
          }
        }

        // Formata tags (separadas por v√≠rgula)
        if (valor && valor.includes(',')) {
          valor = valor.split(',').map(v => v.trim()).join(', ');
        }

        if (valor) {
          html += `
            <div class="resumo-item">
              <span class="resumo-label">${campo.label}:</span>
              <span class="resumo-valor">${valor}</span>
            </div>
          `;
        }
      });

      return html || '<p class="text-gray-500 text-center py-4">Nenhum dado preenchido</p>';
    }

    /**
     * Confirma e executa o envio do registro
     */
    function confirmarEnvioRegistro() {
      fecharModalConfirmacao();
      executarEnvioFormulario();
    }

    /**
     * Executa o envio do formul√°rio (chamada ap√≥s confirma√ß√£o)
     */
    async function executarEnvioFormulario() {
      console.log('üìù Iniciando envio do formul√°rio...');

      // Mostra loading elegante
      if (typeof loadingIndicator !== 'undefined') {
        loadingIndicator.show('üíæ Salvando registro...');
        loadingIndicator.update('Validando dados...', 10);
      }

      // Desabilita bot√£o durante envio
      const btnSalvar = document.getElementById('btnSalvar');
      btnSalvar.disabled = true;
      btnSalvar.textContent = '‚è≥ Salvando...';

      // Salva rascunho antes de enviar (backup de seguran√ßa)
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }

      // Atualiza loading
      if (typeof loadingIndicator !== 'undefined') {
        loadingIndicator.update('Preparando dados...', 30);
      }

      // Chama salvarRegistro (que √© o wrapper que faz o upload de anexos)
      console.log('üöÄ Chamando salvarRegistro...');
      try {
        const resultado = await salvarRegistro();
        console.log('‚úÖ salvarRegistro conclu√≠do:', resultado);
      } catch (erro) {
        console.error('‚ùå Erro ao chamar salvarRegistro:', erro);
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        // Oculta loading em caso de erro
        if (typeof loadingIndicator !== 'undefined') {
          loadingIndicator.hide();
        }
      }
    }

    // Fun√ß√£o de envio do formul√°rio - agora abre modal de confirma√ß√£o
    document.getElementById('registroForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      console.log('üìù Bot√£o salvar clicado, validando formul√°rio...');

      // Valida antes de mostrar confirma√ß√£o
      const validacao = validarFormulario();
      console.log('‚úÖ Valida√ß√£o retornou:', validacao);

      if (!validacao) {
        console.warn('‚ùå Valida√ß√£o falhou, n√£o abrindo modal de confirma√ß√£o');
        return;
      }

      // Abre modal de confirma√ß√£o em vez de enviar direto
      abrirModalConfirmacao();
    });

    // Fun√ß√£o para enviar dados ao Apps Script via iframe (contorna CORS)
    function enviarParaAppsScript(dados) {
      const btnSalvar = document.getElementById('btnSalvar');

      console.log('üìã Validando dados antes de enviar:', dados);

      // Valida√ß√£o de campos obrigat√≥rios (verifica se existem e n√£o est√£o vazios)
      const camposObrigatorios = [
        'criancaEstudante', 'dataNT', 'idade', 'identidadeGenero',
        'tipoViolencia', 'cmeiEmef', 'regiao', 'responsavelRegistro', 'foiMembroFamiliar'
      ];

      const camposFaltando = [];
      for (const campo of camposObrigatorios) {
        const valor = dados[campo];
        // Para foiMembroFamiliar, string vazia √© v√°lida (significa "N√£o informado")
        if (campo === 'foiMembroFamiliar') {
          if (valor === undefined || valor === null) {
            camposFaltando.push(campo);
          }
          // Se for string vazia, aceita como v√°lido (n√£o adiciona aos faltando)
        } else {
          if (!valor || (typeof valor === 'string' && valor.trim() === '')) {
            camposFaltando.push(campo);
          }
        }
      }

      if (camposFaltando.length > 0) {
        console.error('‚ùå Campos obrigat√≥rios faltando:', camposFaltando);
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta(`‚ùå Preencha todos os campos obrigat√≥rios! Faltando: ${camposFaltando.join(', ')}`, 'error');
        return;
      }

      console.log('‚úÖ Todos os campos obrigat√≥rios preenchidos');

      // Verifica se a URL do Apps Script est√° configurada
      // Tenta obter do CONFIG novamente caso n√£o tenha sido carregada antes
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_ID_AQUI')) {
        // Usa window.CONFIG diretamente (n√£o pode reatribuir const)
        const config = typeof window !== 'undefined' ? window.CONFIG : (typeof CONFIG !== 'undefined' ? CONFIG : null);

        if (config && config.APPS_SCRIPT_CASOS) {
          const novaURL = config.APPS_SCRIPT_CASOS;

          // Verifica se a URL mudou (pode estar em cache)
          if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== novaURL) {
            console.warn('‚ö†Ô∏è URL do Apps Script mudou! Atualizando...');
            console.warn('URL antiga:', APPS_SCRIPT_URL);
            console.warn('URL nova:', novaURL);
          }

          APPS_SCRIPT_URL = novaURL;
          console.log('‚úÖ URL obtida do CONFIG:', APPS_SCRIPT_URL);
        } else {
          console.error('‚ùå CONFIG.APPS_SCRIPT_CASOS n√£o est√° dispon√≠vel');
          console.error('CONFIG dispon√≠vel?', typeof config !== 'undefined' && config !== null);
          if (config) {
            console.error('CONFIG.APPS_SCRIPT_CASOS:', config.APPS_SCRIPT_CASOS);
          }
        }
      }

      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_ID_AQUI')) {
        console.error('‚ùå ERRO: URL do Apps Script n√£o configurada!');
        console.error('CONFIG dispon√≠vel?', typeof CONFIG !== 'undefined');
        if (typeof CONFIG !== 'undefined') {
          console.error('CONFIG completo:', CONFIG);
          console.error('CONFIG.APPS_SCRIPT_CASOS:', CONFIG.APPS_SCRIPT_CASOS);
        } else {
          console.error('‚ö†Ô∏è CONFIG n√£o est√° definido. Verifique se config.js est√° sendo carregado corretamente.');
        }
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta('‚ùå Erro: URL do Apps Script n√£o est√° configurada. Verifique o arquivo config.js e certifique-se de que APPS_SCRIPT_CASOS est√° definido. Recarregue a p√°gina ap√≥s configurar.', 'error');
        return;
      }

      console.log('üì° Enviando para URL:', APPS_SCRIPT_URL);

      // Atualiza loading para envio
      if (typeof loadingIndicator !== 'undefined') {
        loadingIndicator.update('üì§ Enviando para o servidor...', 50);
      }

      // Cria callback global para receber resposta do Apps Script
      const callbackName = 'handleScriptResponse_' + Date.now();
      window[callbackName] = function (resultado) {
        console.log('üì• Resposta recebida do Apps Script:', resultado);
        console.log('‚úÖ Callback executado com sucesso');

        // Atualiza loading
        if (typeof loadingIndicator !== 'undefined') {
          loadingIndicator.update('‚úÖ Processando resposta...', 80);
        }

        // Chama callback global fixo se existir (para intercepta√ß√£o de anexos)
        if (typeof window.handleRegistroCallback === 'function') {
          console.log('[enviarParaAppsScript] Chamando handleRegistroCallback...');
          window.handleRegistroCallback(resultado);
        }

        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';

        // Verifica se resultado existe
        if (!resultado) {
          console.error('‚ùå Resposta vazia ou inv√°lida do Apps Script');
          mostrarAlerta('‚ùå Erro: Resposta inv√°lida do servidor. Verifique os logs do Apps Script.', 'error');
          delete window[callbackName];
          return;
        }

        // Verifica sucesso (pode ser 'success' ou 'sucesso')
        const sucesso = resultado.success || resultado.sucesso;
        const mensagem = resultado.message || resultado.mensagem || 'Opera√ß√£o conclu√≠da';

        // Se o callback global foi chamado, n√£o executa a√ß√µes padr√£o (limpar formul√°rio, etc)
        // O callback global (wrapper de anexos) vai cuidar disso
        if (typeof window.handleRegistroCallback === 'function') {
          console.log('[enviarParaAppsScript] Callback global interceptou, pulando a√ß√µes padr√£o');
          delete window[callbackName];
          return;
        }

        if (sucesso) {
          console.log(' Registro salvo com sucesso!');

          // Atualiza loading para conclus√£o
          if (typeof loadingIndicator !== 'undefined') {
            loadingIndicator.update(' Registro salvo com sucesso!', 100);
            // Aguarda 1 segundo antes de ocultar para o usu√°rio ver a mensagem de sucesso
            setTimeout(() => {
              loadingIndicator.hide();
            }, 1000);
          }

          // REMOVIDO: mostrarAlerta aqui pois o fluxo com anexos chama executarAcoesPadraoSalvamento
          // que j√° exibe a mensagem de sucesso. Isso evita duplica√ß√£o.

          // Limpa o formul√°rio completamente ap√≥s salvar com sucesso
          console.log('üßπ Limpando formul√°rio ap√≥s salvamento bem-sucedido...');
          limparFormulario();

          // Scroll suave para o topo
          window.scrollTo({ top: 0, behavior: 'smooth' });

          console.log('‚úÖ Formul√°rio limpo e pronto para novo registro!');
        } else {
          console.error('‚ùå Erro ao salvar:', mensagem);

          // Oculta loading em caso de erro
          if (typeof loadingIndicator !== 'undefined') {
            loadingIndicator.hide();
          }

          mostrarAlerta('‚ùå Erro: ' + mensagem, 'error');
        }

        // Limpa o callback
        delete window[callbackName];
      };

      // Envia dados via JSONP (m√©todo oficial do Apps Script)
      const script = document.createElement('script');
      const params = new URLSearchParams();
      params.append('action', 'saveRegistro');
      params.append('data', JSON.stringify(dados));
      params.append('callback', callbackName);

      const urlCompleta = APPS_SCRIPT_URL + '?' + params.toString();
      console.log('üîó URL completa da requisi√ß√£o:', urlCompleta);

      script.src = urlCompleta;
      script.onerror = function (error) {
        console.error('‚ùå Erro ao carregar script do Apps Script:', error);
        console.error('URL tentada:', urlCompleta);
        console.error('Poss√≠veis causas:');
        console.error('1. Apps Script n√£o est√° publicado como "Aplicativo da Web"');
        console.error('2. Permiss√µes do Apps Script n√£o est√£o configuradas corretamente');
        console.error('3. URL do Apps Script est√° incorreta');
        console.error('4. CORS ou bloqueio de rede');

        // Oculta loading em caso de erro
        if (typeof loadingIndicator !== 'undefined') {
          loadingIndicator.hide();
        }

        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta('‚ùå Erro ao conectar com o servidor. Verifique: 1) Se o Apps Script est√° publicado como "Aplicativo da Web", 2) Se a URL em config.js est√° correta, 3) Se as permiss√µes est√£o configuradas. Veja o console para mais detalhes.', 'error');
        delete window[callbackName];
      };

      script.onload = function () {
        console.log('‚úÖ Script do Apps Script carregado com sucesso');
        console.log('‚è≥ Aguardando resposta do callback...');
      };

      console.log('üì§ Adicionando script ao DOM para enviar dados...');
      document.body.appendChild(script);

      // Timeout de seguran√ßa: se n√£o receber resposta em 30 segundos, considera erro
      setTimeout(() => {
        if (window[callbackName]) {
          console.error('‚è±Ô∏è Timeout: N√£o recebeu resposta do Apps Script em 30 segundos');

          // Oculta loading em caso de timeout
          if (typeof loadingIndicator !== 'undefined') {
            loadingIndicator.hide();
          }

          btnSalvar.disabled = false;
          btnSalvar.textContent = 'üíæ Salvar Registro';
          mostrarAlerta('‚ùå Timeout: O servidor n√£o respondeu. Verifique a URL do Apps Script e se o script est√° publicado corretamente.', 'error');
          delete window[callbackName];
        }
      }, 30000);

      // Remove o script ap√≥s 5 segundos
      setTimeout(() => {
        if (script.parentNode) {
          script.remove();
          console.log('üßπ Script removido do DOM');
        }
      }, 5000);
    }

    // Fun√ß√£o para mostrar alertas
    function mostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('alertContainer');

      const cores = {
        success: 'bg-green-100 border-green-500 text-green-700',
        error: 'bg-red-100 border-red-500 text-red-700',
        info: 'bg-blue-100 border-blue-500 text-blue-700'
      };

      const icones = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };

      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-md`;

      // Fun√ß√£o para remover com anima√ß√£o
      const removerAlerta = () => {
        alerta.classList.add('alert-removing');
        setTimeout(() => {
          alerta.remove();
        }, 400); // Tempo da anima√ß√£o de sa√≠da
      };

      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-2xl mr-3">${icones[tipo]}</span>
            <p class="font-medium">${mensagem}</p>
          </div>
          <button class="text-xl font-bold hover:opacity-70 transition-opacity" onclick="event.target.closest('.alert').querySelector('button').onclick()">
            √ó
          </button>
        </div>
      `;

      // Adiciona evento de clique no bot√£o fechar
      const btnFechar = alerta.querySelector('button');
      btnFechar.onclick = (e) => {
        e.preventDefault();
        removerAlerta();
      };

      container.appendChild(alerta);

      // Remove automaticamente ap√≥s 5 segundos
      setTimeout(() => {
        if (alerta.parentElement) {
          removerAlerta();
        }
      }, 5000);
    }

    // ============================================
    // FEEDBACK VISUAL DO BOT√ÉO SALVAR RASCUNHO
    // ============================================

    function salvarRascunhoComFeedback() {
      const btn = document.getElementById('btnSalvarRascunho');
      const icon = document.getElementById('iconSalvarRascunho');
      const texto = document.getElementById('textoSalvarRascunho');

      // Desabilita bot√£o
      btn.disabled = true;
      btn.style.opacity = '0.7';

      // Mostra loading
      icon.textContent = '‚è≥';
      if (texto) texto.textContent = 'SALVANDO...';

      // Salva
      AutoSave.salvar();

      // Depois de 800ms mostra sucesso
      setTimeout(() => {
        btn.classList.remove('from-blue-500', 'to-indigo-600');
        btn.classList.add('from-green-500', 'to-green-600');
        icon.textContent = '‚úîÔ∏è';
        if (texto) texto.textContent = 'SALVO!';
        btn.style.opacity = '1';

        // Volta ao normal depois de 2s
        setTimeout(() => {
          btn.classList.remove('from-green-500', 'to-green-600');
          btn.classList.add('from-blue-500', 'to-indigo-600');
          icon.textContent = 'üíæ';
          if (texto) texto.textContent = 'SALVAR AGORA';
          btn.disabled = false;
        }, 2000);
      }, 800);
    }

    // ============================================
    // ALERT DIALOG - FUN√á√ïES DE CONTROLE
    // ============================================

    function openAlertDialog() {
      const overlay = document.getElementById('alertDialogOverlay');
      const content = document.getElementById('alertDialogContent');

      overlay.classList.add('show');
      content.classList.add('show');

      // Previne scroll do body
      document.body.style.overflow = 'hidden';
    }

    function closeAlertDialog() {
      const overlay = document.getElementById('alertDialogOverlay');
      const content = document.getElementById('alertDialogContent');

      // Adiciona anima√ß√£o de sa√≠da
      overlay.classList.add('hide');
      content.classList.add('hide');

      // Aguarda anima√ß√£o terminar antes de esconder
      setTimeout(() => {
        overlay.classList.remove('show', 'hide');
        content.classList.remove('show', 'hide');
        document.body.style.overflow = '';
      }, 250);
    }

    function confirmarLimparFormulario() {
      closeAlertDialog();
      limparFormulario();
    }

    // Fun√ß√µes para o dialog de rascunho
    function openAlertDialogRascunho() {
      const overlay = document.getElementById('alertDialogOverlayRascunho');
      const content = document.getElementById('alertDialogContentRascunho');

      overlay.classList.add('show');
      content.classList.add('show');

      document.body.style.overflow = 'hidden';
    }

    function closeAlertDialogRascunho() {
      const overlay = document.getElementById('alertDialogOverlayRascunho');
      const content = document.getElementById('alertDialogContentRascunho');

      // Adiciona anima√ß√£o de sa√≠da
      overlay.classList.add('hide');
      content.classList.add('hide');

      // Aguarda anima√ß√£o terminar antes de esconder
      setTimeout(() => {
        overlay.classList.remove('show', 'hide');
        content.classList.remove('show', 'hide');
        document.body.style.overflow = '';
      }, 250);
    }

    function confirmarLimparRascunho() {
      closeAlertDialogRascunho();
      AutoSave.limpar();

      // Feedback visual
      const draftStatus = document.getElementById('draftStatus');
      if (draftStatus) draftStatus.classList.add('hidden');

      // Mostrar alerta de sucesso se existir
      if (typeof mostrarAlerta === 'function') {
        mostrarAlerta('üóëÔ∏è Rascunho exclu√≠do com sucesso', 'success');
      }

      // Limpar campos do formul√°rio tamb√©m
      limparFormulario();
    }

    // Fecha o dialog ao pressionar ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        const overlay = document.getElementById('alertDialogOverlay');
        const overlayRascunho = document.getElementById('alertDialogOverlayRascunho');

        if (overlay && overlay.classList.contains('show')) {
          closeAlertDialog();
        }
        if (overlayRascunho && overlayRascunho.classList.contains('show')) {
          closeAlertDialogRascunho();
        }
      }
    });

    // Fun√ß√£o para limpar formul√°rio
    function limparFormulario() {
      console.log('üßπ Limpando formul√°rio...');
      const form = document.getElementById('registroForm');

      // 1. Reseta o formul√°rio (limpa todos os campos padr√£o)
      form.reset();

      // 2. Remove classes de erro
      const campos = form.querySelectorAll('.field-error');
      campos.forEach(function (campo) {
        campo.classList.remove('field-error');
      });

      // 3. Limpa todos os campos de texto, n√∫mero e textarea manualmente
      form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(campo => {
        campo.value = '';
      });

      // 4. Reseta os selects customizados
      document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
        const placeholder = trigger.getAttribute('data-placeholder') || 'Selecione...';
        trigger.textContent = placeholder;
      });

      // 5. Reseta selects para primeira op√ß√£o (Selecione...)
      form.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
        // Dispara evento change para atualizar selects customizados
        select.dispatchEvent(new Event('change'));
      });

      // 6. Reseta radio buttons (nenhuma op√ß√£o pr√©-selecionada)
      form.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });

      // 6b. Esconde bloco condicional "Ocorreu na escola" e remove obrigatoriedade
      const ocorreuWrapper = document.getElementById('ocorreu-escola-wrapper');
      if (ocorreuWrapper) {
        ocorreuWrapper.classList.remove('is-visible');
      }
      form.querySelectorAll('input[name="ocorreuEscola"]').forEach(radio => {
        radio.required = false;
      });

      // 7. Esconde campos condicionais
      const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
      if (pcdDetalhesContainer) {
        pcdDetalhesContainer.classList.add('hidden');
      }

      // 8. Limpa campos hidden de tags (incluindo colaboradores)
      ['pcdDetalhes', 'tipoViolencia', 'classificacaoViolencia', 'motivacaoViolencia', 'encaminhamento', 'colaboradores'].forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          campo.value = '';
        }
      });

      // 9. Limpa colaboradores selecionados
      colaboradoresSelecionados = [];
      if (typeof renderizarTagsColaboradores === 'function') {
        renderizarTagsColaboradores();
      }

      // 10. Recarrega nome do usu√°rio (pode ter mudado)
      carregarNomeUsuarioLogado();

      // 9. Limpa arrays de tags e renderiza novamente
      if (typeof transtornosSelecionados !== 'undefined') {
        transtornosSelecionados = [];
        if (typeof renderizarTagsTranstornos === 'function') {
          renderizarTagsTranstornos();
        }
      }
      if (typeof tiposViolenciaSelecionados !== 'undefined') {
        tiposViolenciaSelecionados = [];
        if (typeof renderizarTagsTipoViolencia === 'function') {
          renderizarTagsTipoViolencia();
        }
      }
      if (typeof tiposViolenciaInstitucionalSelecionados !== 'undefined') {
        tiposViolenciaInstitucionalSelecionados = [];
        if (typeof renderizarTagsViolenciaInstitucional === 'function') {
          renderizarTagsViolenciaInstitucional();
        }
      }
      if (typeof encaminhamentosSelecionados !== 'undefined') {
        encaminhamentosSelecionados = [];
        if (typeof renderizarTags === 'function') {
          renderizarTags();
        }
      }

      // 9.5. Colaboradores j√° foram limpos na etapa 9
      // 9.6. Nome do usu√°rio j√° foi recarregado na etapa 10

      // 10. Limpa inputs de tags visuais
      form.querySelectorAll('input[id$="-input"]').forEach(input => {
        input.value = '';
      });

      // 11. Limpa containers de tags
      form.querySelectorAll('[id$="-tags"]').forEach(container => {
        container.innerHTML = '';
      });

      // 12. Limpa rascunho do AutoSave
      if (typeof AutoSave !== 'undefined') {
        AutoSave.limpar();
      }

      // 13. Atualiza progresso do formul√°rio
      atualizarProgresso();

      // 14. Volta ao topo da p√°gina com scroll suave
      window.scrollTo({ top: 0, behavior: 'smooth' });

      console.log('‚úÖ Formul√°rio limpo com sucesso!');
    }

    // ========================================
    // CUSTOM SELECT FUNCTIONALITY
    // ========================================
    function initCustomSelects() {
      document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
        if (select.closest('.custom-select-wrapper')) return; // J√° foi inicializado

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-select-wrapper';

        const trigger = document.createElement('div');
        const selectedOption = select.options[select.selectedIndex];
        // Fallback seguro caso select esteja vazio (improv√°vel mas poss√≠vel)
        const placeholder = selectedOption ? selectedOption.textContent : 'Selecione...';

        trigger.className = 'custom-select-trigger w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm';
        trigger.textContent = placeholder;
        trigger.setAttribute('data-placeholder', placeholder);
        trigger.setAttribute('tabindex', '0');

        const dropdown = document.createElement('div');
        dropdown.className = 'custom-select-dropdown';

        Array.from(select.options).forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'custom-select-option';
          optionDiv.textContent = option.textContent;
          optionDiv.setAttribute('data-value', option.value);

          if (option.selected) {
            optionDiv.classList.add('selected');
          }

          optionDiv.addEventListener('click', () => {
            select.selectedIndex = index;
            select.value = option.value;
            trigger.textContent = option.textContent;

            // Atualiza classes selected
            dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            optionDiv.classList.add('selected');

            dropdown.classList.remove('show');
            trigger.classList.remove('open');

            // Dispara evento change no select original
            select.dispatchEvent(new Event('change', { bubbles: true }));
          });

          dropdown.appendChild(optionDiv);
        });

        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          closeAllCustomSelects();
          dropdown.classList.toggle('show');
          trigger.classList.toggle('open');
        });

        trigger.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            trigger.click();
          }
        });

        // ============================================================
        // NOVO: Ouvinte para atualizar UI quando select nativo muda
        // ============================================================
        select.addEventListener('change', () => {
          const currentOpt = select.options[select.selectedIndex];
          if (currentOpt) {
            trigger.textContent = currentOpt.textContent;

            // Atualiza visualmente a op√ß√£o selecionada no dropdown
            dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
              if (opt.getAttribute('data-value') === select.value) {
                opt.classList.add('selected');
              } else {
                opt.classList.remove('selected');
              }
            });
          }
        });

        select.parentNode.insertBefore(wrapper, select);
        wrapper.appendChild(trigger);
        wrapper.appendChild(dropdown);
        wrapper.appendChild(select);
      });

      // Fecha dropdowns ao clicar fora
      document.addEventListener('click', () => {
        closeAllCustomSelects();
      });
    }

    function closeAllCustomSelects() {
      document.querySelectorAll('.custom-select-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
      document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
        trigger.classList.remove('open');
      });
    }

    // Observa mudan√ßas din√¢micas no select (para quando op√ß√µes s√£o adicionadas via JS)
    function observeSelectChanges() {
      const observer = new MutationObserver(() => {
        document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
          const wrapper = select.closest('.custom-select-wrapper');
          if (!wrapper) return;

          const dropdown = wrapper.querySelector('.custom-select-dropdown');
          const trigger = wrapper.querySelector('.custom-select-trigger');

          if (dropdown && select.options.length !== dropdown.children.length) {
            // Reconstruir dropdown
            dropdown.innerHTML = '';
            Array.from(select.options).forEach((option, index) => {
              const optionDiv = document.createElement('div');
              optionDiv.className = 'custom-select-option';
              optionDiv.textContent = option.textContent;
              optionDiv.setAttribute('data-value', option.value);

              if (option.selected) {
                optionDiv.classList.add('selected');
                trigger.textContent = option.textContent;
              }

              optionDiv.addEventListener('click', () => {
                select.selectedIndex = index;
                select.value = option.value;
                trigger.textContent = option.textContent;

                dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                  opt.classList.remove('selected');
                });
                optionDiv.classList.add('selected');

                dropdown.classList.remove('show');
                trigger.classList.remove('open');

                select.dispatchEvent(new Event('change', { bubbles: true }));
              });

              dropdown.appendChild(optionDiv);
            });
          }
        });
      });

      document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
        observer.observe(select, { childList: true, subtree: true });
      });
    }

    // Inicializa custom selects ap√≥s carregamento
    window.addEventListener('DOMContentLoaded', () => {
      verificarAutenticacao();
      initCustomSelects();
      observeSelectChanges();
      verificarMenuAdmin();

      // Inicializa sistema de auto-save
      AutoSave.inicializar();

      // Inicializa autocomplete de colaboradores
      configurarEventosColaboradores();

      // Inicializa sistema de progresso
      const form = document.getElementById('registroForm');
      if (!form) {
        console.error('Formul√°rio n√£o encontrado!');
        return;
      }

      // Controla exibi√ß√£o condicional de "Ocorreu na escola?"
      const ocorreuWrapper = document.getElementById('ocorreu-escola-wrapper');
      const radiosOcorreu = form.querySelectorAll('input[name="ocorreuEscola"]');
      const radiosViolenciaInformada = form.querySelectorAll('input[name="violenciaInformada"]');

      const toggleOcorreuEscola = () => {
        const mostrar = form.querySelector('input[name="violenciaInformada"]:checked')?.value === 'Sim';
        if (ocorreuWrapper) {
          ocorreuWrapper.classList.toggle('is-visible', !!mostrar);
        }
        radiosOcorreu.forEach(radio => {
          radio.required = mostrar;
          if (!mostrar) {
            radio.checked = false;
          }
        });
      };

      radiosViolenciaInformada.forEach(radio => {
        radio.addEventListener('change', toggleOcorreuEscola);
      });

      // Estado inicial
      toggleOcorreuEscola();

      // Atualiza progresso quando campos mudam
      form.addEventListener('input', () => {
        atualizarProgresso();
      });

      form.addEventListener('change', () => {
        atualizarProgresso();
      });

      // Bot√£o de salvar rascunho manualmente (j√° configurado via onclick no HTML)
      // N√£o precisa adicionar listener aqui, j√° est√° no HTML

      // Atualiza progresso inicial
      setTimeout(() => {
        atualizarProgresso();
      }, 1000);
    });

    // ========================================
    // VERIFICAR AUTENTICA√á√ÉO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');

      // Se n√£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! Fa√ßa login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }

      // Carrega nome do usu√°rio e lista de usu√°rios
      carregarNomeUsuarioLogado();
      carregarListaUsuarios();
    }

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');

      // Mostra bot√£o de sair para TODOS os usu√°rios
      if (btnSair) {
        btnSair.classList.remove('hidden');
      }
      if (btnSairMobile) {
        btnSairMobile.classList.remove('hidden');
      }

      // Menu Admin apenas para admin/superuser
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
      }
    }

    // ========================================
    // FUN√á√ÉO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
  </script>

  <!-- Sistema de Anexos -->
  <script src="assets/js/utils/api.js"></script>
  <script src="assets/js/modules/anexos-handler.js"></script>

  <!-- Script de Upload para Formul√°rio -->
  <script>
    // Event listener para preview de anexos
    document.getElementById('anexos').addEventListener('change', function (e) {
      console.log('=== SELE√á√ÉO DE ANEXOS - CHANGE EVENT ===');
      console.log(`[anexos-change] Timestamp: ${new Date().toISOString()}`);
      console.log(`[anexos-change] Quantidade de arquivos selecionados: ${e.target.files.length}`);

      if (e.target.files.length > 0) {
        const arquivos = Array.from(e.target.files);
        arquivos.forEach((arquivo, index) => {
          console.log(`[anexos-change] Arquivo ${index + 1}:`);
          console.log(`  - Nome: ${arquivo.name}`);
          console.log(`  - Tipo: ${arquivo.type}`);
          console.log(`  - Tamanho: ${(arquivo.size / 1024).toFixed(2)} KB`);
        });
      }

      const preview = document.getElementById('preview-anexos');
      console.log(`[anexos-change] Elemento de preview: ${preview ? 'encontrado' : 'N√ÉO ENCONTRADO'}`);
      criarPreviewAnexos(e.target.files, preview);
      console.log('=== SELE√á√ÉO DE ANEXOS - CONCLU√çDO ===');
    });

    // Modificar fun√ß√£o salvarRegistro para fazer upload de anexos ap√≥s salvar
    // Aguardar at√© que a fun√ß√£o enviarParaAppsScript esteja dispon√≠vel
    setTimeout(() => {
      if (typeof enviarParaAppsScript !== 'function') {
        console.error('[salvarRegistro-wrapper] ‚ùå Erro: enviarParaAppsScript n√£o √© uma fun√ß√£o!');
        return;
      }

      const originalEnviar = window.enviarParaAppsScript;
      window.salvarRegistro = async function () {
        console.log('=== SALVAMENTO COM ANEXOS - IN√çCIO ===');
        console.log(`[salvarRegistro-anexos] Timestamp: ${new Date().toISOString()}`);

        // Coleta os dados do formul√°rio
        const dados = coletarDadosFormulario();
        console.log('[salvarRegistro-anexos] Dados coletados:', dados);

        // Criar um wrapper para interceptar a resposta
        return new Promise((resolve, reject) => {
          // Salvar callback original
          const originalCallback = window.handleRegistroCallback;
          let respuestaRecebida = false;

          // Definir novo callback que intercepta a resposta
          window.handleRegistroCallback = function (resultado) {
            console.log('[salvarRegistro-anexos] ‚úì Resposta do Apps Script recebida:', resultado);
            respuestaRecebida = true;

            // Fazer upload se salvou com sucesso
            if (resultado && resultado.success) {
              // IMPORTANTE: idPlanilha √© o ID visual (n√∫mero da notifica√ß√£o)
              // idNotificacao no retorno do saveRegistro √© a PK do Supabase (pode ser null se sync falhar)
              // Para upload e cria√ß√£o de pastas, usamos o idPlanilha (N√∫m Sequencial)
              let idParaUpload = resultado.idPlanilha || resultado.idNotificacao;
              console.log('[salvarRegistro-anexos] ID da notifica√ß√£o recebida (Planilha):', idParaUpload);

              // Tentar fazer upload dos anexos
              const anexosInput = document.getElementById('anexos');
              const arquivos = anexosInput ? anexosInput.files : null;

              if (arquivos && arquivos.length > 0) {
                console.log(`[salvarRegistro-anexos] Iniciando upload de ${arquivos.length} arquivo(s)...`);

                // Atualiza loading para upload de anexos
                if (typeof loadingIndicator !== 'undefined') {
                  loadingIndicator.update(`üìé Enviando ${arquivos.length} arquivo(s)...`, 60);
                }

                if (typeof uploadAnexos === 'function') {
                  // Passa o nome da crian√ßa retornado pelo backend para garantir que est√° correto
                  const nomeCriancaParaUpload = resultado.criancaEstudante || '';
                  console.log('[salvarRegistro-anexos] Nome da crian√ßa para upload:', nomeCriancaParaUpload);

                  uploadAnexos(
                    idParaUpload,
                    arquivos,
                    (atual, total, nome) => {
                      console.log(`üì§ [anexos] Enviando ${nome} (${atual}/${total})`);
                      // Atualiza progresso do loading
                      if (typeof loadingIndicator !== 'undefined') {
                        const progressoUpload = 60 + (20 * atual / total);
                        loadingIndicator.update(`üìé Enviando arquivo ${atual}/${total}: ${nome}`, progressoUpload);
                      }
                    },
                    (sucessos, erros, total) => {
                      console.log(`[anexos] Upload conclu√≠do: ${sucessos} sucessos, ${erros} erros, ${total} total`);
                    },
                    nomeCriancaParaUpload  // 5¬∫ par√¢metro: nome da crian√ßa
                  ).then(() => {
                    console.log('[salvarRegistro-anexos] ‚úì Upload de anexos conclu√≠do');
                    // Limpar input de anexos
                    const preview = document.getElementById('preview-anexos');
                    if (preview) preview.innerHTML = '';
                    if (anexosInput) anexosInput.value = '';

                    // Executar a√ß√µes padr√£o ap√≥s upload
                    executarAcoesPadraoSalvamento(resultado);
                    resolve(resultado);
                  }).catch(erro => {
                    console.error('[salvarRegistro-anexos] ‚ùå Erro no upload:', erro);
                    // Mesmo com erro no upload, o registro foi salvo, ent√£o executa a√ß√µes padr√£o
                    executarAcoesPadraoSalvamento(resultado);
                    resolve(resultado); // Ainda retorna o resultado do salvar
                  });
                } else {
                  console.warn('[salvarRegistro-anexos] ‚ö†Ô∏è uploadAnexos n√£o dispon√≠vel');
                  executarAcoesPadraoSalvamento(resultado);
                  resolve(resultado);
                }
              } else {
                console.log('[salvarRegistro-anexos] ‚ÑπÔ∏è Nenhum arquivo selecionado');
                executarAcoesPadraoSalvamento(resultado);
                resolve(resultado);
              }
            } else {
              console.error('[salvarRegistro-anexos] ‚ùå Erro ao salvar registro');
              reject(resultado);
            }

            // Limpar callback global ap√≥s uso
            delete window.handleRegistroCallback;
          };

          // Fun√ß√£o auxiliar para executar a√ß√µes padr√£o ap√≥s salvamento
          function executarAcoesPadraoSalvamento(resultado) {
            const btnSalvar = document.getElementById('btnSalvar');
            if (btnSalvar) {
              btnSalvar.disabled = false;
              btnSalvar.textContent = 'üíæ Salvar Registro';
            }

            const sucesso = resultado && (resultado.success || resultado.sucesso);
            const mensagem = resultado ? (resultado.message || resultado.mensagem || 'Opera√ß√£o conclu√≠da') : 'Erro desconhecido';

            if (sucesso) {
              console.log('‚úÖ Registro salvo com sucesso!');
              mostrarAlerta('‚úÖ Registro salvo com sucesso na planilha!', 'success');

              // Limpa o cache de notifica√ß√µes para que sejam recarregadas com os dados atualizados
              console.log('üóëÔ∏è [Cache] Limpando cache de minhas-notificacoes...');
              if (window.DataCache) {
                window.DataCache.clear('minhas_notificacoes');
              }
              localStorage.removeItem('minhas_notificacoes_cache');
              localStorage.removeItem('minhas_notificacoes_timestamp');

              // Define flag para que minhas-notificacoes.html recarregue quando aberto/focado
              localStorage.setItem('reload-notificacoes-on-focus', 'true');
              console.log('üì¢ [Cache] Flag de reload definida para minhas-notificacoes');

              // Limpa o formul√°rio completamente ap√≥s salvar com sucesso
              console.log('üßπ Limpando formul√°rio ap√≥s salvamento bem-sucedido...');
              limparFormulario();

              // Scroll suave para o topo
              window.scrollTo({ top: 0, behavior: 'smooth' });

              console.log('‚úÖ Formul√°rio limpo e pronto para novo registro!');
            } else {
              console.error('‚ùå Erro ao salvar:', mensagem);
              mostrarAlerta('‚ùå Erro: ' + mensagem, 'error');
            }
          }

          // Chamar enviar original
          console.log('[salvarRegistro-anexos] Chamando enviarParaAppsScript...');
          originalEnviar(dados);
        });
      };
    }, 100); // Aguardar 100ms para garantir que fun√ß√µes foram definidas
  </script>

  <!-- Intro.js - Sistema de Onboarding -->
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <script src="assets/js/utils/onboarding.js"></script>
  <script>
    // Inicializar onboarding ap√≥s carregamento completo da p√°gina
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function () {
        if (window.NAAMOnboarding) {
          NAAMOnboarding.init('registro-novo-caso');
        }
      }, 2000);
    });
  </script>

</body>

<!-- Intro.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
<!-- Onboarding Module -->
<script src="assets/js/utils/onboarding.js"></script>
<!-- Initialize Onboarding -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (window.NAAMOnboarding) {
      window.NAAMOnboarding.init('registro-novo-caso');
    }
  });
</script>

</html>