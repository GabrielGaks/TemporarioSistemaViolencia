<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Registros - Viol√™ncia Escolar</title>
  
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .alert {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0.5rem;
    }

    table {
      min-width: 1000px;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-50 min-h-screen font-sans antialiased">

  <div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
    
    <!-- Menu de Navega√ß√£o -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg p-4 mb-6">
      <nav class="flex flex-wrap gap-4 justify-center">
        <a href="index.html" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-400 transition">
          üìù Novo Registro
        </a>
        <a href="gerenciar.html" class="px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold shadow-md hover:shadow-lg transition">
          üìã Gerenciar Registros
        </a>
      </nav>
    </div>
    
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl shadow-xl border border-white/60 backdrop-blur-sm p-6 mb-6">
      <div class="flex items-center justify-center gap-4 mb-3">
        <div class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
          üìã
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
          Gerenciar Registros
        </h1>
      </div>
      <p class="text-center text-gray-600">
        Visualize, edite ou exclua registros existentes
      </p>
    </div>
    
    <!-- √Årea de Alertas -->
    <div id="alertContainer"></div>

    <!-- Controles: Carregar e Buscar -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 items-stretch lg:items-center justify-between">
        <!-- Bot√£o Carregar -->
        <div class="flex items-center gap-4">
          <button 
            id="btnCarregar" 
            onclick="carregarRegistros()"
            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition shadow-md hover:shadow-lg flex items-center gap-2">
            <span>üîÑ</span>
            <span>Carregar Registros</span>
          </button>
          <div id="loadingInfo" class="text-gray-600 text-sm font-medium"></div>
        </div>
        
        <!-- Campo de Busca -->
        <div class="flex-1 max-w-md">
          <div class="relative">
            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input 
              type="text" 
              id="campoBusca" 
              placeholder="Buscar por nome da crian√ßa/estudante..."
              onkeyup="filtrarTabela()"
              class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de Registros -->
    <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6">
      <!-- Estat√≠sticas e Pagina√ß√£o -->
      <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4">
          <div class="px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
            <span class="text-sm text-gray-600">Total:</span>
            <span id="totalRegistros" class="ml-2 text-lg font-bold text-blue-600">0</span>
          </div>
          <div class="px-4 py-2 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-600">Exibindo:</span>
            <span id="registrosVisiveis" class="ml-2 text-lg font-bold text-green-600">0</span>
          </div>
        </div>
        
        <!-- Controles de Pagina√ß√£o -->
        <div class="flex items-center gap-3 bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-2 rounded-xl border border-gray-200">
          <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            Itens por p√°gina:
          </label>
          <div class="relative">
            <select id="itensPorPagina" onchange="mudarItensPorPagina()" class="appearance-none px-4 py-2 pr-10 bg-white border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-semibold text-gray-700 cursor-pointer hover:border-blue-400 hover:shadow-md">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="999999">Todos</option>
            </select>
            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          
          <div id="paginacaoControles" class="flex items-center gap-2"></div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabelaRegistros" class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th class="px-4 py-4 text-left text-sm font-bold">Crian√ßa/Estudante</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Data NT</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Idade</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Viol√™ncia</th>
              <th class="px-4 py-4 text-left text-sm font-bold">CMEI/EMEF</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Regi√£o</th>
              <th class="px-4 py-4 text-center text-sm font-bold">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="corpoTabela" class="divide-y divide-gray-200">
            <tr>
              <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center gap-3">
                  <div class="text-5xl">üìã</div>
                  <div class="text-lg font-medium">Nenhum registro carregado</div>
                  <div class="text-sm">Clique em "Carregar Registros" para visualizar os dados</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modalEdicao" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800">‚úèÔ∏è Editar Registro</h2>
        <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
      </div>
      
      <form id="formEdicao" class="space-y-4">
        <input type="hidden" id="edit_linha">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Crian√ßa/Estudante *</label>
            <input type="text" id="edit_criancaEstudante" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Data da NT *</label>
            <input type="date" id="edit_dataNT" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Idade *</label>
            <input type="text" id="edit_idade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Identidade de G√™nero *</label>
            <select id="edit_identidadeGenero" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecione...</option>
              <option value="Menino">Menino</option>
              <option value="Menina">Menina</option>
              <option value="N√£o-bin√°rio">N√£o-bin√°rio</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">PCD/Transtorno</label>
            <select id="edit_pcdTranstorno" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ra√ßa/Cor</label>
            <input type="text" id="edit_racaCor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Viol√™ncia *</label>
            <input type="text" id="edit_tipoViolencia" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Encaminhamento</label>
            <input type="text" id="edit_encaminhamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">CMEI/EMEF *</label>
            <input type="text" id="edit_cmeiEmef" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Regi√£o *</label>
            <input type="text" id="edit_regiao" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Respons√°vel pelo Registro *</label>
            <input type="text" id="edit_responsavelRegistro" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <!-- Campos adicionais (ocultos mas necess√°rios) -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Fonte: Escola</label>
            <select id="edit_fonteEscola" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Viol√™ncia na Escola Ocorreu</label>
            <select id="edit_violenciaEscolaOcorreu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Profissional Autor</label>
            <select id="edit_profissionalAutor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Estudante Autor</label>
            <select id="edit_estudanteAutor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Viol√™ncia Fora da Escola</label>
            <select id="edit_violenciaNaoEscola" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ocorreu na Escola</label>
            <select id="edit_ocorreuEscola" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Viol√™ncia Informada</label>
            <select id="edit_violenciaInformada" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">N√£o informado</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>
        </div>
        
        <div class="flex gap-4 pt-4 border-t">
          <button 
            type="submit" 
            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition shadow-md">
            üíæ Salvar Altera√ß√µes
          </button>
          <button 
            type="button" 
            onclick="fecharModal()" 
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURA√á√ÉO DO GOOGLE APPS SCRIPT
    // ========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyV1mut0mR53BKA3sgGg96MoCjYBbEW5GR5ojoxv6Merx86wfrCIfV0HI_KMUpfkxyo/exec';
    
    let registrosCache = [];
    let registrosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 25;

    // ========================================
    // LISTENER PARA RECEBER MENSAGENS DO IFRAME (postMessage)
    // ========================================
    window.addEventListener('message', function(event) {
      console.log('[gerenciar] ‚úÖ Mensagem recebida via postMessage:', event.data);
      
      // Verifica se a mensagem tem o formato esperado
      if (event.data && typeof event.data === 'object') {
        const dados = event.data;
        
        const btn = document.getElementById('btnCarregar');
        const info = document.getElementById('loadingInfo');
        
        if (!btn || !info) {
          console.error('[gerenciar] Elementos n√£o encontrados!');
          return;
        }
        
        btn.disabled = false;
        btn.innerHTML = '<span>üîÑ</span> <span>Carregar Registros</span>';
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        info.classList.remove('animate-pulse');
        
        if (dados.success) {
          registrosCache = dados.registros || [];
          const manterPagina = window.manterPaginaAtual || false;
          renderizarTabela(registrosCache, manterPagina);
          info.textContent = `${registrosCache.length} registro(s) carregado(s) ‚úÖ`;
          info.classList.add('text-green-600', 'font-semibold');
          mostrarAlerta(`‚úÖ ${registrosCache.length} registro(s) carregado(s) com sucesso!`, 'success');
        } else {
          info.textContent = 'Erro ao carregar dados ‚ùå';
          info.classList.add('text-red-600', 'font-semibold');
          mostrarAlerta('‚ùå Erro ao carregar registros', 'error');
        }
      }
    });

    // ========================================
    // FUN√á√ïES DE ALERTA
    // ========================================
    function mostrarAlerta(mensagem, tipo = 'info') {
      const container = document.getElementById('alertContainer');
      const cores = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };
      
      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-lg shadow-md`;
      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <p class="font-medium">${mensagem}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-4">√ó</button>
        </div>
      `;
      
      container.appendChild(alerta);
      setTimeout(() => alerta.remove(), 5000);
    }

    // ========================================
    // CARREGAR REGISTROS DA PLANILHA
    // ========================================
    function carregarRegistros(manterPagina = false) {
      const btn = document.getElementById('btnCarregar');
      const info = document.getElementById('loadingInfo');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">‚è≥</span> <span>Carregando...</span>';
      btn.classList.add('opacity-75', 'cursor-not-allowed');
      info.textContent = 'Buscando dados da planilha...';
      info.classList.add('animate-pulse');
      
      console.log('[gerenciar] carregarRegistros iniciado, manterPagina:', manterPagina);
      
      // Armazena flag para usar no callback
      window.manterPaginaAtual = manterPagina;
      
      // Usa POST com iframe (igual ao envio do formul√°rio - funciona sem autentica√ß√£o)
      let iframe = document.getElementById('data_iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'data_iframe';
        iframe.name = 'data_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      
      // Cria formul√°rio para enviar via POST
      let form = document.getElementById('list_form');
      if (!form) {
        form = document.createElement('form');
        form.id = 'list_form';
        form.method = 'POST';
        form.target = 'data_iframe';
        form.style.display = 'none';
        document.body.appendChild(form);
      }
      
      // Limpa formul√°rio e adiciona campo action
      form.innerHTML = '';
      form.action = APPS_SCRIPT_URL;
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify({ action: 'list' });
      form.appendChild(input);
      
      // Define timeout de seguran√ßa
      setTimeout(() => {
        if (btn.disabled) {
          btn.disabled = false;
          btn.innerHTML = 'üîÑ Carregar Registros';
          info.textContent = 'Timeout - tente novamente';
          mostrarAlerta('‚è±Ô∏è Timeout ao carregar registros', 'error');
        }
      }, 15000);
      
      console.log('[gerenciar] Enviando POST para listar registros');
      form.submit();
    }

    // ========================================
    // RENDERIZAR TABELA COM PAGINA√á√ÉO
    // ========================================
    function renderizarTabela(registros, manterPagina = false) {
      registrosFiltrados = registros || [];
      if (!manterPagina) {
        paginaAtual = 1; // Reset para primeira p√°gina apenas se n√£o for reload
      }
      renderizarPagina();
    }

    function renderizarPagina() {
      const tbody = document.getElementById('corpoTabela');
      const registros = registrosFiltrados;
      
      if (!registros || registros.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <div class="text-5xl">üîç</div>
                <div class="text-lg font-medium">Nenhum registro encontrado</div>
              </div>
            </td>
          </tr>
        `;
        atualizarContadores(0, 0);
        renderizarPaginacao(0);
        return;
      }
      
      // Calcula √≠ndices da pagina√ß√£o
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const registrosPagina = registros.slice(inicio, fim);
      
      tbody.innerHTML = registrosPagina.map((reg, idx) => `
        <tr class="hover:bg-blue-50/50 transition-colors duration-150 border-b border-gray-100" data-nome="${(reg.criancaEstudante || '').toLowerCase()}">
          <td class="px-4 py-4 text-sm text-gray-800 font-medium">${reg.criancaEstudante || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.dataNT || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.idade || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
              ${reg.tipoViolencia || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.cmeiEmef || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
              ${reg.regiao || '-'}
            </span>
          </td>
          <td class="px-4 py-4">
            <div class="flex gap-2 justify-center">
              <button 
                onclick="abrirEdicao(${reg.linha})"
                class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-blue-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>‚úèÔ∏è</span>
                <span>Editar</span>
              </button>
              <button 
                onclick="confirmarExclusao(${reg.linha}, '${(reg.criancaEstudante || '').replace(/'/g, "\\'")}')"
                class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-red-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>üóëÔ∏è</span>
                <span>Excluir</span>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      
      atualizarContadores(registros.length, registrosPagina.length);
      renderizarPaginacao(registros.length);
    }

    // ========================================
    // PAGINA√á√ÉO
    // ========================================
    function renderizarPaginacao(total) {
      const container = document.getElementById('paginacaoControles');
      const totalPaginas = Math.ceil(total / itensPorPagina);
      
      if (totalPaginas <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Bot√£o Anterior
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual - 1})" 
          ${paginaAtual === 1 ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 ${paginaAtual === 1 ? '' : 'group-hover:-translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Anterior
          </span>
        </button>
      `;
      
      // N√∫meros das p√°ginas - mostra no m√°ximo 3 n√∫meros + primeira e √∫ltima
      const maxBotoesVisiveis = 3;
      
      // Se total de p√°ginas √© menor ou igual a 5, mostra todas
      if (totalPaginas <= 5) {
        for (let i = 1; i <= totalPaginas; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
      } else {
        // Sempre mostra primeira p√°gina
        html += `<button onclick="irParaPagina(1)" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === 1 ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">1</button>`;
        
        // Determina quais p√°ginas do meio mostrar
        let inicio, fim;
        
        if (paginaAtual <= 3) {
          // Pr√≥ximo √†s primeiras p√°ginas: mostra 2, 3, 4
          inicio = 2;
          fim = 4;
        } else if (paginaAtual >= totalPaginas - 2) {
          // Pr√≥ximo √†s √∫ltimas p√°ginas: mostra (total-3), (total-2), (total-1)
          inicio = totalPaginas - 3;
          fim = totalPaginas - 1;
        } else {
          // No meio: mostra (atual-1), atual, (atual+1)
          inicio = paginaAtual - 1;
          fim = paginaAtual + 1;
        }
        
        // Adiciona elipse antes se necess√°rio
        if (inicio > 2) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Mostra as p√°ginas do meio
        for (let i = inicio; i <= fim; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
        
        // Adiciona elipse depois se necess√°rio
        if (fim < totalPaginas - 1) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Sempre mostra √∫ltima p√°gina
        html += `<button onclick="irParaPagina(${totalPaginas})" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === totalPaginas ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">${totalPaginas}</button>`;
      }
      
      // Bot√£o Pr√≥ximo
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual + 1})" 
          ${paginaAtual === totalPaginas ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === totalPaginas ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            Pr√≥ximo
            <svg class="w-4 h-4 ${paginaAtual === totalPaginas ? '' : 'group-hover:translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </span>
        </button>
      `;
      
      container.innerHTML = html;
    }

    function irParaPagina(pagina) {
      const totalPaginas = Math.ceil(registrosFiltrados.length / itensPorPagina);
      if (pagina < 1 || pagina > totalPaginas) return;
      paginaAtual = pagina;
      renderizarPagina();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mudarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // FILTRAR TABELA POR NOME
    // ========================================
    function filtrarTabela() {
      const busca = document.getElementById('campoBusca').value.toLowerCase().trim();
      
      if (!busca) {
        registrosFiltrados = registrosCache;
      } else {
        registrosFiltrados = registrosCache.filter(reg => 
          (reg.criancaEstudante || '').toLowerCase().includes(busca)
        );
      }
      
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // ATUALIZAR CONTADORES
    // ========================================
    function atualizarContadores(total, visiveis) {
      document.getElementById('totalRegistros').textContent = total;
      document.getElementById('registrosVisiveis').textContent = visiveis;
    }

    // ========================================
    // ABRIR MODAL DE EDI√á√ÉO
    // ========================================
    function abrirEdicao(linha) {
      const registro = registrosCache.find(r => r.linha === linha);
      
      if (!registro) {
        mostrarAlerta('‚ùå Registro n√£o encontrado!', 'error');
        return;
      }
      
      console.log('[gerenciar] Abrindo edi√ß√£o do registro:', registro);
      console.log('[gerenciar] dataNT_ISO:', registro.dataNT_ISO);
      console.log('[gerenciar] identidadeGenero:', registro.identidadeGenero);
      
      // Preenche TODOS os campos do formul√°rio
      document.getElementById('edit_linha').value = linha;
      document.getElementById('edit_criancaEstudante').value = registro.criancaEstudante || '';
      document.getElementById('edit_dataNT').value = registro.dataNT_ISO || '';
      document.getElementById('edit_idade').value = registro.idade || '';
      document.getElementById('edit_identidadeGenero').value = registro.identidadeGenero || '';
      document.getElementById('edit_pcdTranstorno').value = registro.pcdTranstorno || '';
      document.getElementById('edit_racaCor').value = registro.racaCor || '';
      document.getElementById('edit_tipoViolencia').value = registro.tipoViolencia || '';
      document.getElementById('edit_encaminhamento').value = registro.encaminhamento || '';
      document.getElementById('edit_cmeiEmef').value = registro.cmeiEmef || '';
      document.getElementById('edit_regiao').value = registro.regiao || '';
      document.getElementById('edit_responsavelRegistro').value = registro.responsavelRegistro || '';
      
      // Preenche campos adicionais
      document.getElementById('edit_fonteEscola').value = registro.fonteEscola || '';
      document.getElementById('edit_violenciaEscolaOcorreu').value = registro.violenciaEscolaOcorreu || '';
      document.getElementById('edit_profissionalAutor').value = registro.profissionalAutor || '';
      document.getElementById('edit_estudanteAutor').value = registro.estudanteAutor || '';
      document.getElementById('edit_violenciaNaoEscola').value = registro.violenciaNaoEscola || '';
      document.getElementById('edit_ocorreuEscola').value = registro.ocorreuEscola || '';
      document.getElementById('edit_violenciaInformada').value = registro.violenciaInformada || '';
      
      console.log('[gerenciar] Valores recebidos do backend:');
      console.log('[gerenciar]   - fonteEscola:', registro.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', registro.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', registro.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', registro.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', registro.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', registro.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', registro.violenciaInformada);
      
      console.log('[gerenciar] Campo dataNT preenchido com:', document.getElementById('edit_dataNT').value);
      console.log('[gerenciar] Campo identidadeGenero preenchido com:', document.getElementById('edit_identidadeGenero').value);
      
      // Mostra o modal
      document.getElementById('modalEdicao').classList.add('show');
    }

    // ========================================
    // FECHAR MODAL
    // ========================================
    function fecharModal() {
      document.getElementById('modalEdicao').classList.remove('show');
    }

    // ========================================
    // SALVAR EDI√á√ÉO
    // ========================================
    document.getElementById('formEdicao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const dados = {
        action: 'update',
        linha: document.getElementById('edit_linha').value,
        criancaEstudante: document.getElementById('edit_criancaEstudante').value,
        dataNT: document.getElementById('edit_dataNT').value,
        idade: document.getElementById('edit_idade').value,
        identidadeGenero: document.getElementById('edit_identidadeGenero').value,
        pcdTranstorno: document.getElementById('edit_pcdTranstorno').value,
        racaCor: document.getElementById('edit_racaCor').value,
        tipoViolencia: document.getElementById('edit_tipoViolencia').value,
        encaminhamento: document.getElementById('edit_encaminhamento').value,
        cmeiEmef: document.getElementById('edit_cmeiEmef').value,
        regiao: document.getElementById('edit_regiao').value,
        responsavelRegistro: document.getElementById('edit_responsavelRegistro').value,
        // Campos adicionais
        fonteEscola: document.getElementById('edit_fonteEscola').value,
        violenciaEscolaOcorreu: document.getElementById('edit_violenciaEscolaOcorreu').value,
        profissionalAutor: document.getElementById('edit_profissionalAutor').value,
        estudanteAutor: document.getElementById('edit_estudanteAutor').value,
        violenciaNaoEscola: document.getElementById('edit_violenciaNaoEscola').value,
        ocorreuEscola: document.getElementById('edit_ocorreuEscola').value,
        violenciaInformada: document.getElementById('edit_violenciaInformada').value
      };
      
      console.log('[gerenciar] === DADOS DE ATUALIZA√á√ÉO ===');
      console.log('[gerenciar] Campos adicionais sendo enviados:');
      console.log('[gerenciar]   - fonteEscola:', dados.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', dados.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', dados.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', dados.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', dados.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', dados.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', dados.violenciaInformada);
      console.log('[gerenciar] Payload completo:', JSON.stringify(dados));
      
      mostrarAlerta('üîÑ Salvando altera√ß√µes...', 'info');
      enviarAtualizacao(dados);
    });

    function enviarAtualizacao(dados) {
      console.log('[gerenciar] enviarAtualizacao chamado');
      
      // Cria form oculto
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = 'hidden_iframe';
      form.style.display = 'none';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'data';
      input.value = JSON.stringify(dados);
      form.appendChild(input);
      
      // Cria iframe
      let iframe = document.getElementById('hidden_iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.name = 'hidden_iframe';
        iframe.id = 'hidden_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      
      iframe.onload = function() {
        console.log('[gerenciar] Atualiza√ß√£o conclu√≠da!');
        fecharModal();
        mostrarAlerta('‚úÖ Registro atualizado com sucesso!', 'success');
        // Recarrega os dados ap√≥s 300ms mantendo a p√°gina atual
        setTimeout(() => {
          carregarRegistros(true);
        }, 300);
        document.body.removeChild(form);
      };
      
      document.body.appendChild(form);
      form.submit();
    }

    // ========================================
    // CONFIRMAR EXCLUS√ÉO
    // ========================================
    function confirmarExclusao(linha, nome) {
      const confirmacao = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO - EXCLUS√ÉO PERMANENTE\n\n` +
        `Deseja realmente EXCLUIR o registro de:\n` +
        `"${nome}"\n\n` +
        `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
        `Clique em OK para confirmar a exclus√£o.`
      );
      
      if (confirmacao) {
        mostrarAlerta('üîÑ Excluindo registro...', 'info');
        excluirRegistro(linha);
      }
    }

    function excluirRegistro(linha) {
      console.log('[gerenciar] Excluindo registro da linha:', linha);
      
      const dados = {
        action: 'delete',
        linha: linha
      };
      
      // Cria form oculto
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = 'hidden_iframe';
      form.style.display = 'none';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'data';
      input.value = JSON.stringify(dados);
      form.appendChild(input);
      
      // Cria iframe
      let iframe = document.getElementById('hidden_iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.name = 'hidden_iframe';
        iframe.id = 'hidden_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      
      iframe.onload = function() {
        console.log('[gerenciar] Exclus√£o conclu√≠da!');
        mostrarAlerta('üóëÔ∏è Registro exclu√≠do com sucesso!', 'success');
        // Recarrega os dados ap√≥s 300ms mantendo a p√°gina atual
        setTimeout(() => {
          carregarRegistros(true);
        }, 300);
        document.body.removeChild(form);
      };
      
      document.body.appendChild(form);
      form.submit();
    }
  </script>

</body>
</html>
