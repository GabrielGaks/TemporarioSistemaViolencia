# ๐ DIAGRAMA DO SISTEMA DE MONITORAMENTO

## ๐๏ธ Arquitetura Completa

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SISTEMA DE MONITORAMENTO                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 1: GOOGLE SHEETS (Fonte de Dados)                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  Planilha: Pรกgina1                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  ID   โ Nome      โ Idade โ Tipo Violรชncia โ ... โ ID (Y) โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ ...   โ ...       โ ...   โ ...            โ ... โ NOT004 โ   โ
โ  โ Joรฃo  โ Duarte    โ 10    โ Fรญsica         โ ... โ NOT005 โ โ รltima
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 2: TRIGGER TIME-BASED (Execuรงรฃo Automรกtica)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ         โฐ Trigger Every 1 Minute                                    โ
โ         Executa: monitorarAlteracoes()                              โ
โ                                                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                   โ
โ  โ 14:00 โ Execuรงรฃo 1                         โ                   โ
โ  โ 14:01 โ Execuรงรฃo 2 (MUDANรA! ๐)          โ                   โ
โ  โ 14:02 โ Execuรงรฃo 3                         โ                   โ
โ  โ 14:03 โ Execuรงรฃo 4                         โ                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                   โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 3: ARMAZENAMENTO LOCAL (PropertiesService)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  MONITOR_LAST_ID                  = "NOT004"                         โ
โ  MONITOR_ALL_RECORDS              = [JSON array de registros]       โ
โ  MONITOR_LAST_CHECK              = "2025-01-15T14:00:00Z"          โ
โ  MONITOR_UPDATE_COUNT            = "0"                              โ
โ  MONITOR_ENABLED                 = "true"                           โ
โ                                                                       โ
โ  โ Carregamento Rรกpido (sem recarregar planilha)                  โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 4: LรGICA DE COMPARAรรO (Code-Monitoramento.gs)              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  LEITURA:                                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ  โ รltimo ID SALVO: NOT004         โ                                โ
โ  โ รltimo ID ATUAL: NOT005 (novo!)  โ                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ           โ                                                           โ
โ  COMPARAรรO:                                                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ  โ NOT004 === NOT005 ?             โ                                โ
โ  โ โ NรO โ MUDANรA DETECTADA! ๐ โ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ           โ                                                           โ
โ  AรรES:                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ  โ โ Salva novo ID (NOT005)       โ                                โ
โ  โ โ Atualiza registros locais    โ                                โ
โ  โ โ Incrementa contador         โ                                โ
โ  โ โ Dispara notificaรงรฃo         โ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 5: NOTIFICAรรES (Mรบltiplos Canais)                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  dispararNotificacao()                                               โ
โ  โโ ๐ง Email (Gmail)                                                โ
โ  โโ ๐ฌ Slack Webhook                                                โ
โ  โโ ๐ฎ Discord Webhook                                              โ
โ  โโ ๐ Planilha Admin                                               โ
โ  โโ ๐ Dashboard Update                                             โ
โ  โโ ๐ API Webhook Externo                                          โ
โ  โโ ๐ Combinadas (mรบltiplos canais)                               โ
โ                                                                       โ
โ  "๐ Novo caso detectado: Joรฃo Duarte (ID: NOT005)"                โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAMADA 6: LOGS E AUDITORIA                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  ๐ VERIFICAรรO DE ALTERAรรES - 2025-01-15T14:01:00Z               โ
โ  ๐ รltimo ID SALVO: NOT004                                          โ
โ  ๐ รltimo ID ATUAL: NOT005                                          โ
โ  ๐ ALTERAรรO DETECTADA!                                             โ
โ  ๐พ Novo ID salvo: NOT005                                            โ
โ  ๐ Total de atualizaรงรตes: 1                                         โ
โ  ๐ง Notificaรงรฃo disparada                                            โ
โ  โ ALTERAรรO PROCESSADA COM SUCESSO                                โ
โ                                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Fluxo de Execuรงรฃo

```
INรCIO
   โ
   โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ TRIGGER DISPARA         โ
โ (a cada minuto)         โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ monitorarAlteracoes()                       โ
โ                                             โ
โ 1. Verifica se estรก HABILITADO              โ
โ 2. Abre a planilha                          โ
โ 3. Obtรฉm รบltimo ID SALVO                    โ
โ 4. Obtรฉm รบltimo ID ATUAL                    โ
โ 5. Compara IDs                              โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
     โโโโโโโโโดโโโโโโโโโ
     โ                โ
     โผ                โผ
  SEM MUDANรA     MUDANรA DETECTADA
     โ                โ
     โ                โผ
     โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ         โ procesarAlteracao()       โ
     โ         โ                           โ
     โ         โ 1. Obtรฉm dados da linha  โ
     โ         โ 2. Salva registros       โ
     โ         โ 3. Salva novo ID        โ
     โ         โ 4. Incrementa contador  โ
     โ         โ 5. Atualiza timestamp   โ
     โ         โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ                      โ
     โ                      โผ
     โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ         โ dispararNotificacao()       โ
     โ         โ                             โ
     โ         โ Envia para:                 โ
     โ         โ โข Email                     โ
     โ         โ โข Slack                     โ
     โ         โ โข Discord                   โ
     โ         โ โข ou customizado            โ
     โ         โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
     โ                      โ
     โโโโโโโโโโโโฌโโโโโโโโโโโโ
                โ
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ LOG RESULTADO  โ
        โ                โ
        โ โ OK ou      โ
        โ ๐ MUDANรA    โ
        โ PROCESSADA     โ
        โโโโโโโโโโฌโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโ
        โ AGUARDA PRรXIMO  โ
        โ TRIGGER (1 min)  โ
        โโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Exemplo Completo (Timeline)

```
TEMPO    โ AรรO                           โ STATUS
โโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
14:00:00 โ iniciarMonitoramento()         โ โ Sistema iniciado
         โ รltimo ID salvo: NOT004        โ ๐ Registros salvos: 5
         โ                                โ 
14:01:00 โ monitorarAlteracoes() [1ยช]    โ โ Sem mudanรงas
         โ Compara: NOT004 === NOT004     โ ๐ Total atualizaรงรตes: 0
         โ                                โ
14:02:00 โ monitorarAlteracoes() [2ยช]    โ โ Sem mudanรงas
         โ Compara: NOT004 === NOT004     โ ๐ Total atualizaรงรตes: 0
         โ                                โ
14:02:45 โ ๐ค Usuรกrio ADICIONA novo      โ ๐ Novo registro com
         โ    registro na planilha        โ    ID: NOT005
         โ                                โ
14:03:00 โ monitorarAlteracoes() [3ยช]    โ ๐ ALTERAรรO DETECTADA!
         โ Compara: NOT004 !== NOT005    โ 
         โ                                โ ๐ง procesarAlteracao()
         โ โข Salva novo ID: NOT005       โ    executada
         โ โข Atualiza registros          โ ๐ Registros: 6
         โ โข Incrementa contador: 1      โ ๐ Notificaรงรฃo disparada
         โ                                โ
         โ dispararNotificacao()          โ ๐จ Email enviado para
         โ โข Email: admin@org.com        โ    admin@org.com
         โ โข Nome: Joรฃo Duarte           โ ๐ฌ Slack notificado
         โ โข ID: NOT005                  โ
         โ                                โ
14:04:00 โ monitorarAlteracoes() [4ยช]    โ โ Sem mudanรงas
         โ Compara: NOT005 === NOT005    โ ๐ Total atualizaรงรตes: 1
         โ                                โ
14:05:00 โ monitorarAlteracoes() [5ยช]    โ โ Sem mudanรงas
         โ Compara: NOT005 === NOT005    โ ๐ Total atualizaรงรตes: 1
         โ                                โ
```

---

## ๐ฏ Decisรฃo de Detecรงรฃo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Lรช รltimo ID SALVO e ATUAL                 โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
    โโโโโโโโโโโโโโโโโโโ
    โ Sรฃo iguais?     โ
    โโโโโโโโโโฌโโโโโโโโโ
             โ
    โโโโโโโโโโดโโโโโโโโโ
    โ                 โ
   SIM               NรO
    โ                 โ
    โผ                 โผ
โโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโ
โ โ LOG   โ     โ ๐ MUDANรA DETECTADA โ
โ "Sem     โ     โ                      โ
โmudanรงas" โ     โ โข Processa mudanรงa   โ
โ          โ     โ โข Salva novo ID      โ
โ Prรณxima  โ     โ โข Dispara notif.     โ
โverific. โ     โ                      โ
โem 1 min  โ     โ Prรณxima verific.     โ
โ          โ     โ em 1 min             โ
โโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐พ Estrutura de Dados

### PropertiesService (Armazenamento Local)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITOR_LAST_ID                       โ
โ                                                 โ
โ  "NOT005"  โ รltimo ID processado              โ
โ                                                 โ
โ (String simples, comparado a cada verificaรงรฃo) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITOR_ALL_RECORDS                            โ
โ                                                          โ
โ  [                                                       โ
โ    { id: "NOT001", nome: "Joรฃo", data: "..." },        โ
โ    { id: "NOT002", nome: "Maria", data: "..." },       โ
โ    { id: "NOT003", nome: "Pedro", data: "..." },       โ
โ    { id: "NOT004", nome: "Ana", data: "..." },         โ
โ    { id: "NOT005", nome: "Carlos", data: "..." }       โ
โ  ]  โ JSON array de todos os registros                 โ
โ                                                          โ
โ (Atualizado quando mudanรงa detectada)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITOR_LAST_CHECK                             โ
โ                                                          โ
โ  "2025-01-15T14:03:00Z"  โ Timestamp ISO                โ
โ                                                          โ
โ (Atualizado a cada verificaรงรฃo)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITOR_UPDATE_COUNT                           โ
โ                                                          โ
โ  "1"  โ Total de mudanรงas detectadas desde o inรญcio    โ
โ                                                          โ
โ (Incrementado quando mudanรงa processada)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITOR_ENABLED                                โ
โ                                                          โ
โ  "true"  โ Sistema ativo ou inativo                     โ
โ                                                          โ
โ (Pode ser alterado por desativarMonitoramento())       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Canais de Notificaรงรฃo

```
dispararNotificacao()
โ
โโ ๐ง Email (Gmail)
โ  โโ GmailApp.sendEmail(...)
โ
โโ ๐ฌ Slack Webhook
โ  โโ UrlFetchApp.fetch(SLACK_WEBHOOK, ...)
โ
โโ ๐ฎ Discord Webhook
โ  โโ UrlFetchApp.fetch(DISCORD_WEBHOOK, ...)
โ
โโ ๐ Planilha Admin
โ  โโ adminSheet.appendRow(...)
โ
โโ ๐ Dashboard
โ  โโ dashboardSheet.getRange(...).setValue(...)
โ
โโ ๐ Webhook Customizado
โ  โโ UrlFetchApp.fetch(API_URL, ...)
โ
โโ ๐ Combinada
   โโ Email + Slack
   โโ Email + Discord
   โโ Email + Planilha
   โโ Todos os anteriores
```

---

## ๐ Estado do Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        STATUS DO MONITORAMENTO          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                         โ
โ Status: ๐ด ATIVO / โ INATIVO          โ
โ                                         โ
โ ๐ รltimo ID: NOT005                   โ
โ ๐ Registros Salvos: 5                 โ
โ ๐ Total de Atualizaรงรตes: 1            โ
โ โฐ รltima Verificaรงรฃo: 14:03:00        โ
โ                                         โ
โ Prรณxima verificaรงรฃo: Em 1 minuto       โ
โ                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โจ Resumo Visual

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          SISTEMA DE MONITORAMENTO DE PLANILHA             โ
โ                                                            โ
โ  Google Sheets  โ  PropertiesService  โ  Comparaรงรฃo      โ
โ      (Fonte)        (Armazenamento)        (Detecรงรฃo)     โ
โ                                                            โ
โ         โ                    โ                   โ         โ
โ     รltimo ID          รltimo ID SALVO   Hรก mudanรงa?      โ
โ     Atual              Todos registros   SIM โ Notificar  โ
โ                                          NรO โ Aguardar   โ
โ                                                            โ
โ  โฐ Trigger a cada minuto (configurรกvel)                โ
โ  ๐ง Notificaรงรตes em mรบltiplos canais                   โ
โ  ๐พ Armazenamento local (sem recarregar)               โ
โ  โ Sem falsos positivos                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Versรฃo:** 1.0
**Data:** 2025-01-15
