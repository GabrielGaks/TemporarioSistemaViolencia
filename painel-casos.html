<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Painel de Casos de Violência Escolar</title>

  <!-- Esconde conteúdo IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }

    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>

  <!-- TailwindCSS via CDN -->
  <script>
    // Suprime o aviso de produção do Tailwind CSS
    (function () {
      const originalWarn = console.warn;
      let tailwindWarningSuppressed = false;

      console.warn = function (...args) {
        const message = args.join(' ');
        // Suprime aviso do Tailwind CSS sobre produção
        if (message.includes('cdn.tailwindcss.com should not be used') ||
          message.includes('To use Tailwind CSS in production') ||
          message.includes('install it as a PostCSS plugin') ||
          message.includes('use the Tailwind CLI')) {
          tailwindWarningSuppressed = true;
          return; // Suprime o aviso
        }
        originalWarn.apply(console, args);
      };

      // Restaura console.warn após alguns segundos (Tailwind já terá carregado)
      setTimeout(() => {
        if (tailwindWarningSuppressed) {
          console.warn = originalWarn;
        }
      }, 5000);
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">
  <link rel="stylesheet" href="assets/css/statistics-saas.css">
  <link rel="stylesheet" href="assets/css/dashboard-saas.css">

  <!-- Configuração Centralizada -->
  <script src="config.js"></script>
  <script src="assets/js/utils/config-loader.js"></script>

  <!-- Sistema de Transições entre Páginas -->
  <script src="assets/js/utils/page-transitions.js"></script>

  <!-- Sistema de Loading Indicator Elegante -->
  <script src="assets/js/utils/loading-indicator.js"></script>

  <!-- Sistema de Scroll Reveal - Revelação Progressiva -->
  <script src="assets/js/utils/scroll-reveal.js"></script>

  <!-- Sistema de Cache e Notificações -->
  <link rel="stylesheet" href="assets/css/update-notification.css">
  <script src="assets/js/utils/data-cache.js"></script>
  <script src="assets/js/utils/change-detector.js"></script>
  <script src="assets/js/utils/update-notification.js"></script>

  <!-- Sistema de API e Segurança -->
  <script src="assets/js/utils/security.js"></script>
  <script src="assets/js/utils/api.js"></script>

  <!-- Sistema de Navegação por Perfil -->
  <script src="assets/js/utils/navigation.js"></script>

  <!-- Módulo Centralizado de Escolas e Técnicos -->
  <script src="assets/js/utils/escolas-tecnico.js"></script>

  <!-- Dashboard e Estatísticas (arquivo separado para evitar HTML muito longo) -->
  <script src="assets/js/modules/dashboard-stats.js"></script>

  <!-- Biblioteca para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <!-- Biblioteca para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Intro.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
  <!-- Onboarding CSS -->
  <link rel="stylesheet" href="assets/css/onboarding.css">

  <style>
    /* Scroll behavior suave e relaxado para toda a página */
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 100px;
      /* Adiciona espaço no topo ao scrollar */
    }

    /* Customiza a duração do scroll suave via CSS */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }

    /* Skeleton Loading Animation */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    .chart-skeleton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f6f7f8;
      background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
      background-repeat: no-repeat;
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear forwards;
      z-index: 10;
      border-radius: 0.5rem;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Animação suave para linhas da tabela */
    .record-row {
      animation: slideInRow 0.3s ease-out backwards;
    }

    @keyframes slideInRow {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Delay escalonado para cada linha */
    .record-row:nth-child(1) {
      animation-delay: 0.05s;
    }

    .record-row:nth-child(2) {
      animation-delay: 0.1s;
    }

    .record-row:nth-child(3) {
      animation-delay: 0.15s;
    }

    .record-row:nth-child(4) {
      animation-delay: 0.2s;
    }

    .record-row:nth-child(5) {
      animation-delay: 0.25s;
    }

    .record-row:nth-child(6) {
      animation-delay: 0.3s;
    }

    .record-row:nth-child(7) {
      animation-delay: 0.35s;
    }

    .record-row:nth-child(8) {
      animation-delay: 0.4s;
    }

    .record-row:nth-child(9) {
      animation-delay: 0.45s;
    }

    .record-row:nth-child(10) {
      animation-delay: 0.5s;
    }

    /* Checkboxes personalizados elegantes */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .custom-checkbox:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
    }

    .custom-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      color: white;
      font-size: 12px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes checkPop {
      0% {
        transform: translate(-50%, -50%) scale(0);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }

      100% {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Animações para notificação de nova notificação */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }

      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* ========================================
       NOTIFICAÇÃO ELEGANTE E COMPACTA
       ======================================== */
    .notificacao-nova-elegante {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 360px;
      max-width: calc(100vw - 40px);
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 1px 3px rgba(0, 0, 0, 0.05);
      z-index: 10000;
      overflow: hidden;
      opacity: 0;
      transform: translateX(100%) scale(0.95);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    }

    .notificacao-nova-elegante.notificacao-visible {
      animation: notificacaoEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .notificacao-nova-elegante.notificacao-exit {
      animation: notificacaoExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes notificacaoEntrance {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes notificacaoExit {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }
    }

    .notificacao-conteudo {
      position: relative;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: #ffffff;
    }

    .notificacao-icone-container {
      position: relative;
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #eff6ff;
      border-radius: 8px;
      animation: notificacaoIconContainerPulse 2s ease-in-out infinite;
    }

    @keyframes notificacaoIconContainerPulse {

      0%,
      100% {
        background: #eff6ff;
        transform: scale(1);
      }

      50% {
        background: #dbeafe;
        transform: scale(1.05);
      }
    }

    .notificacao-icone {
      width: 20px;
      height: 20px;
      color: #3b82f6;
      animation: notificacaoIconEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes notificacaoIconEntrance {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }

      60% {
        transform: scale(1.2) rotate(10deg);
      }

      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .notificacao-texto {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .notificacao-titulo {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .notificacao-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: #3b82f6;
      color: white;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-radius: 4px;
      flex-shrink: 0;
      animation: notificacaoBadgeEntrance 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes notificacaoBadgeEntrance {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      50% {
        transform: scale(1.15);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .notificacao-mensagem-principal {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.4;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.2s both;
    }

    @keyframes notificacaoTextFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notificacao-descricao {
      font-size: 12px;
      color: #64748b;
      line-height: 1.5;
      word-wrap: break-word;
      animation: notificacaoTextFadeIn 0.6s ease-out 0.3s both;
    }

    .notificacao-acoes {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .notificacao-btn-atualizar {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.4s both;
    }

    @keyframes notificacaoButtonEntrance {
      from {
        opacity: 0;
        transform: translateX(10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notificacao-btn-atualizar:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .notificacao-btn-atualizar:active {
      transform: translateY(0);
    }

    .notificacao-btn-atualizar svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }

    .notificacao-btn-atualizar:hover svg {
      transform: rotate(180deg);
    }

    .notificacao-btn-fechar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      animation: notificacaoButtonEntrance 0.5s ease-out 0.5s both;
    }

    .notificacao-btn-fechar:hover {
      background: #f1f5f9;
      color: #64748b;
      transform: rotate(90deg) scale(1.1);
    }

    .notificacao-progresso {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 50%, #3b82f6 100%);
      background-size: 200% 100%;
      width: 100%;
      transform-origin: left;
      animation: notificacaoProgresso 15s linear forwards, notificacaoProgressoShimmer 2s linear infinite;
    }

    @keyframes notificacaoProgresso {
      from {
        transform: scaleX(1);
      }

      to {
        transform: scaleX(0);
      }
    }

    @keyframes notificacaoProgressoShimmer {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 200% 50%;
      }
    }

    /* Responsivo */
    @media (max-width: 640px) {
      .notificacao-nova-elegante {
        width: calc(100vw - 32px);
        right: 16px;
        top: 16px;
      }

      .notificacao-conteudo {
        padding: 0;
      }
    }

    .checkbox-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      font-size: 0.875rem;
    }

    .checkbox-container:hover .checkbox-label {
      color: #1e40af;
    }

    /* Painel avançado colapsável */
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }

    .advanced-panel.open {
      max-height: 2000px;
      opacity: 1;
      overflow: visible !important;
    }

    .filter-section.show {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toggle-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .checkbox-container {
      transition: all 0.2s ease;
    }

    .checkbox-container:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
    }

    /* Cards de filtros clicáveis */
    .filter-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      height: 56px;
      min-height: 56px;
      padding: 0.75rem !important;
      display: flex;
      align-items: center;
    }

    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.55);
      border-radius: 1rem;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow:
        0 22px 55px rgba(15, 23, 42, 0.18),
        0 10px 22px rgba(15, 23, 42, 0.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .autocomplete-item:first-child {
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }

    .autocomplete-item:last-child {
      border-bottom-left-radius: 1rem;
      border-bottom-right-radius: 1rem;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
      background-color: #eff6ff;
    }

    .autocomplete-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .autocomplete-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .autocomplete-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .autocomplete-nome {
      font-size: 14px;
      color: #374151;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .autocomplete-list::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-list::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .autocomplete-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .autocomplete-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    #filterEscolaSearch.autocomplete-open {
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }

    /* ===== Escola Multi-Select Component ===== */
    .escola-multiselect {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #ffffff;
      overflow: hidden;
    }

    .escola-chips-area {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px;
      min-height: 40px;
      align-items: center;
      border-bottom: 1px solid #f1f5f9;
      background: #f8fafc;
    }

    .escola-chips-area:empty::after,
    .escola-chips-area .escola-chips-empty {
      content: "Nenhuma escola selecionada";
      font-size: 12px;
      color: #94a3b8;
      font-style: italic;
    }

    .escola-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px 6px;
      border-radius: 9999px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      font-size: 12px;
      color: #334155;
      max-width: 100%;
      animation: escolaChipIn 0.2s ease;
    }

    @keyframes escolaChipIn {
      from {
        opacity: 0;
        transform: scale(0.92);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .escola-chip .autocomplete-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .escola-chip-label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 30ch;
    }

    .escola-chip-remove {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: none;
      background: #f1f5f9;
      color: #64748b;
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s ease;
      padding: 0;
    }

    .escola-chip-remove:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .escola-search-wrapper {
      position: relative;
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      background: #ffffff;
    }

    .escola-search-wrapper svg {
      position: absolute;
      left: 22px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      pointer-events: none;
    }

    .escola-search-input {
      width: 100%;
      padding: 8px 12px 8px 34px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      color: #334155;
      background: #f8fafc;
      outline: none;
      transition: all 0.2s ease;
    }

    .escola-search-input:focus {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
      background: #ffffff;
    }

    .escola-search-input::placeholder {
      color: #94a3b8;
    }

    .escola-list-panel {
      max-height: 0;
      overflow-y: auto;
      padding: 0;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .escola-list-panel.is-expanded {
      max-height: 280px;
      padding: 4px 0;
      opacity: 1;
      pointer-events: auto;
    }

    .escola-list-panel::-webkit-scrollbar {
      width: 5px;
    }

    .escola-list-panel::-webkit-scrollbar-track {
      background: transparent;
    }

    .escola-list-panel::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .escola-list-panel::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .escola-section-label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #94a3b8;
      user-select: none;
    }

    .escola-section-label .escola-section-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 16px;
      padding: 0 5px;
      border-radius: 9999px;
      background: #e2e8f0;
      font-size: 10px;
      font-weight: 700;
      color: #64748b;
    }

    .escola-divider {
      height: 1px;
      margin: 4px 14px;
      background: #e2e8f0;
    }

    .escola-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      cursor: pointer;
      transition: background-color 0.15s ease;
      user-select: none;
    }

    .escola-list-item:hover {
      background-color: #f1f5f9;
    }

    .escola-list-item.is-selected {
      background-color: #eff6ff;
    }

    .escola-list-item.is-selected:hover {
      background-color: #dbeafe;
    }

    .escola-list-checkbox {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 2px solid #cbd5e1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .escola-list-item.is-selected .escola-list-checkbox {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .escola-list-checkbox svg {
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .escola-list-item.is-selected .escola-list-checkbox svg {
      opacity: 1;
    }

    .escola-list-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
      flex: 1;
    }

    .escola-list-nome {
      font-size: 13px;
      color: #334155;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .escola-list-sigla {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 1px;
    }

    .escola-list-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
      letter-spacing: 0.04em;
    }

    .escola-list-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .escola-list-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .escola-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px 14px;
      gap: 6px;
      color: #94a3b8;
    }

    .escola-empty-state svg {
      color: #cbd5e1;
    }

    .escola-empty-state span {
      font-size: 13px;
    }

    /* ===== End Escola Multi-Select ===== */

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      min-height: 44px;
    }

    .selected-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      font-size: 12px;
      color: #374151;
      max-width: 100%;
    }

    .deficiency-tag-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 22px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.02em;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
    }

    @keyframes deficiencyBadgePop {
      0% {
        transform: scale(0.85) translateY(2px);
        opacity: 0.65;
      }

      55% {
        transform: scale(1.12) translateY(-1px);
        opacity: 1;
      }

      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    @keyframes deficiencyBadgeOut {
      0% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }

      100% {
        transform: scale(0.78) translateY(2px);
        opacity: 0;
      }
    }

    .deficiency-tag-badge.badge-pop {
      animation: deficiencyBadgePop 220ms cubic-bezier(0.16, 1, 0.3, 1);
      will-change: transform, opacity;
    }

    .deficiency-tag-badge.badge-out {
      animation: deficiencyBadgeOut 180ms ease-in forwards;
      will-change: transform, opacity;
    }

    /* Dropdown do autocomplete por cima + animação */
    .autocomplete-list {
      z-index: 9999;
      will-change: transform, opacity;
      transform-origin: top;
    }

    .autocomplete-list.show {
      display: block;
      animation: autocompleteIn 160ms ease-out;
    }

    .autocomplete-list.hide {
      display: block;
      animation: autocompleteOut 140ms ease-in forwards;
    }

    @keyframes autocompleteIn {
      from {
        opacity: 0;
        transform: translateY(-6px) scale(0.985);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes autocompleteOut {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateY(-6px) scale(0.985);
      }
    }

    .selected-tag-label {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 52ch;
    }

    .selected-tag-remove {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      line-height: 1;
      cursor: pointer;
      flex-shrink: 0;
    }

    .selected-tag-remove:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .filter-card-title {
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 10.5rem;
      transition: none !important;
      transform: none !important;
      pointer-events: none;
    }

    .filter-card-icon {
      transition: none;
      transform: none !important;
      pointer-events: none;
    }

    .filter-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .filter-card:hover::before {
      left: 100%;
    }

    .filter-card:hover {
      transform: translateY(-2px);
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .filter-card-icon {
      transition: none;
      transform: none !important;
      pointer-events: none;
    }

    .filter-card.active {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    /* ── Chip/Pill styling para os grupos de filtros ── */
    details.filter-group {
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-width: 1px;
      border-style: solid;
      border-color: #e2e8f0;
      border-radius: 9999px;
      overflow: visible;
      background: #f8fafc;
    }

    details.filter-group>summary {
      position: relative;
      overflow: hidden;
      min-height: auto;
      height: 38px;
      border-radius: 9999px;
      padding: 0 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      cursor: pointer;
      list-style: none;
    }

    details.filter-group>summary::-webkit-details-marker {
      display: none;
    }

    /* Shimmer desativado para pills compactas */
    details.filter-group>summary::before {
      display: none;
    }

    details.filter-group:has(> summary:hover) {
      border-color: #93c5fd;
      background: #eff6ff;
      box-shadow: 0 1px 4px rgba(59, 130, 246, 0.12);
    }

    details.filter-group[data-expanded="true"],
    details.filter-group.is-active {
      border-color: #3b82f6;
      background: #eff6ff;
      box-shadow: 0 1px 6px rgba(37, 99, 235, 0.18);
    }

    details.filter-group[data-expanded="true"]>summary {
      background: transparent;
    }

    /* ── Layout flex horizontal (row de pills) ── */
    .filters-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.625rem;
      align-items: center;
      position: relative;
      z-index: 20;
    }

    /* No modo "painel", o conteúdo do group não aparece na faixa (apenas no advancedPanel) */
    details.filter-group[data-mode="panel"]>.filter-group-content {
      display: none;
    }

    /* Painel abaixo (mesma lógica do backup) */
    #advancedPanelContent .filter-group-content {
      display: block;
    }

    #advancedPanel {
      position: relative;
      z-index: 10;
    }

    /* Conteúdo do painel com transição suave e relaxada */
    #advancedPanelContent {
      transition: opacity 450ms cubic-bezier(0.4, 0, 0.2, 1),
        transform 500ms cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    /* Animação RÁPIDA para troca entre filtros */
    #advancedPanelContent.is-leaving {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
      /* Animação de saída RÁPIDA para troca entre filtros */
      transition: opacity 200ms cubic-bezier(0.4, 0, 1, 1),
        transform 200ms cubic-bezier(0.4, 0, 1, 1);
    }

    /* Animação LENTA para fechamento do menu */
    #advancedPanelContent.is-leaving-slow {
      opacity: 0;
      transform: translateY(-10px) scale(0.97);
      /* Animação de saída LENTA e suave para fechamento */
      transition: opacity 400ms cubic-bezier(0.4, 0, 0.6, 1),
        transform 400ms cubic-bezier(0.4, 0, 0.6, 1);
    }

    #advancedPanelContent.is-entering {
      opacity: 0;
      transform: translateY(10px) scale(0.97);
      /* Animação de entrada rápida para não atrasar */
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
        transform 350ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Chevron visível no modo painel (dentro da pill) */
    details.filter-group[data-mode="panel"] .filter-group-chevron {
      display: inline !important;
      font-size: 10px;
      color: #94a3b8;
      transition: transform 0.2s ease, color 0.2s ease;
      margin-left: 2px;
      flex-shrink: 0;
    }

    details.filter-group.is-active .filter-group-chevron {
      transform: rotate(180deg);
      color: #3b82f6;
    }

    /* Badge inline dentro da pill (não mais position absolute) */
    details.filter-group[data-mode="panel"]>summary .filter-card-badge {
      position: relative !important;
      top: auto !important;
      right: auto !important;
      z-index: 50 !important;
      pointer-events: none !important;
      display: none;
      align-items: center;
      justify-content: center;
      height: 18px !important;
      line-height: 18px !important;
      min-width: 18px !important;
      padding: 0 4px !important;
      border-radius: 9999px !important;
      font-size: 10px !important;
      font-weight: 700 !important;
      background: #2563eb !important;
      color: #ffffff !important;
      margin: 0 0 0 4px !important;
      border: none !important;
      box-shadow: none !important;
      text-align: center;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Contraste/organização entre categorias dentro do painel */
    #advancedPanelContent .filter-group-content>.px-4 {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #advancedPanelContent .filter-group-content>.px-4>div {
      padding: 12px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
    }

    #advancedPanelContent .filter-group-content>.px-4>div>h4 {
      margin-bottom: 10px !important;
    }

    /* Pill ativa não precisa de grid-column (layout é flex agora) */

    .badge-count {
      animation: badgePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      margin-left: 0.75rem;
      /* Espaçamento entre o texto e o badge */
    }

    @keyframes badgePop {
      0% {
        transform: scale(0);
      }

      50% {
        transform: scale(1.2);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Grupos de Encaminhamento - REFINAMENTO SAAS */
    .encaminhamento-group {
      border: 1px solid #e2e8f0;
      /* Borda mais leve e elegante */
      border-radius: 0.5rem;
      /* Radius mais moderno */
      overflow: hidden;
      transition: all 0.2s ease-in-out;
      background: white;
      margin-bottom: 0.75rem;
      /* Mais espaçamento entre grupos */
    }

    .encaminhamento-group:hover {
      border-color: #cbd5e1;
      /* Feedback sutil no hover do grupo */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      /* Padding refinado */
      background: #f8fafc;
      /* Fundo muito leve */
      cursor: pointer;
      transition: background 0.15s ease;
      border-bottom: 1px solid transparent;
      /* Borda invisível por padrão */
    }

    .encaminhamento-group.expanded .group-header {
      border-bottom-color: #e2e8f0;
      /* Borda aparece quando expandido */
      background: #ffffff;
    }

    .group-header:hover {
      background: #f1f5f9;
    }

    .group-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .group-checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .group-checkbox-wrapper input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      transition: all 0.15s ease;
    }

    .group-checkbox-wrapper input[type="checkbox"]:checked,
    .group-checkbox-wrapper input[type="checkbox"]:indeterminate {
      background-color: #3b82f6;
      border-color: #3b82f6;
    }

    .group-title {
      font-weight: 600;
      color: #334155;
      /* Texto cinza escuro profissional */
      font-size: 0.9rem;
      letter-spacing: -0.01em;
    }

    .group-counter {
      font-size: 0.8rem;
      color: #64748b;
      font-weight: 500;
      margin-left: 0.25rem;
      opacity: 0;
      transform: translateX(-5px);
      transition: all 0.2s ease;
    }

    .group-counter.visible {
      opacity: 1;
      transform: translateX(0);
    }

    /* Badges antigos removidos/escondidos em favor do contador de texto simples se preferir, 
       mas no plano descrevemos contador. Vamos manter o estilo de badge se o usuário quiser, 
       mas o requisito 1 pede "Rede de Saúde (2)". Vamos estilizar o span do contador. */

    .toggle-icon {
      width: 1.125rem;
      height: 1.125rem;
      transition: transform 0.2s ease;
      color: #94a3b8;
    }

    .encaminhamento-group.expanded .toggle-icon {
      transform: rotate(180deg);
      color: #64748b;
    }

    .group-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    .group-body.expanded {
      max-height: 1000px;
      /* Valor arbitrário alto para permitir expansão */
    }

    .group-body-content {
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* Estilo dos itens (subitens) - Refinado */
    .checkbox-container-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
      user-select: none;
    }

    .checkbox-container-item:hover {
      background-color: #f8fafc;
    }

    .checkbox-container-item.selected {
      background-color: #eff6ff;
      /* Azul muito leve */
      /* border-color: #bfdbfe; borda opcional, talvez polua */
    }

    .checkbox-container-item .custom-checkbox {
      width: 1rem;
      height: 1rem;
      border-radius: 3px;
      border: 1px solid #cbd5e1;
      cursor: pointer;
      margin-top: 1px;
    }

    .checkbox-container-item .checkbox-label {
      font-size: 0.875rem;
      color: #475569;
      cursor: pointer;
      flex: 1;
    }

    .checkbox-container-item.selected .checkbox-label {
      color: #1e40af;
      font-weight: 500;
    }

    /* Outros Detectados - Estilo Refinado */
    .encaminhamento-group.outros-detectados {
      border: 1px solid #e5e7eb;
      /* Remove tracejado agressivo */
      background: #fff;
    }

    .encaminhamento-group.outros-detectados .group-header {
      background: #fffbeb;
      /* Amarelo muito suave apenas no header */
    }

    .encaminhamento-group.outros-detectados .group-title {
      color: #b45309;
      /* Tom de amarelo/laranja escuro legível */
    }

    /* Footer do Filtro (Resumo) */
    .filter-encaminhamento-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0.5rem 0 0.5rem;
      margin-top: 0.5rem;
      border-top: 1px solid #e2e8f0;
      font-size: 0.8rem;
      color: #64748b;
    }

    .btn-clear-encaminhamento {
      background: transparent;
      border: none;
      color: #ef4444;
      font-weight: 500;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      transition: background 0.2s;
    }

    .btn-clear-encaminhamento:hover {
      background: #fef2f2;
    }

    .btn-clear-encaminhamento.hidden {
      display: none;
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Alerta inline para novas notificações */
    .alerta-novas-notificacoes {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid #fecaca;
      background: linear-gradient(90deg, #fff1f2, #ffe4e6);
      color: #b91c1c;
      box-shadow: 0 8px 20px rgba(248, 113, 113, 0.15);
      opacity: 0;
      transform: translateY(-20px);
    }

    .alerta-novas-notificacoes.show {
      display: flex;
      animation: alertaEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .alerta-novas-notificacoes.hide {
      animation: alertaExit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes alertaEntrance {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes alertaExit {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Animação de shake para o contador quando é incrementado */
    @keyframes shakeCounter {

      0%,
      100% {
        transform: translateX(0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-4px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(4px);
      }
    }

    .alerta-novas-notificacoes .contador-shake {
      animation: shakeCounter 0.5s ease-in-out;
      display: inline-block;
    }

    /* Esconder botão CTA */
    .alerta-novas-notificacoes .cta {
      display: none;
    }

    .alerta-novas-notificacoes .cta:hover {
      display: none;
    }

    /* Animação de pulsar unificada (reutilizável) */
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
      }

      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* Classe genérica para pulsar (sem ID específico) */
    .btn-pulse-active {
      animation: pulse 2s infinite !important;
      transition: none !important;
    }

    .alerta-novas-notificacoes .close-btn {
      background: transparent;
      color: #b91c1c;
      padding: 6px;
      border-radius: 8px;
      transition: background 0.15s ease;
    }

    .alerta-novas-notificacoes .close-btn:hover {
      background: rgba(185, 28, 28, 0.08);
    }

    /* Bloqueio quando toast está ativo */
    .alerta-novas-notificacoes.toast-blocking {
      pointer-events: none;
      opacity: 0.5;
    }

    /* Apenas Celulares e Tablets: Esconde menu horizontal, mostra hamburguer */

    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }

      .desktop-menu {
        display: none !important;
      }

      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {

      button,
      a {
        min-height: 44px;
      }
    }

    /* ========================================
       DRAWER DE DETALHES
       ======================================== */
    /* ========================================
       MODAL DE DETALHES - SIMPLES
       ======================================== */
    .modal-detalhes {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0);
      backdrop-filter: blur(0px);
      transition: all 0.3s ease;
      overflow-y: auto;
    }

    .modal-detalhes.visible {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px !important;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }

    .modal-detalhes-conteudo {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      padding: 0;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 1152px;
      max-height: 95vh;
      margin: auto;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: modalFadeIn 0.3s ease;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-detalhes-header {
      flex-shrink: 0;
    }

    .modal-detalhes-titulo {
      margin: 0;
    }

    .modal-detalhes-subtitulo {
      margin: 0;
    }

    .modal-detalhes-close {
      cursor: pointer;
    }

    .modal-detalhes-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      background: transparent;
    }

    .modal-detalhes-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-detalhes-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .modal-detalhes-body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
      border-radius: 10px;
    }

    .modal-detalhes-body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);
    }

    .modal-detalhes-section,
    .modal-detalhes-section-title,
    .modal-detalhes-row,
    .modal-detalhes-label,
    .modal-detalhes-value,
    .modal-detalhes-value.empty {
      all: unset;
    }

    /* Botão na tabela */
    .btn-ver-detalhes {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      flex-shrink: 0;
    }

    .btn-ver-detalhes:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-ver-detalhes svg {
      width: 18px;
      height: 18px;
    }

    body.modal-open {
      overflow: hidden !important;
      touch-action: none;
    }

    .select-shell {
      position: relative;
      width: 100%;
    }

    .select-native {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      pointer-events: none;
    }

    .select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 0.85rem;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      padding: 0.65rem 0.85rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #111827;
      transition: box-shadow 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
        border-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
        transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
        background-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 1px 0 rgba(17, 24, 39, 0.02);
    }

    .select-trigger:hover {
      border-color: #93c5fd;
      background: linear-gradient(180deg, #ffffff 0%, #f3f8ff 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
    }

    .select-trigger:focus {
      outline: none;
    }

    .select-trigger:focus-visible {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18), 0 12px 26px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .select-trigger-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.85rem;
      height: 1.85rem;
      border-radius: 0.7rem;
      color: #64748b;
      background: rgba(148, 163, 184, 0.12);
      transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
        background-color 220ms cubic-bezier(0.2, 0.8, 0.2, 1),
        color 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      flex-shrink: 0;
      margin-left: 0.75rem;
    }

    .select-shell[data-open="true"] .select-trigger-icon {
      transform: rotate(180deg);
      background: rgba(59, 130, 246, 0.14);
      color: #2563eb;
    }

    .select-menu {
      position: absolute;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 280px;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08), 0 1px 3px rgba(15, 23, 42, 0.04);
      padding: 0.35rem;
      max-height: 260px;
      overflow: auto;
      transform-origin: top;
      opacity: 0;
      transform: translateY(-6px) scale(0.985);
      pointer-events: none;
      visibility: hidden;
      transition: opacity 140ms ease, transform 180ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .select-menu.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
      visibility: visible;
    }

    .select-menu.closing {
      visibility: visible;
      pointer-events: none;
    }

    /* Complementares: padronização visual (apenas dentro dos grupos colapsáveis) */
    .filter-group-content label {
      font-size: 0.875rem;
      line-height: 1.2;
      margin-bottom: 6px !important;
    }

    .filter-group-content label span.flex-1 {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      overflow: hidden;
    }

    .filter-group-content .grid {
      align-items: stretch;
    }

    .filter-group-content .grid>div:not(.hidden) {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 112px;
    }

    .filter-group-content .select-trigger {
      padding: 0.52rem 0.75rem;
      border-radius: 0.75rem;
    }

    .filter-group-content .select-trigger-icon {
      width: 1.65rem;
      height: 1.65rem;
      border-radius: 0.65rem;
      margin-left: 0.6rem;
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      height: 18px;
      padding: 0 8px;
      border-radius: 9999px;
      font-size: 10px;
      font-weight: 700;
      line-height: 1;
      letter-spacing: 0.02em;
      color: #334155;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      user-select: none;
      white-space: nowrap;
    }

    /* Animação do filtro condicional (parece "sair" do pai) */
    #filterOcorreuEscolaContainer {
      overflow: visible;
      transform-origin: top;
      will-change: height, opacity, transform;
    }

    #filterOcorreuEscolaContainer.is-animating {
      overflow: hidden;
      pointer-events: none;
    }

    .select-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.55rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.84rem;
      line-height: 1.25rem;
      color: #334155;
      cursor: pointer;
      user-select: none;
      transition: background-color 160ms ease, color 160ms ease;
    }

    .select-option:hover {
      background-color: #f1f5f9;
      color: #1e293b;
    }

    .select-option[aria-selected="true"] {
      background-color: #f0f4ff;
      color: #3b5998;
      font-weight: 600;
    }

    /* ── Tooltip Portal: apenas visual (show/hide controlado por JS inline) ── */
    #tooltip-portal {
      pointer-events: none;
      white-space: normal;
    }

    #tooltip-portal>span.relative {
      width: 100%;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.05),
        0 2px 4px -1px rgba(0, 0, 0, 0.03),
        0 10px 15px -3px rgba(0, 0, 0, 0.04);
      border-radius: 8px;
      padding: 12px 16px;
      display: block;
      color: #334155;
      text-align: left;
      white-space: normal;
      line-height: 1.5;
    }

    #tooltip-portal .font-extrabold {
      font-weight: 600 !important;
      color: #0f172a !important;
      font-size: 0.8rem !important;
      margin-bottom: 6px !important;
      letter-spacing: -0.01em !important;
      line-height: 1.4 !important;
    }

    #tooltip-portal .leading-relaxed {
      font-size: 0.75rem !important;
      color: #475569 !important;
      line-height: 1.5 !important;
    }

    #tooltip-portal>span.absolute {
      display: none !important;
    }

    .tooltip-trigger {
      display: inline-flex;
      align-items: center;
      cursor: help;
    }

    .tooltip-trigger .tooltip-popover {
      display: none !important;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 9999px;
      font-size: 9px;
      line-height: 1;
      color: #94a3b8;
      background: transparent;
      border: 1.5px solid #cbd5e1;
      opacity: 0.75;
      user-select: none;
      transition: color 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
    }

    .tooltip-trigger:hover .tooltip-icon,
    .tooltip-trigger:focus .tooltip-icon {
      color: #64748b;
      border-color: #94a3b8;
      opacity: 1;
    }

    .filter-group,
    .filter-group-content {
      overflow: visible;
    }

    #filtersSection {
      position: relative;
      overflow: visible;
    }

    /* Garante que o painel avançado não corte dropdowns */
    #advancedPanel,
    #advancedPanel>div,
    #advancedPanelContent,
    #advancedPanelContent .filter-group-content,
    #advancedPanelContent .filter-group-content>div,
    #advancedPanelContent .px-4 {
      overflow: visible !important;
    }

    /* Garante que cards e containers de filtros não cortem dropdowns */
    .child-filter-card-body,
    .child-filters-grid,
    .conditional-indent {
      overflow: visible !important;
    }

    #selectOverlay {
      position: absolute;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .modal-detalhes-conteudo {
        width: 100%;
        max-height: 95vh;
        margin: auto;
      }

      .modal-detalhes-header {
        padding: 0;
      }

      .modal-detalhes-titulo {
        font-size: inherit;
      }

      .modal-detalhes-body {
        padding: 0;
      }
    }

    /* ============================================
       CHECKBOX COMPACTO E RESPONSIVO
       ============================================ */

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      /* Compacto: 8px vertical */
      background: white;
      border: 1.5px solid #e5e7eb;
      border-radius: 0.5rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      min-height: auto;
    }

    .checkbox-container:hover {
      background-color: #f8fafc;
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Estado selecionado: ÓBVIO em 1 segundo */
    .checkbox-container:has(.custom-checkbox:checked) {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-color: #3b82f6;
      border-width: 2px;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .checkbox-container:has(.custom-checkbox:checked) .checkbox-label {
      color: #1e40af;
      font-weight: 600;
    }

    /* Estado desabilitado */
    .checkbox-container:has(.custom-checkbox:disabled) {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }

    .checkbox-label {
      flex: 1;
      font-size: 0.875rem;
      line-height: 1.25rem;
      /* 1 linha */
      color: #374151;
      cursor: pointer;
      user-select: none;
    }

    /* ============================================
       GRIDS RESPONSIVOS POR TIPO
       ============================================ */

    .child-filter-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }

    /* Permite que dropdowns/overlays (autocomplete) renderizem acima do card quando necessário */
    .child-filter-card.has-flyout {
      overflow: visible !important;
    }

    .child-filter-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
    }

    .child-filter-card-icon {
      width: 34px;
      height: 34px;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #ede9fe;
      color: #6d28d9;
      font-size: 16px;
      flex: none;
    }

    .child-filter-card-title {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      letter-spacing: 0.02em;
    }

    .child-filter-card-body {
      padding: 14px 16px 16px;
    }

    .child-filters-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .child-filters-subgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 768px) {
      .child-filters-subgrid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .child-age-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .child-age-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Inputs de idade no mesmo padrão visual do select-elegant */
    .child-age-input {
      width: 100%;
      height: 44px;
      padding: 0.625rem 0.875rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      background: #ffffff;
      color: #111827;
      font-size: 0.95rem;
      line-height: 1.25rem;
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
      outline: none;
    }

    .child-age-input::placeholder {
      color: #9ca3af;
    }

    .child-age-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18);
    }

    /* Gênero: SEMPRE 2 colunas */
    #filterGeneroContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem 0.75rem;
      /* gap-y < gap-x */
    }

    /* Raça: 2 → 3 → 4 colunas */
    #filterRacaContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem 0.75rem;
    }

    @media (min-width: 768px) {
      #filterRacaContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1024px) {
      #filterRacaContainer {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Orientação: 2 → 3 → 4 → 5 colunas */
    #filterOrientacaoContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem 0.75rem;
    }

    @media (min-width: 768px) {
      #filterOrientacaoContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1024px) {
      #filterOrientacaoContainer {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (min-width: 1280px) {
      #filterOrientacaoContainer {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    /* ============================================
       CARDS DE TIPO DE VIOLÊNCIA - REDESIGN
       Sistema escalável para 1-9+ tipos
       ============================================ */

    /* Container principal — zona de filtro diferenciada */
    #filterTipoViolenciaContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 16px;
      padding: 20px;
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 14px;
    }

    /* Ajustes responsivos */
    @media (min-width: 640px) {
      #filterTipoViolenciaContainer {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
    }

    @media (min-width: 1280px) {
      #filterTipoViolenciaContainer {
        grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      }
    }

    /* ── Card individual ── */
    .violence-type-card {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      min-height: 52px;
      background: #ffffff;
      border: 1.5px solid var(--vt-border, #E5E7EB);
      border-radius: 10px;
      cursor: pointer;
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease;
      overflow: hidden;
      user-select: none;
    }

    /* Remover barra de acento do topo (antigo design) */
    .violence-type-card::before {
      display: none;
    }

    /* ── Estado Hover ── */
    .violence-type-card:hover {
      transform: translateY(-1px);
      border-color: var(--vt-hover-border, #CBD5E1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    /* ── Estado Selecionado ── */
    .violence-type-card.selected {
      background: var(--vt-selected-bg, #EFF6FF);
      border-color: var(--vt-selected-border, #3B82F6);
      border-width: 2px;
      box-shadow: 0 0 0 3px var(--vt-selected-ring, rgba(59, 130, 246, 0.15));
    }

    .violence-type-card.selected .violence-type-icon {
      color: var(--vt-selected-icon, #3B82F6);
    }

    .violence-type-card.selected .violence-type-icon svg {
      stroke: var(--vt-selected-icon, #3B82F6);
    }

    .violence-type-card.selected .violence-type-label {
      color: var(--vt-selected-text, #1E3A5F);
      font-weight: 700;
    }

    .violence-type-card.selected .violence-type-check {
      opacity: 1;
      transform: scale(1);
    }

    /* ── Ícone SVG ── */
    .violence-type-icon {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--vt-icon-color, #6B7280);
      transition: color 180ms ease;
    }

    .violence-type-icon svg {
      width: 20px;
      height: 20px;
      stroke: var(--vt-icon-color, #6B7280);
      stroke-width: 1.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 180ms ease;
    }

    /* ── Label ── */
    .violence-type-label {
      flex: 1;
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      line-height: 1.3;
      transition: color 180ms ease, font-weight 180ms ease;
    }

    /* ── Check mark discreto ── */
    .violence-type-check {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--vt-selected-border, #3B82F6);
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 200ms cubic-bezier(0.68, -0.55, 0.265, 1.55),
        transform 200ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .violence-type-check svg {
      width: 11px;
      height: 11px;
      stroke: white;
      stroke-width: 2.5;
      fill: none;
    }

    /* ── Contador oculto (mantido para compatibilidade) ── */
    .violence-type-count {
      display: none;
    }

    /* ── Input checkbox oculto ── */
    .violence-type-card input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 2;
    }

    /* ── Paleta por Categoria (CSS custom properties) ── */
    .violence-type-card[data-type="fisica"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #FCA5A5;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #FEF2F2;
      --vt-selected-border: #EF4444;
      --vt-selected-ring: rgba(239, 68, 68, 0.12);
      --vt-selected-icon: #DC2626;
      --vt-selected-text: #991B1B;
    }

    .violence-type-card[data-type="psicologica"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #C4B5FD;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #F5F3FF;
      --vt-selected-border: #8B5CF6;
      --vt-selected-ring: rgba(139, 92, 246, 0.12);
      --vt-selected-icon: #7C3AED;
      --vt-selected-text: #5B21B6;
    }

    .violence-type-card[data-type="sexual"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #F9A8D4;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #FDF2F8;
      --vt-selected-border: #EC4899;
      --vt-selected-ring: rgba(236, 72, 153, 0.12);
      --vt-selected-icon: #DB2777;
      --vt-selected-text: #9D174D;
    }

    .violence-type-card[data-type="negligencia"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #FCD34D;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #FFFBEB;
      --vt-selected-border: #F59E0B;
      --vt-selected-ring: rgba(245, 158, 11, 0.12);
      --vt-selected-icon: #D97706;
      --vt-selected-text: #92400E;
    }

    .violence-type-card[data-type="institucional"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #93C5FD;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #EFF6FF;
      --vt-selected-border: #3B82F6;
      --vt-selected-ring: rgba(59, 130, 246, 0.12);
      --vt-selected-icon: #2563EB;
      --vt-selected-text: #1E3A5F;
    }

    .violence-type-card[data-type="bullying"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #FDBA74;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #FFF7ED;
      --vt-selected-border: #F97316;
      --vt-selected-ring: rgba(249, 115, 22, 0.12);
      --vt-selected-icon: #EA580C;
      --vt-selected-text: #9A3412;
    }

    .violence-type-card[data-type="cyberbullying"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #A5F3FC;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #ECFEFF;
      --vt-selected-border: #0891B2;
      --vt-selected-ring: rgba(8, 145, 178, 0.12);
      --vt-selected-icon: #0E7490;
      --vt-selected-text: #155E75;
    }

    .violence-type-card[data-type="autolesao"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #67E8F9;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #ECFEFF;
      --vt-selected-border: #06B6D4;
      --vt-selected-ring: rgba(6, 182, 212, 0.12);
      --vt-selected-icon: #0891B2;
      --vt-selected-text: #164E63;
    }

    /* ============================================
       CRIANÇA / PERFIL - NOVOS COMPONENTES SAAS
       ============================================ */

    /* ── Toggle Chips (Gênero) ── */
    .toggle-chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .toggle-chip {
      flex: 1;
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 0.75rem;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
      border-radius: 9999px;
      /* Pill shape */
      color: #4B5563;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .toggle-chip:hover {
      background: #E5E7EB;
      color: #1F2937;
    }

    .toggle-chip input[type="checkbox"] {
      display: none;
    }

    .toggle-chip.selected {
      background: #EEF2FF;
      /* Indigo-50 */
      border-color: #6366F1;
      /* Indigo-500 */
      color: #4338ca;
      /* Indigo-700 */
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    /* ── Modern Radio (Orientação) ── */
    .modern-radio-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .modern-radio-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem 0.875rem;
      background: #fff;
      border: 1px solid #E5E7EB;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modern-radio-label:hover {
      border-color: #fda4af;
      /* Rose-300 */
      background: #fff1f2;
      /* Rose-50 */
    }

    .modern-radio-label.selected {
      background: #fff1f2;
      /* Rose-50 */
      border-color: #e11d48;
      /* Rose-600 */
      box-shadow: 0 0 0 1px #e11d48;
    }

    /* Custom Radio Visual */
    .modern-radio-input {
      appearance: none;
      -webkit-appearance: none;
      width: 1.125rem;
      height: 1.125rem;
      border: 2px solid #9CA3AF;
      border-radius: 50%;
      margin: 0;
      display: grid;
      place-content: center;
      transition: all 0.2s ease;
    }

    .modern-radio-input::before {
      content: "";
      width: 0.625rem;
      height: 0.625rem;
      border-radius: 50%;
      transform: scale(0);
      transition: 0.15s transform ease-in-out;
      background-color: white;
    }

    .modern-radio-label.selected .modern-radio-input {
      border-color: #e11d48;
      /* Rose-600 */
      background-color: #e11d48;
    }

    .modern-radio-label.selected .modern-radio-input::before {
      transform: scale(1);
    }

    .modern-radio-text {
      font-size: 0.9rem;
      color: #374151;
      font-weight: 500;
    }


    /* ── Grid Improvements ── */
    .child-filters-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 1024px) {
      .child-filters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Card adjustments */
    .child-filter-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .child-filter-card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .violence-type-card[data-type="outros"],
    .violence-type-card[data-type="financeira"] {
      --vt-border: #E5E7EB;
      --vt-hover-border: #94A3B8;
      --vt-icon-color: #9CA3AF;
      --vt-selected-bg: #F8FAFC;
      --vt-selected-border: #64748B;
      --vt-selected-ring: rgba(100, 116, 139, 0.12);
      --vt-selected-icon: #475569;
      --vt-selected-text: #1E293B;
    }

    /* ============================================
       SEÇÃO CONDICIONAL DE VIOLÊNCIA INSTITUCIONAL
       (Subgrupo integrado ao card)
       ============================================ */

    .violence-conditional-section {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.04) 0%, rgba(14, 165, 233, 0.08) 100%);
      border: 2px dashed #0ea5e9;
      border-radius: 12px;
      position: relative;
      animation: conditionalSlideIn 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes conditionalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }

      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px;
      }
    }

    .violence-conditional-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(14, 165, 233, 0.2);
    }

    .violence-conditional-icon {
      font-size: 1.25rem;
    }

    .violence-conditional-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: #0369a1;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .violence-conditional-badge {
      margin-left: auto;
      padding: 0.25rem 0.5rem;
      background: rgba(14, 165, 233, 0.15);
      color: #0284c7;
      font-size: 0.65rem;
      font-weight: 600;
      border-radius: 999px;
    }

    .violence-conditional-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.5rem;
    }

    @media (min-width: 768px) {
      .violence-conditional-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }

    /* Mini cards para opções condicionais */
    .violence-sub-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 0.75rem;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .violence-sub-card:hover {
      border-color: #0ea5e9;
      background: #f0f9ff;
    }

    .violence-sub-card.selected {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-color: #0ea5e9;
      border-width: 2px;
    }

    .violence-sub-card.selected .violence-sub-label {
      color: #0369a1;
      font-weight: 600;
    }

    .violence-sub-card.selected .violence-sub-check {
      opacity: 1;
      transform: scale(1);
    }

    .violence-sub-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .violence-sub-label {
      font-size: 0.75rem;
      color: #475569;
      font-weight: 500;
      line-height: 1.2;
      flex: 1;
    }

    .violence-sub-check {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 9px;
      font-weight: bold;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      flex-shrink: 0;
    }

    .violence-sub-card input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 2;
    }

    /* Ações em lote no topo */
    .violence-actions-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.625rem;
      border-bottom: 1px solid #E2E8F0;
    }

    .violence-actions-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
    }

    .violence-actions-buttons {
      display: flex;
      gap: 6px;
    }

    .violence-action-btn {
      padding: 5px 10px;
      font-size: 0.68rem;
      font-weight: 600;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 180ms ease;
      letter-spacing: 0.01em;
    }

    .violence-action-btn.select-all {
      background: #EFF6FF;
      color: #2563EB;
      border-color: #BFDBFE;
    }

    .violence-action-btn.select-all:hover {
      background: #DBEAFE;
      border-color: #93C5FD;
    }

    .violence-action-btn.clear-all {
      background: #FEF2F2;
      color: #DC2626;
      border-color: #FECACA;
    }

    .violence-action-btn.clear-all:hover {
      background: #FEE2E2;
      border-color: #FCA5A5;
    }

    /* Tipo Deficiência: 2 → 3 colunas */
    #filterTipoDeficienciaContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem 0.75rem;
    }

    @media (min-width: 768px) {
      #filterTipoDeficienciaContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Região, Tipo Instituição: 2 → 3 → 4 colunas */
    #filterRegiaoContainer,
    #filterTipoInstituicaoContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem 0.75rem;
    }

    @media (min-width: 768px) {

      #filterRegiaoContainer,
      #filterTipoInstituicaoContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1024px) {

      #filterRegiaoContainer,
      #filterTipoInstituicaoContainer {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* ============================================
       INDENTAÇÃO DE CONDICIONAIS
       ============================================ */

    .conditional-indent {
      position: relative;
      padding-left: 1.5rem;
      border-left: 3px solid #60a5fa;
      margin-left: 0.5rem;
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
      background: linear-gradient(90deg, rgba(96, 165, 250, 0.05) 0%, transparent 100%);
      border-radius: 0.5rem;
      animation: conditionalAppear 0.3s ease-out;
    }

    @keyframes conditionalAppear {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      height: 18px;
      padding: 0 8px;
      border-radius: 9999px;
      font-size: 10px;
      font-weight: 700;
      color: #1e40af;
      background: #dbeafe;
      border: 1px solid #93c5fd;
      white-space: nowrap;
    }

    /* ============================================
       NEUTRALIZAÇÃO
       ============================================ */

    /* Remove min-height excessiva */
    .filter-group-content .grid>div:not(.hidden) {
      min-height: auto !important;
    }
  </style>

  <!-- Intro.js - Sistema de Onboarding -->
  <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
  <link rel="stylesheet" href="assets/css/onboarding.css">
</head>

<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">

  <!-- Header Wrapper (Sticky Reference) -->
  <header class="sticky top-0 z-50 w-full pointer-events-none">
    <div class="max-w-[1680px] mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-4 pointer-events-auto">

      <!-- Menu de Navegação (Floating Card) -->
      <div data-tour="header" id="menuCard"
        class="bg-white rounded-2xl shadow-sm border border-slate-200 transition-all duration-300">
        <div class="px-4 py-3 flex items-center justify-between">

          <!-- Logo / Marca -->
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-md shadow-blue-500/20">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="hidden md:block">
              <h1 class="text-sm font-bold text-slate-800 leading-tight">Painel de Monitoramento</h1>
              <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Violência Escolar</p>
            </div>
          </div>

          <!-- Menu Desktop (Centralizado/Direita) -->
          <nav data-tour="menu" class="hidden md:flex items-center gap-1">
            <!-- Renderizado via JS -->
            <div class="desktop-menu flex items-center gap-1"></div>
          </nav>

          <!-- Ações do Usuário (Direita) -->
          <div class="flex items-center gap-3">
            <!-- Botão Hamburguer (Mobile) -->
            <button onclick="toggleMobileMenu()"
              class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Menu Mobile Expandível -->
        <nav id="mobileMenuNav" class="mobile-menu md:hidden border-t border-slate-100 bg-white">
          <div class="p-4 flex flex-col gap-2">
            <!-- Renderizado via JS -->
          </div>
        </nav>
      </div>

    </div>
  </header>

  <!-- Container Principal (Conteúdo) -->
  <div class="max-w-[1680px] mx-auto px-4 pb-6 sm:px-6 lg:px-8">

    <!-- Alerta de novas notificações -->
    <div id="alerta-novas-notificacoes"
      class="alerta-novas-notificacoes mb-6 mx-auto max-w-2xl bg-white border-l-4 border-rose-500 shadow-lg rounded-r-lg">
      <div class="flex items-center gap-4 py-3 px-4">
        <div class="p-2 bg-rose-50 rounded-full text-rose-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
            </path>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-bold text-gray-900">Novos dados disponíveis</h4>
          <p class="text-xs text-slate-500 mt-0.5">A planilha foi atualizada recentemente.</p>
        </div>
        <button onclick="carregarDadosPlanilha()"
          class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-xs font-bold rounded-lg shadow-sm transition-all focus:ring-2 focus:ring-rose-500 focus:ring-offset-2">
          Atualizar Agora
        </button>
      </div>
    </div>

    <!-- DASHBOARD EXECUTIVO (Refatorado - SaaS Enterprise) -->
    <section id="filtersSection" data-tour="filtros"
      class="bg-white rounded-xl shadow-sm border border-slate-100 border-l-[3px] border-l-blue-400 p-5 mb-8 border border-slate-200">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-5">
        <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
            </path>
          </svg>
          Filtros & Busca
        </h2>

        <div class="flex items-center gap-3">
          <!-- Botão Limpar Filtros (Agora visível e posicionado estrategicamente) -->
          <button id="btnLimparFiltros"
            class="hidden opacity-0 scale-95 flex items-center gap-2 px-3 py-2 text-slate-500 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all text-sm font-medium"
            title="Limpar todos os filtros">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Limpar</span>
          </button>

          <div class="h-6 w-px bg-slate-200 mx-1 hidden md:block"></div>

          <!-- Badges Area (Agora no meio ou inicio) -->
          <div id="activeFiltersBadges" class="flex flex-wrap gap-2 empty:hidden"></div>

          <!-- Export Dropdown -->
          <div class="relative group" id="exportDropdown">
            <button
              class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-blue-600 hover:border-blue-300 shadow-sm transition-all text-sm font-medium">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              <span>Exportar</span>
              <svg class="w-3 h-3 text-slate-400 group-hover:rotate-180 transition-transform duration-300" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <!-- Dropdown Menu com "Bridge" para evitar fechamento acidental -->
            <div
              class="absolute right-0 mt-1 w-48 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-50 before:absolute before:-top-4 before:left-0 before:w-full before:h-4 before:bg-transparent before:content-['']">
              <div class="py-1">
                <a href="javascript:void(0)" onclick="exportarCSV()"
                  class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-blue-600">
                  <span class="text-xs font-bold text-green-600 w-6">CSV</span> Dados Brutos
                </a>
                <a href="javascript:void(0)" onclick="exportarExcel()"
                  class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-blue-600">
                  <span class="text-xs font-bold text-green-600 w-6">XLS</span> Excel
                </a>
                <div class="border-t border-slate-100 my-1"></div>
                <a href="javascript:void(0)" onclick="exportarPDF()"
                  class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-blue-600">
                  <span class="text-xs font-bold text-red-600 w-6">PDF</span> Relatório Visual
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buscar por nome (sempre visível) -->
      <div class="mb-4">
        <div class="relative">
          <input type="text" id="filterNome" placeholder="Buscar por nome da criança ou estudante..."
            class="w-full pl-10 pr-4 py-2.5 bg-slate-50/70 border border-slate-200 rounded-xl text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none focus:bg-white focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-all">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- NOVO PAINEL DE FILTROS (Compacto) -->
      <div id="quickAdvancedFiltersBox" class="">
        <div class="bg-white rounded-lg">
          <div class="filters-grid">

            <details id="filterGroupPeriodo" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Período</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Filtro: Data Início -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">Data Início:</label>
                      <input type="date" id="filterDataInicio"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    </div>

                    <!-- Filtro: Data Fim -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">Data Fim:</label>
                      <input type="date" id="filterDataFim"
                        class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupContextoEscolar" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 22V8l10-6 10 6v14"></path>
                    <path d="M6 12v4"></path>
                    <path d="M18 12v4"></path>
                    <path d="M10 18h4v4h-4z"></path>
                    <path d="M10 6v1"></path>
                    <path d="M14 6v1"></path>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Contexto Escolar</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <!-- Região -->
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide"><svg
                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display:inline;vertical-align:-2px;margin-right:4px">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                      </svg>Região</h4>
                    <div id="filterRegiaoContainer"></div>
                  </div>

                  <!-- Tipo de Instituição -->
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide"><svg
                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display:inline;vertical-align:-2px;margin-right:4px">
                        <path d="M2 22V8l10-6 10 6v14"></path>
                        <path d="M6 12v4"></path>
                        <path d="M18 12v4"></path>
                        <path d="M10 18h4v4h-4z"></path>
                        <path d="M10 6v1"></path>
                        <path d="M14 6v1"></path>
                      </svg>Tipo de Instituição
                    </h4>
                    <div id="filterTipoInstituicaoContainer"></div>
                  </div>

                  <!-- Escola Específica -->
                  <div id="section-escola" class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide"><svg
                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display:inline;vertical-align:-2px;margin-right:4px">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                      </svg>Escola Específica
                    </h4>
                    <div class="escola-multiselect">
                      <!-- Chips de escolas selecionadas -->
                      <div id="filterEscolaSelectedTags" class="escola-chips-area"></div>
                      <!-- Barra de busca fixa -->
                      <div class="escola-search-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="8"></circle>
                          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="filterEscolaSearch" class="escola-search-input"
                          placeholder="Buscar escola..." autocomplete="off">
                      </div>
                      <!-- Lista scrollável de escolas -->
                      <div class="escola-list-panel" id="filterEscolaAutocompleteList"></div>
                    </div>
                    <!-- Container oculto de checkboxes (fonte de dados) -->
                    <div id="filterEscolaContainer" style="display:none"></div>
                  </div>

                  <!-- Tempo Integral -->
                  <div id="section-ti" class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide"><svg
                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display:inline;vertical-align:-2px;margin-right:4px">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>Tempo Integral</h4>
                    <div class="flex gap-3 items-center">
                      <label class="text-sm font-medium text-gray-700">Filtrar por:</label>
                      <select id="filterTI"
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <option value="">Todos</option>
                        <option value="TI">Tempo Integral (TI)</option>
                        <option value="Regular">Tempo Regular (não TI)</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 2xl:grid-cols-3 gap-4">
                    <!-- Filtro: Fonte informada -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">O relato foi feito pela escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Fonte do
                                  relato</div>
                                <div class="leading-relaxed text-gray-800">Mostra quem iniciou o relato/notificação do
                                  caso. “Sim” significa que a própria escola identificou e registrou o caso (direção,
                                  coordenação, professores ou equipe). “Não” indica que o caso chegou à escola por outra
                                  fonte (ex.: família, estudante, serviços, instituições externas). Isso ajuda a
                                  interpretar como a escola tomou conhecimento do ocorrido.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterFonteInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência identificada pela escola ocorrida na escola (Coluna Q) -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2 text-sm">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Escola identificou que a violência ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Local
                                  confirmado (na escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se, após apuração/verificação, foi
                                  confirmado que o fato ocorreu dentro do ambiente escolar (ex.: sala, pátio, banheiro,
                                  quadra). Este campo descreve o local do ocorrido — não a autoria — e ajuda a
                                  diferenciar situações internas da escola de situações externas acompanhadas pela
                                  escola.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaEscolaOcorreu" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência identificada não ocorrida na escola -->
                    <div>
                      <label class="block text-gray-700 font-medium text-sm" style="margin-bottom: 6px;">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Escola identificou que a violência NÃO ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Local
                                  confirmado (fora da escola)</div>
                                <div class="leading-relaxed text-gray-800">Indica se, após verificação, foi confirmado
                                  que o fato ocorreu fora do ambiente escolar (ex.: residência, via pública, transporte,
                                  outros locais externos). Mesmo quando a escola acompanha ou identifica o caso, este
                                  campo ajuda a registrar que o local do ocorrido não foi na escola.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaNaoEscola" class="select-elegant w-full" style="margin-top: 2px;">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudo de Caso -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Foi realizado estudo de caso pela equipe?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Estudo de
                                  caso</div>
                                <div class="leading-relaxed text-gray-800">Indica se a equipe realizou estudo de caso
                                  (análise estruturada do registro), geralmente com reuniões, avaliação multidisciplinar
                                  (pedagógica/psicossocial/direção), definição de plano de intervenção e documentação
                                  interna. Ajuda a entender o nível de consolidação do acompanhamento do caso.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudoCaso" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Violência informada à escola -->
                    <div>
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1">Violência comunicada à escola por algum agente externo?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Comunicação
                                  por terceiros</div>
                                <div class="leading-relaxed text-gray-800">Indica se a escola tomou conhecimento do caso
                                  por comunicação de terceiros (agentes externos), e não por identificação direta da
                                  equipe escolar. Exemplos: família, o próprio estudante, vizinhos, Conselho Tutelar,
                                  Polícia, UBS, CRAS, entre outros. Esse campo é útil para interpretar a origem da
                                  informação e o fluxo de notificação.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterViolenciaInformada" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro (condicional): Ocorreu na escola (apenas quando agente externo = Sim) -->
                    <div id="filterOcorreuEscolaContainer" class="hidden conditional-indent">
                      <label class="block text-gray-700 font-medium mb-2">
                        <span class="flex items-start gap-1">
                          <span class="flex-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round"
                              style="display:inline;vertical-align:-2px;margin-right:4px">
                              <line x1="5" y1="12" x2="19" y2="12"></line>
                              <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>A violência ocorreu na escola?</span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Condição">
                            <span class="filter-badge">Condicional: Agente Externo = Sim</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Condição de
                                  exibição</div>
                                <div class="leading-relaxed text-gray-800">Exibido quando: “A violência foi comunicada à
                                  escola por algum agente externo?” = Sim.</div>
                              </span>
                            </span>
                          </span>
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">Confirmação
                                  do local</div>
                                <div class="leading-relaxed text-gray-800">Este campo aparece quando o caso foi
                                  comunicado por agente externo. Ele registra a conclusão (após apuração) sobre onde o
                                  fato ocorreu: dentro ou fora da escola. Serve para evitar interpretações ambíguas
                                  quando a informação chegou por terceiros, mas o local do ocorrido ainda precisa ser
                                  confirmado.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterOcorreuEscola" class="select-elegant w-full">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                        <option value="NI">Não Informado</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupAutoriaAgente" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Autoria / Agente</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-5 pb-5 pt-3">
                  <div class="mb-3">
                    <p class="text-[13px] font-semibold text-slate-600 tracking-wide">Autoria da Ocorrência</p>
                    <p class="text-[11px] text-slate-400 mt-0.5">Identifique o possível autor do fato.</p>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                    <!-- Filtro: Foi um membro familiar? -->
                    <div>
                      <label class="block text-[13px] text-gray-500 font-normal mb-2.5">
                        <span class="inline-flex items-center gap-1">
                          O autor era membro da família?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-slate-200 bg-white/95 shadow-2xl shadow-slate-900/10 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-slate-800 mb-2 tracking-wide">Membro da
                                  família</div>
                                <div class="leading-relaxed text-gray-800">Use esta informação para entender se o caso
                                  tem indício de violência intrafamiliar. Considere como familiar: pais ou responsáveis
                                  legais, avós, irmãos, tios, primos e outros parentes consanguíneos ou por afinidade.
                                  Quando marcado como "Sim", costuma indicar necessidade de atenção para contexto
                                  doméstico e rede de proteção.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterMembroFamiliar" class="select-elegant w-full font-medium"
                        style="padding:0.625rem 0.875rem">
                        <option value="">Todos</option>
                        <option value="Sim">Sim</option>
                        <option value="Não">Não</option>
                        <option value="naoinformado">Não informado</option>
                      </select>
                    </div>

                    <!-- Filtro: Profissional autor -->
                    <div>
                      <label class="block text-[13px] text-gray-500 font-normal mb-2.5">
                        <span class="inline-flex items-center gap-1">
                          Profissional/funcionário foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-slate-200 bg-white/95 shadow-2xl shadow-slate-900/10 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-slate-800 mb-2 tracking-wide">Autoria
                                  (profissional)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria do caso foi atribuída a
                                  profissional/funcionário da escola. Considere professores, coordenação, direção,
                                  auxiliares, terceirizados (limpeza, segurança, portaria, merenda) e demais
                                  colaboradores. Esse campo é importante porque muda a interpretação do caso e os
                                  encaminhamentos administrativos.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterProfissionalAutor" class="select-elegant w-full font-medium"
                        style="padding:0.625rem 0.875rem">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>

                    <!-- Filtro: Estudante autor -->
                    <div>
                      <label class="block text-[13px] text-gray-500 font-normal mb-2.5">
                        <span class="inline-flex items-center gap-1">
                          Estudante foi autor?
                          <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0"
                            role="button" aria-label="Ajuda">
                            <span class="tooltip-icon">ⓘ</span>
                            <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                              <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                              <span
                                class="relative block w-80 max-w-[90vw] rounded-xl border border-slate-200 bg-white/95 shadow-2xl shadow-slate-900/10 p-4 text-xs text-gray-900">
                                <div class="text-[11px] font-extrabold text-slate-800 mb-2 tracking-wide">Autoria
                                  (estudante)</div>
                                <div class="leading-relaxed text-gray-800">Indica se a autoria foi atribuída a estudante
                                  (da mesma escola ou de outra unidade). Em geral, é usado para casos como agressões
                                  entre estudantes, bullying/cyberbullying e outras violências no contexto escolar entre
                                  pares.</div>
                              </span>
                            </span>
                          </span>
                        </span>
                      </label>
                      <select id="filterEstudanteAutor" class="select-elegant w-full font-medium"
                        style="padding:0.625rem 0.875rem">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">Não</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <details id="filterGroupViolencia" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Violência</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <!-- Tipo de Violência - Redesign com Cards -->
                  <div class="mb-4">
                    <!-- Barra de ações -->
                    <div class="violence-actions-bar">
                      <h4 class="violence-actions-title"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          style="display:inline;vertical-align:-2px;margin-right:4px">
                          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>Tipo de Violência</h4>
                      <div class="violence-actions-buttons">
                        <button type="button" class="violence-action-btn select-all" onclick="selectAllViolenceTypes()">
                          ✓ Todos
                        </button>
                        <button type="button" class="violence-action-btn clear-all" onclick="clearAllViolenceTypes()">
                          ✕ Limpar
                        </button>
                      </div>
                    </div>
                    <!-- Container de cards de tipos de violência -->
                    <div id="filterTipoViolenciaContainer"></div>
                  </div>

                  <!-- CONDICIONAL: Violência Institucional (integrado como subgrupo visual) -->
                  <div id="section-violenciaInstitucional" class="hidden">
                    <div class="violence-conditional-section">
                      <div class="violence-conditional-header">
                        <span class="violence-conditional-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                            height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="22" x2="21" y2="22"></line>
                            <line x1="6" y1="18" x2="6" y2="11"></line>
                            <line x1="10" y1="18" x2="10" y2="11"></line>
                            <line x1="14" y1="18" x2="14" y2="11"></line>
                            <line x1="18" y1="18" x2="18" y2="11"></line>
                            <polygon points="12 2 20 7 4 7"></polygon>
                          </svg></span>
                        <span class="violence-conditional-title">Detalhamento: Violências Institucionais</span>
                        <span class="violence-conditional-badge">Filtro ativo</span>
                        <span id="badge-violenciaInstitucional-total"
                          class="badge-count hidden inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-sky-600 rounded-full ml-2">0</span>
                      </div>
                      <div id="filterViolenciaInstitucionalContainer" class="violence-conditional-grid"></div>
                    </div>
                  </div>

                </div>
              </div>
            </details>

            <details id="filterGroupEncaminhamentos" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    <line x1="8" y1="10" x2="16" y2="10"></line>
                    <line x1="8" y1="14" x2="16" y2="14"></line>
                    <line x1="8" y1="18" x2="12" y2="18"></line>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Encaminhamentos</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-4 pb-4 pt-2">

                  <div>
                    <h4
                      class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide flex items-center justify-between">
                      <span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round" style="display:inline;vertical-align:-2px;margin-right:4px">
                          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                          <line x1="8" y1="10" x2="16" y2="10"></line>
                          <line x1="8" y1="14" x2="16" y2="14"></line>
                          <line x1="8" y1="18" x2="12" y2="18"></line>
                        </svg>Encaminhamento</span>
                      <span id="badge-encaminhamento-total"
                        class="badge-count hidden inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">0</span>
                    </h4>
                    <div id="filterEncaminhamentoContainer" class="space-y-3"></div>
                  </div>

                </div>
              </div>
            </details>

            <details id="filterGroupPerfilEstudante" class="filter-group" data-mode="panel">
              <summary>
                <span class="text-sm" style="display:inline-flex;align-items:center"><svg
                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg></span>
                <span class="text-sm font-medium text-slate-700">Criança / Perfil</span>
                <span class="filter-group-chevron">▼</span>
              </summary>
              <div class="filter-group-content">
                <div class="px-3 pb-3 pt-2">
                  <div class="child-filters-grid grid grid-cols-1 lg:grid-cols-3 gap-3">

                    <!-- Card: Faixa Etária (Compact) -->
                    <div
                      class="child-filter-card bg-white border border-gray-200 shadow-sm rounded-xl p-3 flex flex-col h-full">
                      <div class="child-filter-card-header flex items-center gap-2 mb-2">
                        <div
                          class="child-filter-card-icon w-7 h-7 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-base">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                          </svg>
                        </div>
                        <div class="child-filter-card-title text-sm font-semibold text-gray-800">FAIXA ETÁRIA</div>
                      </div>
                      <div class="child-filter-card-body flex-1 flex flex-col justify-center">
                        <div class="flex items-center gap-2 mb-1">
                          <div class="flex-1">
                            <label
                              class="block text-gray-500 text-[10px] font-bold uppercase mb-1 text-center tracking-wider">Mínima</label>
                            <input type="number" id="filterIdadeMin" placeholder="0" min="0" max="100"
                              class="w-full h-8 px-2 border border-slate-200 rounded-lg text-center text-sm font-medium focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all mx-auto block hover:border-blue-300">
                          </div>
                          <span class="text-slate-300 font-bold self-end mb-2">—</span>
                          <div class="flex-1">
                            <label
                              class="block text-gray-500 text-[10px] font-bold uppercase mb-1 text-center tracking-wider">Máxima</label>
                            <input type="number" id="filterIdadeMax" placeholder="18" min="0" max="100"
                              class="w-full h-8 px-2 border border-slate-200 rounded-lg text-center text-sm font-medium focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all mx-auto block hover:border-blue-300">
                          </div>
                        </div>
                        <p class="text-[10px] text-slate-400 text-center font-medium">Idade em anos completos</p>
                      </div>
                    </div>

                    <!-- Card: Gênero -->
                    <div
                      class="child-filter-card bg-white border border-gray-200 shadow-sm rounded-xl p-3 flex flex-col h-full">
                      <div class="child-filter-card-header flex items-center gap-2 mb-2">
                        <div
                          class="child-filter-card-icon w-7 h-7 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-base">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                          </svg>
                        </div>
                        <div class="child-filter-card-title text-sm font-semibold text-gray-800">GÊNERO</div>
                      </div>
                      <div class="child-filter-card-body flex-1 flex items-center justify-center">
                        <div id="filterGeneroContainer"
                          class="toggle-chip-container w-full flex justify-center gap-2 flex-wrap">
                          <!-- Filled by JS -->
                        </div>
                      </div>
                    </div>

                    <!-- Card: Raça/Cor -->
                    <div
                      class="child-filter-card bg-white border border-gray-200 shadow-sm rounded-xl p-3 flex flex-col h-full">
                      <div class="child-filter-card-header flex items-center gap-2 mb-2">
                        <div
                          class="child-filter-card-icon w-7 h-7 rounded-lg bg-amber-50 text-amber-600 flex items-center justify-center text-base">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                          </svg>
                        </div>
                        <div class="child-filter-card-title text-sm font-semibold text-gray-800">RAÇA/COR</div>
                      </div>
                      <div class="child-filter-card-body">
                        <div id="filterRacaContainer" class="grid grid-cols-2 gap-x-3 gap-y-2">
                          <!-- Filled by JS -->
                        </div>
                      </div>
                    </div>

                    <!-- Card: Orientação Sexual -->
                    <div
                      class="child-filter-card bg-white border border-gray-200 shadow-sm rounded-xl p-3 lg:col-span-2">
                      <div class="child-filter-card-header flex items-center gap-2 mb-2">
                        <div
                          class="child-filter-card-icon w-7 h-7 rounded-lg bg-rose-50 text-rose-600 flex items-center justify-center text-base">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                            </path>
                          </svg>
                        </div>
                        <div
                          class="child-filter-card-title text-sm font-semibold text-gray-800 flex items-center gap-2">
                          ORIENTAÇÃO SEXUAL
                          <span
                            class="text-[10px] text-rose-600/80 font-medium border border-rose-100 rounded-full px-2 py-0.5 bg-rose-50 tracking-wide uppercase">Opcional</span>
                        </div>
                      </div>
                      <div class="child-filter-card-body">
                        <div id="filterOrientacaoContainer"
                          class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                          <!-- Filled by JS -->
                        </div>
                      </div>
                    </div>

                    <!-- Card: PCD -->
                    <div
                      class="child-filter-card bg-white border border-gray-200 shadow-sm rounded-xl p-3 flex flex-col h-full">
                      <div class="child-filter-card-header flex items-center gap-2 mb-2">
                        <div
                          class="child-filter-card-icon w-7 h-7 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center text-base">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            <path d="M12 22v-6"></path>
                            <path d="M7.5 22h9"></path>
                          </svg>
                        </div>
                        <div class="child-filter-card-title text-sm font-semibold text-gray-800">PCD / TRANSTORNO?
                        </div>
                      </div>
                      <div class="child-filter-card-body flex-1 flex flex-col justify-center">
                        <label class="block text-gray-500 text-xs font-medium mb-1.5 ml-1">Possui deficiência?</label>
                        <select id="filterPCD"
                          class="w-full h-8 px-3 bg-slate-50 border border-slate-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all cursor-pointer hover:bg-white hover:border-blue-300">
                          <option value="">Todos</option>
                          <option value="S">Sim</option>
                          <option value="N">Não</option>
                        </select>
                      </div>
                    </div>

                  </div>

                  <!-- CONDICIONAL: Tipo Deficiência (Padronizado) -->
                  <div id="section-tipoDeficiencia" class="mb-4 hidden conditional-indent">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide"><svg
                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display:inline;vertical-align:-2px;margin-right:4px">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                        <path d="M12 22v-6"></path>
                        <path d="M7.5 22h9"></path>
                      </svg>Tipo de Deficiência
                    </h4>
                    <div class="escola-multiselect">
                      <!-- Chips de deficiências selecionadas -->
                      <div id="filterTipoDeficienciaSelectedTags" class="escola-chips-area"></div>
                      <!-- Barra de busca fixa -->
                      <div class="escola-search-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="8"></circle>
                          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="filterTipoDeficienciaSearch" class="escola-search-input"
                          placeholder="Buscar deficiência..." autocomplete="off">
                      </div>
                      <!-- Lista scrollável de deficiências -->
                      <div class="escola-list-panel" id="filterTipoDeficienciaAutocompleteList"></div>
                    </div>
                    <!-- Container oculto de checkboxes (fonte de dados) -->
                    <div id="filterTipoDeficienciaContainer" style="display:none"></div>
                  </div>

                </div>
              </div>
            </details>

          </div>

          <!-- Painel (abre apenas 1 filtro por vez, como no backup) -->
          <div id="advancedPanel" class="advanced-panel mt-4">
            <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-4 border border-gray-200 shadow-sm">
              <div id="advancedPanelContent"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação removidos (movidos para o header) -->
    </section>

    <section id="dashboardExecutivo" data-tour="dashboard" class="dashboard-saas-container fade-in"
      data-reveal="fade-up">

      <!-- HEADER PREMIUM -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Visão Geral</h2>
          <p class="text-slate-500 mt-1 text-sm">Monitoramento estratégico e indicadores de performance em tempo real.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <span
            class="text-xs font-semibold text-slate-400 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">
            Última atualização: Hoje
          </span>
          <a href="registro-novo-caso.html"
            class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 active:shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Novo Registro
          </a>
          <button id="btnAtualizarKPIs"
            class="flex items-center gap-2 px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 rounded-lg text-sm font-medium transition-all border border-slate-200 shadow-sm hover:shadow-md active:scale-95">
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            Atualizar
          </button>
        </div>
      </div>

      <!-- LINHA 1: KPIs ESTRATÉGICOS (Primary) -->
      <!-- ROW 1: ESTRATÉGICO (4 Cols) -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

        <!-- CARD 1: CASOS EM ANÁLISE (Foco Ativo - ID: statFiltrados) -->
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-md transition-shadow duration-200 group">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Casos em Análise</h3>
            <div
              class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                </path>
              </svg>
            </div>
          </div>
          <div class="flex items-baseline gap-2">
            <!-- ID moved from Context 1 -->
            <span id="statFiltrados" class="text-4xl font-bold text-slate-900 tracking-tight">0</span>
            <span class="text-sm text-slate-400 font-medium">registros</span>
          </div>
          <div
            class="mt-2 flex items-center gap-1.5 text-sm text-blue-600 font-medium bg-blue-50 inline-flex px-2 py-0.5 rounded-md border border-blue-100">
            <span>Visão Filtrada</span>
            <!-- Hidden Legacy IDs preserved -->
            <span id="kpiCasosFiltrados" class="hidden">0</span>
          </div>
        </div>

        <!-- CARD 2: TENDÊNCIA MENSAL -->
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-md transition-shadow duration-200 group">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Tendência Mensal</h3>
            <div
              class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
              </svg>
            </div>
          </div>
          <div class="flex items-baseline gap-2">
            <span id="statVariacaoMensal" class="text-4xl font-bold text-slate-900 tracking-tight">0%</span>
            <span class="text-sm text-slate-400">vs anterior</span>
          </div>
          <p class="mt-2 text-sm text-slate-500 flex items-center gap-1">
            <span id="statCasosEsteMes" class="font-semibold text-slate-700">0</span>
            <span>novos este mês</span>
            <span id="statCasosMesAnterior" class="hidden"></span>
            <span id="textoContextoTemporal" class="hidden"></span>
            <span id="indicadorSeta" class="hidden"></span>
          </p>
        </div>

        <!-- CARD 3: TIPO FREQUENTE -->
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-md transition-shadow duration-200 group">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Tipo Frequente</h3>
            <div
              class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                </path>
              </svg>
            </div>
          </div>
          <div id="kpiTipoFrequente"
            class="text-2xl font-bold text-slate-900 tracking-tight leading-tight line-clamp-2 min-h-[40px]">
            -
          </div>
          <p id="kpiTipoFrequenteCasos" class="mt-2 text-sm text-purple-600 font-medium">
            -
          </p>
        </div>

        <!-- CARD 4: UNIVERSO TOTAL (ID: statTotal) -->
        <div
          class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-md transition-shadow duration-200 group">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Universo Total</h3>
            <div
              class="w-8 h-8 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center group-hover:scale-110 transition-transform duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                </path>
              </svg>
            </div>
          </div>
          <div class="flex items-baseline gap-2">
            <!-- ID moved from Context 1 -->
            <span id="statTotal" class="text-4xl font-bold text-slate-900 tracking-tight">0</span>
            <span class="text-sm text-slate-400 font-medium">base completa</span>
          </div>
          <div class="mt-2 w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
            <!-- Visual progress bar purely for aesthetic -->
            <div class="bg-orange-400 h-1.5 rounded-full" style="width: 100%"></div>
          </div>
          <!-- Hidden Legacy Link -->
          <span id="kpiTotalCasos" class="hidden">0</span>
          <!-- Redundant legacy ID moved to visually hidden to avoid conflicts if JS serves it -->
          <span id="kpiCasosFiltradosPercentual" class="hidden">0%</span>
        </div>
      </div>

      <!-- OLD GRID HIDDEN (Legacy backup) -->
      <div class="kpi-grid-saas" style="display:none !important;">
        <!-- KPI 1: Universo Total (Antigo Casos em Análise) -->
        <div class="kpi-card-saas accent-blue">
          <div>
            <div class="kpi-label-saas">
              <span class="kpi-icon-container"
                style="margin-bottom:0; width:20px; height:20px; background:none; color:currentColor;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                  </path>
                </svg>
              </span>
              UNIVERSO TOTAL
            </div>
            <div id="kpiTotalCasos_OLD" class="kpi-value-saas" style="font-size: 32px;">0</div>
          </div>

          <div class="flex items-center gap-2 mt-2">
            <span id="kpiCasosFiltradosPercentual_OLD"
              class="text-xs font-medium text-blue-700 bg-blue-50 px-2 py-1 rounded-full border border-blue-100">0%</span>
            <span class="text-xs text-slate-400 font-medium">do total exibido</span>
          </div>
        </div>

        <!-- KPI 2: Maior Ocorrência (Escola) -->
        <div class="kpi-card-saas accent-amber">
          <div>
            <div class="kpi-label-saas">
              <span class="kpi-icon-container"
                style="margin-bottom:0; width:20px; height:20px; background:none; color:currentColor;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                  </path>
                </svg>
              </span>
              Maior Ocorrência
            </div>
            <div id="kpiTopEscola_OLD" class="kpi-value-saas line-clamp-2" style="font-size: 18px; line-height: 1.4;">-
            </div>
          </div>
          <div id="kpiTopEscolaCasos_OLD" class="kpi-subtext-saas mt-2 font-medium text-amber-600">-</div>
        </div>

        <!-- KPI 3: Tipo Frequente -->
        <div class="kpi-card-saas accent-purple">
          <div>
            <div class="kpi-label-saas">
              <span class="kpi-icon-container"
                style="margin-bottom:0; width:20px; height:20px; background:none; color:currentColor;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                  </path>
                </svg>
              </span>
              Tipo Frequente
            </div>
            <div id="kpiTipoFrequente_OLD" class="kpi-value-saas line-clamp-2"
              style="font-size: 18px; line-height: 1.4;">-
            </div>
          </div>
          <div id="kpiTipoFrequenteCasos_OLD" class="kpi-subtext-saas mt-2 font-medium text-purple-600">-</div>
        </div>

        <!-- KPI 4: Tendência Mensal -->
        <div class="kpi-card-saas accent-slate">
          <div>
            <div class="kpi-label-saas">
              <span class="kpi-icon-container"
                style="margin-bottom:0; width:20px; height:20px; background:none; color:currentColor;">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
              </span>
              Tendência Mensal
            </div>
            <div class="flex items-baseline gap-2">
              <div id="statCasosEsteMes_OLD" class="kpi-value-saas">0</div>
              <div class="text-xs text-slate-400">vs <span id="statCasosMesAnterior_OLD">0</span> anterior</div>
            </div>
          </div>

          <div class="flex items-center gap-2 mt-2">
            <div id="indicadorSeta"
              class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-100 text-gray-400 text-xs">
              -
            </div>
            <div>
              <span id="statVariacaoMensal_OLD" class="text-sm font-bold text-slate-700">0%</span>
              <span id="textoContextoTemporal_OLD" class="visually-hidden-functionality">Calculando...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ROW 2: DIAGNÓSTICO (3 Cols) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

        <!-- CARD 1: IMPACTO ESCOLAR -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col justify-between">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-amber-50 rounded-lg text-amber-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                </path>
              </svg>
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">Impacto Escolar</h3>
              <p class="text-xs text-slate-400">Ocorrências internas</p>
            </div>
          </div>
          <div>
            <span id="statEscola" class="text-3xl font-bold text-slate-800">0</span>
            <div class="text-xs text-slate-500 mt-1">casos no ambiente escolar</div>
          </div>
        </div>

        <!-- CARD 2: MAIOR OCORRÊNCIA (Moved from KPI 2) -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col justify-between">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-red-50 rounded-lg text-red-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">Ponto de Atenção</h3>
              <p class="text-xs text-slate-400">Maior volume registrado</p>
            </div>
          </div>
          <div>
            <div id="kpiTopEscola"
              class="text-lg font-bold text-slate-800 line-clamp-2 leading-tight min-h-[3.5rem] flex items-center">-
            </div>
            <div id="kpiTopEscolaCasos" class="text-xs text-red-600 font-bold mt-1 uppercase tracking-wide">-</div>
          </div>
        </div>

        <!-- CARD 3: DISTRIBUIÇÃO (List) -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">Distribuição</h3>
              <p class="text-xs text-slate-400">Por categoria</p>
            </div>
          </div>
          <div id="statTipos" class="flex-1 overflow-auto max-h-[100px] pr-2 space-y-2">
            <!-- Populated by JS -->
          </div>
        </div>

      </div>

      <!-- ROW 3: ANÁLISE COMPLEMENTAR (2 Cols) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">

        <!-- CARD: PERFIL ETÁRIO -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
              <span class="text-lg">👥</span> PERFIL ETÁRIO
            </h3>
            <span class="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded">ESTATÍSTICA</span>
          </div>

          <div class="grid grid-cols-4 gap-4">
            <!-- Média -->
            <div class="text-center p-3 rounded-lg bg-slate-50 border border-slate-100">
              <span class="block text-[10px] font-bold text-slate-400 uppercase">Média</span>
              <span id="statMediaIdade" class="block text-2xl font-bold text-slate-800 mt-1">-</span>
            </div>
            <!-- Mediana -->
            <div class="text-center p-3 rounded-lg bg-slate-50 border border-slate-100">
              <span class="block text-[10px] font-bold text-slate-400 uppercase">Mediana</span>
              <span id="statMedianaIdade" class="block text-2xl font-bold text-slate-800 mt-1">-</span>
            </div>
            <!-- Mínima -->
            <div class="text-center p-3 rounded-lg bg-emerald-50 border border-emerald-100">
              <span class="block text-[10px] font-bold text-emerald-600 uppercase">Mín</span>
              <span id="statIdadeMin" class="block text-2xl font-bold text-emerald-700 mt-1">-</span>
            </div>
            <!-- Máxima -->
            <div class="text-center p-3 rounded-lg bg-rose-50 border border-rose-100">
              <span class="block text-[10px] font-bold text-rose-600 uppercase">Máx</span>
              <span id="statIdadeMax" class="block text-2xl font-bold text-rose-700 mt-1">-</span>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center text-xs text-slate-500">
            <span>Variação padrão da amostra</span>
            <div class="flex items-center gap-2">
              <span class="font-bold">Desvio Padrão:</span>
              <span id="statDesvioPadrao" class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">-</span>
            </div>
          </div>
        </div>

        <!-- CARD: TOP ESCOLAS -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
              <span class="text-lg">🏆</span> TOP 5 ESCOLAS
            </h3>
            <span class="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded">RANKING</span>
          </div>
          <div id="top5Escolas" class="space-y-3">
            <!-- JS Content -->
          </div>
        </div>
      </div>
    </section>

    <!-- FILTROS - REFACTORED CLEAN -->




    <!-- ESTATÍSTICAS -->
    <!-- ESTATÍSTICAS (Refatorado - SaaS Enterprise) -->
    <!-- Section Removed: statsSectionSaaS (Merged into Executive Dashboard) -->

    <!-- SEÇÃO DE GRÁFICOS -->
    <section id="chartsSection" class="bg-white rounded-2xl shadow-sm p-6 mb-8 fade-in border border-slate-200"
      data-tour="charts" data-reveal="fade-up">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">📊 Gráficos Dinâmicos</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Gráfico: Tipos de Violência -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-reveal="zoom-in" data-stagger="60">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Tipos de Violência</h3>
            <button id="btnToggleChartType"
              class="p-1 px-2 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors text-gray-600 shadow-sm"
              title="Alternar visualização">
              Mudar para Barras
            </button>
          </div>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTipoViolencia"></canvas>
          </div>
        </div>

        <!-- Gráfico: Tipos de Violência Institucional -->
        <div id="containerChartViolenciaInstitucional"
          class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg p-4 border border-orange-200 hidden"
          data-reveal="zoom-in" data-stagger="60">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-orange-700">🏛️ Violência Institucional</h3>
            <button id="btnToggleChartInstType"
              class="p-1 px-2 text-xs bg-white border border-orange-200 rounded hover:bg-orange-50 transition-colors text-orange-700 shadow-sm"
              title="Alternar visualização">
              Mudar para Barras
            </button>
          </div>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTipoViolenciaInstitucional"></canvas>
          </div>
        </div>

        <!-- Gráfico: Por Região -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Casos por Região</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRegiao"></canvas>
          </div>
        </div>

        <!-- Gráfico: Por Escola -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Top 10 Escolas</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartEscola"></canvas>
          </div>
        </div>

        <!-- Gráfico: Por Faixa Etária -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Faixa Etária</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartIdade"></canvas>
          </div>
        </div>

        <!-- Gráfico: Por Gênero -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Gênero (M/F)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartGenero"></canvas>
          </div>
        </div>

        <!-- Gráfico: Por Raça/Cor -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Raça/Cor</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRaca"></canvas>
          </div>
        </div>

        <!-- Gráfico: Linha do Tempo -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 lg:col-span-2" data-reveal="zoom-in"
          data-stagger="60">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Linha do Tempo (Por Mês)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTemporal"></canvas>
          </div>
        </div>

        <!-- Gráfico: Encaminhamentos -->
        <div
          class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">📊</span>
            <span>Encaminhamentos por Rede</span>
          </h3>
          <div class="relative" style="height: 320px;">
            <canvas id="chartEncaminhamento"></canvas>
          </div>
        </div>

        <!-- Gráfico: Autor da Violência -->
        <div
          class="bg-gradient-to-br from-slate-50 to-purple-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">👤</span>
            <span>Autor da Violência</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartAutor"></canvas>
          </div>
        </div>

        <!-- Gráfico: Ocorreu na Escola? -->
        <div
          class="bg-gradient-to-br from-slate-50 to-green-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">🏫</span>
            <span>Ocorreu na Escola?</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartOcorreuEscola"></canvas>
          </div>
        </div>

        <!-- Gráfico: Correlação Tipo de Violência vs Faixa Etária -->
        <div
          class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border-2 border-indigo-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">🔗</span>
            <span>Correlação: Tipo de Violência vs Faixa Etária</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartCorrelacaoTipoIdade"></canvas>
          </div>
        </div>

        <!-- Gráfico: Comparativo Temporal (Últimos 6 Meses vs Período Anterior) -->
        <div
          class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border-2 border-amber-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">📊</span>
            <span>Comparativo Temporal: Últimos 6 Meses vs Período Anterior</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartComparativoTemporal"></canvas>
          </div>
        </div>

        <!-- Gráfico: Tendência Anual (Comparação Ano Atual vs Ano Anterior) -->
        <div
          class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-5 border-2 border-teal-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2"
          data-reveal="zoom-in" data-stagger="60">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">📈</span>
            <span>Tendência Anual: Comparação Mês a Mês</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartTendenciaAnual"></canvas>
          </div>
        </div>

      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="resultsSection" class="bg-white rounded-2xl shadow-xl p-6 hidden fade-in">
      <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="text-4xl">📋</span>
          <span>Registros</span>
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 border border-blue-200">
            <span id="recordCount">0</span>
          </span>
        </h2>
      </div>

      <div id="noResultsMessage" class="hidden p-6 text-center text-gray-500">⚠️ Nenhum registro encontrado com os
        filtros atuais.</div>

      <div id="tableContainer" data-tour="tabela" class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 sticky top-0 shadow-sm">
            <tr>
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">
                👤 Criança/Estudante</th>
              <!-- Idade merged with Criança -->
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">
                🗓️ Data</th>
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">
                ⚠️ Tipo de Violência</th>
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">
                🏫 CMEI/EMEF</th>
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">
                📍 Região</th>
              <th
                class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">
                📋 Encaminhamento</th>
              <th
                class="px-4 py-3.5 text-center text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">
                ✓ Na Escola?</th>
              <th
                class="px-4 py-3.5 text-center text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">
                🔍 Ações</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-slate-200"></tbody>
        </table>
      </div>

      <!-- Controles de Paginação Modernos -->
      <div id="paginacao"
        class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4 px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-gray-700">📄 Exibir:</span>
          <select id="registrosPorPaginaSelect"
            class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all hover:border-gray-400 cursor-pointer shadow-sm">
            <option value="5">5 registros</option>
            <option value="10" selected>10 registros</option>
            <option value="25">25 registros</option>
            <option value="50">50 registros</option>
            <option value="100">100 registros</option>
          </select>
        </div>

        <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200">
          <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Página</span>
          <span id="paginacaoInfo" class="text-sm font-bold text-slate-700 px-2">1 de 1</span>
        </div>

        <div class="flex items-center gap-1.5">
          <button id="btnPrimeiraPagina"
            class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md"
            disabled title="Primeira página">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7">
              </path>
            </svg>
          </button>
          <button id="btnPaginaAnterior"
            class="group px-4 py-2 text-sm font-medium text-gray-600 bg-white border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-gray-300 disabled:hover:text-gray-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5"
            disabled title="Página anterior">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline">Anterior</span>
          </button>
          <button id="btnProximaPagina"
            class="group px-4 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5"
            title="Próxima página">
            <span class="hidden sm:inline">Próxima</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <button id="btnUltimaPagina"
            class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md"
            title="Última página">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7">
              </path>
            </svg>
          </button>
        </div>
      </div>
    </section>

    </main>


    <script>
      // ==============================
      // Variáveis globais
      // ==============================
      let originalData = [];
      let filteredData = [];
      let columnNames = {};
      let charts = {}; // Armazena instâncias dos gráficos

      // Expõe variáveis globalmente para dashboard-stats.js
      window.originalData = originalData;
      window.filteredData = filteredData;
      window.columnNames = columnNames;

      // Variáveis de paginação (frontend-only)
      let paginaAtual = 1;
      let registrosPorPagina = 10;
      let totalPaginas = 1;

      // ==============================
      // Ponte para o módulo centralizado de escolas (escolas-tecnico.js)
      // Substitui os CSVs hardcoded que existiam aqui anteriormente
      // ==============================
      const _siglaMap = window.NAVMEscolasTecnico.getSiglaNomeMap();
      const CMEI_SIGLAS = _siglaMap.cmei;
      const EMEF_SIGLAS = _siglaMap.emef;

      // ==============================
      // Função auxiliar: Detecta se escola é Tempo Integral
      // ==============================
      function isTempoIntegral(escolaValor) {
        if (!escolaValor) return false;

        const sigla = String(escolaValor).trim().toUpperCase();
        let nomeCompleto = null;

        // Tenta achar nas listas de siglas
        if (CMEI_SIGLAS[sigla]) {
          nomeCompleto = CMEI_SIGLAS[sigla];
        } else if (EMEF_SIGLAS[sigla]) {
          nomeCompleto = EMEF_SIGLAS[sigla];
        } else {
          // Fallback: usa o próprio valor caso a planilha um dia venha com nome em vez de sigla
          nomeCompleto = String(escolaValor).trim();
        }

        const nomeUpper = nomeCompleto.toUpperCase();

        // Tempo Integral: nome completo termina com " TI" ou " TTI"
        return nomeUpper.endsWith(' TI') || nomeUpper.endsWith(' TTI');
      }

      // ==============================
      // Utilitários de texto / listas
      // ==============================

      // Normalização para reduzir erro de digitação: tira acento, pontuação, caixa
      // IMPORTANTE: Preserva a barra (/) para tipos compostos como "Financeira/Econômica"
      function normalizeText(str) {
        return String(str || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase()
          .replace(/[^a-z0-9\s\/]/g, ' ') // ← Preserva / além de letras, números e espaços
          .replace(/\s+/g, ' ')
          .trim();
      }

      // Identifica se uma escola é EMEF ou CMEI baseado no nome/sigla
      function getTipoInstituicao(nomeEscola) {
        if (!nomeEscola) return null;

        const nome = String(nomeEscola).trim().toUpperCase();

        // Verifica se é uma sigla exata de EMEF
        if (EMEF_SIGLAS[nome]) {
          return 'EMEF';
        }

        // Verifica se é uma sigla exata de CMEI
        if (CMEI_SIGLAS[nome]) {
          return 'CMEI';
        }

        // Verifica se o nome contém a sigla como palavra isolada (EMEF)
        for (const sigla in EMEF_SIGLAS) {
          const regex = new RegExp('\\b' + sigla + '\\b', 'i');
          if (regex.test(nome)) {
            return 'EMEF';
          }
        }

        // Verifica se o nome contém a sigla como palavra isolada (CMEI)
        for (const sigla in CMEI_SIGLAS) {
          const regex = new RegExp('\\b' + sigla + '\\b', 'i');
          if (regex.test(nome)) {
            return 'CMEI';
          }
        }

        // Verifica se contém "EMEF" no nome
        if (nome.includes('EMEF')) {
          return 'EMEF';
        }

        // Verifica se contém "CMEI" no nome
        if (nome.includes('CMEI')) {
          return 'CMEI';
        }

        // Se não identificou, retorna null
        return null;
      }

      // Converte sigla para nome completo (se for uma EMEF ou CMEI conhecida)
      function getDisplayName(nomeEscola) {
        if (!nomeEscola) return '';

        const nome = String(nomeEscola).trim().toUpperCase();

        // Se for uma sigla exata de EMEF, retorna "EMEF Sigla"
        if (EMEF_SIGLAS[nome]) {
          return `EMEF ${nome}`;
        }

        // Se for uma sigla exata de CMEI, retorna "CMEI Sigla"
        if (CMEI_SIGLAS[nome]) {
          return `CMEI ${nome}`;
        }

        return nomeEscola;
      }

      // ==============================
      // Sistema de Grupos de Encaminhamento
      // ==============================

      // Definição dos grupos de encaminhamento
      const encaminhamentosAgrupados = {
        redeAssistencia: ['Assistência Social', 'CRAS', 'CREAS', 'Casa Rosa', 'Psicólogo'],
        redeSaude: ['Saúde', 'UBS', 'US', 'CAPSIN'],
        redeEducacao: ['NAAM', 'Educação', 'Escola'],
        conselhoTutelar: ['CT'],
        redeSegurancaJustica: ['DACLE', 'DEAM', 'DEPI', 'DPCA', 'Defensoria Pública', 'Ministério Público', 'Outras delegacias']
      };

      // Nomes amigáveis dos grupos
      const grupoNomes = {
        redeAssistencia: 'Rede de Assistência Social',
        redeSaude: 'Rede de Saúde',
        redeEducacao: 'Rede de Educação',
        conselhoTutelar: 'Conselho Tutelar',
        redeSegurancaJustica: 'Rede de Segurança e Justiça'
      };

      // Verifica se um termo pertence a algum grupo
      function belongsToAnyGroup(term) {
        const termNorm = normalizeText(term);
        for (const groupKey in encaminhamentosAgrupados) {
          const children = encaminhamentosAgrupados[groupKey];
          if (children.some(child => normalizeText(child) === termNorm)) {
            return true;
          }
        }
        return false;
      }

      // Constrói os grupos de encaminhamento baseado nos dados reais
      function buildEncaminhamentoGroups(availableEncaminhamentos) {
        const container = document.getElementById('filterEncaminhamentoContainer');
        container.innerHTML = '';

        // Normalizar availableEncaminhamentos para comparação
        const availableNormalized = availableEncaminhamentos.map(e => normalizeText(e));

        // Construir cada grupo
        for (const groupKey in encaminhamentosAgrupados) {
          const children = encaminhamentosAgrupados[groupKey];

          // Filtrar apenas os filhos que existem nos dados
          const childrenPresent = children.filter(child =>
            availableNormalized.includes(normalizeText(child))
          );

          // Se não há filhos presentes, não renderizar o grupo
          if (childrenPresent.length === 0) continue;

          // Renderizar o grupo
          renderEncaminhamentoGroup(groupKey, childrenPresent);
        }

        // Identificar encaminhamentos não mapeados ("Outros detectados")
        const outrosDetectados = availableEncaminhamentos.filter(term => !belongsToAnyGroup(term));

        if (outrosDetectados.length > 0) {
          renderOutrosDetectados(outrosDetectados);
        }

        // Adicionar Footer de Resumo (NOVO)
        const footer = document.createElement('div');
        footer.id = 'filterEncaminhamentoFooter';
        footer.className = 'filter-encaminhamento-footer hidden'; // Começa escondido

        const summaryText = document.createElement('span');
        summaryText.id = 'encaminhamento-footer-text';
        summaryText.textContent = '';

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.id = 'btn-clear-encaminhamento';
        clearBtn.className = 'btn-clear-encaminhamento';
        clearBtn.textContent = 'Limpar seleção';
        clearBtn.onclick = clearEncaminhamentoSelection;

        footer.appendChild(summaryText);
        footer.appendChild(clearBtn);
        container.appendChild(footer);
      }

      // Atualiza o footer com resumo e botão de limpar
      function updateEncaminhamentoFooter() {
        const footer = document.getElementById('filterEncaminhamentoFooter');
        const summaryText = document.getElementById('encaminhamento-footer-text');

        if (!footer || !summaryText) return;

        const allChecked = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
        const count = allChecked.length;

        if (count > 0) {
          footer.classList.remove('hidden');
          summaryText.textContent = `${count} selecionado${count > 1 ? 's' : ''}`;
        } else {
          footer.classList.add('hidden');
        }
      }

      // Limpa toda a seleção de encaminhamentos
      function clearEncaminhamentoSelection() {
        const allCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.indeterminate = false; // Limpa indeterminado também
        });

        // Remove seleção visual dos itens
        const selectedItems = document.querySelectorAll('#filterEncaminhamentoContainer .checkbox-container-item.selected');
        selectedItems.forEach(item => item.classList.remove('selected'));

        // Atualiza contadores de grupo
        const groups = document.querySelectorAll('.encaminhamento-group');
        groups.forEach(group => {
          const groupId = group.dataset.group;
          if (groupId) updateGroupCounter(groupId);
        });

        updateBadgeEncaminhamentoTotal();
      }

      // Renderiza um grupo de encaminhamento - REFINAMENTO SAAS
      function renderEncaminhamentoGroup(groupId, childrenPresent) {
        const container = document.getElementById('filterEncaminhamentoContainer');
        const groupName = grupoNomes[groupId] || groupId;

        // Criar estrutura do grupo
        const groupDiv = document.createElement('div');
        groupDiv.className = 'encaminhamento-group';
        groupDiv.dataset.group = groupId;

        // Header do grupo
        const header = document.createElement('div');
        header.className = 'group-header';
        header.onclick = () => toggleGroupPanel(groupId);

        const headerLeft = document.createElement('div');
        headerLeft.className = 'group-header-left';

        // Checkbox do grupo
        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'group-checkbox-wrapper';

        const groupCheckbox = document.createElement('input');
        groupCheckbox.type = 'checkbox';
        groupCheckbox.id = `group-${groupId}`;
        groupCheckbox.className = 'custom-checkbox';
        groupCheckbox.onclick = (e) => e.stopPropagation();
        groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);

        checkboxWrapper.appendChild(groupCheckbox);

        // Wrapper do título e contador
        const titleWrapper = document.createElement('div');
        titleWrapper.className = 'flex items-center';

        // Título do grupo
        const title = document.createElement('span');
        title.className = 'group-title';
        title.textContent = groupName;

        // Contador do grupo (NOVO)
        const counter = document.createElement('span');
        counter.id = `counter-${groupId}`;
        counter.className = 'group-counter';
        counter.textContent = ''; // Inicialmente vazio

        titleWrapper.appendChild(title);
        titleWrapper.appendChild(counter);

        headerLeft.appendChild(checkboxWrapper);
        headerLeft.appendChild(titleWrapper);

        // Ícone de toggle
        const toggleIcon = document.createElement('svg');
        toggleIcon.id = `toggle-${groupId}`;
        toggleIcon.className = 'toggle-icon';
        toggleIcon.setAttribute('fill', 'none');
        toggleIcon.setAttribute('stroke', 'currentColor');
        toggleIcon.setAttribute('viewBox', '0 0 24 24');
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';

        header.appendChild(headerLeft);
        header.appendChild(toggleIcon);

        // Body do grupo (conteúdo colapsável)
        const body = document.createElement('div');
        body.id = `body-${groupId}`;
        body.className = 'group-body';

        const bodyContent = document.createElement('div');
        bodyContent.className = 'group-body-content';

        // Criar checkboxes dos filhos
        childrenPresent.forEach((child, index) => {
          const childDiv = document.createElement('div');
          // Nova classe .checkbox-container-item mais leve
          childDiv.className = 'checkbox-container-item';

          // Torna o DIV inteiro clicável
          childDiv.onclick = (e) => {
            // Evita duplo disparo se clicar direto no checkbox
            if (e.target !== childCheckbox && e.target !== childDiv.querySelector('label')) {
              childCheckbox.checked = !childCheckbox.checked;
              childCheckbox.dispatchEvent(new Event('change'));
            }
          };

          const childCheckbox = document.createElement('input');
          childCheckbox.type = 'checkbox';
          childCheckbox.id = `${groupId}_child_${index}`;
          childCheckbox.className = 'custom-checkbox';
          childCheckbox.dataset.value = child;
          childCheckbox.dataset.group = groupId;
          childCheckbox.onchange = function () {
            // Atualiza visual de seleção do item
            if (this.checked) {
              childDiv.classList.add('selected');
            } else {
              childDiv.classList.remove('selected');
            }
            onChildCheckboxChange(groupId);
          };

          const label = document.createElement('label');
          label.htmlFor = `${groupId}_child_${index}`;
          label.className = 'checkbox-label';
          label.textContent = child;

          // Previne click no label de propagar para o div (já que label dispara checkbox nativamente)
          label.onclick = (e) => e.stopPropagation();

          childDiv.appendChild(childCheckbox);
          childDiv.appendChild(label);
          bodyContent.appendChild(childDiv);
        });

        body.appendChild(bodyContent);

        groupDiv.appendChild(header);
        groupDiv.appendChild(body);
        container.appendChild(groupDiv);
      }

      // Renderiza grupo "Outros detectados" - REFINAMENTO SAAS
      function renderOutrosDetectados(termos) {
        const container = document.getElementById('filterEncaminhamentoContainer');
        const groupId = 'outrosDetectados';

        const groupDiv = document.createElement('div');
        // Mantém classe 'outros-detectados' para CSS específico (agora mais elegante)
        groupDiv.className = 'encaminhamento-group outros-detectados';
        groupDiv.dataset.group = groupId;

        const header = document.createElement('div');
        header.className = 'group-header';
        header.onclick = () => toggleGroupPanel(groupId);

        const headerLeft = document.createElement('div');
        headerLeft.className = 'group-header-left';

        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'group-checkbox-wrapper';

        const groupCheckbox = document.createElement('input');
        groupCheckbox.type = 'checkbox';
        groupCheckbox.id = `group-${groupId}`;
        groupCheckbox.className = 'custom-checkbox';
        groupCheckbox.onclick = (e) => e.stopPropagation();
        groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);

        checkboxWrapper.appendChild(groupCheckbox);

        const titleWrapper = document.createElement('div');
        titleWrapper.className = 'flex items-center';

        const title = document.createElement('span');
        title.className = 'group-title';
        title.textContent = 'Outros detectados'; // Ícone ⚠️ removido para visual mais limpo

        const counter = document.createElement('span');
        counter.id = `counter-${groupId}`;
        counter.className = 'group-counter';
        counter.textContent = '';

        titleWrapper.appendChild(title);
        titleWrapper.appendChild(counter);

        headerLeft.appendChild(checkboxWrapper);
        headerLeft.appendChild(titleWrapper);

        const toggleIcon = document.createElement('svg');
        toggleIcon.id = `toggle-${groupId}`;
        toggleIcon.className = 'toggle-icon';
        toggleIcon.setAttribute('fill', 'none');
        toggleIcon.setAttribute('stroke', 'currentColor');
        toggleIcon.setAttribute('viewBox', '0 0 24 24');
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';

        header.appendChild(headerLeft);
        header.appendChild(toggleIcon);

        const body = document.createElement('div');
        body.id = `body-${groupId}`;
        body.className = 'group-body';

        const bodyContent = document.createElement('div');
        bodyContent.className = 'group-body-content';

        termos.forEach((termo, index) => {
          const childDiv = document.createElement('div');
          // Visual refinado também para 'outros'
          childDiv.className = 'checkbox-container-item';

          childDiv.onclick = (e) => {
            if (e.target !== childCheckbox && e.target !== childDiv.querySelector('label')) {
              childCheckbox.checked = !childCheckbox.checked;
              childCheckbox.dispatchEvent(new Event('change'));
            }
          };

          const childCheckbox = document.createElement('input');
          childCheckbox.type = 'checkbox';
          childCheckbox.id = `${groupId}_child_${index}`;
          childCheckbox.className = 'custom-checkbox';
          childCheckbox.dataset.value = termo;
          childCheckbox.dataset.group = groupId; // Fixado para usar groupId correto
          childCheckbox.onchange = function () {
            if (this.checked) {
              childDiv.classList.add('selected');
            } else {
              childDiv.classList.remove('selected');
            }
            onChildCheckboxChange(groupId);
          };

          const label = document.createElement('label');
          label.htmlFor = `${groupId}_child_${index}`;
          label.className = 'checkbox-label';
          label.textContent = termo;
          label.onclick = (e) => e.stopPropagation();

          childDiv.appendChild(childCheckbox);
          childDiv.appendChild(label);
          bodyContent.appendChild(childDiv);
        });

        body.appendChild(bodyContent);

        groupDiv.appendChild(header);
        groupDiv.appendChild(body);
        container.appendChild(groupDiv);
      }

      // Toggle panel de um grupo
      function toggleGroupPanel(groupId) {
        const body = document.getElementById(`body-${groupId}`);
        const icon = document.getElementById(`toggle-${groupId}`);
        const groupDiv = document.querySelector(`.encaminhamento-group[data-group="${groupId}"]`);

        if (body && icon) {
          // Toggle class 'expanded' no groupDiv para controle de borda do header e icon
          if (groupDiv) groupDiv.classList.toggle('expanded');

          // Toggle no body (max-height via CSS)
          body.classList.toggle('expanded');

          // Toggle no icon (rotação via CSS no pai ou classe direta)
          // Mas como usamos .encaminhamento-group.expanded .toggle-icon no CSS, 
          // a classe 'rotated' no ícone é redundante se o CSS usar o pai,
          // mas vamos manter para compatibilidade se o CSS usar a classe direta.
          icon.classList.toggle('rotated');
        }
      }

      // Handler quando checkbox de grupo muda
      function onGroupCheckboxChange(groupId) {
        const groupCheckbox = document.getElementById(`group-${groupId}`);
        const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);

        // Marcar/desmarcar todos os filhos e atualizar visual
        childCheckboxes.forEach(child => {
          child.checked = groupCheckbox.checked;
          const parentDiv = child.closest('.checkbox-container-item');
          if (parentDiv) {
            if (child.checked) parentDiv.classList.add('selected');
            else parentDiv.classList.remove('selected');
          }
        });

        // Atualiza contador e badge (agora usando contador de texto)
        updateGroupCounter(groupId);
        updateBadgeEncaminhamentoTotal(); // Opcional se usar footer
        updateEncaminhamentoFooter(); // Atualiza footer de resumo
        applyFilters();
      }

      // Handler quando checkbox de filho muda
      function onChildCheckboxChange(groupId) {
        const groupCheckbox = document.getElementById(`group-${groupId}`);
        const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);

        const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(childCheckboxes).some(cb => cb.checked);

        // Atualizar estado do grupo (checked, indeterminate, unchecked)
        groupCheckbox.checked = allChecked;
        groupCheckbox.indeterminate = someChecked && !allChecked;

        updateGroupCounter(groupId);
        updateBadgeEncaminhamentoTotal(); // Mantido para compatibilidade
        updateEncaminhamentoFooter(); // Novo footer
        applyFilters();
      }

      // Atualiza o contador de texto do grupo (Ex: "(2)")
      function updateGroupCounter(groupId) {
        const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
        const count = childCheckboxes.length;
        const counterEl = document.getElementById(`counter-${groupId}`);

        if (counterEl) {
          if (count > 0) {
            counterEl.textContent = `(${count})`;
            counterEl.classList.add('visible');
          } else {
            counterEl.textContent = '';
            counterEl.classList.remove('visible');
          }
        }
      }

      // Atualiza badge de um grupo específico
      function updateGroupBadge(groupId) {
        const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
        const count = childCheckboxes.length;
        const badge = document.getElementById(`badge-${groupId}`);

        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      }

      // Atualiza badge total de encaminhamento
      function updateBadgeEncaminhamentoTotal() {
        const allChildCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
        const count = allChildCheckboxes.length;
        const badge = document.getElementById('badge-encaminhamento-total');

        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      }

      // ==============================
      // Sistema de Grupos de Violências Institucionais
      // ==============================

      // Definição dos grupos de violências institucionais (similar aos encaminhamentos)
      const violenciasInstitucionaisAgrupadas = {
        fisica: ['Física', 'Fisica'],
        psicologica: ['Psicológica', 'Psicologica', 'Psicológica/Moral'],
        sexual: ['Sexual', 'Abuso Sexual'],
        verbal: ['Verbal', 'Verbal/Moral'],
        negligencia: ['Negligência', 'Negligencia', 'Negligência/Abandono'],
        patrimonial: ['Patrimonial', 'Patrimonial/Econômica'],
        bullying: ['Bullying', 'Bullying/Cyberbullying'],
        outras: ['Outras', 'Outros']
      };

      // Nomes amigáveis dos grupos
      const grupoNomesViolenciaInstitucional = {
        fisica: 'Violência Física',
        psicologica: 'Violência Psicológica',
        sexual: 'Violência Sexual',
        verbal: 'Violência Verbal',
        negligencia: 'Negligência',
        patrimonial: 'Violência Patrimonial',
        bullying: 'Bullying/Cyberbullying',
        outras: 'Outras Violências Institucionais'
      };

      // Verifica se um termo pertence a algum grupo
      function belongsToAnyGroupViolenciaInstitucional(term) {
        const termNorm = normalizeText(term);
        for (const groupKey in violenciasInstitucionaisAgrupadas) {
          const children = violenciasInstitucionaisAgrupadas[groupKey];
          if (children.some(child => normalizeText(child) === termNorm)) {
            return true;
          }
        }
        return false;
      }

      // Constrói a lista de violências institucionais com cards (REDESIGN)
      function buildViolenciaInstitucionalGroups(data) {
        const container = document.getElementById('filterViolenciaInstitucionalContainer');
        if (!container) return;

        container.innerHTML = '';

        // Coleta todas as violências institucionais dos dados
        // Apenas de registros que têm "Institucional" em tipoViolencia
        const violenciasInstitucionais = new Set();

        data.forEach(row => {
          const tipoViolencia = String(row[columnNames.tipo] || '').toLowerCase();
          const temInstitucional = tipoViolencia.includes('institucional');

          if (temInstitucional && columnNames.tipoViolenciaInstitucional) {
            const violenciaInstitucional = row[columnNames.tipoViolenciaInstitucional];
            if (violenciaInstitucional) {
              // Pode ter múltiplos valores separados por vírgula
              const valores = String(violenciaInstitucional).split(',').map(v => v.trim()).filter(v => v);
              valores.forEach(v => violenciasInstitucionais.add(v));
            }
          }
        });

        const availableViolencias = Array.from(violenciasInstitucionais).sort();

        if (availableViolencias.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-sm italic">Nenhuma violência institucional encontrada nos dados.</p>';
          return;
        }

        // Usar a nova função de sub-cards para renderizar
        createViolenceSubCards('filterViolenciaInstitucionalContainer', availableViolencias, 'violenciaInstitucional');
      }


      // Atualiza badge total de violência institucional
      function updateBadgeViolenciaInstitucionalTotal() {
        // Conta apenas os checkboxes individuais (exclui o checkbox geral)
        const allChildCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
        const count = allChildCheckboxes.length;
        const badge = document.getElementById('badge-violenciaInstitucional-total');

        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      }

      // Coleta todos os tipos de violência institucional selecionados
      function gatherSelectedViolenciasInstitucionais() {
        // Retorna apenas os checkboxes individuais (exclui o checkbox geral)
        const selectedCheckboxes = document.querySelectorAll('#filterViolenciaInstitucionalContainer input[data-filter="violenciaInstitucional"]:checked:not(#checkbox-violencia-institucional-geral)');
        return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
      }

      // Verifica se uma célula de violência institucional corresponde aos termos selecionados (lógica OR)
      function matchViolenciaInstitucionalCell(cellValue, selectedTerms) {
        // Se nenhum termo foi selecionado, aceita todos
        if (selectedTerms.length === 0) return true;

        // Se há termos selecionados mas a célula está vazia, REJEITA
        if (!cellValue) return false;

        // Normalizar célula (split por vírgula)
        const cellValues = String(cellValue)
          .split(',')
          .map(v => normalizeText(v.trim()))
          .filter(v => v);

        // Se após normalizar não há valores, REJEITA
        if (cellValues.length === 0) return false;

        // Normalizar termos selecionados
        const selectedNormalized = selectedTerms.map(t => normalizeText(t));

        // Retorna true se qualquer valor da célula estiver nos selecionados (OR)
        return cellValues.some(cv => selectedNormalized.includes(cv));
      }

      // Verifica se "Institucional" está selecionado e mostra/esconde a seção de detalhamento
      function verificarViolenciaInstitucionalNoFiltro() {
        const sectionViolenciaInstitucional = document.getElementById('section-violenciaInstitucional');
        if (!sectionViolenciaInstitucional) return;

        // Verifica se algum checkbox de "Institucional" está marcado no filtro de Tipo Violência
        const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
        const temInstitucional = Array.from(tipoViolenciaCheckboxes).some(cb => {
          const valor = (cb.dataset.value || '').toLowerCase();
          return valor === 'institucional' || valor.includes('institucional');
        });

        if (temInstitucional) {
          // Mostra a seção de detalhamento de Violências Institucionais
          sectionViolenciaInstitucional.classList.remove('hidden');

          // Mostra o gráfico de violência institucional
          const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
          if (containerChartViolenciaInst) {
            containerChartViolenciaInst.classList.remove('hidden');
          }

          // Re-renderiza os gráficos para atualizar o gráfico de violência institucional
          setTimeout(() => {
            if (typeof renderCharts === 'function' && filteredData) {
              renderCharts(filteredData);
            }
          }, 100);
        } else {
          // Esconde a seção de detalhamento
          sectionViolenciaInstitucional.classList.add('hidden');

          // Desmarca todos os sub-cards de violências institucionais
          const viCards = document.querySelectorAll('#filterViolenciaInstitucionalContainer .violence-sub-card');
          viCards.forEach(card => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
              checkbox.checked = false;
              card.classList.remove('selected');
            }
          });

          // Atualiza badges
          updateBadgeViolenciaInstitucionalTotal();

          // Esconde o gráfico de violência institucional
          const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
          if (containerChartViolenciaInst) {
            containerChartViolenciaInst.classList.add('hidden');
          }

          // Destroi o gráfico se existir
          if (charts['chartTipoViolenciaInstitucional']) {
            charts['chartTipoViolenciaInstitucional'].destroy();
            delete charts['chartTipoViolenciaInstitucional'];
          }

          // Aplica filtros para atualizar a tabela
          applyFilters();
        }
      }

      // Torna a função acessível globalmente
      window.verificarViolenciaInstitucionalNoFiltro = verificarViolenciaInstitucionalNoFiltro;

      // Coleta todos os encaminhamentos selecionados (de todos os grupos)
      function gatherSelectedEncaminhamentos() {
        const selectedCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
        return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
      }

      // Verifica se uma célula de encaminhamento corresponde aos termos selecionados (lógica OR)
      function matchEncaminhamentoCell(cellValue, selectedTerms) {
        // Se nenhum termo foi selecionado, aceita todos
        if (selectedTerms.length === 0) return true;

        // Se há termos selecionados mas a célula está vazia, REJEITA
        if (!cellValue) return false;

        // Normalizar célula (split por vírgula e barra)
        const cellValues = String(cellValue)
          .split(',')
          .flatMap(v => v.split('/'))
          .map(v => normalizeText(v.trim()))
          .filter(v => v);

        // Se após normalizar não há valores, REJEITA
        if (cellValues.length === 0) return false;

        // Normalizar termos selecionados
        const selectedNormalized = selectedTerms.map(t => normalizeText(t));

        // Retorna true se qualquer valor da célula estiver nos selecionados (OR)
        return cellValues.some(cv => selectedNormalized.includes(cv));
      }

      // Gera opções "agrupadas" por texto normalizado (com suporte a multi-valor)
      function buildNormalizedOptions(colKey, data) {
        const map = new Map(); // norm -> rótulo original mais comum
        data.forEach(row => {
          const raw = row[colKey];
          if (!raw) return;

          // Suporta valores múltiplos separados por vírgula E por barra (/)
          // Primeiro separa por vírgula, depois cada parte por barra
          const valores = String(raw)
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);

          valores.forEach(val => {
            const norm = normalizeText(val);
            if (!norm) return;

            // Guarda o label original mais completo (maior length)
            if (!map.has(norm) || val.length > map.get(norm).length) {
              map.set(norm, val);
            }
          });
        });
        return Array.from(map.values()).sort();
      }

      // Gera opções para TIPO DE VIOLÊNCIA (NÃO separa por barra - "Financeira/Econômica" fica junto)
      function buildNormalizedOptionsTipoViolencia(colKey, data) {
        const map = new Map(); // norm -> rótulo original mais comum
        data.forEach(row => {
          const raw = row[colKey];
          if (!raw) return;

          // Suporta valores múltiplos separados APENAS por vírgula
          // NÃO separa por barra (/) para manter "Financeira/Econômica" como uma única categoria
          const valores = String(raw)
            .split(',')
            .map(v => v.trim())
            .filter(v => v);

          valores.forEach(val => {
            const norm = normalizeText(val);
            if (!norm) return;

            // Guarda o label original mais completo (maior length)
            if (!map.has(norm) || val.length > map.get(norm).length) {
              map.set(norm, val);
            }
          });
        });
        return Array.from(map.values()).sort();
      }

      // ========================================
      // NORMALIZAÇÃO DE TRANSTORNOS (UNIFICAÇÃO)
      // ========================================
      // Unifica variações de transtornos em rótulos padronizados
      function normalizarTranstorno(label) {
        if (!label) return label;

        const norm = normalizeText(label);

        // Equivalências para TDAH
        const equivalenciasTDAH = [
          'tdah',
          'tdh',
          'tda h',
          't d a h',
          'deficit de atencao',
          'deficit atencao',
          'deficitdeatencao',
          'deficit hiperatividade',
          'transtorno de deficit',
          'transtorno deficit',
          'transtorno de deficit de atencao',
          'transtorno deficit atencao',
          'deficit de atencao e hiperatividade',
          'deficit de atencao hiperatividade'
        ];

        if (equivalenciasTDAH.some(e => norm.includes(e) || e.includes(norm))) {
          return 'TDAH (Déficit de Atenção e Hiperatividade)';
        }

        // Equivalências para TEA (Autismo)
        const equivalenciasTEA = [
          'tea',
          't e a',
          'autismo',
          'autista',
          'transtorno do espectro autista',
          'espectro autista',
          'transtorno autista'
        ];

        if (equivalenciasTEA.some(e => norm.includes(e) || e.includes(norm))) {
          return 'TEA (Transtorno do Espectro Autista)';
        }

        // Equivalências para DI (Deficiência Intelectual)
        const equivalenciasDI = [
          'di ',
          ' di',
          'd i',
          'deficiencia intelectual',
          'deficiencia mental'
        ];

        if (equivalenciasDI.some(e => norm === e || norm.includes(e))) {
          return 'DI (Deficiência Intelectual)';
        }

        // Equivalências para TOD (Transtorno Opositor Desafiador)
        const equivalenciasTOD = [
          'tod',
          't o d',
          'transtorno opositor',
          'opositor desafiador',
          'transtorno opositor desafiador'
        ];

        if (equivalenciasTOD.some(e => norm.includes(e) || e.includes(norm))) {
          return 'TOD (Transtorno Opositor Desafiador)';
        }

        // Retorna o label original se não encontrou equivalência
        return label;
      }

      // Aplica normalização a uma lista de opções
      function normalizarListaTranstornos(opcoes) {
        const map = new Map(); // Usa Map para evitar duplicatas após normalização

        opcoes.forEach(opt => {
          const normalizado = normalizarTranstorno(opt);
          // Guarda apenas uma vez (a primeira ocorrência)
          if (!map.has(normalizado)) {
            map.set(normalizado, true);
          }
        });

        return Array.from(map.keys()).sort();
      }

      // Gera opções para coluna de Gênero (apenas M ou F)
      function buildGeneroOptions(data) {
        const valores = new Set();
        data.forEach(row => {
          const genero = row[columnNames.genero];
          if (genero) {
            const val = String(genero).trim().toUpperCase();
            if (val === 'M' || val === 'F') {
              valores.add(val);
            }
          }
        });
        return Array.from(valores).sort();
      }

      // Cria checkboxes elegantes para filtros
      function createCheckboxes(containerId, options, filterName) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        options.forEach((opt, index) => {
          const id = `${filterName}_${index}`;
          const div = document.createElement('div');
          div.className = 'checkbox-container';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = id;
          checkbox.className = 'custom-checkbox';
          checkbox.dataset.value = opt;
          checkbox.dataset.filter = filterName;
          checkbox.addEventListener('change', function () {
            updateBadge(filterName);
            applyFilters();

            // Se for filtro de tipoViolencia, verifica se "Institucional" está selecionado
            if (filterName === 'tipoViolencia') {
              verificarViolenciaInstitucionalNoFiltro();
            }
          });

          const label = document.createElement('label');
          label.htmlFor = id;
          label.className = 'checkbox-label';
          label.textContent = opt;

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      // ============================================
      // CARDS DE TIPO DE VIOLÊNCIA - REDESIGN
      // Sistema escalável para 1-9+ tipos
      // ============================================

      // Mapeamento de tipos para ícones SVG e cores
      const VIOLENCE_TYPE_CONFIG = {
        'fisica': {
          svgPath: '<path d="M18 4a3 3 0 0 0-3 3v4H5a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h1l1 5h8l1-5h1a2 2 0 0 0 2-2v-1a2 2 0 0 0-2-2h-2V7a1 1 0 0 1 2 0"/><circle cx="12" cy="4" r="2"/>',
          color: 'fisica',
          keywords: ['física', 'fisica', 'agressão física', 'agressao fisica']
        },
        'psicologica': {
          svgPath: '<path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7z"/><line x1="9" y1="21" x2="15" y2="21"/><line x1="10" y1="23" x2="14" y2="23"/>',
          color: 'psicologica',
          keywords: ['psicológica', 'psicologica', 'emocional', 'mental']
        },
        'sexual': {
          svgPath: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
          color: 'sexual',
          keywords: ['sexual', 'abuso sexual']
        },
        'negligencia': {
          svgPath: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" y1="11" x2="23" y2="11"/>',
          color: 'negligencia',
          keywords: ['negligência', 'negligencia', 'abandono', 'omissão']
        },
        'institucional': {
          svgPath: '<path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/>',
          color: 'institucional',
          keywords: ['institucional']
        },
        'bullying': {
          svgPath: '<path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',
          color: 'bullying',
          keywords: ['bullying']
        },
        'cyberbullying': {
          svgPath: '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/><path d="M9 6h6"/><path d="M12 10v2"/><path d="M12 14h.01"/>',
          color: 'cyberbullying',
          keywords: ['cyberbullying', 'cyber']
        },
        'autolesao': {
          svgPath: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="m12 13-1-1 2-2-3-3 2-2"/>',
          color: 'autolesao',
          keywords: ['autolesão', 'autolesao', 'automutilação', 'suicídio']
        },
        'financeira': {
          svgPath: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
          color: 'outros',
          keywords: ['financeira', 'econômica', 'patrimonial']
        },
        'outros': {
          svgPath: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>',
          color: 'outros',
          keywords: ['outro', 'outros', 'outra']
        }
      };

      /**
       * Detecta o tipo de violência baseado no texto
       * @param {string} text - Texto do tipo de violência
       * @returns {Object} Configuração do tipo (icon, color)
       */
      function detectViolenceType(text) {
        const normalized = normalizeText(text);

        for (const [key, config] of Object.entries(VIOLENCE_TYPE_CONFIG)) {
          for (const keyword of config.keywords) {
            if (normalized.includes(normalizeText(keyword))) {
              return { key, ...config };
            }
          }
        }

        // Fallback para tipos não mapeados
        return { key: 'outros', svgPath: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>', color: 'outros', keywords: [] };
      }

      /**
       * Cria cards de tipo de violência (versão card-based)
       * @param {string} containerId - ID do container
       * @param {Array} options - Lista de opções
       * @param {string} filterName - Nome do filtro (tipoViolencia)
       */
      function createViolenceTypeCards(containerId, options, filterName) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        options.forEach((opt, index) => {
          const id = `${filterName}_${index}`;
          const typeConfig = detectViolenceType(opt);

          // Criar card
          const card = document.createElement('div');
          card.className = 'violence-type-card';
          card.dataset.type = typeConfig.key;
          card.dataset.value = opt;

          // Checkbox oculto mas funcional
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = id;
          checkbox.dataset.value = opt;
          checkbox.dataset.filter = filterName;
          checkbox.addEventListener('change', function () {
            // Atualiza estado visual do card
            if (this.checked) {
              card.classList.add('selected');
            } else {
              card.classList.remove('selected');
            }

            // Atualiza badge e aplica filtros
            updateBadge(filterName);
            applyFilters();

            // Verifica se "Institucional" está selecionado
            if (filterName === 'tipoViolencia') {
              verificarViolenciaInstitucionalNoFiltro();
            }
          });

          // Ícone SVG do tipo
          const icon = document.createElement('div');
          icon.className = 'violence-type-icon';
          icon.innerHTML = `<svg viewBox="0 0 24 24">${typeConfig.svgPath}</svg>`;

          // Label do tipo
          const label = document.createElement('span');
          label.className = 'violence-type-label';
          label.textContent = opt;

          // Check mark SVG
          const check = document.createElement('span');
          check.className = 'violence-type-check';
          check.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>';

          // Montar card
          card.appendChild(checkbox);
          card.appendChild(icon);
          card.appendChild(label);
          card.appendChild(check);

          // Click no card alterna o checkbox
          card.addEventListener('click', function (e) {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change'));
            }
          });

          container.appendChild(card);
        });
      }

      /**
       * Cria cards para violência institucional (subgrupo)
       * @param {string} containerId - ID do container
       * @param {Array} options - Lista de opções
       * @param {string} filterName - Nome do filtro
       */
      function createViolenceSubCards(containerId, options, filterName) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        // Ícones para tipos de violência institucional
        const INST_ICONS = {
          'verbal': '🗣️',
          'física': '👊',
          'omissão': '🚫',
          'discriminação': '🎯',
          'negligência': '⚡',
          'exposição': '👁️',
          'humilhação': '😔',
          'constrangimento': '😣',
          'default': '📌'
        };

        const getInstIcon = (text) => {
          const normalized = normalizeText(text);
          for (const [key, icon] of Object.entries(INST_ICONS)) {
            if (key !== 'default' && normalized.includes(normalizeText(key))) {
              return icon;
            }
          }
          return INST_ICONS.default;
        };

        options.forEach((opt, index) => {
          const id = `${filterName}_${index}`;

          // Criar sub-card
          const card = document.createElement('div');
          card.className = 'violence-sub-card';
          card.dataset.value = opt;

          // Checkbox oculto
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = id;
          checkbox.dataset.value = opt;
          checkbox.dataset.filter = filterName;
          checkbox.addEventListener('change', function () {
            if (this.checked) {
              card.classList.add('selected');
            } else {
              card.classList.remove('selected');
            }
            updateBadgeViolenciaInstitucionalTotal();
            applyFilters();
          });

          // Ícone
          const icon = document.createElement('span');
          icon.className = 'violence-sub-icon';
          icon.textContent = getInstIcon(opt);

          // Label
          const label = document.createElement('span');
          label.className = 'violence-sub-label';
          label.textContent = opt;

          // Check
          const check = document.createElement('span');
          check.className = 'violence-sub-check';
          check.textContent = '✓';

          // Montar card
          card.appendChild(checkbox);
          card.appendChild(icon);
          card.appendChild(label);
          card.appendChild(check);

          // Click toggle
          card.addEventListener('click', function (e) {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change'));
            }
          });

          container.appendChild(card);
        });
      }

      /**
       * Seleciona todos os tipos de violência
       */
      function selectAllViolenceTypes() {
        const cards = document.querySelectorAll('#filterTipoViolenciaContainer .violence-type-card');
        cards.forEach(card => {
          const checkbox = card.querySelector('input[type="checkbox"]');
          if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
            card.classList.add('selected');
          }
        });
        updateBadge('tipoViolencia');
        applyFilters();
        verificarViolenciaInstitucionalNoFiltro();
      }

      /**
       * Limpa todos os tipos de violência selecionados
       */
      function clearAllViolenceTypes() {
        const cards = document.querySelectorAll('#filterTipoViolenciaContainer .violence-type-card');
        cards.forEach(card => {
          const checkbox = card.querySelector('input[type="checkbox"]');
          if (checkbox && checkbox.checked) {
            checkbox.checked = false;
            card.classList.remove('selected');
          }
        });
        updateBadge('tipoViolencia');
        applyFilters();
        verificarViolenciaInstitucionalNoFiltro();
      }

      function initEscolaSearch() {
        const input = document.getElementById('filterEscolaSearch');
        const container = document.getElementById('filterEscolaContainer');
        const listPanel = document.getElementById('filterEscolaAutocompleteList');
        const chipsArea = document.getElementById('filterEscolaSelectedTags');
        const componentWrapper = input.closest('.escola-multiselect');
        if (!input || !container || !listPanel || !componentWrapper) return;

        if (input.dataset.bound === 'true') return;
        input.dataset.bound = 'true';

        let cached = [];
        let isOpen = false;

        const openPanel = () => {
          if (isOpen) return;
          isOpen = true;
          listPanel.classList.add('is-expanded');
          // Scroll active item into view if exists
          const activeItem = listPanel.querySelector('.escola-list-item.active') || listPanel.querySelector('.escola-list-item.is-selected');
          if (activeItem) {
            setTimeout(() => activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' }), 100);
          }
        };

        const closePanel = () => {
          if (!isOpen) return;
          isOpen = false;
          listPanel.classList.remove('is-expanded');
          // Reset scroll? No, keep position
        };

        const buildReverseSiglas = () => {
          const rev = { cmei: {}, emef: {} };
          if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS) {
            Object.keys(CMEI_SIGLAS).forEach((sigla) => {
              const nome = CMEI_SIGLAS[sigla];
              if (!sigla || !nome) return;
              const full = `CMEI ${String(nome).trim()}`;
              rev.cmei[normalizeText(full)] = String(sigla).trim();
            });
          }
          if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS) {
            Object.keys(EMEF_SIGLAS).forEach((sigla) => {
              const nome = EMEF_SIGLAS[sigla];
              if (!sigla || !nome) return;
              const full = `EMEF ${String(nome).trim()}`;
              rev.emef[normalizeText(full)] = String(sigla).trim();
            });
          }
          return rev;
        };

        const reverseSiglas = buildReverseSiglas();

        const getNomeFromSigla = (sigla) => {
          const s = String(sigla || '').trim().toUpperCase();
          if (!s) return '';
          if (typeof CMEI_SIGLAS === 'object' && CMEI_SIGLAS && CMEI_SIGLAS[s]) return `CMEI ${CMEI_SIGLAS[s]}`;
          if (typeof EMEF_SIGLAS === 'object' && EMEF_SIGLAS && EMEF_SIGLAS[s]) return `EMEF ${EMEF_SIGLAS[s]}`;
          return '';
        };

        const rebuildCache = () => {
          const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"][data-filter="escola"]'));
          cached = checkboxes
            .map((cb) => {
              const raw = String(cb.getAttribute('data-value') || '').trim();
              if (!raw) return null;
              const nomeFromSigla = getNomeFromSigla(raw);
              const value = nomeFromSigla || raw;
              const tipo = getTipoInstituicao(value) || getTipoInstituicao(raw) || '';
              let sigla = '';
              if (nomeFromSigla) {
                sigla = raw;
              } else {
                const key = normalizeText(raw);
                sigla = reverseSiglas.cmei[key] || reverseSiglas.emef[key] || '';
              }
              const normalized = normalizeText(value);
              const siglaNormalized = normalizeText(sigla);
              return { checkboxValue: raw, value, tipo, sigla, siglaNormalized, normalized, cb };
            })
            .filter(Boolean);
        };

        // Check if a cached item's checkbox is currently checked
        const isChecked = (it) => it.cb && it.cb.checked;

        // Build a single list item DOM element
        const buildListItem = (it, isSelected) => {
          const row = document.createElement('div');
          row.className = 'escola-list-item' + (isSelected ? ' is-selected' : '');

          // Checkbox visual
          const checkDiv = document.createElement('div');
          checkDiv.className = 'escola-list-checkbox';
          checkDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          row.appendChild(checkDiv);

          // Badge (CMEI/EMEF)
          if (it.tipo) {
            const badge = document.createElement('span');
            badge.className = `escola-list-badge ${String(it.tipo).toLowerCase()}`;
            badge.textContent = it.tipo;
            row.appendChild(badge);
          }

          // Info (name + sigla)
          const info = document.createElement('div');
          info.className = 'escola-list-info';
          const nomeSemTipo = it.tipo ? String(it.value).replace(String(it.tipo) + ' ', '') : it.value;
          const nomeEl = document.createElement('span');
          nomeEl.className = 'escola-list-nome';
          nomeEl.textContent = nomeSemTipo;
          info.appendChild(nomeEl);
          if (it.sigla) {
            const siglaEl = document.createElement('span');
            siglaEl.className = 'escola-list-sigla';
            siglaEl.textContent = `Sigla: ${it.sigla}`;
            info.appendChild(siglaEl);
          }
          row.appendChild(info);

          row.addEventListener('click', (e) => {
            e.stopPropagation();
            if (it.cb) {
              it.cb.checked = !it.cb.checked;
              it.cb.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });

          return row;
        };

        // Render chips for selected schools
        const renderChips = () => {
          if (!chipsArea) return;
          chipsArea.innerHTML = '';
          const selected = cached.filter(isChecked);

          if (!selected.length) {
            const emptySpan = document.createElement('span');
            emptySpan.className = 'escola-chips-empty';
            emptySpan.textContent = 'Nenhuma escola selecionada';
            chipsArea.appendChild(emptySpan);
            return;
          }

          selected.forEach((it) => {
            const chip = document.createElement('span');
            chip.className = 'escola-chip';

            if (it.tipo) {
              const badge = document.createElement('span');
              badge.className = `autocomplete-badge ${String(it.tipo).toLowerCase()}`;
              badge.textContent = it.tipo;
              chip.appendChild(badge);
            }

            const label = document.createElement('span');
            label.className = 'escola-chip-label';
            const nomeSemTipo = it.tipo ? String(it.value).replace(String(it.tipo) + ' ', '') : it.value;
            label.textContent = nomeSemTipo;
            chip.appendChild(label);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'escola-chip-remove';
            removeBtn.innerHTML = '×';
            removeBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              if (it.cb) {
                it.cb.checked = false;
                it.cb.dispatchEvent(new Event('change', { bubbles: true }));
              }
            });
            chip.appendChild(removeBtn);

            chipsArea.appendChild(chip);
          });
        };

        // Render the full list with sections
        const renderList = (filterTerm) => {
          listPanel.innerHTML = '';
          const termNorm = normalizeText(String(filterTerm || '').trim());
          const termSemEspacos = termNorm.replace(/\s+/g, '');
          const palavras = termNorm.split(/\s+/).filter(Boolean);

          // Filter items by search term
          const matchesTerm = (it) => {
            if (!termNorm) return true;
            const matchPorPalavras = palavras.length ? palavras.every(p => it.normalized.includes(p)) : true;
            const matchPorSigla = termSemEspacos ? it.siglaNormalized.includes(termSemEspacos) : true;
            const matchPorIniciais = termSemEspacos ? it.siglaNormalized.startsWith(termSemEspacos) : true;
            return matchPorPalavras || matchPorSigla || matchPorIniciais;
          };

          const selectedItems = cached.filter(it => isChecked(it) && matchesTerm(it));
          const unselectedItems = cached.filter(it => !isChecked(it) && matchesTerm(it));

          if (selectedItems.length === 0 && unselectedItems.length === 0) {
            // Empty state
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'escola-empty-state';
            emptyDiv.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <span>Nenhuma escola encontrada</span>
            `;
            listPanel.appendChild(emptyDiv);
            return;
          }

          // Selected section
          if (selectedItems.length > 0) {
            const selLabel = document.createElement('div');
            selLabel.className = 'escola-section-label';
            selLabel.innerHTML = `Selecionadas <span class="escola-section-count">${selectedItems.length}</span>`;
            listPanel.appendChild(selLabel);

            selectedItems.forEach(it => {
              listPanel.appendChild(buildListItem(it, true));
            });
          }

          // Divider
          if (selectedItems.length > 0 && unselectedItems.length > 0) {
            const divider = document.createElement('div');
            divider.className = 'escola-divider';
            listPanel.appendChild(divider);
          }

          // All schools section
          if (unselectedItems.length > 0) {
            const allLabel = document.createElement('div');
            allLabel.className = 'escola-section-label';
            allLabel.textContent = 'Todas as escolas';
            listPanel.appendChild(allLabel);

            unselectedItems.forEach(it => {
              listPanel.appendChild(buildListItem(it, false));
            });
          }
        };

        // Full re-render
        const fullRender = () => {
          renderChips();
          renderList(input.value);
        };

        // Search input handler
        input.addEventListener('input', function () {
          renderList(this.value);
          if (!isOpen) openPanel();
        });

        // Focus handler - expand list
        input.addEventListener('focus', openPanel);

        // Click on input - ensure open
        input.addEventListener('click', (e) => {
          e.stopPropagation();
          openPanel();
        });

        // Click on chips area - toggles list
        chipsArea.addEventListener('click', (e) => {
          // Don't toggle if clicking a specific chip removal (handled by its own listener)
          if (e.target.closest('.escola-chip-remove')) return;
          input.focus();
        });

        // Document click - close if outside
        document.addEventListener('click', (e) => {
          if (!componentWrapper.contains(e.target)) {
            closePanel();
          }
        });

        // Keyboard navigation
        input.addEventListener('keydown', function (e) {
          const items = Array.from(listPanel.querySelectorAll('.escola-list-item'));
          if (!items.length) return;

          let currentIdx = items.findIndex(el => el.classList.contains('active'));

          if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentIdx = Math.min(currentIdx + 1, items.length - 1);
            items.forEach(el => el.classList.remove('active'));
            items[currentIdx].classList.add('active');
            items[currentIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentIdx = Math.max(currentIdx - 1, 0);
            items.forEach(el => el.classList.remove('active'));
            items[currentIdx].classList.add('active');
            items[currentIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentIdx >= 0 && items[currentIdx]) {
              items[currentIdx].click();
            }
          }
        });

        // MutationObserver: rebuild cache when checkboxes are dynamically created
        const obs = new MutationObserver(() => {
          rebuildCache();
          fullRender();
        });
        obs.observe(container, { childList: true, subtree: true });

        // Listen for checkbox changes (event delegation on hidden container)
        container.addEventListener('change', (e) => {
          const t = e.target;
          if (t && t.matches && t.matches('input[type="checkbox"][data-filter="escola"]')) {
            fullRender();
          }
        });

        // Initial render
        rebuildCache();
        fullRender();
      }

      function setupTipoDeficienciaAutocomplete() {
        const input = document.getElementById('filterTipoDeficienciaSearch');
        const container = document.getElementById('filterTipoDeficienciaContainer');
        const list = document.getElementById('filterTipoDeficienciaAutocompleteList');
        const tagsContainer = document.getElementById('filterTipoDeficienciaSelectedTags');
        if (!input || !container || !list || !tagsContainer) return;

        if (input.dataset.bound === 'true') return;
        input.dataset.bound = 'true';

        let cached = [];
        let selectedIndex = -1;
        let lastJustSelectedValue = null;

        const DEF_BADGE_COLORS = [
          { bg: '#7c3aed', fg: '#ffffff' },
          { bg: '#2563eb', fg: '#ffffff' },
          { bg: '#059669', fg: '#ffffff' },
          { bg: '#d97706', fg: '#ffffff' },
          { bg: '#dc2626', fg: '#ffffff' },
          { bg: '#0f766e', fg: '#ffffff' },
        ];

        const hashString = (str) => {
          let h = 0;
          const s = String(str || '');
          for (let i = 0; i < s.length; i += 1) {
            h = (h * 31 + s.charCodeAt(i)) >>> 0;
          }
          return h;
        };

        const pickBadge = (value) => {
          const h = hashString(normalizeText(value || ''));
          return DEF_BADGE_COLORS[h % DEF_BADGE_COLORS.length];
        };

        const getAbbr = (value) => {
          const s = String(value || '').trim();
          if (!s) return 'D';
          const words = s.split(/\s+/).filter(Boolean);
          const abbr = words.map((w) => (w[0] || '').toUpperCase()).join('');
          return (abbr || 'D').slice(0, 2);
        };

        let closeTimer = null;

        const getAllOptions = () => {
          const cbs = Array.from(container.querySelectorAll('input.custom-checkbox[data-filter="tipoDeficiencia"]'));
          return cbs
            .map((cb) => {
              const labelEl = cb.closest('.checkbox-container')?.querySelector('.checkbox-label');
              const label = labelEl ? String(labelEl.textContent || '').trim() : String(cb.dataset.value || '').trim();
              const value = String(cb.dataset.value || label).trim();
              return {
                value,
                label,
                norm: normalizeText(label) || normalizeText(value),
                cb,
              };
            })
            .filter((o) => o.value && o.label);
        };

        const getSelectedValues = () => {
          return new Set(
            Array.from(container.querySelectorAll('input.custom-checkbox[data-filter="tipoDeficiencia"]:checked'))
              .map((cb) => String(cb.dataset.value || '').trim())
              .filter(Boolean)
          );
        };

        const closeList = () => {
          if (!list.classList.contains('show')) {
            list.classList.remove('hide');
            input.classList.remove('autocomplete-open');
            selectedIndex = -1;
            return;
          }

          list.classList.add('hide');
          list.classList.remove('show');
          input.classList.remove('autocomplete-open');
          selectedIndex = -1;

          closeTimer = window.setTimeout(() => {
            list.classList.remove('hide');
            list.style.display = 'none';
            closeTimer = null;
          }, 160);
        };

        const openList = () => {
          if (closeTimer) {
            window.clearTimeout(closeTimer);
            closeTimer = null;
          }
          list.style.display = 'block';
          list.classList.remove('hide');
          if (!list.classList.contains('show')) list.classList.add('show');
          input.classList.add('autocomplete-open');
        };

        const updateSelectedVisual = () => {
          const items = Array.from(list.querySelectorAll('.autocomplete-item'));
          items.forEach((el, idx) => {
            if (idx === selectedIndex) el.classList.add('active');
            else el.classList.remove('active');
          });
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        };

        const renderSelectedTags = () => {
          const selected = getSelectedValues();
          tagsContainer.innerHTML = '';

          if (selected.size === 0) {
            tagsContainer.innerHTML = '<span class="text-xs text-gray-500">Nenhum tipo selecionado</span>';
            return;
          }

          const opts = cached.length ? cached : getAllOptions();
          const byValue = new Map(opts.map((o) => [o.value, o]));

          Array.from(selected).forEach((val) => {
            const opt = byValue.get(val);
            const label = opt ? opt.label : val;

            const badgeCfg = pickBadge(label || val);

            const tag = document.createElement('span');
            tag.className = 'selected-tag';

            const badge = document.createElement('span');
            badge.className = 'deficiency-tag-badge';
            badge.textContent = getAbbr(label || val);
            badge.style.background = badgeCfg.bg;
            badge.style.color = badgeCfg.fg;
            if (lastJustSelectedValue && String(val) === String(lastJustSelectedValue)) {
              badge.classList.add('badge-pop');
            }
            tag.appendChild(badge);

            const text = document.createElement('span');
            text.className = 'selected-tag-label';
            text.textContent = label;
            tag.appendChild(text);

            const remove = document.createElement('button');
            remove.type = 'button';
            remove.className = 'selected-tag-remove';
            remove.textContent = '×';
            remove.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const cb = opt?.cb;
              if (!cb) return;
              remove.disabled = true;
              badge.classList.remove('badge-pop');
              badge.classList.add('badge-out');
              window.setTimeout(() => {
                cb.checked = false;
                cb.dispatchEvent(new Event('change', { bubbles: true }));
                renderSelectedTags();
                renderList(input.value);
              }, 190);
            });
            tag.appendChild(remove);
            tagsContainer.appendChild(tag);
          });

          // Evita animar em rerenders futuros
          lastJustSelectedValue = null;
        };

        const renderList = (rawQuery) => {
          const query = normalizeText(rawQuery || '').trim();
          const selected = getSelectedValues();

          cached = getAllOptions();
          let results = cached.filter((o) => !selected.has(o.value));

          // Sem texto: mostra tudo
          if (query) {
            results = results.filter((o) => (o.norm || '').includes(query));
          }

          list.innerHTML = '';
          selectedIndex = -1;

          if (!results.length) {
            list.innerHTML = '<div class="no-results">🔍 Nenhum tipo encontrado</div>';
            openList();
            return;
          }

          results.slice(0, 50).forEach((opt, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.dataset.index = String(idx);

            const label = document.createElement('div');
            label.className = 'autocomplete-item-label';
            label.textContent = opt.label;
            item.appendChild(label);

            item.addEventListener('mousedown', (e) => {
              e.preventDefault();
              const cb = opt.cb;
              if (!cb || cb.disabled) return;
              lastJustSelectedValue = opt.value;
              cb.checked = true;
              cb.dispatchEvent(new Event('change', { bubbles: true }));
              input.value = '';
              renderSelectedTags();
              renderList('');
            });

            list.appendChild(item);
          });

          openList();
        };

        input.addEventListener('input', () => {
          renderList(input.value);
        });

        input.addEventListener('focus', () => {
          renderList(input.value);
        });

        input.addEventListener('keydown', (e) => {
          const items = Array.from(list.querySelectorAll('.autocomplete-item'));
          if (!items.length) return;

          if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelectedVisual();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelectedVisual();
          } else if (e.key === 'Enter') {
            e.preventDefault();
            const el = items[selectedIndex] || items[0];
            if (el) el.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
          } else if (e.key === 'Escape') {
            closeList();
          }
        });

        document.addEventListener('click', (e) => {
          const t = e.target;
          if (t === input || (t && t.closest && t.closest('#filterTipoDeficienciaAutocompleteList'))) return;
          closeList();
        });

        const mo = new MutationObserver(() => {
          cached = getAllOptions();
          renderSelectedTags();
        });
        mo.observe(container, { childList: true, subtree: true });

        cached = getAllOptions();
        renderSelectedTags();
      }

      // Obtém valores selecionados dos checkboxes
      function getCheckedValues(filterName) {
        const checkboxes = document.querySelectorAll(`input[data-filter="${filterName}"]:checked`);
        return Array.from(checkboxes).map(cb => cb.dataset.value);
      }

      // Atualiza o badge de contagem
      function updateBadge(filterName) {
        const count = getCheckedValues(filterName).length;
        const badge = document.getElementById(`badge-${filterName}`);

        // Verifica se o badge existe antes de tentar acessar suas propriedades
        if (!badge) {
          console.warn(`[updateBadge] Badge não encontrado para filtro: ${filterName}`);
          return;
        }

        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }

      // Atualiza badge para filtro TI (select ao invés de checkboxes)
      function updateBadgeTI() {
        const selectTI = document.getElementById('filterTI');
        const badge = document.getElementById('badge-ti');

        if (selectTI && selectTI.value && selectTI.value !== '') {
          badge.textContent = '1';
          badge.classList.remove('hidden');
        } else if (badge) {
          badge.classList.add('hidden');
        }
      }

      function ensureFilterCardBadges() {
        const groups = document.querySelectorAll('details.filter-group[data-mode="panel"]');
        groups.forEach((d) => {
          const summary = d.querySelector('summary');
          if (!summary) return;
          const existing = summary.querySelector('.filter-card-badge');
          if (existing) {
            // Normaliza caso exista um badge antigo com classes grandes
            existing.className = 'filter-card-badge';
            existing.style.pointerEvents = 'none';
            if (!existing.textContent) existing.textContent = '0';
            return;
          }

          const badge = document.createElement('span');
          badge.className = 'filter-card-badge';
          badge.textContent = '0';
          badge.style.display = 'none';

          summary.appendChild(badge);
        });
      }

      function updateFilterCardBadges() {
        ensureFilterCardBadges();
        const groups = document.querySelectorAll('details.filter-group[data-mode="panel"]');

        const isCountable = (el) => {
          if (!el) return false;
          if (el.disabled) return false;
          // Não conta campos em seções condicionais escondidas
          if (el.closest('.hidden')) return false;
          return true;
        };

        groups.forEach((d) => {
          const content = d.__panelContent || d.querySelector('.filter-group-content');
          const summary = d.querySelector('summary');
          const badge = summary ? summary.querySelector('.filter-card-badge') : null;
          if (!content || !badge) return;

          let count = 0;
          const fields = content.querySelectorAll('input, select, textarea');

          fields.forEach((el) => {
            if (!isCountable(el)) return;

            // Ignorar campo de busca do autocomplete (não é filtro aplicado)
            if (el.id === 'filterEscolaSearch') return;

            const tag = (el.tagName || '').toLowerCase();
            if (tag === 'select') {
              if (String(el.value || '').trim() !== '') count += 1;
              return;
            }

            const type = String(el.type || '').toLowerCase();
            if (type === 'checkbox' || type === 'radio') {
              if (el.checked) count += 1;
              return;
            }

            // text/number/date/etc
            if (String(el.value || '').trim() !== '') count += 1;
          });

          if (count > 0) {
            badge.textContent = String(count);
            badge.style.display = 'inline-flex';
          } else {
            badge.style.display = 'none';
          }
        });
      }

      // Formata data para exibição (dd/mm/aaaa)
      function formatDate(value) {
        if (!value || value === '') return null; // Retorna null para valores vazios
        const date = parseDateCell(value);
        if (!date) return value; // Se não conseguir parsear, retorna o valor original

        const dia = String(date.getDate()).padStart(2, '0');
        const mes = String(date.getMonth() + 1).padStart(2, '0');
        const ano = date.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }

      // Converte célula de data (dd/mm/aaaa, número serial do Excel, etc.) em Date
      function parseDateCell(value) {
        const str = String(value || '').trim();
        if (!str) return null;

        // IMPORTANTE: Formato Date(YYYY,M,D) do Google Sheets
        // O mês já vem base-0 (0=janeiro, 11=dezembro)
        const dateMatch = str.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
        if (dateMatch) {
          const ano = parseInt(dateMatch[1], 10);
          const mes = parseInt(dateMatch[2], 10); // Já está em base-0
          const dia = parseInt(dateMatch[3], 10);
          return new Date(ano, mes, dia);
        }

        // Tenta formato dd/mm/aaaa ou dd-mm-aaaa (brasileiro)
        const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
        if (m) {
          let dia = parseInt(m[1], 10);
          let mes = parseInt(m[2], 10) - 1;
          let ano = parseInt(m[3], 10);
          if (ano < 100) ano += 2000;

          // Valida se a data é válida
          const d = new Date(ano, mes, dia);
          if (d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia) {
            return d;
          }
          return null;
        }

        // Tenta como número serial do Excel (ex: 45803)
        const num = parseFloat(str);
        if (!isNaN(num) && num > 1 && num < 100000) {
          // Excel conta dias desde 01/01/1900
          // Mas Excel tem um bug: considera 1900 como ano bissexto (não é)
          // Então para datas >= 01/03/1900, subtraímos 1 dia extra
          const excelEpoch = new Date(1899, 11, 30); // 30/12/1899
          const days = num >= 60 ? num - 1 : num; // Corrige bug do Excel
          const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
          return date;
        }

        // Tenta parse direto (formato ISO ou outros)
        const d = new Date(str);
        return isNaN(d.getTime()) ? null : d;
      }

      // ==============================
      // Inicialização da página
      // ==============================
      window.addEventListener('load', function () {
        // Estado global de atualização (compartilhado via localStorage)
        window.EstadoBotaoAtualizacaoPainel = false;

        // Event listeners do modal
        const modal = document.getElementById('modal-detalhes');

        // Fechar modal ao clicar fora
        if (modal) {
          modal.addEventListener('click', function (e) {
            if (e.target === modal) {
              fecharModalDetalhes();
            }
          });
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            if (modal && modal.classList.contains('visible')) {
              fecharModalDetalhes();
            }
          }
        });
        // Ao clicar em Atualizar Dados, atualiza estado global, invalida cache e carrega dados
        // Ao clicar em Atualizar Dados, atualiza estado global, invalida cache e carrega dados
        const btnAtualizar = document.getElementById('btnAtualizar');
        if (btnAtualizar) {
          btnAtualizar.addEventListener('click', function () {
            try {
              window.EstadoBotaoAtualizacaoPainel = true;
              localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
                state: true,
                timestamp: Date.now(),
                source: 'painel-casos'
              }));
              console.log('[Painel] 🧭 Estado global definido: Atualizar Dados clicado');
            } catch (e) {
              console.warn('[Painel] ⚠️ Erro ao definir estado global:', e);
            }

            // Garante limpeza de cache e recarrega notificações
            if (typeof limparCacheERecarregarNotificacoes === 'function') {
              limparCacheERecarregarNotificacoes();
            }
            // Comportamento normal do botão
            // Passa true para indicar que é uma ação explícita do usuário
            if (typeof carregarDadosPlanilha === 'function') {
              carregarDadosPlanilha(true);
            }
          });
        }

        // Event listeners de paginação
        document.getElementById('btnPrimeiraPagina').addEventListener('click', () => irParaPagina(1));
        document.getElementById('btnPaginaAnterior').addEventListener('click', () => irParaPagina(paginaAtual - 1));
        document.getElementById('btnProximaPagina').addEventListener('click', () => irParaPagina(paginaAtual + 1));
        document.getElementById('btnUltimaPagina').addEventListener('click', () => irParaPagina(totalPaginas));
        document.getElementById('registrosPorPaginaSelect').addEventListener('change', alterarRegistrosPorPagina);

        // Event listeners de exportação e dashboard
        const btnExportarCSV = document.getElementById('btnExportarCSV');
        const btnExportarExcel = document.getElementById('btnExportarExcel');
        const btnExportarPDF = document.getElementById('btnExportarPDF');
        const btnAtualizarKPIs = document.getElementById('btnAtualizarKPIs');

        // Wrapper para atualizarKPIs que limpa cache e recarrega notificações
        function atualizarKPIsComLimpeza() {
          // Limpa cache e recarrega notificações antes de atualizar KPIs
          if (typeof limparCacheERecarregarNotificacoes === 'function') {
            limparCacheERecarregarNotificacoes();
          }
          // Chama a função original de atualizar KPIs
          if (typeof atualizarKPIs === 'function') {
            atualizarKPIs();
          }
        }

        if (btnExportarCSV) btnExportarCSV.addEventListener('click', exportarCSV);
        if (btnExportarExcel) btnExportarExcel.addEventListener('click', exportarExcel);
        if (btnExportarPDF) btnExportarPDF.addEventListener('click', exportarPDF);
        if (btnAtualizarKPIs) btnAtualizarKPIs.addEventListener('click', atualizarKPIsComLimpeza);

        // Carrega os dados automaticamente ao iniciar
        carregarDadosPlanilha();
      });

      // Abre seção específica do filtro
      function openFilterSection(filterName) {
        const box = document.getElementById('quickAdvancedFiltersBox');
        if (!box) return;

        const map = {
          periodo: { group: 'filterGroupPeriodo', target: 'filterDataInicio' },
          perfilEstudante: { group: 'filterGroupPerfilEstudante', target: 'filterPCD' },
          contextoEscolar: { group: 'filterGroupContextoEscolar', target: 'filterFonteInformada' },
          autoriaAgente: { group: 'filterGroupAutoriaAgente', target: 'filterMembroFamiliar' },
          violencia: { group: 'filterGroupViolencia', target: 'filterTipoViolenciaContainer' },
          encaminhamento: { group: 'filterGroupEncaminhamentos', target: 'filterEncaminhamentoContainer' },

          // atalhos antigos
          regiao: { group: 'filterGroupContextoEscolar', target: 'filterRegiaoContainer' },
          tipoInstituicao: { group: 'filterGroupContextoEscolar', target: 'filterTipoInstituicaoContainer' },
          escola: { group: 'filterGroupContextoEscolar', target: 'filterEscolaSearch' },
          ti: { group: 'filterGroupContextoEscolar', target: 'filterTI' },
          tipoViolencia: { group: 'filterGroupViolencia', target: 'filterTipoViolenciaContainer' },
          violenciaInstitucional: { group: 'filterGroupViolencia', target: 'section-violenciaInstitucional' },
          raca: { group: 'filterGroupPerfilEstudante', target: 'filterRacaContainer' },
          genero: { group: 'filterGroupPerfilEstudante', target: 'filterGeneroContainer' },
          orientacao: { group: 'filterGroupPerfilEstudante', target: 'filterOrientacaoContainer' },
          tipoDeficiencia: { group: 'filterGroupPerfilEstudante', target: 'section-tipoDeficiencia' },
        };

        const conf = map[filterName] || null;
        if (!conf) return;

        const details = document.getElementById(conf.group);
        if (details && !details.hasAttribute('open')) {
          details.setAttribute('open', '');
          details.dataset.expanded = 'true';
          const content = details.querySelector('.filter-group-content');
          if (content) {
            content.style.overflow = 'visible';
            content.style.height = '';
          }
        }

        const target = document.getElementById(conf.target);
        if (target) {
          setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        }
      }

      // Busca nome de coluna
      function findColumn(data, possibleNames, excludeTerms = []) {
        if (!data || data.length === 0) return null;
        const keys = Object.keys(data[0]);

        for (const possible of possibleNames) {
          const found = keys.find(k => {
            const kLower = k.toLowerCase().trim();
            const pLower = possible.toLowerCase().trim();

            // Verifica exclusões primeiro
            if (excludeTerms && excludeTerms.length > 0) {
              if (excludeTerms.some(term => kLower.includes(term.toLowerCase()))) {
                return false;
              }
            }

            // Busca exata ou que contenha (mas não ao contrário para evitar "Idade" pegar "Identidade")
            return kLower === pLower || kLower.includes(pLower);
          });
          if (found) return found;
        }
        return null;
      }

      // ==============================
      // Carregamento de dados do Google Sheets via JSONP
      // ==============================



      // ========================================
      // SISTEMA DE MÁQUINA DE ESTADOS PARA NOTIFICAÇÕES
      // Garante: Toast SEMPRE aparece antes do Alerta (nunca simultâneo)
      // ========================================

      const NOTIF_STATES = {
        IDLE: 'idle',                           // Nenhuma notificação visível
        TOAST_SHOWING: 'toast_showing',         // Toast está visível/animando
        TOAST_EXITING: 'toast_exiting',         // Toast saindo (bloqueio ao alerta)
        ALERT_SHOWING: 'alert_showing',         // Alerta está visível
        ALERT_EXITING: 'alert_exiting'          // Alerta saindo
      };

      // Flag global: indica que o usuário iniciou uma atualização manual
      // a partir do popup azul de nova notificação.
      // Esta flag é usada pelo ChangeDetector e pelos gerenciadores de alerta/toast
      // para suprimir qualquer alerta visual redundante nesse ciclo.
      window.atualizacaoDisparadaPeloUsuario = window.atualizacaoDisparadaPeloUsuario || false;
      // Alias compatível com a nomenclatura sugerida na documentação
      window.atualizacaoIniciadaViaPopup = window.atualizacaoDisparadaPeloUsuario;

      const NotificationManager = {
        state: NOTIF_STATES.IDLE,
        hasStoredNotif: false,
        timeoutMap: {},

        // ===== ESTADO MÁQUINA =====
        setState(newState) {
          if (newState === this.state) return;
          console.log(`[NotifState] ${this.state} → ${newState}`);
          this.state = newState;
        },

        // ===== VERIFICAÇÕES DE SEGURANÇA =====
        canShowToast() {
          return this.state === NOTIF_STATES.IDLE;
        },

        canShowAlert() {
          // Alerta SÓ pode aparecer se:
          // 1. Estado é IDLE (nenhuma notificação ativa)
          // 2. Toast NÃO está visível
          return this.state === NOTIF_STATES.IDLE &&
            !this.isToastVisible();
        },

        isToastVisible() {
          const toast = document.getElementById('notificacao-nova-notificacao');
          if (!toast) return false;
          return toast.style.display !== 'none' &&
            !toast.classList.contains('notificacao-exit');
        },

        // ===== MOSTRAR TOAST =====
        showToast() {
          // Rejeita se não está em IDLE
          if (!this.canShowToast()) {
            console.warn('[NotifManager] ❌ Toast rejeitado: estado não é IDLE');
            return false;
          }

          this.setState(NOTIF_STATES.TOAST_SHOWING);
          this.hasStoredNotif = true;

          // Bloqueia o alerta (se existir)
          const alerta = document.getElementById('alerta-novas-notificacoes');
          if (alerta) {
            alerta.classList.add('toast-blocking');
          }

          // Salva flag no localStorage (para recargas)
          try {
            localStorage.setItem('naam_new_notif_flag', '1');
          } catch (e) {
            console.warn('[NotifManager] Erro ao salvar flag:', e);
          }

          console.log('[NotifManager] ✅ Toast: MOSTRANDO');
          return true;
        },

        // ===== INICIAR SAÍDA DO TOAST =====
        startToastExit() {
          if (this.state !== NOTIF_STATES.TOAST_SHOWING) {
            console.warn('[NotifManager] ❌ Toast exit rejeitado: estado não é TOAST_SHOWING');
            return;
          }

          this.setState(NOTIF_STATES.TOAST_EXITING);
          console.log('[NotifManager] ⏹️ Toast: SAINDO (alerta BLOQUEADO)');

          // Libera o alerta após a animação (400ms)
          this.clearTimeout('toastExit');
          this.timeoutMap['toastExit'] = setTimeout(() => {
            this.completeToastExit();
          }, 400);
        },

        // ===== COMPLETAR SAÍDA DO TOAST =====
        completeToastExit() {
          this.setState(NOTIF_STATES.IDLE);
          console.log('[NotifManager] ✅ Toast: REMOVIDO - liberando Alerta');

          // Desbloqueia o alerta
          const alerta = document.getElementById('alerta-novas-notificacoes');
          if (alerta) {
            alerta.classList.remove('toast-blocking');
          }

          // Agora sim, mostra o alerta se foi marcado
          if (this.hasStoredNotif) {
            setTimeout(() => this.showAlert(), 50);
          }
        },

        // ===== MOSTRAR ALERTA =====
        showAlert() {
          // SEGURANÇA: Rejeita se toast ainda está visível
          if (!this.canShowAlert()) {
            console.warn('[NotifManager] ❌ Alerta rejeitado: Toast ainda está ativo ou estado inválido');
            return false;
          }
          // Bloqueio global: se atualização foi iniciada via popup azul,
          // não exibir alerta e remover qualquer instância existente do DOM
          if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
            console.warn('[NotifManager] 🚫 Alerta bloqueado: atualização iniciada via popup');
            const alertaBloquear = document.getElementById('alerta-novas-notificacoes');
            if (alertaBloquear) alertaBloquear.remove();
            return false;
          }

          const alerta = document.getElementById('alerta-novas-notificacoes');
          if (!alerta) return false;

          this.setState(NOTIF_STATES.ALERT_SHOWING);

          // Animar entrada do alerta
          alerta.style.display = 'flex';
          void alerta.offsetWidth; // Força reflow
          alerta.classList.remove('hide');
          alerta.classList.add('show');

          // ✨ Ativa animação de pulsar no botão de atualizar
          ativarPulseBotao('btnAtualizar');

          console.log('[NotifManager] ✅ Alerta: MOSTRANDO');
          return true;
        },

        // ===== INICIAR SAÍDA DO ALERTA =====
        startAlertExit() {
          if (this.state !== NOTIF_STATES.ALERT_SHOWING) {
            console.warn('[NotifManager] ⚠️ Alert exit: estado não é ALERT_SHOWING, ignorando');
            return;
          }

          this.setState(NOTIF_STATES.ALERT_EXITING);
          console.log('[NotifManager] ⏹️ Alerta: SAINDO');

          const alerta = document.getElementById('alerta-novas-notificacoes');
          if (alerta) {
            alerta.classList.remove('show');
            alerta.classList.add('hide');
          }

          // Completa saída após animação
          this.clearTimeout('alertExit');
          this.timeoutMap['alertExit'] = setTimeout(() => {
            this.completeAlertExit();
          }, 400);
        },

        // ===== COMPLETAR SAÍDA DO ALERTA =====
        completeAlertExit() {
          this.setState(NOTIF_STATES.IDLE);
          this.hasStoredNotif = false;

          const alerta = document.getElementById('alerta-novas-notificacoes');
          if (alerta) {
            // Se a saída foi disparada em um fluxo iniciado via popup azul,
            // removemos o alerta definitivamente do DOM para não deixar resíduos.
            if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
              alerta.remove();
            } else {
              alerta.style.display = 'none';
              alerta.classList.remove('show', 'hide');
            }
          }

          // ✨ Remove animação de pulsar do botão de atualizar
          desativarPulseBotao('btnAtualizar');

          // Limpa localStorage
          try {
            localStorage.removeItem('naam_new_notif_flag');
          } catch (e) {
            console.warn('[NotifManager] Erro ao limpar flag:', e);
          }

          console.log('[NotifManager] ✅ Sistema: IDLE novamente');
        },

        // ===== HELPERS =====
        clearTimeout(key) {
          if (this.timeoutMap[key]) {
            clearTimeout(this.timeoutMap[key]);
            delete this.timeoutMap[key];
          }
        },

        cleanup() {
          Object.keys(this.timeoutMap).forEach(key => this.clearTimeout(key));
          this.state = NOTIF_STATES.IDLE;
        }
      };

      // ID da planilha (extraído do link de edição)
      // Usando configuração centralizada (config.js)
      const SPREADSHEET_ID = (typeof CONFIG !== 'undefined' && CONFIG.SPREADSHEET_ID)
        ? CONFIG.SPREADSHEET_ID
        : '1A6a2ZLiHegPJBDpE3YLPGsa8RXVRLjpkXmKdauSlb9Y';

      function carregarDadosPlanilha(isUserAction = false) {
        // Armazena flag para uso no callback de sucesso
        window._carregarDadosPlanilhaIsUserAction = isUserAction;

        // ✨ Remove alerta e animação quando usuário clica para carregar
        // (indica que ele viu a notificação e está atualizando)
        if (typeof NotificationManager !== 'undefined' && NotificationManager.state === 'alert_showing') {
          NotificationManager.startAlertExit();
        }

        // Remove o alerta vermelho de notificações novas
        const alertaExistente = document.getElementById('alerta-novas-notificacoes');
        if (alertaExistente) {
          alertaExistente.remove();
          console.log('[Painel] 🔴 Alerta de notificações removido do DOM');
        }

        // Remove animação do botão
        desativarPulseBotao('btnAtualizar');

        // ✨ SINCRONIZAÇÃO: Só marca como atualizado se for uma ação explícita do usuário
        // (não marca se for chamada automaticamente durante navegação ou carregamento inicial)
        if (isUserAction) {
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
          if (ultimoIdSalvo) {
            const notifId = parseInt(ultimoIdSalvo, 10);
            if (typeof marcarPopupAzulAtualizado === 'function') {
              marcarPopupAzulAtualizado(notifId);
            }
            // Atualiza último ID sincronizado imediatamente
            try {
              localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
              console.log('[Sync] ✅ Estado sincronizado limpo e último ID atualizado após clique no botão Atualizar Dados');
              // Zera contador global de novas notificações
              localStorage.removeItem('naam_new_notif_count');
            } catch (e) {
              console.warn('[Sync] ⚠️ Erro ao atualizar estado sincronizado:', e);
            }
          }
        }

        // Limpa flag do localStorage
        try {
          localStorage.removeItem('naam_new_notif_flag');
        } catch (e) {
          console.warn('[carregarDadosPlanilha] Erro ao limpar flag:', e);
        }

        // Limpa cache e recarrega notificações antes de carregar dados
        if (typeof limparCacheERecarregarNotificacoes === 'function') {
          limparCacheERecarregarNotificacoes();
        }

        // Validação: Verifica se SPREADSHEET_ID está configurado
        if (!SPREADSHEET_ID || SPREADSHEET_ID.includes('SEU_ID_DA_PLANILHA_AQUI') || SPREADSHEET_ID.trim() === '') {
          updateUploadStatus('error', '⚠️ Configure SPREADSHEET_ID em config.js para carregar dados da planilha');
          console.error('❌ SPREADSHEET_ID não configurado em config.js');
          return;
        }

        updateUploadStatus('loading', '⏳ Carregando dados da planilha...');

        console.log('🔄 Buscando dados via JSONP...');

        // Remove script antigo se existir
        const oldScript = document.getElementById('jsonp-script');
        if (oldScript) {
          oldScript.remove();
        }

        // Timestamp para evitar cache
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 15);

        // Cria objeto global google.visualization para interceptar a resposta
        if (!window.google) {
          window.google = {};
        }
        if (!window.google.visualization) {
          window.google.visualization = {};
        }
        if (!window.google.visualization.Query) {
          window.google.visualization.Query = {};
        }

        // Define função que receberá os dados
        window.google.visualization.Query.setResponse = function (response) {
          try {
            console.log('✅ Dados recebidos via JSONP');

            if (!response || !response.table || !response.table.rows) {
              updateUploadStatus('error', '❌ Formato de resposta inválido');
              return;
            }

            // Extrai cabeçalhos
            const headers = response.table.cols.map(col => col.label || '');

            // Converte linhas para objetos
            const data = response.table.rows.map(row => {
              const obj = {};
              row.c.forEach((cell, index) => {
                const header = headers[index];
                if (header) {
                  obj[header] = cell && cell.v !== null && cell.v !== undefined ? cell.v : '';
                }
              });
              return obj;
            });

            console.log('📊 Total de registros:', data.length);

            // Limpa dados anteriores
            originalData = [];
            filteredData = [];
            window.originalData = [];
            window.filteredData = [];

            processLoadedData(data);

            // ✨ SINCRONIZAÇÃO: Após carregar dados com sucesso, atualiza último ID sincronizado
            // Só atualiza se foi uma ação explícita do usuário (isUserAction = true)
            // Isso é controlado pela flag window._carregarDadosPlanilhaIsUserAction
            setTimeout(() => {
              if (window._carregarDadosPlanilhaIsUserAction) {
                const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
                if (ultimoIdSalvo) {
                  const notifId = parseInt(ultimoIdSalvo, 10);
                  try {
                    localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
                    console.log('[Sync] ✅ Último ID sincronizado atualizado após carregar dados (ação do usuário):', notifId);
                  } catch (e) {
                    console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
                  }
                }
                // Limpa a flag
                window._carregarDadosPlanilhaIsUserAction = false;
              }
            }, 1000);

          } catch (error) {
            console.error('❌ Erro ao processar:', error);
            updateUploadStatus('error', '❌ Erro ao processar dados: ' + error.message);
          }
        };

        // Cria script tag para JSONP (não usa fetch, não precisa de proxy)
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&_=${timestamp}&r=${random}`;

        script.onerror = function () {
          console.error('❌ Erro ao carregar script');
          updateUploadStatus('error', '❌ Erro ao conectar com Google Sheets. Verifique se a planilha está compartilhada como "Qualquer pessoa com o link pode visualizar"');
        };

        document.head.appendChild(script);
      }

      function processLoadedData(data) {
        if (!data || data.length === 0) {
          updateUploadStatus('error', '❌ Arquivo vazio ou sem dados válidos');
          return;
        }

        originalData = data;
        filteredData = [...data];

        // Atualiza variáveis globais para dashboard-stats.js
        window.originalData = originalData;
        window.filteredData = filteredData;

        // Mapeia colunas - Atualizado para novo cabeçalho
        columnNames = {
          // Criança/Estudante
          crianca: findColumn(data, ['criança/ estudante', 'crianca/ estudante', 'criança/estudante', 'crianca/estudante', 'criança', 'crianca', 'estud']),

          // Data da NT
          data: findColumn(data, ['data da nt', 'data nt', 'data da', 'data', 'dt']),

          // Idade
          idade: findColumn(data, ['idade']),

          // Identidade de Gênero
          genero: findColumn(data, ['identidade de gênero', 'identidade de genero', 'gênero', 'genero', 'sexo']),

          // É PCD/tem Transtorno?
          pcd: findColumn(data, ['é pcd/tem transtorno', 'e pcd/tem transtorno', 'pcd/tem transtorno', 'pcd', 'deficiência', 'deficiencia', 'transtorno']),

          // Qual o Transtorno?
          detalhePCD: findColumn(data, [
            'qual o transtorno',
            'qual transtorno',
            'transtorno',
            'detalhamento',
            'detalhamento pcd',
            'detalhamento transtorno',
            'tipo de deficiencia',
            'tipo de deficiência',
            'tipo de transtorno',
            'detalhamento de pcd',
            'detalhamento de transtorno'
          ]),

          // Raça/Cor
          raca: findColumn(data, ['raça/cor', 'raca/cor', 'raça', 'raca', 'cor']),

          // Qual a Orientação Sexual?
          orientacaoSexual: findColumn(data, ['qual a orientação sexual', 'qual a orientacao sexual', 'orientação sexual', 'orientacao sexual', 'orientação', 'orientacao']),

          // Tipo de Violência
          tipo: findColumn(data, ['tipo de violência', 'tipo de violencia', 'tipo']),

          // Tipo de Violência Institucional (coluna K)
          // OBS: Aceita tanto o novo cabeçalho quanto o antigo ("motivação da violência"),
          // mas SEMPRE trata essa coluna como detalhamento da violência institucional.
          tipoViolenciaInstitucional: findColumn(data, [
            // Novos nomes esperados
            'tipo de violência institucional',
            'tipo de violencia institucional',
            'violencia institucional',
            'violência institucional',
            'tipo violencia institucional',
            // Nomes antigos reaproveitados (motivação da violência)
            'qual a motivação da violencia',
            'qual a motivacao da violencia',
            'motivação da violencia',
            'motivacao da violencia',
            'motivação',
            'motivacao'
          ]),

          // Encaminhamento
          encaminhamento: findColumn(data, ['encaminhamento']),

          // CMEI/EMEF
          escola: findColumn(data, ['cmei/emef', 'cmei / emef', 'cmei', 'emef', 'escola']),

          // Região
          regiao: findColumn(data, ['região', 'regiao']),

          // Responsável pelo Registro
          responsavel: findColumn(data, ['responsável pelo registro', 'responsavel pelo registro', 'responsável', 'responsavel']),

          // fonte informadores foi a escola?
          fonteInformada: findColumn(data, ['fonte informadores foi a escola', 'fonte informadora foi a escola', 'fonte informada', 'fonte']),

          // violência identificada pela escola ocorrida na escola (Exclui "não")
          violenciaEscolaOcorreu: findColumn(data, ['violência identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida'], ['não', 'nao']),

          // Algum profissional da escola foi autor da violência
          profissionalAutor: findColumn(data, ['algum profissional da escola foi autor da violência', 'algum profissional da escola foi autor', 'profissional da escola foi autor', 'profissional autor']),

          // Album estudante foi autor da violência?? (Algum)
          estudanteAutor: findColumn(data, ['album estudante foi autor da violência', 'algum estudante foi autor da violência', 'algum estudante foi autor', 'estudante foi autor', 'estudante autor']),

          // violência identificada pela escola não ocorrida na escola
          violenciaNaoEscola: findColumn(data, ['violência identificada pela escola não ocorrida na escola', 'violencia identificada pela escola nao ocorrida na escola', 'violência identificada pela escola não ocorrida', 'violencia nao ocorrida']),

          // ocorreu na escola? 1.1 (Exclui "não" para não pegar a pergunta inversa)
          ocorreu: findColumn(data, ['ocorreu na escola? 1.1', 'ocorreu na escola', 'ocorreu'], ['não', 'nao']),

          // violência informada a escola por qualquer um dos agentes que a compõe 1.2
          violenciaInformada: findColumn(data, ['violência informada a escola por qualquer um dos agentes que a compõe', 'violencia informada a escola', 'violência informada à escola', 'violencia informada', 'violência informada']),

          // Estudo de Caso
          estudoCaso: findColumn(data, [
            'foi realizado estudo de caso',
            'foi realizado estudo de caso?',
            'estudo de caso',
            'estudo caso',
            'estudo caso?',
            'estudo'
          ])
          ,
          // Foi um membro familiar?
          foiMembroFamiliar: findColumn(data, [
            'foi um membro familiar?',
            'foi um membro familiar',
            'membro familiar',
            'foi membro familiar',
            'membro da família',
            'membro da familia',
            'familiar',
            'foi familiar'
          ])
        };

        // Debug essencial (reduzido)
        console.log('Todas as colunas do primeiro registro:', Object.keys(data[0]));
        console.log('Mapeamento Ocorreu na Escola:', {
          ocorreu: columnNames.ocorreu,
          violenciaEscolaOcorreu: columnNames.violenciaEscolaOcorreu,
          violenciaNaoEscola: columnNames.violenciaNaoEscola
        });

        if (columnNames.genero && data.length > 0) {
          console.log('Exemplo de gênero (primeiro registro):', data[0][columnNames.genero]);
          console.log('Exemplo de gênero (segundo registro):', data[1] ? data[1][columnNames.genero] : 'N/A');
          console.log('Exemplo de gênero (terceiro registro):', data[2] ? data[2][columnNames.genero] : 'N/A');
        }
        if (columnNames.detalhePCD && data.length > 0) {
          console.log('Exemplo de detalhePCD (primeiro registro):', data[0][columnNames.detalhePCD]);
          console.log('Exemplo de detalhePCD (segundo registro):', data[1] ? data[1][columnNames.detalhePCD] : 'N/A');
          console.log('Exemplo de detalhePCD (terceiro registro):', data[2] ? data[2][columnNames.detalhePCD] : 'N/A');
        }

        // Verifica se está pegando a coluna errada
        if (columnNames.genero === 'Idade') {
          console.warn('⚠️ ERRO: Gênero está mapeado para coluna Idade!');
          // Tenta encontrar pela letra da coluna
          const primeiroRegistro = data[0];
          const colunas = Object.keys(primeiroRegistro);
          console.log('Colunas disponíveis:', colunas);

          // Procura coluna que contenha apenas M ou F
          for (const col of colunas) {
            const valores = data.slice(0, 10).map(row => String(row[col] || '').trim().toUpperCase());
            const todosMouF = valores.every(v => v === '' || v === 'M' || v === 'F');
            if (todosMouF && valores.some(v => v === 'M' || v === 'F')) {
              console.log(`✓ Coluna candidata para gênero: "${col}" - valores:`, valores);
            }
          }
        }

        console.log('=== FIM DEBUG ===');

        // Atualiza variáveis globais para dashboard-stats.js
        window.columnNames = columnNames;

        updateUploadStatus('success', `✅ Arquivo carregado – ${data.length} registros`);

        initializeFilters(data);
        populateTipoDeficienciaList(data); // Preenche lista de deficiências padronizada

        document.getElementById('filtersSection').classList.remove('hidden');

        document.getElementById('chartsSection').classList.remove('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        document.getElementById('dashboardExecutivo').classList.remove('hidden');

        // Resetar para primeira página ao carregar dados
        paginaAtual = 1;

        renderStats(filteredData);
        renderCharts(filteredData);
        renderTable(filteredData);

        // Atualiza KPIs do Dashboard Executivo
        setTimeout(() => {
          if (typeof atualizarKPIs === 'function') {
            atualizarKPIs();
          }
        }, 500);

        // Configura botão de atualização manual
        const btnUpdate = document.getElementById('btnAtualizarKPIs');
        if (btnUpdate) {
          btnUpdate.onclick = function () {
            if (typeof atualizarKPIs === 'function') {
              atualizarKPIs();
              // Feedback visual simples
              const originalText = this.innerHTML;
              this.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Atualizando...';
              setTimeout(() => {
                this.innerHTML = originalText;
              }, 800);
            }
          };
        }
      }

      // ==============================
      // Atualização dos Cards de Métricas (Novo Design)
      // ==============================


      function updateUploadStatus(type, message) {
        const statusDiv = document.getElementById('uploadStatus');
        if (!statusDiv) {
          console.warn('[updateUploadStatus] Element #uploadStatus not found. Message:', message);
          return;
        }
        statusDiv.textContent = message;
        statusDiv.className = 'p-4 rounded-md';

        if (type === 'loading') {
          statusDiv.classList.add('bg-blue-50', 'text-blue-700');
        } else if (type === 'success') {
          statusDiv.classList.add('bg-green-50', 'text-green-700');
        } else if (type === 'error') {
          statusDiv.classList.add('bg-red-50', 'text-red-700');
        } else {
          statusDiv.classList.add('bg-gray-50', 'text-gray-600');
        }
      }

      // ==============================
      // Filtros
      // ==============================
      // ==============================
      // Funções Auxiliares Genéricas e de Filtros
      // ==============================
      function normalizeText(str) {
        if (!str) return '';
        return String(str)
          .normalize('NFD') // Normaliza caracteres Unicode (remove acentos)
          .replace(/[\u0300-\u036f]/g, '') // Remove diacríticos
          .toLowerCase()
          .trim();
      }

      function getTipoInstituicao(nomeEscola) {
        if (!nomeEscola) return null;

        // Refatorado para usar metadados reais
        if (typeof window.NAVMEscolasTecnico !== 'undefined') {
          // Prioridade para detecção de EJA via flag
          if (window.NAVMEscolasTecnico.isEJA(nomeEscola)) return 'EJA';

          const tipo = window.NAVMEscolasTecnico.getTipoInstituicaoBySigla(nomeEscola);
          if (tipo) return tipo;
        }

        // Fallback legado (parsing de string)
        const nome = String(nomeEscola).toUpperCase();
        if (nome.includes('EJA')) return 'EJA'; // Garante que EJA seja capturado no fallback
        if (nome.includes('CMEI')) return 'CMEI';
        if (nome.includes('EMEF')) return 'EMEF';
        return null;
      }

      function isTempoIntegral(nomeEscola) {
        if (typeof window.NAVMEscolasTecnico !== 'undefined') {
          return window.NAVMEscolasTecnico.isTempoIntegral(nomeEscola);
        }
        // Fallback legado
        if (!nomeEscola) return false;
        return String(nomeEscola).toUpperCase().includes(' TI') || String(nomeEscola).toUpperCase().endsWith('TI');
      }

      function getCheckedValues(groupName) {
        const checkboxes = document.querySelectorAll(`input[data-filter="${groupName}"]:checked`);
        return Array.from(checkboxes).map(cb => normalizeText(cb.value));
      }

      function buildNormalizedOptions(columnName, data) {
        const valores = new Set();
        data.forEach(row => {
          const val = row[columnName];
          if (val) {
            // Suporta vírgula e barra como separadores (Fixed: user request)
            const parts = String(val).split(/[,/]/).map(s => s.trim()).filter(s => s);
            parts.forEach(p => valores.add(p));
          }
        });
        return Array.from(valores).sort((a, b) => a.localeCompare(b));
      }

      function buildNormalizedOptionsTipoViolencia(columnName, data) {
        const valores = new Set();
        data.forEach(row => {
          const val = row[columnName];
          if (val) {
            // Não separa por barra para manter tipos compostos
            const parts = String(val).split(',').map(s => s.trim()).filter(s => s);
            parts.forEach(p => valores.add(p));
          }
        });
        return Array.from(valores).sort((a, b) => a.localeCompare(b));
      }

      function buildGeneroOptions(data) {
        const valores = new Set();
        data.forEach(row => {
          const val = row[columnNames.genero];
          if (val) {
            const v = String(val).trim().toUpperCase();
            if (v === 'M' || v === 'MASCULINO') valores.add('Masculino');
            else if (v === 'F' || v === 'FEMININO') valores.add('Feminino');
            else if (v === 'IGNORADO') { } // Ignore 'Ignorado'
            else valores.add(val);
          }
        });
        return Array.from(valores).sort();
      }

      function buildRacaOptions(data) {
        const valores = new Set();
        data.forEach(row => {
          const val = row[columnNames.raca];
          if (val) {
            let v = String(val).trim().toLowerCase();
            v = v.charAt(0).toUpperCase() + v.slice(1);
            if (v === 'Amarela' || v === 'Branca' || v === 'Parda' || v === 'Preta' || v === 'Indígena') {
              valores.add(v);
            } else {
              valores.add(v);
            }
          }
        });
        return Array.from(valores).sort();
      }

      function normalizarTranstorno(t) {
        if (!t) return '';
        let s = normalizeText(t);
        if (s === 'tdh') return 'tdah';
        if (s.includes('espectro') || s.includes('autista') || s === 'tea') return 'tea';
        if (s.includes('intelectual') || s === 'di') return 'deficiencia intelectual';
        return s;
      }

      function normalizarListaTranstornos(lista) {
        const s = new Set();
        lista.forEach(item => {
          const norm = normalizarTranstorno(item);
          if (norm) s.add(norm.toUpperCase());
        });
        return Array.from(s).sort();
      }

      function createToggleChips(containerId, options, filterType) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'toggle-chip';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.dataset.filter = filterType;
          input.value = opt;

          label.appendChild(input);
          label.appendChild(document.createTextNode(opt));

          container.appendChild(label);

          input.addEventListener('change', () => {
            if (input.checked) label.classList.add('selected');
            else label.classList.remove('selected');
            applyFilters();
          });
        });
      }

      function createModernRadio(containerId, options, filterType) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        options.forEach((opt, index) => {
          const label = document.createElement('label');
          label.className = 'modern-radio-label flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-100';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `filter_${filterType}`; // Group by name for radio behavior
          input.className = 'modern-radio-input w-4 h-4 text-rose-600 border-gray-300 focus:ring-rose-500';
          input.dataset.filter = filterType;
          input.value = opt;

          const span = document.createElement('span');
          span.className = 'modern-radio-text text-sm text-gray-600';
          span.textContent = opt;

          label.appendChild(input);
          label.appendChild(span);
          container.appendChild(label);

          // Allow deselecting if clicking the already selected radio
          let wasChecked = false;
          input.addEventListener('mousedown', () => {
            wasChecked = input.checked;
          });

          input.addEventListener('click', (e) => {
            if (wasChecked) {
              input.checked = false;
              wasChecked = false;
              applyFilters();
            } else {
              applyFilters();
            }
          });
        });
      }

      function createCheckboxes(containerId, options, filterType) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        options.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'flex items-center mb-2';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'custom-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
          input.dataset.filter = filterType;
          input.value = opt;
          input.dataset.value = opt;

          const label = document.createElement('label');
          label.className = 'ml-2 text-sm text-gray-700 cursor-pointer';
          label.textContent = opt;
          label.onclick = () => input.click();

          div.appendChild(input);
          div.appendChild(label);
          container.appendChild(div);

          input.addEventListener('change', () => applyFilters());
        });
      }

      function getViolenceMetadata(type) {
        const t = normalizeText(type).toLowerCase();
        let code = 'outros';
        let icon = '';

        // SVGs
        const icons = {
          fisica: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13.5a2.5 2.5 0 0 0-5 0v1a2 2 0 0 0 2 2h3a2 2 0 0 0 2-2v-1zm-5-8.5v4"></path><path d="M14.5 9h-2"></path><path d="M10 11.5v-1a2.5 2.5 0 0 0-5 0v1a2 2 0 0 0 2 2h3a2 2 0 0 0-5 0"></path></svg>`,
          psicologica: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a5 5 0 0 0-5 5v2a5 5 0 0 0 10 0V7a5 5 0 0 0-5-5z"></path><path d="M12 14a5 5 0 0 0-5 5v1h10v-1a5 5 0 0 0-5-5z"></path></svg>`,
          sexual: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`,
          negligencia: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 10.59 0A4 4 0 0 1 18 13.87V21H6Z"></path><line x1="6" y1="17" x2="18" y2="17"></line></svg>`,
          institucional: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="22" x2="22" y2="22"></line><line x1="6" y1="2" x2="6" y2="22"></line><line x1="18" y1="2" x2="18" y2="22"></line><line x1="6" y1="12" x2="18" y2="12"></line></svg>`,
          cyber: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`,
          patrimonial: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
          autolesao: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>`,
          default: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`
        };

        if (t.includes('fisica')) { code = 'fisica'; icon = icons.fisica; }
        else if (t.includes('psicologica') || t.includes('moral')) { code = 'psicologica'; icon = icons.psicologica; }
        else if (t.includes('sexual')) { code = 'sexual'; icon = icons.sexual; }
        else if (t.includes('negligencia')) { code = 'negligencia'; icon = icons.negligencia; }
        else if (t.includes('institucional')) { code = 'institucional'; icon = icons.institucional; }
        else if (t.includes('cyber') || t.includes('virtual')) { code = 'cyberbullying'; icon = icons.cyber; }
        else if (t.includes('patrimonial')) { code = 'financeira'; icon = icons.patrimonial; }
        else if (t.includes('auto') || t.includes('suicidio')) { code = 'autolesao'; icon = icons.autolesao; }
        else if (t.includes('bullying')) { code = 'bullying'; icon = icons.psicologica; }
        else { code = 'outros'; icon = icons.default; }

        return { code, icon, label: type };
      }

      function createViolenceTypeCards(containerId, options, filterType) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        container.className = ''; // Limpa classes utilitárias para usar o CSS do ID #filterTipoViolenciaContainer

        options.forEach(opt => {
          const meta = getViolenceMetadata(opt);

          const label = document.createElement('label');
          label.className = 'violence-type-card';
          label.dataset.type = meta.code;

          label.innerHTML = `
            <input type="checkbox" data-filter="${filterType}" data-value="${opt}" value="${opt}">
            <div class="violence-type-icon">${meta.icon}</div>
            <div class="violence-type-label">${opt}</div>
            <div class="violence-type-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
          `;

          container.appendChild(label);

          const input = label.querySelector('input');
          input.addEventListener('change', (e) => {
            if (e.target.checked) label.classList.add('selected');
            else label.classList.remove('selected');

            verificarViolenciaInstitucionalNoFiltro();
            applyFilters();
          });
        });
      }

      function verificarViolenciaInstitucionalNoFiltro() {
        const checkboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
        let isInst = false;
        checkboxes.forEach(cb => {
          if (normalizeText(cb.value).includes('institucional')) isInst = true;
        });

        const section = document.getElementById('section-violenciaInstitucional');
        if (section) {
          if (isInst) section.classList.remove('hidden');
          else section.classList.add('hidden');
        }
      }

      function selectAllViolenceTypes() {
        const checkboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]');
        checkboxes.forEach(cb => cb.checked = true);
        verificarViolenciaInstitucionalNoFiltro();
        applyFilters();
      }

      function clearAllViolenceTypes() {
        const checkboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]');
        checkboxes.forEach(cb => cb.checked = false);
        verificarViolenciaInstitucionalNoFiltro();
        applyFilters();
      }

      function updateBadgeViolenciaInstitucionalTotal() {
        const checkboxes = document.querySelectorAll('input[data-filter="violenciaInstitucional"]:checked');
        const badge = document.getElementById('badge-violenciaInstitucional-total');
        if (badge) {
          badge.textContent = checkboxes.length;
          if (checkboxes.length > 0) badge.classList.remove('hidden');
          else badge.classList.add('hidden');
        }
      }

      function buildViolenciaInstitucionalGroups(data) {
        const col = columnNames.tipoViolenciaInstitucional;
        if (!col) return;
        const values = buildNormalizedOptions(col, data);
        createCheckboxes('filterViolenciaInstitucionalContainer', values, 'violenciaInstitucional');
      }

      function gatherSelectedViolenciasInstitucionais() {
        return getCheckedValues('violenciaInstitucional');
      }

      function matchViolenciaInstitucionalCell(cellValue, selectedFilters) {
        if (!cellValue) return false;
        const cellNorm = normalizeText(cellValue);
        return selectedFilters.some(filter => cellNorm.includes(filter));
      }



      function initializeFilters(data) {
        // 1. Validação de Idade (Min <= Max)
        const idadeMin = document.getElementById('filterIdadeMin');
        const idadeMax = document.getElementById('filterIdadeMax');

        function validateAge() {
          const min = parseInt(idadeMin.value);
          const max = parseInt(idadeMax.value);
          if (!isNaN(min) && !isNaN(max) && min > max) {
            idadeMax.setCustomValidity("A idade máxima deve ser maior ou igual à mínima.");
            idadeMax.reportValidity();
          } else {
            idadeMax.setCustomValidity("");
          }
          applyFilters();
        }

        if (idadeMin && idadeMax) {
          idadeMin.addEventListener('input', validateAge);
          idadeMax.addEventListener('input', validateAge);
        }

        // 2. Região
        if (columnNames.regiao) {
          const valores = buildNormalizedOptions(columnNames.regiao, data);
          createCheckboxes('filterRegiaoContainer', valores, 'regiao');
        }

        // 3. Tipo Violência (Cards)
        if (columnNames.tipo) {
          const valores = buildNormalizedOptionsTipoViolencia(columnNames.tipo, data);
          createViolenceTypeCards('filterTipoViolenciaContainer', valores, 'tipoViolencia');
          setTimeout(verificarViolenciaInstitucionalNoFiltro, 500);
        }

        // 4. Escola & Tipo Instituição
        if (columnNames.escola) {
          const tiposSet = new Set();
          data.forEach(row => {
            const tipo = getTipoInstituicao(row[columnNames.escola]);
            if (tipo) tiposSet.add(tipo);
            else if (row[columnNames.escola]) tiposSet.add('Não Encontrada');
          });
          const tiposInstituicao = Array.from(tiposSet).sort();
          createCheckboxes('filterTipoInstituicaoContainer', tiposInstituicao, 'tipoInstituicao');

          const valores = buildNormalizedOptions(columnNames.escola, data);
          createCheckboxes('filterEscolaContainer', valores, 'escola');
        }

        // 5. Criança / Perfil Section (Refactored)
        // Gênero -> Chips
        if (columnNames.genero) {
          const valores = buildGeneroOptions(data);
          createToggleChips('filterGeneroContainer', valores, 'genero');
        }
        // Raça/Cor -> Checkboxes (Grid)
        if (columnNames.raca) {
          const valores = buildRacaOptions(data);
          createCheckboxes('filterRacaContainer', valores, 'raca');
        }
        // Orientação Sexual -> Radio
        const colOrientacao = columnNames.orientacao || columnNames.orientacaoSexual;
        if (colOrientacao) {
          let valores = buildNormalizedOptions(colOrientacao, data);
          if (valores.length === 0) valores = ['Heterossexual', 'Homossexual', 'Bissexual', 'Pansexual', 'Assexual', 'Outro', 'Não informado'];
          createModernRadio('filterOrientacaoContainer', valores, 'orientacao');
        }

        // PCD Listener
        const pcdSelect = document.getElementById('filterPCD');
        if (pcdSelect) {
          pcdSelect.addEventListener('change', () => {
            applyFilters();
            const tipoDefContainer = document.getElementById('section-tipoDeficiencia');
            if (tipoDefContainer) {
              if (pcdSelect.value === 'S') tipoDefContainer.classList.remove('hidden');
              else tipoDefContainer.classList.add('hidden');
            }
          });
        }
        // Tipo Deficiência (Detalhe)
        if (columnNames.detalhePCD) {
          const valoresBrutos = buildNormalizedOptions(columnNames.detalhePCD, data);
          const valoresNormalizados = normalizarListaTranstornos(valoresBrutos);
          createCheckboxes('filterTipoDeficienciaContainer', valoresNormalizados, 'tipoDeficiencia');
        }

        // 6. Violência Institucional
        if (columnNames.tipoViolenciaInstitucional) {
          buildViolenciaInstitucionalGroups(data);
        }

        // 7. Encaminhamento
        const colEnc = columnNames.encaminhamento;
        if (colEnc) {
          const values = buildNormalizedOptions(colEnc, data);
          buildEncaminhamentoGroups(values);
        }

        // Autocompletes
        if (typeof setupEscolaAutocomplete === 'function') setupEscolaAutocomplete();
        if (typeof setupTipoDeficienciaAutocomplete === 'function') setupTipoDeficienciaAutocomplete();
      }




      // Adiciona o filtro de membro familiar
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada', 'filterEstudoCaso',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI',
        'filterMembroFamiliar' // <-- Adicionado aqui
      ];

      filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          // Para inputs type="date", usar 'change' ao invés de 'input'
          const eventType = (element.type === 'date') ? 'change' :
            (element.tagName === 'INPUT') ? 'input' : 'change';
          element.addEventListener(eventType, applyFilters);
        }
      });

      // Inicializa estado do gráfico
      window.chartTipoViolenciaType = 'pie';

      // Configura botão de toggle
      const btnToggle = document.getElementById('btnToggleChartType');
      if (btnToggle) {
        btnToggle.addEventListener('click', function () {
          const isPie = window.chartTipoViolenciaType === 'pie';

          // Alterna estado
          window.chartTipoViolenciaType = isPie ? 'bar' : 'pie';

          // Atualiza texto do botão
          this.textContent = isPie ? 'Mudar para Pizza' : 'Mudar para Barras';

          // Re-renderiza gráficos se houver dados
          if (window.filteredData) {
            renderCharts(window.filteredData);
          }
        });
      }

      // Inicializa estado do gráfico Institucional
      window.chartViolenciaInstitucionalType = 'pie';

      // Configura botão de toggle Institucional
      const btnToggleInst = document.getElementById('btnToggleChartInstType');
      if (btnToggleInst) {
        btnToggleInst.addEventListener('click', function () {
          const isPie = window.chartViolenciaInstitucionalType === 'pie';

          // Alterna estado
          window.chartViolenciaInstitucionalType = isPie ? 'bar' : 'pie';

          // Atualiza texto do botão
          this.textContent = isPie ? 'Mudar para Pizza' : 'Mudar para Barras';

          // Re-renderiza gráficos se houver dados
          if (window.filteredData) {
            renderCharts(window.filteredData);
          }
        });
      }

      // ===============================================
      // ORQUESTRAÇÃO DE EXPORTAÇÃO PDF DUPLA (PIZZA E BARRAS)
      // ===============================================
      window.handleExportPDF = async function () {
        try {
          if (!window.filteredData || window.filteredData.length === 0) {
            alert('Não há dados filtrados para exportar.');
            return;
          }

          console.log('🚀 Iniciando exportação inteligente de PDF...');

          // Guarda estado original dos tipos de gráfico
          const originalTipoType = window.chartTipoViolenciaType;
          const originalInstType = window.chartViolenciaInstitucionalType;

          // Objeto para acumular todas as imagens
          const allImages = {};

          // 1. Captura gráficos "padrão" (aqueles que não mudam de tipo)
          // Renderiza estado atual para garantir
          renderCharts(window.filteredData);
          await new Promise(r => setTimeout(r, 800)); // Aguarda animação
          let standardImages = capturarGraficosComoImagens();
          Object.assign(allImages, standardImages);

          // 2. Captura "Tipos de Violência" - Versão PIZZA
          window.chartTipoViolenciaType = 'pie';
          renderCharts(window.filteredData);
          await new Promise(r => setTimeout(r, 600)); // Aguarda render
          const pieCanvas = document.getElementById('chartTipoViolencia');
          if (pieCanvas && pieCanvas.width > 0) {
            allImages['chartTipoViolencia_pie'] = pieCanvas.toDataURL('image/png');
          }

          // 3. Captura "Tipos de Violência" - Versão BARRAS
          window.chartTipoViolenciaType = 'bar';
          renderCharts(window.filteredData);
          await new Promise(r => setTimeout(r, 600)); // Aguarda render
          const barCanvas = document.getElementById('chartTipoViolencia');
          if (barCanvas && barCanvas.width > 0) {
            allImages['chartTipoViolencia_bar'] = barCanvas.toDataURL('image/png');
          }

          // 4. Captura "Violência Institucional" - Versão PIZZA (se visível/relevante)
          const instContainer = document.getElementById('containerChartViolenciaInstitucional');
          if (instContainer && !instContainer.classList.contains('hidden')) {
            window.chartViolenciaInstitucionalType = 'pie';
            renderCharts(window.filteredData);
            await new Promise(r => setTimeout(r, 600)); // Aguarda render
            const instPieCanvas = document.getElementById('chartTipoViolenciaInstitucional');
            if (instPieCanvas && instPieCanvas.width > 0) {
              allImages['chartTipoViolenciaInstitucional_pie'] = instPieCanvas.toDataURL('image/png');
            }

            // 5. Captura "Violência Institucional" - Versão BARRAS
            window.chartViolenciaInstitucionalType = 'bar';
            renderCharts(window.filteredData);
            await new Promise(r => setTimeout(r, 600)); // Aguarda render
            const instBarCanvas = document.getElementById('chartTipoViolenciaInstitucional');
            if (instBarCanvas && instBarCanvas.width > 0) {
              // Tenta capturar. Se não tiver dados, o renderCharts pode ter destruído o chart, 
              // mas a verificação de container visível acima deve prever isso.
              allImages['chartTipoViolenciaInstitucional_bar'] = instBarCanvas.toDataURL('image/png');
            }
          }

          // 6. Restaura estado original e re-renderiza para o usuário não perceber a "bagunça"
          window.chartTipoViolenciaType = originalTipoType;
          window.chartViolenciaInstitucionalType = originalInstType;
          renderCharts(window.filteredData);

          // 7. Chama a função de exportação real passando as imagens customizadas
          console.log('📦 Imagens preparadas para PDF:', Object.keys(allImages));
          exportarPDF(allImages);

        } catch (error) {
          console.error('Erro na orquestração do PDF:', error);
          alert('Ocorreu um erro ao preparar o PDF. Tente novamente.');
          // Tenta restaurar estado em caso de erro
          if (typeof window.chartTipoViolenciaType !== 'undefined') {
            renderCharts(window.filteredData);
          }
        }
      };



      // ===============================================
      // VINCULAÇÃO ROBUSTA DO BOTÃO DE EXPORTAÇÃO
      // ===============================================
      (function bindExportBtn() {
        const btn = document.getElementById('btnExportarPDF');
        if (btn) {
          console.log('✅ Botão Exportar PDF encontrado. Vinculando...');
          // Usa capture: true para garantir que pegamos o evento primeiro
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();
            window.handleExportPDF();
          }, { capture: true });
        } else {
          // Tenta novamente se o botão ainda não existir (ex: carregamento dinâmico)
          setTimeout(bindExportBtn, 500);
        }
      })();

      function syncConditionalOcorreuEscola() {
        const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
        const ocorreuContainer = document.getElementById('filterOcorreuEscolaContainer');
        const ocorreuSelect = document.getElementById('filterOcorreuEscola');
        if (!violenciaInformadaEl || !ocorreuContainer || !ocorreuSelect) return;

        const shouldShow = String(violenciaInformadaEl.value || '') === 'S';

        const isHidden = ocorreuContainer.classList.contains('hidden');
        const isAnimating = ocorreuContainer.classList.contains('is-animating');

        const animateIn = () => {
          if (isAnimating) return;
          ocorreuContainer.classList.add('is-animating');
          ocorreuContainer.classList.remove('hidden');

          // Estado inicial: "de dentro" (contraído e levemente acima)
          ocorreuContainer.style.height = '0px';
          ocorreuContainer.style.opacity = '0';
          ocorreuContainer.style.transform = 'translateY(-8px) scaleY(0.98)';

          // Força layout
          void ocorreuContainer.offsetHeight;

          const target = ocorreuContainer.scrollHeight;
          ocorreuContainer.style.transition = 'height 260ms cubic-bezier(0.16, 1, 0.3, 1), opacity 200ms ease, transform 260ms cubic-bezier(0.16, 1, 0.3, 1)';

          requestAnimationFrame(() => {
            ocorreuContainer.style.height = `${target}px`;
            ocorreuContainer.style.opacity = '1';
            ocorreuContainer.style.transform = 'translateY(0) scaleY(1)';
          });

          const onEnd = (ev) => {
            if (ev && ev.target !== ocorreuContainer) return;
            ocorreuContainer.removeEventListener('transitionend', onEnd);
            ocorreuContainer.style.transition = '';
            ocorreuContainer.style.height = '';
            ocorreuContainer.style.opacity = '';
            ocorreuContainer.style.transform = '';
            ocorreuContainer.classList.remove('is-animating');
            ocorreuContainer.style.overflow = '';
          };
          ocorreuContainer.addEventListener('transitionend', onEnd);
          setTimeout(() => onEnd({ target: ocorreuContainer }), 320);
        };

        const animateOut = () => {
          if (isAnimating) return;
          ocorreuContainer.classList.add('is-animating');

          const start = ocorreuContainer.getBoundingClientRect().height;
          ocorreuContainer.style.height = `${Math.max(0, start)}px`;
          ocorreuContainer.style.opacity = '1';
          ocorreuContainer.style.transform = 'translateY(0) scaleY(1)';

          // Força layout
          void ocorreuContainer.offsetHeight;

          ocorreuContainer.style.transition = 'height 220ms ease, opacity 160ms ease, transform 220ms ease';
          requestAnimationFrame(() => {
            ocorreuContainer.style.height = '0px';
            ocorreuContainer.style.opacity = '0';
            ocorreuContainer.style.transform = 'translateY(-8px) scaleY(0.98)';
          });

          const onEnd = (ev) => {
            if (ev && ev.target !== ocorreuContainer) return;
            ocorreuContainer.removeEventListener('transitionend', onEnd);
            ocorreuContainer.style.transition = '';
            ocorreuContainer.style.height = '';
            ocorreuContainer.style.opacity = '';
            ocorreuContainer.style.transform = '';
            ocorreuContainer.classList.remove('is-animating');
            ocorreuContainer.style.overflow = '';
            ocorreuContainer.classList.add('hidden');
          };
          ocorreuContainer.addEventListener('transitionend', onEnd);
          setTimeout(() => onEnd({ target: ocorreuContainer }), 280);
        };

        if (shouldShow) {
          ocorreuSelect.disabled = false;
          if (isHidden) animateIn();
        } else {
          ocorreuSelect.disabled = true;
          if (ocorreuSelect.value) {
            ocorreuSelect.value = '';
            ocorreuSelect.dispatchEvent(new Event('change', { bubbles: true }));
          }
          if (!isHidden) animateOut();
        }
      }

      const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
      if (violenciaInformadaEl) {
        violenciaInformadaEl.addEventListener('change', syncConditionalOcorreuEscola);
      }
      syncConditionalOcorreuEscola();

      // Listener para filterPCD → toggleTipoDeficienciaSection
      const filterPCDElement = document.getElementById('filterPCD');
      if (filterPCDElement) {
        filterPCDElement.addEventListener('change', () => {
          toggleTipoDeficienciaSection();
          applyFilters();
        });
      }
      toggleTipoDeficienciaSection(); // Estado inicial

      // Event listener específico para o filtro TI com atualização de badge
      const filterTIElement = document.getElementById('filterTI');
      if (filterTIElement) {
        filterTIElement.addEventListener('change', function () {
          updateBadgeTI();
          applyFilters();
        });
      }

      document.getElementById('btnLimparFiltros').addEventListener('click', clearFilters);
      // Event listeners de exportação já estão configurados no window.addEventListener('load')



      // ============================================
      // LÓGICA DO FILTRO DE DEFICIÊNCIA (PADRONIZADO)
      // ============================================
      let tipoDeficienciaOptions = []; // Armazena todas as opções únicas

      function populateTipoDeficienciaList(data) {
        if (!columnNames.detalhePCD) return;

        const container = document.getElementById('filterTipoDeficienciaContainer');
        const listPanel = document.getElementById('filterTipoDeficienciaAutocompleteList');
        if (!container || !listPanel) return;

        // 1. Extrair valores únicos
        const uniqueValues = new Set();
        data.forEach(row => {
          const raw = row[columnNames.detalhePCD];
          if (!raw) return;
          // Divide por vírgula e barra
          String(raw).split(/[,/]/).forEach(v => {
            const val = v.trim();
            if (val) uniqueValues.add(normalizarTranstorno(val)); // Usa normalização existente para agrupar
          });
        });

        // Converte para array de objetos { value, label } e ordena
        tipoDeficienciaOptions = Array.from(uniqueValues).sort().map(val => ({
          value: val,
          label: val // Label igual ao value normalizado (Title Case)
        }));

        // 2. Criar Checkboxes Invisíveis (Fonte de Verdade)
        container.innerHTML = '';
        tipoDeficienciaOptions.forEach(opt => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `chk_def_${opt.value.replace(/\s+/g, '_')}`;
          checkbox.value = opt.value;
          checkbox.name = 'tipoDeficiencia'; // Importante para getCheckedValues
          checkbox.className = 'custom-checkbox';
          container.appendChild(checkbox);
        });

        // 3. Renderizar Lista Visual Inicial
        renderTipoDeficienciaList('');
        initTipoDeficienciaSearch();
        updateTipoDeficienciaChips();
      }

      function initTipoDeficienciaSearch() {
        const searchInput = document.getElementById('filterTipoDeficienciaSearch');
        if (!searchInput) return;

        searchInput.addEventListener('input', (e) => {
          const term = e.target.value;
          renderTipoDeficienciaList(term);
        });
      }

      function renderTipoDeficienciaList(filterTerm) {
        const listPanel = document.getElementById('filterTipoDeficienciaAutocompleteList');
        if (!listPanel) return;

        listPanel.innerHTML = '';
        const term = filterTerm.toLowerCase();

        // Filtra opções
        const filtered = tipoDeficienciaOptions.filter(opt =>
          opt.label.toLowerCase().includes(term)
        );

        if (filtered.length === 0) {
          listPanel.innerHTML = `
            <div class="escola-empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 opacity-50"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <p>Nenhum tipo encontrado</p>
            </div>`;
          return;
        }

        // Renderiza itens
        filtered.forEach(opt => {
          const item = document.createElement('div');
          item.className = 'escola-list-item'; // Reusa estilo da escola

          // Verifica estado real no checkbox oculto
          const checkboxId = `chk_def_${opt.value.replace(/\s+/g, '_')}`;
          const realCheckbox = document.getElementById(checkboxId);
          const isChecked = realCheckbox ? realCheckbox.checked : false;

          if (isChecked) item.classList.add('selected');

          item.innerHTML = `<span>${opt.label}</span>`;
          if (isChecked) {
            item.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
          }

          // Click handler
          item.addEventListener('click', () => {
            if (realCheckbox) {
              realCheckbox.checked = !realCheckbox.checked;
              // Atualiza visual
              renderTipoDeficienciaList(filterTerm); // Re-renderiza para atualizar checks
              updateTipoDeficienciaChips();
              applyFilters();
            }
          });

          listPanel.appendChild(item);
        });
      }

      function updateTipoDeficienciaChips() {
        const chipsArea = document.getElementById('filterTipoDeficienciaSelectedTags');
        const container = document.getElementById('filterTipoDeficienciaContainer');
        if (!chipsArea || !container) return;

        chipsArea.innerHTML = '';
        const checkedBoxes = container.querySelectorAll('input:checked');

        if (checkedBoxes.length === 0) {
          chipsArea.style.display = 'none';
          return;
        }

        chipsArea.style.display = 'flex';
        checkedBoxes.forEach(cb => {
          const chip = document.createElement('div');
          chip.className = 'escola-chip'; // Reusa estilo
          chip.innerHTML = `
            <span>${cb.value}</span>
            <button onclick="removeTipoDeficiencia('${cb.value}')">×</button>
          `;
          chipsArea.appendChild(chip);
        });
      }

      // Função global para remover via chip
      window.removeTipoDeficiencia = function (val) {
        const container = document.getElementById('filterTipoDeficienciaContainer');
        if (!container) return;

        // Seletor mais seguro para valores com caracteres especiais
        const checkboxes = container.querySelectorAll('input');
        checkboxes.forEach(cb => {
          if (cb.value === val) {
            cb.checked = false;
          }
        });

        const searchInput = document.getElementById('filterTipoDeficienciaSearch');
        renderTipoDeficienciaList(searchInput ? searchInput.value : '');
        updateTipoDeficienciaChips();
        applyFilters();
      }
      function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        const firstOption = select.options[0] || null;
        select.innerHTML = '';
        if (firstOption) {
          select.appendChild(firstOption);
        }
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          select.appendChild(option);
        });
      }

      // S/N
      function checkSN(value, filterValue) {
        if (!filterValue) return true;
        const val = String(value || '').toUpperCase().trim();
        if (!val) return false;
        const f = filterValue.toUpperCase();
        if (f === 'S') {
          return val === 'S' || val === 'SIM';
        }
        if (f === 'N') {
          return val === 'N' || val === 'NAO' || val === 'NÃO';
        }
        return false;
      }

      // ============================================
      // CONDICIONAL: filterPCD → section-tipoDeficiencia
      // ============================================
      function toggleTipoDeficienciaSection() {
        const filterPCD = document.getElementById('filterPCD');
        const sectionTipoDeficiencia = document.getElementById('section-tipoDeficiencia');

        if (!filterPCD || !sectionTipoDeficiencia) return;

        if (filterPCD.value === 'S') {
          sectionTipoDeficiencia.classList.remove('hidden');
        } else {
          sectionTipoDeficiencia.classList.add('hidden');

          // Limpa seleções se esconder
          const container = document.getElementById('filterTipoDeficienciaContainer');
          if (container) {
            const checks = container.querySelectorAll('input:checked');
            if (checks.length > 0) {
              checks.forEach(c => c.checked = false);

              const searchInput = document.getElementById('filterTipoDeficienciaSearch');
              if (searchInput) searchInput.value = '';

              if (typeof updateTipoDeficienciaChips === 'function') updateTipoDeficienciaChips();
              if (typeof renderTipoDeficienciaList === 'function') renderTipoDeficienciaList('');

              // Se foi chamado pelo evento change, o applyFilters será chamado depois pelo listener.
              // Se for chamado manualmente, talvez precise forçar update, mas o listener do PCD já chama applyFilters.
            }
          }
        }
      }

      function applyFilters() {
        const filters = {
          regioes: getCheckedValues('regiao'),
          tipos: getCheckedValues('tipoViolencia'),
          tiposInstituicao: getCheckedValues('tipoInstituicao'),
          escolas: getCheckedValues('escola'),
          encaminhamentos: gatherSelectedEncaminhamentos(),
          racas: getCheckedValues('raca'),
          generos: getCheckedValues('genero'),

          // NOVO FILTRO: Tipos de deficiência/transtorno selecionados
          tiposDeficiencia: getCheckedValues('tipoDeficiencia'),

          // NOVOS FILTROS
          orientacoes: getCheckedValues('orientacao'),
          violenciasInstitucionais: gatherSelectedViolenciasInstitucionais(),

          pcd: document.getElementById('filterPCD').value,
          ocorreu: document.getElementById('filterOcorreuEscola').value,
          fonteInformada: document.getElementById('filterFonteInformada').value,
          violenciaEscolaOcorreu: document.getElementById('filterViolenciaEscolaOcorreu').value,
          profissionalAutor: document.getElementById('filterProfissionalAutor').value,
          estudanteAutor: document.getElementById('filterEstudanteAutor').value,
          violenciaNaoEscola: document.getElementById('filterViolenciaNaoEscola').value,
          violenciaInformada: document.getElementById('filterViolenciaInformada').value,

          estudoCaso: document.getElementById('filterEstudoCaso').value,

          // NOVO FILTRO: Foi um membro familiar?
          membroFamiliar: document.getElementById('filterMembroFamiliar').value,

          idadeMin: document.getElementById('filterIdadeMin').value,
          idadeMax: document.getElementById('filterIdadeMax').value,

          nome: document.getElementById('filterNome').value.toLowerCase(),

          dataInicio: document.getElementById('filterDataInicio').value,
          dataFim: document.getElementById('filterDataFim').value
        };

        const dataInicioDate = filters.dataInicio ? new Date(filters.dataInicio + 'T00:00:00') : null;
        const dataFimDate = filters.dataFim ? new Date(filters.dataFim + 'T23:59:59') : null;

        filteredData = originalData.filter(row => {

          // FILTRO: Foi um membro familiar?
          // Opções: '' (Todos), 'Sim', 'Não', 'naoinformado'
          if (filters.membroFamiliar && columnNames.foiMembroFamiliar) {
            const valor = String(row[columnNames.foiMembroFamiliar] || '').trim().toUpperCase();
            console.log('[Filtro Membro Familiar] Valor na linha:', valor, '| Filtro selecionado:', filters.membroFamiliar);
            if (filters.membroFamiliar === 'Sim' && valor !== 'S') return false;
            if (filters.membroFamiliar === 'Não' && valor !== 'N') return false;
            if (filters.membroFamiliar === 'naoinformado' && valor !== '') return false;
          }
          // Multi (OU) - com suporte a campos multi-valor separados por vírgula
          if (filters.regioes.length && columnNames.regiao) {
            const rowVals = String(row[columnNames.regiao] || '').split(',').map(v => v.trim());
            const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
            const filterNorms = filters.regioes.map(v => normalizeText(v));
            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }
          if (filters.tipos.length && columnNames.tipo) {
            // Filtro de Tipo de Violência: NÃO separa por barra (/)
            // "Financeira/Econômica" é tratada como uma categoria única
            const rowVals = String(row[columnNames.tipo] || '')
              .split(',')
              .map(v => v.trim())
              .filter(v => v);

            const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
            const filterNorms = filters.tipos.map(v => normalizeText(v));
            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }
          // Filtro por tipo de instituição (CMEI/EMEF/Não Encontrada/EJA)
          if (filters.tiposInstituicao.length && columnNames.escola) {
            const escolaSigla = row[columnNames.escola];
            let tipoEscola = null;

            // Lógica refatorada para usar metadados robustos
            if (window.NAVMEscolasTecnico) {
              // Tenta detectar EJA primeiro se for uma categoria desejada
              if (window.NAVMEscolasTecnico.isEJA(escolaSigla)) {
                tipoEscola = 'EJA';
              } else {
                tipoEscola = window.NAVMEscolasTecnico.getTipoInstituicaoBySigla(escolaSigla);
              }
            }

            // Fallback se NAVMEscolasTecnico não estiver carregado ou falhar
            if (!tipoEscola && escolaSigla) {
              // Tenta inferir pelo nome/sigla string (Legado mantido para segurança)
              const s = String(escolaSigla).toUpperCase();
              if (s.includes('EJA')) tipoEscola = 'EJA';
              else if (s.startsWith('CMEI') || window.NAVMEscolasTecnico.SIGLAS_CMEI[s]) tipoEscola = 'CMEI';
              else if (s.startsWith('EMEF') || window.NAVMEscolasTecnico.SIGLAS_EMEF[s]) tipoEscola = 'EMEF';
            }

            const tipoParaFiltro = tipoEscola || (row[columnNames.escola] ? 'Não Encontrada' : null);

            if (!tipoParaFiltro || !filters.tiposInstituicao.includes(tipoParaFiltro)) {
              return false;
            }
          }
          if (filters.escolas.length && columnNames.escola) {
            const rowVals = String(row[columnNames.escola] || '').split(',').map(v => v.trim());
            const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
            const filterNorms = filters.escolas.map(v => normalizeText(v));
            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }

          // FILTRO: Tempo Integral (Refatorado para usar NAVMEscolasTecnico.isTempoIntegral)
          const selectTI = document.getElementById('filterTI');
          const filtroTI = selectTI ? selectTI.value : '';

          if (filtroTI && columnNames.escola) {
            const escola = row[columnNames.escola]; // Sigla da escola

            if (filtroTI === 'TI') {
              // Só mantém registros de escolas de tempo integral
              if (window.NAVMEscolasTecnico && !window.NAVMEscolasTecnico.isTempoIntegral(escola)) {
                return false;
              }
            } else if (filtroTI === 'Regular') {
              // Só mantém registros de escolas que NÃO são TI
              if (window.NAVMEscolasTecnico && window.NAVMEscolasTecnico.isTempoIntegral(escola)) {
                return false;
              }
            }
            // Se filtroTI === '' → não filtra por tempo integral
          }

          if (filters.encaminhamentos.length && columnNames.encaminhamento) {
            if (!matchEncaminhamentoCell(row[columnNames.encaminhamento], filters.encaminhamentos)) {
              return false;
            }
          }
          if (filters.racas.length && columnNames.raca) {
            const rowVals = String(row[columnNames.raca] || '').split(',').map(v => v.trim());
            const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
            const filterNorms = filters.racas.map(v => normalizeText(v));
            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }
          if (filters.generos.length && columnNames.genero) {
            // Para gênero (coluna D), verifica se é M ou F
            const rowValue = String(row[columnNames.genero] || '').trim().toUpperCase();
            const ok = filters.generos.some(v => v.toUpperCase() === rowValue);
            if (!ok) return false;
          }

          // NOVO FILTRO: Tipo de deficiência/transtorno
          // Este filtro trabalha em conjunto com o filtro de PCD
          // APLICA NORMALIZAÇÃO para que "TDAH", "TDH", "tdah" sejam considerados iguais
          if (filters.tiposDeficiencia.length && columnNames.detalhePCD) {
            // Se o usuário selecionou tipos de deficiência, o registro deve:
            // 1) Ser PCD (ter "S" ou "SIM" na coluna PCD)
            // 2) Ter um detalhamento que bata com as opções selecionadas

            // Verifica se é PCD
            const isPCD = checkSN(row[columnNames.pcd], 'S');
            if (!isPCD) return false; // Se não é PCD, não passa no filtro

            // Verifica se o detalhamento bate com alguma opção selecionada
            // Separa por vírgula E por barra (/) para considerar múltiplos transtornos
            const rowVals = String(row[columnNames.detalhePCD] || '')
              .split(',')
              .flatMap(v => v.split('/'))
              .map(v => v.trim())
              .filter(v => v);

            // APLICA NORMALIZAÇÃO aos valores do registro E aos filtros selecionados
            const rowNormalizados = rowVals.map(v => normalizarTranstorno(v));
            const filterNormalizados = filters.tiposDeficiencia; // Já vem normalizado do checkbox

            // Compara usando normalizeText para remover acentos e maiúsculas
            const rowNorms = rowNormalizados.map(v => normalizeText(v));
            const filterNorms = filterNormalizados.map(v => normalizeText(v));

            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }

          // NOVO FILTRO: Orientação Sexual (OU)
          if (filters.orientacoes.length && columnNames.orientacaoSexual) {
            const rowVals = String(row[columnNames.orientacaoSexual] || '')
              .split(',')
              .flatMap(v => v.split('/'))
              .map(v => v.trim())
              .filter(v => v);

            const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
            const filterNorms = filters.orientacoes.map(v => normalizeText(v));
            const ok = rowNorms.some(rn => filterNorms.includes(rn));
            if (!ok) return false;
          }

          // FILTRO: Violências Institucionais
          // Aplica se o registro tem "Institucional" em tipoViolencia
          if (filters.violenciasInstitucionais && filters.violenciasInstitucionais.length > 0) {
            const tipoViolencia = String(row[columnNames.tipo] || '').toLowerCase();
            const temInstitucional = tipoViolencia.includes('institucional');

            if (!temInstitucional) {
              // Se não tem "Institucional" em tipoViolencia, não passa no filtro
              return false;
            }

            // Se tem "Institucional" em tipoViolencia, verifica o campo tipoViolenciaInstitucional
            if (columnNames.tipoViolenciaInstitucional) {
              const violenciaInstitucional = row[columnNames.tipoViolenciaInstitucional];

              // Se o campo está vazio, considera como "Não informado" e passa no filtro
              // (todos os registros com "Institucional" devem aparecer, mesmo sem detalhamento)
              if (!violenciaInstitucional || String(violenciaInstitucional).trim() === '') {
                // Campo vazio = "Não informado", passa no filtro
                // (todos os registros com violência institucional aparecem, independente do detalhamento)
              } else {
                // Se tem valor, verifica se corresponde aos filtros selecionados
                if (!matchViolenciaInstitucionalCell(violenciaInstitucional, filters.violenciasInstitucionais)) {
                  return false;
                }
              }
            }
          }

          // S/N
          if (filters.pcd && columnNames.pcd && !checkSN(row[columnNames.pcd], filters.pcd)) return false;

          // FILTRO: Ocorreu na escola - Combina colunas U (ocorreu) e Q (violenciaEscolaOcorreu)
          // 'S'  → mostra registros onde U OU Q = 'S'
          // 'N'  → mostra registros onde U E Q = 'N'
          // 'NI' → mostra registros onde nenhuma coluna tem 'S' nem 'N' (ambas vazias/indefinidas)
          if (filters.ocorreu && filters.ocorreu !== '') {
            const valU = columnNames.ocorreu ? String(row[columnNames.ocorreu] || '').trim().toUpperCase() : '';
            const valQ = columnNames.violenciaEscolaOcorreu ? String(row[columnNames.violenciaEscolaOcorreu] || '').trim().toUpperCase() : '';
            const ocorreuU = valU === 'S' || valU === 'SIM';
            const ocorreuQ = valQ === 'S' || valQ === 'SIM';
            const naoU = valU === 'N' || valU === 'NAO' || valU === 'NÃO';
            const naoQ = valQ === 'N' || valQ === 'NAO' || valQ === 'NÃO';
            const ocorreuNaEscola = ocorreuU || ocorreuQ;

            if (filters.ocorreu === 'S' && !ocorreuNaEscola) return false;

            if (filters.ocorreu === 'N') {
              // 'Não' = pelo menos uma coluna marcada como N, e nenhuma como S
              if (ocorreuNaEscola || (!naoU && !naoQ)) return false;
            }

            if (filters.ocorreu === 'NI') {
              // 'Não Informado' = nenhuma coluna tem S nem N (ambas vazias)
              if (ocorreuNaEscola || naoU || naoQ) return false;
            }
          }

          if (filters.fonteInformada && columnNames.fonteInformada && !checkSN(row[columnNames.fonteInformada], filters.fonteInformada)) return false;

          // FILTRO: Violência identificada pela escola ocorrida na escola - Usa APENAS coluna Q
          if (filters.violenciaEscolaOcorreu && columnNames.violenciaEscolaOcorreu &&
            !checkSN(row[columnNames.violenciaEscolaOcorreu], filters.violenciaEscolaOcorreu)) return false;

          // FILTRO: Autor da Violência (colunas R e S)
          // Lógica: Se profissionalAutor = 'S', mostra apenas casos onde R = 'S' (independente de S)
          // Se estudanteAutor = 'S', mostra apenas casos onde S = 'S' (independente de R)
          // Se ambos = 'N', mostra apenas casos onde R = 'N' E S = 'N'
          if (filters.profissionalAutor && filters.profissionalAutor !== '') {
            if (columnNames.profissionalAutor) {
              const profissionalS = checkSN(row[columnNames.profissionalAutor], 'S');
              const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');

              if (filters.profissionalAutor === 'S' && !profissionalS) return false;
              if (filters.profissionalAutor === 'N' && !profissionalN) return false;
            }
          }

          if (filters.estudanteAutor && filters.estudanteAutor !== '') {
            if (columnNames.estudanteAutor) {
              const estudanteS = checkSN(row[columnNames.estudanteAutor], 'S');
              const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');

              if (filters.estudanteAutor === 'S' && !estudanteS) return false;
              if (filters.estudanteAutor === 'N' && !estudanteN) return false;
            }
          }

          // Caso especial: Se ambos estão definidos como 'N', significa "Outro Agente"
          // Ambos devem ser 'N' para passar no filtro
          if (filters.profissionalAutor === 'N' && filters.estudanteAutor === 'N') {
            if (columnNames.profissionalAutor && columnNames.estudanteAutor) {
              const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');
              const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');
              if (!profissionalN || !estudanteN) return false;
            }
          }
          if (filters.violenciaNaoEscola && columnNames.violenciaNaoEscola &&
            !checkSN(row[columnNames.violenciaNaoEscola], filters.violenciaNaoEscola)) return false;
          if (filters.violenciaInformada && columnNames.violenciaInformada &&
            !checkSN(row[columnNames.violenciaInformada], filters.violenciaInformada)) return false;
          if (filters.estudoCaso && columnNames.estudoCaso &&
            !checkSN(row[columnNames.estudoCaso], filters.estudoCaso)) return false;

          // Idade
          if (columnNames.idade) {
            const idade = parseInt(row[columnNames.idade], 10);
            if (filters.idadeMin && !isNaN(idade) && idade < parseInt(filters.idadeMin, 10)) return false;
            if (filters.idadeMax && !isNaN(idade) && idade > parseInt(filters.idadeMax, 10)) return false;
          }

          // Nome (contains)
          if (filters.nome && columnNames.crianca) {
            const nome = String(row[columnNames.crianca] || '').toLowerCase();
            if (!nome.includes(filters.nome)) return false;
          }

          // Data - usa coluna dataNT (Data da NT) ou data
          const dataColumn = columnNames.dataNT || columnNames.data;
          if ((dataInicioDate || dataFimDate) && dataColumn !== undefined) {
            const rowDate = parseDateCell(row[dataColumn]);
            // Se houver filtro de data mas o registro não tem data válida, exclui o registro
            if (!rowDate) {
              return false;
            }

            // Normaliza as datas para comparação (apenas dia/mês/ano, sem horas)
            const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
            const dataInicioOnly = dataInicioDate ? new Date(dataInicioDate.getFullYear(), dataInicioDate.getMonth(), dataInicioDate.getDate()) : null;
            const dataFimDateOnly = dataFimDate ? new Date(dataFimDate.getFullYear(), dataFimDate.getMonth(), dataFimDate.getDate()) : null;

            if (dataInicioOnly && rowDateOnly < dataInicioOnly) return false;
            if (dataFimDateOnly && rowDateOnly > dataFimDateOnly) return false;
          }

          return true;
        });

        // Atualiza variável global para dashboard-stats.js
        window.filteredData = filteredData;

        // Resetar para primeira página ao aplicar filtros
        paginaAtual = 1;

        renderStats(filteredData);
        renderCharts(filteredData);
        renderTable(filteredData);

        // Atualiza KPIs após aplicar filtros
        setTimeout(() => {
          if (typeof atualizarKPIs === 'function') {
            atualizarKPIs();
          }
          if (typeof updateNewHeaderMetrics === 'function') {
            updateNewHeaderMetrics();
          }
        }, 300);

        updateFilterCardBadges();

        // Atualiza UI de sub-grupos
        if (typeof updateBadgeViolenciaInstitucionalTotal === 'function') {
          updateBadgeViolenciaInstitucionalTotal();
        }
        if (typeof verificarViolenciaInstitucionalNoFiltro === 'function') {
          verificarViolenciaInstitucionalNoFiltro();
        }
      }

      function clearFilters() {
        // Limpar checkboxes dos filtros avançados
        const allCheckboxes = document.querySelectorAll('.custom-checkbox');
        allCheckboxes.forEach(cb => {
          cb.checked = false;
          cb.indeterminate = false;
        });

        // Limpar badges
        const badges = document.querySelectorAll('.badge-count, .group-badge');
        badges.forEach(badge => badge.classList.add('hidden'));

        // Remover estados ativos dos cards
        const cards = document.querySelectorAll('.filter-card');
        cards.forEach(card => card.classList.remove('active'));

        // Esconder todas as seções
        const sections = document.querySelectorAll('.filter-section');
        sections.forEach(section => {
          section.classList.remove('show');
          section.classList.add('hidden');
        });

        // Limpar selects e inputs
        const filterIds = [
          'filterPCD', 'filterOcorreuEscola',
          'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
          'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada',
          'filterIdadeMin', 'filterIdadeMax', 'filterNome',
          'filterDataInicio', 'filterDataFim', 'filterTI'
        ];

        filterIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (el.tagName === 'SELECT') {
            Array.from(el.options).forEach(o => o.selected = false);
          } else {
            el.value = '';
          }
        });

        // Reaplica regra do campo condicional (oculta e garante valor limpo)
        const violenciaInformadaEl = document.getElementById('filterViolenciaInformada');
        const ocorreuContainer = document.getElementById('filterOcorreuEscolaContainer');
        const ocorreuSelect = document.getElementById('filterOcorreuEscola');
        if (violenciaInformadaEl && ocorreuContainer && ocorreuSelect) {
          ocorreuContainer.classList.add('hidden');
          ocorreuSelect.disabled = true;
          ocorreuSelect.value = '';
        }

        // Resetar filtro condicional de tipo deficiência
        toggleTipoDeficienciaSection();

        filteredData = [...originalData];

        // Atualiza variável global para dashboard-stats.js
        window.filteredData = filteredData;

        // Esconde seção de Violências Institucionais ao limpar filtros
        const sectionViolenciaInstitucional = document.getElementById('section-violenciaInstitucional');
        if (sectionViolenciaInstitucional) {
          sectionViolenciaInstitucional.classList.add('hidden');
        }

        // Resetar para primeira página ao limpar filtros
        paginaAtual = 1;

        renderStats(filteredData);
        renderCharts(filteredData);
        renderTable(filteredData);

        // Atualiza KPIs após limpar filtros
        setTimeout(() => {
          if (typeof atualizarKPIs === 'function') {
            atualizarKPIs();
          }
        }, 300);

        ensureFilterCardBadges();
        updateFilterCardBadges();
      }

      // ==============================
      // Estatísticas / Tabela
      // ==============================
      function renderStats(data) {
        const total = originalData.length;
        const filtrados = data.length;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statFiltrados').textContent = filtrados;

        let countEscola = 0;
        // Considera AMBAS as colunas U (ocorreu na escola 1.1) e Q (violência identificada pela escola ocorrida na escola)
        // Se qualquer uma delas for 'S' ou 'Sim', conta como ocorrido na escola
        if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
          countEscola = data.reduce((acc, row) => {
            const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
            const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
            return acc + (ocorreuU || ocorreuQ ? 1 : 0);
          }, 0);
        }
        document.getElementById('statEscola').textContent = countEscola;

        const tiposDiv = document.getElementById('statTipos');
        tiposDiv.innerHTML = '';
        if (columnNames.tipo) {
          const mapa = {};
          data.forEach(row => {
            const tipo = row[columnNames.tipo];
            if (!tipo) return;
            const rotulo = String(tipo).trim();
            mapa[rotulo] = (mapa[rotulo] || 0) + 1;
          });
          const tipos = Object.keys(mapa).sort();
          if (tipos.length === 0) {
            tiposDiv.textContent = 'Nenhum tipo identificado nos registros filtrados.';
          } else {
            tipos.forEach(t => {
              const p = document.createElement('div');
              p.textContent = `${t}: ${mapa[t]}`;
              tiposDiv.appendChild(p);
            });
          }
        } else {
          tiposDiv.textContent = 'Coluna "Tipo de Violência" não encontrada.';
        }
      }

      // ==============================
      // Gráficos
      // ==============================
      // ==============================
      // Gráficos - Helpers e Rendering
      // ==============================

      function showSkeleton(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !canvas.parentElement) return;

        // O pai do canvas deve ser position: relative
        const container = canvas.parentElement;
        if (getComputedStyle(container).position === 'static') {
          container.style.position = 'relative';
        }

        // Verifica se já existe skeleton
        let skeleton = container.querySelector('.chart-skeleton');
        if (!skeleton) {
          skeleton = document.createElement('div');
          skeleton.className = 'chart-skeleton';
          container.appendChild(skeleton);
        }
        skeleton.style.display = 'block';
      }

      function hideSkeleton(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !canvas.parentElement) return;
        const skeleton = canvas.parentElement.querySelector('.chart-skeleton');
        if (skeleton) {
          // Pequeno delay ou fade-out opcional poderia ser adicionado aqui
          skeleton.style.display = 'none';
        }
      }

      function renderCharts(data) {
        // Lista de IDs de canvas para mostrar skeleton
        const chartIds = [
          'chartTipoViolencia', 'chartTipoViolenciaInstitucional', 'chartRegiao', 'chartEscola',
          'chartIdade', 'chartGenero', 'chartRaca', 'chartTemporal',
          'chartEncaminhamento', 'chartAutor', 'chartOcorreuEscola',
          'chartCorrelacaoTipoIdade', 'chartComparativoTemporal', 'chartTendenciaAnual'
        ];

        // Ativa skeleton em todos
        chartIds.forEach(id => showSkeleton(id));

        // Pequeno delay para permitir que o browser renderize o skeleton
        setTimeout(() => {
          processAndRenderCharts(data);
        }, 50);
      }

      function processAndRenderCharts(data) {
        // Cores para os gráficos
        const colors = [
          'rgba(59, 130, 246, 0.8)',   // azul
          'rgba(239, 68, 68, 0.8)',    // vermelho
          'rgba(34, 197, 94, 0.8)',    // verde
          'rgba(234, 179, 8, 0.8)',    // amarelo
          'rgba(168, 85, 247, 0.8)',   // roxo
          'rgba(236, 72, 153, 0.8)',   // rosa
          'rgba(20, 184, 166, 0.8)',   // teal
          'rgba(251, 146, 60, 0.8)',   // laranja
          'rgba(148, 163, 184, 0.8)',  // cinza
          'rgba(6, 182, 212, 0.8)'     // cyan
        ];

        // Gráfico: Tipos de Violência (normalizado)
        if (columnNames.tipo) {
          const dados = {};
          const mapaNormalizado = {}; // norm -> label original mais comum

          data.forEach(row => {
            const tipo = row[columnNames.tipo];
            if (tipo) {
              const original = String(tipo).trim();
              const norm = normalizeText(original);
              if (norm) {
                dados[norm] = (dados[norm] || 0) + 1;
                // Guarda o label original mais usado (capitalizado)
                if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                  mapaNormalizado[norm] = original;
                }
              }
            }
          });

          // Converte de volta para labels originais
          const sorted = Object.entries(dados)
            .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
            .sort((a, b) => b[1] - a[1]);

          // Verifica tipo de gráfico selecionado (global)
          if (window.chartTipoViolenciaType === 'bar') {
            renderHorizontalBarChart('chartTipoViolencia', sorted, colors);
          } else {
            renderPieChart('chartTipoViolencia', sorted, colors);
          }
        }

        // Gráfico: Tipos de Violência Institucional (normalizado)
        // Só renderiza se "Institucional" estiver selecionado no filtro de tipo de violência
        const containerChartViolenciaInst = document.getElementById('containerChartViolenciaInstitucional');
        const tipoViolenciaCheckboxes = document.querySelectorAll('input[data-filter="tipoViolencia"]:checked');
        const temInstitucional = Array.from(tipoViolenciaCheckboxes).some(cb => {
          const valor = (cb.dataset.value || '').toLowerCase();
          return valor === 'institucional' || valor.includes('institucional');
        });

        if (temInstitucional && columnNames.tipoViolenciaInstitucional) {
          // Mostra o container do gráfico
          if (containerChartViolenciaInst) {
            containerChartViolenciaInst.classList.remove('hidden');
          }

          const dados = {};
          const mapaNormalizado = {};

          // Filtra apenas registros que têm "Institucional" no tipo de violência
          // Usa os dados já filtrados (parâmetro 'data' da função renderCharts)
          const dataInstitucional = data.filter(row => {
            const tipoViolencia = row[columnNames.tipo];
            if (!tipoViolencia) return false;
            const tipoViolenciaStr = String(tipoViolencia).toLowerCase();
            return tipoViolenciaStr.includes('institucional');
          });

          dataInstitucional.forEach(row => {
            const tipoInst = row[columnNames.tipoViolenciaInstitucional];
            if (tipoInst) {
              const original = String(tipoInst).trim();
              const norm = normalizeText(original);
              if (norm) {
                dados[norm] = (dados[norm] || 0) + 1;
                // Guarda o label original mais usado (capitalizado)
                if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                  mapaNormalizado[norm] = original;
                }
              }
            }
          });

          // Converte de volta para labels originais
          const sorted = Object.entries(dados)
            .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
            .sort((a, b) => b[1] - a[1]);

          // Se houver dados, renderiza o gráfico
          if (sorted.length > 0) {
            // Verifica tipo de gráfico selecionado (global)
            if (window.chartViolenciaInstitucionalType === 'bar') {
              renderHorizontalBarChart('chartTipoViolenciaInstitucional', sorted, colors);
            } else {
              renderPieChart('chartTipoViolenciaInstitucional', sorted, colors);
            }
          } else {
            // Se não houver dados, mostra mensagem
            const canvas = document.getElementById('chartTipoViolenciaInstitucional');
            if (canvas && canvas.parentElement) {
              // Destroi o gráfico se existir
              if (charts['chartTipoViolenciaInstitucional']) {
                charts['chartTipoViolenciaInstitucional'].destroy();
                delete charts['chartTipoViolenciaInstitucional'];
              }
              canvas.parentElement.innerHTML = '<p class="text-gray-500 text-sm text-center mt-8">Nenhuma violência institucional encontrada nos dados filtrados.</p>';
            }
          }
        } else {
          // Esconde o container do gráfico se "Institucional" não estiver selecionado
          if (containerChartViolenciaInst) {
            containerChartViolenciaInst.classList.add('hidden');
          }
          // Destroi o gráfico se existir
          if (charts['chartTipoViolenciaInstitucional']) {
            charts['chartTipoViolenciaInstitucional'].destroy();
            delete charts['chartTipoViolenciaInstitucional'];
          }
        }

        // Gráfico: Por Região (normalizado)
        if (columnNames.regiao) {
          const dados = {};
          const mapaNormalizado = {};

          data.forEach(row => {
            const regiao = row[columnNames.regiao];
            if (regiao) {
              const original = String(regiao).trim();
              const norm = normalizeText(original);
              if (norm) {
                dados[norm] = (dados[norm] || 0) + 1;
                if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                  mapaNormalizado[norm] = original;
                }
              }
            }
          });

          const sorted = Object.entries(dados)
            .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
            .sort((a, b) => b[1] - a[1]);
          renderBarChart('chartRegiao', sorted, colors);
        }

        // Gráfico: Top 10 Escolas (normalizado)
        if (columnNames.escola) {
          const dados = {};
          const mapaNormalizado = {};

          data.forEach(row => {
            const escola = row[columnNames.escola];
            if (escola) {
              const original = String(escola).trim();
              const norm = normalizeText(original);
              if (norm) {
                dados[norm] = (dados[norm] || 0) + 1;
                if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                  mapaNormalizado[norm] = original;
                }
              }
            }
          });

          const sorted = Object.entries(dados)
            .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          renderBarChart('chartEscola', sorted, colors);
        }

        // Gráfico: Faixa Etária
        if (columnNames.idade) {
          const faixas = {
            '0-5 anos': 0,
            '6-10 anos': 0,
            '11-14 anos': 0,
            '15-17 anos': 0,
            '18+ anos': 0
          };

          data.forEach(row => {
            const idade = parseInt(row[columnNames.idade], 10);
            if (!isNaN(idade)) {
              if (idade <= 5) faixas['0-5 anos']++;
              else if (idade <= 10) faixas['6-10 anos']++;
              else if (idade <= 14) faixas['11-14 anos']++;
              else if (idade <= 17) faixas['15-17 anos']++;
              else faixas['18+ anos']++;
            }
          });

          const sorted = Object.entries(faixas).filter(([k, v]) => v > 0);
          renderBarChart('chartIdade', sorted, colors);
        }

        // Gráfico: Gênero (Coluna D: M ou F)
        if (columnNames.genero) {
          const dados = { 'F': 0, 'M': 0 };
          data.forEach(row => {
            const genero = row[columnNames.genero];
            if (genero) {
              const key = String(genero).trim().toUpperCase();
              if (key === 'F') dados['F']++;
              else if (key === 'M') dados['M']++;
            }
          });

          // Filtra apenas os que têm valores
          const sorted = Object.entries(dados).filter(([k, v]) => v > 0).sort((a, b) => b[1] - a[1]);
          renderPieChart('chartGenero', sorted, colors);
        }

        // Gráfico: Raça/Cor (normalizado)
        if (columnNames.raca) {
          const dados = {};
          const mapaNormalizado = {};

          data.forEach(row => {
            const raca = row[columnNames.raca];
            if (raca) {
              const original = String(raca).trim();
              const norm = normalizeText(original);
              if (norm) {
                dados[norm] = (dados[norm] || 0) + 1;
                if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                  mapaNormalizado[norm] = original;
                }
              }
            }
          });

          const sorted = Object.entries(dados)
            .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
            .sort((a, b) => b[1] - a[1]);
          renderPieChart('chartRaca', sorted, colors);
        }

        // Gráfico: Linha do Tempo (sem logs detalhados de datas)
        if (columnNames.data) {
          const porMes = {};
          data.forEach((row) => {
            const rawData = row[columnNames.data];
            const date = parseDateCell(rawData);
            if (date) {
              const mes = date.getMonth();
              const ano = date.getFullYear();
              const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
              porMes[key] = (porMes[key] || 0) + 1;
            }
          });
          const sorted = Object.entries(porMes).sort((a, b) => a[0].localeCompare(b[0]));
          console.log('Meses ordenados:', sorted);

          const labels = sorted.map(([key]) => {
            const [ano, mes] = key.split('-');
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return `${meses[parseInt(mes) - 1]}/${ano}`;
          });
          const valores = sorted.map(([, v]) => v);

          console.log('Labels para gráfico:', labels);
          console.log('Valores para gráfico:', valores);
          console.log('=== FIM DEBUG GRÁFICO TEMPORAL ===');

          renderLineChart('chartTemporal', labels, valores);
        }

        // Gráfico: Encaminhamentos (agrupado por redes)
        if (columnNames.encaminhamento) {
          // Contagem por grupo de rede
          const dadosPorGrupo = {};

          data.forEach(row => {
            const encaminhamento = row[columnNames.encaminhamento];
            if (encaminhamento) {
              // Suporta valores múltiplos separados por vírgula e barra
              const valores = String(encaminhamento)
                .split(',')
                .flatMap(v => v.split('/'))
                .map(v => v.trim())
                .filter(v => v);

              valores.forEach(val => {
                const original = String(val).trim();
                const norm = normalizeText(original);

                if (norm) {
                  // Encontrar grupo
                  let grupoEncontrado = null;
                  for (const groupKey in encaminhamentosAgrupados) {
                    const children = encaminhamentosAgrupados[groupKey];
                    if (children.some(child => normalizeText(child) === norm)) {
                      grupoEncontrado = groupKey;
                      break;
                    }
                  }

                  // Se não encontrou grupo, usar "Outros"
                  if (!grupoEncontrado) {
                    grupoEncontrado = 'outros';
                  }

                  // Contagem por grupo
                  if (!dadosPorGrupo[grupoEncontrado]) {
                    dadosPorGrupo[grupoEncontrado] = 0;
                  }
                  dadosPorGrupo[grupoEncontrado]++;
                }
              });
            }
          });

          // Converter para array e ordenar
          const sorted = Object.entries(dadosPorGrupo)
            .map(([groupId, count]) => {
              const groupName = grupoNomes[groupId] || (groupId === 'outros' ? 'Outros Encaminhamentos' : groupId);
              return [groupName, count, groupId];
            })
            .sort((a, b) => b[1] - a[1]);

          if (sorted.length > 0) {
            // Usar cores diferentes para cada grupo
            const coresPorGrupo = {
              'redeAssistencia': 'rgba(59, 130, 246, 0.8)', // Azul
              'redeSaude': 'rgba(34, 197, 94, 0.8)', // Verde
              'redeEducacao': 'rgba(251, 146, 60, 0.8)', // Laranja
              'conselhoTutelar': 'rgba(168, 85, 247, 0.8)', // Roxo
              'redeSegurancaJustica': 'rgba(239, 68, 68, 0.8)', // Vermelho
              'outros': 'rgba(156, 163, 175, 0.8)' // Cinza
            };

            const cores = sorted.map(([, , groupId]) => coresPorGrupo[groupId] || coresPorGrupo['outros']);
            const dadosGrafico = sorted.map(([name, count]) => [name, count]);

            renderHorizontalBarChartGrouped('chartEncaminhamento', dadosGrafico, cores);
          }
        }

        // Gráfico: Autor da Violência (baseado nas colunas R e S)
        // Coluna R (profissionalAutor): 'S' = Profissional da Escola
        // Coluna S (estudanteAutor): 'S' = Estudante
        // Se ambas = 'N': Outro Agente (Fora da Instituição)
        if (columnNames.profissionalAutor || columnNames.estudanteAutor) {
          const dados = {
            'Profissional da Escola': 0,
            'Estudante': 0,
            'Outro Agente (Fora da Instituição)': 0,
            'Não Informado': 0
          };

          data.forEach(row => {
            const profissionalS = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'S') : false;
            const profissionalN = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'N') : false;
            const estudanteS = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'S') : false;
            const estudanteN = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'N') : false;

            // Se coluna R = 'S' → Profissional da Escola
            if (profissionalS) {
              dados['Profissional da Escola']++;
            }
            // Se coluna S = 'S' → Estudante
            else if (estudanteS) {
              dados['Estudante']++;
            }
            // Se ambas colunas R e S = 'N' → Outro Agente (Fora da Instituição)
            else if (profissionalN && estudanteN) {
              dados['Outro Agente (Fora da Instituição)']++;
            }
            // Caso contrário → Não Informado
            else {
              dados['Não Informado']++;
            }
          });

          const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
          if (sorted.length > 0) {
            renderPieChart('chartAutor', sorted, colors);
          }
        }

        // Gráfico: Ocorreu na Escola? (Sim/Não)
        if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
          const dados = {
            'Sim': 0,
            'Não': 0,
            'Não Informado': 0
          };

          data.forEach(row => {
            const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
            const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
            const ocorreuNaEscola = ocorreuU || ocorreuQ;

            const naoOcorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'N') : false;
            const naoOcorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'N') : false;
            const naoOcorreuNaEscola = naoOcorreuU || naoOcorreuQ;

            if (ocorreuNaEscola) {
              dados['Sim']++;
            } else if (naoOcorreuNaEscola) {
              dados['Não']++;
            } else {
              dados['Não Informado']++;
            }
          });

          const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
          if (sorted.length > 0) {
            renderPieChart('chartOcorreuEscola', sorted, colors);
          }
        }

        // Gráfico: Correlação Tipo de Violência vs Faixa Etária
        if (columnNames.tipo && columnNames.idade) {
          const faixasEtarias = ['0-5', '6-10', '11-14', '15-17', '18+'];
          const tiposViolencia = {};
          const correlacao = {};

          // Primeiro, identifica todos os tipos de violência
          data.forEach(row => {
            const tipo = row[columnNames.tipo];
            if (tipo) {
              const tipoNorm = normalizeText(String(tipo).trim());
              if (tipoNorm && !tiposViolencia[tipoNorm]) {
                tiposViolencia[tipoNorm] = String(tipo).trim();
              }
            }
          });

          // Cria estrutura de correlação
          Object.keys(tiposViolencia).forEach(tipoNorm => {
            correlacao[tipoNorm] = {};
            faixasEtarias.forEach(faixa => {
              correlacao[tipoNorm][faixa] = 0;
            });
          });

          // Preenche os dados
          data.forEach(row => {
            const tipo = row[columnNames.tipo];
            const idade = row[columnNames.idade];

            if (tipo && idade) {
              const tipoNorm = normalizeText(String(tipo).trim());
              if (!tipoNorm) return;

              const idadeNum = parseInt(String(idade).trim(), 10);
              if (isNaN(idadeNum)) return;

              let faixa = '18+';
              if (idadeNum <= 5) faixa = '0-5';
              else if (idadeNum <= 10) faixa = '6-10';
              else if (idadeNum <= 14) faixa = '11-14';
              else if (idadeNum <= 17) faixa = '15-17';

              if (correlacao[tipoNorm] && correlacao[tipoNorm][faixa] !== undefined) {
                correlacao[tipoNorm][faixa]++;
              }
            }
          });

          // Prepara dados para o gráfico (top 5 tipos mais frequentes)
          const tiposOrdenados = Object.entries(tiposViolencia)
            .map(([norm, original]) => {
              const total = faixasEtarias.reduce((sum, faixa) => sum + (correlacao[norm]?.[faixa] || 0), 0);
              return { norm, original, total };
            })
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

          if (tiposOrdenados.length > 0) {
            const datasets = faixasEtarias.map((faixa, idx) => {
              return {
                label: faixa + ' anos',
                data: tiposOrdenados.map(({ norm }) => correlacao[norm]?.[faixa] || 0),
                backgroundColor: colors[idx % colors.length],
                borderColor: colors[idx % colors.length].replace('0.8', '1'),
                borderWidth: 2
              };
            });

            const labels = tiposOrdenados.map(({ original }) => original);
            renderGroupedBarChart('chartCorrelacaoTipoIdade', labels, datasets);
          }
        }

        // Gráfico: Comparativo Temporal (Últimos 6 Meses vs Período Anterior)
        if (columnNames.data || columnNames.dataNT) {
          const dataCol = columnNames.data || columnNames.dataNT;
          const agora = new Date();
          const mesAtual = agora.getMonth();
          const anoAtual = agora.getFullYear();

          // Função auxiliar para calcular mês e ano corretamente
          const calcularMesAno = (mesesAtras) => {
            const dataAlvo = new Date(anoAtual, mesAtual - mesesAtras, 1);
            return {
              mes: dataAlvo.getMonth(),
              ano: dataAlvo.getFullYear()
            };
          };

          // Últimos 6 meses (0 a 5 meses atrás)
          const ultimos6Meses = {};
          for (let i = 0; i < 6; i++) {
            const { mes, ano } = calcularMesAno(i);
            const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
            ultimos6Meses[key] = { mes, ano, count: 0 };
          }

          // Período anterior (6 a 11 meses atrás)
          const periodoAnterior = {};
          for (let i = 6; i < 12; i++) {
            const { mes, ano } = calcularMesAno(i);
            const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
            periodoAnterior[key] = { mes, ano, count: 0 };
          }

          // Conta os casos - INCLUI TODOS os dados que caem nos períodos
          data.forEach(row => {
            const rawData = row[dataCol];
            if (!rawData) return;

            const date = parseDateCell(rawData);
            if (!date || isNaN(date.getTime())) return;

            const rowMes = date.getMonth();
            const rowAno = date.getFullYear();
            const key = `${rowAno}-${String(rowMes + 1).padStart(2, '0')}`;

            // Verifica se o registro cai em algum dos períodos definidos
            if (ultimos6Meses[key]) {
              ultimos6Meses[key].count++;
            } else if (periodoAnterior[key]) {
              periodoAnterior[key].count++;
            }
          });

          // Prepara dados para o gráfico
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          const labels = [];
          const dadosUltimos6 = [];
          const dadosAnterior = [];

          // Ordena por data (mais antigo primeiro)
          const sortedUltimos6 = Object.entries(ultimos6Meses)
            .sort((a, b) => a[0].localeCompare(b[0]));
          const sortedAnterior = Object.entries(periodoAnterior)
            .sort((a, b) => a[0].localeCompare(b[0]));

          // Cria um mapa do período anterior usando a chave completa (ano-mês)
          const anteriorPorChave = {};
          sortedAnterior.forEach(([key, { mes, ano, count }]) => {
            anteriorPorChave[key] = count;
          });

          // Alinha os dados: para cada mês dos últimos 6, busca o mês correspondente do período anterior
          // O período anterior é exatamente 6 meses antes, então precisamos mapear corretamente
          sortedUltimos6.forEach(([keyUltimos6, { mes: mesUltimos6, ano: anoUltimos6, count: countUltimos6 }]) => {
            // Calcula o mês correspondente no período anterior (6 meses antes)
            const dataAnterior = new Date(anoUltimos6, mesUltimos6 - 6, 1);
            const mesAnterior = dataAnterior.getMonth();
            const anoAnterior = dataAnterior.getFullYear();
            const keyAnterior = `${anoAnterior}-${String(mesAnterior + 1).padStart(2, '0')}`;

            labels.push(meses[mesUltimos6]);
            dadosUltimos6.push(countUltimos6);
            // Busca o count do período anterior usando a chave calculada
            dadosAnterior.push(anteriorPorChave[keyAnterior] || 0);
          });

          if (labels.length > 0) {
            // Calcula os períodos reais para as legendas dinâmicas
            const primeiroMesUltimos6 = sortedUltimos6[0][1].mes;
            const ultimoMesUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].mes;
            const primeiroAnoUltimos6 = sortedUltimos6[0][1].ano;
            const ultimoAnoUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].ano;

            const primeiroMesAnterior = sortedAnterior[0][1].mes;
            const ultimoMesAnterior = sortedAnterior[sortedAnterior.length - 1][1].mes;
            const primeiroAnoAnterior = sortedAnterior[0][1].ano;
            const ultimoAnoAnterior = sortedAnterior[sortedAnterior.length - 1][1].ano;

            // Cria labels dinâmicas
            let labelUltimos6 = '';
            let labelAnterior = '';

            // Se os meses estão no mesmo ano
            if (primeiroAnoUltimos6 === ultimoAnoUltimos6) {
              labelUltimos6 = `${meses[primeiroMesUltimos6]}-${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
            } else {
              labelUltimos6 = `${meses[primeiroMesUltimos6]} ${primeiroAnoUltimos6} - ${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
            }

            if (primeiroAnoAnterior === ultimoAnoAnterior) {
              labelAnterior = `${meses[primeiroMesAnterior]}-${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
            } else {
              labelAnterior = `${meses[primeiroMesAnterior]} ${primeiroAnoAnterior} - ${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
            }

            renderComparativeLineChart('chartComparativoTemporal', labels, dadosUltimos6, dadosAnterior, labelUltimos6, labelAnterior);
          }
        }

        // Gráfico: Tendência Anual (Comparação Ano Atual vs Ano Anterior)
        if (columnNames.data || columnNames.dataNT) {
          const dataCol = columnNames.data || columnNames.dataNT;
          const agora = new Date();
          const anoAtual = agora.getFullYear();
          const anoAnterior = anoAtual - 1;

          const dadosAnoAtual = {};
          const dadosAnoAnterior = {};

          // Inicializa todos os meses
          for (let mes = 0; mes < 12; mes++) {
            dadosAnoAtual[mes] = 0;
            dadosAnoAnterior[mes] = 0;
          }

          // Conta os casos
          data.forEach(row => {
            const rawData = row[dataCol];
            if (!rawData) return;

            const date = parseDateCell(rawData);
            if (!date || isNaN(date.getTime())) return;

            const rowMes = date.getMonth();
            const rowAno = date.getFullYear();

            if (rowAno === anoAtual && dadosAnoAtual[rowMes] !== undefined) {
              dadosAnoAtual[rowMes]++;
            } else if (rowAno === anoAnterior && dadosAnoAnterior[rowMes] !== undefined) {
              dadosAnoAnterior[rowMes]++;
            }
          });

          // Prepara dados para o gráfico
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          const labels = meses;
          const dadosAtual = Object.values(dadosAnoAtual);
          const dadosAnterior = Object.values(dadosAnoAnterior);

          renderComparativeLineChart('chartTendenciaAnual', labels, dadosAtual, dadosAnterior, `Ano ${anoAtual}`, `Ano ${anoAnterior}`);
        }

        // Limpeza final de skeletons para gráficos não renderizados
        const allChartIds = [
          'chartTipoViolencia', 'chartTipoViolenciaInstitucional', 'chartRegiao', 'chartEscola',
          'chartIdade', 'chartGenero', 'chartRaca', 'chartTemporal',
          'chartEncaminhamento', 'chartAutor', 'chartOcorreuEscola',
          'chartCorrelacaoTipoIdade', 'chartComparativoTemporal', 'chartTendenciaAnual'
        ];
        allChartIds.forEach(id => hideSkeleton(id));
      }

      // Função para aplicar filtros baseado no clique do gráfico
      function aplicarFiltroDoGrafico(tipoGrafico, valor) {
        console.log('[aplicarFiltroDoGrafico] Chamado com:', tipoGrafico, valor);

        // Limpa filtros anteriores relacionados
        const filtrosRelacionados = {
          'chartTipoViolencia': ['tipoViolencia'],
          'chartTipoViolenciaInstitucional': ['violenciaInstitucional'],
          'chartRegiao': ['regiao'],
          'chartEscola': ['escola'],
          'chartIdade': ['idade'],
          'chartGenero': ['genero'],
          'chartRaca': ['raca'],
          'chartEncaminhamento': ['encaminhamento'],
          'chartAutor': ['profissionalAutor', 'estudanteAutor'],
          'chartOcorreuEscola': ['ocorreuEscola'],
          'chartTemporal': ['data'],
          'chartComparativoTemporal': ['data'],
          'chartTendenciaAnual': ['data']
        };

        // Limpa checkboxes relacionados
        if (filtrosRelacionados[tipoGrafico]) {
          filtrosRelacionados[tipoGrafico].forEach(filtro => {
            const checkboxes = document.querySelectorAll(`input[data-filter="${filtro}"]`);
            checkboxes.forEach(cb => cb.checked = false);
            // Só atualiza badge se existir
            const badge = document.getElementById(`badge-${filtro}`);
            if (badge) {
              updateBadge(filtro);
            }
          });
        }

        // Limpa filtros de select também
        if (tipoGrafico === 'chartAutor') {
          const filterProf = document.getElementById('filterProfissionalAutor');
          const filterEst = document.getElementById('filterEstudanteAutor');
          if (filterProf) filterProf.value = '';
          if (filterEst) filterEst.value = '';
        }
        if (tipoGrafico === 'chartOcorreuEscola') {
          const filterOcorreu = document.getElementById('filterOcorreuEscola');
          if (filterOcorreu) filterOcorreu.value = '';
        }
        if (tipoGrafico === 'chartIdade') {
          const filterIdadeMin = document.getElementById('filterIdadeMin');
          const filterIdadeMax = document.getElementById('filterIdadeMax');
          if (filterIdadeMin) filterIdadeMin.value = '';
          if (filterIdadeMax) filterIdadeMax.value = '';
        }
        if (tipoGrafico === 'chartTemporal' || tipoGrafico === 'chartComparativoTemporal' || tipoGrafico === 'chartTendenciaAnual') {
          const filterDataInicio = document.getElementById('filterDataInicio');
          const filterDataFim = document.getElementById('filterDataFim');
          if (filterDataInicio) filterDataInicio.value = '';
          if (filterDataFim) filterDataFim.value = '';
        }

        // Normaliza o valor para comparação
        const valorNormalizado = normalizeText(valor);

        // Aplica filtro específico baseado no tipo de gráfico
        switch (tipoGrafico) {
          case 'chartTipoViolencia':
            // Marca checkbox do tipo de violência (usa data-filter e data-value com normalização)
            const tipoCheckboxes = document.querySelectorAll(`input[data-filter="tipoViolencia"]`);
            tipoCheckboxes.forEach(cb => {
              const cbValueNorm = normalizeText(cb.dataset.value || '');
              if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
                cb.checked = true;
              }
            });
            updateBadge('tipoViolencia');
            // Verifica se precisa mostrar card de Violências Institucionais
            setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
            break;

          case 'chartRegiao':
            const regiaoCheckboxes = document.querySelectorAll(`input[data-filter="regiao"]`);
            regiaoCheckboxes.forEach(cb => {
              const cbValueNorm = normalizeText(cb.dataset.value || '');
              if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
                cb.checked = true;
              }
            });
            updateBadge('regiao');
            break;

          case 'chartEscola':
            const escolaCheckboxes = document.querySelectorAll(`input[data-filter="escola"]`);
            escolaCheckboxes.forEach(cb => {
              const cbValueNorm = normalizeText(cb.dataset.value || '');
              if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
                cb.checked = true;
              }
            });
            updateBadge('escola');
            break;

          case 'chartGenero':
            // Para gênero, precisa mapear valores do gráfico para valores dos checkboxes
            let generoValor = valor;
            if (valor === 'Masculino' || valor === 'M') generoValor = 'M';
            if (valor === 'Feminino' || valor === 'F') generoValor = 'F';

            const generoCheckboxes = document.querySelectorAll(`input[data-filter="genero"]`);
            generoCheckboxes.forEach(cb => {
              const cbValue = cb.dataset.value || '';
              if (cbValue.toUpperCase() === generoValor.toUpperCase() || cbValue === valor) {
                cb.checked = true;
              }
            });
            updateBadge('genero');
            break;

          case 'chartRaca':
            const racaCheckboxes = document.querySelectorAll(`input[data-filter="raca"]`);
            racaCheckboxes.forEach(cb => {
              const cbValueNorm = normalizeText(cb.dataset.value || '');
              if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
                cb.checked = true;
              }
            });
            updateBadge('raca');
            break;

          case 'chartTipoViolenciaInstitucional':
            // Primeiro, garante que "Institucional" está selecionado no tipo de violência
            const tipoViolenciaCheckboxes = document.querySelectorAll(`input[data-filter="tipoViolencia"]`);
            let temInstitucional = false;
            tipoViolenciaCheckboxes.forEach(cb => {
              const cbValue = (cb.dataset.value || '').toLowerCase();
              if (cbValue === 'institucional' || cbValue.includes('institucional')) {
                cb.checked = true;
                temInstitucional = true;
              }
            });
            if (temInstitucional) {
              updateBadge('tipoViolencia');
              // Verifica e mostra o card de Violências Institucionais se necessário
              setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
            }

            // Marca o checkbox de violência institucional específico
            const violenciaInstCheckboxes = document.querySelectorAll(`input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)`);
            violenciaInstCheckboxes.forEach(cb => {
              const cbValueNorm = normalizeText(cb.dataset.value || '');
              if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
                cb.checked = true;
              }
            });

            // Atualiza o checkbox geral se todos estiverem marcados
            const allViolenciaInstCheckboxes = document.querySelectorAll(`input[data-filter="violenciaInstitucional"]:not(#checkbox-violencia-institucional-geral)`);
            const checkedCount = Array.from(allViolenciaInstCheckboxes).filter(cb => cb.checked).length;
            const grupoGeral = document.getElementById('checkbox-violencia-institucional-geral');
            if (grupoGeral) {
              grupoGeral.checked = checkedCount === allViolenciaInstCheckboxes.length;
              grupoGeral.indeterminate = checkedCount > 0 && checkedCount < allViolenciaInstCheckboxes.length;
            }

            updateBadgeViolenciaInstitucionalTotal();
            break;

          case 'chartEncaminhamento':
            // Encaminhamento usa data-group e data-value nos checkboxes individuais
            // O gráfico mostra valores originais (mapaNormalizado), mas precisa encontrar checkboxes
            // Primeiro desmarca todos os checkboxes de encaminhamento
            const allEncCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]');
            allEncCheckboxes.forEach(cb => cb.checked = false);

            // Normaliza o valor clicado para comparação
            const valorNorm = normalizeText(valor);
            const valorLower = valor.toLowerCase().trim();

            // Procura checkboxes que correspondem EXATAMENTE ao valor clicado
            // O valor do gráfico é o valor original (ex: "CT", "CRAS", etc.)
            // Prioriza correspondência exata para evitar falsos positivos
            let encontrado = false;

            // Primeira passagem: busca exata (mais precisa)
            allEncCheckboxes.forEach(cb => {
              const cbValue = (cb.dataset.value || '').trim();
              if (!cbValue) return;

              const cbValueNorm = normalizeText(cbValue);
              const cbValueLower = cbValue.toLowerCase().trim();

              // Compara valores exatos primeiro (mais preciso)
              if (cbValue === valor ||
                cbValueNorm === valorNorm ||
                cbValueLower === valorLower) {
                cb.checked = true;
                encontrado = true;
              }
            });

            // Segunda passagem: busca parcial apenas se não encontrou exato
            // Mas apenas se o valor é uma substring completa (não apenas parte de uma palavra)
            if (!encontrado) {
              allEncCheckboxes.forEach(cb => {
                const cbValue = (cb.dataset.value || '').trim();
                if (!cbValue) return;

                const cbValueNorm = normalizeText(cbValue);

                // Busca parcial: verifica se o valor normalizado corresponde exatamente
                // ou se um é substring completa do outro (evita falsos positivos)
                // Só marca se for correspondência exata ou substring no início/fim com espaço ou barra
                const valorIsSubstring = cbValueNorm === valorNorm ||
                  (cbValueNorm.includes(valorNorm) &&
                    (cbValueNorm.startsWith(valorNorm + ' ') ||
                      cbValueNorm.endsWith(' ' + valorNorm) ||
                      cbValueNorm.startsWith(valorNorm + '/') ||
                      cbValueNorm.endsWith('/' + valorNorm) ||
                      cbValueNorm.startsWith(valorNorm + ',') ||
                      cbValueNorm.endsWith(',' + valorNorm)));
                const cbIsSubstring = valorNorm === cbValueNorm ||
                  (valorNorm.includes(cbValueNorm) &&
                    (valorNorm.startsWith(cbValueNorm + ' ') ||
                      valorNorm.endsWith(' ' + cbValueNorm) ||
                      valorNorm.startsWith(cbValueNorm + '/') ||
                      valorNorm.endsWith('/' + cbValueNorm) ||
                      valorNorm.startsWith(cbValueNorm + ',') ||
                      valorNorm.endsWith(',' + cbValueNorm)));

                if (valorIsSubstring || cbIsSubstring) {
                  cb.checked = true;
                  encontrado = true;
                }
              });
            }

            // Log para debug se não encontrou
            if (!encontrado) {
              console.warn('[Filtro Encaminhamento] Não encontrou checkbox para:', valor);
              const valoresDisponiveis = Array.from(allEncCheckboxes).slice(0, 10).map(cb => cb.dataset.value);
              console.log('[Filtro Encaminhamento] Primeiros 10 checkboxes disponíveis:', valoresDisponiveis);
            }

            // Atualiza badge e grupos
            const encSelected = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
            const encBadge = document.getElementById('badge-encaminhamento-total');
            if (encBadge) {
              if (encSelected.length > 0) {
                encBadge.textContent = encSelected.length;
                encBadge.classList.remove('hidden');
              } else {
                encBadge.classList.add('hidden');
              }
            }

            // Atualiza grupos que têm checkboxes marcados
            const grupos = new Set();
            encSelected.forEach(cb => {
              const groupId = cb.closest('.encaminhamento-group')?.dataset.group;
              if (groupId) grupos.add(groupId);
            });
            grupos.forEach(groupId => {
              const groupCheckbox = document.getElementById(`group-${groupId}`);
              if (groupCheckbox) {
                const groupCheckboxes = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]`);
                const groupChecked = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]:checked`);
                groupCheckbox.checked = groupChecked.length > 0;
                groupCheckbox.indeterminate = groupChecked.length > 0 && groupChecked.length < groupCheckboxes.length;
              }
            });
            break;

          case 'chartAutor':
            console.log('[Filtro Autor] Aplicando filtro para:', valor);
            const filterProf = document.getElementById('filterProfissionalAutor');
            const filterEst = document.getElementById('filterEstudanteAutor');
            // Limpa ambos primeiro
            if (filterProf) filterProf.value = '';
            if (filterEst) filterEst.value = '';
            // Depois define conforme o valor clicado
            if (valor === 'Profissional da Escola' && filterProf) {
              filterProf.value = 'S';
              console.log('[Filtro Autor] Definido: profissionalAutor = S');
            } else if (valor === 'Estudante' && filterEst) {
              filterEst.value = 'S';
              console.log('[Filtro Autor] Definido: estudanteAutor = S');
            } else if (valor === 'Outro Agente (Fora da Instituição)') {
              if (filterProf) filterProf.value = 'N';
              if (filterEst) filterEst.value = 'N';
              console.log('[Filtro Autor] Definido: profissionalAutor = N, estudanteAutor = N');
            } else {
              console.warn('[Filtro Autor] Valor não reconhecido:', valor);
            }
            break;

          case 'chartOcorreuEscola':
            console.log('[Filtro OcorreuEscola] Aplicando filtro para:', valor);
            const filterOcorreu = document.getElementById('filterOcorreuEscola');
            const ocorreuContainer = document.getElementById('filterOcorreuEscolaContainer');
            if (filterOcorreu) {
              // Garante que o select está habilitado e visível (independente de filterViolenciaInformada)
              filterOcorreu.disabled = false;
              if (ocorreuContainer) {
                ocorreuContainer.classList.remove('hidden');
                ocorreuContainer.style.height = '';
                ocorreuContainer.style.opacity = '1';
                ocorreuContainer.style.transform = '';
              }
              // Limpa primeiro
              filterOcorreu.value = '';
              // Depois define conforme o valor clicado
              if (valor === 'Sim') {
                filterOcorreu.value = 'S';
                console.log('[Filtro OcorreuEscola] Definido: ocorreu = S');
              } else if (valor === 'Não') {
                filterOcorreu.value = 'N';
                console.log('[Filtro OcorreuEscola] Definido: ocorreu = N');
              } else if (valor === 'Não Informado') {
                filterOcorreu.value = 'NI';
                console.log('[Filtro OcorreuEscola] Definido: ocorreu = NI (Não Informado)');
              } else {
                console.warn('[Filtro OcorreuEscola] Valor não reconhecido:', valor);
              }
            } else {
              console.error('[Filtro OcorreuEscola] Elemento filterOcorreuEscola não encontrado');
            }
            break;

          case 'chartIdade':
            // Para idade, precisa extrair a faixa etária (formato: "0-5 anos", "6-10 anos", "18+ anos")
            const idadeMatch = valor.match(/(\d+)-(\d+)/);
            if (idadeMatch) {
              const filterIdadeMin = document.getElementById('filterIdadeMin');
              const filterIdadeMax = document.getElementById('filterIdadeMax');
              if (filterIdadeMin) filterIdadeMin.value = idadeMatch[1];
              if (filterIdadeMax) filterIdadeMax.value = idadeMatch[2];
            } else if (valor.includes('18+')) {
              // Para 18+ anos, define mínimo como 18 e máximo vazio
              const filterIdadeMin = document.getElementById('filterIdadeMin');
              const filterIdadeMax = document.getElementById('filterIdadeMax');
              if (filterIdadeMin) filterIdadeMin.value = '18';
              if (filterIdadeMax) filterIdadeMax.value = '';
            }
            break;

          case 'chartTemporal':
          case 'chartComparativoTemporal':
          case 'chartTendenciaAnual':
            // Para gráficos temporais, filtra por mês
            // Suporta formatos: "Nov/2025" (com ano) e "Nov" (sem ano)
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const mesValor = valor.trim();

            let mesNum = 0;
            let anoFiltro = 0;

            // Verifica se o label contém o ano (formato: "Mês/Ano")
            const partesMesAno = mesValor.split('/');
            if (partesMesAno.length === 2 && partesMesAno[1].length === 4) {
              // Formato "Nov/2025"
              mesNum = meses.indexOf(partesMesAno[0]) + 1;
              anoFiltro = parseInt(partesMesAno[1], 10);
            } else {
              // Formato "Nov" (sem ano) — busca na data real
              mesNum = meses.indexOf(mesValor) + 1;

              if (mesNum > 0) {
                // Busca o ano mais recente nos dados que tenha registros neste mês
                const dataCol = columnNames.dataNT || columnNames.data;
                if (dataCol) {
                  let melhorAno = 0;
                  originalData.forEach(row => {
                    const date = parseDateCell(row[dataCol]);
                    if (date && (date.getMonth() + 1) === mesNum) {
                      if (date.getFullYear() > melhorAno) {
                        melhorAno = date.getFullYear();
                      }
                    }
                  });
                  anoFiltro = melhorAno || new Date().getFullYear();
                } else {
                  anoFiltro = new Date().getFullYear();
                }
              }
            }

            if (mesNum > 0 && anoFiltro > 0) {
              const dataInicio = `${anoFiltro}-${String(mesNum).padStart(2, '0')}-01`;
              const ultimoDia = new Date(anoFiltro, mesNum, 0).getDate();
              const dataFim = `${anoFiltro}-${String(mesNum).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`;

              const filterDataInicio = document.getElementById('filterDataInicio');
              const filterDataFim = document.getElementById('filterDataFim');
              if (filterDataInicio) filterDataInicio.value = dataInicio;
              if (filterDataFim) filterDataFim.value = dataFim;
              console.log(`[Filtro ${tipoGrafico}] Aplicando filtro para mês ${mesValor}: ${dataInicio} até ${dataFim}`);
            } else {
              console.error(`[Filtro ${tipoGrafico}] Mês não encontrado:`, mesValor);
            }
            break;
        }

        // Aplica filtros e rola até a tabela
        console.log('[aplicarFiltroDoGrafico] Aplicando filtros após configurar:', tipoGrafico, 'valor:', valor);

        // Se for gráfico de Tipo Violência ou Violência Institucional, verifica se precisa mostrar card de Violências Institucionais
        if (tipoGrafico === 'chartTipoViolencia' || tipoGrafico === 'chartTipoViolenciaInstitucional') {
          setTimeout(verificarViolenciaInstitucionalNoFiltro, 100);
        }

        applyFilters();

        // Aguarda um pouco para garantir que os filtros foram aplicados e a tabela foi atualizada
        setTimeout(() => {
          const tableContainer = document.getElementById('tableContainer');
          if (tableContainer) {
            tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          const count = filteredData ? filteredData.length : 0;
          console.log('[aplicarFiltroDoGrafico] ✅ Filtros aplicados! Registros filtrados:', count);
          if (count === 0) {
            console.warn('[aplicarFiltroDoGrafico] ⚠️ Nenhum registro encontrado após filtrar por:', valor);
          }
        }, 150);
      }

      function renderPieChart(canvasId, data, colors) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        const labels = data.map(([k]) => k);
        const valores = data.map(([, v]) => v);

        charts[canvasId] = new Chart(canvas, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: valores,
              backgroundColor: colors,
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              console.log('[Gráfico Pizza] Clique detectado no gráfico:', canvasId);
              console.log('[Gráfico Pizza] Elements recebidos:', elements);
              if (elements && elements.length > 0) {
                const index = elements[0].index;
                const label = labels[index];
                console.log('[Gráfico Pizza] Label clicado:', label, 'Index:', index);
                aplicarFiltroDoGrafico(canvasId, label);
              } else {
                console.warn('[Gráfico Pizza] Nenhum elemento encontrado no clique. Tentando método alternativo...');
                // Método alternativo: tenta detectar clique usando getElementsAtEventForMode
                const chart = charts[canvasId];
                if (chart) {
                  const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                  if (points && points.length > 0) {
                    const point = points[0];
                    const label = labels[point.index];
                    console.log('[Gráfico Pizza] Label encontrado via método alternativo:', label);
                    aplicarFiltroDoGrafico(canvasId, label);
                  } else {
                    console.error('[Gráfico Pizza] Não foi possível detectar o elemento clicado');
                  }
                }
              }
            },
            onHover: (event, elements) => {
              // Muda cursor para pointer quando hover
              if (event.native && event.native.target) {
                event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
              }
            },
            plugins: {
              datalabels: {
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 12
                },
                formatter: (value, ctx) => {
                  return value;
                },
                display: 'auto'
              },
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: { size: 11 }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                callbacks: {
                  label: function (context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} caso${value !== 1 ? 's' : ''} (${percentage}%)`;
                  },
                  footer: function (context) {
                    const total = context.reduce((sum, item) => sum + (item.parsed || 0), 0);
                    return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                  }
                }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      function renderBarChart(canvasId, data, colors) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        const labels = data.map(([k]) => k);
        const valores = data.map(([, v]) => v);

        charts[canvasId] = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: valores,
              backgroundColor: colors[0],
              borderColor: colors[0].replace('0.8', '1'),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const label = labels[index];
                aplicarFiltroDoGrafico(canvasId, label);
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                callbacks: {
                  title: function (context) {
                    return context[0].label;
                  },
                  label: function (context) {
                    const valor = context.parsed.y;
                    return `${valor} caso${valor !== 1 ? 's' : ''}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      function renderHorizontalBarChartGrouped(canvasId, data, colors) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        const labels = data.map(([k]) => k);
        const valores = data.map(([, v]) => v);

        charts[canvasId] = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Casos',
              data: valores,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.8', '1')),
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000,
              easing: 'easeOutQuart'
            },
            onClick: (event, elements) => {
              console.log('[Gráfico Encaminhamento] Clique detectado no gráfico:', canvasId);
              console.log('[Gráfico Encaminhamento] Elements recebidos:', elements);
              if (elements && elements.length > 0) {
                const index = elements[0].index;
                const label = labels[index];
                console.log('[Gráfico Encaminhamento] Label clicado:', label, 'Index:', index);
                aplicarFiltroDoGrafico(canvasId, label);
              } else {
                console.warn('[Gráfico Encaminhamento] Nenhum elemento encontrado no clique');
              }
            },
            onHover: (event, elements) => {
              if (event.native && event.native.target) {
                event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  title: function (context) {
                    return context[0].label;
                  },
                  label: function (context) {
                    const valor = context.parsed.x;
                    return `${valor} caso${valor !== 1 ? 's' : ''}`;
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)',
                  drawBorder: false
                }
              },
              y: {
                ticks: {
                  font: { size: 11 },
                  padding: 8
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      function renderHorizontalBarChart(canvasId, data, colors) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        const labels = data.map(([k]) => k);
        const valores = data.map(([, v]) => v);

        // Cores alternadas para melhor visualização
        const backgroundColors = valores.map((_, index) => {
          return colors[index % colors.length];
        });

        charts[canvasId] = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade',
              data: valores,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y', // Barras horizontais
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const label = labels[index];
                aplicarFiltroDoGrafico(canvasId, label);
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `Casos: ${context.parsed.x}`;
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      // Renderiza gráfico de barras agrupadas (para correlações)
      function renderGroupedBarChart(canvasId, labels, datasets) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
          delete charts[canvasId];
        }

        const ctx = canvas.getContext('2d');
        charts[canvasId] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  padding: 15,
                  font: { size: 12, weight: 'bold' }
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function (context) {
                    return context.dataset.label + ': ' + context.parsed.y + ' casos';
                  }
                }
              }
            },
            scales: {
              x: {
                stacked: false,
                ticks: {
                  font: { size: 11 },
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: {
                  display: false
                }
              },
              y: {
                stacked: false,
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 }
                },
                title: {
                  display: true,
                  text: 'Quantidade de Casos',
                  font: { size: 12, weight: 'bold' }
                }
              }
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const element = elements[0];
                const datasetIndex = element.datasetIndex;
                const index = element.index;
                const label = labels[index];
                const datasetLabel = datasets[datasetIndex].label;
                aplicarFiltroDoGrafico('chartCorrelacaoTipoIdade', `${label} - ${datasetLabel}`);
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      // Renderiza gráfico comparativo de linhas (para análises temporais)
      function renderComparativeLineChart(canvasId, labels, data1, data2, label1 = 'Período 1', label2 = 'Período 2') {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
          delete charts[canvasId];
        }

        const ctx = canvas.getContext('2d');
        charts[canvasId] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: label1,
                data: data1,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              },
              {
                label: label2,
                data: data2,
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  padding: 15,
                  font: { size: 13, weight: 'bold' },
                  usePointStyle: true,
                  pointStyle: 'circle',
                  boxWidth: 12,
                  boxHeight: 12
                },
                onClick: (e, legendItem, legend) => {
                  // Permite clicar na legenda para mostrar/ocultar datasets
                  const index = legendItem.datasetIndex;
                  const chart = legend.chart;
                  const meta = chart.getDatasetMeta(index);
                  meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                  chart.update();
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                callbacks: {
                  title: function (context) {
                    return 'Mês: ' + context[0].label;
                  },
                  label: function (context) {
                    return context.dataset.label + ': ' + context.parsed.y + ' caso' + (context.parsed.y !== 1 ? 's' : '');
                  },
                  footer: function (context) {
                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                    return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  font: { size: 11 },
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: {
                  display: false
                }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 }
                },
                title: {
                  display: true,
                  text: 'Quantidade de Casos',
                  font: { size: 12, weight: 'bold' }
                }
              }
            },
            onClick: (event, elements) => {
              console.log('[Gráfico Comparativo] Clique detectado no gráfico:', canvasId);
              console.log('[Gráfico Comparativo] Elements recebidos:', elements);

              if (elements && elements.length > 0) {
                const element = elements[0];
                const index = element.index;
                const label = labels[index];
                console.log('[Gráfico Comparativo] Label clicado:', label, 'Index:', index);
                aplicarFiltroDoGrafico(canvasId, label);
              } else {
                console.warn('[Gráfico Comparativo] Nenhum elemento encontrado no clique. Tentando método alternativo...');
                // Método alternativo para gráfico de linha comparativo
                const chart = charts[canvasId];
                if (chart) {
                  const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                  if (points && points.length > 0) {
                    const point = points[0];
                    const label = labels[point.index];
                    console.log('[Gráfico Comparativo] Label encontrado via método alternativo:', label);
                    aplicarFiltroDoGrafico(canvasId, label);
                  } else {
                    console.error('[Gráfico Comparativo] Não foi possível detectar o elemento clicado');
                  }
                }
              }
            },
            onHover: (event, elements) => {
              // Muda cursor para pointer quando hover sobre pontos
              if (event.native && event.native.target) {
                const chart = charts[canvasId];
                if (chart) {
                  const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                  event.native.target.style.cursor = points && points.length > 0 ? 'pointer' : 'default';
                }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      function renderLineChart(canvasId, labels, valores) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        // Destroi gráfico anterior se existir
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        charts[canvasId] = new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Casos por Mês',
              data: valores,
              borderColor: 'rgba(59, 130, 246, 1)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              console.log('[Gráfico Linha] Clique detectado no gráfico:', canvasId);
              console.log('[Gráfico Linha] Elements recebidos:', elements);
              if (elements && elements.length > 0) {
                const index = elements[0].index;
                const label = labels[index];
                console.log('[Gráfico Linha] Label clicado:', label, 'Index:', index);
                aplicarFiltroDoGrafico(canvasId, label);
              } else {
                console.warn('[Gráfico Linha] Nenhum elemento encontrado no clique. Tentando método alternativo...');
                // Método alternativo para gráfico de linha
                const chart = charts[canvasId];
                if (chart) {
                  const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                  if (points && points.length > 0) {
                    const point = points[0];
                    const label = labels[point.index];
                    console.log('[Gráfico Linha] Label encontrado via método alternativo:', label);
                    aplicarFiltroDoGrafico(canvasId, label);
                  } else {
                    console.error('[Gráfico Linha] Não foi possível detectar o elemento clicado');
                  }
                }
              }
            },
            onHover: (event, elements) => {
              // Muda cursor para pointer quando hover
              if (event.native && event.native.target) {
                event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
              }
            },
            plugins: {
              legend: {
                display: true,
                labels: {
                  font: { size: 12, weight: 'bold' },
                  usePointStyle: true
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                callbacks: {
                  title: function (context) {
                    return 'Mês: ' + context[0].label;
                  },
                  label: function (context) {
                    const valor = context.parsed.y;
                    return `${context.dataset.label}: ${valor} caso${valor !== 1 ? 's' : ''}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
        hideSkeleton(canvasId);
      }

      // ==============================
      // FUNÇÕES DE ESTILO (Redesign)
      // ==============================

      // Helper para cores de badges de violência
      function getViolenceBadgeStyle(tipo) {
        if (!tipo) return 'bg-gray-100 text-gray-500 border border-gray-200';
        const t = normalizeText(tipo);

        // Física, Tortura -> Vermelho (Alerta Máximo)
        if (t.includes('fisica') || t.includes('tortura')) {
          return 'bg-red-50 text-red-700 border border-red-100';
        }
        // Sexual -> Roxo (Gravidade Alta/Distinta)
        if (t.includes('sexual')) {
          return 'bg-purple-50 text-purple-700 border border-purple-100';
        }
        // Psicológica -> Laranja (Alerta Médio)
        if (t.includes('psicologica')) {
          return 'bg-orange-50 text-orange-700 border border-orange-100';
        }
        // Negligência -> Amarelo (Atenção)
        if (t.includes('negligencia')) {
          return 'bg-yellow-50 text-yellow-700 border border-yellow-100';
        }
        // Autoagressão -> Rose
        if (t.includes('autoagressao') || t.includes('suicidio')) {
          return 'bg-rose-50 text-rose-700 border border-rose-100';
        }
        // Institucional -> Slate (Neutro/System)
        if (t.includes('institucional')) {
          return 'bg-slate-100 text-slate-700 border border-slate-200';
        }

        // Padrão -> Azul Suave
        return 'bg-blue-50 text-blue-700 border border-blue-100';
      }

      // Helper para cores de badges de Escola (CMEI vs EMEF)
      function getSchoolBadgeStyle(nomeEscola) {
        if (!nomeEscola) return 'bg-gray-50 text-gray-500 border border-gray-200';
        const tipo = getTipoInstituicao(nomeEscola); // Usa função existente

        if (tipo === 'CMEI') {
          return 'bg-sky-50 text-sky-700 border border-sky-100'; // Azul Céu para CMEI
        }
        if (tipo === 'EMEF') {
          return 'bg-indigo-50 text-indigo-700 border border-indigo-100'; // Indigo para EMEF
        }
        return 'bg-gray-50 text-gray-600 border border-gray-100'; // Outros
      }

      function renderGenericBadge(text, styleClass) {
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium ${styleClass} whitespace-nowrap shadow-sm">${text}</span>`;
      }

      function renderReferralTags(encaminhamentos) {
        if (!encaminhamentos || encaminhamentos === 'Não informado') return '<span class="text-gray-300 text-xs">-</span>';

        let lista = [];
        if (Array.isArray(encaminhamentos)) {
          lista = encaminhamentos;
        } else {
          lista = String(encaminhamentos)
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(Boolean);
        }

        if (lista.length === 0) return '<span class="text-gray-300 text-xs">-</span>';

        // Pega o primeiro e conta o resto
        const primeiro = lista[0];
        const restantes = lista.slice(1);
        const count = restantes.length;

        // Badge azul suave para o primeiro item
        let html = `<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100 whitespace-nowrap truncate max-w-[12ch]" title="${primeiro}">${primeiro}</span>`;

        if (count > 0) {
          const titleFull = restantes.join(', ');
          html += `<span class="ml-1 inline-flex items-center justify-center px-1.5 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200 cursor-help" title="${titleFull}">+${count}</span>`;
        }
        // Centraliza o conteúdo flex
        return `<div class="flex items-center justify-center">${html}</div>`;
      }

      function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        const recordCount = document.getElementById('recordCount');
        const noResults = document.getElementById('noResultsMessage');

        tbody.innerHTML = '';
        recordCount.textContent = data.length;

        if (data.length === 0) {
          noResults.classList.remove('hidden');
          document.getElementById('paginacao').style.display = 'none';
          return;
        } else {
          noResults.classList.add('hidden');
          document.getElementById('paginacao').style.display = 'flex';
        }

        // Calcular total de páginas
        totalPaginas = Math.ceil(data.length / registrosPorPagina);

        // Garantir que a página atual seja válida
        if (paginaAtual > totalPaginas) {
          paginaAtual = totalPaginas;
        }
        if (paginaAtual < 1) {
          paginaAtual = 1;
        }

        // Calcular índices para slice
        const inicio = (paginaAtual - 1) * registrosPorPagina;
        const fim = inicio + registrosPorPagina;

        // Pegar apenas os registros da página atual
        const registrosPagina = data.slice(inicio, fim);

        registrosPagina.forEach((row, index) => {
          const tr = document.createElement('tr');
          // Row style
          tr.className = 'record-row border-b border-gray-100 hover:bg-blue-50/30 transition-colors duration-150 cursor-pointer group';
          tr.style.height = '60px'; // Aumentei um pouco para melhor respiro com badges

          // Ao clicar na linha, abre detalhes
          tr.addEventListener('click', () => abrirModalDetalhes(row));

          // 1. DADOS DA CRIANÇA (Esquerda - Âncora Visual)
          const nome = columnNames.crianca ? (row[columnNames.crianca] || 'Não informado') : 'Não informado';
          const idade = columnNames.idade ? (row[columnNames.idade] || '-') : '-';

          const nomeClass = nome === 'Não informado' ? 'text-gray-400 italic font-normal' : 'text-slate-900 font-semibold';
          const nomeHtml = `<div class="flex flex-col">
                              <div class="truncate max-w-[200px] ${nomeClass} text-sm" title="${nome}">${nome}</div>
                              <div class="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                                <span>${idade} anos</span>
                              </div>
                            </div>`;

          // 2. DATA (Centralizado)
          const dataViol = columnNames.data ? formatDate(row[columnNames.data]) : '-';
          const dataHtml = `<span class="text-xs font-medium text-gray-500 tabular-nums bg-gray-50 px-2 py-1 rounded border border-gray-100">${dataViol}</span>`;

          // 3. TIPO DE VIOLÊNCIA (Centralizado com Badges)
          const tipoRaw = columnNames.tipo ? (row[columnNames.tipo] || '') : '';
          const tiposLista = tipoRaw.split(',').map(t => t.trim()).filter(Boolean);
          let tipoHtml = '';
          if (tiposLista.length > 0) {
            const primeiroTipo = tiposLista[0];
            const style = getViolenceBadgeStyle(primeiroTipo);
            tipoHtml = renderGenericBadge(primeiroTipo, style);

            if (tiposLista.length > 1) {
              tipoHtml += `<span class="ml-1 text-xs text-gray-400 font-medium" title="${tiposLista.map(t => t).join(', ')}">+${tiposLista.length - 1}</span>`;
            }
          } else {
            tipoHtml = '<span class="text-gray-300">-</span>';
          }
          // Wrap para centralizar flex items se houver múltiplos
          if (tiposLista.length > 1) {
            tipoHtml = `<div class="flex items-center justify-center">${tipoHtml}</div>`;
          }


          // 4. ESCOLA (Centralizado com Badges de Tipo)
          const escolaOriginal = columnNames.escola ? (row[columnNames.escola] || '') : '';
          let escolaNome = escolaOriginal ? getDisplayName(escolaOriginal) : 'Não informado';
          let escolaHtml = '';

          if (escolaNome !== 'Não informado') {
            const schoolBadgeStyle = getSchoolBadgeStyle(escolaNome);
            // Extrair apenas o nome curto se desejar, ou usar badge no nome todo truncado
            escolaHtml = `<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${schoolBadgeStyle} truncate max-w-[140px]" title="${escolaNome}">
                             ${escolaNome}
                           </span>`;
          } else {
            escolaHtml = '<span class="text-gray-300 text-xs italic">-</span>';
          }


          // 5. REGIÃO (Centralizado)
          const regiao = columnNames.regiao ? (row[columnNames.regiao] || '-') : '-';
          const regiaoHtml = `<span class="text-xs text-gray-600 font-medium">${regiao}</span>`;

          // 6. ENCAMINHAMENTO (Centralizado via helper)
          const encaminhamentoRaw = columnNames.encaminhamento ? (row[columnNames.encaminhamento] || '') : '';
          const encaminhamentoHtml = renderReferralTags(encaminhamentoRaw);

          // 7. OCORREU NA ESCOLA (Centralizado Badge)
          let ocorreuNaEscola = '';
          // Critérios do usuário:
          // 1. A escola identificou que ocorreu na escola (violenciaEscolaOcorreu - Col Q)
          // 2. Um agente externo comunicou... QUE a violência ocorreu na escola (ocorreu - Col U)

          const identificou = columnNames.violenciaEscolaOcorreu ? (row[columnNames.violenciaEscolaOcorreu] || '') : '';
          const reportadoNaEscola = columnNames.ocorreu ? (row[columnNames.ocorreu] || '') : '';

          let flagOcorreu = false;

          // Se identificou na escola OU se foi reportado que ocorreu na escola
          if (checkSN(identificou, 'S') || checkSN(reportadoNaEscola, 'S')) {
            flagOcorreu = true;
          }

          const naEscolaHtml = flagOcorreu
            ? `<div class="flex justify-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-100">Sim</span></div>`
            : `<div class="flex justify-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">Não</span></div>`;


          // Array de Células
          const celulas = [
            { html: nomeHtml, align: 'left' },   // Nome
            { html: dataHtml, align: 'center' }, // Data
            { html: tipoHtml, align: 'center' }, // Violência
            { html: escolaHtml, align: 'center' }, // Escola
            { html: regiaoHtml, align: 'center' }, // Região
            { html: encaminhamentoHtml, align: 'center' }, // Encaminhamento
            { html: naEscolaHtml, align: 'center' }, // Na Escola
          ];

          celulas.forEach(cel => {
            const td = document.createElement('td');
            // Classes base
            let classes = 'px-4 py-3 align-middle text-sm whitespace-nowrap';

            // Alinhamento
            if (cel.align === 'center') classes += ' text-center';
            else classes += ' text-left';

            td.className = classes;
            td.innerHTML = cel.html;
            tr.appendChild(td);
          });

          // COLUNA DE AÇÃO (Direita)
          const tdAcao = document.createElement('td');
          tdAcao.className = 'px-4 py-3 align-middle text-center';
          const btnDetalhes = document.createElement('button');
          btnDetalhes.className = 'p-1.5 rounded-full text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-colors opacity-60 group-hover:opacity-100';
          btnDetalhes.title = 'Ver detalhes completos';
          btnDetalhes.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          `;
          btnDetalhes.addEventListener('click', function (e) {
            e.stopPropagation();
            abrirModalDetalhes(row);
          });
          tdAcao.appendChild(btnDetalhes);
          tr.appendChild(tdAcao);

          tbody.appendChild(tr);
        });

        // Atualizar controles de paginação
        updatePaginationControls();
      }

      // ==============================
      // MODAL DE DETALHES
      // ==============================
      function abrirModalDetalhes(record) {
        const modal = document.getElementById('modal-detalhes');
        const modalBody = document.getElementById('modal-detalhes-body');
        const modalTitulo = document.getElementById('modal-detalhes-titulo');
        const modalSubtitulo = document.getElementById('modal-detalhes-subtitulo');

        const nomeCrianca = record[columnNames.crianca] || record.Crianca || record.Criança || 'Registro';
        const idNotificacao = record.idNotificacao || record.ID || record.Id || record['ID Notificação'] || '';
        const dataNTValue = record[columnNames.data] || '';
        const dataNT = dataNTValue ? (formatDate(dataNTValue) || dataNTValue) : '';

        modalTitulo.textContent = nomeCrianca;
        modalSubtitulo.textContent = idNotificacao ? `ID: #${idNotificacao} • ${dataNT}` : (dataNT || 'Detalhes do Registro');

        const normalizeText = (v) => String(v || '').trim();
        const isEmptyValue = (v) => v === undefined || v === null || String(v).trim() === '' || String(v).trim() === 'Não informado';
        const toDisplay = (v) => isEmptyValue(v) ? 'Não informado' : String(v).trim();

        const toYesNoUnknown = (raw) => {
          const s = String(raw ?? '').trim();
          if (!s) return '';
          const up = s.toLowerCase();
          if (up === 's') return 'Sim';
          if (up === 'n') return 'Não';
          if (up === 'sim') return 'Sim';
          if (up === 'não' || up === 'nao') return 'Não';
          return s;
        };

        const toYesNoUnknownText = (raw) => {
          const yn = toYesNoUnknown(raw);
          if (yn === 'Sim') return 'Sim';
          if (yn === 'Não') return 'Não';
          return 'Não informado';
        };

        const renderChips = (raw, emptyText = 'Nenhum item informado') => {
          if (isEmptyValue(raw)) {
            return `<span class="text-sm text-gray-500 italic">${emptyText}</span>`;
          }
          const parts = String(raw)
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
          if (parts.length === 0) {
            return `<span class="text-sm text-gray-500 italic">${emptyText}</span>`;
          }
          return `
          <div class="flex flex-wrap gap-2">
            ${parts.map(p => `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700 border border-blue-200">${p}</span>`).join('')}
          </div>
        `;
        };

        const renderYesNoPill = (raw) => {
          const yn = toYesNoUnknown(raw);
          if (yn === 'Sim') {
            return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700 border border-green-200">✓ Sim</span>`;
          }
          if (yn === 'Não') {
            return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700 border border-red-200">✗ Não</span>`;
          }
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-600 border border-gray-200">⊘ Não informado</span>`;
        };

        const renderAnswerPill = (raw) => {
          const yn = toYesNoUnknown(raw);
          if (yn === 'Sim') {
            return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-blue-50 text-blue-700 border border-blue-200">Sim</span>`;
          }
          if (yn === 'Não') {
            return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-blue-50 text-blue-700 border border-blue-200">Não</span>`;
          }
          return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-gray-50 text-gray-600 border border-gray-200">Não informado</span>`;
        };

        const renderReadOnlyValue = (text) => {
          const value = String(text ?? '').trim();
          const display = value ? value : 'Não informado';
          return `<span class="inline-flex items-center px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-900 border border-indigo-200 font-semibold text-sm tracking-tight">${display}</span>`;
        };

        const renderField = (label, valueHtml) => {
          return `
          <div>
            <div class="text-xs sm:text-sm font-semibold text-gray-700 mb-2">${label}</div>
            <div class="text-gray-900">
              ${valueHtml}
            </div>
          </div>
        `;
        };

        const findKeyByContains = (needleParts) => {
          const keys = Object.keys(record || {});
          const normalizedNeedles = (needleParts || []).map(p => String(p).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''));
          for (const k of keys) {
            const nk = String(k).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            if (normalizedNeedles.every(p => nk.includes(p))) return k;
          }
          return null;
        };

        const getTipoInstituicao = (nomeEscola) => {
          const v = normalizeText(nomeEscola);
          if (!v) return '';
          if (v.toUpperCase().startsWith('CMEI')) return 'CMEI - Centro Municipal de Educação Infantil';
          if (v.toUpperCase().startsWith('EMEF')) return 'EMEF - Escola Municipal de Ensino Fundamental';
          return '';
        };

        const escolaValue = record[columnNames.escola] || '';
        const tipoInstituicaoValue = getTipoInstituicao(escolaValue);

        const colaboradoresKey = findKeyByContains(['colaborador']);
        const colaboradoresValue = colaboradoresKey ? record[colaboradoresKey] : '';

        const htmlContent = `
        <div class="bg-gradient-to-br from-blue-50/30 via-indigo-50/20 to-purple-50/30">
          <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 md:p-8 lg:p-10 space-y-6 sm:space-y-8">

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">👤</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Dados da Criança/Estudante</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Preencha as informações básicas da criança ou estudante envolvido no caso</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  <div class="md:col-span-2">${renderField('Nome da Criança/Estudante *', renderReadOnlyValue(toDisplay(record[columnNames.crianca] || '')))}</div>
                  ${renderField('Data da Notificação (NT) *', renderReadOnlyValue(toDisplay(dataNT || '')))}
                  ${renderField('Idade *', renderReadOnlyValue(toDisplay(record[columnNames.idade] || '')))}
                  ${renderField('Identidade de Gênero *', renderReadOnlyValue(toDisplay(record[columnNames.genero] || '')))}
                  ${renderField('É PCD/tem Transtorno?', renderReadOnlyValue(toDisplay(record[columnNames.pcd] || '')))}
                  ${renderField('Raça/Cor', renderReadOnlyValue(toDisplay(record[columnNames.raca] || '')))}
                  ${renderField('Orientação Sexual', renderReadOnlyValue(toDisplay(record[columnNames.orientacaoSexual] || '')))}
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-amber-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-amber-100 text-amber-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">⚠️</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Situação da Violência</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Descreva o tipo de violência ocorrida e os encaminhamentos realizados</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  <div class="md:col-span-2">${renderField('Tipo de Violência *', renderChips(record[columnNames.tipo] || '', 'Nenhum tipo informado'))}</div>
                  <div class="md:col-span-2">${renderField('Encaminhamento', renderChips(record[columnNames.encaminhamento] || '', 'Nenhum encaminhamento informado'))}</div>
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-emerald-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-emerald-100 text-emerald-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">🏫</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Dados da Instituição</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Preencha informações sobre a escola e região onde ocorreu o caso</p>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                  ${renderField('Qual o tipo da instituição de ensino? *', renderReadOnlyValue(toDisplay(tipoInstituicaoValue || '')))}
                  ${renderField('Região *', renderReadOnlyValue(toDisplay(record[columnNames.regiao] || '')))}
                  <div class="md:col-span-2">${renderField('Instituição de Ensino *', renderReadOnlyValue(toDisplay(escolaValue || '')))}</div>
                  <div class="md:col-span-2">${renderField('Responsável pelo Registro *', renderReadOnlyValue(toDisplay(record[columnNames.responsavel] || '')))}</div>
                  <div class="md:col-span-2">${renderField('Colaboradores (opcional)', renderChips(colaboradoresValue || '', 'Nenhum colaborador adicionado'))}</div>
                </div>
              </div>
            </section>

            <section>
              <div class="bg-gradient-to-r from-slate-50 to-purple-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6">
                <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
                  <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">❓</div>
                  <div class="flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Informações Complementares</h2>
                    <p class="text-xs sm:text-sm text-gray-600">Responda às questões adicionais sobre o contexto da violência</p>
                  </div>
                </div>
                ${(() => {
            const foiMembroFamiliarValue = record[columnNames.foiMembroFamiliar] || '';
            const fonteEscolaValue = record[columnNames.fonteInformada] || '';
            const violenciaEscolaOcorreuValue = record[columnNames.violenciaEscolaOcorreu] || '';
            const profissionalAutorValue = record[columnNames.profissionalAutor] || '';
            const estudanteAutorValue = record[columnNames.estudanteAutor] || '';
            const violenciaNaoEscolaValue = record[columnNames.violenciaNaoEscola] || '';
            const violenciaInformadaValue = record[columnNames.violenciaInformada] || '';
            const ocorreuValue = record[columnNames.ocorreu] || '';
            const estudoCasoValue = record[columnNames.estudoCaso] || '';

            const renderTooltip = (tooltipTitle, tooltipBody) => {
              return `
                      <span class="relative inline-flex align-middle ml-1 tooltip-trigger" tabindex="0" role="button" aria-label="Ajuda">
                        <span class="tooltip-icon">ⓘ</span>
                        <span class="tooltip-popover absolute left-1/2 -translate-x-1/2 bottom-full mb-2">
                          <span class="absolute inset-[-10px] rounded-2xl bg-white/30 backdrop-blur-[2px]"></span>
                          <span class="relative block w-80 max-w-[90vw] rounded-xl border border-indigo-300 bg-white/95 shadow-2xl shadow-indigo-900/20 p-4 text-xs text-gray-900">
                            <div class="text-[11px] font-extrabold text-indigo-900 mb-2 tracking-wide">${tooltipTitle}</div>
                            <div class="leading-relaxed text-gray-800">${tooltipBody}</div>
                          </span>
                        </span>
                      </span>
                    `;
            };

            const renderQ = (questionText, answerRaw, tooltipTitle, tooltipBody) => {
              return `
                      <div class="space-y-1">
                        <div class="text-sm font-medium text-gray-800">
                          ${questionText}
                          ${renderTooltip(tooltipTitle, tooltipBody)}
                        </div>
                        <div>${renderReadOnlyValue(toYesNoUnknownText(answerRaw))}</div>
                      </div>
                    `;
            };

            const shouldShowOcorreu = toYesNoUnknown(violenciaInformadaValue) === 'Sim';

            return `
                    <div class="space-y-4">
                      ${renderQ(
              'O autor era membro da família?',
              foiMembroFamiliarValue,
              'Membro da família',
              'Use esta informação para entender se o caso tem indício de violência intrafamiliar. Considere como familiar: pais ou responsáveis legais, avós, irmãos, tios, primos e outros parentes consanguíneos ou por afinidade. Quando marcado como “Sim”, costuma indicar necessidade de atenção para contexto doméstico e rede de proteção.'
            )}

                      ${renderQ(
              'O relato foi feito pela escola?',
              fonteEscolaValue,
              'Fonte do relato',
              'Mostra quem iniciou o relato/notificação do caso. “Sim” significa que a própria escola identificou e registrou o caso (direção, coordenação, professores ou equipe). “Não” indica que o caso chegou à escola por outra fonte (ex.: família, estudante, serviços, instituições externas). Isso ajuda a interpretar como a escola tomou conhecimento do ocorrido.'
            )}

                      ${renderQ(
              'A escola identificou que a violência ocorreu na escola?',
              violenciaEscolaOcorreuValue,
              'Local confirmado (na escola)',
              'Indica se, após apuração/verificação, foi confirmado que o fato ocorreu dentro do ambiente escolar (ex.: sala, pátio, banheiro, quadra). Este campo descreve o local do ocorrido — não a autoria — e ajuda a diferenciar situações internas da escola de situações externas acompanhadas pela escola.'
            )}

                      ${renderQ(
              'Algum profissional/funcionário da escola foi autor da violência?',
              profissionalAutorValue,
              'Autoria (profissional)',
              'Indica se a autoria do caso foi atribuída a profissional/funcionário da escola. Considere professores, coordenação, direção, auxiliares, terceirizados (limpeza, segurança, portaria, merenda) e demais colaboradores. Esse campo é importante porque muda a interpretação do caso e os encaminhamentos administrativos.'
            )}

                      ${renderQ(
              'Algum estudante foi autor da violência?',
              estudanteAutorValue,
              'Autoria (estudante)',
              'Indica se a autoria foi atribuída a estudante (da mesma escola ou de outra unidade). Em geral, é usado para casos como agressões entre estudantes, bullying/cyberbullying e outras violências no contexto escolar entre pares.'
            )}

                      ${renderQ(
              'A escola identificou que a violência NÃO ocorreu na escola?',
              violenciaNaoEscolaValue,
              'Local confirmado (fora da escola)',
              'Indica se, após verificação, foi confirmado que o fato ocorreu fora do ambiente escolar (ex.: residência, via pública, transporte, outros locais externos). Mesmo quando a escola acompanha ou identifica o caso, este campo ajuda a registrar que o local do ocorrido não foi na escola.'
            )}

                      ${renderQ(
              'A violência foi comunicada à escola por algum agente externo?',
              violenciaInformadaValue,
              'Comunicação por terceiros',
              'Indica se a escola tomou conhecimento do caso por comunicação de terceiros (agentes externos), e não por identificação direta da equipe escolar. Exemplos: família, o próprio estudante, vizinhos, Conselho Tutelar, Polícia, UBS, CRAS, entre outros. Esse campo é útil para interpretar a origem da informação e o fluxo de notificação.'
            )}

                      ${shouldShowOcorreu ? renderQ(
              '➜ A violência ocorreu na escola?',
              ocorreuValue,
              'Confirmação do local',
              'Este campo aparece quando o caso foi comunicado por agente externo. Ele registra a conclusão (após apuração) sobre onde o fato ocorreu: dentro ou fora da escola. Serve para evitar interpretações ambíguas quando a informação chegou por terceiros, mas o local do ocorrido ainda precisa ser confirmado.'
            ) : ''}

                      ${renderQ(
              'Foi realizado estudo de caso pela equipe?',
              estudoCasoValue,
              'Estudo de caso',
              'Indica se a equipe realizou estudo de caso (análise estruturada do registro), geralmente com reuniões, avaliação multidisciplinar (pedagógica/psicossocial/direção), definição de plano de intervenção e documentação interna. Ajuda a entender o nível de consolidação do acompanhamento do caso.'
            )}
                    </div>
                  `;
          })()}
              </div>
            </section>

            ${(() => {
            // ABA DE ANEXOS - VISIVEL APENAS PARA ADMIN/SUPERUSER
            const userRole = sessionStorage.getItem('userRole');
            if (userRole !== 'admin' && userRole !== 'superuser') {
              return '';
            }

            // Funcao para obter icone baseado no tipo de arquivo
            const getFileIcon = (filename) => {
              const ext = (filename || '').split('.').pop().toLowerCase();
              const icons = {
                pdf: '📄', doc: '📝', docx: '📝',
                xls: '📊', xlsx: '📊',
                jpg: '🖼️', jpeg: '🖼️', png: '🖼️', gif: '🖼️',
                mp4: '🎥', mp3: '🎵',
                zip: '📦', rar: '📦'
              };
              return icons[ext] || '📎';
            };

            // Busca anexos do registro (se disponivel no record)
            const anexos = record.anexos || record.Anexos || [];
            const hasAnexos = Array.isArray(anexos) && anexos.length > 0;

            // Renderiza lista de anexos ou mensagem vazia
            const renderAnexosList = () => {
              if (!hasAnexos) {
                return '<div class="text-center py-8 text-gray-500"><span class="text-4xl block mb-3">📂</span><p class="font-medium">Nenhum anexo disponivel</p><p class="text-sm">Este registro nao possui arquivos anexados.</p></div>';
              }
              return anexos.map((anexo, index) => {
                const nome = anexo.nome || anexo.filename || 'Arquivo_' + (index + 1);
                const url = anexo.url || anexo.link || '#';
                const enviadoPor = anexo.enviadoPor || anexo.usuario || 'Usuario';
                const dataEnvio = anexo.dataEnvio || anexo.data || '';
                const icon = getFileIcon(nome);
                const dataStr = dataEnvio ? ' - ' + dataEnvio : '';
                return '<div class="flex items-center justify-between p-3 sm:p-4 bg-white rounded-xl border border-gray-200 hover:border-indigo-300 hover:shadow-sm transition-all"><div class="flex items-center gap-3 flex-1 min-w-0"><span class="text-2xl flex-shrink-0">' + icon + '</span><div class="min-w-0 flex-1"><p class="font-medium text-gray-800 truncate">' + nome + '</p><p class="text-xs text-gray-500">Enviado por: ' + enviadoPor + dataStr + '</p></div></div><a href="' + url + '" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 ml-3 px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg hover:bg-indigo-600 transition-colors flex items-center gap-2"><span>⬇️</span><span class="hidden sm:inline">Download</span></a></div>';
              }).join('');
            };

            const totalText = hasAnexos ? '<p class="mt-4 text-sm text-gray-500 text-center">Total: ' + anexos.length + ' anexo(s)</p>' : '';

            return '<section><div class="bg-gradient-to-r from-slate-50 to-indigo-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6"><div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6"><div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-indigo-100 text-indigo-700 text-xl sm:text-2xl flex-shrink-0 shadow-sm">📎</div><div class="flex-1"><h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">Anexos do Caso</h2><p class="text-xs sm:text-sm text-gray-600">Documentos e arquivos relacionados a este registro (visivel apenas para administradores)</p></div></div><div class="space-y-3">' + renderAnexosList() + '</div>' + totalText + '</div></section>';
          })()}
          </div>
        </div>
      `;

        modalBody.innerHTML = htmlContent || '<p class="text-gray-500 text-center py-8">Nenhuma informação disponível</p>';

        // Capturar posição atual do scroll
        const scrollY = window.scrollY || window.pageYOffset;

        // Salvar posição do scroll para restaurar depois
        modal.dataset.scrollY = scrollY;

        // Bloquear scroll do body e manter posição visual
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollY}px`;
        document.body.style.width = '100%';
        document.body.classList.add('modal-open');

        // Abrir modal começando na posição atual do scroll
        modal.style.top = `${scrollY}px`;
        modal.style.height = `${window.innerHeight}px`;
        modal.classList.add('visible');

        // Scrollar o modal para mostrar o conteúdo no topo
        setTimeout(() => {
          modal.scrollTop = 0;
        }, 10);
      }

      function fecharModalDetalhes() {
        const modal = document.getElementById('modal-detalhes');
        const scrollY = modal.dataset.scrollY || '0';

        // Remover bloqueio de scroll
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        document.body.classList.remove('modal-open');

        // Fechar modal
        modal.classList.remove('visible');
        modal.style.top = '';
        modal.style.height = '';

        // Restaurar posição do scroll
        window.scrollTo(0, parseInt(scrollY));
      }

      // ==============================
      // Funções de Paginação
      // ==============================
      function updatePaginationControls() {
        const info = document.getElementById('paginacaoInfo');
        const btnPrimeira = document.getElementById('btnPrimeiraPagina');
        const btnAnterior = document.getElementById('btnPaginaAnterior');
        const btnProxima = document.getElementById('btnProximaPagina');
        const btnUltima = document.getElementById('btnUltimaPagina');

        info.textContent = paginaAtual + ' de ' + totalPaginas;

        // Desabilitar botões conforme necessário
        btnPrimeira.disabled = (paginaAtual === 1);
        btnAnterior.disabled = (paginaAtual === 1);
        btnProxima.disabled = (paginaAtual === totalPaginas);
        btnUltima.disabled = (paginaAtual === totalPaginas);
      }

      function irParaPagina(novaPagina) {
        if (novaPagina >= 1 && novaPagina <= totalPaginas) {
          paginaAtual = novaPagina;
          renderTable(filteredData);
          // Scroll suave para a seção de resultados
          document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function alterarRegistrosPorPagina() {
        const select = document.getElementById('registrosPorPaginaSelect');
        registrosPorPagina = parseInt(select.value, 10);
        paginaAtual = 1; // Voltar para primeira página
        renderTable(filteredData);
      }

      // ========================================
      // VERIFICAR AUTENTICAÇÃO
      // ========================================
      function verificarAutenticacao() {
        const userRole = sessionStorage.getItem('userRole');
        const userEmail = sessionStorage.getItem('userEmail');

        // Se não estiver autenticado, redireciona para login
        if (!userRole || !userEmail) {
          alert('Acesso negado! Faça login para acessar o sistema.');
          window.location.href = 'index.html';
          return;
        }

        // Ajusta visibilidade do menu para visualizador (somente painel)
        ajustarMenuPorRole(userRole);
        configurarLogoutVisualizador(userRole);
      }

      // ========================================
      // MENU MOBILE TOGGLE
      // ========================================
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = document.getElementById('menuIcon');
        mobileMenu.classList.toggle('show');
        menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
      }

      // Fecha o menu ao redimensionar para desktop
      window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = document.getElementById('menuIcon');
          if (mobileMenu && mobileMenu.classList.contains('show')) {
            mobileMenu.classList.remove('show');
            menuIcon.style.transform = 'rotate(0deg)';
          }
        }
      });

      // ========================================
      // VERIFICAR E MOSTRAR MENU (DINAMICO)
      // Usa o sistema de navegacao por perfil
      // ========================================
      function verificarMenuAdmin() {
        // Usa o novo sistema de navegacao por perfil
        if (window.NAVMNavigation) {
          window.NAVMNavigation.renderMenus();
          console.log('[Menu] Menus renderizados via NAVMNavigation');
        } else {
          console.warn('[Menu] NAVMNavigation nao disponivel');
        }
      }

      // Funcao legada - agora o ajuste e feito automaticamente pelo navigation.js
      function ajustarMenuPorRole(role) {
        // O novo sistema de navegacao ja renderiza apenas os itens permitidos
        console.log('[Menu] ajustarMenuPorRole chamado para role:', role);
      }

      // Funcao legada - agora o botao sair e sempre visivel pelo navigation.js
      function configurarLogoutVisualizador(role) {
        // O botao sair agora e sempre renderizado pelo navigation.js
        console.log('[Menu] configurarLogoutVisualizador chamado para role:', role);
      }

      // ========================================
      // FECHAR MENU MOBILE AO CLICAR EM LINK
      // ========================================
      document.addEventListener('DOMContentLoaded', function () {
        const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
        mobileMenuLinks.forEach(link => {
          link.addEventListener('click', function () {
            const mobileMenu = document.getElementById('mobileMenuNav');
            const menuIcon = document.getElementById('menuIcon');
            if (mobileMenu && menuIcon) {
              mobileMenu.classList.remove('show');
              menuIcon.style.transform = 'rotate(0deg)';
            }
          });
        });

        verificarMenuAdmin();

        // Carregar contador de notificações
        carregarContadorNotificacoes();

        // ✨ SINCRONIZAÇÃO ENTRE PÁGINAS: Listener para invalidação de cache
        window.addEventListener('storage', (event) => {
          if (event.key === 'naam_cache_invalidation' && event.newValue) {
            try {
              const invalidationEvent = JSON.parse(event.newValue);
              if (invalidationEvent.type === 'cache_invalidation' && invalidationEvent.cacheKey === 'gerenciar_casos') {
                console.log('[Sincronização] 📡 Evento de invalidação recebido da página:', invalidationEvent.source);

                // Limpa cache local
                if (window.DataCache) {
                  window.DataCache.clear('gerenciar_casos');
                  window.DataCache.clearAll();
                  console.log('[Sincronização] ✅ Cache local invalidado');
                }

                // Recarrega dados automaticamente se estiver na página de painel
                if (typeof carregarDadosPlanilha === 'function') {
                  console.log('[Sincronização] 🔄 Recarregando dados da planilha...');
                  // Aguarda 500ms para evitar conflito com a página que iniciou
                  setTimeout(() => {
                    carregarDadosPlanilha();
                  }, 500);
                }
              }
            } catch (e) {
              console.warn('[Sincronização] ⚠️ Erro ao processar evento de invalidação:', e);
            }
          }
        });
      });



      // ========================================
      // SISTEMA DE SINCRONIZAÇÃO ENTRE PÁGINAS
      // ========================================
      // Rastreia estado do popup azul e sincroniza entre painel-casos.html e gerenciar-casos.html
      const SYNC_STATE_KEY = 'naam_popup_azul_sync_state';
      const SYNC_LAST_NOTIF_ID_KEY = 'naam_last_synced_notif_id';

      /**
       * Salva estado de sincronização no localStorage
       * @param {Object} state - Estado a ser salvo
       */
      function salvarEstadoSincronizacao(state) {
        try {
          const syncState = {
            ...state,
            timestamp: Date.now(),
            pagina: window.location.pathname.includes('painel-casos') ? 'painel' : 'gerenciar'
          };
          localStorage.setItem(SYNC_STATE_KEY, JSON.stringify(syncState));
          console.log('[Sync] 💾 Estado salvo:', syncState);
        } catch (e) {
          console.warn('[Sync] ⚠️ Erro ao salvar estado:', e);
        }
      }

      /**
       * Lê estado de sincronização do localStorage
       * @returns {Object|null} Estado ou null se não existir
       */
      function lerEstadoSincronizacao() {
        try {
          const stored = localStorage.getItem(SYNC_STATE_KEY);
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (e) {
          console.warn('[Sync] ⚠️ Erro ao ler estado:', e);
        }
        return null;
      }

      /**
       * Limpa estado de sincronização
       */
      function limparEstadoSincronizacao() {
        try {
          localStorage.removeItem(SYNC_STATE_KEY);
          console.log('[Sync] 🧹 Estado limpo');
        } catch (e) {
          console.warn('[Sync] ⚠️ Erro ao limpar estado:', e);
        }
      }

      /**
       * Marca que popup azul foi criado (ativo)
       * @param {number} notifId - ID da notificação que gerou o popup
       */
      function marcarPopupAzulAtivo(notifId) {
        salvarEstadoSincronizacao({
          popupAtivo: true,
          popupFechadoSemAtualizar: false,
          popupAtualizado: false,
          notifId: notifId
        });
      }

      /**
       * Marca que popup azul foi fechado sem atualizar
       * @param {number} notifId - ID da notificação
       */
      function marcarPopupAzulFechadoSemAtualizar(notifId) {
        salvarEstadoSincronizacao({
          popupAtivo: false,
          popupFechadoSemAtualizar: true,
          popupAtualizado: false,
          notifId: notifId
        });
      }

      /**
       * Marca que popup azul foi atualizado (usuário clicou em Atualizar)
       * @param {number} notifId - ID da notificação
       */
      function marcarPopupAzulAtualizado(notifId) {
        salvarEstadoSincronizacao({
          popupAtivo: false,
          popupFechadoSemAtualizar: false,
          popupAtualizado: true,
          notifId: notifId
        });
        // Salva último ID sincronizado
        try {
          localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
        } catch (e) {
          console.warn('[Sync] ⚠️ Erro ao salvar último ID sincronizado:', e);
        }
      }

      /**
       * Verifica estado sincronizado na inicialização da página
       * Se popup foi fechado sem atualizar em outra página, mostra alerta vermelho
       */
      function verificarEstadoSincronizadoNaInicializacao() {
        const estado = lerEstadoSincronizacao();
        if (!estado) return;

        console.log('[Sync] 🔍 Verificando estado sincronizado:', estado);

        // Se popup foi fechado sem atualizar E não foi atualizado depois
        if (estado.popupFechadoSemAtualizar && !estado.popupAtualizado) {
          // Verifica se o ID da notificação ainda é relevante (não foi atualizado em outra página)
          const ultimoIdSincronizado = localStorage.getItem(SYNC_LAST_NOTIF_ID_KEY);
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');

          console.log('[Sync] 📊 Comparação de IDs:', {
            ultimoIdSincronizado,
            ultimoIdSalvo,
            estadoNotifId: estado.notifId
          });

          // Se não há ID sincronizado, significa que nunca houve atualização via popup
          // Nesse caso, sempre mostra o alerta se o popup foi fechado sem atualizar
          if (!ultimoIdSincronizado) {
            console.log('[Sync] 🔔 Popup foi fechado sem atualizar (nunca houve atualização). Mostrando alerta vermelho...');

            // Força mostrar alerta vermelho e animação
            window.popupAzulFechadoPeloUsuario = true;
            setTimeout(() => {
              if (typeof showAlertaNovasNotificacoes === 'function') {
                showAlertaNovasNotificacoes();
              }
            }, 500);
            return;
          }

          // Se há ID sincronizado, verifica se o ID atual é diferente (ainda há notificação pendente)
          // OU se o ID do estado é diferente do sincronizado (a notificação que gerou o popup ainda não foi processada)
          if (ultimoIdSalvo && ultimoIdSalvo !== ultimoIdSincronizado) {
            console.log('[Sync] 🔔 Popup foi fechado sem atualizar e há notificação pendente. Mostrando alerta vermelho...');

            // Força mostrar alerta vermelho e animação
            window.popupAzulFechadoPeloUsuario = true;
            setTimeout(() => {
              if (typeof showAlertaNovasNotificacoes === 'function') {
                showAlertaNovasNotificacoes();
              }
            }, 500);
            return;
          }

          // Se o ID do estado é diferente do sincronizado, também mostra (notificação específica não foi processada)
          if (estado.notifId && String(estado.notifId) !== ultimoIdSincronizado) {
            console.log('[Sync] 🔔 Popup foi fechado sem atualizar e a notificação específica não foi processada. Mostrando alerta vermelho...');

            // Força mostrar alerta vermelho e animação
            window.popupAzulFechadoPeloUsuario = true;
            setTimeout(() => {
              if (typeof showAlertaNovasNotificacoes === 'function') {
                showAlertaNovasNotificacoes();
              }
            }, 500);
            return;
          }

          // Se chegou aqui e o popup foi fechado sem atualizar, mostra o alerta de qualquer forma
          // (pode ser que o ID ainda não tenha sido atualizado, mas o popup foi fechado)
          console.log('[Sync] 🔔 Popup foi fechado sem atualizar. Mostrando alerta vermelho (fallback)...');

          // Força mostrar alerta vermelho e animação
          window.popupAzulFechadoPeloUsuario = true;
          setTimeout(() => {
            if (typeof showAlertaNovasNotificacoes === 'function') {
              showAlertaNovasNotificacoes();
            }
          }, 500);
        }
      }

      /**
       * Detecta navegação entre páginas e marca popup como fechado se estava ativo
       */
      function configurarDetecaoNavegacao() {
        // Detecta quando usuário está saindo da página
        window.addEventListener('beforeunload', () => {
          const estado = lerEstadoSincronizacao();
          const popupAtivo = document.getElementById('notificacao-nova-notificacao');

          console.log('[Sync] 🚪 beforeunload disparado. Estado:', estado, 'Popup ativo:', !!popupAtivo);

          // Se há popup azul ativo e usuário está navegando sem atualizar
          if (estado && estado.popupAtivo && popupAtivo) {
            console.log('[Sync] 🚪 Usuário navegando com popup azul ativo. Marcando como fechado sem atualizar...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
            marcarPopupAzulFechadoSemAtualizar(notifId);
          } else if (popupAtivo) {
            // Se há popup ativo mas não há estado salvo, cria o estado
            console.log('[Sync] 🚪 Popup ativo mas sem estado. Criando estado e marcando como fechado...');
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
            marcarPopupAzulFechadoSemAtualizar(notifId);
          }
        });

        // Também detecta quando a página fica oculta (mudança de aba)
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            const estado = lerEstadoSincronizacao();
            const popupAtivo = document.getElementById('notificacao-nova-notificacao');

            console.log('[Sync] 👁️ Página ocultada. Estado:', estado, 'Popup ativo:', !!popupAtivo);

            // Se há popup azul ativo e página foi ocultada
            if (estado && estado.popupAtivo && popupAtivo) {
              console.log('[Sync] 👁️ Página ocultada com popup azul ativo. Marcando como fechado sem atualizar...');
              const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
              const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : (estado.notifId || null);
              marcarPopupAzulFechadoSemAtualizar(notifId);
            } else if (popupAtivo) {
              // Se há popup ativo mas não há estado salvo, cria o estado
              console.log('[Sync] 👁️ Popup ativo mas sem estado. Criando estado e marcando como fechado...');
              const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
              const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
              marcarPopupAzulFechadoSemAtualizar(notifId);
            }
          }
        });
      }

      // Configura detecção de navegação ao carregar
      configurarDetecaoNavegacao();



      // ===== FUNÇÕES UTILITÁRIAS PARA ANIMAÇÃO DE PULSAR =====
      /**
       * Ativa a animação de pulsar em um botão
       * @param {HTMLElement|string} botao - Elemento do botão ou ID do botão
       */
      function ativarPulseBotao(botao) {
        const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
        if (elemento) {
          elemento.classList.add('btn-pulse-active');
        }
      }

      /**
       * Desativa a animação de pulsar em um botão
       * @param {HTMLElement|string} botao - Elemento do botão ou ID do botão
       */
      function desativarPulseBotao(botao) {
        const elemento = typeof botao === 'string' ? document.getElementById(botao) : botao;
        if (elemento) {
          elemento.classList.remove('btn-pulse-active');
        }
      }

      // Restaura estado ao carregar página (se havia notificação pendente)
      (function restoreNotificationState() {
        try {
          const hasFlag = localStorage.getItem('naam_new_notif_flag') === '1';
          if (hasFlag) {
            NotificationManager.hasStoredNotif = true;
            // Mostra alerta após DOM estar pronto
            setTimeout(() => {
              NotificationManager.showAlert();
            }, 100);
          }
        } catch (e) {
          console.warn('[NotifManager] Erro ao restaurar estado:', e);
        }
      })();

      // ===== WRAPPER COMPATÍVEL COM CÓDIGO ANTIGO =====
      function showAlertaNovasNotificacoes(count, deveAguardarToast = false) {
        const badgeDesktop = document.getElementById('badge-notif-desktop');
        const badgeMobile = document.getElementById('badge-notif-mobile');
        let alerta = document.getElementById('alerta-novas-notificacoes');

        // Determina contagem de novas notificações, se fornecida ou salva globalmente
        let totalNovas = null;
        if (typeof count === 'number' && count > 0) {
          totalNovas = count;
        } else if (typeof count === 'string') {
          const parsed = parseInt(count, 10);
          if (!isNaN(parsed) && parsed > 0) {
            totalNovas = parsed;
          }
        }
        // Se não veio via parâmetro, tenta ler do localStorage (contador global)
        if (totalNovas === null) {
          try {
            const stored = localStorage.getItem('naam_new_notif_count');
            if (stored) {
              const parsed = parseInt(stored, 10);
              if (!isNaN(parsed) && parsed > 0) {
                totalNovas = parsed;
              }
            }
          } catch (e) {
            console.warn('[Alerta Painel] ⚠️ Erro ao ler contador global de novas notificações:', e);
          }
        }

        function aplicarTextoEContador() {
          if (!alerta) return;
          const titulo = alerta.querySelector('span.font-semibold');
          const descricao = alerta.querySelector('span.text-sm');

          if (titulo) {
            if (totalNovas === 1) {
              titulo.textContent = 'Existe 1 nova notificação!';
            } else if (typeof totalNovas === 'number' && totalNovas > 1) {
              titulo.textContent = `Existem ${totalNovas} novas notificações!`;
            } else {
              // fallback quando não sabemos o número exato
              titulo.textContent = 'Existem novas notificações!';
            }
          }

          if (descricao) {
            // Mantém o texto padrão do painel
            descricao.textContent = 'Clique em Atualizar Dados para recarregar.';
          }
        }

        function atualizarBadges() {
          const valorBadge = totalNovas != null ? String(totalNovas) : '!';
          if (badgeDesktop) {
            badgeDesktop.textContent = valorBadge;
            badgeDesktop.classList.remove('hidden');
          }
          if (badgeMobile) {
            badgeMobile.textContent = valorBadge;
            badgeMobile.classList.remove('hidden');
          }
        }

        // Bloqueio global: se atualização foi iniciada via popup azul,
        // não exibir quaisquer alertas/badges e remover o alerta do DOM
        if (window.atualizacaoDisparadaPeloUsuario || window.atualizacaoIniciadaViaPopup) {
          if (alerta) alerta.remove();
          if (badgeDesktop) badgeDesktop.classList.add('hidden');
          if (badgeMobile) badgeMobile.classList.add('hidden');
          console.log('[Alerta Painel] 🚫 Bloqueado por atualização via popup; alerta removido do DOM');
          return;
        }

        // ✨ SINCRONIZAÇÃO: Se popup foi fechado sem atualizar (em qualquer página),
        // força mostrar alerta vermelho e animação
        const estado = lerEstadoSincronizacao();
        if (estado && estado.popupFechadoSemAtualizar && !estado.popupAtualizado) {
          const ultimoIdSincronizado = localStorage.getItem(SYNC_LAST_NOTIF_ID_KEY);
          const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');

          // Se ainda há notificação pendente
          if (!ultimoIdSincronizado || ultimoIdSalvo !== ultimoIdSincronizado) {
            console.log('[Alerta Painel] ✅ Popup foi fechado sem atualizar. FORÇANDO exibição do alerta vermelho...');

            // Reseta estado da state machine
            if (typeof NotificationManager !== 'undefined') {
              NotificationManager.setState('idle');
              NotificationManager.hasStoredNotif = false;
            }

            // Garante que o elemento do alerta exista
            if (!alerta) {
              console.warn('[Alerta Painel] ⚠️ Elemento #alerta-novas-notificacoes não encontrado. Recriando alerta no DOM...');
              alerta = document.createElement('div');
              alerta.id = 'alerta-novas-notificacoes';
              alerta.className = 'alerta-novas-notificacoes mb-4';
              alerta.innerHTML = `
              <div class="flex items-center gap-3">
                <span class="text-lg">🔔</span>
                <div class="flex flex-col">
                  <span class="font-semibold">Existem novas notificações!</span>
                  <span class="text-sm text-rose-700">Clique em Atualizar Dados para recarregar.</span>
                </div>
              </div>
            `;

              // Insere o alerta logo acima do cabeçalho
              const header = document.querySelector('.bg-white.rounded-2xl.shadow-xl.p-6.mb-6');
              if (header && header.parentElement) {
                header.parentElement.insertBefore(alerta, header);
              } else {
                document.body.insertBefore(alerta, document.body.firstChild);
              }
            }

            // Força mostrar o alerta vermelho
            alerta.style.display = 'flex';
            void alerta.offsetWidth; // Força reflow
            alerta.classList.remove('hide');
            alerta.classList.add('show');
            console.log('[Alerta Painel] ✅ Alerta vermelho FORÇADO a aparecer');

            // Atualiza textos e contador no próprio alerta
            aplicarTextoEContador();

            // Força ativar animação de pulsar no botão
            ativarPulseBotao('btnAtualizar');
            console.log('[Alerta Painel] ✅ Animação de pulsar FORÇADA no botão Atualizar Dados');

            // Atualiza badges (se ainda existirem no DOM)
            atualizarBadges();

            return;
          }
        }

        // Atualiza texto/contador no alerta com base na contagem (quando existir)
        if (alerta) {
          aplicarTextoEContador();
        }

        if (deveAguardarToast) {
          // Marca como pendente, mas NÃO mostra
          NotificationManager.hasStoredNotif = true;
          atualizarBadges();
          return;
        }

        // Tenta mostrar alerta via state machine
        const showed = NotificationManager.showAlert();
        if (showed) {
          atualizarBadges();
        }
      }

      function hideAlertaNovasNotificacoes(clearFlag = true) {
        const badgeDesktop = document.getElementById('badge-notif-desktop');
        const badgeMobile = document.getElementById('badge-notif-mobile');

        NotificationManager.startAlertExit();

        if (badgeDesktop) badgeDesktop.classList.add('hidden');
        if (badgeMobile) badgeMobile.classList.add('hidden');

        if (!clearFlag) {
          NotificationManager.hasStoredNotif = true; // Mantém pendente
        }
      }

      function handleVerNotificacoesCTA() {
        hideAlertaNovasNotificacoes(true);
        window.location.href = 'minhas-notificacoes.html';
      }

      async function carregarContadorNotificacoes() {
        try {
          const email = localStorage.getItem('userEmail');
          if (!email) return;

          const url = window.CONFIG.APPS_SCRIPT_CASOS;
          const dados = {
            action: 'contarNaoLidas',
            emailUsuario: email
          };

          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'data=' + encodeURIComponent(JSON.stringify(dados))
          });

          const resultado = await response.json();

          if (resultado.success && resultado.count > 0) {
            const badgeDesktop = document.getElementById('badge-notif-desktop');
            const badgeMobile = document.getElementById('badge-notif-mobile');

            if (badgeDesktop) {
              badgeDesktop.textContent = resultado.count;
              badgeDesktop.classList.remove('hidden');
            }

            if (badgeMobile) {
              badgeMobile.textContent = resultado.count;
              badgeMobile.classList.remove('hidden');
            }

            showAlertaNovasNotificacoes(resultado.count);
          } else {
            // Não esconda se existe flag pendente; apenas limpa visuais quando usuário limpar flag
            hideAlertaNovasNotificacoes(false);
          }
        } catch (error) {
          console.error('Erro ao carregar contador de notificações:', error);
        }
      }

      // ========================================
      // FUNÇÃO SAIR
      // ========================================
      function sair() {
        if (confirm('Deseja realmente sair do sistema?')) {
          sessionStorage.clear();
          localStorage.clear();
          window.location.href = 'index.html';
        }
      }

      // Chama verificações ao carregar
      verificarAutenticacao();
      verificarMenuAdmin();

      // ✨ SINCRONIZAÇÃO: Verifica estado sincronizado na inicialização
      // Se popup foi fechado sem atualizar em outra página, mostra alerta vermelho
      setTimeout(() => {
        if (typeof verificarEstadoSincronizadoNaInicializacao === 'function') {
          verificarEstadoSincronizadoNaInicializacao();
        }
      }, 1500);

      // ========================================
      // SISTEMA DE DETECÇÃO AUTOMÁTICA DE MUDANÇAS
      // ========================================
      // Inicializa o sistema de detecção de mudanças após carregar os dados
      // Usa a mesma lógica que funcionou no teste manual
      if (window.ChangeDetector && window.DataCache && window.UpdateNotification) {
        // Aguarda os dados serem carregados primeiro
        setTimeout(() => {
          const url = window.CONFIG.APPS_SCRIPT_CASOS;
          const cacheKey = 'painel_casos';
          const pollingInterval = window.CONFIG ? (window.CONFIG.POLLING_INTERVAL || 45000) : 45000;

          console.log('🔄 [Painel Casos] Iniciando sistema de detecção automática de mudanças...');
          console.log('   • Intervalo: ' + (pollingInterval / 1000) + ' segundos');
          console.log('   • Cache key: ' + cacheKey);
          console.log('   • URL: ' + url);

          // Configura callback para recarregar dados quando usuário clicar em "Atualizar Agora"
          if (window.UpdateNotification) {
            window.UpdateNotification.onUpdate(() => {
              console.log('[Painel Casos] Usuário solicitou atualização - recarregando dados...');
              // Recarrega os dados quando usuário clicar em "Atualizar Agora"
              if (typeof carregarDadosPlanilha === 'function') {
                carregarDadosPlanilha();
              } else {
                location.reload();
              }
            });
          }

          // Inicia verificação periódica usando a mesma lógica do teste manual
          // Chama checkForChanges diretamente com cacheKey e URL
          let pollingActive = true;
          let pollingIntervalId = null;
          let verificationCount = 0;

          // Função para executar uma verificação
          const executeCheck = async () => {
            // Pausa quando a página está oculta
            if (document.hidden || !pollingActive) {
              console.log('[Painel Casos] ⏸️ Verificação pausada (página oculta ou polling inativo)');
              return;
            }

            verificationCount++;
            const checkTime = new Date().toLocaleTimeString();
            console.log(`[Painel Casos] 🔍 Verificação #${verificationCount} iniciada às ${checkTime}`);

            try {
              // Usa a mesma lógica do teste manual que funcionou
              // O checkForChanges já dispara o evento 'dataChanged' se detectar mudanças
              const hasChanges = await window.ChangeDetector.checkForChanges(cacheKey, url);

              if (hasChanges) {
                console.log('[Painel Casos] ✅ Mudanças detectadas na verificação #' + verificationCount);
                showAlertaNovasNotificacoes();
              } else {
                console.log('[Painel Casos] ✓ Nenhuma mudança detectada na verificação #' + verificationCount);
              }
            } catch (error) {
              console.error('[Painel Casos] ❌ Erro na verificação periódica #' + verificationCount + ':', error);
              // Não para o polling mesmo se houver erro
            }
          };

          // Função para iniciar o polling
          const startPolling = () => {
            // Limpa intervalo anterior se existir
            if (pollingIntervalId) {
              clearInterval(pollingIntervalId);
              pollingIntervalId = null;
            }

            console.log('[Painel Casos] 🚀 Iniciando polling contínuo...');

            // Executa primeira verificação imediatamente
            executeCheck();

            // Configura intervalo para verificações periódicas
            pollingIntervalId = setInterval(() => {
              executeCheck();
            }, pollingInterval);

            // Armazena o ID do intervalo para poder parar depois se necessário
            window._painelCasosPollingInterval = pollingIntervalId;

            console.log('[Painel Casos] ✅ Polling iniciado com sucesso!');
            console.log(`   • Intervalo: ${pollingInterval / 1000} segundos`);
            console.log(`   • Próxima verificação em: ${pollingInterval / 1000} segundos`);
          };

          // Inicia o polling
          startPolling();

          // ========================================
          // SISTEMA SIMPLIFICADO DE VERIFICAÇÃO POR ID
          // ========================================
          // Verifica novas notificações comparando apenas IDs numéricos
          let ultimoIdSalvo = null;
          let intervaloVerificacaoId = null;
          const STORAGE_KEY_ULTIMO_ID = 'naam_ultimo_id_notificacao';

          /**
           * Carrega último ID salvo do localStorage
           */
          function carregarUltimoIdSalvo() {
            try {
              const salvo = localStorage.getItem(STORAGE_KEY_ULTIMO_ID);
              if (salvo !== null && salvo !== undefined && salvo !== '') {
                const id = Number(salvo);
                if (!isNaN(id)) {
                  ultimoIdSalvo = id;
                  console.log('[Cache/Notificações] ✅ ID carregado do cache:', ultimoIdSalvo);
                  return id;
                }
              }
            } catch (error) {
              console.warn('[Cache/Notificações] Erro ao carregar ID do cache:', error);
            }
            return null;
          }

          /**
           * Salva último ID no localStorage
           */
          function salvarUltimoId(id) {
            try {
              if (id !== null && id !== undefined) {
                localStorage.setItem(STORAGE_KEY_ULTIMO_ID, String(id));
                ultimoIdSalvo = id;
                console.log('[Cache/Notificações] 💾 ID salvo no cache:', id);
              }
            } catch (error) {
              console.warn('[Cache/Notificações] Erro ao salvar ID no cache:', error);
            }
          }

          /**
           * Limpa último ID salvo do localStorage
           */
          function limparUltimoIdSalvo() {
            try {
              localStorage.removeItem(STORAGE_KEY_ULTIMO_ID);
              ultimoIdSalvo = null;
              console.log('[Cache/Notificações] 🧹 ID removido do cache');
            } catch (error) {
              console.warn('[Cache/Notificações] Erro ao limpar ID do cache:', error);
            }
          }

          /**
           * Função 1: Buscar último ID da planilha
           */
          async function buscarUltimoId() {
            try {
              if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
                console.warn('[Verificação ID] API não disponível');
                return null;
              }

              const resultado = await window.API.request(window.CONFIG.APPS_SCRIPT_CASOS, {
                action: 'getLastNotificationId'
              });

              if (resultado.success && resultado.lastId !== null && resultado.lastId !== undefined) {
                return Number(resultado.lastId);
              }

              return null;
            } catch (error) {
              console.error('[Verificação ID] Erro ao buscar último ID:', error);
              return null;
            }
          }

          /**
           * Função 2: Verificação contínua de mudanças
           */
          async function verificarMudancasPorId() {
            try {
              // Chama Função 1 para obter último ID da planilha
              const ultimoIdPlanilha = await buscarUltimoId();

              if (ultimoIdPlanilha === null) {
                console.log('[Verificação ID] Não foi possível obter ID da planilha');
                return;
              }

              // Comparação: ultimoIdPlanilha vs ultimoIdSalvo
              if (ultimoIdSalvo === null) {
                // Primeira execução: apenas salva o ID
                salvarUltimoId(ultimoIdPlanilha);
                console.log('[Verificação ID] ID inicial salvo:', ultimoIdSalvo);
                return;
              }

              // Comparação numérica estrita
              if (ultimoIdPlanilha === ultimoIdSalvo) {
                // IDs iguais → não há nova notificação
                console.log('[Verificação ID] Nenhuma mudança detectada (ID:', ultimoIdPlanilha + ')');
                return;
              }

              // IDs diferentes → há nova notificação
              console.log('[Verificação ID] 🔔 NOVA NOTIFICAÇÃO DETECTADA!');
              console.log('  • ID anterior:', ultimoIdSalvo);
              console.log('  • ID atual:', ultimoIdPlanilha);

              // Calcula uma contagem aproximada de novas notificações
              let diff = null;
              if (typeof ultimoIdSalvo === 'number' && !isNaN(ultimoIdSalvo)) {
                diff = ultimoIdPlanilha - ultimoIdSalvo;
              }
              let countNovas = 1;
              if (diff !== null && diff > 0) {
                countNovas = diff;
              }
              console.log('[Verificação ID] 🧮 Contagem estimada de novas notificações:', countNovas);
              try {
                localStorage.setItem('naam_new_notif_count', String(countNovas));
              } catch (e) {
                console.warn('[Verificação ID] ⚠️ Erro ao salvar contador de novas notificações:', e);
              }

              // Notificar sistema (popup azul + alerta, que lerão o contador)
              mostrarNotificacaoNovaNotificacao(countNovas);

              // Atualizar ultimoIdSalvo e salvar no cache
              salvarUltimoId(ultimoIdPlanilha);
              console.log('[Verificação ID] ID atualizado para:', ultimoIdSalvo);

            } catch (error) {
              console.error('[Verificação ID] Erro na verificação:', error);
            }
          }

          /**
           * Atualiza cache de notificações sem recarregar a página
           */
          // Dispara atualização via popup azul com bloqueio de alertas
          function atualizarViaPopupNotificacao() {
            console.log('[Popup Azul Painel] ▶️ Atualização iniciada pelo usuário');
            // Seta flag global para bloquear qualquer alerta/contadores/animações neste ciclo
            window.atualizacaoDisparadaPeloUsuario = true;
            window.atualizacaoIniciadaViaPopup = true;

            // ✨ SINCRONIZAÇÃO: Marca que popup foi atualizado
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
            if (typeof marcarPopupAzulAtualizado === 'function') {
              marcarPopupAzulAtualizado(notifId);
            }
            try {
              localStorage.setItem('naam_estado_atualizacao_painel', JSON.stringify({
                state: true,
                timestamp: Date.now(),
                source: 'popup-azul-painel'
              }));
            } catch (e) {
              console.warn('[Popup Azul Painel] ⚠️ Falha ao persistir estado global:', e);
            }

            // Remove imediatamente qualquer alerta persistente do DOM
            const alerta = document.getElementById('alerta-novas-notificacoes');
            if (alerta) alerta.remove();

            // Garante remoção de animação do botão principal de atualizar
            desativarPulseBotao('btnAtualizar');

            // Executa o fluxo padrão de atualização (cache + recarregar)
            if (typeof atualizarCacheNotificacoes === 'function') {
              atualizarCacheNotificacoes();
            } else {
              // Fallback: remove toast e dá reload
              const notificacao = document.getElementById('notificacao-nova-notificacao');
              if (notificacao) notificacao.remove();
              location.reload();
            }
          }

          function atualizarCacheNotificacoes() {
            console.log('[Notificação] 🔄 Atualizando cache de notificações...');

            // Remove a notificação visual com animação de saída
            const notificacao = document.getElementById('notificacao-nova-notificacao');
            if (notificacao) {
              notificacao.classList.remove('notificacao-visible');
              notificacao.classList.add('notificacao-exit');
              setTimeout(() => {
                notificacao.remove();
              }, 400);
            }

            // Limpa cache de registros e atualiza ID
            limparCacheERecarregarNotificacoes();
            hideAlertaNovasNotificacoes(true);

            // Recarrega os dados da planilha sem recarregar a página
            if (typeof carregarDadosPlanilha === 'function') {
              carregarDadosPlanilha();
              console.log('[Notificação] ✅ Cache atualizado e dados recarregados');

              // ✨ SINCRONIZAÇÃO: Após atualização bem-sucedida, atualiza último ID sincronizado
              // Aguarda um pouco para garantir que o ID foi atualizado
              setTimeout(() => {
                const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
                if (ultimoIdSalvo && typeof marcarPopupAzulAtualizado === 'function') {
                  const notifId = parseInt(ultimoIdSalvo, 10);
                  // Atualiza o último ID sincronizado para refletir que esta notificação foi processada
                  try {
                    localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(notifId));
                    console.log('[Sync] ✅ Último ID sincronizado atualizado após atualização:', notifId);
                  } catch (e) {
                    console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
                  }
                }
              }, 2000);
            } else {
              console.warn('[Notificação] ⚠️ Função carregarDadosPlanilha não disponível');
            }
          }

          /**
           * Atualiza o contador no alerta vermelho com animação de shake e incrementa o valor
           * @param {number} countNovas - Quantidade de novas notificações a adicionar
           */
          function atualizarContadorAlertaVermelhoComShake(countNovas) {
            const alerta = document.getElementById('alerta-novas-notificacoes');
            if (!alerta) return;

            // Verifica se o alerta está visível
            const estaVisivel = alerta.classList.contains('show') ||
              alerta.style.display === 'flex' ||
              (alerta.offsetParent !== null && alerta.style.display !== 'none');

            if (!estaVisivel) return;

            const titulo = alerta.querySelector('span.font-semibold');
            if (!titulo) return;

            // Extrai o número atual do texto do título
            let contadorAtual = 0;
            const textoAtual = titulo.textContent;
            const match = textoAtual.match(/(\d+)/);
            if (match) {
              contadorAtual = parseInt(match[1], 10);
            } else if (textoAtual.includes('Existe 1 nova')) {
              contadorAtual = 1;
            } else if (textoAtual.includes('Existem novas')) {
              // Se não tem número, tenta ler do localStorage
              try {
                const stored = localStorage.getItem('naam_new_notif_count');
                if (stored) {
                  contadorAtual = parseInt(stored, 10) || 0;
                }
              } catch (e) {
                console.warn('[Contador] ⚠️ Erro ao ler contador:', e);
              }
            }

            // Incrementa o contador
            const novoTotal = contadorAtual + (countNovas || 1);

            // Atualiza o localStorage global
            try {
              localStorage.setItem('naam_new_notif_count', String(novoTotal));
            } catch (e) {
              console.warn('[Contador] ⚠️ Erro ao salvar contador:', e);
            }

            // Atualiza o texto do título
            if (novoTotal === 1) {
              titulo.textContent = 'Existe 1 nova notificação!';
            } else {
              titulo.textContent = `Existem ${novoTotal} novas notificações!`;
            }

            // Aplica animação de shake no título
            titulo.classList.add('contador-shake');
            setTimeout(() => {
              titulo.classList.remove('contador-shake');
            }, 500);

            // Atualiza badges se existirem
            const badgeDesktop = document.getElementById('badge-notif-desktop');
            const badgeMobile = document.getElementById('badge-notif-mobile');
            if (badgeDesktop) {
              badgeDesktop.textContent = String(novoTotal);
              badgeDesktop.classList.remove('hidden');
            }
            if (badgeMobile) {
              badgeMobile.textContent = String(novoTotal);
              badgeMobile.classList.remove('hidden');
            }

            console.log('[Contador] ✅ Contador atualizado com shake:', contadorAtual, '→', novoTotal);
          }

          /**
           * Mostra notificação visual elegante e compacta de nova notificação
           */
          function mostrarNotificacaoNovaNotificacao(count) {
            // Verifica se o alerta vermelho já está visível
            const alertaVermelho = document.getElementById('alerta-novas-notificacoes');
            const alertaEstaVisivel = alertaVermelho && (
              alertaVermelho.classList.contains('show') ||
              alertaVermelho.style.display === 'flex' ||
              (alertaVermelho.offsetParent !== null && alertaVermelho.style.display !== 'none')
            );

            // Se o alerta vermelho já está visível, apenas atualiza o contador com shake
            if (alertaEstaVisivel) {
              console.log('[Popup Azul] ⚠️ Alerta vermelho já está visível. Atualizando contador com shake em vez de mostrar popup azul.');
              atualizarContadorAlertaVermelhoComShake(count || 1);
              return; // Não cria o popup azul
            }

            // Remove notificação anterior se existir
            const notificacaoAnterior = document.getElementById('notificacao-nova-notificacao');
            if (notificacaoAnterior) {
              notificacaoAnterior.remove();
            }
            // Marca a flag mas não mostra alerta ainda (aguardará saída do toast)
            // Passa a contagem (se fornecida) para o alerta vermelho
            showAlertaNovasNotificacoes(typeof count === 'number' ? count : null, true);

            // ✨ SINCRONIZAÇÃO: Marca que popup azul está ativo
            const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
            const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
            if (typeof marcarPopupAzulAtivo === 'function') {
              marcarPopupAzulAtivo(notifId);
            }

            // Cria container principal
            const notificacao = document.createElement('div');
            notificacao.id = 'notificacao-nova-notificacao';
            notificacao.className = 'notificacao-nova-elegante';

            // HTML da notificação harmônica e integrada
            notificacao.innerHTML = `
        <div class="notificacao-conteudo">
          <div class="notificacao-icone-container">
            <svg class="notificacao-icone" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="notificacao-texto">
            <div class="notificacao-titulo">
              <span class="notificacao-badge">NOVO</span>
              <span class="notificacao-mensagem-principal">Nova Notificação Recebida</span>
            </div>
            <div class="notificacao-descricao">
              Banco de dados recebeu nova notificação
            </div>
            <div class="notificacao-acoes">
              <button class="notificacao-btn-atualizar" onclick="if (typeof atualizarViaPopupNotificacao === 'function') { atualizarViaPopupNotificacao(); } else { this.closest('.notificacao-nova-elegante').remove(); location.reload(); }">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Atualizar
              </button>
              <button class="notificacao-btn-fechar" onclick="fecharNotificacaoToast(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="notificacao-progresso"></div>
      `;

            document.body.appendChild(notificacao);

            // Animação de entrada
            setTimeout(() => {
              notificacao.classList.add('notificacao-visible');
            }, 10);

            // Barra de progresso (15 segundos) - apenas visual, não fecha mais sozinha
            const progresso = notificacao.querySelector('.notificacao-progresso');
            if (progresso) {
              progresso.style.animation = 'notificacaoProgresso 15s linear forwards';
            }

            // Removido o fechamento automático em 15s.
            // Este popup azul só sai quando:
            // - Usuário clicar em "Atualizar" (atualiza os dados), ou
            // - Usuário clicar no "X" (fecha e força o alerta vermelho).
          }

          /**
           * Função para fechar a notificação toast manualmente
           */
          function fecharNotificacaoToast(botao) {
            const notificacao = botao.closest('.notificacao-nova-elegante');
            if (notificacao) {
              // ✨ SINCRONIZAÇÃO: Marca que popup foi fechado sem atualizar
              const ultimoIdSalvo = localStorage.getItem('naam_ultimo_id_notificacao');
              const notifId = ultimoIdSalvo ? parseInt(ultimoIdSalvo, 10) : null;
              if (typeof marcarPopupAzulFechadoSemAtualizar === 'function') {
                marcarPopupAzulFechadoSemAtualizar(notifId);
              }

              notificacao.classList.remove('notificacao-visible');
              notificacao.classList.add('notificacao-exit');

              // Remove do DOM após animação
              setTimeout(() => {
                notificacao.remove();
                // Mostra o alerta persistente após fechar o toast
                if (typeof showAlertaNovasNotificacoes === 'function') {
                  showAlertaNovasNotificacoes();
                }
              }, 400);
            }
          }

          // Torna a função acessível globalmente para o onclick inline
          if (typeof window !== 'undefined') {
            window.fecharNotificacaoToast = fecharNotificacaoToast;
          }

          /**
           * Limpa cache e recarrega notificações
           * NOTA: Não limpa o último ID salvo, apenas atualiza para o ID atual da planilha
           */
          function limparCacheERecarregarNotificacoes() {
            console.log('[Cache/Notificações] 🧹 Limpando cache de registros...');

            // Limpa cache de registros (mas mantém o ID de notificação)
            if (window.DataCache) {
              window.DataCache.clear('gerenciar_casos');
              window.DataCache.clearAll(); // Limpa todos os caches para garantir
              console.log('[Cache/Notificações] ✅ Cache limpo');
            }

            // ✨ SINCRONIZAÇÃO ENTRE PÁGINAS: Notifica outras páginas abertas
            try {
              const invalidationEvent = {
                type: 'cache_invalidation',
                timestamp: Date.now(),
                source: 'painel-casos',
                cacheKey: 'gerenciar_casos'
              };
              localStorage.setItem('naam_cache_invalidation', JSON.stringify(invalidationEvent));
              console.log('[Cache/Notificações] 📡 Evento de invalidação enviado para outras páginas');
              console.log('[Painel] ✅ Solicitei atualização da aba "Gerenciar Registros" (cache "gerenciar_casos" invalidado e sincronização disparada)');
            } catch (e) {
              console.warn('[Cache/Notificações] ⚠️ Erro ao enviar evento de invalidação:', e);
            }

            // Atualiza o último ID salvo com o ID atual da planilha (sem resetar)
            if (window.API && window.CONFIG && window.CONFIG.APPS_SCRIPT_CASOS) {
              buscarUltimoId().then(id => {
                if (id !== null) {
                  salvarUltimoId(id);
                  console.log('[Cache/Notificações] ✅ ID atualizado para:', ultimoIdSalvo);

                  // ✨ SINCRONIZAÇÃO: Só atualiza último ID sincronizado se for ação do usuário
                  // (não atualiza se for chamada automaticamente)
                  if (window._carregarDadosPlanilhaIsUserAction) {
                    try {
                      localStorage.setItem(SYNC_LAST_NOTIF_ID_KEY, String(id));
                      console.log('[Sync] ✅ Último ID sincronizado atualizado (ação do usuário):', id);
                    } catch (e) {
                      console.warn('[Sync] ⚠️ Erro ao atualizar último ID sincronizado:', e);
                    }
                  }
                }
              });
            }
          }

          /**
           * Inicia o sistema de verificação contínua
           */
          function iniciarVerificacaoPorId() {
            // Verifica se API e CONFIG estão disponíveis
            if (!window.API || !window.CONFIG || !window.CONFIG.APPS_SCRIPT_CASOS) {
              console.warn('[Verificação ID] ⏳ Aguardando carregamento da API...');
              // Tenta novamente após 1 segundo
              setTimeout(iniciarVerificacaoPorId, 1000);
              return;
            }

            // Limpa intervalo anterior se existir
            if (intervaloVerificacaoId) {
              clearInterval(intervaloVerificacaoId);
            }

            console.log('[Verificação ID] 🚀 Iniciando sistema de verificação por ID...');
            console.log('[Verificação ID] API disponível:', !!window.API);
            console.log('[Verificação ID] CONFIG disponível:', !!window.CONFIG);
            console.log('[Verificação ID] APPS_SCRIPT_CASOS:', window.CONFIG.APPS_SCRIPT_CASOS);

            // Carrega ID salvo do cache primeiro
            const idSalvo = carregarUltimoIdSalvo();

            // Se não há ID salvo, busca da planilha
            if (idSalvo === null) {
              buscarUltimoId().then(id => {
                if (id !== null) {
                  salvarUltimoId(id);
                  console.log('[Verificação ID] ✅ ID inicial obtido e salvo:', ultimoIdSalvo);
                } else {
                  console.warn('[Verificação ID] ⚠️ Não foi possível obter ID inicial, tentando novamente...');
                }
              });
            } else {
              console.log('[Verificação ID] ✅ ID carregado do cache:', ultimoIdSalvo);
            }

            // Intervalo de verificação: 10 segundos (pode ser configurado)
            const intervalo = 10000; // 10 segundos

            // Executa primeira verificação após 5 segundos
            setTimeout(() => {
              verificarMudancasPorId();
            }, 5000);

            // Configura verificação contínua
            intervaloVerificacaoId = setInterval(() => {
              verificarMudancasPorId();
            }, intervalo);

            console.log('[Verificação ID] ✅ Sistema iniciado! Verificando a cada', intervalo / 1000, 'segundos');
          }

          // Aguarda carregamento completo antes de iniciar
          function aguardarEIniciar() {
            // Verifica se tudo está carregado
            if (typeof window !== 'undefined' &&
              typeof window.CONFIG !== 'undefined' &&
              typeof window.API !== 'undefined' &&
              window.CONFIG.APPS_SCRIPT_CASOS) {
              iniciarVerificacaoPorId();
            } else {
              // Tenta novamente após 500ms
              setTimeout(aguardarEIniciar, 500);
            }
          }

          // Inicia verificação quando a página carregar
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              // Aguarda um pouco mais para garantir que todos os scripts carregaram
              setTimeout(aguardarEIniciar, 1000);
            });
          } else {
            // Página já carregou, aguarda scripts
            setTimeout(aguardarEIniciar, 1000);
          }

          // Pausa quando a página fica oculta e retoma quando fica visível
          document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
              console.log('[Painel Casos] 👁️ Página oculta - pausando verificação');
              pollingActive = false;
            } else {
              console.log('[Painel Casos] 👁️ Página visível - retomando verificação');
              pollingActive = true;
              // Executa uma verificação imediatamente quando a página fica visível
              executeCheck();
            }
          });

          // Monitora se o intervalo ainda está ativo (para debug)
          setInterval(() => {
            if (pollingIntervalId) {
              console.log(`[Painel Casos] 📊 Status: Polling ativo | Verificações realizadas: ${verificationCount} | Próxima em: ${pollingInterval / 1000}s`);
            } else {
              console.warn('[Painel Casos] ⚠️ ATENÇÃO: Polling parado! Reiniciando...');
              startPolling();
            }
          }, 60000); // Log de status a cada 1 minuto

          console.log('✅ [Painel Casos] Sistema de detecção de mudanças iniciado e rodando continuamente');
          console.log('   💡 O sistema ficará monitorando mudanças automaticamente');
          console.log('   💡 Quando detectar uma mudança, mostrará uma notificação no canto da tela');
        }, 3000); // Aguarda 3 segundos para garantir que os dados foram carregados
      } else {
        console.warn('⚠️ [Painel Casos] ChangeDetector, DataCache ou UpdateNotification não disponíveis');
      }

    </script>

    <!-- Script para suprimir erros de extensões do navegador -->
    <script>
      // Suprime erros de extensões do navegador que não são do nosso código
      (function () {
        const originalError = console.error;
        const originalWarn = console.warn;

        // Lista de padrões de erros de extensões para ignorar
        const ignorePatterns = [
          'content.bundle.js',
          'products.json',
          'chrome-extension://',
          'moz-extension://',
          'safari-extension://',
          'edge-extension://',
          'Uncaught SyntaxError: "undefined" is not valid JSON',
          'Unexpected token \'<\''
        ];

        console.error = function (...args) {
          const message = args.join(' ');
          // Ignora erros de extensões
          if (ignorePatterns.some(pattern => message.includes(pattern))) {
            return; // Suprime o erro
          }
          originalError.apply(console, args);
        };

        console.warn = function (...args) {
          const message = args.join(' ');
          // Ignora avisos de extensões
          if (ignorePatterns.some(pattern => message.includes(pattern))) {
            return; // Suprime o aviso
          }
          originalWarn.apply(console, args);
        };

        // Trata erros não capturados de extensões (captura fase de captura)
        window.addEventListener('error', function (e) {
          try {
            const errorMessage = String(e.message || '');
            const errorSource = String(e.filename || e.source || '');
            const errorStack = String(e.error?.stack || '');

            // Ignora erros de extensões
            if (ignorePatterns.some(pattern =>
              errorMessage.includes(pattern) ||
              errorSource.includes(pattern) ||
              errorStack.includes(pattern)
            )) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              return false;
            }
          } catch (err) {
            // Se houver erro ao processar, deixa passar
          }
        }, true);

        // Trata promessas rejeitadas de extensões
        window.addEventListener('unhandledrejection', function (e) {
          try {
            const reason = String(e.reason || '');
            const reasonStack = String(e.reason?.stack || '');

            // Ignora rejeições de extensões
            if (ignorePatterns.some(pattern =>
              reason.includes(pattern) || reasonStack.includes(pattern)
            )) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
          } catch (err) {
            // Se houver erro ao processar, deixa passar
          }
        });
      })();
    </script>

    <!-- ========================================
       MODAL DE DETALHES DO REGISTRO
       ======================================== -->
    <div id="modal-detalhes" class="modal-detalhes">
      <div class="modal-detalhes-conteudo">
        <div
          class="modal-detalhes-header flex items-center justify-between px-4 sm:px-6 md:px-8 py-4 sm:py-5 border-b border-gray-200 bg-gradient-to-r from-white to-blue-50/30">
          <div>
            <h2
              class="modal-detalhes-titulo text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2 sm:gap-3">
              <span class="text-2xl sm:text-3xl">🧾</span>
              <span id="modal-detalhes-titulo">Detalhes do Registro</span>
            </h2>
            <p class="modal-detalhes-subtitulo text-xs sm:text-sm text-gray-600 mt-1" id="modal-detalhes-subtitulo"></p>
          </div>
          <button
            class="modal-detalhes-close text-gray-400 hover:text-gray-600 text-3xl font-light transition-colors w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg hover:bg-gray-100"
            onclick="fecharModalDetalhes()" aria-label="Fechar">×</button>
        </div>

        <div class="modal-detalhes-body" id="modal-detalhes-body"></div>
      </div>
    </div>

    <!-- Intro.js - Sistema de Onboarding -->
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <script src="assets/js/utils/onboarding.js"></script>
    <script>
      // Inicializar onboarding após carregamento completo da página
      document.addEventListener('DOMContentLoaded', function () {
        // Aguardar dados carregarem antes de iniciar o tour
        setTimeout(function () {
          if (window.NAAMOnboarding) {
            NAAMOnboarding.init('painel-casos');
          }
        }, 2500);
      });
    </script>
</body>

<script>
  (function () {
    const DURATION_OPEN = 360;
    const DURATION_CLOSE = 280;
    const easingOpen = "cubic-bezier(0.16, 1, 0.3, 1)";
    const easingClose = "cubic-bezier(0.4, 0, 0.2, 1)";

    const raf = () => new Promise((r) => requestAnimationFrame(r));

    function initAccordion(details) {
      const summary = details.querySelector("summary");
      const content = details.querySelector(".filter-group-content");
      if (!summary || !content) return;

      // Guarda referência fixa ao conteúdo para o modo painel (o conteúdo será movido no DOM).
      details.__panelContent = content;
      content.__panelOwner = details;

      // Modo painel: não expande inline; clique abre apenas o advancedPanel abaixo.
      if ((details.dataset.mode || '') === 'panel') {
        details.open = false;
        details.dataset.expanded = 'false';
        content.style.overflow = 'hidden';
        content.style.height = '';

        summary.addEventListener('click', (e) => {
          e.preventDefault();
          openFilterPanel(details);
        });
        return;
      }

      // Mantém o conteúdo sempre mensurável para evitar travadas/altura 0.
      const initiallyOpen = details.hasAttribute("open");
      details.open = true;

      details.dataset.expanded = initiallyOpen ? "true" : "false";
      content.style.overflow = initiallyOpen ? "visible" : "hidden";
      content.style.height = initiallyOpen ? "" : "0px";

      let isAnimating = false;
      let animation = null;

      const cancelAnimation = () => {
        if (animation) {
          animation.cancel();
          animation = null;
        }
      };

      const animateHeight = (from, to, duration, easing) => {
        cancelAnimation();
        animation = content.animate(
          [
            { height: `${from}px`, opacity: 0.92 },
            { height: `${to}px`, opacity: 1 },
          ],
          { duration, easing }
        );
        return animation;
      };

      const expand = async () => {
        if (isAnimating) return;
        isAnimating = true;
        details.dataset.expanded = "true";
        content.style.overflow = "hidden";

        // Garantir que estamos com altura 0 antes de medir a altura final.
        content.style.height = content.getBoundingClientRect().height + "px";
        await raf();
        await raf();
        const startHeight = content.getBoundingClientRect().height;
        const endHeight = content.scrollHeight;
        content.style.height = `${startHeight}px`;

        const a = animateHeight(startHeight, endHeight, DURATION_OPEN, easingOpen);
        a.onfinish = () => {
          content.style.height = "";
          content.style.overflow = "visible";
          isAnimating = false;
          animation = null;
        };
        a.oncancel = () => {
          isAnimating = false;
        };
      };

      const collapse = async () => {
        if (isAnimating) return;
        isAnimating = true;
        content.style.overflow = "hidden";

        // Trava a altura atual para animar até zero.
        content.style.height = content.scrollHeight + "px";
        await raf();
        const startHeight = content.getBoundingClientRect().height;
        const endHeight = 0;

        const a = animateHeight(startHeight, endHeight, DURATION_CLOSE, easingClose);
        a.onfinish = () => {
          content.style.height = "0px";
          details.dataset.expanded = "false";
          content.style.overflow = "hidden";
          isAnimating = false;
          animation = null;
        };
        a.oncancel = () => {
          isAnimating = false;
        };
      };

      summary.addEventListener("click", (e) => {
        e.preventDefault();
        const expanded = details.dataset.expanded === "true";
        if (expanded) {
          void collapse();
        } else {
          void expand();
        }
      });
    }

    // ==========================================
    // Lógica do Botão "Limpar Filtros"
    // ==========================================
    function updateClearButtonVisibility() {
      const btn = document.getElementById('btnLimparFiltros');
      if (!btn) return;

      let hasActiveFilters = false;

      // 1. Verifica Inputs e Selects simples
      const inputs = document.querySelectorAll('#quickAdvancedFiltersBox input:not([type="checkbox"]), #quickAdvancedFiltersBox select');
      for (const input of inputs) {
        if (input.value && input.value !== '' && input.value !== 'Todos') {
          hasActiveFilters = true;
          break;
        }
      }

      // 2. Verifica Checkboxes (exceto os de controle interno se houver)
      if (!hasActiveFilters) {
        const checkboxes = document.querySelectorAll('#quickAdvancedFiltersBox input[type="checkbox"]:checked');
        if (checkboxes.length > 0) hasActiveFilters = true;
      }

      // 3. Verifica Tags Customizadas (ex: Deficiência, Escola)
      if (!hasActiveFilters) {
        const tags = document.querySelectorAll('.selected-tag');
        if (tags.length > 0) hasActiveFilters = true;
      }

      // 4. Verifica filtro de nome principal
      if (!hasActiveFilters) {
        const nomeFilter = document.getElementById('filterNome');
        if (nomeFilter && nomeFilter.value.trim() !== '') hasActiveFilters = true;
      }

      // Atualiza estado do botão
      if (hasActiveFilters) {
        btn.classList.remove('hidden');
        // Pequeno delay para permitir transição de opacidade
        requestAnimationFrame(() => {
          btn.classList.remove('opacity-0', 'scale-95');
          btn.classList.add('opacity-100', 'scale-100');
        });
      } else {
        btn.classList.remove('opacity-100', 'scale-100');
        btn.classList.add('opacity-0', 'scale-95');
        // Aguarda transição para esconder (300ms)
        setTimeout(() => {
          if (btn.classList.contains('opacity-0')) { // Verifica se ainda deve estar escondido
            btn.classList.add('hidden');
          }
        }, 300);
      }
    }

    function clearAllFilters() {
      // 1. Limpa Inputs de Texto
      document.querySelectorAll('#quickAdvancedFiltersBox input[type="text"], #quickAdvancedFiltersBox input[type="number"], #filterNome').forEach(input => {
        input.value = '';
      });

      // 2. Limpa Selects
      document.querySelectorAll('#quickAdvancedFiltersBox select').forEach(select => {
        select.value = ''; // Ou 'Todos' se for o value padrão, mas '' costuma ser o default seguro
        if (select.selectedIndex !== -1) select.selectedIndex = 0; // Garante o primeiro item
        // Dispara evento para atualizar UI de selects customizados se houver
        select.dispatchEvent(new Event('change', { bubbles: true }));
      });

      // 3. Desmarca Checkboxes
      document.querySelectorAll('#quickAdvancedFiltersBox input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });

      // 4. Limpa Tags Customizadas (Autocompletes)
      // Dispara clique no 'x' se existir, ou limpa container
      document.querySelectorAll('.remove-tag').forEach(btn => btn.click());

      // 5. Força atualização geral
      updateFilterCardBadges();
      updateClearButtonVisibility();

      // 6. Recarrega dados (Chama a função principal de filtro se existir)
      if (typeof applyFilters === 'function') {
        applyFilters();
      } else if (typeof filtrarDados === 'function') {
        filtrarDados();
      } else {
        // Fallback: dispara input em algum elemento para triggerar listeners globais
        const dummy = document.getElementById('filterNome');
        if (dummy) dummy.dispatchEvent(new Event('input', { bubbles: true }));
      }

      // Feedback visual (Toast opcional ou apenas atualiza KPI)
    }

    function boot() {
      document.querySelectorAll("details.filter-group").forEach(initAccordion);
      initEscolaSearch();
      setupTipoDeficienciaAutocomplete();

      ensureFilterCardBadges();
      updateFilterCardBadges();

      // Inicializa botão limpar
      updateClearButtonVisibility();

      const btnLimpar = document.getElementById('btnLimparFiltros');
      if (btnLimpar) {
        btnLimpar.addEventListener('click', (e) => {
          e.preventDefault();
          clearAllFilters();
        });
      }

      // Atualiza os badges e o botão limpar ao interagir com qualquer filtro
      const box = document.getElementById('quickAdvancedFiltersBox');
      const filterNome = document.getElementById('filterNome');

      const updateAll = () => {
        updateFilterCardBadges();
        updateClearButtonVisibility();
      };

      if (box) {
        box.addEventListener('input', updateAll, true);
        box.addEventListener('change', updateAll, true);
      }

      if (filterNome) {
        filterNome.addEventListener('input', updateAll, true);
      }

      // Fallback global: garante atualização mesmo quando o conteúdo é movido para o painel
      document.addEventListener('input', (e) => {
        const t = e.target;
        if (t && t.closest && t.closest('.filter-group-content')) updateFilterCardBadges();
      }, true);
      document.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.closest && t.closest('.filter-group-content')) updateFilterCardBadges();
      }, true);

      // Deixa o bloco inteiro das opções clicável (marca/desmarca o checkbox interno)
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (!target || !target.closest) return;

        // Não interferir quando o clique já é no próprio input/controle
        if (target.matches('input, select, textarea, option, button, a')) return;

        const item = target.closest('.checkbox-container');
        if (!item) return;

        const cb = item.querySelector('input.custom-checkbox[type="checkbox"], input.custom-checkbox[type="radio"]');
        if (!cb || cb.disabled) return;

        // Evita duplo toggle quando o clique foi no label associado
        if (target.tagName === 'LABEL') return;

        if (cb.type === 'checkbox') {
          cb.checked = !cb.checked;
        } else {
          cb.checked = true;
        }
        cb.dispatchEvent(new Event('change', { bubbles: true }));
      }, true);
    }

    function openFilterPanel(details) {
      const panel = document.getElementById('advancedPanel');
      const host = document.getElementById('advancedPanelContent');
      const content = details.__panelContent || details.querySelector('.filter-group-content');
      if (!panel || !host || !content) return;

      // Lock/fila: evita que cliques durante a animação corrompam o estado.
      if (host.__swapLock) {
        host.__queuedDetails = details;
        return;
      }

      const active = details.classList.contains('is-active');

      // Garante que os botões dos filtros fiquem sempre visíveis
      const ensureFiltersVisible = () => {
        const filtersGrid = document.querySelector('.filters-grid');
        if (!filtersGrid) return;

        // Scrolla suavemente para garantir que os filtros fiquem visíveis no topo
        setTimeout(() => {
          filtersGrid.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
        }, 50);
      };

      // Scroll para centralizar (usado apenas no fechamento)
      const centerSelectedCard = () => {
        const summary = details.querySelector('summary') || details;
        summary.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
      };

      // Animação RÁPIDA para troca entre filtros (SEM scroll, só anima)
      const animateSwap = (fn) => {
        host.__swapLock = true;

        // Animação de fade out RÁPIDA (sem aguardar scroll)
        host.classList.remove('is-entering');
        host.classList.remove('is-leaving-slow');
        host.classList.add('is-leaving');

        // Aguarda a animação de saída terminar (RÁPIDA)
        setTimeout(() => {
          fn();
          host.classList.remove('is-leaving');
          host.classList.add('is-entering');

          // Após trocar o conteúdo, garante que os filtros fiquem visíveis
          ensureFiltersVisible();

          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              host.classList.remove('is-entering');
              host.__swapLock = false;

              // Se houve clique durante a animação, executa o último pedido agora.
              if (host.__queuedDetails) {
                const next = host.__queuedDetails;
                host.__queuedDetails = null;
                setTimeout(() => openFilterPanel(next), 0);
              }
            });
          });
        }, 200); // Duração RÁPIDA da animação de fade out para troca
      };

      // Animação LENTA para fechamento do menu (COM scroll para centralizar)
      const animateClose = (fn) => {
        host.__swapLock = true;

        // PRIMEIRO: Scroll para centralizar (aguarda o scroll terminar)
        setTimeout(() => {
          // DEPOIS: Inicia animação de fade out LENTA
          host.classList.remove('is-entering');
          host.classList.remove('is-leaving');
          host.classList.add('is-leaving-slow');

          // Aguarda a animação de saída terminar (LENTA)
          setTimeout(() => {
            fn();
            host.classList.remove('is-leaving-slow');
            host.__swapLock = false;
          }, 400); // Duração LENTA da animação de fade out para fechamento
        }, 500); // Delay maior para o scroll (mais suave no fechamento)
      };

      const restoreActive = () => {
        const prevContent = host.querySelector('.filter-group-content');
        const prevOwner = prevContent ? prevContent.__panelOwner : null;
        if (prevOwner) {
          prevOwner.classList.remove('is-active');
          prevOwner.dataset.expanded = 'false';
        }
        if (prevContent && prevContent.__panelPlaceholder) {
          prevContent.__panelPlaceholder.replaceWith(prevContent);
          prevContent.__panelPlaceholder = null;
        }
      };

      // Se clicou no mesmo, fecha painel
      if (active) {
        // PRIMEIRO: Centraliza o card (scroll acontece primeiro)
        centerSelectedCard();

        // DEPOIS: Animação de fade out LENTA (fechamento)
        animateClose(() => {
          restoreActive();
          host.innerHTML = '';
          panel.classList.remove('open');
          updateFilterCardBadges();
        });

        return;
      }

      // Troca de filtro: Animação RÁPIDA sem scroll de centralização
      // A página se adapta automaticamente, mantendo os filtros visíveis
      animateSwap(() => {
        restoreActive();
        host.innerHTML = '';
        const placeholder = document.createComment('filter-group-content-placeholder');
        content.parentNode.insertBefore(placeholder, content);
        content.__panelPlaceholder = placeholder;
        host.appendChild(content);

        details.classList.add('is-active');
        details.dataset.expanded = 'true';
        panel.classList.add('open');

        // Revalida o autocomplete caso o conteúdo tenha sido movido
        initEscolaSearch();
        setupTipoDeficienciaAutocomplete();

        updateFilterCardBadges();
      });
    }

    // Função para fechar o painel de filtros com animação suave LENTA
    function closeFilterPanel() {
      const panel = document.getElementById('advancedPanel');
      const host = document.getElementById('advancedPanelContent');
      if (!panel || !host) return;

      // Verifica se o painel está aberto
      if (!panel.classList.contains('open')) return;

      // Animação de fechamento LENTA
      host.classList.remove('is-entering');
      host.classList.remove('is-leaving');
      host.classList.add('is-leaving-slow');

      setTimeout(() => {
        // Restaura o conteúdo ao filtro original
        const prevContent = host.querySelector('.filter-group-content');
        const prevOwner = prevContent ? prevContent.__panelOwner : null;

        if (prevOwner) {
          prevOwner.classList.remove('is-active');
          prevOwner.dataset.expanded = 'false';
        }

        if (prevContent && prevContent.__panelPlaceholder) {
          prevContent.__panelPlaceholder.replaceWith(prevContent);
          prevContent.__panelPlaceholder = null;
        }

        host.innerHTML = '';
        panel.classList.remove('open');
        host.classList.remove('is-leaving-slow');

        updateFilterCardBadges();
      }, 450); // Duração da animação de fechamento LENTA (450ms)
    }

    // Funções de Autocomplete (Reimplementadas)
    function setupGenericAutocomplete(searchId, listId, containerId, tagsId, onSelectCallback) {
      const searchInput = document.getElementById(searchId);
      const autocompleteList = document.getElementById(listId);
      const optionsContainer = document.getElementById(containerId);
      const tagsContainer = document.getElementById(tagsId);

      if (!searchInput || !autocompleteList || !optionsContainer) return;

      // Renderiza tags iniciais (caso já tenha algo selecionado)
      renderSelectedTags();

      // Evento de input no campo de busca
      searchInput.addEventListener('input', function () {
        const val = this.value.toLowerCase().trim();
        closeAllLists();

        if (!val) return;

        const currentItems = [];
        const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');

        checkboxes.forEach(cb => {
          // Ignora já selecionados
          if (cb.checked) return;

          const label = cb.nextSibling ? cb.nextSibling.textContent : cb.value;
          if (label.toLowerCase().includes(val)) {
            currentItems.push({
              label: label,
              value: cb.value,
              checkbox: cb
            });
          }
        });

        if (currentItems.length === 0) return;

        autocompleteList.innerHTML = '';
        currentItems.slice(0, 10).forEach(item => { // Limita a 10 resultados
          const div = document.createElement('div');

          // Realça o texto coincidente
          const regex = new RegExp(`(${val})`, 'gi');
          div.innerHTML = item.label.replace(regex, '<strong>$1</strong>');

          div.addEventListener('click', function () {
            item.checkbox.checked = true;
            item.checkbox.dispatchEvent(new Event('change')); // Dispara atualização dos filtros
            renderSelectedTags();
            searchInput.value = '';
            closeAllLists();
            if (onSelectCallback) onSelectCallback();
          });

          autocompleteList.appendChild(div);
        });

        autocompleteList.style.display = 'block';
      });

      // Fecha lista ao clicar fora
      document.addEventListener('click', function (e) {
        if (e.target !== searchInput) {
          closeAllLists();
        }
      });

      function closeAllLists() {
        autocompleteList.innerHTML = '';
        autocompleteList.style.display = 'none';
      }

      function renderSelectedTags() {
        if (!tagsContainer) return;
        tagsContainer.innerHTML = '';

        const checkedBoxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');

        checkedBoxes.forEach(cb => {
          const labelText = cb.nextSibling ? cb.nextSibling.textContent : cb.value;

          const tag = document.createElement('div');
          tag.className = 'selected-tag';
          tag.innerHTML = `
            <span>${labelText}</span>
            <span class="remove-tag" data-value="${cb.value}">×</span>
          `;

          tag.querySelector('.remove-tag').addEventListener('click', function () {
            cb.checked = false;
            cb.dispatchEvent(new Event('change')); // Dispara atualização dos filtros
            renderSelectedTags();
            if (onSelectCallback) onSelectCallback();
          });

          tagsContainer.appendChild(tag);
        });
      }

      // Expõe função de renderização para ser chamada externamente se necessário
      return { renderSelectedTags };
    }

    window.setupEscolaAutocomplete = function () {
      // Delegates to the local implementation (multi-select component)
      initEscolaSearch();
    };

    window.setupTipoDeficienciaAutocomplete = function () {
      window.tipoDeficienciaAutocomplete = setupGenericAutocomplete(
        'filterTipoDeficienciaSearch',
        'filterTipoDeficienciaContainer',
        'filterTipoDeficienciaSelectedTags',
        () => applyFilters()
      );
    };


    // Nota: Comportamento de fechamento automático ao scrollar foi removido
    // O painel permanece aberto durante o scroll para melhor usabilidade

    window.toggleAdvancedFilters = function toggleAdvancedFilters() {
      const box = document.getElementById('quickAdvancedFiltersBox');
      if (!box) return;
      setTimeout(() => {
        box.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", boot);
    } else {
      boot();
    }
  })();
</script>

<script>
  (function () {
    const svgChevron = "<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='m6 9 6 6 6-6'/></svg>";

    function closeAll(except) {
      document.querySelectorAll('.select-shell[data-open="true"]').forEach((el) => {
        if (except && el === except) return;
        el.dataset.open = 'false';
        const menu = el.__menu;
        const trigger = el.__trigger;
        if (menu) menu.classList.remove('open');
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
        if (el.__followRAF) {
          cancelAnimationFrame(el.__followRAF);
          el.__followRAF = null;
        }
      });
    }

    function getOverlay() {
      const filtersSection = document.getElementById('filtersSection');
      if (!filtersSection) return null;

      let overlay = document.getElementById('selectOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'selectOverlay';
        filtersSection.appendChild(overlay);
      }
      return overlay;
    }

    function positionMenu(shell) {
      const menu = shell.__menu;
      const trigger = shell.__trigger;
      const overlay = shell.__overlay || getOverlay();
      if (!menu || !trigger || !overlay) return;
      shell.__overlay = overlay;

      const rect = trigger.getBoundingClientRect();
      const overlayRect = overlay.getBoundingClientRect();
      const gap = 8;

      const left = rect.left - overlayRect.left;
      const top = rect.bottom - overlayRect.top + gap;

      menu.style.left = `${Math.max(0, left)}px`;
      menu.style.top = `${Math.max(0, top)}px`;
      menu.style.width = `${Math.max(220, rect.width)}px`;
    }

    function startFollowing(shell) {
      if (shell.__followRAF) return;
      const tick = () => {
        if (shell.dataset.open !== 'true') {
          shell.__followRAF = null;
          return;
        }
        positionMenu(shell);
        shell.__followRAF = requestAnimationFrame(tick);
      };
      shell.__followRAF = requestAnimationFrame(tick);
    }

    function buildCustomSelect(select) {
      if (!select || select.dataset.customized === 'true') return;
      select.dataset.customized = 'true';

      const shell = document.createElement('div');
      shell.className = 'select-shell';
      shell.dataset.open = 'false';

      const trigger = document.createElement('button');
      trigger.type = 'button';
      trigger.className = 'select-trigger';
      trigger.setAttribute('aria-haspopup', 'listbox');
      trigger.setAttribute('aria-expanded', 'false');

      const label = document.createElement('span');
      label.style.whiteSpace = 'nowrap';
      label.style.overflow = 'hidden';
      label.style.textOverflow = 'ellipsis';

      const icon = document.createElement('span');
      icon.className = 'select-trigger-icon';
      icon.innerHTML = svgChevron;

      trigger.appendChild(label);
      trigger.appendChild(icon);

      const menu = document.createElement('div');
      menu.className = 'select-menu';
      menu.setAttribute('role', 'listbox');

      // Keep references on shell for portal/positioning.
      shell.__menu = menu;
      shell.__trigger = trigger;

      const updateLabel = () => {
        const opt = select.options[select.selectedIndex];
        label.textContent = opt ? opt.textContent : '';
      };

      const rebuildOptions = () => {
        menu.innerHTML = '';
        Array.from(select.options).forEach((opt) => {
          const item = document.createElement('div');
          item.className = 'select-option';
          item.setAttribute('role', 'option');
          item.dataset.value = opt.value;
          item.textContent = opt.textContent;
          item.setAttribute('aria-selected', opt.selected ? 'true' : 'false');

          item.addEventListener('click', () => {
            select.value = opt.value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
            updateLabel();
            rebuildOptions();
            const closeWithAnimation = () => {
              if (!menu.classList.contains('open')) {
                shell.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                return;
              }

              menu.classList.add('closing');
              menu.classList.remove('open');
              const onEnd = (ev) => {
                if (ev && ev.target !== menu) return;
                menu.removeEventListener('transitionend', onEnd);
                menu.classList.remove('closing');
                shell.dataset.open = 'false';
                trigger.setAttribute('aria-expanded', 'false');
                if (shell.__followRAF) {
                  cancelAnimationFrame(shell.__followRAF);
                  shell.__followRAF = null;
                }
              };
              menu.addEventListener('transitionend', onEnd);
              setTimeout(() => onEnd({ target: menu }), 260);
            };
            closeWithAnimation();
          });

          menu.appendChild(item);
        });
      };

      updateLabel();
      rebuildOptions();

      select.classList.add('select-native');

      const parent = select.parentElement;
      if (!parent) return;
      parent.insertBefore(shell, select);
      shell.appendChild(trigger);
      // Portal menu to overlay inside filtersSection (container pai)
      const overlay = getOverlay();
      if (overlay) {
        shell.__overlay = overlay;
        overlay.appendChild(menu);
      } else {
        // fallback
        document.body.appendChild(menu);
      }
      shell.appendChild(select);

      trigger.addEventListener('click', () => {
        const isOpen = shell.dataset.open === 'true';
        if (isOpen) {
          shell.dataset.open = 'false';
          trigger.setAttribute('aria-expanded', 'false');
          menu.classList.remove('open');
          if (shell.__followRAF) {
            cancelAnimationFrame(shell.__followRAF);
            shell.__followRAF = null;
          }
          return;
        }
        closeAll(shell);
        shell.dataset.open = 'true';
        trigger.setAttribute('aria-expanded', 'true');
        rebuildOptions();
        menu.classList.add('open');
        // Double rAF garante layout estável antes de medir/posicionar
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            positionMenu(shell);
            startFollowing(shell);
          });
        });
      });

      select.addEventListener('change', () => {
        updateLabel();
        rebuildOptions();
      });
    }

    function boot() {
      document.querySelectorAll('select.select-elegant').forEach(buildCustomSelect);

      document.addEventListener('click', (e) => {
        const target = e.target;
        const shell = target && target.closest ? target.closest('.select-shell') : null;
        closeAll(shell);
      });

      window.addEventListener('resize', () => {
        document.querySelectorAll('.select-shell[data-open="true"]').forEach((shell) => positionMenu(shell));
      });

      window.addEventListener('scroll', () => {
        document.querySelectorAll('.select-shell[data-open="true"]').forEach((shell) => positionMenu(shell));
      }, { passive: true });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  })();
</script>

<!-- Intro.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
<!-- Onboarding Module -->
<script src="assets/js/utils/onboarding.js"></script>
<!-- Initialize Onboarding -->
<!-- Sticky Menu Behavior -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const menuCard = document.getElementById('menuCard');
    const headerWrapper = document.querySelector('header');

    if (!menuCard) return;

    const handleScroll = () => {
      if (window.scrollY > 10) {
        // Scrolled State
        menuCard.classList.add('scrolled-menu');
        headerWrapper.classList.add('header-scrolled');
      } else {
        // Top State
        menuCard.classList.remove('scrolled-menu');
        headerWrapper.classList.remove('header-scrolled');
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    // Run once on load
    handleScroll();
  });
</script>

<!-- ── Tooltip Portal System (independente) ── -->
<script>
  (function () {
    'use strict';

    function init() {
      if (window.__TOOLTIP_PORTAL_INIT) return;
      window.__TOOLTIP_PORTAL_INIT = true;

      // Portal: position absolute no body (coordenadas de documento, nao viewport)
      var portal = document.createElement('div');
      portal.id = 'tooltip-portal';
      portal.style.cssText = 'position:absolute;display:none;';
      document.body.appendChild(portal);

      var active = null;
      var timer = null;

      function hideNow() {
        portal.style.cssText = 'position:absolute;display:none;left:-9999px;top:-9999px;opacity:0;';
        portal.innerHTML = '';
        active = null;
        if (timer) { clearTimeout(timer); timer = null; }
      }

      function show(trigger) {
        if (active === trigger) return;
        if (timer) { clearTimeout(timer); timer = null; }
        active = trigger;

        var src = trigger.querySelector('.tooltip-popover');
        if (!src) { active = null; return; }

        // Clonar conteudo
        var inner = src.querySelector('span.relative');
        portal.innerHTML = '';
        if (inner) {
          portal.appendChild(inner.cloneNode(true));
        } else {
          portal.innerHTML = src.innerHTML;
        }

        // 1. Medir invisivel: absolute, opacity 0, posicao temporaria
        portal.style.cssText =
          'position:absolute;z-index:999999;pointer-events:none;'
          + 'width:max-content;max-width:320px;min-width:240px;'
          + 'display:block;opacity:0;left:0px;top:0px;';

        var pw = portal.offsetWidth;
        var ph = portal.offsetHeight;

        // 2. Posicao do trigger (viewport + scroll = coordenadas de documento)
        var r = trigger.getBoundingClientRect();
        var scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        var scrollY = window.pageYOffset || document.documentElement.scrollTop;
        var vw = document.documentElement.clientWidth;

        // Coordenadas absolutas do trigger no documento
        var trigDocTop = r.top + scrollY;
        var trigDocLeft = r.left + scrollX;

        // 3. Acima do trigger; se não couber, flip para baixo
        var top = trigDocTop - ph - 8;
        if (top < scrollY + 4) {
          // Não cabe acima: posicionar abaixo do trigger
          top = trigDocTop + r.height + 8;
        }

        // 4. Centralizado no trigger, clampado as bordas
        var left = trigDocLeft + (r.width / 2) - (pw / 2);
        if (left < scrollX + 8) left = scrollX + 8;
        if (left + pw > scrollX + vw - 8) left = scrollX + vw - pw - 8;

        // 5. Aplicar posicao (ainda opacity 0)
        portal.style.left = left + 'px';
        portal.style.top = top + 'px';

        // 6. Fade in
        requestAnimationFrame(function () {
          if (active !== trigger) return;
          portal.style.transition = 'opacity .15s ease';
          portal.style.opacity = '1';
        });
      }

      function hide() {
        if (!active) return;
        active = null;
        portal.style.opacity = '0';
        timer = setTimeout(hideNow, 160);
      }

      // --- Eventos ---
      document.addEventListener('mouseover', function (e) {
        var trig = e.target.closest('.tooltip-trigger');
        if (trig) show(trig);
      });

      document.addEventListener('mouseout', function (e) {
        var trig = e.target.closest('.tooltip-trigger');
        if (!trig || active !== trig) return;
        var rel = e.relatedTarget;
        if (rel && trig.contains(rel)) return;
        hide();
      });

      document.addEventListener('focusin', function (e) {
        var trig = e.target.closest('.tooltip-trigger');
        if (trig) show(trig);
      });

      document.addEventListener('focusout', function (e) {
        var trig = e.target.closest('.tooltip-trigger');
        if (trig && active === trig) {
          setTimeout(function () {
            if (active === trig && !trig.contains(document.activeElement)) hide();
          }, 0);
        }
      });

      window.addEventListener('resize', hide, { passive: true });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && active) hide();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

</html>